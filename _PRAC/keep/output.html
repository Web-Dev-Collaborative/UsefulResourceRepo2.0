<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>output</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h2 id="commented-practice-problems"># Commented Practice Problems:</h2>
<p>/<em> An asynchronously iterable queue class. Add values with enqueue() </em> and remove them with dequeue(). dequeue() returns a Promise, which * means that values can be dequeued before they are enqueued. The * class implements [Symbol.asyncIterator] and next() so that it can * be used with the for/await loop (which will not terminate until * the close() method is called.) */</p>
<hr />
<p>```js class AsyncQueue { constructor() { // Values that have been queued but not dequeued yet are stored here this.values = []; // When Promises are dequeued before their corresponding values are // queued, the resolve methods for those Promises are stored here. this.resolvers = []; // Once closed, no more values can be enqueued, and no more unfulfilled // Promises returned. this.closed = false; }</p>
<p>enqueue(value) { if (this.closed) { throw new Error(“AsyncQueue closed”); } if (this.resolvers.length &gt; 0) { // If this value has already been promised, resolve that Promise const resolve = this.resolvers.shift(); resolve(value); } else { // Otherwise, queue it up this.values.push(value); } } //———————————————————————————————— dequeue() { if (this.values.length &gt; 0) { // If there is a queued value, return a resolved Promise for it const value = this.values.shift(); return Promise.resolve(value); } else if (this.closed) { // If no queued values and we’re closed, return a resolved // Promise for the “end-of-stream” marker return Promise.resolve(AsyncQueue.EOS); } else { // Otherwise, return an unresolved Promise, // queuing the resolver function for later use return new Promise((resolve) =&gt; { this.resolvers.push(resolve); }); } }</p>
<p>close() { // Once the queue is closed, no more values will be enqueued. // So resolve any pending Promises with the end-of-stream marker while (this.resolvers.length &gt; 0) { this.resolvers.shift()(AsyncQueue.EOS); } this.closed = true; }</p>
<p>// Define the method that makes this class asynchronously iterable <a href="">Symbol.asyncIterator</a> { return this; }</p>
<p>// Define the method that makes this an asynchronous iterator. The // dequeue() Promise resolves to a value or the EOS sentinel if we’re // closed. Here, we need to return a Promise that resolves to an // iterator result object. next() { return this.dequeue().then((value) =&gt; value === AsyncQueue.EOS ? { value: undefined, done: true } : { value: value, done: false } ); } }</p>
<p>// A sentinel value returned by dequeue() to mark “end of stream” when closed AsyncQueue.EOS = Symbol(“end-of-stream”);</p>
<p>// Push events of the specified type on the specified document element // onto an AsyncQueue object, and return the queue for use as an event stream function eventStream(elt, type) { const q = new AsyncQueue(); // Create a queue elt.addEventListener(type, (e) =&gt; q.enqueue(e)); // Enqueue events return q; }</p>
<p>async function handleKeys() { // Get a stream of keypress events and loop once for each one for await (const event of eventStream(document, “keypress”)) { console.log(event.key); } } const BitSet = (function() { // Set BitSet to the return value of this function // Private implementation details here function isValid(set, n) { … } function has(set, byte, bit) { … } const BITS = new Uint8Array([1, 2, 4, 8, 16, 32, 64, 128]); const MASKS = new Uint8Array([~1, ~2, ~4, ~8, ~16, ~32, ~64, ~128]);</p>
<pre><code>// The public API of the module is just the BitSet class, which we define
// and return here. The class can use the private functions and constants
// defined above, but they will be hidden from users of the class
return class BitSet extends AbstractWritableSet {
    // ... implementation omitted ...
};</code></pre>
<p>}());</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> Instances of this Complex class represent complex numbers. </em> Recall that a complex number is the sum of a real number and an * imaginary number and that the imaginary number i is the square root of -1. */</p>
<hr />
<p>```js class Complex { // Once class field declarations are standardized, we could declare // private fields to hold the real and imaginary parts of a complex number // here, with code like this: // // #r = 0; // #i = 0;</p>
<p>// This constructor function defines the instance fields r and i on every // instance it creates. These fields hold the real and imaginary parts of // the complex number: they are the state of the object. constructor(real, imaginary) { this.r = real; // This field holds the real part of the number. this.i = imaginary; // This field holds the imaginary part. }</p>
<p>// Here are two instance methods for addition and multiplication // of complex numbers. If c and d are instances of this class, we // might write c.plus(d) or d.times(c) plus(that) { return new Complex(this.r + that.r, this.i + that.i); } times(that) { return new Complex( this.r * that.r - this.i * that.i, this.r * that.i + this.i * that.r ); }</p>
<p>// And here are static variants of the complex arithmetic methods. // We could write Complex.sum(c,d) and Complex.product(c,d) static sum(c, d) { return c.plus(d); } static product(c, d) { return c.times(d); }</p>
<p>// These are some instance methods that are defined as getters // so they’re used like fields. The real and imaginary getters would // be useful if we were using private fields this.#r and this.#i get real() { return this.r; } get imaginary() { return this.i; } get magnitude() { return Math.hypot(this.r, this.i); }</p>
<p>// Classes should almost always have a toString() method toString() { return <code>{${this.r},${this.i}}</code>; }</p>
<p>// It is often useful to define a method for testing whether // two instances of your class represent the same value equals(that) { return that instanceof Complex &amp;&amp; this.r === that.r &amp;&amp; this.i === that.i; }</p>
<p>// Once static fields are supported inside class bodies, we could // define a useful Complex.ZERO constant like this: // static ZERO = new Complex(0,0); }</p>
<p>// Here are some class fields that hold useful predefined complex numbers. Complex.ZERO = new Complex(0, 0); Complex.ONE = new Complex(1, 0); Complex.I = new Complex(0, 1); // A trivial Array subclass that adds getters for the first and last elements. class EZArray extends Array { get first() { return this[0]; } get last() { return this[this.length - 1]; } }</p>
<p>let a = new EZArray(); a instanceof EZArray; // =&gt; true: a is subclass instance a instanceof Array; // =&gt; true: a is also a superclass instance. a.push(1, 2, 3, 4); // a.length == 4; we can use inherited methods a.pop(); // =&gt; 4: another inherited method a.first; // =&gt; 1: first getter defined by subclass a.last; // =&gt; 3: last getter defined by subclass a[1]; // =&gt; 2: regular array access syntax still works. Array.isArray(a); // =&gt; true: subclass instance really is an array EZArray.isArray(a); // =&gt; true: subclass inherits static methods, too!</p>
<p>// EZArray inherits instance methods because EZArray.prototype // inherits from Array.prototype Array.prototype.isPrototypeOf(EZArray.prototype); // =&gt; true</p>
<p>// And EZArray inherits static methods and properties because // EZArray inherits from Array. This is a special feature of the // extends keyword and is not possible before ES6. Array.isPrototypeOf(EZArray); // =&gt; true class Glob { constructor(glob) { this.glob = glob;</p>
<pre><code>// We implement glob matching using RegExp internally.
// ? matches any one character except /, and * matches zero or more
// of those characters. We use capturing groups around each.
let regexpText = glob.replace(&quot;?&quot;, &quot;([^/])&quot;).replace(&quot;*&quot;, &quot;([^/]*)&quot;);

// We use the u flag to get Unicode-aware matching.
// Globs are intended to match entire strings, so we use the ^ and $
// anchors and do not implement search() or matchAll() since they
// are not useful with patterns like this.
this.regexp = new RegExp(`^${regexpText}$`, &quot;u&quot;);</code></pre>
<p>}</p>
<p>toString() { return this.glob; }</p>
<p><a href="s">Symbol.search</a> { return s.search(this.regexp); } <a href="s">Symbol.match</a> { return s.match(this.regexp); } <a href="s,%20replacement">Symbol.replace</a> { return s.replace(this.regexp, replacement); } }</p>
<p>let pattern = new Glob("docs/*.txt“);”docs/js.txt“.search(pattern); // =&gt; 0: matches at character 0”docs/js.htm“.search(pattern); // =&gt; -1: does not match let match =”docs/js.txt“.match(pattern); match[0]; // =&gt;”docs/js.txt" match[1]; // =&gt; “js” match.index; // =&gt; 0 “docs/js.txt”.replace(pattern, “web/$1.htm”); // =&gt; “web/js.htm”</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> A Set-like class that keeps track of how many times a value has </em> been added. Call add() and remove() like you would for a Set, and * call count() to find out how many times a given value has been added. * The default iterator yields the values that have been added at least * once. Use entries() if you want to iterate [value, count] pairs. */</p>
<hr />
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">class</span> Histogram <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="co">// To initialize, we just create a Map object to delegate to</span></a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="kw">this</span>.<span class="at">map</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="co">// For any given key, the count is the value in the Map, or zero</span></a>
<a class="sourceLine" id="cb3-8" title="8">  <span class="co">// if the key does not appear in the Map.</span></a>
<a class="sourceLine" id="cb3-9" title="9">  <span class="at">count</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">get</span>(key) <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-12" title="12"></a>
<a class="sourceLine" id="cb3-13" title="13">  <span class="co">// The Set-like method has() returns true if the count is non-zero</span></a>
<a class="sourceLine" id="cb3-14" title="14">  <span class="at">has</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">count</span>(key) <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-17" title="17"></a>
<a class="sourceLine" id="cb3-18" title="18">  <span class="co">// The size of the histogram is just the number of entries in the Map.</span></a>
<a class="sourceLine" id="cb3-19" title="19">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-20" title="20">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">size</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-21" title="21">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-22" title="22"></a>
<a class="sourceLine" id="cb3-23" title="23">  <span class="co">// To add a key, just increment its count in the Map.</span></a>
<a class="sourceLine" id="cb3-24" title="24">  <span class="at">add</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-25" title="25">    <span class="kw">this</span>.<span class="va">map</span>.<span class="at">set</span>(key<span class="op">,</span> <span class="kw">this</span>.<span class="at">count</span>(key) <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-26" title="26">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-27" title="27"></a>
<a class="sourceLine" id="cb3-28" title="28">  <span class="co">// Deleting a key is a little trickier because we have to delete</span></a>
<a class="sourceLine" id="cb3-29" title="29">  <span class="co">// the key from the Map if the count goes back down to zero.</span></a>
<a class="sourceLine" id="cb3-30" title="30">  <span class="kw">delete</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-31" title="31">    <span class="kw">let</span> count <span class="op">=</span> <span class="kw">this</span>.<span class="at">count</span>(key)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-32" title="32">    <span class="cf">if</span> (count <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-33" title="33">      <span class="kw">this</span>.<span class="va">map</span>.<span class="at">delete</span>(key)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-34" title="34">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (count <span class="op">&gt;</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-35" title="35">      <span class="kw">this</span>.<span class="va">map</span>.<span class="at">set</span>(key<span class="op">,</span> count <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-36" title="36">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-37" title="37">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-38" title="38"></a>
<a class="sourceLine" id="cb3-39" title="39">  <span class="co">// Iterating a Histogram just returns the keys stored in it</span></a>
<a class="sourceLine" id="cb3-40" title="40">  [<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-41" title="41">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">keys</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-42" title="42">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-43" title="43"></a>
<a class="sourceLine" id="cb3-44" title="44">  <span class="co">// These other iterator methods just delegate to the Map object</span></a>
<a class="sourceLine" id="cb3-45" title="45">  <span class="at">keys</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-46" title="46">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">keys</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-47" title="47">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-48" title="48">  <span class="at">values</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-49" title="49">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">values</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-50" title="50">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-51" title="51">  <span class="at">entries</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-52" title="52">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">entries</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-53" title="53">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-54" title="54"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> A Range object represents a range of numbers {x: from &lt;= x &lt;= to} * Range defines a has() method for testing whether a given number is a member * of the range. Range is iterable and iterates all integers within the range. */</p>
<hr />
<p>```js class Range { constructor(from, to) { this.from = from; this.to = to; }</p>
<p>// Make a Range act like a Set of numbers has(x) { return typeof x === “number” &amp;&amp; this.from &lt;= x &amp;&amp; x &lt;= this.to; }</p>
<p>// Return string representation of the range using set notation toString() { return <code>{ x | ${this.from} ≤ x ≤ ${this.to} }</code>; }</p>
<p>// Make a Range iterable by returning an iterator object. // Note that the name of this method is a special symbol, not a string. <a href="">Symbol.iterator</a> { // Each iterator instance must iterate the range independently of // others. So we need a state variable to track our location in the // iteration. We start at the first integer &gt;= from. let next = Math.ceil(this.from); // This is the next value we return let last = this.to; // We won’t return anything &gt; this return { // This is the iterator object // This next() method is what makes this an iterator object. // It must return an iterator result object. next() { return next &lt;= last // If we haven’t returned last value yet ? { value: next++ } // return next value and increment it : { done: true }; // otherwise indicate that we’re done. },</p>
<pre><code>  // As a convenience, we make the iterator itself iterable.
  [Symbol.iterator]() {
    return this;
  },
};</code></pre>
<p>} }</p>
<p>for (let x of new Range(1, 10)) console.log(x); // Logs numbers 1 to 10 […new Range(-2, 2)]; // =&gt; [-2, -1, 0, 1, 2]</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> The AbstractSet class defines a single abstract method, has(). </em>/</p>
<hr />
<p>```js class AbstractSet { // Throw an error here so that subclasses are forced // to define their own working version of this method. has(x) { throw new Error(“Abstract method”); } }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> NotSet is a concrete subclass of AbstractSet. </em> The members of this set are all values that are not members of some * other set. Because it is defined in terms of another set it is not * writable, and because it has infinite members, it is not enumerable. * All we can do with it is test for membership and convert it to a * string using mathematical notation. */</p>
<hr />
<p>```js class NotSet extends AbstractSet { constructor(set) { super(); this.set = set; }</p>
<p>// Our implementation of the abstract method we inherited has(x) { return !this.set.has(x); } // And we also override this Object method toString() { return <code>{ x| x ∉ ${this.set.toString()} }</code>; } }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> Range set is a concrete subclass of AbstractSet. Its members are </em> all values that are between the from and to bounds, inclusive. * Since its members can be floating point numbers, it is not * enumerable and does not have a meaningful size. */</p>
<hr />
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">class</span> RangeSet <span class="kw">extends</span> AbstractSet <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="at">constructor</span>(<span class="im">from</span><span class="op">,</span> to) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="kw">super</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="kw">this</span>.<span class="at">from</span> <span class="op">=</span> <span class="im">from</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="kw">this</span>.<span class="at">to</span> <span class="op">=</span> to<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="at">has</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-9" title="9">    <span class="cf">return</span> x <span class="op">&gt;=</span> <span class="kw">this</span>.<span class="at">from</span> <span class="op">&amp;&amp;</span> x <span class="op">&lt;=</span> <span class="kw">this</span>.<span class="at">to</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-11" title="11">  <span class="at">toString</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="cf">return</span> <span class="vs">`{ x| </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">from</span><span class="sc">}</span><span class="vs"> ≤ x ≤ </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">to</span><span class="sc">}</span><span class="vs"> }`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-13" title="13">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> AbstractEnumerableSet is an abstract subclass of AbstractSet. It defines * an abstract getter that returns the size of the set and also defines an * abstract iterator. And it then implements concrete isEmpty(), toString(), * and equals() methods on top of those. Subclasses that implement the * iterator, the size getter, and the has() method get these concrete * methods for free. */</p>
<hr />
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">class</span> AbstractEnumerableSet <span class="kw">extends</span> AbstractSet <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Abstract method&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-5" title="5">  [<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Abstract method&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-8" title="8"></a>
<a class="sourceLine" id="cb6-9" title="9">  <span class="at">isEmpty</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-10" title="10">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">size</span> <span class="op">===</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-12" title="12">  <span class="at">toString</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-13" title="13">    <span class="cf">return</span> <span class="vs">`{</span><span class="sc">${</span><span class="va">Array</span>.<span class="at">from</span>(<span class="kw">this</span>).<span class="at">join</span>(<span class="st">&quot;, &quot;</span>)<span class="sc">}</span><span class="vs">}`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-15" title="15">  <span class="at">equals</span>(set) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-16" title="16">    <span class="co">// If the other set is not also Enumerable, it isn&#39;t equal to this one</span></a>
<a class="sourceLine" id="cb6-17" title="17">    <span class="cf">if</span> (<span class="op">!</span>(set <span class="kw">instanceof</span> AbstractEnumerableSet)) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-18" title="18"></a>
<a class="sourceLine" id="cb6-19" title="19">    <span class="co">// If they don&#39;t have the same size, they&#39;re not equal</span></a>
<a class="sourceLine" id="cb6-20" title="20">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">size</span> <span class="op">!==</span> <span class="va">set</span>.<span class="at">size</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-21" title="21"></a>
<a class="sourceLine" id="cb6-22" title="22">    <span class="co">// Loop through the elements of this set</span></a>
<a class="sourceLine" id="cb6-23" title="23">    <span class="cf">for</span> (<span class="kw">let</span> element <span class="kw">of</span> <span class="kw">this</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-24" title="24">      <span class="co">// If an element isn&#39;t in the other set, they aren&#39;t equal</span></a>
<a class="sourceLine" id="cb6-25" title="25">      <span class="cf">if</span> (<span class="op">!</span><span class="va">set</span>.<span class="at">has</span>(element)) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-27" title="27"></a>
<a class="sourceLine" id="cb6-28" title="28">    <span class="co">// The elements matched, so the sets are equal</span></a>
<a class="sourceLine" id="cb6-29" title="29">    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-30" title="30">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-31" title="31"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> SingletonSet is a concrete subclass of AbstractEnumerableSet. * A singleton set is a read-only set with a single member. */</p>
<hr />
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">class</span> SingletonSet <span class="kw">extends</span> AbstractEnumerableSet <span class="op">{</span></a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="at">constructor</span>(member) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="kw">super</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="kw">this</span>.<span class="at">member</span> <span class="op">=</span> member<span class="op">;</span></a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7">  <span class="co">// We implement these three methods, and inherit isEmpty, equals()</span></a>
<a class="sourceLine" id="cb7-8" title="8">  <span class="co">// and toString() implementations based on these methods.</span></a>
<a class="sourceLine" id="cb7-9" title="9">  <span class="at">has</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-10" title="10">    <span class="cf">return</span> x <span class="op">===</span> <span class="kw">this</span>.<span class="at">member</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-12" title="12">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb7-13" title="13">    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-15" title="15">  <span class="op">*</span>[<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb7-16" title="16">    <span class="kw">yield</span> <span class="kw">this</span>.<span class="at">member</span><span class="op">;</span></a>
<a class="sourceLine" id="cb7-17" title="17">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-18" title="18"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> AbstractWritableSet is an abstract subclass of AbstractEnumerableSet. * It defines the abstract methods insert() and remove() that insert and * remove individual elements from the set, and then implements concrete * add(), subtract(), and intersect() methods on top of those. Note that * our API diverges here from the standard JavaScript Set class. */</p>
<hr />
<p>```js class AbstractWritableSet extends AbstractEnumerableSet { insert(x) { throw new Error(“Abstract method”); } remove(x) { throw new Error(“Abstract method”); }</p>
<p>add(set) { for (let element of set) { this.insert(element); } }</p>
<p>subtract(set) { for (let element of set) { this.remove(element); } }</p>
<p>intersect(set) { for (let element of this) { if (!set.has(element)) { this.remove(element); } } } }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> A BitSet is a concrete subclass of AbstractWritableSet with a </em> very efficient fixed-size set implementation for sets whose * elements are non-negative integers less than some maximum size. */</p>
<hr />
<p>```js class BitSet extends AbstractWritableSet { constructor(max) { super(); this.max = max; // The maximum integer we can store. this.n = 0; // How many integers are in the set this.numBytes = Math.floor(max / 8) + 1; // How many bytes we need this.data = new Uint8Array(this.numBytes); // The bytes }</p>
<p>// Internal method to check if a value is a legal member of this set _valid(x) { return Number.isInteger(x) &amp;&amp; x &gt;= 0 &amp;&amp; x &lt;= this.max; }</p>
<p>// Tests whether the specified bit of the specified byte of our // data array is set or not. Returns true or false. _has(byte, bit) { return (this.data[byte] &amp; BitSet.bits[bit]) !== 0; }</p>
<p>// Is the value x in this BitSet? has(x) { if (this._valid(x)) { let byte = Math.floor(x / 8); let bit = x % 8; return this._has(byte, bit); } else { return false; } }</p>
<p>// Insert the value x into the BitSet insert(x) { if (this._valid(x)) { // If the value is valid let byte = Math.floor(x / 8); // convert to byte and bit let bit = x % 8; if (!this._has(byte, bit)) { // If that bit is not set yet this.data[byte] |= BitSet.bits[bit]; // then set it this.n++; // and increment set size } } else { throw new TypeError(“Invalid set element:” + x); } }</p>
<p>remove(x) { if (this._valid(x)) { // If the value is valid let byte = Math.floor(x / 8); // compute the byte and bit let bit = x % 8; if (this._has(byte, bit)) { // If that bit is already set this.data[byte] &amp;= BitSet.masks[bit]; // then unset it this.n–; // and decrement size } } else { throw new TypeError(“Invalid set element:” + x); } }</p>
<p>// A getter to return the size of the set get size() { return this.n; }</p>
<p>// Iterate the set by just checking each bit in turn. // (We could be a lot more clever and optimize this substantially) *<a href="">Symbol.iterator</a> { for (let i = 0; i &lt;= this.max; i++) { if (this.has(i)) { yield i; } } } }</p>
<p>// Some pre-computed values used by the has(), insert() and remove() methods BitSet.bits = new Uint8Array([1, 2, 4, 8, 16, 32, 64, 128]); BitSet.masks = new Uint8Array([~1, ~2, ~4, ~8, ~16, ~32, ~64, ~128]); // This is the constructor function for our subclass function Span(start, span) { if (span &gt;= 0) { this.from = start; this.to = start + span; } else { this.to = start; this.from = start + span; } }</p>
<p>// Ensure that the Span prototype inherits from the Range prototype Span.prototype = Object.create(Range.prototype);</p>
<p>// We don’t want to inherit Range.prototype.constructor, so we // define our own constructor property. Span.prototype.constructor = Span;</p>
<p>// By defining its own toString() method, Span overrides the // toString() method that it would otherwise inherit from Range. Span.prototype.toString = function () { return <code>(${this.from}... +${this.to - this.from})</code>; };</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"></a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="op">---</span></a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5"></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">/*</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co"> TOC.js: create a table of contents for a document.</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co"> *</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co"> * This script runs when the DOMContentLoaded event is fired and</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co"> * automatically generates a table of contents for the document.</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co"> * It does not define any global symbols so it should not conflict</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co"> * with other scripts.</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co"> *</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co"> * When this script runs, it first looks for a document element with</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co"> * an id of &quot;TOC&quot;. If there is no such element it creates one at the</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co"> * start of the document. Next, the function finds all &lt;h2&gt; through</span></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co"> * &lt;h6&gt; tags, treats them as section titles, and creates a table of</span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co"> * contents within the TOC element. The function adds section numbers</span></a>
<a class="sourceLine" id="cb8-19" title="19"><span class="co"> * to each section heading and wraps the headings in named anchors so</span></a>
<a class="sourceLine" id="cb8-20" title="20"><span class="co"> * that the TOC can link to them. The generated anchors have names</span></a>
<a class="sourceLine" id="cb8-21" title="21"><span class="co"> * that begin with &quot;TOC&quot;, so you should avoid this prefix in your own</span></a>
<a class="sourceLine" id="cb8-22" title="22"><span class="co"> * HTML.</span></a>
<a class="sourceLine" id="cb8-23" title="23"><span class="co"> *</span></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="co"> * The entries in the generated TOC can be styled with CSS. All</span></a>
<a class="sourceLine" id="cb8-25" title="25"><span class="co"> * entries have a class &quot;TOCEntry&quot;. Entries also have a class that</span></a>
<a class="sourceLine" id="cb8-26" title="26"><span class="co"> * corresponds to the level of the section heading. &lt;h1&gt; tags generate</span></a>
<a class="sourceLine" id="cb8-27" title="27"><span class="co"> * entries of class &quot;TOCLevel1&quot;, &lt;h2&gt; tags generate entries of class</span></a>
<a class="sourceLine" id="cb8-28" title="28"><span class="co"> * &quot;TOCLevel2&quot;, and so on. Section numbers inserted into headings have</span></a>
<a class="sourceLine" id="cb8-29" title="29"><span class="co"> * class &quot;TOCSectNum&quot;.</span></a>
<a class="sourceLine" id="cb8-30" title="30"><span class="co"> *</span></a>
<a class="sourceLine" id="cb8-31" title="31"><span class="co"> * You might use this script with a stylesheet like this:</span></a>
<a class="sourceLine" id="cb8-32" title="32"><span class="co"> *</span></a>
<a class="sourceLine" id="cb8-33" title="33"><span class="co"> *   #TOC { border: solid black 1px; margin: 10px; padding: 10px; }</span></a>
<a class="sourceLine" id="cb8-34" title="34"><span class="co"> *   .TOCEntry { margin: 5px 0px; }</span></a>
<a class="sourceLine" id="cb8-35" title="35"><span class="co"> *   .TOCEntry a { text-decoration: none; }</span></a>
<a class="sourceLine" id="cb8-36" title="36"><span class="co"> *   .TOCLevel1 { font-size: 16pt; font-weight: bold; }</span></a>
<a class="sourceLine" id="cb8-37" title="37"><span class="co"> *   .TOCLevel2 { font-size: 14pt; margin-left: .25in; }</span></a>
<a class="sourceLine" id="cb8-38" title="38"><span class="co"> *   .TOCLevel3 { font-size: 12pt; margin-left: .5in; }</span></a>
<a class="sourceLine" id="cb8-39" title="39"><span class="co"> *   .TOCSectNum:after { content: &quot;: &quot;; }</span></a>
<a class="sourceLine" id="cb8-40" title="40"><span class="co"> *</span></a>
<a class="sourceLine" id="cb8-41" title="41"><span class="co"> * To hide the section numbers, use this:</span></a>
<a class="sourceLine" id="cb8-42" title="42"><span class="co"> *</span></a>
<a class="sourceLine" id="cb8-43" title="43"><span class="co"> *   .TOCSectNum { display: none }</span></a>
<a class="sourceLine" id="cb8-44" title="44"><span class="co"> **/</span></a>
<a class="sourceLine" id="cb8-45" title="45"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-46" title="46">  <span class="co">// Find the TOC container element.</span></a>
<a class="sourceLine" id="cb8-47" title="47">  <span class="co">// If there isn&#39;t one, create one at the start of the document.</span></a>
<a class="sourceLine" id="cb8-48" title="48">  <span class="kw">let</span> toc <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#TOC&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-49" title="49">  <span class="cf">if</span> (<span class="op">!</span>toc) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-50" title="50">    toc <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-51" title="51">    <span class="va">toc</span>.<span class="at">id</span> <span class="op">=</span> <span class="st">&quot;TOC&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-52" title="52">    <span class="va">document</span>.<span class="va">body</span>.<span class="at">prepend</span>(toc)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-53" title="53">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-54" title="54"></a>
<a class="sourceLine" id="cb8-55" title="55">  <span class="co">// Find all section heading elements. We&#39;re assuming here that the</span></a>
<a class="sourceLine" id="cb8-56" title="56">  <span class="co">// document title uses &lt;h1&gt; and that sections within the document are</span></a>
<a class="sourceLine" id="cb8-57" title="57">  <span class="co">// marked with &lt;h2&gt; through &lt;h6&gt;.</span></a>
<a class="sourceLine" id="cb8-58" title="58">  <span class="kw">let</span> headings <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&quot;h2,h3,h4,h5,h6&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-59" title="59"></a>
<a class="sourceLine" id="cb8-60" title="60">  <span class="co">// Initialize an array that keeps track of section numbers.</span></a>
<a class="sourceLine" id="cb8-61" title="61">  <span class="kw">let</span> sectionNumbers <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb8-62" title="62"></a>
<a class="sourceLine" id="cb8-63" title="63">  <span class="co">// Now loop through the section header elements we found.</span></a>
<a class="sourceLine" id="cb8-64" title="64">  <span class="cf">for</span> (<span class="kw">let</span> heading <span class="kw">of</span> headings) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-65" title="65">    <span class="co">// Skip the heading if it is inside the TOC container.</span></a>
<a class="sourceLine" id="cb8-66" title="66">    <span class="cf">if</span> (<span class="va">heading</span>.<span class="at">parentNode</span> <span class="op">===</span> toc) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-67" title="67">      <span class="cf">continue</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-68" title="68">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-69" title="69"></a>
<a class="sourceLine" id="cb8-70" title="70">    <span class="co">// Figure out what level heading it is.</span></a>
<a class="sourceLine" id="cb8-71" title="71">    <span class="co">// Subtract 1 because &lt;h2&gt; is a level-1 heading.</span></a>
<a class="sourceLine" id="cb8-72" title="72">    <span class="kw">let</span> level <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">heading</span>.<span class="va">tagName</span>.<span class="at">charAt</span>(<span class="dv">1</span>)) <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-73" title="73"></a>
<a class="sourceLine" id="cb8-74" title="74">    <span class="co">// Increment the section number for this heading level</span></a>
<a class="sourceLine" id="cb8-75" title="75">    <span class="co">// and reset all lower heading level numbers to zero.</span></a>
<a class="sourceLine" id="cb8-76" title="76">    sectionNumbers[level <span class="op">-</span> <span class="dv">1</span>]<span class="op">++;</span></a>
<a class="sourceLine" id="cb8-77" title="77">    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> level<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">sectionNumbers</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-78" title="78">      sectionNumbers[i] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-79" title="79">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-80" title="80"></a>
<a class="sourceLine" id="cb8-81" title="81">    <span class="co">// Now combine section numbers for all heading levels</span></a>
<a class="sourceLine" id="cb8-82" title="82">    <span class="co">// to produce a section number like 2.3.1.</span></a>
<a class="sourceLine" id="cb8-83" title="83">    <span class="kw">let</span> sectionNumber <span class="op">=</span> <span class="va">sectionNumbers</span>.<span class="at">slice</span>(<span class="dv">0</span><span class="op">,</span> level).<span class="at">join</span>(<span class="st">&quot;.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-84" title="84"></a>
<a class="sourceLine" id="cb8-85" title="85">    <span class="co">// Add the section number to the section header title.</span></a>
<a class="sourceLine" id="cb8-86" title="86">    <span class="co">// We place the number in a &lt;span&gt; to make it styleable.</span></a>
<a class="sourceLine" id="cb8-87" title="87">    <span class="kw">let</span> span <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;span&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-88" title="88">    <span class="va">span</span>.<span class="at">className</span> <span class="op">=</span> <span class="st">&quot;TOCSectNum&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-89" title="89">    <span class="va">span</span>.<span class="at">textContent</span> <span class="op">=</span> sectionNumber<span class="op">;</span></a>
<a class="sourceLine" id="cb8-90" title="90">    <span class="va">heading</span>.<span class="at">prepend</span>(span)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-91" title="91"></a>
<a class="sourceLine" id="cb8-92" title="92">    <span class="co">// Wrap the heading in a named anchor so we can link to it.</span></a>
<a class="sourceLine" id="cb8-93" title="93">    <span class="kw">let</span> anchor <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-94" title="94">    <span class="kw">let</span> fragmentName <span class="op">=</span> <span class="vs">`TOC</span><span class="sc">${</span>sectionNumber<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-95" title="95">    <span class="va">anchor</span>.<span class="at">name</span> <span class="op">=</span> fragmentName<span class="op">;</span></a>
<a class="sourceLine" id="cb8-96" title="96">    <span class="va">heading</span>.<span class="at">before</span>(anchor)<span class="op">;</span> <span class="co">// Insert anchor before heading</span></a>
<a class="sourceLine" id="cb8-97" title="97">    <span class="va">anchor</span>.<span class="at">append</span>(heading)<span class="op">;</span> <span class="co">// and move heading inside anchor</span></a>
<a class="sourceLine" id="cb8-98" title="98"></a>
<a class="sourceLine" id="cb8-99" title="99">    <span class="co">// Now create a link to this section.</span></a>
<a class="sourceLine" id="cb8-100" title="100">    <span class="kw">let</span> link <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-101" title="101">    <span class="va">link</span>.<span class="at">href</span> <span class="op">=</span> <span class="vs">`#</span><span class="sc">${</span>fragmentName<span class="sc">}</span><span class="vs">`</span><span class="op">;</span> <span class="co">// Link destination</span></a>
<a class="sourceLine" id="cb8-102" title="102"></a>
<a class="sourceLine" id="cb8-103" title="103">    <span class="co">// Copy the heading text into the link. This is a safe use of</span></a>
<a class="sourceLine" id="cb8-104" title="104">    <span class="co">// innerHTML because we are not inserting any untrusted strings.</span></a>
<a class="sourceLine" id="cb8-105" title="105">    <span class="va">link</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">heading</span>.<span class="at">innerHTML</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-106" title="106"></a>
<a class="sourceLine" id="cb8-107" title="107">    <span class="co">// Place the link in a div that is styleable based on the level.</span></a>
<a class="sourceLine" id="cb8-108" title="108">    <span class="kw">let</span> entry <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-109" title="109">    <span class="va">entry</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;TOCEntry&quot;</span><span class="op">,</span> <span class="vs">`TOCLevel</span><span class="sc">${</span>level<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-110" title="110">    <span class="va">entry</span>.<span class="at">append</span>(link)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-111" title="111"></a>
<a class="sourceLine" id="cb8-112" title="112">    <span class="co">// And add the div to the TOC container.</span></a>
<a class="sourceLine" id="cb8-113" title="113">    <span class="va">toc</span>.<span class="at">append</span>(entry)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-114" title="114">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-115" title="115"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-116" title="116"><span class="kw">class</span> TypedMap <span class="kw">extends</span> Map <span class="op">{</span></a>
<a class="sourceLine" id="cb8-117" title="117">  <span class="at">constructor</span>(keyType<span class="op">,</span> valueType<span class="op">,</span> entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-118" title="118">    <span class="co">// If entries are specified, check their types</span></a>
<a class="sourceLine" id="cb8-119" title="119">    <span class="cf">if</span> (entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-120" title="120">      <span class="cf">for</span> (<span class="kw">let</span> [k<span class="op">,</span> v] <span class="kw">of</span> entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-121" title="121">        <span class="cf">if</span> (<span class="kw">typeof</span> k <span class="op">!==</span> keyType <span class="op">||</span> <span class="kw">typeof</span> v <span class="op">!==</span> valueType) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-122" title="122">          <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`Wrong type for entry [</span><span class="sc">${</span>k<span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>v<span class="sc">}</span><span class="vs">]`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-123" title="123">        <span class="op">}</span></a>
<a class="sourceLine" id="cb8-124" title="124">      <span class="op">}</span></a>
<a class="sourceLine" id="cb8-125" title="125">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-126" title="126"></a>
<a class="sourceLine" id="cb8-127" title="127">    <span class="co">// Initialize the superclass with the (type-checked) initial entries</span></a>
<a class="sourceLine" id="cb8-128" title="128">    <span class="kw">super</span>(entries)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-129" title="129"></a>
<a class="sourceLine" id="cb8-130" title="130">    <span class="co">// And then initialize this subclass by storing the types</span></a>
<a class="sourceLine" id="cb8-131" title="131">    <span class="kw">this</span>.<span class="at">keyType</span> <span class="op">=</span> keyType<span class="op">;</span></a>
<a class="sourceLine" id="cb8-132" title="132">    <span class="kw">this</span>.<span class="at">valueType</span> <span class="op">=</span> valueType<span class="op">;</span></a>
<a class="sourceLine" id="cb8-133" title="133">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-134" title="134"></a>
<a class="sourceLine" id="cb8-135" title="135">  <span class="co">// Now redefine the set() method to add type checking for any</span></a>
<a class="sourceLine" id="cb8-136" title="136">  <span class="co">// new entries added to the map.</span></a>
<a class="sourceLine" id="cb8-137" title="137">  <span class="at">set</span>(key<span class="op">,</span> value) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-138" title="138">    <span class="co">// Throw an error if the key or value are of the wrong type</span></a>
<a class="sourceLine" id="cb8-139" title="139">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">keyType</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> key <span class="op">!==</span> <span class="kw">this</span>.<span class="at">keyType</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-140" title="140">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs"> is not of type </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">keyType</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-141" title="141">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-142" title="142">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">valueType</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> value <span class="op">!==</span> <span class="kw">this</span>.<span class="at">valueType</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-143" title="143">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs"> is not of type </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">valueType</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-144" title="144">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-145" title="145"></a>
<a class="sourceLine" id="cb8-146" title="146">    <span class="co">// If the types are correct, we invoke the superclass&#39;s version of</span></a>
<a class="sourceLine" id="cb8-147" title="147">    <span class="co">// the set() method, to actually add the entry to the map. And we</span></a>
<a class="sourceLine" id="cb8-148" title="148">    <span class="co">// return whatever the superclass method returns.</span></a>
<a class="sourceLine" id="cb8-149" title="149">    <span class="cf">return</span> <span class="kw">super</span>.<span class="at">set</span>(key<span class="op">,</span> value)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-150" title="150">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-151" title="151"><span class="op">}</span></a>
<a class="sourceLine" id="cb8-152" title="152"><span class="co">// This function adds property accessor methods for a property with</span></a>
<a class="sourceLine" id="cb8-153" title="153"><span class="co">// the specified name to the object o. The methods are named get&lt;name&gt;</span></a>
<a class="sourceLine" id="cb8-154" title="154"><span class="co">// and set&lt;name&gt;. If a predicate function is supplied, the setter</span></a>
<a class="sourceLine" id="cb8-155" title="155"><span class="co">// method uses it to test its argument for validity before storing it.</span></a>
<a class="sourceLine" id="cb8-156" title="156"><span class="co">// If the predicate returns false, the setter method throws an exception.</span></a>
<a class="sourceLine" id="cb8-157" title="157"><span class="co">//</span></a>
<a class="sourceLine" id="cb8-158" title="158"><span class="co">// The unusual thing about this function is that the property value</span></a>
<a class="sourceLine" id="cb8-159" title="159"><span class="co">// that is manipulated by the getter and setter methods is not stored in</span></a>
<a class="sourceLine" id="cb8-160" title="160"><span class="co">// the object o. Instead, the value is stored only in a local variable</span></a>
<a class="sourceLine" id="cb8-161" title="161"><span class="co">// in this function. The getter and setter methods are also defined</span></a>
<a class="sourceLine" id="cb8-162" title="162"><span class="co">// locally to this function and therefore have access to this local variable.</span></a>
<a class="sourceLine" id="cb8-163" title="163"><span class="co">// This means that the value is private to the two accessor methods, and it</span></a>
<a class="sourceLine" id="cb8-164" title="164"><span class="co">// cannot be set or modified except through the setter method.</span></a>
<a class="sourceLine" id="cb8-165" title="165"><span class="kw">function</span> <span class="at">addPrivateProperty</span>(o<span class="op">,</span> name<span class="op">,</span> predicate) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-166" title="166">  <span class="kw">let</span> value<span class="op">;</span> <span class="co">// This is the property value</span></a>
<a class="sourceLine" id="cb8-167" title="167"></a>
<a class="sourceLine" id="cb8-168" title="168">  <span class="co">// The getter method simply returns the value.</span></a>
<a class="sourceLine" id="cb8-169" title="169">  o[<span class="vs">`get</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>] <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-170" title="170">    <span class="cf">return</span> value<span class="op">;</span></a>
<a class="sourceLine" id="cb8-171" title="171">  <span class="op">};</span></a>
<a class="sourceLine" id="cb8-172" title="172"></a>
<a class="sourceLine" id="cb8-173" title="173">  <span class="co">// The setter method stores the value or throws an exception if</span></a>
<a class="sourceLine" id="cb8-174" title="174">  <span class="co">// the predicate rejects the value.</span></a>
<a class="sourceLine" id="cb8-175" title="175">  o[<span class="vs">`set</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>] <span class="op">=</span> (v) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-176" title="176">    <span class="cf">if</span> (predicate <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="at">predicate</span>(v)) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-177" title="177">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`set</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">: invalid value </span><span class="sc">${</span>v<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-178" title="178">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-179" title="179">      value <span class="op">=</span> v<span class="op">;</span></a>
<a class="sourceLine" id="cb8-180" title="180">    <span class="op">}</span></a>
<a class="sourceLine" id="cb8-181" title="181">  <span class="op">};</span></a>
<a class="sourceLine" id="cb8-182" title="182"><span class="op">}</span></a>
<a class="sourceLine" id="cb8-183" title="183"></a>
<a class="sourceLine" id="cb8-184" title="184"><span class="co">// The following code demonstrates the addPrivateProperty() method.</span></a>
<a class="sourceLine" id="cb8-185" title="185"><span class="kw">let</span> o <span class="op">=</span> <span class="op">{};</span> <span class="co">// Here is an empty object</span></a>
<a class="sourceLine" id="cb8-186" title="186"></a>
<a class="sourceLine" id="cb8-187" title="187"><span class="co">// Add property accessor methods getName and setName()</span></a>
<a class="sourceLine" id="cb8-188" title="188"><span class="co">// Ensure that only string values are allowed</span></a>
<a class="sourceLine" id="cb8-189" title="189"><span class="at">addPrivateProperty</span>(o<span class="op">,</span> <span class="st">&quot;Name&quot;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> <span class="kw">typeof</span> x <span class="op">===</span> <span class="st">&quot;string&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-190" title="190"></a>
<a class="sourceLine" id="cb8-191" title="191"><span class="va">o</span>.<span class="at">setName</span>(<span class="st">&quot;Frank&quot;</span>)<span class="op">;</span> <span class="co">// Set the property value</span></a>
<a class="sourceLine" id="cb8-192" title="192"><span class="va">o</span>.<span class="at">getName</span>()<span class="op">;</span> <span class="co">// =&gt; &quot;Frank&quot;</span></a>
<a class="sourceLine" id="cb8-193" title="193"><span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;o.getName(): &quot;</span><span class="op">,</span> <span class="va">o</span>.<span class="at">getName</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb8-194" title="194"><span class="co">// o.setName(0); // !TypeError: try to set a value of the wrong type</span></a>
<a class="sourceLine" id="cb8-195" title="195"></a>
<a class="sourceLine" id="cb8-196" title="196"><span class="co">/*</span></a>
<a class="sourceLine" id="cb8-197" title="197"></a>
<a class="sourceLine" id="cb8-198" title="198"><span class="co">node addPrivateProperty.js</span></a>
<a class="sourceLine" id="cb8-199" title="199"><span class="co">o.getName(): Frank |</span></a>
<a class="sourceLine" id="cb8-200" title="200"><span class="co">  09: 01: 36 | bryan @LAPTOP - 9 LGJ3JGS: [ js - files ] js - files_exitstatus: 0[ ╗__________________________________________________________o &gt;</span></a>
<a class="sourceLine" id="cb8-201" title="201"></a>
<a class="sourceLine" id="cb8-202" title="202"></a>
<a class="sourceLine" id="cb8-203" title="203"><span class="co">*/</span></a>
<a class="sourceLine" id="cb8-204" title="204"><span class="co">//APPEND-DIR.js</span></a>
<a class="sourceLine" id="cb8-205" title="205"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>( <span class="st">&#39;fs&#39;</span> )<span class="op">;</span> <span class="kw">let</span> cat <span class="op">=</span> <span class="at">require</span>( <span class="st">&#39;child_process&#39;</span> ).<span class="at">execSync</span>( <span class="st">&#39;cat *&#39;</span> ).<span class="at">toString</span>( <span class="st">&#39;UTF-8&#39;</span> )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-206" title="206"><span class="va">fs</span>.<span class="at">writeFile</span>( <span class="st">&#39;output.md&#39;</span><span class="op">,</span> cat<span class="op">,</span> ( err ) <span class="kw">=&gt;</span> <span class="op">{</span> <span class="cf">if</span> ( err ) <span class="cf">throw</span> err<span class="op">;</span> <span class="op">}</span> )<span class="op">;</span></a>
<a class="sourceLine" id="cb8-207" title="207"><span class="kw">function</span> <span class="at">arraycopy</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb8-208" title="208">  <span class="im">from</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-209" title="209">  to <span class="op">=</span> <span class="im">from</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-210" title="210">  n <span class="op">=</span> <span class="im">from</span>.<span class="at">length</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-211" title="211">  fromIndex <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-212" title="212">  toIndex <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb8-213" title="213"><span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-214" title="214">  <span class="kw">let</span> valuesToCopy <span class="op">=</span> <span class="im">from</span>.<span class="at">slice</span>(fromIndex<span class="op">,</span> fromIndex <span class="op">+</span> n)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-215" title="215">  <span class="va">to</span>.<span class="at">splice</span>(toIndex<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> ...<span class="at">valuesToCopy</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-216" title="216">  <span class="cf">return</span> to<span class="op">;</span></a>
<a class="sourceLine" id="cb8-217" title="217"><span class="op">}</span></a>
<a class="sourceLine" id="cb8-218" title="218"><span class="kw">let</span> a <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb8-219" title="219"><span class="kw">let</span> b <span class="op">=</span> [<span class="dv">9</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb8-220" title="220"><span class="at">arraycopy</span>(<span class="op">{</span> <span class="dt">from</span><span class="op">:</span> a<span class="op">,</span> <span class="dt">n</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">to</span><span class="op">:</span> b<span class="op">,</span> <span class="dt">toIndex</span><span class="op">:</span> <span class="dv">4</span> <span class="op">}</span>)<span class="op">;</span> <span class="co">// =&gt; [9,8,7,6,1,2,3,5]</span></a></code></pre></div>
<hr />
<p>/<em> </em> Define a new Object.assignDescriptors() function that works like * Object.assign() except that it copies property descriptors from * source objects into the target object instead of just copying * property values. This function copies all own properties, both * enumerable and non-enumerable. And because it copies descriptors, * it copies getter functions from source objects and overwrites setter * functions in the target object rather than invoking those getters and * setters. <em> </em> Object.assignDescriptors() propagates any TypeErrors thrown by * Object.defineProperty(). This can occur if the target object is sealed * or frozen or if any of the source properties try to change an existing * non-configurable property on the target object. <em> </em> Note that the assignDescriptors property is added to Object with * Object.defineProperty() so that the new function can be created as * a non-enumerable property like Object.assign(). */</p>
<hr />
<p>```js Object.defineProperty(Object, “assignDescriptors”, { // Match the attributes of Object.assign() writable: true, enumerable: false, configurable: true, // The function that is the value of the assignDescriptors property. value(target, …sources) { for (let source of sources) { for (let name of Object.getOwnPropertyNames(source)) { let desc = Object.getOwnPropertyDescriptor(source, name); Object.defineProperty(target, name, desc); }</p>
<pre><code>  for (let symbol of Object.getOwnPropertySymbols(source)) {
    let desc = Object.getOwnPropertyDescriptor(source, symbol);
    Object.defineProperty(target, symbol, desc);
  }
}
return target;</code></pre>
<p>}, }); // Read lines of text from the source stream, and write any lines // that match the specified pattern to the destination stream. async function grep(source, destination, pattern, encoding = “utf8”) { // Set up the source stream for reading strings, not Buffers source.setEncoding(encoding);</p>
<p>// Set an error handler on the destination stream in case standard // output closes unexpectedly (when piping output to <code>head</code>, e.g.) destination.on(“error”, (err) =&gt; process.exit());</p>
<p>// The chunks we read are unlikely to end with a newline, so each will // probably have a partial line at the end. Track that here let incompleteLine = "";</p>
<p>// Use a for/await loop to asynchronously read chunks from the input stream for await (let chunk of source) { // Split the end of the last chunk plus this one into lines let lines = (incompleteLine + chunk).split(“”); // The last line is incomplete incompleteLine = lines.pop(); // Now loop through the lines and write any matches to the destination for (let line of lines) { if (pattern.test(line)) { destination.write(<code>${line}\n</code>, encoding); } } } // Finally, check for a match on any trailing text. if (pattern.test(incompleteLine)) { destination.write(<code>${incompleteLine}\n</code>, encoding); } }</p>
<p>let pattern = new RegExp(process.argv[2]); // Get a RegExp from command line. grep(process.stdin, process.stdout, pattern) // Call the async grep() function. .catch((err) =&gt; { // Handle asynchronous exceptions. console.error(err); process.exit(); }); const threads = require(“worker_threads”);</p>
<p>if (threads.isMainThread) { let sharedBuffer = new SharedArrayBuffer(4); let sharedArray = new Int32Array(sharedBuffer); let worker = new threads.Worker(__filename, { workerData: sharedArray });</p>
<p>worker.on(“online”, () =&gt; { for (let i = 0; i &lt; 10_000_000; i++) { Atomics.add(sharedArray, 0, 1); // Threadsafe atomic increment }</p>
<pre><code>worker.on(&quot;message&quot;, (message) =&gt; {
  // When both threads are done, use a threadsafe function
  // to read the shared array and confirm that it has the
  // expected value of 20,000,000.
  console.log(Atomics.load(sharedArray, 0));
});</code></pre>
<p>}); } else { let sharedArray = threads.workerData; for (let i = 0; i &lt; 10_000_000; i++) { Atomics.add(sharedArray, 0, 1); // Threadsafe atomic increment } threads.parentPort.postMessage(“done”); }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> This Node program reads text from standard input, computes the frequency </em> of each letter in that text, and displays a histogram of the most * frequently used characters. It requires Node 12 or higher to run. <em> </em> In a Unix-type environment you can invoke the program like this: * node charfreq.js &lt; corpus.txt */</p>
<hr />
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">// This class extends Map so that the get() method returns the specified</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co">// value instead of null when the key is not in the map</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="kw">class</span> DefaultMap <span class="kw">extends</span> Map <span class="op">{</span></a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="at">constructor</span>(defaultValue) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-6" title="6">    <span class="kw">super</span>()<span class="op">;</span> <span class="co">// Invoke superclass constructor</span></a>
<a class="sourceLine" id="cb11-7" title="7">    <span class="kw">this</span>.<span class="at">defaultValue</span> <span class="op">=</span> defaultValue<span class="op">;</span> <span class="co">// Remember the default value</span></a>
<a class="sourceLine" id="cb11-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-9" title="9"></a>
<a class="sourceLine" id="cb11-10" title="10">  <span class="at">get</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-11" title="11">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">has</span>(key)) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-12" title="12">      <span class="co">// If the key is already in the map</span></a>
<a class="sourceLine" id="cb11-13" title="13">      <span class="cf">return</span> <span class="kw">super</span>.<span class="at">get</span>(key)<span class="op">;</span> <span class="co">// return its value from superclass.</span></a>
<a class="sourceLine" id="cb11-14" title="14">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-15" title="15">      <span class="cf">return</span> <span class="kw">this</span>.<span class="at">defaultValue</span><span class="op">;</span> <span class="co">// Otherwise return the default value</span></a>
<a class="sourceLine" id="cb11-16" title="16">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-17" title="17">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-18" title="18"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-19" title="19"></a>
<a class="sourceLine" id="cb11-20" title="20"><span class="co">// This class computes and displays letter frequency histograms</span></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="kw">class</span> Histogram <span class="op">{</span></a>
<a class="sourceLine" id="cb11-22" title="22">  <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-23" title="23">    <span class="kw">this</span>.<span class="at">letterCounts</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">DefaultMap</span>(<span class="dv">0</span>)<span class="op">;</span> <span class="co">// Map from letters to counts</span></a>
<a class="sourceLine" id="cb11-24" title="24">    <span class="kw">this</span>.<span class="at">totalLetters</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// How many letters in all</span></a>
<a class="sourceLine" id="cb11-25" title="25">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-26" title="26"></a>
<a class="sourceLine" id="cb11-27" title="27">  <span class="co">// This function updates the histogram with the letters of text.</span></a>
<a class="sourceLine" id="cb11-28" title="28">  <span class="at">add</span>(text) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-29" title="29">    <span class="co">// Remove whitespace from the text, and convert to upper case</span></a>
<a class="sourceLine" id="cb11-30" title="30">    text <span class="op">=</span> <span class="va">text</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\s</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&quot;&quot;</span>).<span class="at">toUpperCase</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-31" title="31"></a>
<a class="sourceLine" id="cb11-32" title="32">    <span class="co">// Now loop through the characters of the text</span></a>
<a class="sourceLine" id="cb11-33" title="33">    <span class="cf">for</span> (<span class="kw">let</span> character <span class="kw">of</span> text) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-34" title="34">      <span class="kw">let</span> count <span class="op">=</span> <span class="kw">this</span>.<span class="va">letterCounts</span>.<span class="at">get</span>(character)<span class="op">;</span> <span class="co">// Get old count</span></a>
<a class="sourceLine" id="cb11-35" title="35">      <span class="kw">this</span>.<span class="va">letterCounts</span>.<span class="at">set</span>(character<span class="op">,</span> count <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Increment it</span></a>
<a class="sourceLine" id="cb11-36" title="36">      <span class="kw">this</span>.<span class="at">totalLetters</span><span class="op">++;</span></a>
<a class="sourceLine" id="cb11-37" title="37">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-38" title="38">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-39" title="39"></a>
<a class="sourceLine" id="cb11-40" title="40">  <span class="co">// Convert the histogram to a string that displays an ASCII graphic</span></a>
<a class="sourceLine" id="cb11-41" title="41">  <span class="at">toString</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-42" title="42">    <span class="co">// Convert the Map to an array of [key,value] arrays</span></a>
<a class="sourceLine" id="cb11-43" title="43">    <span class="kw">let</span> entries <span class="op">=</span> [...<span class="va">this</span>.<span class="at">letterCounts</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-44" title="44"></a>
<a class="sourceLine" id="cb11-45" title="45">    <span class="co">// Sort the array by count, then alphabetically</span></a>
<a class="sourceLine" id="cb11-46" title="46">    <span class="va">entries</span>.<span class="at">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-47" title="47">      <span class="co">// A function to define sort order.</span></a>
<a class="sourceLine" id="cb11-48" title="48">      <span class="cf">if</span> (a[<span class="dv">1</span>] <span class="op">===</span> b[<span class="dv">1</span>]) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-49" title="49">        <span class="co">// If the counts are the same</span></a>
<a class="sourceLine" id="cb11-50" title="50">        <span class="cf">return</span> a[<span class="dv">0</span>] <span class="op">&lt;</span> b[<span class="dv">0</span>] <span class="op">?</span> <span class="dv">-1</span> : <span class="dv">1</span><span class="op">;</span> <span class="co">// sort alphabetically.</span></a>
<a class="sourceLine" id="cb11-51" title="51">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-52" title="52">        <span class="co">// If the counts differ</span></a>
<a class="sourceLine" id="cb11-53" title="53">        <span class="cf">return</span> b[<span class="dv">1</span>] <span class="op">-</span> a[<span class="dv">1</span>]<span class="op">;</span> <span class="co">// sort by largest count.</span></a>
<a class="sourceLine" id="cb11-54" title="54">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-55" title="55">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-56" title="56"></a>
<a class="sourceLine" id="cb11-57" title="57">    <span class="co">// Convert the counts to percentages</span></a>
<a class="sourceLine" id="cb11-58" title="58">    <span class="cf">for</span> (<span class="kw">let</span> entry <span class="kw">of</span> entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-59" title="59">      entry[<span class="dv">1</span>] <span class="op">=</span> (entry[<span class="dv">1</span>] / <span class="kw">this</span>.<span class="at">totalLetters</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-60" title="60">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-61" title="61"></a>
<a class="sourceLine" id="cb11-62" title="62">    <span class="co">// Drop any entries less than 1%</span></a>
<a class="sourceLine" id="cb11-63" title="63">    entries <span class="op">=</span> <span class="va">entries</span>.<span class="at">filter</span>((entry) <span class="kw">=&gt;</span> entry[<span class="dv">1</span>] <span class="op">&gt;=</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-64" title="64"></a>
<a class="sourceLine" id="cb11-65" title="65">    <span class="co">// Now convert each entry to a line of text</span></a>
<a class="sourceLine" id="cb11-66" title="66">    <span class="kw">let</span> lines <span class="op">=</span> <span class="va">entries</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb11-67" title="67">      ([l<span class="op">,</span> n]) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>l<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span><span class="st">&quot;#&quot;</span>.<span class="at">repeat</span>(<span class="va">Math</span>.<span class="at">round</span>(n))<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span><span class="va">n</span>.<span class="at">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">%`</span></a>
<a class="sourceLine" id="cb11-68" title="68">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb11-69" title="69"></a>
<a class="sourceLine" id="cb11-70" title="70">    <span class="co">// And return the concatenated lines, separated by newline characters.</span></a>
<a class="sourceLine" id="cb11-71" title="71">    <span class="cf">return</span> <span class="va">lines</span>.<span class="at">join</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-72" title="72">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-73" title="73"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-74" title="74"></a>
<a class="sourceLine" id="cb11-75" title="75"><span class="co">// This async (Promise-returning) function creates a Histogram object,</span></a>
<a class="sourceLine" id="cb11-76" title="76"><span class="co">// asynchronously reads chunks of text from standard input, and adds those chunks to</span></a>
<a class="sourceLine" id="cb11-77" title="77"><span class="co">// the histogram. When it reaches the end of the stream, it returns this histogram</span></a>
<a class="sourceLine" id="cb11-78" title="78"><span class="kw">async</span> <span class="kw">function</span> <span class="at">histogramFromStdin</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-79" title="79">  <span class="va">process</span>.<span class="va">stdin</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf-8&quot;</span>)<span class="op">;</span> <span class="co">// Read Unicode strings, not bytes</span></a>
<a class="sourceLine" id="cb11-80" title="80">  <span class="kw">let</span> histogram <span class="op">=</span> <span class="kw">new</span> <span class="at">Histogram</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-81" title="81">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> <span class="va">process</span>.<span class="at">stdin</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-82" title="82">    <span class="va">histogram</span>.<span class="at">add</span>(chunk)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-83" title="83">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-84" title="84">  <span class="cf">return</span> histogram<span class="op">;</span></a>
<a class="sourceLine" id="cb11-85" title="85"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-86" title="86"></a>
<a class="sourceLine" id="cb11-87" title="87"><span class="co">// This one final line of code is the main body of the program.</span></a>
<a class="sourceLine" id="cb11-88" title="88"><span class="co">// It makes a Histogram object from standard input, then prints the histogram.</span></a>
<a class="sourceLine" id="cb11-89" title="89"><span class="at">histogramFromStdin</span>().<span class="at">then</span>((histogram) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-90" title="90">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">histogram</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb11-91" title="91"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-92" title="92"><span class="co">// This is server-side JavaScript, intended to be run with NodeJS.</span></a>
<a class="sourceLine" id="cb11-93" title="93"><span class="co">// It implements a very simple, completely anonymous chat room.</span></a>
<a class="sourceLine" id="cb11-94" title="94"><span class="co">// POST new messages to /chat, or GET a text/event-stream of messages</span></a>
<a class="sourceLine" id="cb11-95" title="95"><span class="co">// from the same URL. Making a GET request to / returns a simple HTML file</span></a>
<a class="sourceLine" id="cb11-96" title="96"><span class="co">// that contains the client-side chat UI.</span></a>
<a class="sourceLine" id="cb11-97" title="97"><span class="kw">const</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;http&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-98" title="98"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-99" title="99"><span class="kw">const</span> url <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;url&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-100" title="100"></a>
<a class="sourceLine" id="cb11-101" title="101"><span class="co">// The HTML file for the chat client. Used below.</span></a>
<a class="sourceLine" id="cb11-102" title="102"><span class="kw">const</span> clientHTML <span class="op">=</span> <span class="va">fs</span>.<span class="at">readFileSync</span>(<span class="st">&quot;chatClient.html&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-103" title="103"></a>
<a class="sourceLine" id="cb11-104" title="104"><span class="co">// An array of ServerResponse objects that we&#39;re going to send events to</span></a>
<a class="sourceLine" id="cb11-105" title="105"><span class="kw">let</span> clients <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb11-106" title="106"></a>
<a class="sourceLine" id="cb11-107" title="107"><span class="co">// Create a new server, and listen on port 8080.</span></a>
<a class="sourceLine" id="cb11-108" title="108"><span class="co">// Connect to http://localhost:8080/ to use it.</span></a>
<a class="sourceLine" id="cb11-109" title="109"><span class="kw">let</span> server <span class="op">=</span> <span class="kw">new</span> <span class="va">http</span>.<span class="at">Server</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-110" title="110"><span class="va">server</span>.<span class="at">listen</span>(<span class="dv">8080</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-111" title="111"></a>
<a class="sourceLine" id="cb11-112" title="112"><span class="co">// When the server gets a new request, run this function</span></a>
<a class="sourceLine" id="cb11-113" title="113"><span class="va">server</span>.<span class="at">on</span>(<span class="st">&quot;request&quot;</span><span class="op">,</span> (request<span class="op">,</span> response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-114" title="114">  <span class="co">// Parse the requested URL</span></a>
<a class="sourceLine" id="cb11-115" title="115">  <span class="kw">let</span> pathname <span class="op">=</span> <span class="va">url</span>.<span class="at">parse</span>(<span class="va">request</span>.<span class="at">url</span>).<span class="at">pathname</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-116" title="116"></a>
<a class="sourceLine" id="cb11-117" title="117">  <span class="co">// If the request was for &quot;/&quot;, send the client-side chat UI.</span></a>
<a class="sourceLine" id="cb11-118" title="118">  <span class="cf">if</span> (pathname <span class="op">===</span> <span class="st">&quot;/&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-119" title="119">    <span class="co">// A request for the chat UI</span></a>
<a class="sourceLine" id="cb11-120" title="120">    <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span><span class="op">,</span> <span class="op">{</span> <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;text/html&quot;</span> <span class="op">}</span>).<span class="at">end</span>(clientHTML)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-121" title="121">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-122" title="122">  <span class="co">// Otherwise send a 404 error for any path other than &quot;/chat&quot; or for</span></a>
<a class="sourceLine" id="cb11-123" title="123">  <span class="co">// any method other than &quot;GET&quot; and &quot;POST&quot;</span></a>
<a class="sourceLine" id="cb11-124" title="124">  <span class="cf">else</span> <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb11-125" title="125">    pathname <span class="op">!==</span> <span class="st">&quot;/chat&quot;</span> <span class="op">||</span></a>
<a class="sourceLine" id="cb11-126" title="126">    (<span class="va">request</span>.<span class="at">method</span> <span class="op">!==</span> <span class="st">&quot;GET&quot;</span> <span class="op">&amp;&amp;</span> <span class="va">request</span>.<span class="at">method</span> <span class="op">!==</span> <span class="st">&quot;POST&quot;</span>)</a>
<a class="sourceLine" id="cb11-127" title="127">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-128" title="128">    <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">404</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-129" title="129">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-130" title="130">  <span class="co">// If the /chat request was a GET, then a client is connecting.</span></a>
<a class="sourceLine" id="cb11-131" title="131">  <span class="cf">else</span> <span class="cf">if</span> (<span class="va">request</span>.<span class="at">method</span> <span class="op">===</span> <span class="st">&quot;GET&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-132" title="132">    <span class="at">acceptNewClient</span>(request<span class="op">,</span> response)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-133" title="133">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-134" title="134">  <span class="co">// Otherwise the /chat request is a POST of a new message</span></a>
<a class="sourceLine" id="cb11-135" title="135">  <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-136" title="136">    <span class="at">broadcastNewMessage</span>(request<span class="op">,</span> response)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-137" title="137">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-138" title="138"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-139" title="139"></a>
<a class="sourceLine" id="cb11-140" title="140"><span class="co">// This handles GET requests for the /chat endpoint which are generated when</span></a>
<a class="sourceLine" id="cb11-141" title="141"><span class="co">// the client creates a new EventSource object (or when the EventSource</span></a>
<a class="sourceLine" id="cb11-142" title="142"><span class="co">// reconnects automatically).</span></a>
<a class="sourceLine" id="cb11-143" title="143"><span class="kw">function</span> <span class="at">acceptNewClient</span>(request<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-144" title="144">  <span class="co">// Remember the response object so we can send future messages to it</span></a>
<a class="sourceLine" id="cb11-145" title="145">  <span class="va">clients</span>.<span class="at">push</span>(response)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-146" title="146"></a>
<a class="sourceLine" id="cb11-147" title="147">  <span class="co">// If the client closes the connection, remove the corresponding</span></a>
<a class="sourceLine" id="cb11-148" title="148">  <span class="co">// response object from the array of active clients</span></a>
<a class="sourceLine" id="cb11-149" title="149">  <span class="va">request</span>.<span class="va">connection</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-150" title="150">    <span class="va">clients</span>.<span class="at">splice</span>(<span class="va">clients</span>.<span class="at">indexOf</span>(response)<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-151" title="151">    <span class="va">response</span>.<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-152" title="152">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-153" title="153"></a>
<a class="sourceLine" id="cb11-154" title="154">  <span class="co">// Set headers and send an initial chat event to just this one client</span></a>
<a class="sourceLine" id="cb11-155" title="155">  <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-156" title="156">    <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;text/event-stream&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-157" title="157">    <span class="dt">Connection</span><span class="op">:</span> <span class="st">&quot;keep-alive&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-158" title="158">    <span class="st">&quot;Cache-Control&quot;</span><span class="op">:</span> <span class="st">&quot;no-cache&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-159" title="159">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-160" title="160">  <span class="va">response</span>.<span class="at">write</span>(<span class="st">&quot;event: chat</span><span class="sc">\n</span><span class="st">data: Connected</span><span class="sc">\n\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-161" title="161"></a>
<a class="sourceLine" id="cb11-162" title="162">  <span class="co">// Note that we intentionally do not call response.end() here.</span></a>
<a class="sourceLine" id="cb11-163" title="163">  <span class="co">// Keeping the connection open is what makes Server-Sent Events work.</span></a>
<a class="sourceLine" id="cb11-164" title="164"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-165" title="165"></a>
<a class="sourceLine" id="cb11-166" title="166"><span class="co">// This function is called in response to POST requests to the /chat endpoint</span></a>
<a class="sourceLine" id="cb11-167" title="167"><span class="co">// which clients send when users type a new message.</span></a>
<a class="sourceLine" id="cb11-168" title="168"><span class="kw">async</span> <span class="kw">function</span> <span class="at">broadcastNewMessage</span>(request<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-169" title="169">  <span class="co">// First, read the body of the request to get the user&#39;s message</span></a>
<a class="sourceLine" id="cb11-170" title="170">  <span class="va">request</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf8&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-171" title="171">  <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-172" title="172">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> request) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-173" title="173">    body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb11-174" title="174">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-175" title="175"></a>
<a class="sourceLine" id="cb11-176" title="176">  <span class="co">// Once we&#39;ve read the body send an empty response and close the connection</span></a>
<a class="sourceLine" id="cb11-177" title="177">  <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-178" title="178"></a>
<a class="sourceLine" id="cb11-179" title="179">  <span class="co">// Format the message in text/event-stream format, prefixing each</span></a>
<a class="sourceLine" id="cb11-180" title="180">  <span class="co">// line with &quot;data: &quot;</span></a>
<a class="sourceLine" id="cb11-181" title="181">  <span class="kw">let</span> message <span class="op">=</span> <span class="st">&quot;data: &quot;</span> <span class="op">+</span> <span class="va">body</span>.<span class="at">replace</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">data: &quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-182" title="182"></a>
<a class="sourceLine" id="cb11-183" title="183">  <span class="co">// Give the message data a prefix that defines it as a &quot;chat&quot; event</span></a>
<a class="sourceLine" id="cb11-184" title="184">  <span class="co">// and give it a double newline suffix that marks the end of the event.</span></a>
<a class="sourceLine" id="cb11-185" title="185">  <span class="kw">let</span> event <span class="op">=</span> <span class="vs">`event: chat</span><span class="sc">\n${</span>message<span class="sc">}\n\n</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-186" title="186"></a>
<a class="sourceLine" id="cb11-187" title="187">  <span class="co">// Now send this event to all listening clients</span></a>
<a class="sourceLine" id="cb11-188" title="188">  <span class="va">clients</span>.<span class="at">forEach</span>((client) <span class="kw">=&gt;</span> <span class="va">client</span>.<span class="at">write</span>(event))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-189" title="189"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-190" title="190"><span class="co">// Wait for messages from our parent process</span></a>
<a class="sourceLine" id="cb11-191" title="191"><span class="va">process</span>.<span class="at">on</span>(<span class="st">&quot;message&quot;</span><span class="op">,</span> (message) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-192" title="192">  <span class="co">// When we receive one, do a calculation and send the result</span></a>
<a class="sourceLine" id="cb11-193" title="193">  <span class="co">// back to the parent.</span></a>
<a class="sourceLine" id="cb11-194" title="194">  <span class="va">process</span>.<span class="at">send</span>(<span class="op">{</span> <span class="dt">hypotenuse</span><span class="op">:</span> <span class="va">Math</span>.<span class="at">hypot</span>(<span class="va">message</span>.<span class="at">x</span><span class="op">,</span> <span class="va">message</span>.<span class="at">y</span>) <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-195" title="195"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-196" title="196"><span class="kw">function</span> <span class="at">classof</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-197" title="197">  <span class="cf">return</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(o).<span class="at">slice</span>(<span class="dv">8</span><span class="op">,</span> <span class="dv">-1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-198" title="198"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-199" title="199"></a>
<a class="sourceLine" id="cb11-200" title="200"><span class="at">classof</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Null&quot;</span></a>
<a class="sourceLine" id="cb11-201" title="201"><span class="at">classof</span>(<span class="kw">undefined</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Undefined&quot;</span></a>
<a class="sourceLine" id="cb11-202" title="202"><span class="at">classof</span>(<span class="dv">1</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Number&quot;</span></a>
<a class="sourceLine" id="cb11-203" title="203"><span class="at">classof</span>(10n <span class="op">**</span> 100n)<span class="op">;</span> <span class="co">// =&gt; &quot;BigInt&quot;</span></a>
<a class="sourceLine" id="cb11-204" title="204"><span class="at">classof</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;String&quot;</span></a>
<a class="sourceLine" id="cb11-205" title="205"><span class="at">classof</span>(<span class="kw">false</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Boolean&quot;</span></a>
<a class="sourceLine" id="cb11-206" title="206"><span class="at">classof</span>(<span class="at">Symbol</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Symbol&quot;</span></a>
<a class="sourceLine" id="cb11-207" title="207"><span class="at">classof</span>(<span class="op">{}</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Object&quot;</span></a>
<a class="sourceLine" id="cb11-208" title="208"><span class="at">classof</span>([])<span class="op">;</span> <span class="co">// =&gt; &quot;Array&quot;</span></a>
<a class="sourceLine" id="cb11-209" title="209"><span class="at">classof</span>(<span class="ss">/./</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;RegExp&quot;</span></a>
<a class="sourceLine" id="cb11-210" title="210"><span class="at">classof</span>(() <span class="kw">=&gt;</span> <span class="op">{}</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Function&quot;</span></a>
<a class="sourceLine" id="cb11-211" title="211"><span class="at">classof</span>(<span class="kw">new</span> <span class="at">Map</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Map&quot;</span></a>
<a class="sourceLine" id="cb11-212" title="212"><span class="at">classof</span>(<span class="kw">new</span> <span class="at">Set</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Set&quot;</span></a>
<a class="sourceLine" id="cb11-213" title="213"><span class="at">classof</span>(<span class="kw">new</span> <span class="at">Date</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Date&quot;</span></a>
<a class="sourceLine" id="cb11-214" title="214"></a>
<a class="sourceLine" id="cb11-215" title="215"><span class="kw">class</span> Range <span class="op">{</span></a>
<a class="sourceLine" id="cb11-216" title="216">  get [<span class="va">Symbol</span>.<span class="at">toStringTag</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-217" title="217">    <span class="cf">return</span> <span class="st">&quot;Range&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-218" title="218">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-219" title="219">  <span class="co">// the rest of this class is omitted here</span></a>
<a class="sourceLine" id="cb11-220" title="220"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-221" title="221"><span class="kw">let</span> r <span class="op">=</span> <span class="kw">new</span> <span class="at">Range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-222" title="222"><span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(r)<span class="op">;</span> <span class="co">// =&gt; &quot;[object Range]&quot;</span></a>
<a class="sourceLine" id="cb11-223" title="223"><span class="at">classof</span>(r)<span class="op">;</span> <span class="co">// =&gt; &quot;Range&quot;</span></a>
<a class="sourceLine" id="cb11-224" title="224"><span class="co">// Define some drawing attributes</span></a>
<a class="sourceLine" id="cb11-225" title="225"><span class="va">c</span>.<span class="at">font</span> <span class="op">=</span> <span class="st">&quot;bold 60pt sans-serif&quot;</span><span class="op">;</span> <span class="co">// Big font</span></a>
<a class="sourceLine" id="cb11-226" title="226"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> <span class="co">// Narrow lines</span></a>
<a class="sourceLine" id="cb11-227" title="227"><span class="va">c</span>.<span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">&quot;#000&quot;</span><span class="op">;</span> <span class="co">// Black lines</span></a>
<a class="sourceLine" id="cb11-228" title="228"></a>
<a class="sourceLine" id="cb11-229" title="229"><span class="co">// Outline a rectangle and some text</span></a>
<a class="sourceLine" id="cb11-230" title="230"><span class="va">c</span>.<span class="at">strokeRect</span>(<span class="dv">175</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">325</span>)<span class="op">;</span> <span class="co">// A vertical stripe down the middle</span></a>
<a class="sourceLine" id="cb11-231" title="231"><span class="va">c</span>.<span class="at">strokeText</span>(<span class="st">&quot;&lt;canvas&gt;&quot;</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">330</span>)<span class="op">;</span> <span class="co">// Note strokeText() instead of fillText()</span></a>
<a class="sourceLine" id="cb11-232" title="232"></a>
<a class="sourceLine" id="cb11-233" title="233"><span class="co">// Define a complex path with an interior that is outside.</span></a>
<a class="sourceLine" id="cb11-234" title="234"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">200</span><span class="op">,</span> <span class="dv">225</span><span class="op">,</span> <span class="dv">200</span>)<span class="op">;</span> <span class="co">// Large triangle</span></a>
<a class="sourceLine" id="cb11-235" title="235"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">200</span><span class="op">,</span> <span class="dv">225</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="co">// Smaller reverse triangle inside</span></a>
<a class="sourceLine" id="cb11-236" title="236"></a>
<a class="sourceLine" id="cb11-237" title="237"><span class="co">// Make that path the clipping region.</span></a>
<a class="sourceLine" id="cb11-238" title="238"><span class="va">c</span>.<span class="at">clip</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-239" title="239"></a>
<a class="sourceLine" id="cb11-240" title="240"><span class="co">// Stroke the path with a 5 pixel line, entirely inside the clipping region.</span></a>
<a class="sourceLine" id="cb11-241" title="241"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">10</span><span class="op">;</span> <span class="co">// Half of this 10 pixel line will be clipped away</span></a>
<a class="sourceLine" id="cb11-242" title="242"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-243" title="243"></a>
<a class="sourceLine" id="cb11-244" title="244"><span class="co">// Fill the parts of the rectangle and text that are inside the clipping region</span></a>
<a class="sourceLine" id="cb11-245" title="245"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#aaa&quot;</span><span class="op">;</span> <span class="co">// Light gray</span></a>
<a class="sourceLine" id="cb11-246" title="246"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">175</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">325</span>)<span class="op">;</span> <span class="co">// Fill the vertical stripe</span></a>
<a class="sourceLine" id="cb11-247" title="247"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#888&quot;</span><span class="op">;</span> <span class="co">// Darker gray</span></a>
<a class="sourceLine" id="cb11-248" title="248"><span class="va">c</span>.<span class="at">fillText</span>(<span class="st">&quot;&lt;canvas&gt;&quot;</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">330</span>)<span class="op">;</span> <span class="co">// Fill the text</span></a>
<a class="sourceLine" id="cb11-249" title="249">(<span class="kw">function</span> <span class="at">updateClock</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-250" title="250">  <span class="co">// Update the SVG clock graphic to show current time</span></a>
<a class="sourceLine" id="cb11-251" title="251">  <span class="kw">let</span> now <span class="op">=</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">;</span> <span class="co">// Current time</span></a>
<a class="sourceLine" id="cb11-252" title="252">  <span class="kw">let</span> sec <span class="op">=</span> <span class="va">now</span>.<span class="at">getSeconds</span>()<span class="op">;</span> <span class="co">// Seconds</span></a>
<a class="sourceLine" id="cb11-253" title="253">  <span class="kw">let</span> min <span class="op">=</span> <span class="va">now</span>.<span class="at">getMinutes</span>() <span class="op">+</span> sec / <span class="dv">60</span><span class="op">;</span> <span class="co">// Fractional minutes</span></a>
<a class="sourceLine" id="cb11-254" title="254">  <span class="kw">let</span> hour <span class="op">=</span> (<span class="va">now</span>.<span class="at">getHours</span>() <span class="op">%</span> <span class="dv">12</span>) <span class="op">+</span> min / <span class="dv">60</span><span class="op">;</span> <span class="co">// Fractional hours</span></a>
<a class="sourceLine" id="cb11-255" title="255">  <span class="kw">let</span> minangle <span class="op">=</span> min <span class="op">*</span> <span class="dv">6</span><span class="op">;</span> <span class="co">// 6 degrees per minute</span></a>
<a class="sourceLine" id="cb11-256" title="256">  <span class="kw">let</span> hourangle <span class="op">=</span> hour <span class="op">*</span> <span class="dv">30</span><span class="op">;</span> <span class="co">// 30 degrees per hour</span></a>
<a class="sourceLine" id="cb11-257" title="257"></a>
<a class="sourceLine" id="cb11-258" title="258">  <span class="co">// Get SVG elements for the hands of the clock</span></a>
<a class="sourceLine" id="cb11-259" title="259">  <span class="kw">let</span> minhand <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#clock .minutehand&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-260" title="260">  <span class="kw">let</span> hourhand <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#clock .hourhand&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-261" title="261"></a>
<a class="sourceLine" id="cb11-262" title="262">  <span class="co">// Set an SVG attribute on them to move them around the clock face</span></a>
<a class="sourceLine" id="cb11-263" title="263">  <span class="va">minhand</span>.<span class="at">setAttribute</span>(<span class="st">&quot;transform&quot;</span><span class="op">,</span> <span class="vs">`rotate(</span><span class="sc">${</span>minangle<span class="sc">}</span><span class="vs">,50,50)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-264" title="264">  <span class="va">hourhand</span>.<span class="at">setAttribute</span>(<span class="st">&quot;transform&quot;</span><span class="op">,</span> <span class="vs">`rotate(</span><span class="sc">${</span>hourangle<span class="sc">}</span><span class="vs">,50,50)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-265" title="265"></a>
<a class="sourceLine" id="cb11-266" title="266">  <span class="co">// Run this function again in 10 seconds</span></a>
<a class="sourceLine" id="cb11-267" title="267">  <span class="at">setTimeout</span>(updateClock<span class="op">,</span> <span class="dv">10000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-268" title="268"><span class="op">}</span>)()<span class="op">;</span> <span class="co">// Note immediate invocation of the function here.</span></a>
<a class="sourceLine" id="cb11-269" title="269"><span class="co">// A Promise-based wrapper around setTimeout() that we can use await with.</span></a>
<a class="sourceLine" id="cb11-270" title="270"><span class="co">// Returns a Promise that fulfills in the specified number of milliseconds</span></a>
<a class="sourceLine" id="cb11-271" title="271"><span class="kw">function</span> <span class="at">elapsedTime</span>(ms) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-272" title="272">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="kw">=&gt;</span> <span class="at">setTimeout</span>(resolve<span class="op">,</span> ms))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-273" title="273"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-274" title="274"></a>
<a class="sourceLine" id="cb11-275" title="275"><span class="co">// An async generator function that increments a counter and yields it</span></a>
<a class="sourceLine" id="cb11-276" title="276"><span class="co">// a specified (or infinite) number of times at a specified interval.</span></a>
<a class="sourceLine" id="cb11-277" title="277"><span class="kw">async</span> <span class="kw">function</span><span class="op">*</span> <span class="at">clock</span>(interval<span class="op">,</span> max <span class="op">=</span> <span class="kw">Infinity</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-278" title="278">  <span class="cf">for</span> (<span class="kw">let</span> count <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> count <span class="op">&lt;=</span> max<span class="op">;</span> count<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-279" title="279">    <span class="co">// regular for loop</span></a>
<a class="sourceLine" id="cb11-280" title="280">    <span class="cf">await</span> <span class="at">elapsedTime</span>(interval)<span class="op">;</span> <span class="co">// wait for time to pass</span></a>
<a class="sourceLine" id="cb11-281" title="281">    <span class="kw">yield</span> count<span class="op">;</span> <span class="co">// yield the counter</span></a>
<a class="sourceLine" id="cb11-282" title="282">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-283" title="283"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-284" title="284"></a>
<a class="sourceLine" id="cb11-285" title="285"><span class="co">// A test function that uses the async generator with for/await</span></a>
<a class="sourceLine" id="cb11-286" title="286"><span class="kw">async</span> <span class="kw">function</span> <span class="at">test</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-287" title="287">  <span class="co">// Async so we can use for/await</span></a>
<a class="sourceLine" id="cb11-288" title="288">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> tick <span class="kw">of</span> <span class="at">clock</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">100</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-289" title="289">    <span class="co">// Loop 100 times every 300ms</span></a>
<a class="sourceLine" id="cb11-290" title="290">    <span class="va">console</span>.<span class="at">log</span>(tick)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-291" title="291">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-292" title="292"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-293" title="293"><span class="kw">function</span> <span class="at">clock</span>(interval<span class="op">,</span> max <span class="op">=</span> <span class="kw">Infinity</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-294" title="294">  <span class="co">// A Promise-ified version of setTimeout that we can use await with.</span></a>
<a class="sourceLine" id="cb11-295" title="295">  <span class="co">// Note that this takes an absolute time instead of an interval.</span></a>
<a class="sourceLine" id="cb11-296" title="296">  <span class="kw">function</span> <span class="at">until</span>(time) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-297" title="297">    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="kw">=&gt;</span> <span class="at">setTimeout</span>(resolve<span class="op">,</span> time <span class="op">-</span> <span class="va">Date</span>.<span class="at">now</span>()))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-298" title="298">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-299" title="299"></a>
<a class="sourceLine" id="cb11-300" title="300">  <span class="kw">let</span> startTime <span class="op">=</span> <span class="va">Date</span>.<span class="at">now</span>()<span class="op">;</span> <span class="co">// Remember when we started</span></a>
<a class="sourceLine" id="cb11-301" title="301">  <span class="kw">let</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// Remember which iteration we&#39;re on</span></a>
<a class="sourceLine" id="cb11-302" title="302"></a>
<a class="sourceLine" id="cb11-303" title="303">  <span class="co">// Return an asynchronously iterable object</span></a>
<a class="sourceLine" id="cb11-304" title="304">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-305" title="305">    <span class="kw">async</span> <span class="at">next</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-306" title="306">      <span class="co">// The next() method makes this an iterator</span></a>
<a class="sourceLine" id="cb11-307" title="307">      <span class="cf">if</span> (<span class="op">++</span>count <span class="op">&gt;</span> max) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-308" title="308">        <span class="co">// Are we done?</span></a>
<a class="sourceLine" id="cb11-309" title="309">        <span class="cf">return</span> <span class="op">{</span> <span class="dt">done</span><span class="op">:</span> <span class="kw">true</span> <span class="op">};</span> <span class="co">// Iteration result indicating done</span></a>
<a class="sourceLine" id="cb11-310" title="310">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-311" title="311">      <span class="co">// Figure out when the next iteration should begin,</span></a>
<a class="sourceLine" id="cb11-312" title="312">      <span class="kw">let</span> targetTime <span class="op">=</span> startTime <span class="op">+</span> count <span class="op">*</span> interval<span class="op">;</span></a>
<a class="sourceLine" id="cb11-313" title="313">      <span class="co">// wait until that time,</span></a>
<a class="sourceLine" id="cb11-314" title="314">      <span class="cf">await</span> <span class="at">until</span>(targetTime)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-315" title="315">      <span class="co">// and return the count value in an iteration result object.</span></a>
<a class="sourceLine" id="cb11-316" title="316">      <span class="cf">return</span> <span class="op">{</span> <span class="dt">value</span><span class="op">:</span> count <span class="op">};</span></a>
<a class="sourceLine" id="cb11-317" title="317">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-318" title="318">    <span class="co">// This method means that this iterator object is also an iterable.</span></a>
<a class="sourceLine" id="cb11-319" title="319">    [<span class="va">Symbol</span>.<span class="at">asyncIterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-320" title="320">      <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-321" title="321">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-322" title="322">  <span class="op">};</span></a>
<a class="sourceLine" id="cb11-323" title="323"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-324" title="324"><span class="co">// Return a new function that computes f(g(...)).</span></a>
<a class="sourceLine" id="cb11-325" title="325"><span class="co">// The returned function h passes all of its arguments to g, then passes</span></a>
<a class="sourceLine" id="cb11-326" title="326"><span class="co">// the return value of g to f, then returns the return value of f.</span></a>
<a class="sourceLine" id="cb11-327" title="327"><span class="co">// Both f and g are invoked with the same this value as h was invoked with.</span></a>
<a class="sourceLine" id="cb11-328" title="328"><span class="kw">function</span> <span class="at">compose</span>(f<span class="op">,</span> g) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-329" title="329">  <span class="cf">return</span> <span class="kw">function</span> (...<span class="at">args</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-330" title="330">    <span class="co">// We use call for f because we&#39;re passing a single value and</span></a>
<a class="sourceLine" id="cb11-331" title="331">    <span class="co">// apply for g because we&#39;re passing an array of values.</span></a>
<a class="sourceLine" id="cb11-332" title="332">    <span class="cf">return</span> <span class="va">f</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> <span class="va">g</span>.<span class="at">apply</span>(<span class="kw">this</span><span class="op">,</span> args))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-333" title="333">  <span class="op">};</span></a>
<a class="sourceLine" id="cb11-334" title="334"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-335" title="335"></a>
<a class="sourceLine" id="cb11-336" title="336"><span class="kw">const</span> sum <span class="op">=</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y<span class="op">;</span></a>
<a class="sourceLine" id="cb11-337" title="337"><span class="kw">const</span> square <span class="op">=</span> (x) <span class="kw">=&gt;</span> x <span class="op">*</span> x<span class="op">;</span></a>
<a class="sourceLine" id="cb11-338" title="338"><span class="at">compose</span>(square<span class="op">,</span> sum)(<span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span> <span class="co">// =&gt; 25; the square of the sum</span></a>
<a class="sourceLine" id="cb11-339" title="339"><span class="co">// This function writes the specified chunk to the specified stream and</span></a>
<a class="sourceLine" id="cb11-340" title="340"><span class="co">// returns a Promise that will be fulfilled when it is OK to write again.</span></a>
<a class="sourceLine" id="cb11-341" title="341"><span class="co">// Because it returns a Promise, it can be used with await.</span></a>
<a class="sourceLine" id="cb11-342" title="342"><span class="kw">function</span> <span class="at">write</span>(stream<span class="op">,</span> chunk) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-343" title="343">  <span class="co">// Write the specified chunk to the specified stream</span></a>
<a class="sourceLine" id="cb11-344" title="344">  <span class="kw">let</span> hasMoreRoom <span class="op">=</span> <span class="va">stream</span>.<span class="at">write</span>(chunk)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-345" title="345"></a>
<a class="sourceLine" id="cb11-346" title="346">  <span class="cf">if</span> (hasMoreRoom) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-347" title="347">    <span class="co">// If buffer is not full, return</span></a>
<a class="sourceLine" id="cb11-348" title="348">    <span class="cf">return</span> <span class="va">Promise</span>.<span class="at">resolve</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// an already resolved Promise object</span></a>
<a class="sourceLine" id="cb11-349" title="349">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-350" title="350">    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-351" title="351">      <span class="co">// Otherwise, return a Promise that</span></a>
<a class="sourceLine" id="cb11-352" title="352">      <span class="va">stream</span>.<span class="at">once</span>(<span class="st">&quot;drain&quot;</span><span class="op">,</span> resolve)<span class="op">;</span> <span class="co">// resolves on the drain event.</span></a>
<a class="sourceLine" id="cb11-353" title="353">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-354" title="354">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-355" title="355"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-356" title="356"></a>
<a class="sourceLine" id="cb11-357" title="357"><span class="co">// Copy data from the source stream to the destination stream</span></a>
<a class="sourceLine" id="cb11-358" title="358"><span class="co">// respecting backpressure from the destination stream.</span></a>
<a class="sourceLine" id="cb11-359" title="359"><span class="co">// This is much like calling source.pipe(destination).</span></a>
<a class="sourceLine" id="cb11-360" title="360"><span class="kw">async</span> <span class="kw">function</span> <span class="at">copy</span>(source<span class="op">,</span> destination) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-361" title="361">  <span class="co">// Set an error handler on the destination stream in case standard</span></a>
<a class="sourceLine" id="cb11-362" title="362">  <span class="co">// output closes unexpectedly (when piping output to `head`, e.g.)</span></a>
<a class="sourceLine" id="cb11-363" title="363">  <span class="va">destination</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="va">process</span>.<span class="at">exit</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb11-364" title="364"></a>
<a class="sourceLine" id="cb11-365" title="365">  <span class="co">// Use a for/await loop to asynchronously read chunks from the input stream</span></a>
<a class="sourceLine" id="cb11-366" title="366">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> source) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-367" title="367">    <span class="co">// Write the chunk and wait until there is more room in the buffer.</span></a>
<a class="sourceLine" id="cb11-368" title="368">    <span class="cf">await</span> <span class="at">write</span>(destination<span class="op">,</span> chunk)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-369" title="369">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-370" title="370"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-371" title="371"></a>
<a class="sourceLine" id="cb11-372" title="372"><span class="co">// Copy standard input to standard output</span></a>
<a class="sourceLine" id="cb11-373" title="373"><span class="at">copy</span>(<span class="va">process</span>.<span class="at">stdin</span><span class="op">,</span> <span class="va">process</span>.<span class="at">stdout</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-374" title="374"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-375" title="375"></a>
<a class="sourceLine" id="cb11-376" title="376"><span class="co">// A streaming file copy function, using &quot;flowing mode&quot;.</span></a>
<a class="sourceLine" id="cb11-377" title="377"><span class="co">// Copies the contents of the named source file to the named destination file.</span></a>
<a class="sourceLine" id="cb11-378" title="378"><span class="co">// On success, invokes the callback with a null argument. On error,</span></a>
<a class="sourceLine" id="cb11-379" title="379"><span class="co">// invokes the callback with an Error object.</span></a>
<a class="sourceLine" id="cb11-380" title="380"><span class="kw">function</span> <span class="at">copyFile</span>(sourceFilename<span class="op">,</span> destinationFilename<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-381" title="381">  <span class="kw">let</span> input <span class="op">=</span> <span class="va">fs</span>.<span class="at">createReadStream</span>(sourceFilename)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-382" title="382">  <span class="kw">let</span> output <span class="op">=</span> <span class="va">fs</span>.<span class="at">createWriteStream</span>(destinationFilename)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-383" title="383"></a>
<a class="sourceLine" id="cb11-384" title="384">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;data&quot;</span><span class="op">,</span> (chunk) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-385" title="385">    <span class="co">// When we get new data,</span></a>
<a class="sourceLine" id="cb11-386" title="386">    <span class="kw">let</span> hasRoom <span class="op">=</span> <span class="va">output</span>.<span class="at">write</span>(chunk)<span class="op">;</span> <span class="co">// write it to the output stream.</span></a>
<a class="sourceLine" id="cb11-387" title="387">    <span class="cf">if</span> (<span class="op">!</span>hasRoom) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-388" title="388">      <span class="co">// If the output stream is full</span></a>
<a class="sourceLine" id="cb11-389" title="389">      <span class="va">input</span>.<span class="at">pause</span>()<span class="op">;</span> <span class="co">// then pause the input stream.</span></a>
<a class="sourceLine" id="cb11-390" title="390">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-391" title="391">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-392" title="392">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-393" title="393">    <span class="co">// When we reach the end of input,</span></a>
<a class="sourceLine" id="cb11-394" title="394">    <span class="va">output</span>.<span class="at">end</span>()<span class="op">;</span> <span class="co">// tell the output stream to end.</span></a>
<a class="sourceLine" id="cb11-395" title="395">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-396" title="396">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-397" title="397">    <span class="co">// If we get an error on the input,</span></a>
<a class="sourceLine" id="cb11-398" title="398">    <span class="at">callback</span>(err)<span class="op">;</span> <span class="co">// call the callback with the error</span></a>
<a class="sourceLine" id="cb11-399" title="399">    <span class="va">process</span>.<span class="at">exit</span>()<span class="op">;</span> <span class="co">// and quit.</span></a>
<a class="sourceLine" id="cb11-400" title="400">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-401" title="401"></a>
<a class="sourceLine" id="cb11-402" title="402">  <span class="va">output</span>.<span class="at">on</span>(<span class="st">&quot;drain&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-403" title="403">    <span class="co">// When the output is no longer full,</span></a>
<a class="sourceLine" id="cb11-404" title="404">    <span class="va">input</span>.<span class="at">resume</span>()<span class="op">;</span> <span class="co">// resume data events on the input</span></a>
<a class="sourceLine" id="cb11-405" title="405">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-406" title="406">  <span class="va">output</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-407" title="407">    <span class="co">// If we get an error on the output,</span></a>
<a class="sourceLine" id="cb11-408" title="408">    <span class="at">callback</span>(err)<span class="op">;</span> <span class="co">// call the callback with the error</span></a>
<a class="sourceLine" id="cb11-409" title="409">    <span class="va">process</span>.<span class="at">exit</span>()<span class="op">;</span> <span class="co">// and quit.</span></a>
<a class="sourceLine" id="cb11-410" title="410">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-411" title="411">  <span class="va">output</span>.<span class="at">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-412" title="412">    <span class="co">// When output is fully written</span></a>
<a class="sourceLine" id="cb11-413" title="413">    <span class="at">callback</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// call the callback with no error.</span></a>
<a class="sourceLine" id="cb11-414" title="414">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-415" title="415"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-416" title="416"></a>
<a class="sourceLine" id="cb11-417" title="417"><span class="co">// Here&#39;s a simple command-line utility to copy files</span></a>
<a class="sourceLine" id="cb11-418" title="418"><span class="kw">let</span> <span class="im">from</span> <span class="op">=</span> <span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb11-419" title="419">  to <span class="op">=</span> <span class="va">process</span>.<span class="at">argv</span>[<span class="dv">3</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-420" title="420"><span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Copying file </span><span class="sc">${</span><span class="im">from</span><span class="sc">}</span><span class="vs"> to </span><span class="sc">${</span>to<span class="sc">}</span><span class="vs">...`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-421" title="421"><span class="at">copyFile</span>(<span class="im">from</span><span class="op">,</span> to<span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-422" title="422">  <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-423" title="423">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-424" title="424">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-425" title="425">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;done.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-426" title="426">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-427" title="427"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-428" title="428"><span class="kw">function</span> <span class="at">counter</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-429" title="429">  <span class="kw">let</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-430" title="430">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-431" title="431">    <span class="dt">count</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb11-432" title="432">      <span class="cf">return</span> n<span class="op">++;</span></a>
<a class="sourceLine" id="cb11-433" title="433">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-434" title="434">    <span class="dt">reset</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb11-435" title="435">      n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-436" title="436">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-437" title="437">  <span class="op">};</span></a>
<a class="sourceLine" id="cb11-438" title="438"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-439" title="439"></a>
<a class="sourceLine" id="cb11-440" title="440"><span class="kw">let</span> c <span class="op">=</span> <span class="at">counter</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb11-441" title="441">  d <span class="op">=</span> <span class="at">counter</span>()<span class="op">;</span> <span class="co">// Create two counters</span></a>
<a class="sourceLine" id="cb11-442" title="442"><span class="va">c</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 0</span></a>
<a class="sourceLine" id="cb11-443" title="443"><span class="va">d</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 0: they count independently</span></a>
<a class="sourceLine" id="cb11-444" title="444"><span class="va">c</span>.<span class="at">reset</span>()<span class="op">;</span> <span class="co">// reset() and count() methods share state</span></a>
<a class="sourceLine" id="cb11-445" title="445"><span class="va">c</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 0: because we reset c</span></a>
<a class="sourceLine" id="cb11-446" title="446"><span class="va">d</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 1: d was not reset</span></a>
<a class="sourceLine" id="cb11-447" title="447"><span class="kw">function</span> <span class="at">counter</span>(n) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-448" title="448">  <span class="co">// Function argument n is the private variable</span></a>
<a class="sourceLine" id="cb11-449" title="449">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-450" title="450">    <span class="co">// Property getter method returns and increments private counter var.</span></a>
<a class="sourceLine" id="cb11-451" title="451">    get <span class="at">count</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-452" title="452">      <span class="cf">return</span> n<span class="op">++;</span></a>
<a class="sourceLine" id="cb11-453" title="453">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-454" title="454">    <span class="co">// Property setter doesn&#39;t allow the value of n to decrease</span></a>
<a class="sourceLine" id="cb11-455" title="455">    set <span class="at">count</span>(m) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-456" title="456">      <span class="cf">if</span> (m <span class="op">&gt;</span> n) n <span class="op">=</span> m<span class="op">;</span></a>
<a class="sourceLine" id="cb11-457" title="457">      <span class="cf">else</span> <span class="cf">throw</span> <span class="at">Error</span>(<span class="st">&quot;count can only be set to a larger value&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-458" title="458">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-459" title="459">  <span class="op">};</span></a>
<a class="sourceLine" id="cb11-460" title="460"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-461" title="461"></a>
<a class="sourceLine" id="cb11-462" title="462"><span class="kw">let</span> c <span class="op">=</span> <span class="at">counter</span>(<span class="dv">1000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-463" title="463"><span class="va">c</span>.<span class="at">count</span><span class="op">;</span> <span class="co">// =&gt; 1000</span></a>
<a class="sourceLine" id="cb11-464" title="464"><span class="va">c</span>.<span class="at">count</span><span class="op">;</span> <span class="co">// =&gt; 1001</span></a>
<a class="sourceLine" id="cb11-465" title="465"><span class="va">c</span>.<span class="at">count</span> <span class="op">=</span> <span class="dv">2000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-466" title="466"><span class="va">c</span>.<span class="at">count</span><span class="op">;</span> <span class="co">// =&gt; 2000</span></a>
<a class="sourceLine" id="cb11-467" title="467"><span class="va">c</span>.<span class="at">count</span> <span class="op">=</span> <span class="dv">2000</span><span class="op">;</span> <span class="co">// !Error: count can only be set to a larger value</span></a>
<a class="sourceLine" id="cb11-468" title="468"><span class="co">// A utility function to convert angles from degrees to radians</span></a>
<a class="sourceLine" id="cb11-469" title="469"><span class="kw">function</span> <span class="at">rads</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-470" title="470">  <span class="cf">return</span> (<span class="va">Math</span>.<span class="at">PI</span> <span class="op">*</span> x) / <span class="dv">180</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-471" title="471"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-472" title="472"></a>
<a class="sourceLine" id="cb11-473" title="473"><span class="co">// Get the context object of the document&#39;s canvas element</span></a>
<a class="sourceLine" id="cb11-474" title="474"><span class="kw">let</span> c <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;canvas&quot;</span>).<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-475" title="475"></a>
<a class="sourceLine" id="cb11-476" title="476"><span class="co">// Define some graphics attributes and draw the curves</span></a>
<a class="sourceLine" id="cb11-477" title="477"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#aaa&quot;</span><span class="op">;</span> <span class="co">// Gray fills</span></a>
<a class="sourceLine" id="cb11-478" title="478"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> <span class="co">// 2-pixel black (by default) lines</span></a>
<a class="sourceLine" id="cb11-479" title="479"></a>
<a class="sourceLine" id="cb11-480" title="480"><span class="co">// Draw a circle.</span></a>
<a class="sourceLine" id="cb11-481" title="481"><span class="co">// There is no current point, so draw just the circle with no straight</span></a>
<a class="sourceLine" id="cb11-482" title="482"><span class="co">// line from the current point to the start of the circle.</span></a>
<a class="sourceLine" id="cb11-483" title="483"><span class="va">c</span>.<span class="at">beginPath</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-484" title="484"><span class="va">c</span>.<span class="at">arc</span>(</a>
<a class="sourceLine" id="cb11-485" title="485">  <span class="dv">75</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-486" title="486">  <span class="dv">100</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-487" title="487">  <span class="dv">50</span><span class="op">,</span> <span class="co">// Center at (75,100), radius 50</span></a>
<a class="sourceLine" id="cb11-488" title="488">  <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-489" title="489">  <span class="at">rads</span>(<span class="dv">360</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb11-490" title="490">  <span class="kw">false</span></a>
<a class="sourceLine" id="cb11-491" title="491">)<span class="op">;</span> <span class="co">// Go clockwise from 0 to 360 degrees</span></a>
<a class="sourceLine" id="cb11-492" title="492"><span class="va">c</span>.<span class="at">fill</span>()<span class="op">;</span> <span class="co">// Fill the circle</span></a>
<a class="sourceLine" id="cb11-493" title="493"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span> <span class="co">// Stroke its outline.</span></a>
<a class="sourceLine" id="cb11-494" title="494"></a>
<a class="sourceLine" id="cb11-495" title="495"><span class="co">// Now draw an ellipse in the same way</span></a>
<a class="sourceLine" id="cb11-496" title="496"><span class="va">c</span>.<span class="at">beginPath</span>()<span class="op">;</span> <span class="co">// Start new path not connected to the circle</span></a>
<a class="sourceLine" id="cb11-497" title="497"><span class="va">c</span>.<span class="at">ellipse</span>(</a>
<a class="sourceLine" id="cb11-498" title="498">  <span class="dv">200</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-499" title="499">  <span class="dv">100</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-500" title="500">  <span class="dv">50</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-501" title="501">  <span class="dv">35</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-502" title="502">  <span class="at">rads</span>(<span class="dv">15</span>)<span class="op">,</span> <span class="co">// Center, radii, and rotation</span></a>
<a class="sourceLine" id="cb11-503" title="503">  <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-504" title="504">  <span class="at">rads</span>(<span class="dv">360</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb11-505" title="505">  <span class="kw">false</span></a>
<a class="sourceLine" id="cb11-506" title="506">)<span class="op">;</span> <span class="co">// Start angle, end angle, direction</span></a>
<a class="sourceLine" id="cb11-507" title="507"></a>
<a class="sourceLine" id="cb11-508" title="508"><span class="co">// Draw a wedge. Angles are measured clockwise from the positive x axis.</span></a>
<a class="sourceLine" id="cb11-509" title="509"><span class="co">// Note that arc() adds a line from the current point to the arc start.</span></a>
<a class="sourceLine" id="cb11-510" title="510"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">325</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="co">// Start at the center of the circle.</span></a>
<a class="sourceLine" id="cb11-511" title="511"><span class="va">c</span>.<span class="at">arc</span>(</a>
<a class="sourceLine" id="cb11-512" title="512">  <span class="dv">325</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-513" title="513">  <span class="dv">100</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-514" title="514">  <span class="dv">50</span><span class="op">,</span> <span class="co">// Circle center and radius</span></a>
<a class="sourceLine" id="cb11-515" title="515">  <span class="at">rads</span>(<span class="op">-</span><span class="dv">60</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb11-516" title="516">  <span class="at">rads</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="co">// Start at angle -60 and go to angle 0</span></a>
<a class="sourceLine" id="cb11-517" title="517">  <span class="kw">true</span></a>
<a class="sourceLine" id="cb11-518" title="518">)<span class="op">;</span> <span class="co">// counterclockwise</span></a>
<a class="sourceLine" id="cb11-519" title="519"><span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Add radius back to the center of the circle</span></a>
<a class="sourceLine" id="cb11-520" title="520"></a>
<a class="sourceLine" id="cb11-521" title="521"><span class="co">// Similar wedge, offset a bit, and in the opposite direction</span></a>
<a class="sourceLine" id="cb11-522" title="522"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">340</span><span class="op">,</span> <span class="dv">92</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-523" title="523"><span class="va">c</span>.<span class="at">arc</span>(<span class="dv">340</span><span class="op">,</span> <span class="dv">92</span><span class="op">,</span> <span class="dv">42</span><span class="op">,</span> <span class="at">rads</span>(<span class="op">-</span><span class="dv">60</span>)<span class="op">,</span> <span class="at">rads</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-524" title="524"><span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-525" title="525"></a>
<a class="sourceLine" id="cb11-526" title="526"><span class="co">// Use arcTo() for rounded corners. Here we draw a square with</span></a>
<a class="sourceLine" id="cb11-527" title="527"><span class="co">// upper left corner at (400,50) and corners of varying radii.</span></a>
<a class="sourceLine" id="cb11-528" title="528"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">450</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span> <span class="co">// Begin in the middle of the top edge.</span></a>
<a class="sourceLine" id="cb11-529" title="529"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">500</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">;</span> <span class="co">// Add part of top edge and upper right corner.</span></a>
<a class="sourceLine" id="cb11-530" title="530"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">500</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">400</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">;</span> <span class="co">// Add right edge and lower right corner.</span></a>
<a class="sourceLine" id="cb11-531" title="531"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">400</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">400</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span> <span class="co">// Add bottom edge and lower left corner.</span></a>
<a class="sourceLine" id="cb11-532" title="532"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">400</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Add left edge and upper left corner.</span></a>
<a class="sourceLine" id="cb11-533" title="533"><span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Close path to add the rest of the top edge.</span></a>
<a class="sourceLine" id="cb11-534" title="534"></a>
<a class="sourceLine" id="cb11-535" title="535"><span class="co">// Quadratic Bezier curve: one control point</span></a>
<a class="sourceLine" id="cb11-536" title="536"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">525</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// Begin here</span></a>
<a class="sourceLine" id="cb11-537" title="537"><span class="va">c</span>.<span class="at">quadraticCurveTo</span>(<span class="dv">550</span><span class="op">,</span> <span class="dv">75</span><span class="op">,</span> <span class="dv">625</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// Draw a curve to (625, 125)</span></a>
<a class="sourceLine" id="cb11-538" title="538"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">550</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">75</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span> <span class="co">// Mark the control point (550,75)</span></a>
<a class="sourceLine" id="cb11-539" title="539"></a>
<a class="sourceLine" id="cb11-540" title="540"><span class="co">// Cubic Bezier curve</span></a>
<a class="sourceLine" id="cb11-541" title="541"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">625</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="co">// Start at (625, 100)</span></a>
<a class="sourceLine" id="cb11-542" title="542"><span class="va">c</span>.<span class="at">bezierCurveTo</span>(<span class="dv">645</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">705</span><span class="op">,</span> <span class="dv">130</span><span class="op">,</span> <span class="dv">725</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="co">// Curve to (725, 100)</span></a>
<a class="sourceLine" id="cb11-543" title="543"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">645</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">70</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span> <span class="co">// Mark control points</span></a>
<a class="sourceLine" id="cb11-544" title="544"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">705</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">130</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-545" title="545"></a>
<a class="sourceLine" id="cb11-546" title="546"><span class="co">// Finally, fill the curves and stroke their outlines.</span></a>
<a class="sourceLine" id="cb11-547" title="547"><span class="va">c</span>.<span class="at">fill</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-548" title="548"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-549" title="549"><span class="co">// Convert [x,y] coordinates to [r,theta] polar coordinates</span></a>
<a class="sourceLine" id="cb11-550" title="550"><span class="kw">function</span> <span class="at">toPolar</span>(x<span class="op">,</span> y) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-551" title="551">  <span class="cf">return</span> [<span class="va">Math</span>.<span class="at">sqrt</span>(x <span class="op">*</span> x <span class="op">+</span> y <span class="op">*</span> y)<span class="op">,</span> <span class="va">Math</span>.<span class="at">atan2</span>(y<span class="op">,</span> x)]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-552" title="552"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-553" title="553"></a>
<a class="sourceLine" id="cb11-554" title="554"><span class="co">// Convert polar to Cartesian coordinates</span></a>
<a class="sourceLine" id="cb11-555" title="555"><span class="kw">function</span> <span class="at">toCartesian</span>(r<span class="op">,</span> theta) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-556" title="556">  <span class="cf">return</span> [r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(theta)<span class="op">,</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(theta)]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-557" title="557"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-558" title="558"></a>
<a class="sourceLine" id="cb11-559" title="559"><span class="kw">let</span> [r<span class="op">,</span> theta] <span class="op">=</span> <span class="at">toPolar</span>(<span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span>)<span class="op">;</span> <span class="co">// r == Math.sqrt(2); theta == Math.PI/4</span></a>
<a class="sourceLine" id="cb11-560" title="560"><span class="kw">let</span> [x<span class="op">,</span> y] <span class="op">=</span> <span class="at">toCartesian</span>(r<span class="op">,</span> theta)<span class="op">;</span> <span class="co">// [x, y] == [1.0, 1,0]</span></a>
<a class="sourceLine" id="cb11-561" title="561"><span class="co">// Print the name and value of each property of o.  Return undefined.</span></a>
<a class="sourceLine" id="cb11-562" title="562"><span class="kw">function</span> <span class="at">printprops</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-563" title="563">  <span class="cf">for</span> (<span class="kw">let</span> p <span class="kw">in</span> o) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-564" title="564">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span>p<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>o[p]<span class="sc">}\n</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-565" title="565">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-566" title="566"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-567" title="567"></a>
<a class="sourceLine" id="cb11-568" title="568"><span class="co">// Compute the distance between Cartesian points (x1,y1) and (x2,y2).</span></a>
<a class="sourceLine" id="cb11-569" title="569"><span class="kw">function</span> <span class="at">distance</span>(x1<span class="op">,</span> y1<span class="op">,</span> x2<span class="op">,</span> y2) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-570" title="570">  <span class="kw">let</span> dx <span class="op">=</span> x2 <span class="op">-</span> x1<span class="op">;</span></a>
<a class="sourceLine" id="cb11-571" title="571">  <span class="kw">let</span> dy <span class="op">=</span> y2 <span class="op">-</span> y1<span class="op">;</span></a>
<a class="sourceLine" id="cb11-572" title="572">  <span class="cf">return</span> <span class="va">Math</span>.<span class="at">sqrt</span>(dx <span class="op">*</span> dx <span class="op">+</span> dy <span class="op">*</span> dy)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-573" title="573"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-574" title="574"></a>
<a class="sourceLine" id="cb11-575" title="575"><span class="co">// A recursive function (one that calls itself) that computes factorials</span></a>
<a class="sourceLine" id="cb11-576" title="576"><span class="co">// Recall that x! is the product of x and all positive integers less than it.</span></a>
<a class="sourceLine" id="cb11-577" title="577"><span class="kw">function</span> <span class="at">factorial</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-578" title="578">  <span class="cf">if</span> (x <span class="op">&lt;=</span> <span class="dv">1</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-579" title="579">  <span class="cf">return</span> x <span class="op">*</span> <span class="at">factorial</span>(x <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-580" title="580"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-581" title="581"><span class="co">// Compute factorials and cache results as properties of the function itself.</span></a>
<a class="sourceLine" id="cb11-582" title="582"><span class="kw">function</span> <span class="at">factorial</span>(n) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-583" title="583">  <span class="cf">if</span> (<span class="va">Number</span>.<span class="at">isInteger</span>(n) <span class="op">&amp;&amp;</span> n <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-584" title="584">    <span class="co">// Positive integers only</span></a>
<a class="sourceLine" id="cb11-585" title="585">    <span class="cf">if</span> (<span class="op">!</span>(n <span class="kw">in</span> factorial)) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-586" title="586">      <span class="co">// If no cached result</span></a>
<a class="sourceLine" id="cb11-587" title="587">      factorial[n] <span class="op">=</span> n <span class="op">*</span> <span class="at">factorial</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Compute and cache it</span></a>
<a class="sourceLine" id="cb11-588" title="588">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-589" title="589">    <span class="cf">return</span> factorial[n]<span class="op">;</span> <span class="co">// Return the cached result</span></a>
<a class="sourceLine" id="cb11-590" title="590">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-591" title="591">    <span class="cf">return</span> <span class="kw">NaN</span><span class="op">;</span> <span class="co">// If input was bad</span></a>
<a class="sourceLine" id="cb11-592" title="592">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-593" title="593"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-594" title="594">factorial[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Initialize the cache to hold this base case.</span></a>
<a class="sourceLine" id="cb11-595" title="595"><span class="at">factorial</span>(<span class="dv">6</span>)<span class="op">;</span> <span class="co">// =&gt; 720</span></a>
<a class="sourceLine" id="cb11-596" title="596">factorial[<span class="dv">5</span>]<span class="op">;</span> <span class="co">// =&gt; 120; the call above caches this value</span></a>
<a class="sourceLine" id="cb11-597" title="597"><span class="kw">function</span> <span class="at">fetchSequentially</span>(urls) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-598" title="598">  <span class="co">// We&#39;ll store the URL bodies here as we fetch them</span></a>
<a class="sourceLine" id="cb11-599" title="599">  <span class="kw">const</span> bodies <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb11-600" title="600"></a>
<a class="sourceLine" id="cb11-601" title="601">  <span class="co">// Here&#39;s a Promise-returning function that fetches one body</span></a>
<a class="sourceLine" id="cb11-602" title="602">  <span class="kw">function</span> <span class="at">fetchOne</span>(url) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-603" title="603">    <span class="cf">return</span> <span class="at">fetch</span>(url)</a>
<a class="sourceLine" id="cb11-604" title="604">      .<span class="at">then</span>((response) <span class="kw">=&gt;</span> <span class="va">response</span>.<span class="at">text</span>())</a>
<a class="sourceLine" id="cb11-605" title="605">      .<span class="at">then</span>((body) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-606" title="606">        <span class="co">// We save the body to the array, and we&#39;re purposely</span></a>
<a class="sourceLine" id="cb11-607" title="607">        <span class="co">// omitting a return value here (returning undefined)</span></a>
<a class="sourceLine" id="cb11-608" title="608">        <span class="va">bodies</span>.<span class="at">push</span>(body)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-609" title="609">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-610" title="610">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-611" title="611"></a>
<a class="sourceLine" id="cb11-612" title="612">  <span class="co">// Start with a Promise that will fulfill right away (with value undefined)</span></a>
<a class="sourceLine" id="cb11-613" title="613">  <span class="kw">let</span> p <span class="op">=</span> <span class="va">Promise</span>.<span class="at">resolve</span>(<span class="kw">undefined</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-614" title="614"></a>
<a class="sourceLine" id="cb11-615" title="615">  <span class="co">// Now loop through the desired URLs, building a Promise chain</span></a>
<a class="sourceLine" id="cb11-616" title="616">  <span class="co">// of arbitrary length, fetching one URL at each stage of the chain</span></a>
<a class="sourceLine" id="cb11-617" title="617">  <span class="cf">for</span> (url <span class="kw">of</span> urls) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-618" title="618">    p <span class="op">=</span> <span class="va">p</span>.<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="at">fetchOne</span>(url))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-619" title="619">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-620" title="620"></a>
<a class="sourceLine" id="cb11-621" title="621">  <span class="co">// When the last Promise in that chain is fulfilled, then the</span></a>
<a class="sourceLine" id="cb11-622" title="622">  <span class="co">// bodies array is ready. So let&#39;s return a Promise for that</span></a>
<a class="sourceLine" id="cb11-623" title="623">  <span class="co">// bodies array. Note that we don&#39;t include any error handlers:</span></a>
<a class="sourceLine" id="cb11-624" title="624">  <span class="co">// we want to allow errors to propagate to the caller.</span></a>
<a class="sourceLine" id="cb11-625" title="625">  <span class="cf">return</span> <span class="va">p</span>.<span class="at">then</span>(() <span class="kw">=&gt;</span> bodies)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-626" title="626"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-627" title="627"><span class="at">fetch</span>(<span class="st">&quot;/api/users/current&quot;</span>) <span class="co">// Make an HTTP (or HTTPS) GET request.</span></a>
<a class="sourceLine" id="cb11-628" title="628">  .<span class="at">then</span>((response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-629" title="629">    <span class="co">// When we get a response, first check it</span></a>
<a class="sourceLine" id="cb11-630" title="630">    <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb11-631" title="631">      <span class="va">response</span>.<span class="at">ok</span> <span class="op">&amp;&amp;</span> <span class="co">// for a success code and the expected type.</span></a>
<a class="sourceLine" id="cb11-632" title="632">      <span class="va">response</span>.<span class="va">headers</span>.<span class="at">get</span>(<span class="st">&quot;Content-Type&quot;</span>) <span class="op">===</span> <span class="st">&quot;application/json&quot;</span></a>
<a class="sourceLine" id="cb11-633" title="633">    ) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-634" title="634">      <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>()<span class="op">;</span> <span class="co">// Return a Promise for the body.</span></a>
<a class="sourceLine" id="cb11-635" title="635">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-636" title="636">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>( <span class="co">// Or throw an error.</span></a>
<a class="sourceLine" id="cb11-637" title="637">        <span class="vs">`Unexpected response status </span><span class="sc">${</span><span class="va">response</span>.<span class="at">status</span><span class="sc">}</span><span class="vs"> or content type`</span></a>
<a class="sourceLine" id="cb11-638" title="638">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb11-639" title="639">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-640" title="640">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb11-641" title="641">  .<span class="at">then</span>((currentUser) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-642" title="642">    <span class="co">// When the response.json() Promise resolves</span></a>
<a class="sourceLine" id="cb11-643" title="643">    <span class="at">displayUserInfo</span>(currentUser)<span class="op">;</span> <span class="co">// do something with the parsed body.</span></a>
<a class="sourceLine" id="cb11-644" title="644">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb11-645" title="645">  .<span class="at">catch</span>((error) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-646" title="646">    <span class="co">// Or if anything went wrong, just log the error.</span></a>
<a class="sourceLine" id="cb11-647" title="647">    <span class="co">// If the user&#39;s browser is offline, fetch() itself will reject.</span></a>
<a class="sourceLine" id="cb11-648" title="648">    <span class="co">// If the server returns a bad response then we throw an error above.</span></a>
<a class="sourceLine" id="cb11-649" title="649">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Error while fetching current user:&quot;</span><span class="op">,</span> error)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-650" title="650">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-651" title="651"><span class="co">// This function is like fetch(), but it adds support for a timeout</span></a>
<a class="sourceLine" id="cb11-652" title="652"><span class="co">// property in the options object and aborts the fetch if it is not complete</span></a>
<a class="sourceLine" id="cb11-653" title="653"><span class="co">// within the number of milliseconds specified by that property.</span></a>
<a class="sourceLine" id="cb11-654" title="654"><span class="kw">function</span> <span class="at">fetchWithTimeout</span>(url<span class="op">,</span> options <span class="op">=</span> <span class="op">{}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-655" title="655">  <span class="cf">if</span> (<span class="va">options</span>.<span class="at">timeout</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-656" title="656">    <span class="co">// If the timeout property exists and is nonzero</span></a>
<a class="sourceLine" id="cb11-657" title="657">    <span class="kw">let</span> controller <span class="op">=</span> <span class="kw">new</span> <span class="at">AbortController</span>()<span class="op">;</span> <span class="co">// Create a controller</span></a>
<a class="sourceLine" id="cb11-658" title="658">    <span class="va">options</span>.<span class="at">signal</span> <span class="op">=</span> <span class="va">controller</span>.<span class="at">signal</span><span class="op">;</span> <span class="co">// Set the signal property</span></a>
<a class="sourceLine" id="cb11-659" title="659">    <span class="co">// Start a timer that will send the abort signal after the specified</span></a>
<a class="sourceLine" id="cb11-660" title="660">    <span class="co">// number of milliseconds have passed. Note that we never cancel</span></a>
<a class="sourceLine" id="cb11-661" title="661">    <span class="co">// this timer. Calling abort() after the fetch is complete has</span></a>
<a class="sourceLine" id="cb11-662" title="662">    <span class="co">// no effect.</span></a>
<a class="sourceLine" id="cb11-663" title="663">    <span class="at">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-664" title="664">      <span class="va">controller</span>.<span class="at">abort</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-665" title="665">    <span class="op">},</span> <span class="va">options</span>.<span class="at">timeout</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-666" title="666">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-667" title="667">  <span class="co">// Now just perform a normal fetch</span></a>
<a class="sourceLine" id="cb11-668" title="668">  <span class="cf">return</span> <span class="at">fetch</span>(url<span class="op">,</span> options)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-669" title="669"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-670" title="670"><span class="kw">function</span><span class="op">*</span> <span class="at">fibonacciSequence</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-671" title="671">  <span class="kw">let</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-672" title="672">    y <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-673" title="673">  <span class="cf">for</span> (<span class="op">;;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-674" title="674">    <span class="kw">yield</span> y<span class="op">;</span></a>
<a class="sourceLine" id="cb11-675" title="675">    [x<span class="op">,</span> y] <span class="op">=</span> [y<span class="op">,</span> x <span class="op">+</span> y]<span class="op">;</span> <span class="co">// Note: destructuring assignment</span></a>
<a class="sourceLine" id="cb11-676" title="676">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-677" title="677"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-678" title="678"><span class="co">// Return an iterable object that filters the specified iterable,</span></a>
<a class="sourceLine" id="cb11-679" title="679"><span class="co">// iterating only those elements for which the predicate returns true</span></a>
<a class="sourceLine" id="cb11-680" title="680"><span class="kw">function</span> <span class="at">filter</span>(iterable<span class="op">,</span> predicate) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-681" title="681">  <span class="kw">let</span> iterator <span class="op">=</span> iterable[<span class="va">Symbol</span>.<span class="at">iterator</span>]()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-682" title="682">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-683" title="683">    <span class="co">// This object is both iterator and iterable</span></a>
<a class="sourceLine" id="cb11-684" title="684">    [<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-685" title="685">      <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-686" title="686">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-687" title="687">    <span class="at">next</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-688" title="688">      <span class="cf">for</span> (<span class="op">;;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-689" title="689">        <span class="kw">let</span> v <span class="op">=</span> <span class="va">iterator</span>.<span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-690" title="690">        <span class="cf">if</span> (<span class="va">v</span>.<span class="at">done</span> <span class="op">||</span> <span class="at">predicate</span>(<span class="va">v</span>.<span class="at">value</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-691" title="691">          <span class="cf">return</span> v<span class="op">;</span></a>
<a class="sourceLine" id="cb11-692" title="692">        <span class="op">}</span></a>
<a class="sourceLine" id="cb11-693" title="693">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-694" title="694">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-695" title="695">  <span class="op">};</span></a>
<a class="sourceLine" id="cb11-696" title="696"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-697" title="697"></a>
<a class="sourceLine" id="cb11-698" title="698"><span class="co">// Filter a range so we&#39;re left with only even numbers</span></a>
<a class="sourceLine" id="cb11-699" title="699">[...<span class="at">filter</span>(<span class="kw">new</span> <span class="at">Range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> (x) <span class="kw">=&gt;</span> x <span class="op">%</span> <span class="dv">2</span> <span class="op">===</span> <span class="dv">0</span>)]<span class="op">;</span> <span class="co">// =&gt; [2,4,6,8,10]</span></a>
<a class="sourceLine" id="cb11-700" title="700"><span class="co">// Find all occurrences of a value x in an array a and return an array</span></a>
<a class="sourceLine" id="cb11-701" title="701"><span class="co">// of matching indexes</span></a>
<a class="sourceLine" id="cb11-702" title="702"><span class="kw">function</span> <span class="at">findall</span>(a<span class="op">,</span> x) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-703" title="703">  <span class="kw">let</span> results <span class="op">=</span> []<span class="op">,</span> <span class="co">// The array of indexes we&#39;ll return</span></a>
<a class="sourceLine" id="cb11-704" title="704">    len <span class="op">=</span> <span class="va">a</span>.<span class="at">length</span><span class="op">,</span> <span class="co">// The length of the array to be searched</span></a>
<a class="sourceLine" id="cb11-705" title="705">    pos <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// The position to search from</span></a>
<a class="sourceLine" id="cb11-706" title="706">  <span class="cf">while</span> (pos <span class="op">&lt;</span> len) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-707" title="707">    <span class="co">// While more elements to search...</span></a>
<a class="sourceLine" id="cb11-708" title="708">    pos <span class="op">=</span> <span class="va">a</span>.<span class="at">indexOf</span>(x<span class="op">,</span> pos)<span class="op">;</span> <span class="co">// Search</span></a>
<a class="sourceLine" id="cb11-709" title="709">    <span class="cf">if</span> (pos <span class="op">===</span> <span class="dv">-1</span>) <span class="cf">break</span><span class="op">;</span> <span class="co">// If nothing found, we&#39;re done.</span></a>
<a class="sourceLine" id="cb11-710" title="710">    <span class="va">results</span>.<span class="at">push</span>(pos)<span class="op">;</span> <span class="co">// Otherwise, store index in array</span></a>
<a class="sourceLine" id="cb11-711" title="711">    pos <span class="op">=</span> pos <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// And start next search at next element</span></a>
<a class="sourceLine" id="cb11-712" title="712">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-713" title="713">  <span class="cf">return</span> results<span class="op">;</span> <span class="co">// Return array of indexes</span></a>
<a class="sourceLine" id="cb11-714" title="714"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-715" title="715"><span class="co">// Return the document&#39;s cookies as a Map object.</span></a>
<a class="sourceLine" id="cb11-716" title="716"><span class="co">// Assume that cookie values are encoded with encodeURIComponent().</span></a>
<a class="sourceLine" id="cb11-717" title="717"><span class="kw">function</span> <span class="at">getCookies</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-718" title="718">  <span class="kw">let</span> cookies <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>()<span class="op">;</span> <span class="co">// The object we will return</span></a>
<a class="sourceLine" id="cb11-719" title="719">  <span class="kw">let</span> all <span class="op">=</span> <span class="va">document</span>.<span class="at">cookie</span><span class="op">;</span> <span class="co">// Get all cookies in one big string</span></a>
<a class="sourceLine" id="cb11-720" title="720">  <span class="kw">let</span> list <span class="op">=</span> <span class="va">all</span>.<span class="at">split</span>(<span class="st">&quot;; &quot;</span>)<span class="op">;</span> <span class="co">// Split into individual name/value pairs</span></a>
<a class="sourceLine" id="cb11-721" title="721">  <span class="cf">for</span> (<span class="kw">let</span> cookie <span class="kw">of</span> list) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-722" title="722">    <span class="co">// For each cookie in that list</span></a>
<a class="sourceLine" id="cb11-723" title="723">    <span class="cf">if</span> (<span class="op">!</span><span class="va">cookie</span>.<span class="at">includes</span>(<span class="st">&quot;=&quot;</span>)) <span class="cf">continue</span><span class="op">;</span> <span class="co">// Skip if there is no = sign</span></a>
<a class="sourceLine" id="cb11-724" title="724">    <span class="kw">let</span> p <span class="op">=</span> <span class="va">cookie</span>.<span class="at">indexOf</span>(<span class="st">&quot;=&quot;</span>)<span class="op">;</span> <span class="co">// Find the first = sign</span></a>
<a class="sourceLine" id="cb11-725" title="725">    <span class="kw">let</span> name <span class="op">=</span> <span class="va">cookie</span>.<span class="at">substring</span>(<span class="dv">0</span><span class="op">,</span> p)<span class="op">;</span> <span class="co">// Get cookie name</span></a>
<a class="sourceLine" id="cb11-726" title="726">    <span class="kw">let</span> value <span class="op">=</span> <span class="va">cookie</span>.<span class="at">substring</span>(p <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Get cookie value</span></a>
<a class="sourceLine" id="cb11-727" title="727">    value <span class="op">=</span> <span class="at">decodeURIComponent</span>(value)<span class="op">;</span> <span class="co">// Decode the value</span></a>
<a class="sourceLine" id="cb11-728" title="728">    <span class="va">cookies</span>.<span class="at">set</span>(name<span class="op">,</span> value)<span class="op">;</span> <span class="co">// Remember cookie name and value</span></a>
<a class="sourceLine" id="cb11-729" title="729">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-730" title="730">  <span class="cf">return</span> cookies<span class="op">;</span></a>
<a class="sourceLine" id="cb11-731" title="731"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-732" title="732"><span class="kw">const</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;http&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-733" title="733"></a>
<a class="sourceLine" id="cb11-734" title="734"><span class="kw">function</span> <span class="at">getJSON</span>(url) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-735" title="735">  <span class="co">// Create and return a new Promise</span></a>
<a class="sourceLine" id="cb11-736" title="736">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-737" title="737">    <span class="co">// Start an HTTP GET request for the specified URL</span></a>
<a class="sourceLine" id="cb11-738" title="738">    request <span class="op">=</span> <span class="va">http</span>.<span class="at">get</span>(url<span class="op">,</span> (response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-739" title="739">      <span class="co">// called when response starts</span></a>
<a class="sourceLine" id="cb11-740" title="740">      <span class="co">// Reject the Promise if the HTTP status is wrong</span></a>
<a class="sourceLine" id="cb11-741" title="741">      <span class="cf">if</span> (<span class="va">response</span>.<span class="at">statusCode</span> <span class="op">!==</span> <span class="dv">200</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-742" title="742">        <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="vs">`HTTP status </span><span class="sc">${</span><span class="va">response</span>.<span class="at">statusCode</span><span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-743" title="743">        <span class="va">response</span>.<span class="at">resume</span>()<span class="op">;</span> <span class="co">// so we don&#39;t leak memory</span></a>
<a class="sourceLine" id="cb11-744" title="744">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-745" title="745">      <span class="co">// And reject if the response headers are wrong</span></a>
<a class="sourceLine" id="cb11-746" title="746">      <span class="cf">else</span> <span class="cf">if</span> (<span class="va">response</span>.<span class="at">headers</span>[<span class="st">&quot;content-type&quot;</span>] <span class="op">!==</span> <span class="st">&quot;application/json&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-747" title="747">        <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Invalid content-type&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-748" title="748">        <span class="va">response</span>.<span class="at">resume</span>()<span class="op">;</span> <span class="co">// don&#39;t leak memory</span></a>
<a class="sourceLine" id="cb11-749" title="749">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-750" title="750">        <span class="co">// Otherwise, register events to read the body of the response</span></a>
<a class="sourceLine" id="cb11-751" title="751">        <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-752" title="752">        <span class="va">response</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf-8&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-753" title="753">        <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;data&quot;</span><span class="op">,</span> (chunk) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-754" title="754">          body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb11-755" title="755">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-756" title="756">        <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-757" title="757">          <span class="co">// When the response body is complete, try to parse it</span></a>
<a class="sourceLine" id="cb11-758" title="758">          <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-759" title="759">            <span class="kw">let</span> parsed <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(body)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-760" title="760">            <span class="co">// If it parsed successfully, fulfill the Promise</span></a>
<a class="sourceLine" id="cb11-761" title="761">            <span class="at">resolve</span>(parsed)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-762" title="762">          <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-763" title="763">            <span class="co">// If parsing failed, reject the Promise</span></a>
<a class="sourceLine" id="cb11-764" title="764">            <span class="at">reject</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-765" title="765">          <span class="op">}</span></a>
<a class="sourceLine" id="cb11-766" title="766">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-767" title="767">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-768" title="768">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-769" title="769">    <span class="co">// We also reject the Promise if the request fails before we</span></a>
<a class="sourceLine" id="cb11-770" title="770">    <span class="co">// even get a response (such as when the network is down)</span></a>
<a class="sourceLine" id="cb11-771" title="771">    <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (error) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-772" title="772">      <span class="at">reject</span>(error)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-773" title="773">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-774" title="774">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-775" title="775"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-776" title="776"><span class="kw">const</span> https <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;https&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-777" title="777"></a>
<a class="sourceLine" id="cb11-778" title="778"><span class="co">// Read the text content of the URL and asynchronously pass it to the callback.</span></a>
<a class="sourceLine" id="cb11-779" title="779"><span class="kw">function</span> <span class="at">getText</span>(url<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-780" title="780">  <span class="co">// Start an HTTP GET request for the URL</span></a>
<a class="sourceLine" id="cb11-781" title="781">  request <span class="op">=</span> <span class="va">https</span>.<span class="at">get</span>(url)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-782" title="782"></a>
<a class="sourceLine" id="cb11-783" title="783">  <span class="co">// Register a function to handle the &quot;response&quot; event.</span></a>
<a class="sourceLine" id="cb11-784" title="784">  <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;response&quot;</span><span class="op">,</span> (response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-785" title="785">    <span class="co">// The response event means that response headers have been received</span></a>
<a class="sourceLine" id="cb11-786" title="786">    <span class="kw">let</span> httpStatus <span class="op">=</span> <span class="va">response</span>.<span class="at">statusCode</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-787" title="787"></a>
<a class="sourceLine" id="cb11-788" title="788">    <span class="co">// The body of the HTTP response has not been received yet.</span></a>
<a class="sourceLine" id="cb11-789" title="789">    <span class="co">// So we register more event handlers to to be called when it arrives.</span></a>
<a class="sourceLine" id="cb11-790" title="790">    <span class="va">response</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf-8&quot;</span>)<span class="op">;</span> <span class="co">// We&#39;re expecting Unicode text</span></a>
<a class="sourceLine" id="cb11-791" title="791">    <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// which we will accumulate here.</span></a>
<a class="sourceLine" id="cb11-792" title="792"></a>
<a class="sourceLine" id="cb11-793" title="793">    <span class="co">// This event handler is called when a chunk of the body is ready</span></a>
<a class="sourceLine" id="cb11-794" title="794">    <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;data&quot;</span><span class="op">,</span> (chunk) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-795" title="795">      body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb11-796" title="796">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-797" title="797"></a>
<a class="sourceLine" id="cb11-798" title="798">    <span class="co">// This event handler is called when the response is complete</span></a>
<a class="sourceLine" id="cb11-799" title="799">    <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-800" title="800">      <span class="cf">if</span> (httpStatus <span class="op">===</span> <span class="dv">200</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-801" title="801">        <span class="co">// If the HTTP response was good</span></a>
<a class="sourceLine" id="cb11-802" title="802">        <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> body)<span class="op">;</span> <span class="co">// Pass response body to the callback</span></a>
<a class="sourceLine" id="cb11-803" title="803">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-804" title="804">        <span class="co">// Otherwise pass an error</span></a>
<a class="sourceLine" id="cb11-805" title="805">        <span class="at">callback</span>(httpStatus<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-806" title="806">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-807" title="807">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-808" title="808">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-809" title="809"></a>
<a class="sourceLine" id="cb11-810" title="810">  <span class="co">// We also register an event handler for lower-level network errors</span></a>
<a class="sourceLine" id="cb11-811" title="811">  <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-812" title="812">    <span class="at">callback</span>(err<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-813" title="813">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-814" title="814"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-815" title="815"><span class="kw">function</span> <span class="at">glob</span>(strings<span class="op">,</span> ...<span class="at">values</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-816" title="816">  <span class="co">// Assemble the strings and values into a single string</span></a>
<a class="sourceLine" id="cb11-817" title="817">  <span class="kw">let</span> s <span class="op">=</span> strings[<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-818" title="818">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">values</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-819" title="819">    s <span class="op">+=</span> values[i] <span class="op">+</span> strings[i <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-820" title="820">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-821" title="821">  <span class="co">// Return a parsed representation of that string</span></a>
<a class="sourceLine" id="cb11-822" title="822">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Glob</span>(s)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-823" title="823"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-824" title="824"></a>
<a class="sourceLine" id="cb11-825" title="825"><span class="kw">let</span> root <span class="op">=</span> <span class="st">&quot;/tmp&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-826" title="826"><span class="kw">let</span> filePattern <span class="op">=</span> glob<span class="vs">`</span><span class="sc">${</span>root<span class="sc">}</span><span class="vs">/*.html`</span><span class="op">;</span> <span class="co">// A RegExp alternative</span></a>
<a class="sourceLine" id="cb11-827" title="827"><span class="st">&quot;/tmp/test.html&quot;</span>.<span class="at">match</span>(filePattern)[<span class="dv">1</span>]<span class="op">;</span> <span class="co">// =&gt; &quot;test&quot;</span></a>
<a class="sourceLine" id="cb11-828" title="828"><span class="kw">const</span> stream <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;stream&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-829" title="829"></a>
<a class="sourceLine" id="cb11-830" title="830"><span class="kw">class</span> GrepStream <span class="kw">extends</span> <span class="va">stream</span>.<span class="at">Transform</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-831" title="831">  <span class="at">constructor</span>(pattern) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-832" title="832">    <span class="kw">super</span>(<span class="op">{</span> <span class="dt">decodeStrings</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>)<span class="op">;</span> <span class="co">// Don&#39;t convert strings back to buffers</span></a>
<a class="sourceLine" id="cb11-833" title="833">    <span class="kw">this</span>.<span class="at">pattern</span> <span class="op">=</span> pattern<span class="op">;</span> <span class="co">// The regular expression we want to match</span></a>
<a class="sourceLine" id="cb11-834" title="834">    <span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// Any remnant of the last chunk of data</span></a>
<a class="sourceLine" id="cb11-835" title="835">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-836" title="836"></a>
<a class="sourceLine" id="cb11-837" title="837">  <span class="co">// This method is invoked when there is a string ready to be</span></a>
<a class="sourceLine" id="cb11-838" title="838">  <span class="co">// transformed. It should pass transformed data to the specified</span></a>
<a class="sourceLine" id="cb11-839" title="839">  <span class="co">// callback function. We expect string input so this stream should</span></a>
<a class="sourceLine" id="cb11-840" title="840">  <span class="co">// only be connected to readable streams that have had</span></a>
<a class="sourceLine" id="cb11-841" title="841">  <span class="co">// setEncoding() called on them.</span></a>
<a class="sourceLine" id="cb11-842" title="842">  <span class="at">_transform</span>(chunk<span class="op">,</span> encoding<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-843" title="843">    <span class="cf">if</span> (<span class="kw">typeof</span> chunk <span class="op">!==</span> <span class="st">&quot;string&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-844" title="844">      <span class="at">callback</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Expected a string but got a buffer&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-845" title="845">      <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-846" title="846">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-847" title="847">    <span class="co">// Add the chunk to any previously incomplete line and break</span></a>
<a class="sourceLine" id="cb11-848" title="848">    <span class="co">// everything into lines</span></a>
<a class="sourceLine" id="cb11-849" title="849">    <span class="kw">let</span> lines <span class="op">=</span> (<span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">+</span> chunk).<span class="at">split</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-850" title="850"></a>
<a class="sourceLine" id="cb11-851" title="851">    <span class="co">// The last element of the array is the new incomplete line</span></a>
<a class="sourceLine" id="cb11-852" title="852">    <span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">=</span> <span class="va">lines</span>.<span class="at">pop</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-853" title="853"></a>
<a class="sourceLine" id="cb11-854" title="854">    <span class="co">// Find all matching lines</span></a>
<a class="sourceLine" id="cb11-855" title="855">    <span class="kw">let</span> output <span class="op">=</span> lines <span class="co">// Start with all complete lines,</span></a>
<a class="sourceLine" id="cb11-856" title="856">      .<span class="at">filter</span>((l) <span class="kw">=&gt;</span> <span class="kw">this</span>.<span class="va">pattern</span>.<span class="at">test</span>(l)) <span class="co">// filter them for matches,</span></a>
<a class="sourceLine" id="cb11-857" title="857">      .<span class="at">join</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span> <span class="co">// and join them back up.</span></a>
<a class="sourceLine" id="cb11-858" title="858"></a>
<a class="sourceLine" id="cb11-859" title="859">    <span class="co">// If anything matched, add a final newline</span></a>
<a class="sourceLine" id="cb11-860" title="860">    <span class="cf">if</span> (output) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-861" title="861">      output <span class="op">+=</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-862" title="862">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-863" title="863"></a>
<a class="sourceLine" id="cb11-864" title="864">    <span class="co">// Always call the callback even if there is no output</span></a>
<a class="sourceLine" id="cb11-865" title="865">    <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> output)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-866" title="866">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-867" title="867"></a>
<a class="sourceLine" id="cb11-868" title="868">  <span class="co">// This is called right before the stream is closed.</span></a>
<a class="sourceLine" id="cb11-869" title="869">  <span class="co">// It is our chance to write out any last data.</span></a>
<a class="sourceLine" id="cb11-870" title="870">  <span class="at">_flush</span>(callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-871" title="871">    <span class="co">// If we still have an incomplete line, and it matches</span></a>
<a class="sourceLine" id="cb11-872" title="872">    <span class="co">// pass it to the callback</span></a>
<a class="sourceLine" id="cb11-873" title="873">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">pattern</span>.<span class="at">test</span>(<span class="kw">this</span>.<span class="at">incompleteLine</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-874" title="874">      <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">+</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-875" title="875">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-876" title="876">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-877" title="877"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-878" title="878"></a>
<a class="sourceLine" id="cb11-879" title="879"><span class="co">// Now we can write a program like &#39;grep&#39; with this class.</span></a>
<a class="sourceLine" id="cb11-880" title="880"><span class="kw">let</span> pattern <span class="op">=</span> <span class="kw">new</span> <span class="at">RegExp</span>(<span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>])<span class="op">;</span> <span class="co">// Get a RegExp from command line.</span></a>
<a class="sourceLine" id="cb11-881" title="881"><span class="va">process</span>.<span class="at">stdin</span> <span class="co">// Start with standard input,</span></a>
<a class="sourceLine" id="cb11-882" title="882">  .<span class="at">setEncoding</span>(<span class="st">&quot;utf8&quot;</span>) <span class="co">// read it as Unicode strings,</span></a>
<a class="sourceLine" id="cb11-883" title="883">  .<span class="at">pipe</span>(<span class="kw">new</span> <span class="at">GrepStream</span>(pattern)) <span class="co">// pipe it to our GrepStream,</span></a>
<a class="sourceLine" id="cb11-884" title="884">  .<span class="at">pipe</span>(<span class="va">process</span>.<span class="at">stdout</span>) <span class="co">// and pipe that to standard out.</span></a>
<a class="sourceLine" id="cb11-885" title="885">  .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">process</span>.<span class="at">exit</span>())<span class="op">;</span> <span class="co">// Exit gracefully if stdout closes.</span></a>
<a class="sourceLine" id="cb11-886" title="886"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-887" title="887"><span class="kw">const</span> zlib <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;zlib&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-888" title="888"></a>
<a class="sourceLine" id="cb11-889" title="889"><span class="kw">function</span> <span class="at">gzip</span>(filename<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-890" title="890">  <span class="co">// Create the streams</span></a>
<a class="sourceLine" id="cb11-891" title="891">  <span class="kw">let</span> source <span class="op">=</span> <span class="va">fs</span>.<span class="at">createReadStream</span>(filename)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-892" title="892">  <span class="kw">let</span> destination <span class="op">=</span> <span class="va">fs</span>.<span class="at">createWriteStream</span>(filename <span class="op">+</span> <span class="st">&quot;.gz&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-893" title="893">  <span class="kw">let</span> gzipper <span class="op">=</span> <span class="va">zlib</span>.<span class="at">createGzip</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-894" title="894"></a>
<a class="sourceLine" id="cb11-895" title="895">  <span class="co">// Set up the pipeline</span></a>
<a class="sourceLine" id="cb11-896" title="896">  source</a>
<a class="sourceLine" id="cb11-897" title="897">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> callback) <span class="co">// call callback on read error</span></a>
<a class="sourceLine" id="cb11-898" title="898">    .<span class="at">pipe</span>(gzipper)</a>
<a class="sourceLine" id="cb11-899" title="899">    .<span class="at">pipe</span>(destination)</a>
<a class="sourceLine" id="cb11-900" title="900">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> callback) <span class="co">// call callback on write error</span></a>
<a class="sourceLine" id="cb11-901" title="901">    .<span class="at">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> callback)<span class="op">;</span> <span class="co">// call callback when writing is complete</span></a>
<a class="sourceLine" id="cb11-902" title="902"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-903" title="903"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-904" title="904"><span class="kw">const</span> crypto <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;crypto&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-905" title="905"></a>
<a class="sourceLine" id="cb11-906" title="906"><span class="co">// Compute a sha256 hash of the contents of the named file and pass the</span></a>
<a class="sourceLine" id="cb11-907" title="907"><span class="co">// hash (as a string) to the specified error-first callback function.</span></a>
<a class="sourceLine" id="cb11-908" title="908"><span class="kw">function</span> <span class="at">sha256</span>(filename<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-909" title="909">  <span class="kw">let</span> input <span class="op">=</span> <span class="va">fs</span>.<span class="at">createReadStream</span>(filename)<span class="op">;</span> <span class="co">// The data stream.</span></a>
<a class="sourceLine" id="cb11-910" title="910">  <span class="kw">let</span> hasher <span class="op">=</span> <span class="va">crypto</span>.<span class="at">createHash</span>(<span class="st">&quot;sha256&quot;</span>)<span class="op">;</span> <span class="co">// For computing the hash.</span></a>
<a class="sourceLine" id="cb11-911" title="911"></a>
<a class="sourceLine" id="cb11-912" title="912">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;readable&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-913" title="913">    <span class="co">// When there is data ready to read</span></a>
<a class="sourceLine" id="cb11-914" title="914">    <span class="kw">let</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb11-915" title="915">    <span class="cf">while</span> ((chunk <span class="op">=</span> <span class="va">input</span>.<span class="at">read</span>())) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-916" title="916">      <span class="co">// Read a chunk, and if non-null,</span></a>
<a class="sourceLine" id="cb11-917" title="917">      <span class="va">hasher</span>.<span class="at">update</span>(chunk)<span class="op">;</span> <span class="co">// pass it to the hasher,</span></a>
<a class="sourceLine" id="cb11-918" title="918">    <span class="op">}</span> <span class="co">// and keep looping until not readable</span></a>
<a class="sourceLine" id="cb11-919" title="919">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-920" title="920">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-921" title="921">    <span class="co">// At the end of the stream,</span></a>
<a class="sourceLine" id="cb11-922" title="922">    <span class="kw">let</span> hash <span class="op">=</span> <span class="va">hasher</span>.<span class="at">digest</span>(<span class="st">&quot;hex&quot;</span>)<span class="op">;</span> <span class="co">// compute the hash,</span></a>
<a class="sourceLine" id="cb11-923" title="923">    <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> hash)<span class="op">;</span> <span class="co">// and pass it to the callback.</span></a>
<a class="sourceLine" id="cb11-924" title="924">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-925" title="925">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> callback)<span class="op">;</span> <span class="co">// On error, call callback</span></a>
<a class="sourceLine" id="cb11-926" title="926"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-927" title="927"></a>
<a class="sourceLine" id="cb11-928" title="928"><span class="co">// Here&#39;s a simple command-line utility to compute the hash of a file</span></a>
<a class="sourceLine" id="cb11-929" title="929"><span class="at">sha256</span>(<span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>]<span class="op">,</span> (err<span class="op">,</span> hash) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-930" title="930">  <span class="co">// Pass filename from command line.</span></a>
<a class="sourceLine" id="cb11-931" title="931">  <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-932" title="932">    <span class="co">// If we get an error</span></a>
<a class="sourceLine" id="cb11-933" title="933">    <span class="va">console</span>.<span class="at">error</span>(<span class="va">err</span>.<span class="at">toString</span>())<span class="op">;</span> <span class="co">// print it as an error.</span></a>
<a class="sourceLine" id="cb11-934" title="934">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-935" title="935">    <span class="co">// Otherwise,</span></a>
<a class="sourceLine" id="cb11-936" title="936">    <span class="va">console</span>.<span class="at">log</span>(hash)<span class="op">;</span> <span class="co">// print the hash string.</span></a>
<a class="sourceLine" id="cb11-937" title="937">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-938" title="938"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-939" title="939"><span class="kw">function</span> <span class="at">html</span>(strings<span class="op">,</span> ...<span class="at">values</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-940" title="940">  <span class="co">// Convert each value to a string and escape special HTML characters</span></a>
<a class="sourceLine" id="cb11-941" title="941">  <span class="kw">let</span> escaped <span class="op">=</span> <span class="va">values</span>.<span class="at">map</span>((v) <span class="kw">=&gt;</span></a>
<a class="sourceLine" id="cb11-942" title="942">    <span class="at">String</span>(v)</a>
<a class="sourceLine" id="cb11-943" title="943">      .<span class="at">replace</span>(<span class="st">&quot;&amp;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;amp;&quot;</span>)</a>
<a class="sourceLine" id="cb11-944" title="944">      .<span class="at">replace</span>(<span class="st">&quot;&lt;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;lt;&quot;</span>)</a>
<a class="sourceLine" id="cb11-945" title="945">      .<span class="at">replace</span>(<span class="st">&quot;&gt;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;gt;&quot;</span>)</a>
<a class="sourceLine" id="cb11-946" title="946">      .<span class="at">replace</span>(<span class="st">&#39;&quot;&#39;</span><span class="op">,</span> <span class="st">&quot;&amp;quot;&quot;</span>)</a>
<a class="sourceLine" id="cb11-947" title="947">      .<span class="at">replace</span>(<span class="st">&quot;&#39;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;#39;&quot;</span>)</a>
<a class="sourceLine" id="cb11-948" title="948">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb11-949" title="949"></a>
<a class="sourceLine" id="cb11-950" title="950">  <span class="co">// Return the concatenated strings and escaped values</span></a>
<a class="sourceLine" id="cb11-951" title="951">  <span class="kw">let</span> result <span class="op">=</span> strings[<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-952" title="952">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">escaped</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-953" title="953">    result <span class="op">+=</span> escaped[i] <span class="op">+</span> strings[i <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-954" title="954">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-955" title="955">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb11-956" title="956"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-957" title="957"></a>
<a class="sourceLine" id="cb11-958" title="958"><span class="kw">let</span> operator <span class="op">=</span> <span class="st">&quot;&lt;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-959" title="959">html<span class="vs">`&lt;b&gt;x </span><span class="sc">${</span>operator<span class="sc">}</span><span class="vs"> y&lt;/b&gt;`</span><span class="op">;</span> <span class="co">// =&gt; &quot;&lt;b&gt;x &amp;lt; y&lt;/b&gt;&quot;</span></a>
<a class="sourceLine" id="cb11-960" title="960"></a>
<a class="sourceLine" id="cb11-961" title="961"><span class="kw">let</span> kind <span class="op">=</span> <span class="st">&quot;game&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-962" title="962">  name <span class="op">=</span> <span class="st">&quot;D&amp;D&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-963" title="963">html<span class="vs">`&lt;div class=&quot;</span><span class="sc">${</span>kind<span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span> <span class="co">// =&gt;&#39;&lt;div class=&quot;game&quot;&gt;D&amp;amp;D&lt;/div&gt;&#39;</span></a>
<a class="sourceLine" id="cb11-964" title="964"><span class="co">// We use a Proxy to create an object that appears to have every</span></a>
<a class="sourceLine" id="cb11-965" title="965"><span class="co">// possible property, with the value of each property equal to its name</span></a>
<a class="sourceLine" id="cb11-966" title="966"><span class="kw">let</span> identity <span class="op">=</span> <span class="kw">new</span> <span class="at">Proxy</span>(</a>
<a class="sourceLine" id="cb11-967" title="967">  <span class="op">{},</span></a>
<a class="sourceLine" id="cb11-968" title="968">  <span class="op">{</span></a>
<a class="sourceLine" id="cb11-969" title="969">    <span class="co">// Every property has its own name as its value</span></a>
<a class="sourceLine" id="cb11-970" title="970">    <span class="at">get</span>(o<span class="op">,</span> name<span class="op">,</span> target) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-971" title="971">      <span class="cf">return</span> name<span class="op">;</span></a>
<a class="sourceLine" id="cb11-972" title="972">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-973" title="973">    <span class="co">// Every property name is defined</span></a>
<a class="sourceLine" id="cb11-974" title="974">    <span class="at">has</span>(o<span class="op">,</span> name) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-975" title="975">      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-976" title="976">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-977" title="977">    <span class="co">// There are too many properties to enumerate, so we just throw</span></a>
<a class="sourceLine" id="cb11-978" title="978">    <span class="at">ownKeys</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-979" title="979">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">RangeError</span>(<span class="st">&quot;Infinite number of properties&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-980" title="980">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-981" title="981">    <span class="co">// All properties exist and are not writable, configurable or enumerable.</span></a>
<a class="sourceLine" id="cb11-982" title="982">    <span class="at">getOwnPropertyDescriptor</span>(o<span class="op">,</span> name) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-983" title="983">      <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-984" title="984">        <span class="dt">value</span><span class="op">:</span> name<span class="op">,</span></a>
<a class="sourceLine" id="cb11-985" title="985">        <span class="dt">enumerable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-986" title="986">        <span class="dt">writable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-987" title="987">        <span class="dt">configurable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-988" title="988">      <span class="op">};</span></a>
<a class="sourceLine" id="cb11-989" title="989">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-990" title="990">    <span class="co">// All properties are read-only so they can&#39;t be set</span></a>
<a class="sourceLine" id="cb11-991" title="991">    <span class="at">set</span>(o<span class="op">,</span> name<span class="op">,</span> value<span class="op">,</span> target) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-992" title="992">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-993" title="993">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-994" title="994">    <span class="co">// All properties are non-configurable, so they can&#39;t be deleted</span></a>
<a class="sourceLine" id="cb11-995" title="995">    <span class="at">deleteProperty</span>(o<span class="op">,</span> name) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-996" title="996">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-997" title="997">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-998" title="998">    <span class="co">// All properties exist and are non-configurable so we can&#39;t define more</span></a>
<a class="sourceLine" id="cb11-999" title="999">    <span class="at">defineProperty</span>(o<span class="op">,</span> name<span class="op">,</span> desc) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1000" title="1000">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1001" title="1001">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-1002" title="1002">    <span class="co">// In effect, this means that the object is not extensible</span></a>
<a class="sourceLine" id="cb11-1003" title="1003">    <span class="at">isExtensible</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1004" title="1004">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1005" title="1005">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-1006" title="1006">    <span class="co">// All properties are already defined on this object, so it couldn&#39;t</span></a>
<a class="sourceLine" id="cb11-1007" title="1007">    <span class="co">// inherit anything even if it did have a prototype object.</span></a>
<a class="sourceLine" id="cb11-1008" title="1008">    <span class="at">getPrototypeOf</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1009" title="1009">      <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1010" title="1010">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-1011" title="1011">    <span class="co">// The object is not extensible, so we can&#39;t change the prototype</span></a>
<a class="sourceLine" id="cb11-1012" title="1012">    <span class="at">setPrototypeOf</span>(o<span class="op">,</span> proto) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1013" title="1013">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1014" title="1014">    <span class="op">},</span></a>
<a class="sourceLine" id="cb11-1015" title="1015">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1016" title="1016">)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1017" title="1017"></a>
<a class="sourceLine" id="cb11-1018" title="1018"><span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; &quot;x&quot;</span></a>
<a class="sourceLine" id="cb11-1019" title="1019"><span class="va">identity</span>.<span class="at">toString</span><span class="op">;</span> <span class="co">// =&gt; &quot;toString&quot;</span></a>
<a class="sourceLine" id="cb11-1020" title="1020">identity[<span class="dv">0</span>]<span class="op">;</span> <span class="co">// =&gt; &quot;0&quot;</span></a>
<a class="sourceLine" id="cb11-1021" title="1021"><span class="va">identity</span>.<span class="at">x</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Setting properties has no effect</span></a>
<a class="sourceLine" id="cb11-1022" title="1022"><span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; &quot;x&quot;</span></a>
<a class="sourceLine" id="cb11-1023" title="1023"><span class="kw">delete</span> <span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; false: can&#39;t delete properties either</span></a>
<a class="sourceLine" id="cb11-1024" title="1024"><span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; &quot;x&quot;</span></a>
<a class="sourceLine" id="cb11-1025" title="1025"><span class="va">Object</span>.<span class="at">keys</span>(identity)<span class="op">;</span> <span class="co">// !RangeError: can&#39;t list all the keys</span></a>
<a class="sourceLine" id="cb11-1026" title="1026"><span class="cf">for</span> (<span class="kw">let</span> p <span class="kw">of</span> identity)<span class="op">;</span> <span class="co">// !RangeError</span></a>
<a class="sourceLine" id="cb11-1027" title="1027"><span class="co">// Asynchronously load and execute a script from a specified URL</span></a>
<a class="sourceLine" id="cb11-1028" title="1028"><span class="co">// Returns a Promise that resolves when the script has loaded.</span></a>
<a class="sourceLine" id="cb11-1029" title="1029"><span class="kw">function</span> <span class="at">importScript</span>(url) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1030" title="1030">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1031" title="1031">    <span class="kw">let</span> s <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;script&quot;</span>)<span class="op">;</span> <span class="co">// Create a &lt;script&gt; element</span></a>
<a class="sourceLine" id="cb11-1032" title="1032">    <span class="va">s</span>.<span class="at">onload</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1033" title="1033">      <span class="at">resolve</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1034" title="1034">    <span class="op">};</span> <span class="co">// Resolve promise when loaded</span></a>
<a class="sourceLine" id="cb11-1035" title="1035">    <span class="va">s</span>.<span class="at">onerror</span> <span class="op">=</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1036" title="1036">      <span class="at">reject</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1037" title="1037">    <span class="op">};</span> <span class="co">// Reject on failure</span></a>
<a class="sourceLine" id="cb11-1038" title="1038">    <span class="va">s</span>.<span class="at">src</span> <span class="op">=</span> url<span class="op">;</span> <span class="co">// Set the script URL</span></a>
<a class="sourceLine" id="cb11-1039" title="1039">    <span class="va">document</span>.<span class="va">head</span>.<span class="at">append</span>(s)<span class="op">;</span> <span class="co">// Add &lt;script&gt; to document</span></a>
<a class="sourceLine" id="cb11-1040" title="1040">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1041" title="1041"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-1042" title="1042"><span class="va">customElements</span>.<span class="at">define</span>(</a>
<a class="sourceLine" id="cb11-1043" title="1043">  <span class="st">&quot;inline-circle&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-1044" title="1044">  <span class="kw">class</span> InlineCircle <span class="kw">extends</span> HTMLElement <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1045" title="1045">    <span class="co">// The browser calls this method when an &lt;inline-circle&gt; element</span></a>
<a class="sourceLine" id="cb11-1046" title="1046">    <span class="co">// is inserted into the document. There is also a disconnectedCallback()</span></a>
<a class="sourceLine" id="cb11-1047" title="1047">    <span class="co">// that we don&#39;t need in this example.</span></a>
<a class="sourceLine" id="cb11-1048" title="1048">    <span class="at">connectedCallback</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1049" title="1049">      <span class="co">// Set the styles needed to create circles</span></a>
<a class="sourceLine" id="cb11-1050" title="1050">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">display</span> <span class="op">=</span> <span class="st">&quot;inline-block&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1051" title="1051">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">borderRadius</span> <span class="op">=</span> <span class="st">&quot;50%&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1052" title="1052">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">border</span> <span class="op">=</span> <span class="st">&quot;solid black 1px&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1053" title="1053">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">transform</span> <span class="op">=</span> <span class="st">&quot;translateY(10%)&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1054" title="1054"></a>
<a class="sourceLine" id="cb11-1055" title="1055">      <span class="co">// If there is not already a size defined, set a default size</span></a>
<a class="sourceLine" id="cb11-1056" title="1056">      <span class="co">// that is based on the current font size.</span></a>
<a class="sourceLine" id="cb11-1057" title="1057">      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="va">style</span>.<span class="at">width</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1058" title="1058">        <span class="kw">this</span>.<span class="va">style</span>.<span class="at">width</span> <span class="op">=</span> <span class="st">&quot;0.8em&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1059" title="1059">        <span class="kw">this</span>.<span class="va">style</span>.<span class="at">height</span> <span class="op">=</span> <span class="st">&quot;0.8em&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1060" title="1060">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1061" title="1061">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1062" title="1062"></a>
<a class="sourceLine" id="cb11-1063" title="1063">    <span class="co">// The static observedAttributes property specifies which attributes</span></a>
<a class="sourceLine" id="cb11-1064" title="1064">    <span class="co">// we want to be notified about changes to. (We use a getter here since</span></a>
<a class="sourceLine" id="cb11-1065" title="1065">    <span class="co">// we can only use &quot;static&quot; with methods.)</span></a>
<a class="sourceLine" id="cb11-1066" title="1066">    <span class="kw">static</span> get <span class="at">observedAttributes</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1067" title="1067">      <span class="cf">return</span> [<span class="st">&quot;diameter&quot;</span><span class="op">,</span> <span class="st">&quot;color&quot;</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1068" title="1068">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1069" title="1069"></a>
<a class="sourceLine" id="cb11-1070" title="1070">    <span class="co">// This callback is invoked when one of the attributes listed above</span></a>
<a class="sourceLine" id="cb11-1071" title="1071">    <span class="co">// changes, either when the custom element is first parsed, or later.</span></a>
<a class="sourceLine" id="cb11-1072" title="1072">    <span class="at">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1073" title="1073">      <span class="cf">switch</span> (name) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1074" title="1074">        <span class="cf">case</span> <span class="st">&quot;diameter&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb11-1075" title="1075">          <span class="co">// If the diameter attribute changes, update the size styles</span></a>
<a class="sourceLine" id="cb11-1076" title="1076">          <span class="kw">this</span>.<span class="va">style</span>.<span class="at">width</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1077" title="1077">          <span class="kw">this</span>.<span class="va">style</span>.<span class="at">height</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1078" title="1078">          <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1079" title="1079">        <span class="cf">case</span> <span class="st">&quot;color&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb11-1080" title="1080">          <span class="co">// If the color attribute changes, update the color styles</span></a>
<a class="sourceLine" id="cb11-1081" title="1081">          <span class="kw">this</span>.<span class="va">style</span>.<span class="at">backgroundColor</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1082" title="1082">          <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1083" title="1083">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1084" title="1084">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1085" title="1085"></a>
<a class="sourceLine" id="cb11-1086" title="1086">    <span class="co">// Define JavaScript properties that correspond to the element&#39;s</span></a>
<a class="sourceLine" id="cb11-1087" title="1087">    <span class="co">// attributes. These getters and setters just get and set the underlying</span></a>
<a class="sourceLine" id="cb11-1088" title="1088">    <span class="co">// attributes. If a JavaScript property is set, that sets the attribute</span></a>
<a class="sourceLine" id="cb11-1089" title="1089">    <span class="co">// which triggers a call to attributeChangedCallback() which updates</span></a>
<a class="sourceLine" id="cb11-1090" title="1090">    <span class="co">// the element styles.</span></a>
<a class="sourceLine" id="cb11-1091" title="1091">    get <span class="at">diameter</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1092" title="1092">      <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;diameter&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1093" title="1093">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1094" title="1094">    set <span class="at">diameter</span>(diameter) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1095" title="1095">      <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;diameter&quot;</span><span class="op">,</span> diameter)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1096" title="1096">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1097" title="1097">    get <span class="at">color</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1098" title="1098">      <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;color&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1099" title="1099">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1100" title="1100">    set <span class="at">color</span>(color) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1101" title="1101">      <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;color&quot;</span><span class="op">,</span> color)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1102" title="1102">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1103" title="1103">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1104" title="1104">)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1105" title="1105"><span class="co">// Determine if o is an array-like object.</span></a>
<a class="sourceLine" id="cb11-1106" title="1106"><span class="co">// Strings and functions have numeric length properties, but are</span></a>
<a class="sourceLine" id="cb11-1107" title="1107"><span class="co">// excluded by the typeof test. In client-side JavaScript, DOM text</span></a>
<a class="sourceLine" id="cb11-1108" title="1108"><span class="co">// nodes have a numeric length property, and may need to be excluded</span></a>
<a class="sourceLine" id="cb11-1109" title="1109"><span class="co">// with an additional o.nodeType !== 3 test.</span></a>
<a class="sourceLine" id="cb11-1110" title="1110"><span class="kw">function</span> <span class="at">isArrayLike</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1111" title="1111">  <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb11-1112" title="1112">    o <span class="op">&amp;&amp;</span> <span class="co">// o is not null, undefined, etc.</span></a>
<a class="sourceLine" id="cb11-1113" title="1113">    <span class="kw">typeof</span> o <span class="op">===</span> <span class="st">&quot;object&quot;</span> <span class="op">&amp;&amp;</span> <span class="co">// o is an object</span></a>
<a class="sourceLine" id="cb11-1114" title="1114">    <span class="va">Number</span>.<span class="at">isFinite</span>(<span class="va">o</span>.<span class="at">length</span>) <span class="op">&amp;&amp;</span> <span class="co">// o.length is a finite number</span></a>
<a class="sourceLine" id="cb11-1115" title="1115">    <span class="va">o</span>.<span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> <span class="co">// o.length is non-negative</span></a>
<a class="sourceLine" id="cb11-1116" title="1116">    <span class="va">Number</span>.<span class="at">isInteger</span>(<span class="va">o</span>.<span class="at">length</span>) <span class="op">&amp;&amp;</span> <span class="co">// o.length is an integer</span></a>
<a class="sourceLine" id="cb11-1117" title="1117">    <span class="va">o</span>.<span class="at">length</span> <span class="op">&lt;</span> <span class="dv">4294967295</span></a>
<a class="sourceLine" id="cb11-1118" title="1118">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1119" title="1119">    <span class="co">// o.length &lt; 2^32 - 1</span></a>
<a class="sourceLine" id="cb11-1120" title="1120">    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// Then o is array-like.</span></a>
<a class="sourceLine" id="cb11-1121" title="1121">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1122" title="1122">    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> <span class="co">// Otherwise it is not.</span></a>
<a class="sourceLine" id="cb11-1123" title="1123">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1124" title="1124"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-1125" title="1125"><span class="co">// Connect to the joke port (6789) on the server named on the command line</span></a>
<a class="sourceLine" id="cb11-1126" title="1126"><span class="kw">let</span> socket <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;net&quot;</span>).<span class="at">createConnection</span>(<span class="dv">6789</span><span class="op">,</span> <span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1127" title="1127"><span class="va">socket</span>.<span class="at">pipe</span>(<span class="va">process</span>.<span class="at">stdout</span>)<span class="op">;</span> <span class="co">// Pipe data from the socket to stdout</span></a>
<a class="sourceLine" id="cb11-1128" title="1128"><span class="va">process</span>.<span class="va">stdin</span>.<span class="at">pipe</span>(socket)<span class="op">;</span> <span class="co">// Pipe data from stdin to the socket</span></a>
<a class="sourceLine" id="cb11-1129" title="1129"><span class="va">socket</span>.<span class="at">on</span>(<span class="st">&quot;close&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">process</span>.<span class="at">exit</span>())<span class="op">;</span> <span class="co">// Quit when the socket closes.</span></a>
<a class="sourceLine" id="cb11-1130" title="1130"><span class="co">// A TCP server that delivers interactive knock-knock jokes on port 6789.</span></a>
<a class="sourceLine" id="cb11-1131" title="1131"><span class="co">// (Why is six afraid of seven? Because seven ate nine!)</span></a>
<a class="sourceLine" id="cb11-1132" title="1132"><span class="kw">const</span> net <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;net&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1133" title="1133"><span class="kw">const</span> readline <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;readline&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1134" title="1134"></a>
<a class="sourceLine" id="cb11-1135" title="1135"><span class="co">// Create a Server object and start listening for connections</span></a>
<a class="sourceLine" id="cb11-1136" title="1136"><span class="kw">let</span> server <span class="op">=</span> <span class="va">net</span>.<span class="at">createServer</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1137" title="1137"><span class="va">server</span>.<span class="at">listen</span>(<span class="dv">6789</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Delivering laughs on port 6789&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1138" title="1138"></a>
<a class="sourceLine" id="cb11-1139" title="1139"><span class="co">// When a client connects, tell them a knock-knock joke.</span></a>
<a class="sourceLine" id="cb11-1140" title="1140"><span class="va">server</span>.<span class="at">on</span>(<span class="st">&quot;connection&quot;</span><span class="op">,</span> (socket) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1141" title="1141">  <span class="at">tellJoke</span>(socket)</a>
<a class="sourceLine" id="cb11-1142" title="1142">    .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="va">socket</span>.<span class="at">end</span>()) <span class="co">// When the joke is done, close the socket.</span></a>
<a class="sourceLine" id="cb11-1143" title="1143">    .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1144" title="1144">      <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span> <span class="co">// Log any errors that occur,</span></a>
<a class="sourceLine" id="cb11-1145" title="1145">      <span class="va">socket</span>.<span class="at">end</span>()<span class="op">;</span> <span class="co">// but still close the socket!</span></a>
<a class="sourceLine" id="cb11-1146" title="1146">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1147" title="1147"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1148" title="1148"></a>
<a class="sourceLine" id="cb11-1149" title="1149"><span class="co">// These are all the jokes we know.</span></a>
<a class="sourceLine" id="cb11-1150" title="1150"><span class="kw">const</span> jokes <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1151" title="1151">  <span class="dt">Boo</span><span class="op">:</span> <span class="st">&quot;Don&#39;t cry...it&#39;s only a joke!&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-1152" title="1152">  <span class="dt">Lettuce</span><span class="op">:</span> <span class="st">&quot;Let us in! It&#39;s freezing out here!&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-1153" title="1153">  <span class="st">&quot;A little old lady&quot;</span><span class="op">:</span> <span class="st">&quot;Wow, I didn&#39;t know you could yodel!&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-1154" title="1154"><span class="op">};</span></a>
<a class="sourceLine" id="cb11-1155" title="1155"></a>
<a class="sourceLine" id="cb11-1156" title="1156"><span class="co">// Interactively perform a knock-knock joke over this socket, without blocking.</span></a>
<a class="sourceLine" id="cb11-1157" title="1157"><span class="kw">async</span> <span class="kw">function</span> <span class="at">tellJoke</span>(socket) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1158" title="1158">  <span class="co">// Pick one of the jokes at random</span></a>
<a class="sourceLine" id="cb11-1159" title="1159">  <span class="kw">let</span> randomElement <span class="op">=</span> (a) <span class="kw">=&gt;</span> a[<span class="va">Math</span>.<span class="at">floor</span>(<span class="va">Math</span>.<span class="at">random</span>() <span class="op">*</span> <span class="va">a</span>.<span class="at">length</span>)]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1160" title="1160">  <span class="kw">let</span> who <span class="op">=</span> <span class="at">randomElement</span>(<span class="va">Object</span>.<span class="at">keys</span>(jokes))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1161" title="1161">  <span class="kw">let</span> punchline <span class="op">=</span> jokes[who]<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1162" title="1162"></a>
<a class="sourceLine" id="cb11-1163" title="1163">  <span class="co">// Use the readline module to read the user&#39;s input one line at a time.</span></a>
<a class="sourceLine" id="cb11-1164" title="1164">  <span class="kw">let</span> lineReader <span class="op">=</span> <span class="va">readline</span>.<span class="at">createInterface</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb11-1165" title="1165">    <span class="dt">input</span><span class="op">:</span> socket<span class="op">,</span></a>
<a class="sourceLine" id="cb11-1166" title="1166">    <span class="dt">output</span><span class="op">:</span> socket<span class="op">,</span></a>
<a class="sourceLine" id="cb11-1167" title="1167">    <span class="dt">prompt</span><span class="op">:</span> <span class="st">&quot;&gt;&gt; &quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb11-1168" title="1168">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1169" title="1169"></a>
<a class="sourceLine" id="cb11-1170" title="1170">  <span class="co">// A utility function to output a line of text to the client</span></a>
<a class="sourceLine" id="cb11-1171" title="1171">  <span class="co">// and then (by default) display a prompt.</span></a>
<a class="sourceLine" id="cb11-1172" title="1172">  <span class="kw">function</span> <span class="at">output</span>(text<span class="op">,</span> prompt <span class="op">=</span> <span class="kw">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1173" title="1173">    <span class="va">socket</span>.<span class="at">write</span>(<span class="vs">`</span><span class="sc">${</span>text<span class="sc">}\r\n</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1174" title="1174">    <span class="cf">if</span> (prompt) <span class="va">lineReader</span>.<span class="at">prompt</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1175" title="1175">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1176" title="1176"></a>
<a class="sourceLine" id="cb11-1177" title="1177">  <span class="co">// Knock-knock jokes have a call-and-response structure.</span></a>
<a class="sourceLine" id="cb11-1178" title="1178">  <span class="co">// We expect different input from the user at different stages and</span></a>
<a class="sourceLine" id="cb11-1179" title="1179">  <span class="co">// take different action when we get that input at different stages.</span></a>
<a class="sourceLine" id="cb11-1180" title="1180">  <span class="kw">let</span> stage <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1181" title="1181"></a>
<a class="sourceLine" id="cb11-1182" title="1182">  <span class="co">// Start the knock-knock joke off in the traditional way.</span></a>
<a class="sourceLine" id="cb11-1183" title="1183">  <span class="at">output</span>(<span class="st">&quot;Knock knock!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1184" title="1184"></a>
<a class="sourceLine" id="cb11-1185" title="1185">  <span class="co">// Now read lines asynchronously from the client until the joke is done.</span></a>
<a class="sourceLine" id="cb11-1186" title="1186">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> inputLine <span class="kw">of</span> lineReader) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1187" title="1187">    <span class="cf">if</span> (stage <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1188" title="1188">      <span class="cf">if</span> (<span class="va">inputLine</span>.<span class="at">toLowerCase</span>() <span class="op">===</span> <span class="st">&quot;who&#39;s there?&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1189" title="1189">        <span class="co">// If the user gives the right response at stage 0</span></a>
<a class="sourceLine" id="cb11-1190" title="1190">        <span class="co">// then tell the first part of the joke and go to stage 1.</span></a>
<a class="sourceLine" id="cb11-1191" title="1191">        <span class="at">output</span>(who)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1192" title="1192">        stage <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1193" title="1193">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1194" title="1194">        <span class="co">// Otherwise teach the user how to do knock-knock jokes.</span></a>
<a class="sourceLine" id="cb11-1195" title="1195">        <span class="at">output</span>(<span class="st">&#39;Please type &quot;Who</span><span class="sc">\&#39;</span><span class="st">s there?&quot;.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1196" title="1196">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1197" title="1197">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (stage <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1198" title="1198">      <span class="cf">if</span> (<span class="va">inputLine</span>.<span class="at">toLowerCase</span>() <span class="op">===</span> <span class="vs">`</span><span class="sc">${</span><span class="va">who</span>.<span class="at">toLowerCase</span>()<span class="sc">}</span><span class="vs"> who?`</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1199" title="1199">        <span class="co">// If the user&#39;s response is correct at stage 1, then</span></a>
<a class="sourceLine" id="cb11-1200" title="1200">        <span class="co">// deliver the punchline and return since the joke is done.</span></a>
<a class="sourceLine" id="cb11-1201" title="1201">        <span class="at">output</span>(<span class="vs">`</span><span class="sc">${</span>punchline<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1202" title="1202">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1203" title="1203">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1204" title="1204">        <span class="co">// Make the user play along.</span></a>
<a class="sourceLine" id="cb11-1205" title="1205">        <span class="at">output</span>(<span class="vs">`Please type &quot;</span><span class="sc">${</span>who<span class="sc">}</span><span class="vs"> who?&quot;.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1206" title="1206">      <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1207" title="1207">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1208" title="1208">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1209" title="1209"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-1210" title="1210"><span class="kw">let</span> deg <span class="op">=</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">180</span><span class="op">;</span> <span class="co">// For converting degrees to radians</span></a>
<a class="sourceLine" id="cb11-1211" title="1211"></a>
<a class="sourceLine" id="cb11-1212" title="1212"><span class="co">// Draw a level-n Koch snowflake fractal on the canvas context c,</span></a>
<a class="sourceLine" id="cb11-1213" title="1213"><span class="co">// with lower-left corner at (x,y) and side length len.</span></a>
<a class="sourceLine" id="cb11-1214" title="1214"><span class="kw">function</span> <span class="at">snowflake</span>(c<span class="op">,</span> n<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> len) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1215" title="1215">  <span class="va">c</span>.<span class="at">save</span>()<span class="op">;</span> <span class="co">// Save current transformation</span></a>
<a class="sourceLine" id="cb11-1216" title="1216">  <span class="va">c</span>.<span class="at">translate</span>(x<span class="op">,</span> y)<span class="op">;</span> <span class="co">// Translate origin to starting point</span></a>
<a class="sourceLine" id="cb11-1217" title="1217">  <span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Begin a new subpath at the new origin</span></a>
<a class="sourceLine" id="cb11-1218" title="1218">  <span class="at">leg</span>(n)<span class="op">;</span> <span class="co">// Draw the first leg of the snowflake</span></a>
<a class="sourceLine" id="cb11-1219" title="1219">  <span class="va">c</span>.<span class="at">rotate</span>(<span class="op">-</span><span class="dv">120</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Now rotate 120 degrees counterclockwise</span></a>
<a class="sourceLine" id="cb11-1220" title="1220">  <span class="at">leg</span>(n)<span class="op">;</span> <span class="co">// Draw the second leg</span></a>
<a class="sourceLine" id="cb11-1221" title="1221">  <span class="va">c</span>.<span class="at">rotate</span>(<span class="op">-</span><span class="dv">120</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Rotate again</span></a>
<a class="sourceLine" id="cb11-1222" title="1222">  <span class="at">leg</span>(n)<span class="op">;</span> <span class="co">// Draw the final leg</span></a>
<a class="sourceLine" id="cb11-1223" title="1223">  <span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Close the subpath</span></a>
<a class="sourceLine" id="cb11-1224" title="1224">  <span class="va">c</span>.<span class="at">restore</span>()<span class="op">;</span> <span class="co">// And restore original transformation</span></a>
<a class="sourceLine" id="cb11-1225" title="1225"></a>
<a class="sourceLine" id="cb11-1226" title="1226">  <span class="co">// Draw a single leg of a level-n Koch snowflake.</span></a>
<a class="sourceLine" id="cb11-1227" title="1227">  <span class="co">// This function leaves the current point at the end of the leg it has</span></a>
<a class="sourceLine" id="cb11-1228" title="1228">  <span class="co">// drawn and translates the coordinate system so the current point is (0,0).</span></a>
<a class="sourceLine" id="cb11-1229" title="1229">  <span class="co">// This means you can easily call rotate() after drawing a leg.</span></a>
<a class="sourceLine" id="cb11-1230" title="1230">  <span class="kw">function</span> <span class="at">leg</span>(n) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1231" title="1231">    <span class="va">c</span>.<span class="at">save</span>()<span class="op">;</span> <span class="co">// Save the current transformation</span></a>
<a class="sourceLine" id="cb11-1232" title="1232">    <span class="cf">if</span> (n <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1233" title="1233">      <span class="co">// Nonrecursive case:</span></a>
<a class="sourceLine" id="cb11-1234" title="1234">      <span class="va">c</span>.<span class="at">lineTo</span>(len<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">//   Just draw a horizontal line</span></a>
<a class="sourceLine" id="cb11-1235" title="1235">    <span class="op">}</span> <span class="co">//                                       _  _</span></a>
<a class="sourceLine" id="cb11-1236" title="1236">    <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1237" title="1237">      <span class="co">// Recursive case: draw 4 sub-legs like:  \/</span></a>
<a class="sourceLine" id="cb11-1238" title="1238">      <span class="va">c</span>.<span class="at">scale</span>(<span class="dv">1</span> / <span class="dv">3</span><span class="op">,</span> <span class="dv">1</span> / <span class="dv">3</span>)<span class="op">;</span> <span class="co">// Sub-legs are 1/3 the size of this leg</span></a>
<a class="sourceLine" id="cb11-1239" title="1239">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Recurse for the first sub-leg</span></a>
<a class="sourceLine" id="cb11-1240" title="1240">      <span class="va">c</span>.<span class="at">rotate</span>(<span class="dv">60</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Turn 60 degrees clockwise</span></a>
<a class="sourceLine" id="cb11-1241" title="1241">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Second sub-leg</span></a>
<a class="sourceLine" id="cb11-1242" title="1242">      <span class="va">c</span>.<span class="at">rotate</span>(<span class="op">-</span><span class="dv">120</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Rotate 120 degrees back</span></a>
<a class="sourceLine" id="cb11-1243" title="1243">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Third sub-leg</span></a>
<a class="sourceLine" id="cb11-1244" title="1244">      <span class="va">c</span>.<span class="at">rotate</span>(<span class="dv">60</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Rotate back to our original heading</span></a>
<a class="sourceLine" id="cb11-1245" title="1245">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Final sub-leg</span></a>
<a class="sourceLine" id="cb11-1246" title="1246">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1247" title="1247">    <span class="va">c</span>.<span class="at">restore</span>()<span class="op">;</span> <span class="co">// Restore the transformation</span></a>
<a class="sourceLine" id="cb11-1248" title="1248">    <span class="va">c</span>.<span class="at">translate</span>(len<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// But translate to make end of leg (0,0)</span></a>
<a class="sourceLine" id="cb11-1249" title="1249">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1250" title="1250"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-1251" title="1251"></a>
<a class="sourceLine" id="cb11-1252" title="1252"><span class="kw">let</span> c <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;canvas&quot;</span>).<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1253" title="1253"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// A level-0 snowflake is a triangle</span></a>
<a class="sourceLine" id="cb11-1254" title="1254"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">175</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// A level-1 snowflake is a 6-sided star</span></a>
<a class="sourceLine" id="cb11-1255" title="1255"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">325</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// etc.</span></a>
<a class="sourceLine" id="cb11-1256" title="1256"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">475</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1257" title="1257"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">625</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// A level-4 snowflake looks like a snowflake!</span></a>
<a class="sourceLine" id="cb11-1258" title="1258"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span> <span class="co">// Stroke this very complicated path</span></a>
<a class="sourceLine" id="cb11-1259" title="1259"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1260" title="1260"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;path&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1261" title="1261"></a>
<a class="sourceLine" id="cb11-1262" title="1262"><span class="kw">async</span> <span class="kw">function</span> <span class="at">listDirectory</span>(dirpath) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1263" title="1263">  <span class="kw">let</span> dir <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="va">promises</span>.<span class="at">opendir</span>(dirpath)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1264" title="1264">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> entry <span class="kw">of</span> dir) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1265" title="1265">    <span class="kw">let</span> name <span class="op">=</span> <span class="va">entry</span>.<span class="at">name</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1266" title="1266">    <span class="cf">if</span> (<span class="va">entry</span>.<span class="at">isDirectory</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1267" title="1267">      name <span class="op">+=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span> <span class="co">// Add a trailing slash to subdirectories</span></a>
<a class="sourceLine" id="cb11-1268" title="1268">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1269" title="1269">    <span class="kw">let</span> stats <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="va">promises</span>.<span class="at">stat</span>(<span class="va">path</span>.<span class="at">join</span>(dirpath<span class="op">,</span> name))<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1270" title="1270">    <span class="kw">let</span> size <span class="op">=</span> <span class="va">stats</span>.<span class="at">size</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-1271" title="1271">    <span class="va">console</span>.<span class="at">log</span>(<span class="at">String</span>(size).<span class="at">padStart</span>(<span class="dv">10</span>)<span class="op">,</span> name)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1272" title="1272">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1273" title="1273"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-1274" title="1274"><span class="co">//requiring path and fs modules</span></a>
<a class="sourceLine" id="cb11-1275" title="1275"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;path&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1276" title="1276"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1277" title="1277"><span class="co">//joining path of directory</span></a>
<a class="sourceLine" id="cb11-1278" title="1278"><span class="kw">const</span> directoryPath <span class="op">=</span> <span class="va">path</span>.<span class="at">join</span>(__dirname<span class="op">,</span> <span class="st">&quot;.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1279" title="1279"><span class="co">//passsing directoryPath and callback function</span></a>
<a class="sourceLine" id="cb11-1280" title="1280"><span class="kw">let</span> fileArr <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1281" title="1281"><span class="va">fs</span>.<span class="at">readdir</span>(directoryPath<span class="op">,</span> <span class="kw">function</span> (err<span class="op">,</span> files) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1282" title="1282">  <span class="co">//handling error</span></a>
<a class="sourceLine" id="cb11-1283" title="1283">  <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1284" title="1284">    <span class="cf">return</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Unable to scan directory: &quot;</span> <span class="op">+</span> err)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1285" title="1285">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-1286" title="1286">  <span class="co">//listing all files using forEach</span></a>
<a class="sourceLine" id="cb11-1287" title="1287">  <span class="va">files</span>.<span class="at">forEach</span>(<span class="kw">function</span> (file) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-1288" title="1288">    <span class="va">fileArr</span>.<span class="at">push</span>(file)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1289" title="1289">    <span class="co">// Do whatever you want to do with the file</span></a>
<a class="sourceLine" id="cb11-1290" title="1290">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;file , fileArr: &quot;</span><span class="op">,</span> file<span class="op">,</span> fileArr)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1291" title="1291">    <span class="cf">return</span> fileArr<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1292" title="1292">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1293" title="1293"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-1294" title="1294"><span class="co">// If the integer 0x00000001 is arranged in memory as 01 00 00 00, then</span></a>
<a class="sourceLine" id="cb11-1295" title="1295"><span class="co">// we&#39;re on a little-endian platform. On a big-endian platform, we&#39;d get</span></a>
<a class="sourceLine" id="cb11-1296" title="1296"><span class="co">// bytes 00 00 00 01 instead.</span></a>
<a class="sourceLine" id="cb11-1297" title="1297"><span class="kw">let</span> littleEndian <span class="op">=</span> <span class="kw">new</span> <span class="at">Int8Array</span>(<span class="kw">new</span> <span class="at">Int32Array</span>([<span class="dv">1</span>]).<span class="at">buffer</span>)[<span class="dv">0</span>] <span class="op">===</span> <span class="dv">1</span><span class="op">;</span></a></code></pre></div>
<hr />
<p>/<em> </em> Return a Proxy object that wraps o, delegating all operations to * that object after logging each operation. objname is a string that * will appear in the log messages to identify the object. If o has own * properties whose values are objects or functions, then if you query * the value of those properties, you’ll get a loggingProxy back, so that * logging behavior of this proxy is “contagious”. */</p>
<hr />
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">function</span> <span class="at">loggingProxy</span>(o<span class="op">,</span> objname) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="co">// Define handlers for our logging Proxy object.</span></a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="co">// Each handler logs a message and then delegates to the target object.</span></a>
<a class="sourceLine" id="cb12-4" title="4">  <span class="kw">const</span> handlers <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-5" title="5">    <span class="co">// This handler is a special case because for own properties</span></a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="co">// whose value is an object or function, it returns a proxy rather</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="co">// than returning the value itself.</span></a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="at">get</span>(target<span class="op">,</span> property<span class="op">,</span> receiver) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-9" title="9">      <span class="co">// Log the get operation</span></a>
<a class="sourceLine" id="cb12-10" title="10">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler get(</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="va">property</span>.<span class="at">toString</span>()<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-11" title="11"></a>
<a class="sourceLine" id="cb12-12" title="12">      <span class="co">// Use the Reflect API to get the property value</span></a>
<a class="sourceLine" id="cb12-13" title="13">      <span class="kw">let</span> value <span class="op">=</span> <span class="va">Reflect</span>.<span class="at">get</span>(target<span class="op">,</span> property<span class="op">,</span> receiver)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-14" title="14"></a>
<a class="sourceLine" id="cb12-15" title="15">      <span class="co">// If the property is an own property of the target and</span></a>
<a class="sourceLine" id="cb12-16" title="16">      <span class="co">// the value is an object or function then return a Proxy for it.</span></a>
<a class="sourceLine" id="cb12-17" title="17">      <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb12-18" title="18">        <span class="va">Reflect</span>.<span class="at">ownKeys</span>(target).<span class="at">includes</span>(property) <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb12-19" title="19">        (<span class="kw">typeof</span> value <span class="op">===</span> <span class="st">&quot;object&quot;</span> <span class="op">||</span> <span class="kw">typeof</span> value <span class="op">===</span> <span class="st">&quot;function&quot;</span>)</a>
<a class="sourceLine" id="cb12-20" title="20">      ) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-21" title="21">        <span class="cf">return</span> <span class="at">loggingProxy</span>(value<span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">.</span><span class="sc">${</span><span class="va">property</span>.<span class="at">toString</span>()<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-22" title="22">      <span class="op">}</span></a>
<a class="sourceLine" id="cb12-23" title="23"></a>
<a class="sourceLine" id="cb12-24" title="24">      <span class="co">// Otherwise return the value unmodified.</span></a>
<a class="sourceLine" id="cb12-25" title="25">      <span class="cf">return</span> value<span class="op">;</span></a>
<a class="sourceLine" id="cb12-26" title="26">    <span class="op">},</span></a>
<a class="sourceLine" id="cb12-27" title="27"></a>
<a class="sourceLine" id="cb12-28" title="28">    <span class="co">// There is nothing special about the following three methods:</span></a>
<a class="sourceLine" id="cb12-29" title="29">    <span class="co">// they log the operation and delegate to the target object.</span></a>
<a class="sourceLine" id="cb12-30" title="30">    <span class="co">// They are a special case simply so we can avoid logging the</span></a>
<a class="sourceLine" id="cb12-31" title="31">    <span class="co">// receiver object which can cause infinite recursion.</span></a>
<a class="sourceLine" id="cb12-32" title="32">    <span class="at">set</span>(target<span class="op">,</span> prop<span class="op">,</span> value<span class="op">,</span> receiver) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-33" title="33">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler set(</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="va">prop</span>.<span class="at">toString</span>()<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-34" title="34">      <span class="cf">return</span> <span class="va">Reflect</span>.<span class="at">set</span>(target<span class="op">,</span> prop<span class="op">,</span> value<span class="op">,</span> receiver)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-35" title="35">    <span class="op">},</span></a>
<a class="sourceLine" id="cb12-36" title="36">    <span class="at">apply</span>(target<span class="op">,</span> receiver<span class="op">,</span> args) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-37" title="37">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler </span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">(</span><span class="sc">${</span>args<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-38" title="38">      <span class="cf">return</span> <span class="va">Reflect</span>.<span class="at">apply</span>(target<span class="op">,</span> receiver<span class="op">,</span> args)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-39" title="39">    <span class="op">},</span></a>
<a class="sourceLine" id="cb12-40" title="40">    <span class="at">construct</span>(target<span class="op">,</span> args<span class="op">,</span> receiver) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-41" title="41">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler </span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">(</span><span class="sc">${</span>args<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-42" title="42">      <span class="cf">return</span> <span class="va">Reflect</span>.<span class="at">construct</span>(target<span class="op">,</span> args<span class="op">,</span> receiver)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-43" title="43">    <span class="op">},</span></a>
<a class="sourceLine" id="cb12-44" title="44">  <span class="op">};</span></a>
<a class="sourceLine" id="cb12-45" title="45"></a>
<a class="sourceLine" id="cb12-46" title="46">  <span class="co">// We can automatically generate the rest of the handlers.</span></a>
<a class="sourceLine" id="cb12-47" title="47">  <span class="co">// Metaprogramming FTW!</span></a>
<a class="sourceLine" id="cb12-48" title="48">  <span class="va">Reflect</span>.<span class="at">ownKeys</span>(Reflect).<span class="at">forEach</span>((handlerName) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb12-49" title="49">    <span class="cf">if</span> (<span class="op">!</span>(handlerName <span class="kw">in</span> handlers)) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-50" title="50">      handlers[handlerName] <span class="op">=</span> <span class="kw">function</span> (target<span class="op">,</span> ...<span class="at">args</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-51" title="51">        <span class="co">// Log the operation</span></a>
<a class="sourceLine" id="cb12-52" title="52">        <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler </span><span class="sc">${</span>handlerName<span class="sc">}</span><span class="vs">(</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>args<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-53" title="53">        <span class="co">// Delegate the operation</span></a>
<a class="sourceLine" id="cb12-54" title="54">        <span class="cf">return</span> Reflect[handlerName](target<span class="op">,</span> ...<span class="at">args</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-55" title="55">      <span class="op">};</span></a>
<a class="sourceLine" id="cb12-56" title="56">    <span class="op">}</span></a>
<a class="sourceLine" id="cb12-57" title="57">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-58" title="58"></a>
<a class="sourceLine" id="cb12-59" title="59">  <span class="co">// Return a proxy for the object using these logging handlers</span></a>
<a class="sourceLine" id="cb12-60" title="60">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Proxy</span>(o<span class="op">,</span> handlers)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-61" title="61"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> This class represents a subrectangle of a canvas or image. We use Tiles to * divide a canvas into regions that can be processed independently by Workers. */</p>
<hr />
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">class</span> Tile <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="at">constructor</span>(x<span class="op">,</span> y<span class="op">,</span> width<span class="op">,</span> height) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="kw">this</span>.<span class="at">x</span> <span class="op">=</span> x<span class="op">;</span> <span class="co">// The properties of a Tile object</span></a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="kw">this</span>.<span class="at">y</span> <span class="op">=</span> y<span class="op">;</span> <span class="co">// represent the position and size</span></a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="kw">this</span>.<span class="at">width</span> <span class="op">=</span> width<span class="op">;</span> <span class="co">// of the tile within a larger</span></a>
<a class="sourceLine" id="cb13-6" title="6">    <span class="kw">this</span>.<span class="at">height</span> <span class="op">=</span> height<span class="op">;</span> <span class="co">// rectangle.</span></a>
<a class="sourceLine" id="cb13-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb13-8" title="8"></a>
<a class="sourceLine" id="cb13-9" title="9">  <span class="co">// This static method is a generator that divides a rectangle of the</span></a>
<a class="sourceLine" id="cb13-10" title="10">  <span class="co">// specified width and height into the specified number of rows and</span></a>
<a class="sourceLine" id="cb13-11" title="11">  <span class="co">// columns and yields numRows*numCols Tile objects to cover the rectangle.</span></a>
<a class="sourceLine" id="cb13-12" title="12">  <span class="kw">static</span> <span class="op">*</span><span class="at">tiles</span>(width<span class="op">,</span> height<span class="op">,</span> numRows<span class="op">,</span> numCols) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-13" title="13">    <span class="kw">let</span> columnWidth <span class="op">=</span> <span class="va">Math</span>.<span class="at">ceil</span>(width / numCols)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-14" title="14">    <span class="kw">let</span> rowHeight <span class="op">=</span> <span class="va">Math</span>.<span class="at">ceil</span>(height / numRows)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-15" title="15"></a>
<a class="sourceLine" id="cb13-16" title="16">    <span class="cf">for</span> (<span class="kw">let</span> row <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> row <span class="op">&lt;</span> numRows<span class="op">;</span> row<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-17" title="17">      <span class="kw">let</span> tileHeight <span class="op">=</span></a>
<a class="sourceLine" id="cb13-18" title="18">        row <span class="op">&lt;</span> numRows <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-19" title="19">          <span class="op">?</span> rowHeight <span class="co">// height of most rows</span></a>
<a class="sourceLine" id="cb13-20" title="20">          : height <span class="op">-</span> rowHeight <span class="op">*</span> (numRows <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// height of last row</span></a>
<a class="sourceLine" id="cb13-21" title="21">      <span class="cf">for</span> (<span class="kw">let</span> col <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> col <span class="op">&lt;</span> numCols<span class="op">;</span> col<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-22" title="22">        <span class="kw">let</span> tileWidth <span class="op">=</span></a>
<a class="sourceLine" id="cb13-23" title="23">          col <span class="op">&lt;</span> numCols <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb13-24" title="24">            <span class="op">?</span> columnWidth <span class="co">// width of most columns</span></a>
<a class="sourceLine" id="cb13-25" title="25">            : width <span class="op">-</span> columnWidth <span class="op">*</span> (numCols <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// and last column</span></a>
<a class="sourceLine" id="cb13-26" title="26"></a>
<a class="sourceLine" id="cb13-27" title="27">        <span class="kw">yield</span> <span class="kw">new</span> <span class="at">Tile</span>(</a>
<a class="sourceLine" id="cb13-28" title="28">          col <span class="op">*</span> columnWidth<span class="op">,</span></a>
<a class="sourceLine" id="cb13-29" title="29">          row <span class="op">*</span> rowHeight<span class="op">,</span></a>
<a class="sourceLine" id="cb13-30" title="30">          tileWidth<span class="op">,</span></a>
<a class="sourceLine" id="cb13-31" title="31">          tileHeight</a>
<a class="sourceLine" id="cb13-32" title="32">        )<span class="op">;</span></a>
<a class="sourceLine" id="cb13-33" title="33">      <span class="op">}</span></a>
<a class="sourceLine" id="cb13-34" title="34">    <span class="op">}</span></a>
<a class="sourceLine" id="cb13-35" title="35">  <span class="op">}</span></a>
<a class="sourceLine" id="cb13-36" title="36"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> This class represents a pool of workers, all running the same code. The * worker code you specify must respond to each message it receives by * performing some kind of computation and then posting a single message with * the result of that computation. <em> </em> Given a WorkerPool and message that represents work to be performed, simply * call addWork(), with the message as an argument. If there is a Worker * object that is currently idle, the message will be posted to that worker * immediately. If there are no idle Worker objects, the message will be * queued and will be posted to a Worker when one becomes available. <em> </em> addWork() returns a Promise, which will resolve with the message recieved * from the work, or will reject if the worker throws an unhandled error. */</p>
<hr />
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">class</span> WorkerPool <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="at">constructor</span>(numWorkers<span class="op">,</span> workerSource) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-3" title="3">    <span class="kw">this</span>.<span class="at">idleWorkers</span> <span class="op">=</span> []<span class="op">;</span> <span class="co">// Workers that are not currently working</span></a>
<a class="sourceLine" id="cb14-4" title="4">    <span class="kw">this</span>.<span class="at">workQueue</span> <span class="op">=</span> []<span class="op">;</span> <span class="co">// Work not currently being processed</span></a>
<a class="sourceLine" id="cb14-5" title="5">    <span class="kw">this</span>.<span class="at">workerMap</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>()<span class="op">;</span> <span class="co">// Map workers to resolve and reject funcs</span></a>
<a class="sourceLine" id="cb14-6" title="6"></a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="co">// Create the specified number of workers, add message and error</span></a>
<a class="sourceLine" id="cb14-8" title="8">    <span class="co">// handlers and save them in the idleWorkers array.</span></a>
<a class="sourceLine" id="cb14-9" title="9">    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> numWorkers<span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-10" title="10">      <span class="kw">let</span> worker <span class="op">=</span> <span class="kw">new</span> <span class="at">Worker</span>(workerSource)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-11" title="11">      <span class="va">worker</span>.<span class="at">onmessage</span> <span class="op">=</span> (message) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-12" title="12">        <span class="kw">this</span>.<span class="at">_workerDone</span>(worker<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="va">message</span>.<span class="at">data</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-13" title="13">      <span class="op">};</span></a>
<a class="sourceLine" id="cb14-14" title="14">      <span class="va">worker</span>.<span class="at">onerror</span> <span class="op">=</span> (error) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-15" title="15">        <span class="kw">this</span>.<span class="at">_workerDone</span>(worker<span class="op">,</span> error<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-16" title="16">      <span class="op">};</span></a>
<a class="sourceLine" id="cb14-17" title="17">      <span class="kw">this</span>.<span class="at">idleWorkers</span>[i] <span class="op">=</span> worker<span class="op">;</span></a>
<a class="sourceLine" id="cb14-18" title="18">    <span class="op">}</span></a>
<a class="sourceLine" id="cb14-19" title="19">  <span class="op">}</span></a>
<a class="sourceLine" id="cb14-20" title="20"></a>
<a class="sourceLine" id="cb14-21" title="21">  <span class="co">// This internal method is called when a worker finishes working, either</span></a>
<a class="sourceLine" id="cb14-22" title="22">  <span class="co">// by sending a message or by throwing an error.</span></a>
<a class="sourceLine" id="cb14-23" title="23">  <span class="at">_workerDone</span>(worker<span class="op">,</span> error<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-24" title="24">    <span class="co">// Look up the resolve() and reject() functions for this worker</span></a>
<a class="sourceLine" id="cb14-25" title="25">    <span class="co">// and then remove the worker&#39;s entry from the map.</span></a>
<a class="sourceLine" id="cb14-26" title="26">    <span class="kw">let</span> [resolver<span class="op">,</span> rejector] <span class="op">=</span> <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">get</span>(worker)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-27" title="27">    <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">delete</span>(worker)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-28" title="28"></a>
<a class="sourceLine" id="cb14-29" title="29">    <span class="co">// If there is no queued work, put this worker back in</span></a>
<a class="sourceLine" id="cb14-30" title="30">    <span class="co">// the list of idle workers. Otherwise, take work from the queue</span></a>
<a class="sourceLine" id="cb14-31" title="31">    <span class="co">// and send it to this worker.</span></a>
<a class="sourceLine" id="cb14-32" title="32">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">workQueue</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-33" title="33">      <span class="kw">this</span>.<span class="va">idleWorkers</span>.<span class="at">push</span>(worker)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-34" title="34">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-35" title="35">      <span class="kw">let</span> [work<span class="op">,</span> resolver<span class="op">,</span> rejector] <span class="op">=</span> <span class="kw">this</span>.<span class="va">workQueue</span>.<span class="at">shift</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb14-36" title="36">      <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">set</span>(worker<span class="op">,</span> [resolver<span class="op">,</span> rejector])<span class="op">;</span></a>
<a class="sourceLine" id="cb14-37" title="37">      <span class="va">worker</span>.<span class="at">postMessage</span>(work)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-38" title="38">    <span class="op">}</span></a>
<a class="sourceLine" id="cb14-39" title="39"></a>
<a class="sourceLine" id="cb14-40" title="40">    <span class="co">// Finally, resolve or reject the promise associated with the worker.</span></a>
<a class="sourceLine" id="cb14-41" title="41">    error <span class="op">===</span> <span class="kw">null</span> <span class="op">?</span> <span class="at">resolver</span>(response) : <span class="at">rejector</span>(error)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-42" title="42">  <span class="op">}</span></a>
<a class="sourceLine" id="cb14-43" title="43"></a>
<a class="sourceLine" id="cb14-44" title="44">  <span class="co">// This method adds work to the worker pool and returns a Promise that</span></a>
<a class="sourceLine" id="cb14-45" title="45">  <span class="co">// will resolve with a worker&#39;s response when the work is done. The work</span></a>
<a class="sourceLine" id="cb14-46" title="46">  <span class="co">// is a value to be passed to a worker with postMessage(). If there is an</span></a>
<a class="sourceLine" id="cb14-47" title="47">  <span class="co">// idle worker, the work message will be sent immediately. Otherwise it</span></a>
<a class="sourceLine" id="cb14-48" title="48">  <span class="co">// will be queued until a worker is available.</span></a>
<a class="sourceLine" id="cb14-49" title="49">  <span class="at">addWork</span>(work) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-50" title="50">    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-51" title="51">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">idleWorkers</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-52" title="52">        <span class="kw">let</span> worker <span class="op">=</span> <span class="kw">this</span>.<span class="va">idleWorkers</span>.<span class="at">pop</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb14-53" title="53">        <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">set</span>(worker<span class="op">,</span> [resolve<span class="op">,</span> reject])<span class="op">;</span></a>
<a class="sourceLine" id="cb14-54" title="54">        <span class="va">worker</span>.<span class="at">postMessage</span>(work)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-55" title="55">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb14-56" title="56">        <span class="kw">this</span>.<span class="va">workQueue</span>.<span class="at">push</span>([work<span class="op">,</span> resolve<span class="op">,</span> reject])<span class="op">;</span></a>
<a class="sourceLine" id="cb14-57" title="57">      <span class="op">}</span></a>
<a class="sourceLine" id="cb14-58" title="58">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb14-59" title="59">  <span class="op">}</span></a>
<a class="sourceLine" id="cb14-60" title="60"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> This class holds the state information necessary to render a Mandelbrot set. * The cx and cy properties give the point in the complex plane that is the * center of the image. The perPixel property specifies how much the real and * imaginary parts of that complex number changes for each pixel of the image. * The maxIterations property specifies how hard we work to compute the set. * Larger numbers require more computation but produce crisper images. * Note that the size of the canvas is not part of the state. Given cx, cy, and * perPixel we simply render whatever portion of the Mandelbrot set fits in * the canvas at its current size. <em> </em> Objects of this type are used with history.pushState() and are used to read * the desired state from a bookmarked or shared URL. */</p>
<hr />
<p>```js class PageState { // This factory method returns an initial state to display the entire set. static initialState() { let s = new PageState(); s.cx = -0.5; s.cy = 0; s.perPixel = 3 / window.innerHeight; s.maxIterations = 500; return s; }</p>
<p>// This factory method obtains state from a URL, or returns null if // a valid state could not be read from the URL. static fromURL(url) { let s = new PageState(); let u = new URL(url); // Initialize state from the url’s search params. s.cx = parseFloat(u.searchParams.get(“cx”)); s.cy = parseFloat(u.searchParams.get(“cy”)); s.perPixel = parseFloat(u.searchParams.get(“pp”)); s.maxIterations = parseInt(u.searchParams.get(“it”)); // If we got valid values, return the PageState object, otherwise null. return isNaN(s.cx) || isNaN(s.cy) || isNaN(s.perPixel) || isNaN(s.maxIterations) ? null : s; }</p>
<p>// This instance method encodes the current state into the search // parameters of the browser’s current location. toURL() { let u = new URL(window.location); u.searchParams.set(“cx”, this.cx); u.searchParams.set(“cy”, this.cy); u.searchParams.set(“pp”, this.perPixel); u.searchParams.set(“it”, this.maxIterations); return u.href; } }</p>
<p>// These constants control the parallelism of the Mandelbrot set computation. // You may need to adjust them to get optimum performance on your computer. const ROWS = 3, COLS = 4, NUMWORKERS = navigator.hardwareConcurrency || 2;</p>
// This is the main class of our Mandelbrot set program. Simply invoke the // constructor function with the
<canvas>
element to render into. The program // assumes that this
<canvas>
<p>element is styled so that it is always as big // as the browser window. class MandelbrotCanvas { constructor(canvas) { // Store the canvas, get its context object, and initialize a WorkerPool this.canvas = canvas; this.context = canvas.getContext(“2d”); this.workerPool = new WorkerPool(NUMWORKERS, “mandelbrotWorker.js”);</p>
<pre><code>// Define some properties that we&#39;ll use later
this.tiles = null; // Subregions of the canvas
this.pendingRender = null; // We&#39;re not currently rendering
this.wantsRerender = false; // No render is currently requested
this.resizeTimer = null; // Prevents us from resizing too frequently
this.colorTable = null; // For converting raw data to pixel values.

// Set up our event handlers
this.canvas.addEventListener(&quot;pointerdown&quot;, (e) =&gt; this.handlePointer(e));
window.addEventListener(&quot;keydown&quot;, (e) =&gt; this.handleKey(e));
window.addEventListener(&quot;resize&quot;, (e) =&gt; this.handleResize(e));
window.addEventListener(&quot;popstate&quot;, (e) =&gt; this.setState(e.state, false));

// Initialize our state from the URL or start with the initial state.
this.state = PageState.fromURL(window.location) || PageState.initialState();

// Save this state with the history mechanism.
history.replaceState(this.state, &quot;&quot;, this.state.toURL());

// Set the canvas size and get an array of tiles that cover it.
this.setSize();

// And render the Mandelbrot set into the canvas.
this.render();</code></pre>
<p>}</p>
<p>// Set the canvas size and initialize an array of Tile objects. This // method is called from the constructor and also by the handleResize() // method when the browser window is resized. setSize() { this.width = this.canvas.width = window.innerWidth; this.height = this.canvas.height = window.innerHeight; this.tiles = […Tile.tiles(this.width, this.height, ROWS, COLS)]; }</p>
<p>// This function makes a change to the PageState, then re-renders the // Mandelbrot set using that new state, and also saves the new state with // history.pushState(). If the first argument is a function that function // will be called with the state object as its argument and should make // changes to the state. If the first argument is an object, then we simply // copy the properties of that object into the state object. If the optional // second argument is false, then the new state will not be saved. (We // do this when calling setState in response to a popstate event.) setState(f, save = true) { // If the argument is a function, call it to update the state. // Otherwise, copy its properties into the current state. if (typeof f === “function”) { f(this.state); } else { for (let property in f) { this.state[property] = f[property]; } }</p>
<pre><code>// In either case, start rendering the new state ASAP.
this.render();

// Normally we save the new state. Except when we&#39;re called with
// a second argument of false which we do when we get a popstate event.
if (save) {
  history.pushState(this.state, &quot;&quot;, this.state.toURL());
}</code></pre>
<p>}</p>
<p>// This method asynchronously draws the portion of the Mandelbrot set // specified by the PageState object into the canvas. It is called by // the constructor, by setState() when the state changes, and by the // resize event handler when the size of the canvas changes. render() { // Sometimes the user may use the keyboard or mouse to request renders // more quickly than we can perform them. We don’t want to submit all // the renders to the worker pool. Instead if we’re rendering, we’ll // just make a note that a new render is needed, and when the current // render completes, we’ll render the current state, possibly skipping // multiple intermediate states. if (this.pendingRender) { // If we’re already rendering, this.wantsRerender = true; // make a note to rerender later return; // and don’t do anything more now. }</p>
<pre><code>// Get our state variables and compute the complex number for the
// upper left corner of the canvas.
let { cx, cy, perPixel, maxIterations } = this.state;
let x0 = cx - (perPixel * this.width) / 2;
let y0 = cy - (perPixel * this.height) / 2;

// For each of our ROWS*COLS tiles, call addWork() with a message
// for the code in mandelbrotWorker.js. Collect the resulting Promise
// objects into an array.
let promises = this.tiles.map((tile) =&gt;
  this.workerPool.addWork({
    tile: tile,
    x0: x0 + tile.x * perPixel,
    y0: y0 + tile.y * perPixel,
    perPixel: perPixel,
    maxIterations: maxIterations,
  })
);

// Use Promise.all() to get an array of responses from the array of
// promises. Each response is the computation for one of our tiles.
// Recall from mandelbrotWorker.js that each response includes the
// Tile object, an ImageData object that includes iteration counts
// instead of pixel values, and the minimum and maximum iterations
// for that tile.
this.pendingRender = Promise.all(promises)
  .then((responses) =&gt; {
    // First, find the overall max and min iterations over all tiles.
    // We need these numbers so we can assign colors to the pixels.
    let min = maxIterations,
      max = 0;
    for (let r of responses) {
      if (r.min &lt; min) min = r.min;
      if (r.max &gt; max) max = r.max;
    }

    // Now we need a way to convert the raw iteration counts from the
    // workers into pixel colors that will be displayed in the canvas.
    // We know that all the pixels have between min and max iterations
    // so we precompute the colors for each iteration count and store
    // them in the colorTable array.

    // If we haven&#39;t allocated a color table yet, or if it is no longer
    // the right size, then allocate a new one.
    if (!this.colorTable || this.colorTable.length !== maxIterations + 1) {
      this.colorTable = new Uint32Array(maxIterations + 1);
    }

    // Given the max and the min, compute appropriate values in the
    // color table. Pixels in the set will be colored fully opaque
    // black. Pixels outside the set will be translucent black with higher
    // iteration counts resulting in higher opacity. Pixels with
    // minimum iteration counts will be transparent and the white
    // background will show through, resulting in a grayscale image.
    if (min === max) {
      // If all the pixels are the same,
      if (min === maxIterations) {
        // Then make them all black
        this.colorTable[min] = 0xff000000;
      } else {
        // Or all transparent.
        this.colorTable[min] = 0;
      }
    } else {
      // In the normal case where min and max are different, use a
      // logarithic scale to assign each possible iteration count an
      // opacity between 0 and 255, and then use the shift left
      // operator to turn that into a pixel value.
      let maxlog = Math.log(1 + max - min);
      for (let i = min; i &lt;= max; i++) {
        this.colorTable[i] =
          Math.ceil((Math.log(1 + i - min) / maxlog) * 255) &lt;&lt; 24;
      }
    }

    // Now translate the iteration numbers in each response&#39;s
    // ImageData to colors from the colorTable.
    for (let r of responses) {
      let iterations = new Uint32Array(r.imageData.data.buffer);
      for (let i = 0; i &lt; iterations.length; i++) {
        iterations[i] = this.colorTable[iterations[i]];
      }
    }

    // Finally, render all the imageData objects into their
    // corresponding tiles of the canvas using putImageData().
    // (First, though, remove any CSS transforms on the canvas that may
    // have been set by the pointerdown event handler.)
    this.canvas.style.transform = &quot;&quot;;
    for (let r of responses) {
      this.context.putImageData(r.imageData, r.tile.x, r.tile.y);
    }
  })
  .catch((reason) =&gt; {
    // If anything went wrong in any of our Promises, we&#39;ll log
    // an error here. This shouldn&#39;t happen, but this will help with
    // debugging if it does.
    console.error(&quot;Promise rejected in render():&quot;, reason);
  })
  .finally(() =&gt; {
    // When we are done rendering, clear the pendingRender flags
    this.pendingRender = null;
    // And if render requests came in while we were busy, rerender now.
    if (this.wantsRerender) {
      this.wantsRerender = false;
      this.render();
    }
  });</code></pre>
<p>}</p>
<p>// If the user resizes the window, this function will be called repeatedly. // Resizing a canvas and rerendering the Mandlebrot set is an expensive // operation that we can’t do multiple times a second, so we use a timer // to defer handling the resize until 200ms have elapsed since the last // resize event was received. handleResize(event) { // If we were already deferring a resize, clear it. if (this.resizeTimer) clearTimeout(this.resizeTimer); // And defer this resize instead. this.resizeTimer = setTimeout(() =&gt; { this.resizeTimer = null; // Note that resize has been handled this.setSize(); // Resize canvas and tiles this.render(); // Rerender at the new size }, 200); }</p>
<p>// If the user presses a key, this event handler will be called. // We call setState() in response to various keys, and setState() renders // the new state, updates the URL, and saves the state in browser history. handleKey(event) { switch (event.key) { case “Escape”: // Type Escape to go back to the initial state this.setState(PageState.initialState()); break; case “+”: // Type + to increase the number of iterations this.setState((s) =&gt; { s.maxIterations = Math.round(s.maxIterations * 1.5); }); break; case “-”: // Type - to decrease the number of iterations this.setState((s) =&gt; { s.maxIterations = Math.round(s.maxIterations / 1.5); if (s.maxIterations &lt; 1) s.maxIterations = 1; }); break; case “o”: // Type o to zoom out this.setState((s) =&gt; (s.perPixel <em>= 2)); break; case “ArrowUp”: // Up arrow to scroll up this.setState((s) =&gt; (s.cy -= (this.height / 10) </em> s.perPixel)); break; case “ArrowDown”: // Down arrow to scroll down this.setState((s) =&gt; (s.cy += (this.height / 10) * s.perPixel)); break; case “ArrowLeft”: // Left arrow to scroll left this.setState((s) =&gt; (s.cx -= (this.width / 10) * s.perPixel)); break; case “ArrowRight”: // Right arrow to scroll right this.setState((s) =&gt; (s.cx += (this.width / 10) * s.perPixel)); break; } }</p>
<p>// This method is called when we get a pointerdown event on the canvas. // The pointerdown event might be the start of a zoom gesture (a click or // tap) or a pan gesture (a drag). This handler registers handlers for // the pointermove and pointerup events in order to respond to the rest // of the gesture. (These two extra handlers are removed when the gesture // ends with a pointerup.) handlePointer(event) { // The pixel coordinates and time of the initial pointer down. // Because the canvas is as big as the window, these event coordinates // are also canvas coordinates. const x0 = event.clientX, y0 = event.clientY, t0 = Date.now();</p>
<pre><code>// This is the handler for move events.
const pointerMoveHandler = (event) =&gt; {
  // How much have we moved, and how much time has passed?
  let dx = event.clientX - x0,
    dy = event.clientY - y0,
    dt = Date.now() - t0;

  // If the pointer has moved enough or enough time has passed that
  // this is not a regular click, then use CSS to pan the display.
  // (We will rerender it for real when we get the pointerup event.)
  if (dx &gt; 10 || dy &gt; 10 || dt &gt; 500) {
    this.canvas.style.transform = `translate(${dx}px, ${dy}px)`;
  }
};

// This is the handler for pointerup events
const pointerUpHandler = (event) =&gt; {
  // When the pointer goes up, the gesture is over, so remove
  // the move and up handlers until the next gesture.
  this.canvas.removeEventListener(&quot;pointermove&quot;, pointerMoveHandler);
  this.canvas.removeEventListener(&quot;pointerup&quot;, pointerUpHandler);

  // How much did the pointer move, and how much time passed?
  const dx = event.clientX - x0,
    dy = event.clientY - y0,
    dt = Date.now() - t0;
  // Unpack the state object into individual constants.
  const { cx, cy, perPixel } = this.state;

  // If the pointer moved far enough or if enough time passed, then
  // this was a pan gesture, and we need to change state to change
  // the center point. Otherwise, the user clicked or tapped on a
  // point and we need to center and zoom in on that point.
  if (dx &gt; 10 || dy &gt; 10 || dt &gt; 500) {
    // The user panned the image by (dx, dy) pixels.
    // Convert those values to offsets in the complex plane.
    this.setState({ cx: cx - dx * perPixel, cy: cy - dy * perPixel });
  } else {
    // The user clicked. Compute how many pixels the center moves.
    let cdx = x0 - this.width / 2;
    let cdy = y0 - this.height / 2;

    // Use CSS to quickly and temporarily zoom in
    this.canvas.style.transform = `translate(${-cdx * 2}px, ${
      -cdy * 2
    }px) scale(2)`;

    // Set the complex coordinates of the new center point and
    // zoom in by a factor of 2.
    this.setState((s) =&gt; {
      s.cx += cdx * s.perPixel;
      s.cy += cdy * s.perPixel;
      s.perPixel /= 2;
    });
  }
};

// When the user begins a gesture we register handlers for the
// pointermove and pointerup events that follow.
this.canvas.addEventListener(&quot;pointermove&quot;, pointerMoveHandler);
this.canvas.addEventListener(&quot;pointerup&quot;, pointerUpHandler);</code></pre>
<p>} }</p>
// Finally, here’s how we set up the canvas. Note that this JavaScript file // is self-sufficient. The HTML file only needs to include this one
<script>
. let canvas = document.createElement(“canvas”); // Create a canvas element document.body.append(canvas); // Insert it into the body document.body.style = “margin:0”; // No margin for the
<body>
<p>canvas.style.width = “100%”; // Make canvas as wide as body canvas.style.height = “100%”; // and as high as the body. new MandelbrotCanvas(canvas); // And start rendering into it! // This is a simple worker that receives a message from its parent thread, // performs the computation described by that message and then posts the // result of that computation back to the parent thread. onmessage = function (message) { // First, we unpack the message we received: // - tile is an object with width and height properties. It specifies the // size of the rectangle of pixels for which we will be computing // Mandelbrot set membership. // - (x0, y0) is the point in the complex plane that corresponds to the // upper-left pixel in the tile. // - perPixel is the pixel size in both the real and imaginary dimensions. // - maxIterations specifies the maximum number of iterations we will // perform before deciding that a pixel is in the set. const { tile, x0, y0, perPixel, maxIterations } = message.data; const { width, height } = tile;</p>
<p>// Next, we create an ImageData object to represent the rectangular array // of pixels, get its internal ArrayBuffer, and create a typed array view // of that buffer so we can treat each pixel as a single integer instead of // four individual bytes. We’ll store the number of iterations for each // pixel in this iterations array. (The iterations will be transformed into // actual pixel colors in the parent thread.) const imageData = new ImageData(width, height); const iterations = new Uint32Array(imageData.data.buffer);</p>
<p>// Now we begin the computation. There are three nested for loops here. // The outer two loop over the rows and columns of pixels, and the inner // loop iterates each pixel to see if it “escapes” or not. The various // loop variables are the following: // - row and column are integers representing the pixel coordinate. // - x and y represent the complex point for each pixel: x + yi. // - index is the index in the iterations array for the current pixel. // - n tracks the number of iterations for each pixel. // - max and min track the largest and smallest number of iterations // we’ve seen so far for any pixel in the rectangle. let index = 0, max = 0, min = maxIterations; for (let row = 0, y = y0; row &lt; height; row++, y += perPixel) { for (let column = 0, x = x0; column &lt; width; column++, x += perPixel) { // For each pixel we start with the complex number c = x+yi. // Then we repeatedly compute the complex number z(n+1) based on // this recursive formula: // z(0) = c // z(n+1) = z(n)^2 + c // If |z(n)| (the magnitude of z(n)) is &gt; 2, then the // pixel is not part of the set and we stop after n iterations. let n; // The number of iterations so far let r = x, i = y; // Start with z(0) set to c for (n = 0; n &lt; maxIterations; n++) { let rr = r * r, ii = i * i; // Square the two parts of z(n). if (rr + ii &gt; 4) { // If |z(n)|^2 is &gt; 4 then break; // we’ve escaped and can stop iterating. } i = 2 * r * i + y; // Compute imaginary part of z(n+1). r = rr - ii + x; // And the real part of z(n+1). } iterations[index++] = n; // Remember # iterations for each pixel. if (n &gt; max) max = n; // Track the maximum number we’ve seen. if (n &lt; min) min = n; // And the minimum as well. } }</p>
<p>// When the computation is complete, send the results back to the parent // thread. The imageData object will be copied, but the giant ArrayBuffer // it contains will be transferred for a nice performance boost. postMessage({ tile, imageData, min, max }, [imageData.data.buffer]); }; // Return an iterable object that iterates the result of applying f() // to each value from the source iterable function map(iterable, f) { let iterator = iterable<a href="">Symbol.iterator</a>; return { // This object is both iterator and iterable <a href="">Symbol.iterator</a> { return this; }, next() { let v = iterator.next(); if (v.done) { return v; } else { return { value: f(v.value) }; } }, }; }</p>
<p>// Map a range of integers to their squares and convert to an array […map(new Range(1, 4), (x) =&gt; x * x)]; // =&gt; [1, 4, 9, 16] // Return a function that expects an array argument and applies f to // each element, returning the array of return values. // Contrast this with the map() function from earlier. function mapper(f) { return (a) =&gt; map(a, f); }</p>
<p>const increment = (x) =&gt; x + 1; const incrementAll = mapper(increment); incrementAll([1, 2, 3]); // =&gt; [2,3,4] // Return a memoized version of f. // It only works if arguments to f all have distinct string representations. function memoize(f) { const cache = new Map(); // Value cache stored in the closure.</p>
<p>return function (…args) { // Create a string version of the arguments to use as a cache key. let key = args.length + args.join(“+”); if (cache.has(key)) { return cache.get(key); } else { let result = f.apply(this, args); cache.set(key, result); return result; } }; }</p>
<p>// Return the Greatest Common Divisor of two integers using the Euclidian // algorithm: http://en.wikipedia.org/wiki/Euclidean_algorithm function gcd(a, b) { // Type checking for a and b has been omitted if (a &lt; b) { // Ensure that a &gt;= b when we start [a, b] = [b, a]; // Destructuring assignment to swap variables } while (b !== 0) { // This is Euclid’s algorithm for GCD [a, b] = [b, a % b]; } return a; }</p>
<p>const gcdmemo = memoize(gcd); gcdmemo(85, 187); // =&gt; 17</p>
<p>// Note that when we write a recursive function that we will be memoizing, // we typically want to recurse to the memoized version, not the original. const factorial = memoize(function (n) { return n &lt;= 1 ? 1 : n * factorial(n - 1); }); factorial(5); // =&gt; 120: also caches values for 4, 3, 2 and 1. // Like Object.assign() but doesn’t override existing properties // (and also doesn’t handle Symbol properties) function merge(target, …sources) { for (let source of sources) { for (let key of Object.keys(source)) { if (!(key in target)) { // This is different than Object.assign() target[key] = source[key]; } } } return target; } Object.assign({ x: 1 }, { x: 2, y: 2 }, { y: 3, z: 4 }); // =&gt; {x: 2, y: 3, z: 4} merge({ x: 1 }, { x: 2, y: 2 }, { y: 3, z: 4 }); // =&gt; {x: 1, y: 2, z: 4} // This higher-order function returns a new function that passes its // arguments to f and returns the logical negation of f’s return value; function not(f) { return function (…args) { // Return a new function let result = f.apply(this, args); // that calls f return !result; // and negates its result. }; }</p>
const even = (x) =&gt; x % 2 === 0; // A function to determine if a number is even const odd = not(even); // A new function that does the opposite [1, 1, 3, 5, 5].every(odd); // =&gt; true: every element of the array is odd // Set the onload property of the Window object to a function. // The function is the event handler: it is invoked when the document loads. window.onload = function () { // Look up a
<form>
<p>element let form = document.querySelector(“form#shipping”); // Register an event handler function on the form that will be invoked // before the form is submitted. Assume isFormValid() is defined elsewhere. form.onsubmit = function (event) { // When the user submits the form if (!isFormValid(this)) { // check whether form inputs are valid event.preventDefault(); // and if not, prevent form submission. } }; }; // We define some simple functions here function add(x, y) { return x + y; } function subtract(x, y) { return x - y; } function multiply(x, y) { return x * y; } function divide(x, y) { return x / y; }</p>
<p>// Here’s a function that takes one of the preceding functions // as an argument and invokes it on two operands function operate(operator, operand1, operand2) { return operator(operand1, operand2); }</p>
<p>// We could invoke this function like this to compute the value (2+3) + (4*5): let i = operate(add, operate(add, 2, 3), operate(multiply, 4, 5));</p>
<p>// For the sake of the example, we implement the simple functions again, // this time within an object literal; const operators = { add: (x, y) =&gt; x + y, subtract: (x, y) =&gt; x - y, multiply: (x, y) =&gt; x * y, divide: (x, y) =&gt; x / y, pow: Math.pow, // This works for predefined functions too };</p>
<p>// This function takes the name of an operator, looks up that operator // in the object, and then invokes it on the supplied operands. Note // the syntax used to invoke the operator function. function operate2(operation, operand1, operand2) { if (typeof operators[operation] === “function”) { return operators<a href="operand1,%20operand2">operation</a>; } else throw “unknown operator”; }</p>
<p>operate2(“add”, “hello”, operate2(“add”, " “,”world“)); // =&gt;”hello world" operate2(“pow”, 10, 2); // =&gt; 100</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> An asynchronously iterable queue class. Add values with enqueue() </em> and remove them with dequeue(). dequeue() returns a Promise, which * means that values can be dequeued before they are enqueued. The * class implements [Symbol.asyncIterator] and next() so that it can * be used with the for/await loop (which will not terminate until * the close() method is called.) */</p>
<hr />
<p>```js class AsyncQueue { constructor() { // Values that have been queued but not dequeued yet are stored here this.values = []; // When Promises are dequeued before their corresponding values are // queued, the resolve methods for those Promises are stored here. this.resolvers = []; // Once closed, no more values can be enqueued, and no more unfulfilled // Promises returned. this.closed = false; }</p>
<p>enqueue(value) { if (this.closed) { throw new Error(“AsyncQueue closed”); } if (this.resolvers.length &gt; 0) { // If this value has already been promised, resolve that Promise const resolve = this.resolvers.shift(); resolve(value); } else { // Otherwise, queue it up this.values.push(value); } }</p>
<p>dequeue() { if (this.values.length &gt; 0) { // If there is a queued value, return a resolved Promise for it const value = this.values.shift(); return Promise.resolve(value); } else if (this.closed) { // If no queued values and we’re closed, return a resolved // Promise for the “end-of-stream” marker return Promise.resolve(AsyncQueue.EOS); } else { // Otherwise, return an unresolved Promise, // queuing the resolver function for later use return new Promise((resolve) =&gt; { this.resolvers.push(resolve); }); } }</p>
<p>close() { // Once the queue is closed, no more values will be enqueued. // So resolve any pending Promises with the end-of-stream marker while (this.resolvers.length &gt; 0) { this.resolvers.shift()(AsyncQueue.EOS); } this.closed = true; }</p>
<p>// Define the method that makes this class asynchronously iterable <a href="">Symbol.asyncIterator</a> { return this; }</p>
<p>// Define the method that makes this an asynchronous iterator. The // dequeue() Promise resolves to a value or the EOS sentinel if we’re // closed. Here, we need to return a Promise that resolves to an // iterator result object. next() { return this.dequeue().then((value) =&gt; value === AsyncQueue.EOS ? { value: undefined, done: true } : { value: value, done: false } ); } }</p>
<p>// A sentinel value returned by dequeue() to mark “end of stream” when closed AsyncQueue.EOS = Symbol(“end-of-stream”);</p>
<p>// Push events of the specified type on the specified document element // onto an AsyncQueue object, and return the queue for use as an event stream function eventStream(elt, type) { const q = new AsyncQueue(); // Create a queue elt.addEventListener(type, (e) =&gt; q.enqueue(e)); // Enqueue events return q; }</p>
<p>async function handleKeys() { // Get a stream of keypress events and loop once for each one for await (const event of eventStream(document, “keypress”)) { console.log(event.key); } }</p>
<p>const BitSet = (function() { // Set BitSet to the return value of this function // Private implementation details here function isValid(set, n) { … } function has(set, byte, bit) { … } const BITS = new Uint8Array([1, 2, 4, 8, 16, 32, 64, 128]); const MASKS = new Uint8Array([~1, ~2, ~4, ~8, ~16, ~32, ~64, ~128]);</p>
<pre><code>// The public API of the module is just the BitSet class, which we define
// and return here. The class can use the private functions and constants
// defined above, but they will be hidden from users of the class
return class BitSet extends AbstractWritableSet {
    // ... implementation omitted ...
};</code></pre>
<p>}());</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> Instances of this Complex class represent complex numbers. </em> Recall that a complex number is the sum of a real number and an * imaginary number and that the imaginary number i is the square root of -1. */</p>
<hr />
<p>```js class Complex { // Once class field declarations are standardized, we could declare // private fields to hold the real and imaginary parts of a complex number // here, with code like this: // // #r = 0; // #i = 0;</p>
<p>// This constructor function defines the instance fields r and i on every // instance it creates. These fields hold the real and imaginary parts of // the complex number: they are the state of the object. constructor(real, imaginary) { this.r = real; // This field holds the real part of the number. this.i = imaginary; // This field holds the imaginary part. }</p>
<p>// Here are two instance methods for addition and multiplication // of complex numbers. If c and d are instances of this class, we // might write c.plus(d) or d.times(c) plus(that) { return new Complex(this.r + that.r, this.i + that.i); } times(that) { return new Complex( this.r * that.r - this.i * that.i, this.r * that.i + this.i * that.r ); }</p>
<p>// And here are static variants of the complex arithmetic methods. // We could write Complex.sum(c,d) and Complex.product(c,d) static sum(c, d) { return c.plus(d); } static product(c, d) { return c.times(d); }</p>
<p>// These are some instance methods that are defined as getters // so they’re used like fields. The real and imaginary getters would // be useful if we were using private fields this.#r and this.#i get real() { return this.r; } get imaginary() { return this.i; } get magnitude() { return Math.hypot(this.r, this.i); }</p>
<p>// Classes should almost always have a toString() method toString() { return <code>{${this.r},${this.i}}</code>; }</p>
<p>// It is often useful to define a method for testing whether // two instances of your class represent the same value equals(that) { return that instanceof Complex &amp;&amp; this.r === that.r &amp;&amp; this.i === that.i; }</p>
<p>// Once static fields are supported inside class bodies, we could // define a useful Complex.ZERO constant like this: // static ZERO = new Complex(0,0); }</p>
<p>// Here are some class fields that hold useful predefined complex numbers. Complex.ZERO = new Complex(0, 0); Complex.ONE = new Complex(1, 0); Complex.I = new Complex(0, 1);</p>
<p>// A trivial Array subclass that adds getters for the first and last elements. class EZArray extends Array { get first() { return this[0]; } get last() { return this[this.length - 1]; } }</p>
<p>let a = new EZArray(); a instanceof EZArray; // =&gt; true: a is subclass instance a instanceof Array; // =&gt; true: a is also a superclass instance. a.push(1, 2, 3, 4); // a.length == 4; we can use inherited methods a.pop(); // =&gt; 4: another inherited method a.first; // =&gt; 1: first getter defined by subclass a.last; // =&gt; 3: last getter defined by subclass a[1]; // =&gt; 2: regular array access syntax still works. Array.isArray(a); // =&gt; true: subclass instance really is an array EZArray.isArray(a); // =&gt; true: subclass inherits static methods, too!</p>
<p>// EZArray inherits instance methods because EZArray.prototype // inherits from Array.prototype Array.prototype.isPrototypeOf(EZArray.prototype); // =&gt; true</p>
<p>// And EZArray inherits static methods and properties because // EZArray inherits from Array. This is a special feature of the // extends keyword and is not possible before ES6. Array.isPrototypeOf(EZArray); // =&gt; true</p>
<p>class Glob { constructor(glob) { this.glob = glob;</p>
<pre><code>// We implement glob matching using RegExp internally.
// ? matches any one character except /, and * matches zero or more
// of those characters. We use capturing groups around each.
let regexpText = glob.replace(&quot;?&quot;, &quot;([^/])&quot;).replace(&quot;*&quot;, &quot;([^/]*)&quot;);

// We use the u flag to get Unicode-aware matching.
// Globs are intended to match entire strings, so we use the ^ and $
// anchors and do not implement search() or matchAll() since they
// are not useful with patterns like this.
this.regexp = new RegExp(`^${regexpText}$`, &quot;u&quot;);</code></pre>
<p>}</p>
<p>toString() { return this.glob; }</p>
<p><a href="s">Symbol.search</a> { return s.search(this.regexp); } <a href="s">Symbol.match</a> { return s.match(this.regexp); } <a href="s,%20replacement">Symbol.replace</a> { return s.replace(this.regexp, replacement); } }</p>
<p>let pattern = new Glob("docs/*.txt“);”docs/js.txt“.search(pattern); // =&gt; 0: matches at character 0”docs/js.htm“.search(pattern); // =&gt; -1: does not match let match =”docs/js.txt“.match(pattern); match[0]; // =&gt;”docs/js.txt" match[1]; // =&gt; “js” match.index; // =&gt; 0 “docs/js.txt”.replace(pattern, “web/$1.htm”); // =&gt; “web/js.htm”</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> A Set-like class that keeps track of how many times a value has </em> been added. Call add() and remove() like you would for a Set, and * call count() to find out how many times a given value has been added. * The default iterator yields the values that have been added at least * once. Use entries() if you want to iterate [value, count] pairs. */</p>
<hr />
<div class="sourceCode" id="cb21"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb21-1" title="1"><span class="kw">class</span> Histogram <span class="op">{</span></a>
<a class="sourceLine" id="cb21-2" title="2">  <span class="co">// To initialize, we just create a Map object to delegate to</span></a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb21-4" title="4">    <span class="kw">this</span>.<span class="at">map</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb21-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-6" title="6"></a>
<a class="sourceLine" id="cb21-7" title="7">  <span class="co">// For any given key, the count is the value in the Map, or zero</span></a>
<a class="sourceLine" id="cb21-8" title="8">  <span class="co">// if the key does not appear in the Map.</span></a>
<a class="sourceLine" id="cb21-9" title="9">  <span class="at">count</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb21-10" title="10">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">get</span>(key) <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb21-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-12" title="12"></a>
<a class="sourceLine" id="cb21-13" title="13">  <span class="co">// The Set-like method has() returns true if the count is non-zero</span></a>
<a class="sourceLine" id="cb21-14" title="14">  <span class="at">has</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb21-15" title="15">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">count</span>(key) <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb21-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-17" title="17"></a>
<a class="sourceLine" id="cb21-18" title="18">  <span class="co">// The size of the histogram is just the number of entries in the Map.</span></a>
<a class="sourceLine" id="cb21-19" title="19">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb21-20" title="20">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">size</span><span class="op">;</span></a>
<a class="sourceLine" id="cb21-21" title="21">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-22" title="22"></a>
<a class="sourceLine" id="cb21-23" title="23">  <span class="co">// To add a key, just increment its count in the Map.</span></a>
<a class="sourceLine" id="cb21-24" title="24">  <span class="at">add</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb21-25" title="25">    <span class="kw">this</span>.<span class="va">map</span>.<span class="at">set</span>(key<span class="op">,</span> <span class="kw">this</span>.<span class="at">count</span>(key) <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-26" title="26">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-27" title="27"></a>
<a class="sourceLine" id="cb21-28" title="28">  <span class="co">// Deleting a key is a little trickier because we have to delete</span></a>
<a class="sourceLine" id="cb21-29" title="29">  <span class="co">// the key from the Map if the count goes back down to zero.</span></a>
<a class="sourceLine" id="cb21-30" title="30">  <span class="kw">delete</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb21-31" title="31">    <span class="kw">let</span> count <span class="op">=</span> <span class="kw">this</span>.<span class="at">count</span>(key)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-32" title="32">    <span class="cf">if</span> (count <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb21-33" title="33">      <span class="kw">this</span>.<span class="va">map</span>.<span class="at">delete</span>(key)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-34" title="34">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (count <span class="op">&gt;</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb21-35" title="35">      <span class="kw">this</span>.<span class="va">map</span>.<span class="at">set</span>(key<span class="op">,</span> count <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-36" title="36">    <span class="op">}</span></a>
<a class="sourceLine" id="cb21-37" title="37">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-38" title="38"></a>
<a class="sourceLine" id="cb21-39" title="39">  <span class="co">// Iterating a Histogram just returns the keys stored in it</span></a>
<a class="sourceLine" id="cb21-40" title="40">  [<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb21-41" title="41">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">keys</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb21-42" title="42">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-43" title="43"></a>
<a class="sourceLine" id="cb21-44" title="44">  <span class="co">// These other iterator methods just delegate to the Map object</span></a>
<a class="sourceLine" id="cb21-45" title="45">  <span class="at">keys</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb21-46" title="46">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">keys</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb21-47" title="47">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-48" title="48">  <span class="at">values</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb21-49" title="49">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">values</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb21-50" title="50">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-51" title="51">  <span class="at">entries</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb21-52" title="52">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">map</span>.<span class="at">entries</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb21-53" title="53">  <span class="op">}</span></a>
<a class="sourceLine" id="cb21-54" title="54"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> A Range object represents a range of numbers {x: from &lt;= x &lt;= to} * Range defines a has() method for testing whether a given number is a member * of the range. Range is iterable and iterates all integers within the range. */</p>
<hr />
<p>```js class Range { constructor(from, to) { this.from = from; this.to = to; }</p>
<p>// Make a Range act like a Set of numbers has(x) { return typeof x === “number” &amp;&amp; this.from &lt;= x &amp;&amp; x &lt;= this.to; }</p>
<p>// Return string representation of the range using set notation toString() { return <code>{ x | ${this.from} ≤ x ≤ ${this.to} }</code>; }</p>
<p>// Make a Range iterable by returning an iterator object. // Note that the name of this method is a special symbol, not a string. <a href="">Symbol.iterator</a> { // Each iterator instance must iterate the range independently of // others. So we need a state variable to track our location in the // iteration. We start at the first integer &gt;= from. let next = Math.ceil(this.from); // This is the next value we return let last = this.to; // We won’t return anything &gt; this return { // This is the iterator object // This next() method is what makes this an iterator object. // It must return an iterator result object. next() { return next &lt;= last // If we haven’t returned last value yet ? { value: next++ } // return next value and increment it : { done: true }; // otherwise indicate that we’re done. },</p>
<pre><code>  // As a convenience, we make the iterator itself iterable.
  [Symbol.iterator]() {
    return this;
  },
};</code></pre>
<p>} }</p>
<p>for (let x of new Range(1, 10)) console.log(x); // Logs numbers 1 to 10 […new Range(-2, 2)]; // =&gt; [-2, -1, 0, 1, 2]</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> The AbstractSet class defines a single abstract method, has(). </em>/</p>
<hr />
<p>```js class AbstractSet { // Throw an error here so that subclasses are forced // to define their own working version of this method. has(x) { throw new Error(“Abstract method”); } }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> NotSet is a concrete subclass of AbstractSet. </em> The members of this set are all values that are not members of some * other set. Because it is defined in terms of another set it is not * writable, and because it has infinite members, it is not enumerable. * All we can do with it is test for membership and convert it to a * string using mathematical notation. */</p>
<hr />
<p>```js class NotSet extends AbstractSet { constructor(set) { super(); this.set = set; }</p>
<p>// Our implementation of the abstract method we inherited has(x) { return !this.set.has(x); } // And we also override this Object method toString() { return <code>{ x| x ∉ ${this.set.toString()} }</code>; } }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> Range set is a concrete subclass of AbstractSet. Its members are </em> all values that are between the from and to bounds, inclusive. * Since its members can be floating point numbers, it is not * enumerable and does not have a meaningful size. */</p>
<hr />
<div class="sourceCode" id="cb23"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">class</span> RangeSet <span class="kw">extends</span> AbstractSet <span class="op">{</span></a>
<a class="sourceLine" id="cb23-2" title="2">  <span class="at">constructor</span>(<span class="im">from</span><span class="op">,</span> to) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-3" title="3">    <span class="kw">super</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb23-4" title="4">    <span class="kw">this</span>.<span class="at">from</span> <span class="op">=</span> <span class="im">from</span><span class="op">;</span></a>
<a class="sourceLine" id="cb23-5" title="5">    <span class="kw">this</span>.<span class="at">to</span> <span class="op">=</span> to<span class="op">;</span></a>
<a class="sourceLine" id="cb23-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb23-7" title="7"></a>
<a class="sourceLine" id="cb23-8" title="8">  <span class="at">has</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-9" title="9">    <span class="cf">return</span> x <span class="op">&gt;=</span> <span class="kw">this</span>.<span class="at">from</span> <span class="op">&amp;&amp;</span> x <span class="op">&lt;=</span> <span class="kw">this</span>.<span class="at">to</span><span class="op">;</span></a>
<a class="sourceLine" id="cb23-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb23-11" title="11">  <span class="at">toString</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb23-12" title="12">    <span class="cf">return</span> <span class="vs">`{ x| </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">from</span><span class="sc">}</span><span class="vs"> ≤ x ≤ </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">to</span><span class="sc">}</span><span class="vs"> }`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb23-13" title="13">  <span class="op">}</span></a>
<a class="sourceLine" id="cb23-14" title="14"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> AbstractEnumerableSet is an abstract subclass of AbstractSet. It defines * an abstract getter that returns the size of the set and also defines an * abstract iterator. And it then implements concrete isEmpty(), toString(), * and equals() methods on top of those. Subclasses that implement the * iterator, the size getter, and the has() method get these concrete * methods for free. */</p>
<hr />
<div class="sourceCode" id="cb24"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">class</span> AbstractEnumerableSet <span class="kw">extends</span> AbstractSet <span class="op">{</span></a>
<a class="sourceLine" id="cb24-2" title="2">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb24-3" title="3">    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Abstract method&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-5" title="5">  [<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb24-6" title="6">    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Abstract method&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-8" title="8"></a>
<a class="sourceLine" id="cb24-9" title="9">  <span class="at">isEmpty</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb24-10" title="10">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">size</span> <span class="op">===</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-12" title="12">  <span class="at">toString</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb24-13" title="13">    <span class="cf">return</span> <span class="vs">`{</span><span class="sc">${</span><span class="va">Array</span>.<span class="at">from</span>(<span class="kw">this</span>).<span class="at">join</span>(<span class="st">&quot;, &quot;</span>)<span class="sc">}</span><span class="vs">}`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-15" title="15">  <span class="at">equals</span>(set) <span class="op">{</span></a>
<a class="sourceLine" id="cb24-16" title="16">    <span class="co">// If the other set is not also Enumerable, it isn&#39;t equal to this one</span></a>
<a class="sourceLine" id="cb24-17" title="17">    <span class="cf">if</span> (<span class="op">!</span>(set <span class="kw">instanceof</span> AbstractEnumerableSet)) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-18" title="18"></a>
<a class="sourceLine" id="cb24-19" title="19">    <span class="co">// If they don&#39;t have the same size, they&#39;re not equal</span></a>
<a class="sourceLine" id="cb24-20" title="20">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">size</span> <span class="op">!==</span> <span class="va">set</span>.<span class="at">size</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-21" title="21"></a>
<a class="sourceLine" id="cb24-22" title="22">    <span class="co">// Loop through the elements of this set</span></a>
<a class="sourceLine" id="cb24-23" title="23">    <span class="cf">for</span> (<span class="kw">let</span> element <span class="kw">of</span> <span class="kw">this</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb24-24" title="24">      <span class="co">// If an element isn&#39;t in the other set, they aren&#39;t equal</span></a>
<a class="sourceLine" id="cb24-25" title="25">      <span class="cf">if</span> (<span class="op">!</span><span class="va">set</span>.<span class="at">has</span>(element)) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb24-27" title="27"></a>
<a class="sourceLine" id="cb24-28" title="28">    <span class="co">// The elements matched, so the sets are equal</span></a>
<a class="sourceLine" id="cb24-29" title="29">    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-30" title="30">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-31" title="31"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> SingletonSet is a concrete subclass of AbstractEnumerableSet. * A singleton set is a read-only set with a single member. */</p>
<hr />
<div class="sourceCode" id="cb25"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb25-1" title="1"><span class="kw">class</span> SingletonSet <span class="kw">extends</span> AbstractEnumerableSet <span class="op">{</span></a>
<a class="sourceLine" id="cb25-2" title="2">  <span class="at">constructor</span>(member) <span class="op">{</span></a>
<a class="sourceLine" id="cb25-3" title="3">    <span class="kw">super</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb25-4" title="4">    <span class="kw">this</span>.<span class="at">member</span> <span class="op">=</span> member<span class="op">;</span></a>
<a class="sourceLine" id="cb25-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb25-6" title="6"></a>
<a class="sourceLine" id="cb25-7" title="7">  <span class="co">// We implement these three methods, and inherit isEmpty, equals()</span></a>
<a class="sourceLine" id="cb25-8" title="8">  <span class="co">// and toString() implementations based on these methods.</span></a>
<a class="sourceLine" id="cb25-9" title="9">  <span class="at">has</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb25-10" title="10">    <span class="cf">return</span> x <span class="op">===</span> <span class="kw">this</span>.<span class="at">member</span><span class="op">;</span></a>
<a class="sourceLine" id="cb25-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb25-12" title="12">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb25-13" title="13">    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb25-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb25-15" title="15">  <span class="op">*</span>[<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb25-16" title="16">    <span class="kw">yield</span> <span class="kw">this</span>.<span class="at">member</span><span class="op">;</span></a>
<a class="sourceLine" id="cb25-17" title="17">  <span class="op">}</span></a>
<a class="sourceLine" id="cb25-18" title="18"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> AbstractWritableSet is an abstract subclass of AbstractEnumerableSet. * It defines the abstract methods insert() and remove() that insert and * remove individual elements from the set, and then implements concrete * add(), subtract(), and intersect() methods on top of those. Note that * our API diverges here from the standard JavaScript Set class. */</p>
<hr />
<p>```js class AbstractWritableSet extends AbstractEnumerableSet { insert(x) { throw new Error(“Abstract method”); } remove(x) { throw new Error(“Abstract method”); }</p>
<p>add(set) { for (let element of set) { this.insert(element); } }</p>
<p>subtract(set) { for (let element of set) { this.remove(element); } }</p>
<p>intersect(set) { for (let element of this) { if (!set.has(element)) { this.remove(element); } } } }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> A BitSet is a concrete subclass of AbstractWritableSet with a </em> very efficient fixed-size set implementation for sets whose * elements are non-negative integers less than some maximum size. */</p>
<hr />
<p>```js class BitSet extends AbstractWritableSet { constructor(max) { super(); this.max = max; // The maximum integer we can store. this.n = 0; // How many integers are in the set this.numBytes = Math.floor(max / 8) + 1; // How many bytes we need this.data = new Uint8Array(this.numBytes); // The bytes }</p>
<p>// Internal method to check if a value is a legal member of this set _valid(x) { return Number.isInteger(x) &amp;&amp; x &gt;= 0 &amp;&amp; x &lt;= this.max; }</p>
<p>// Tests whether the specified bit of the specified byte of our // data array is set or not. Returns true or false. _has(byte, bit) { return (this.data[byte] &amp; BitSet.bits[bit]) !== 0; }</p>
<p>// Is the value x in this BitSet? has(x) { if (this._valid(x)) { let byte = Math.floor(x / 8); let bit = x % 8; return this._has(byte, bit); } else { return false; } }</p>
<p>// Insert the value x into the BitSet insert(x) { if (this._valid(x)) { // If the value is valid let byte = Math.floor(x / 8); // convert to byte and bit let bit = x % 8; if (!this._has(byte, bit)) { // If that bit is not set yet this.data[byte] |= BitSet.bits[bit]; // then set it this.n++; // and increment set size } } else { throw new TypeError(“Invalid set element:” + x); } }</p>
<p>remove(x) { if (this._valid(x)) { // If the value is valid let byte = Math.floor(x / 8); // compute the byte and bit let bit = x % 8; if (this._has(byte, bit)) { // If that bit is already set this.data[byte] &amp;= BitSet.masks[bit]; // then unset it this.n–; // and decrement size } } else { throw new TypeError(“Invalid set element:” + x); } }</p>
<p>// A getter to return the size of the set get size() { return this.n; }</p>
<p>// Iterate the set by just checking each bit in turn. // (We could be a lot more clever and optimize this substantially) *<a href="">Symbol.iterator</a> { for (let i = 0; i &lt;= this.max; i++) { if (this.has(i)) { yield i; } } } }</p>
<p>// Some pre-computed values used by the has(), insert() and remove() methods BitSet.bits = new Uint8Array([1, 2, 4, 8, 16, 32, 64, 128]); BitSet.masks = new Uint8Array([~1, ~2, ~4, ~8, ~16, ~32, ~64, ~128]);</p>
<p>// This is the constructor function for our subclass function Span(start, span) { if (span &gt;= 0) { this.from = start; this.to = start + span; } else { this.to = start; this.from = start + span; } }</p>
<p>// Ensure that the Span prototype inherits from the Range prototype Span.prototype = Object.create(Range.prototype);</p>
<p>// We don’t want to inherit Range.prototype.constructor, so we // define our own constructor property. Span.prototype.constructor = Span;</p>
<p>// By defining its own toString() method, Span overrides the // toString() method that it would otherwise inherit from Range. Span.prototype.toString = function () { return <code>(${this.from}... +${this.to - this.from})</code>; };</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb26-1" title="1"></a>
<a class="sourceLine" id="cb26-2" title="2"></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="op">---</span></a>
<a class="sourceLine" id="cb26-4" title="4"></a>
<a class="sourceLine" id="cb26-5" title="5"></a>
<a class="sourceLine" id="cb26-6" title="6"><span class="co">/*</span></a>
<a class="sourceLine" id="cb26-7" title="7"><span class="co"> TOC.js: create a table of contents for a document.</span></a>
<a class="sourceLine" id="cb26-8" title="8"><span class="co"> *</span></a>
<a class="sourceLine" id="cb26-9" title="9"><span class="co"> * This script runs when the DOMContentLoaded event is fired and</span></a>
<a class="sourceLine" id="cb26-10" title="10"><span class="co"> * automatically generates a table of contents for the document.</span></a>
<a class="sourceLine" id="cb26-11" title="11"><span class="co"> * It does not define any global symbols so it should not conflict</span></a>
<a class="sourceLine" id="cb26-12" title="12"><span class="co"> * with other scripts.</span></a>
<a class="sourceLine" id="cb26-13" title="13"><span class="co"> *</span></a>
<a class="sourceLine" id="cb26-14" title="14"><span class="co"> * When this script runs, it first looks for a document element with</span></a>
<a class="sourceLine" id="cb26-15" title="15"><span class="co"> * an id of &quot;TOC&quot;. If there is no such element it creates one at the</span></a>
<a class="sourceLine" id="cb26-16" title="16"><span class="co"> * start of the document. Next, the function finds all &lt;h2&gt; through</span></a>
<a class="sourceLine" id="cb26-17" title="17"><span class="co"> * &lt;h6&gt; tags, treats them as section titles, and creates a table of</span></a>
<a class="sourceLine" id="cb26-18" title="18"><span class="co"> * contents within the TOC element. The function adds section numbers</span></a>
<a class="sourceLine" id="cb26-19" title="19"><span class="co"> * to each section heading and wraps the headings in named anchors so</span></a>
<a class="sourceLine" id="cb26-20" title="20"><span class="co"> * that the TOC can link to them. The generated anchors have names</span></a>
<a class="sourceLine" id="cb26-21" title="21"><span class="co"> * that begin with &quot;TOC&quot;, so you should avoid this prefix in your own</span></a>
<a class="sourceLine" id="cb26-22" title="22"><span class="co"> * HTML.</span></a>
<a class="sourceLine" id="cb26-23" title="23"><span class="co"> *</span></a>
<a class="sourceLine" id="cb26-24" title="24"><span class="co"> * The entries in the generated TOC can be styled with CSS. All</span></a>
<a class="sourceLine" id="cb26-25" title="25"><span class="co"> * entries have a class &quot;TOCEntry&quot;. Entries also have a class that</span></a>
<a class="sourceLine" id="cb26-26" title="26"><span class="co"> * corresponds to the level of the section heading. &lt;h1&gt; tags generate</span></a>
<a class="sourceLine" id="cb26-27" title="27"><span class="co"> * entries of class &quot;TOCLevel1&quot;, &lt;h2&gt; tags generate entries of class</span></a>
<a class="sourceLine" id="cb26-28" title="28"><span class="co"> * &quot;TOCLevel2&quot;, and so on. Section numbers inserted into headings have</span></a>
<a class="sourceLine" id="cb26-29" title="29"><span class="co"> * class &quot;TOCSectNum&quot;.</span></a>
<a class="sourceLine" id="cb26-30" title="30"><span class="co"> *</span></a>
<a class="sourceLine" id="cb26-31" title="31"><span class="co"> * You might use this script with a stylesheet like this:</span></a>
<a class="sourceLine" id="cb26-32" title="32"><span class="co"> *</span></a>
<a class="sourceLine" id="cb26-33" title="33"><span class="co"> *   #TOC { border: solid black 1px; margin: 10px; padding: 10px; }</span></a>
<a class="sourceLine" id="cb26-34" title="34"><span class="co"> *   .TOCEntry { margin: 5px 0px; }</span></a>
<a class="sourceLine" id="cb26-35" title="35"><span class="co"> *   .TOCEntry a { text-decoration: none; }</span></a>
<a class="sourceLine" id="cb26-36" title="36"><span class="co"> *   .TOCLevel1 { font-size: 16pt; font-weight: bold; }</span></a>
<a class="sourceLine" id="cb26-37" title="37"><span class="co"> *   .TOCLevel2 { font-size: 14pt; margin-left: .25in; }</span></a>
<a class="sourceLine" id="cb26-38" title="38"><span class="co"> *   .TOCLevel3 { font-size: 12pt; margin-left: .5in; }</span></a>
<a class="sourceLine" id="cb26-39" title="39"><span class="co"> *   .TOCSectNum:after { content: &quot;: &quot;; }</span></a>
<a class="sourceLine" id="cb26-40" title="40"><span class="co"> *</span></a>
<a class="sourceLine" id="cb26-41" title="41"><span class="co"> * To hide the section numbers, use this:</span></a>
<a class="sourceLine" id="cb26-42" title="42"><span class="co"> *</span></a>
<a class="sourceLine" id="cb26-43" title="43"><span class="co"> *   .TOCSectNum { display: none }</span></a>
<a class="sourceLine" id="cb26-44" title="44"><span class="co"> **/</span></a>
<a class="sourceLine" id="cb26-45" title="45"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb26-46" title="46">  <span class="co">// Find the TOC container element.</span></a>
<a class="sourceLine" id="cb26-47" title="47">  <span class="co">// If there isn&#39;t one, create one at the start of the document.</span></a>
<a class="sourceLine" id="cb26-48" title="48">  <span class="kw">let</span> toc <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#TOC&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-49" title="49">  <span class="cf">if</span> (<span class="op">!</span>toc) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-50" title="50">    toc <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-51" title="51">    <span class="va">toc</span>.<span class="at">id</span> <span class="op">=</span> <span class="st">&quot;TOC&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-52" title="52">    <span class="va">document</span>.<span class="va">body</span>.<span class="at">prepend</span>(toc)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-53" title="53">  <span class="op">}</span></a>
<a class="sourceLine" id="cb26-54" title="54"></a>
<a class="sourceLine" id="cb26-55" title="55">  <span class="co">// Find all section heading elements. We&#39;re assuming here that the</span></a>
<a class="sourceLine" id="cb26-56" title="56">  <span class="co">// document title uses &lt;h1&gt; and that sections within the document are</span></a>
<a class="sourceLine" id="cb26-57" title="57">  <span class="co">// marked with &lt;h2&gt; through &lt;h6&gt;.</span></a>
<a class="sourceLine" id="cb26-58" title="58">  <span class="kw">let</span> headings <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&quot;h2,h3,h4,h5,h6&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-59" title="59"></a>
<a class="sourceLine" id="cb26-60" title="60">  <span class="co">// Initialize an array that keeps track of section numbers.</span></a>
<a class="sourceLine" id="cb26-61" title="61">  <span class="kw">let</span> sectionNumbers <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb26-62" title="62"></a>
<a class="sourceLine" id="cb26-63" title="63">  <span class="co">// Now loop through the section header elements we found.</span></a>
<a class="sourceLine" id="cb26-64" title="64">  <span class="cf">for</span> (<span class="kw">let</span> heading <span class="kw">of</span> headings) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-65" title="65">    <span class="co">// Skip the heading if it is inside the TOC container.</span></a>
<a class="sourceLine" id="cb26-66" title="66">    <span class="cf">if</span> (<span class="va">heading</span>.<span class="at">parentNode</span> <span class="op">===</span> toc) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-67" title="67">      <span class="cf">continue</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-68" title="68">    <span class="op">}</span></a>
<a class="sourceLine" id="cb26-69" title="69"></a>
<a class="sourceLine" id="cb26-70" title="70">    <span class="co">// Figure out what level heading it is.</span></a>
<a class="sourceLine" id="cb26-71" title="71">    <span class="co">// Subtract 1 because &lt;h2&gt; is a level-1 heading.</span></a>
<a class="sourceLine" id="cb26-72" title="72">    <span class="kw">let</span> level <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">heading</span>.<span class="va">tagName</span>.<span class="at">charAt</span>(<span class="dv">1</span>)) <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-73" title="73"></a>
<a class="sourceLine" id="cb26-74" title="74">    <span class="co">// Increment the section number for this heading level</span></a>
<a class="sourceLine" id="cb26-75" title="75">    <span class="co">// and reset all lower heading level numbers to zero.</span></a>
<a class="sourceLine" id="cb26-76" title="76">    sectionNumbers[level <span class="op">-</span> <span class="dv">1</span>]<span class="op">++;</span></a>
<a class="sourceLine" id="cb26-77" title="77">    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> level<span class="op">;</span> i <span class="op">&lt;</span> <span class="va">sectionNumbers</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-78" title="78">      sectionNumbers[i] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-79" title="79">    <span class="op">}</span></a>
<a class="sourceLine" id="cb26-80" title="80"></a>
<a class="sourceLine" id="cb26-81" title="81">    <span class="co">// Now combine section numbers for all heading levels</span></a>
<a class="sourceLine" id="cb26-82" title="82">    <span class="co">// to produce a section number like 2.3.1.</span></a>
<a class="sourceLine" id="cb26-83" title="83">    <span class="kw">let</span> sectionNumber <span class="op">=</span> <span class="va">sectionNumbers</span>.<span class="at">slice</span>(<span class="dv">0</span><span class="op">,</span> level).<span class="at">join</span>(<span class="st">&quot;.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-84" title="84"></a>
<a class="sourceLine" id="cb26-85" title="85">    <span class="co">// Add the section number to the section header title.</span></a>
<a class="sourceLine" id="cb26-86" title="86">    <span class="co">// We place the number in a &lt;span&gt; to make it styleable.</span></a>
<a class="sourceLine" id="cb26-87" title="87">    <span class="kw">let</span> span <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;span&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-88" title="88">    <span class="va">span</span>.<span class="at">className</span> <span class="op">=</span> <span class="st">&quot;TOCSectNum&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-89" title="89">    <span class="va">span</span>.<span class="at">textContent</span> <span class="op">=</span> sectionNumber<span class="op">;</span></a>
<a class="sourceLine" id="cb26-90" title="90">    <span class="va">heading</span>.<span class="at">prepend</span>(span)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-91" title="91"></a>
<a class="sourceLine" id="cb26-92" title="92">    <span class="co">// Wrap the heading in a named anchor so we can link to it.</span></a>
<a class="sourceLine" id="cb26-93" title="93">    <span class="kw">let</span> anchor <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-94" title="94">    <span class="kw">let</span> fragmentName <span class="op">=</span> <span class="vs">`TOC</span><span class="sc">${</span>sectionNumber<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-95" title="95">    <span class="va">anchor</span>.<span class="at">name</span> <span class="op">=</span> fragmentName<span class="op">;</span></a>
<a class="sourceLine" id="cb26-96" title="96">    <span class="va">heading</span>.<span class="at">before</span>(anchor)<span class="op">;</span> <span class="co">// Insert anchor before heading</span></a>
<a class="sourceLine" id="cb26-97" title="97">    <span class="va">anchor</span>.<span class="at">append</span>(heading)<span class="op">;</span> <span class="co">// and move heading inside anchor</span></a>
<a class="sourceLine" id="cb26-98" title="98"></a>
<a class="sourceLine" id="cb26-99" title="99">    <span class="co">// Now create a link to this section.</span></a>
<a class="sourceLine" id="cb26-100" title="100">    <span class="kw">let</span> link <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;a&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-101" title="101">    <span class="va">link</span>.<span class="at">href</span> <span class="op">=</span> <span class="vs">`#</span><span class="sc">${</span>fragmentName<span class="sc">}</span><span class="vs">`</span><span class="op">;</span> <span class="co">// Link destination</span></a>
<a class="sourceLine" id="cb26-102" title="102"></a>
<a class="sourceLine" id="cb26-103" title="103">    <span class="co">// Copy the heading text into the link. This is a safe use of</span></a>
<a class="sourceLine" id="cb26-104" title="104">    <span class="co">// innerHTML because we are not inserting any untrusted strings.</span></a>
<a class="sourceLine" id="cb26-105" title="105">    <span class="va">link</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">heading</span>.<span class="at">innerHTML</span><span class="op">;</span></a>
<a class="sourceLine" id="cb26-106" title="106"></a>
<a class="sourceLine" id="cb26-107" title="107">    <span class="co">// Place the link in a div that is styleable based on the level.</span></a>
<a class="sourceLine" id="cb26-108" title="108">    <span class="kw">let</span> entry <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;div&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-109" title="109">    <span class="va">entry</span>.<span class="va">classList</span>.<span class="at">add</span>(<span class="st">&quot;TOCEntry&quot;</span><span class="op">,</span> <span class="vs">`TOCLevel</span><span class="sc">${</span>level<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-110" title="110">    <span class="va">entry</span>.<span class="at">append</span>(link)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-111" title="111"></a>
<a class="sourceLine" id="cb26-112" title="112">    <span class="co">// And add the div to the TOC container.</span></a>
<a class="sourceLine" id="cb26-113" title="113">    <span class="va">toc</span>.<span class="at">append</span>(entry)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-114" title="114">  <span class="op">}</span></a>
<a class="sourceLine" id="cb26-115" title="115"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-116" title="116"></a>
<a class="sourceLine" id="cb26-117" title="117"><span class="kw">class</span> TypedMap <span class="kw">extends</span> Map <span class="op">{</span></a>
<a class="sourceLine" id="cb26-118" title="118">  <span class="at">constructor</span>(keyType<span class="op">,</span> valueType<span class="op">,</span> entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-119" title="119">    <span class="co">// If entries are specified, check their types</span></a>
<a class="sourceLine" id="cb26-120" title="120">    <span class="cf">if</span> (entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-121" title="121">      <span class="cf">for</span> (<span class="kw">let</span> [k<span class="op">,</span> v] <span class="kw">of</span> entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-122" title="122">        <span class="cf">if</span> (<span class="kw">typeof</span> k <span class="op">!==</span> keyType <span class="op">||</span> <span class="kw">typeof</span> v <span class="op">!==</span> valueType) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-123" title="123">          <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`Wrong type for entry [</span><span class="sc">${</span>k<span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>v<span class="sc">}</span><span class="vs">]`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-124" title="124">        <span class="op">}</span></a>
<a class="sourceLine" id="cb26-125" title="125">      <span class="op">}</span></a>
<a class="sourceLine" id="cb26-126" title="126">    <span class="op">}</span></a>
<a class="sourceLine" id="cb26-127" title="127"></a>
<a class="sourceLine" id="cb26-128" title="128">    <span class="co">// Initialize the superclass with the (type-checked) initial entries</span></a>
<a class="sourceLine" id="cb26-129" title="129">    <span class="kw">super</span>(entries)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-130" title="130"></a>
<a class="sourceLine" id="cb26-131" title="131">    <span class="co">// And then initialize this subclass by storing the types</span></a>
<a class="sourceLine" id="cb26-132" title="132">    <span class="kw">this</span>.<span class="at">keyType</span> <span class="op">=</span> keyType<span class="op">;</span></a>
<a class="sourceLine" id="cb26-133" title="133">    <span class="kw">this</span>.<span class="at">valueType</span> <span class="op">=</span> valueType<span class="op">;</span></a>
<a class="sourceLine" id="cb26-134" title="134">  <span class="op">}</span></a>
<a class="sourceLine" id="cb26-135" title="135"></a>
<a class="sourceLine" id="cb26-136" title="136">  <span class="co">// Now redefine the set() method to add type checking for any</span></a>
<a class="sourceLine" id="cb26-137" title="137">  <span class="co">// new entries added to the map.</span></a>
<a class="sourceLine" id="cb26-138" title="138">  <span class="at">set</span>(key<span class="op">,</span> value) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-139" title="139">    <span class="co">// Throw an error if the key or value are of the wrong type</span></a>
<a class="sourceLine" id="cb26-140" title="140">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">keyType</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> key <span class="op">!==</span> <span class="kw">this</span>.<span class="at">keyType</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-141" title="141">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs"> is not of type </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">keyType</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-142" title="142">    <span class="op">}</span></a>
<a class="sourceLine" id="cb26-143" title="143">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">valueType</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> value <span class="op">!==</span> <span class="kw">this</span>.<span class="at">valueType</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-144" title="144">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs"> is not of type </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">valueType</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-145" title="145">    <span class="op">}</span></a>
<a class="sourceLine" id="cb26-146" title="146"></a>
<a class="sourceLine" id="cb26-147" title="147">    <span class="co">// If the types are correct, we invoke the superclass&#39;s version of</span></a>
<a class="sourceLine" id="cb26-148" title="148">    <span class="co">// the set() method, to actually add the entry to the map. And we</span></a>
<a class="sourceLine" id="cb26-149" title="149">    <span class="co">// return whatever the superclass method returns.</span></a>
<a class="sourceLine" id="cb26-150" title="150">    <span class="cf">return</span> <span class="kw">super</span>.<span class="at">set</span>(key<span class="op">,</span> value)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-151" title="151">  <span class="op">}</span></a>
<a class="sourceLine" id="cb26-152" title="152"><span class="op">}</span></a>
<a class="sourceLine" id="cb26-153" title="153"></a>
<a class="sourceLine" id="cb26-154" title="154"><span class="co">// This function adds property accessor methods for a property with</span></a>
<a class="sourceLine" id="cb26-155" title="155"><span class="co">// the specified name to the object o. The methods are named get&lt;name&gt;</span></a>
<a class="sourceLine" id="cb26-156" title="156"><span class="co">// and set&lt;name&gt;. If a predicate function is supplied, the setter</span></a>
<a class="sourceLine" id="cb26-157" title="157"><span class="co">// method uses it to test its argument for validity before storing it.</span></a>
<a class="sourceLine" id="cb26-158" title="158"><span class="co">// If the predicate returns false, the setter method throws an exception.</span></a>
<a class="sourceLine" id="cb26-159" title="159"><span class="co">//</span></a>
<a class="sourceLine" id="cb26-160" title="160"><span class="co">// The unusual thing about this function is that the property value</span></a>
<a class="sourceLine" id="cb26-161" title="161"><span class="co">// that is manipulated by the getter and setter methods is not stored in</span></a>
<a class="sourceLine" id="cb26-162" title="162"><span class="co">// the object o. Instead, the value is stored only in a local variable</span></a>
<a class="sourceLine" id="cb26-163" title="163"><span class="co">// in this function. The getter and setter methods are also defined</span></a>
<a class="sourceLine" id="cb26-164" title="164"><span class="co">// locally to this function and therefore have access to this local variable.</span></a>
<a class="sourceLine" id="cb26-165" title="165"><span class="co">// This means that the value is private to the two accessor methods, and it</span></a>
<a class="sourceLine" id="cb26-166" title="166"><span class="co">// cannot be set or modified except through the setter method.</span></a>
<a class="sourceLine" id="cb26-167" title="167"><span class="kw">function</span> <span class="at">addPrivateProperty</span>(o<span class="op">,</span> name<span class="op">,</span> predicate) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-168" title="168">  <span class="kw">let</span> value<span class="op">;</span> <span class="co">// This is the property value</span></a>
<a class="sourceLine" id="cb26-169" title="169"></a>
<a class="sourceLine" id="cb26-170" title="170">  <span class="co">// The getter method simply returns the value.</span></a>
<a class="sourceLine" id="cb26-171" title="171">  o[<span class="vs">`get</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>] <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb26-172" title="172">    <span class="cf">return</span> value<span class="op">;</span></a>
<a class="sourceLine" id="cb26-173" title="173">  <span class="op">};</span></a>
<a class="sourceLine" id="cb26-174" title="174"></a>
<a class="sourceLine" id="cb26-175" title="175">  <span class="co">// The setter method stores the value or throws an exception if</span></a>
<a class="sourceLine" id="cb26-176" title="176">  <span class="co">// the predicate rejects the value.</span></a>
<a class="sourceLine" id="cb26-177" title="177">  o[<span class="vs">`set</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>] <span class="op">=</span> (v) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb26-178" title="178">    <span class="cf">if</span> (predicate <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="at">predicate</span>(v)) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-179" title="179">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`set</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">: invalid value </span><span class="sc">${</span>v<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-180" title="180">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb26-181" title="181">      value <span class="op">=</span> v<span class="op">;</span></a>
<a class="sourceLine" id="cb26-182" title="182">    <span class="op">}</span></a>
<a class="sourceLine" id="cb26-183" title="183">  <span class="op">};</span></a>
<a class="sourceLine" id="cb26-184" title="184"><span class="op">}</span></a>
<a class="sourceLine" id="cb26-185" title="185"></a>
<a class="sourceLine" id="cb26-186" title="186"><span class="co">// The following code demonstrates the addPrivateProperty() method.</span></a>
<a class="sourceLine" id="cb26-187" title="187"><span class="kw">let</span> o <span class="op">=</span> <span class="op">{};</span> <span class="co">// Here is an empty object</span></a>
<a class="sourceLine" id="cb26-188" title="188"></a>
<a class="sourceLine" id="cb26-189" title="189"><span class="co">// Add property accessor methods getName and setName()</span></a>
<a class="sourceLine" id="cb26-190" title="190"><span class="co">// Ensure that only string values are allowed</span></a>
<a class="sourceLine" id="cb26-191" title="191"><span class="at">addPrivateProperty</span>(o<span class="op">,</span> <span class="st">&quot;Name&quot;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> <span class="kw">typeof</span> x <span class="op">===</span> <span class="st">&quot;string&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-192" title="192"></a>
<a class="sourceLine" id="cb26-193" title="193"><span class="va">o</span>.<span class="at">setName</span>(<span class="st">&quot;Frank&quot;</span>)<span class="op">;</span> <span class="co">// Set the property value</span></a>
<a class="sourceLine" id="cb26-194" title="194"><span class="va">o</span>.<span class="at">getName</span>()<span class="op">;</span> <span class="co">// =&gt; &quot;Frank&quot;</span></a>
<a class="sourceLine" id="cb26-195" title="195"><span class="va">o</span>.<span class="at">setName</span>(<span class="dv">0</span>)<span class="op">;</span> <span class="co">// !TypeError: try to set a value of the wrong type</span></a>
<a class="sourceLine" id="cb26-196" title="196"></a>
<a class="sourceLine" id="cb26-197" title="197"><span class="kw">function</span> <span class="at">arraycopy</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb26-198" title="198">  <span class="im">from</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-199" title="199">  to <span class="op">=</span> <span class="im">from</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-200" title="200">  n <span class="op">=</span> <span class="im">from</span>.<span class="at">length</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-201" title="201">  fromIndex <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-202" title="202">  toIndex <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb26-203" title="203"><span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb26-204" title="204">  <span class="kw">let</span> valuesToCopy <span class="op">=</span> <span class="im">from</span>.<span class="at">slice</span>(fromIndex<span class="op">,</span> fromIndex <span class="op">+</span> n)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-205" title="205">  <span class="va">to</span>.<span class="at">splice</span>(toIndex<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> ...<span class="at">valuesToCopy</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-206" title="206">  <span class="cf">return</span> to<span class="op">;</span></a>
<a class="sourceLine" id="cb26-207" title="207"><span class="op">}</span></a>
<a class="sourceLine" id="cb26-208" title="208"><span class="kw">let</span> a <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb26-209" title="209"><span class="kw">let</span> b <span class="op">=</span> [<span class="dv">9</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb26-210" title="210"><span class="at">arraycopy</span>(<span class="op">{</span> <span class="dt">from</span><span class="op">:</span> a<span class="op">,</span> <span class="dt">n</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">to</span><span class="op">:</span> b<span class="op">,</span> <span class="dt">toIndex</span><span class="op">:</span> <span class="dv">4</span> <span class="op">}</span>)<span class="op">;</span> <span class="co">// =&gt; [9,8,7,6,1,2,3,5]</span></a></code></pre></div>
<hr />
<p>/<em> </em> Define a new Object.assignDescriptors() function that works like * Object.assign() except that it copies property descriptors from * source objects into the target object instead of just copying * property values. This function copies all own properties, both * enumerable and non-enumerable. And because it copies descriptors, * it copies getter functions from source objects and overwrites setter * functions in the target object rather than invoking those getters and * setters. <em> </em> Object.assignDescriptors() propagates any TypeErrors thrown by * Object.defineProperty(). This can occur if the target object is sealed * or frozen or if any of the source properties try to change an existing * non-configurable property on the target object. <em> </em> Note that the assignDescriptors property is added to Object with * Object.defineProperty() so that the new function can be created as * a non-enumerable property like Object.assign(). */</p>
<hr />
<p>```js Object.defineProperty(Object, “assignDescriptors”, { // Match the attributes of Object.assign() writable: true, enumerable: false, configurable: true, // The function that is the value of the assignDescriptors property. value(target, …sources) { for (let source of sources) { for (let name of Object.getOwnPropertyNames(source)) { let desc = Object.getOwnPropertyDescriptor(source, name); Object.defineProperty(target, name, desc); }</p>
<pre><code>  for (let symbol of Object.getOwnPropertySymbols(source)) {
    let desc = Object.getOwnPropertyDescriptor(source, symbol);
    Object.defineProperty(target, symbol, desc);
  }
}
return target;</code></pre>
<p>}, });</p>
<p>// Read lines of text from the source stream, and write any lines // that match the specified pattern to the destination stream. async function grep(source, destination, pattern, encoding = “utf8”) { // Set up the source stream for reading strings, not Buffers source.setEncoding(encoding);</p>
<p>// Set an error handler on the destination stream in case standard // output closes unexpectedly (when piping output to <code>head</code>, e.g.) destination.on(“error”, (err) =&gt; process.exit());</p>
<p>// The chunks we read are unlikely to end with a newline, so each will // probably have a partial line at the end. Track that here let incompleteLine = "";</p>
<p>// Use a for/await loop to asynchronously read chunks from the input stream for await (let chunk of source) { // Split the end of the last chunk plus this one into lines let lines = (incompleteLine + chunk).split(“”); // The last line is incomplete incompleteLine = lines.pop(); // Now loop through the lines and write any matches to the destination for (let line of lines) { if (pattern.test(line)) { destination.write(<code>${line}\n</code>, encoding); } } } // Finally, check for a match on any trailing text. if (pattern.test(incompleteLine)) { destination.write(<code>${incompleteLine}\n</code>, encoding); } }</p>
<p>let pattern = new RegExp(process.argv[2]); // Get a RegExp from command line. grep(process.stdin, process.stdout, pattern) // Call the async grep() function. .catch((err) =&gt; { // Handle asynchronous exceptions. console.error(err); process.exit(); });</p>
<p>const threads = require(“worker_threads”);</p>
<p>if (threads.isMainThread) { let sharedBuffer = new SharedArrayBuffer(4); let sharedArray = new Int32Array(sharedBuffer); let worker = new threads.Worker(__filename, { workerData: sharedArray });</p>
<p>worker.on(“online”, () =&gt; { for (let i = 0; i &lt; 10_000_000; i++) { Atomics.add(sharedArray, 0, 1); // Threadsafe atomic increment }</p>
<pre><code>worker.on(&quot;message&quot;, (message) =&gt; {
  // When both threads are done, use a threadsafe function
  // to read the shared array and confirm that it has the
  // expected value of 20,000,000.
  console.log(Atomics.load(sharedArray, 0));
});</code></pre>
<p>}); } else { let sharedArray = threads.workerData; for (let i = 0; i &lt; 10_000_000; i++) { Atomics.add(sharedArray, 0, 1); // Threadsafe atomic increment } threads.parentPort.postMessage(“done”); }</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> This Node program reads text from standard input, computes the frequency </em> of each letter in that text, and displays a histogram of the most * frequently used characters. It requires Node 12 or higher to run. <em> </em> In a Unix-type environment you can invoke the program like this: * node charfreq.js &lt; corpus.txt */</p>
<hr />
<div class="sourceCode" id="cb29"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb29-1" title="1"></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="co">// This class extends Map so that the get() method returns the specified</span></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="co">// value instead of null when the key is not in the map</span></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="kw">class</span> DefaultMap <span class="kw">extends</span> Map <span class="op">{</span></a>
<a class="sourceLine" id="cb29-5" title="5">  <span class="at">constructor</span>(defaultValue) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-6" title="6">    <span class="kw">super</span>()<span class="op">;</span> <span class="co">// Invoke superclass constructor</span></a>
<a class="sourceLine" id="cb29-7" title="7">    <span class="kw">this</span>.<span class="at">defaultValue</span> <span class="op">=</span> defaultValue<span class="op">;</span> <span class="co">// Remember the default value</span></a>
<a class="sourceLine" id="cb29-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-9" title="9"></a>
<a class="sourceLine" id="cb29-10" title="10">  <span class="at">get</span>(key) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-11" title="11">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">has</span>(key)) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-12" title="12">      <span class="co">// If the key is already in the map</span></a>
<a class="sourceLine" id="cb29-13" title="13">      <span class="cf">return</span> <span class="kw">super</span>.<span class="at">get</span>(key)<span class="op">;</span> <span class="co">// return its value from superclass.</span></a>
<a class="sourceLine" id="cb29-14" title="14">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-15" title="15">      <span class="cf">return</span> <span class="kw">this</span>.<span class="at">defaultValue</span><span class="op">;</span> <span class="co">// Otherwise return the default value</span></a>
<a class="sourceLine" id="cb29-16" title="16">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-17" title="17">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-18" title="18"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-19" title="19"></a>
<a class="sourceLine" id="cb29-20" title="20"><span class="co">// This class computes and displays letter frequency histograms</span></a>
<a class="sourceLine" id="cb29-21" title="21"><span class="kw">class</span> Histogram <span class="op">{</span></a>
<a class="sourceLine" id="cb29-22" title="22">  <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-23" title="23">    <span class="kw">this</span>.<span class="at">letterCounts</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">DefaultMap</span>(<span class="dv">0</span>)<span class="op">;</span> <span class="co">// Map from letters to counts</span></a>
<a class="sourceLine" id="cb29-24" title="24">    <span class="kw">this</span>.<span class="at">totalLetters</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// How many letters in all</span></a>
<a class="sourceLine" id="cb29-25" title="25">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-26" title="26"></a>
<a class="sourceLine" id="cb29-27" title="27">  <span class="co">// This function updates the histogram with the letters of text.</span></a>
<a class="sourceLine" id="cb29-28" title="28">  <span class="at">add</span>(text) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-29" title="29">    <span class="co">// Remove whitespace from the text, and convert to upper case</span></a>
<a class="sourceLine" id="cb29-30" title="30">    text <span class="op">=</span> <span class="va">text</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\s</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&quot;&quot;</span>).<span class="at">toUpperCase</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-31" title="31"></a>
<a class="sourceLine" id="cb29-32" title="32">    <span class="co">// Now loop through the characters of the text</span></a>
<a class="sourceLine" id="cb29-33" title="33">    <span class="cf">for</span> (<span class="kw">let</span> character <span class="kw">of</span> text) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-34" title="34">      <span class="kw">let</span> count <span class="op">=</span> <span class="kw">this</span>.<span class="va">letterCounts</span>.<span class="at">get</span>(character)<span class="op">;</span> <span class="co">// Get old count</span></a>
<a class="sourceLine" id="cb29-35" title="35">      <span class="kw">this</span>.<span class="va">letterCounts</span>.<span class="at">set</span>(character<span class="op">,</span> count <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Increment it</span></a>
<a class="sourceLine" id="cb29-36" title="36">      <span class="kw">this</span>.<span class="at">totalLetters</span><span class="op">++;</span></a>
<a class="sourceLine" id="cb29-37" title="37">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-38" title="38">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-39" title="39"></a>
<a class="sourceLine" id="cb29-40" title="40">  <span class="co">// Convert the histogram to a string that displays an ASCII graphic</span></a>
<a class="sourceLine" id="cb29-41" title="41">  <span class="at">toString</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-42" title="42">    <span class="co">// Convert the Map to an array of [key,value] arrays</span></a>
<a class="sourceLine" id="cb29-43" title="43">    <span class="kw">let</span> entries <span class="op">=</span> [...<span class="va">this</span>.<span class="at">letterCounts</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-44" title="44"></a>
<a class="sourceLine" id="cb29-45" title="45">    <span class="co">// Sort the array by count, then alphabetically</span></a>
<a class="sourceLine" id="cb29-46" title="46">    <span class="va">entries</span>.<span class="at">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-47" title="47">      <span class="co">// A function to define sort order.</span></a>
<a class="sourceLine" id="cb29-48" title="48">      <span class="cf">if</span> (a[<span class="dv">1</span>] <span class="op">===</span> b[<span class="dv">1</span>]) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-49" title="49">        <span class="co">// If the counts are the same</span></a>
<a class="sourceLine" id="cb29-50" title="50">        <span class="cf">return</span> a[<span class="dv">0</span>] <span class="op">&lt;</span> b[<span class="dv">0</span>] <span class="op">?</span> <span class="dv">-1</span> : <span class="dv">1</span><span class="op">;</span> <span class="co">// sort alphabetically.</span></a>
<a class="sourceLine" id="cb29-51" title="51">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-52" title="52">        <span class="co">// If the counts differ</span></a>
<a class="sourceLine" id="cb29-53" title="53">        <span class="cf">return</span> b[<span class="dv">1</span>] <span class="op">-</span> a[<span class="dv">1</span>]<span class="op">;</span> <span class="co">// sort by largest count.</span></a>
<a class="sourceLine" id="cb29-54" title="54">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-55" title="55">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-56" title="56"></a>
<a class="sourceLine" id="cb29-57" title="57">    <span class="co">// Convert the counts to percentages</span></a>
<a class="sourceLine" id="cb29-58" title="58">    <span class="cf">for</span> (<span class="kw">let</span> entry <span class="kw">of</span> entries) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-59" title="59">      entry[<span class="dv">1</span>] <span class="op">=</span> (entry[<span class="dv">1</span>] / <span class="kw">this</span>.<span class="at">totalLetters</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-60" title="60">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-61" title="61"></a>
<a class="sourceLine" id="cb29-62" title="62">    <span class="co">// Drop any entries less than 1%</span></a>
<a class="sourceLine" id="cb29-63" title="63">    entries <span class="op">=</span> <span class="va">entries</span>.<span class="at">filter</span>((entry) <span class="kw">=&gt;</span> entry[<span class="dv">1</span>] <span class="op">&gt;=</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-64" title="64"></a>
<a class="sourceLine" id="cb29-65" title="65">    <span class="co">// Now convert each entry to a line of text</span></a>
<a class="sourceLine" id="cb29-66" title="66">    <span class="kw">let</span> lines <span class="op">=</span> <span class="va">entries</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb29-67" title="67">      ([l<span class="op">,</span> n]) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>l<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span><span class="st">&quot;#&quot;</span>.<span class="at">repeat</span>(<span class="va">Math</span>.<span class="at">round</span>(n))<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span><span class="va">n</span>.<span class="at">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">%`</span></a>
<a class="sourceLine" id="cb29-68" title="68">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb29-69" title="69"></a>
<a class="sourceLine" id="cb29-70" title="70">    <span class="co">// And return the concatenated lines, separated by newline characters.</span></a>
<a class="sourceLine" id="cb29-71" title="71">    <span class="cf">return</span> <span class="va">lines</span>.<span class="at">join</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-72" title="72">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-73" title="73"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-74" title="74"></a>
<a class="sourceLine" id="cb29-75" title="75"><span class="co">// This async (Promise-returning) function creates a Histogram object,</span></a>
<a class="sourceLine" id="cb29-76" title="76"><span class="co">// asynchronously reads chunks of text from standard input, and adds those chunks to</span></a>
<a class="sourceLine" id="cb29-77" title="77"><span class="co">// the histogram. When it reaches the end of the stream, it returns this histogram</span></a>
<a class="sourceLine" id="cb29-78" title="78"><span class="kw">async</span> <span class="kw">function</span> <span class="at">histogramFromStdin</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-79" title="79">  <span class="va">process</span>.<span class="va">stdin</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf-8&quot;</span>)<span class="op">;</span> <span class="co">// Read Unicode strings, not bytes</span></a>
<a class="sourceLine" id="cb29-80" title="80">  <span class="kw">let</span> histogram <span class="op">=</span> <span class="kw">new</span> <span class="at">Histogram</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-81" title="81">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> <span class="va">process</span>.<span class="at">stdin</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-82" title="82">    <span class="va">histogram</span>.<span class="at">add</span>(chunk)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-83" title="83">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-84" title="84">  <span class="cf">return</span> histogram<span class="op">;</span></a>
<a class="sourceLine" id="cb29-85" title="85"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-86" title="86"></a>
<a class="sourceLine" id="cb29-87" title="87"><span class="co">// This one final line of code is the main body of the program.</span></a>
<a class="sourceLine" id="cb29-88" title="88"><span class="co">// It makes a Histogram object from standard input, then prints the histogram.</span></a>
<a class="sourceLine" id="cb29-89" title="89"><span class="at">histogramFromStdin</span>().<span class="at">then</span>((histogram) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-90" title="90">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">histogram</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb29-91" title="91"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-92" title="92"></a>
<a class="sourceLine" id="cb29-93" title="93"><span class="co">// This is server-side JavaScript, intended to be run with NodeJS.</span></a>
<a class="sourceLine" id="cb29-94" title="94"><span class="co">// It implements a very simple, completely anonymous chat room.</span></a>
<a class="sourceLine" id="cb29-95" title="95"><span class="co">// POST new messages to /chat, or GET a text/event-stream of messages</span></a>
<a class="sourceLine" id="cb29-96" title="96"><span class="co">// from the same URL. Making a GET request to / returns a simple HTML file</span></a>
<a class="sourceLine" id="cb29-97" title="97"><span class="co">// that contains the client-side chat UI.</span></a>
<a class="sourceLine" id="cb29-98" title="98"><span class="kw">const</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;http&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-99" title="99"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-100" title="100"><span class="kw">const</span> url <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;url&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-101" title="101"></a>
<a class="sourceLine" id="cb29-102" title="102"><span class="co">// The HTML file for the chat client. Used below.</span></a>
<a class="sourceLine" id="cb29-103" title="103"><span class="kw">const</span> clientHTML <span class="op">=</span> <span class="va">fs</span>.<span class="at">readFileSync</span>(<span class="st">&quot;chatClient.html&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-104" title="104"></a>
<a class="sourceLine" id="cb29-105" title="105"><span class="co">// An array of ServerResponse objects that we&#39;re going to send events to</span></a>
<a class="sourceLine" id="cb29-106" title="106"><span class="kw">let</span> clients <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb29-107" title="107"></a>
<a class="sourceLine" id="cb29-108" title="108"><span class="co">// Create a new server, and listen on port 8080.</span></a>
<a class="sourceLine" id="cb29-109" title="109"><span class="co">// Connect to http://localhost:8080/ to use it.</span></a>
<a class="sourceLine" id="cb29-110" title="110"><span class="kw">let</span> server <span class="op">=</span> <span class="kw">new</span> <span class="va">http</span>.<span class="at">Server</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-111" title="111"><span class="va">server</span>.<span class="at">listen</span>(<span class="dv">8080</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-112" title="112"></a>
<a class="sourceLine" id="cb29-113" title="113"><span class="co">// When the server gets a new request, run this function</span></a>
<a class="sourceLine" id="cb29-114" title="114"><span class="va">server</span>.<span class="at">on</span>(<span class="st">&quot;request&quot;</span><span class="op">,</span> (request<span class="op">,</span> response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-115" title="115">  <span class="co">// Parse the requested URL</span></a>
<a class="sourceLine" id="cb29-116" title="116">  <span class="kw">let</span> pathname <span class="op">=</span> <span class="va">url</span>.<span class="at">parse</span>(<span class="va">request</span>.<span class="at">url</span>).<span class="at">pathname</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-117" title="117"></a>
<a class="sourceLine" id="cb29-118" title="118">  <span class="co">// If the request was for &quot;/&quot;, send the client-side chat UI.</span></a>
<a class="sourceLine" id="cb29-119" title="119">  <span class="cf">if</span> (pathname <span class="op">===</span> <span class="st">&quot;/&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-120" title="120">    <span class="co">// A request for the chat UI</span></a>
<a class="sourceLine" id="cb29-121" title="121">    <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span><span class="op">,</span> <span class="op">{</span> <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;text/html&quot;</span> <span class="op">}</span>).<span class="at">end</span>(clientHTML)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-122" title="122">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-123" title="123">  <span class="co">// Otherwise send a 404 error for any path other than &quot;/chat&quot; or for</span></a>
<a class="sourceLine" id="cb29-124" title="124">  <span class="co">// any method other than &quot;GET&quot; and &quot;POST&quot;</span></a>
<a class="sourceLine" id="cb29-125" title="125">  <span class="cf">else</span> <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb29-126" title="126">    pathname <span class="op">!==</span> <span class="st">&quot;/chat&quot;</span> <span class="op">||</span></a>
<a class="sourceLine" id="cb29-127" title="127">    (<span class="va">request</span>.<span class="at">method</span> <span class="op">!==</span> <span class="st">&quot;GET&quot;</span> <span class="op">&amp;&amp;</span> <span class="va">request</span>.<span class="at">method</span> <span class="op">!==</span> <span class="st">&quot;POST&quot;</span>)</a>
<a class="sourceLine" id="cb29-128" title="128">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-129" title="129">    <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">404</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-130" title="130">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-131" title="131">  <span class="co">// If the /chat request was a GET, then a client is connecting.</span></a>
<a class="sourceLine" id="cb29-132" title="132">  <span class="cf">else</span> <span class="cf">if</span> (<span class="va">request</span>.<span class="at">method</span> <span class="op">===</span> <span class="st">&quot;GET&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-133" title="133">    <span class="at">acceptNewClient</span>(request<span class="op">,</span> response)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-134" title="134">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-135" title="135">  <span class="co">// Otherwise the /chat request is a POST of a new message</span></a>
<a class="sourceLine" id="cb29-136" title="136">  <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-137" title="137">    <span class="at">broadcastNewMessage</span>(request<span class="op">,</span> response)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-138" title="138">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-139" title="139"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-140" title="140"></a>
<a class="sourceLine" id="cb29-141" title="141"><span class="co">// This handles GET requests for the /chat endpoint which are generated when</span></a>
<a class="sourceLine" id="cb29-142" title="142"><span class="co">// the client creates a new EventSource object (or when the EventSource</span></a>
<a class="sourceLine" id="cb29-143" title="143"><span class="co">// reconnects automatically).</span></a>
<a class="sourceLine" id="cb29-144" title="144"><span class="kw">function</span> <span class="at">acceptNewClient</span>(request<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-145" title="145">  <span class="co">// Remember the response object so we can send future messages to it</span></a>
<a class="sourceLine" id="cb29-146" title="146">  <span class="va">clients</span>.<span class="at">push</span>(response)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-147" title="147"></a>
<a class="sourceLine" id="cb29-148" title="148">  <span class="co">// If the client closes the connection, remove the corresponding</span></a>
<a class="sourceLine" id="cb29-149" title="149">  <span class="co">// response object from the array of active clients</span></a>
<a class="sourceLine" id="cb29-150" title="150">  <span class="va">request</span>.<span class="va">connection</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-151" title="151">    <span class="va">clients</span>.<span class="at">splice</span>(<span class="va">clients</span>.<span class="at">indexOf</span>(response)<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-152" title="152">    <span class="va">response</span>.<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-153" title="153">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-154" title="154"></a>
<a class="sourceLine" id="cb29-155" title="155">  <span class="co">// Set headers and send an initial chat event to just this one client</span></a>
<a class="sourceLine" id="cb29-156" title="156">  <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-157" title="157">    <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;text/event-stream&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-158" title="158">    <span class="dt">Connection</span><span class="op">:</span> <span class="st">&quot;keep-alive&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-159" title="159">    <span class="st">&quot;Cache-Control&quot;</span><span class="op">:</span> <span class="st">&quot;no-cache&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-160" title="160">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-161" title="161">  <span class="va">response</span>.<span class="at">write</span>(<span class="st">&quot;event: chat</span><span class="sc">\n</span><span class="st">data: Connected</span><span class="sc">\n\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-162" title="162"></a>
<a class="sourceLine" id="cb29-163" title="163">  <span class="co">// Note that we intentionally do not call response.end() here.</span></a>
<a class="sourceLine" id="cb29-164" title="164">  <span class="co">// Keeping the connection open is what makes Server-Sent Events work.</span></a>
<a class="sourceLine" id="cb29-165" title="165"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-166" title="166"></a>
<a class="sourceLine" id="cb29-167" title="167"><span class="co">// This function is called in response to POST requests to the /chat endpoint</span></a>
<a class="sourceLine" id="cb29-168" title="168"><span class="co">// which clients send when users type a new message.</span></a>
<a class="sourceLine" id="cb29-169" title="169"><span class="kw">async</span> <span class="kw">function</span> <span class="at">broadcastNewMessage</span>(request<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-170" title="170">  <span class="co">// First, read the body of the request to get the user&#39;s message</span></a>
<a class="sourceLine" id="cb29-171" title="171">  <span class="va">request</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf8&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-172" title="172">  <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-173" title="173">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> request) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-174" title="174">    body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb29-175" title="175">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-176" title="176"></a>
<a class="sourceLine" id="cb29-177" title="177">  <span class="co">// Once we&#39;ve read the body send an empty response and close the connection</span></a>
<a class="sourceLine" id="cb29-178" title="178">  <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-179" title="179"></a>
<a class="sourceLine" id="cb29-180" title="180">  <span class="co">// Format the message in text/event-stream format, prefixing each</span></a>
<a class="sourceLine" id="cb29-181" title="181">  <span class="co">// line with &quot;data: &quot;</span></a>
<a class="sourceLine" id="cb29-182" title="182">  <span class="kw">let</span> message <span class="op">=</span> <span class="st">&quot;data: &quot;</span> <span class="op">+</span> <span class="va">body</span>.<span class="at">replace</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">data: &quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-183" title="183"></a>
<a class="sourceLine" id="cb29-184" title="184">  <span class="co">// Give the message data a prefix that defines it as a &quot;chat&quot; event</span></a>
<a class="sourceLine" id="cb29-185" title="185">  <span class="co">// and give it a double newline suffix that marks the end of the event.</span></a>
<a class="sourceLine" id="cb29-186" title="186">  <span class="kw">let</span> event <span class="op">=</span> <span class="vs">`event: chat</span><span class="sc">\n${</span>message<span class="sc">}\n\n</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-187" title="187"></a>
<a class="sourceLine" id="cb29-188" title="188">  <span class="co">// Now send this event to all listening clients</span></a>
<a class="sourceLine" id="cb29-189" title="189">  <span class="va">clients</span>.<span class="at">forEach</span>((client) <span class="kw">=&gt;</span> <span class="va">client</span>.<span class="at">write</span>(event))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-190" title="190"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-191" title="191"></a>
<a class="sourceLine" id="cb29-192" title="192"><span class="co">// Wait for messages from our parent process</span></a>
<a class="sourceLine" id="cb29-193" title="193"><span class="va">process</span>.<span class="at">on</span>(<span class="st">&quot;message&quot;</span><span class="op">,</span> (message) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-194" title="194">  <span class="co">// When we receive one, do a calculation and send the result</span></a>
<a class="sourceLine" id="cb29-195" title="195">  <span class="co">// back to the parent.</span></a>
<a class="sourceLine" id="cb29-196" title="196">  <span class="va">process</span>.<span class="at">send</span>(<span class="op">{</span> <span class="dt">hypotenuse</span><span class="op">:</span> <span class="va">Math</span>.<span class="at">hypot</span>(<span class="va">message</span>.<span class="at">x</span><span class="op">,</span> <span class="va">message</span>.<span class="at">y</span>) <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-197" title="197"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-198" title="198"></a>
<a class="sourceLine" id="cb29-199" title="199"><span class="kw">function</span> <span class="at">classof</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-200" title="200">  <span class="cf">return</span> <span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(o).<span class="at">slice</span>(<span class="dv">8</span><span class="op">,</span> <span class="dv">-1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-201" title="201"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-202" title="202"></a>
<a class="sourceLine" id="cb29-203" title="203"><span class="at">classof</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Null&quot;</span></a>
<a class="sourceLine" id="cb29-204" title="204"><span class="at">classof</span>(<span class="kw">undefined</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Undefined&quot;</span></a>
<a class="sourceLine" id="cb29-205" title="205"><span class="at">classof</span>(<span class="dv">1</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Number&quot;</span></a>
<a class="sourceLine" id="cb29-206" title="206"><span class="at">classof</span>(10n <span class="op">**</span> 100n)<span class="op">;</span> <span class="co">// =&gt; &quot;BigInt&quot;</span></a>
<a class="sourceLine" id="cb29-207" title="207"><span class="at">classof</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;String&quot;</span></a>
<a class="sourceLine" id="cb29-208" title="208"><span class="at">classof</span>(<span class="kw">false</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Boolean&quot;</span></a>
<a class="sourceLine" id="cb29-209" title="209"><span class="at">classof</span>(<span class="at">Symbol</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Symbol&quot;</span></a>
<a class="sourceLine" id="cb29-210" title="210"><span class="at">classof</span>(<span class="op">{}</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Object&quot;</span></a>
<a class="sourceLine" id="cb29-211" title="211"><span class="at">classof</span>([])<span class="op">;</span> <span class="co">// =&gt; &quot;Array&quot;</span></a>
<a class="sourceLine" id="cb29-212" title="212"><span class="at">classof</span>(<span class="ss">/./</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;RegExp&quot;</span></a>
<a class="sourceLine" id="cb29-213" title="213"><span class="at">classof</span>(() <span class="kw">=&gt;</span> <span class="op">{}</span>)<span class="op">;</span> <span class="co">// =&gt; &quot;Function&quot;</span></a>
<a class="sourceLine" id="cb29-214" title="214"><span class="at">classof</span>(<span class="kw">new</span> <span class="at">Map</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Map&quot;</span></a>
<a class="sourceLine" id="cb29-215" title="215"><span class="at">classof</span>(<span class="kw">new</span> <span class="at">Set</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Set&quot;</span></a>
<a class="sourceLine" id="cb29-216" title="216"><span class="at">classof</span>(<span class="kw">new</span> <span class="at">Date</span>())<span class="op">;</span> <span class="co">// =&gt; &quot;Date&quot;</span></a>
<a class="sourceLine" id="cb29-217" title="217"></a>
<a class="sourceLine" id="cb29-218" title="218"><span class="kw">class</span> Range <span class="op">{</span></a>
<a class="sourceLine" id="cb29-219" title="219">  get [<span class="va">Symbol</span>.<span class="at">toStringTag</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-220" title="220">    <span class="cf">return</span> <span class="st">&quot;Range&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-221" title="221">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-222" title="222">  <span class="co">// the rest of this class is omitted here</span></a>
<a class="sourceLine" id="cb29-223" title="223"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-224" title="224"><span class="kw">let</span> r <span class="op">=</span> <span class="kw">new</span> <span class="at">Range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-225" title="225"><span class="va">Object</span>.<span class="va">prototype</span>.<span class="va">toString</span>.<span class="at">call</span>(r)<span class="op">;</span> <span class="co">// =&gt; &quot;[object Range]&quot;</span></a>
<a class="sourceLine" id="cb29-226" title="226"><span class="at">classof</span>(r)<span class="op">;</span> <span class="co">// =&gt; &quot;Range&quot;</span></a>
<a class="sourceLine" id="cb29-227" title="227"></a>
<a class="sourceLine" id="cb29-228" title="228"><span class="co">// Define some drawing attributes</span></a>
<a class="sourceLine" id="cb29-229" title="229"><span class="va">c</span>.<span class="at">font</span> <span class="op">=</span> <span class="st">&quot;bold 60pt sans-serif&quot;</span><span class="op">;</span> <span class="co">// Big font</span></a>
<a class="sourceLine" id="cb29-230" title="230"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> <span class="co">// Narrow lines</span></a>
<a class="sourceLine" id="cb29-231" title="231"><span class="va">c</span>.<span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">&quot;#000&quot;</span><span class="op">;</span> <span class="co">// Black lines</span></a>
<a class="sourceLine" id="cb29-232" title="232"></a>
<a class="sourceLine" id="cb29-233" title="233"><span class="co">// Outline a rectangle and some text</span></a>
<a class="sourceLine" id="cb29-234" title="234"><span class="va">c</span>.<span class="at">strokeRect</span>(<span class="dv">175</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">325</span>)<span class="op">;</span> <span class="co">// A vertical stripe down the middle</span></a>
<a class="sourceLine" id="cb29-235" title="235"><span class="va">c</span>.<span class="at">strokeText</span>(<span class="st">&quot;&lt;canvas&gt;&quot;</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">330</span>)<span class="op">;</span> <span class="co">// Note strokeText() instead of fillText()</span></a>
<a class="sourceLine" id="cb29-236" title="236"></a>
<a class="sourceLine" id="cb29-237" title="237"><span class="co">// Define a complex path with an interior that is outside.</span></a>
<a class="sourceLine" id="cb29-238" title="238"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">200</span><span class="op">,</span> <span class="dv">225</span><span class="op">,</span> <span class="dv">200</span>)<span class="op">;</span> <span class="co">// Large triangle</span></a>
<a class="sourceLine" id="cb29-239" title="239"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">200</span><span class="op">,</span> <span class="dv">225</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="co">// Smaller reverse triangle inside</span></a>
<a class="sourceLine" id="cb29-240" title="240"></a>
<a class="sourceLine" id="cb29-241" title="241"><span class="co">// Make that path the clipping region.</span></a>
<a class="sourceLine" id="cb29-242" title="242"><span class="va">c</span>.<span class="at">clip</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-243" title="243"></a>
<a class="sourceLine" id="cb29-244" title="244"><span class="co">// Stroke the path with a 5 pixel line, entirely inside the clipping region.</span></a>
<a class="sourceLine" id="cb29-245" title="245"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">10</span><span class="op">;</span> <span class="co">// Half of this 10 pixel line will be clipped away</span></a>
<a class="sourceLine" id="cb29-246" title="246"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-247" title="247"></a>
<a class="sourceLine" id="cb29-248" title="248"><span class="co">// Fill the parts of the rectangle and text that are inside the clipping region</span></a>
<a class="sourceLine" id="cb29-249" title="249"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#aaa&quot;</span><span class="op">;</span> <span class="co">// Light gray</span></a>
<a class="sourceLine" id="cb29-250" title="250"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">175</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">325</span>)<span class="op">;</span> <span class="co">// Fill the vertical stripe</span></a>
<a class="sourceLine" id="cb29-251" title="251"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#888&quot;</span><span class="op">;</span> <span class="co">// Darker gray</span></a>
<a class="sourceLine" id="cb29-252" title="252"><span class="va">c</span>.<span class="at">fillText</span>(<span class="st">&quot;&lt;canvas&gt;&quot;</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">330</span>)<span class="op">;</span> <span class="co">// Fill the text</span></a>
<a class="sourceLine" id="cb29-253" title="253"></a>
<a class="sourceLine" id="cb29-254" title="254">(<span class="kw">function</span> <span class="at">updateClock</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-255" title="255">  <span class="co">// Update the SVG clock graphic to show current time</span></a>
<a class="sourceLine" id="cb29-256" title="256">  <span class="kw">let</span> now <span class="op">=</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">;</span> <span class="co">// Current time</span></a>
<a class="sourceLine" id="cb29-257" title="257">  <span class="kw">let</span> sec <span class="op">=</span> <span class="va">now</span>.<span class="at">getSeconds</span>()<span class="op">;</span> <span class="co">// Seconds</span></a>
<a class="sourceLine" id="cb29-258" title="258">  <span class="kw">let</span> min <span class="op">=</span> <span class="va">now</span>.<span class="at">getMinutes</span>() <span class="op">+</span> sec / <span class="dv">60</span><span class="op">;</span> <span class="co">// Fractional minutes</span></a>
<a class="sourceLine" id="cb29-259" title="259">  <span class="kw">let</span> hour <span class="op">=</span> (<span class="va">now</span>.<span class="at">getHours</span>() <span class="op">%</span> <span class="dv">12</span>) <span class="op">+</span> min / <span class="dv">60</span><span class="op">;</span> <span class="co">// Fractional hours</span></a>
<a class="sourceLine" id="cb29-260" title="260">  <span class="kw">let</span> minangle <span class="op">=</span> min <span class="op">*</span> <span class="dv">6</span><span class="op">;</span> <span class="co">// 6 degrees per minute</span></a>
<a class="sourceLine" id="cb29-261" title="261">  <span class="kw">let</span> hourangle <span class="op">=</span> hour <span class="op">*</span> <span class="dv">30</span><span class="op">;</span> <span class="co">// 30 degrees per hour</span></a>
<a class="sourceLine" id="cb29-262" title="262"></a>
<a class="sourceLine" id="cb29-263" title="263">  <span class="co">// Get SVG elements for the hands of the clock</span></a>
<a class="sourceLine" id="cb29-264" title="264">  <span class="kw">let</span> minhand <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#clock .minutehand&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-265" title="265">  <span class="kw">let</span> hourhand <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#clock .hourhand&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-266" title="266"></a>
<a class="sourceLine" id="cb29-267" title="267">  <span class="co">// Set an SVG attribute on them to move them around the clock face</span></a>
<a class="sourceLine" id="cb29-268" title="268">  <span class="va">minhand</span>.<span class="at">setAttribute</span>(<span class="st">&quot;transform&quot;</span><span class="op">,</span> <span class="vs">`rotate(</span><span class="sc">${</span>minangle<span class="sc">}</span><span class="vs">,50,50)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-269" title="269">  <span class="va">hourhand</span>.<span class="at">setAttribute</span>(<span class="st">&quot;transform&quot;</span><span class="op">,</span> <span class="vs">`rotate(</span><span class="sc">${</span>hourangle<span class="sc">}</span><span class="vs">,50,50)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-270" title="270"></a>
<a class="sourceLine" id="cb29-271" title="271">  <span class="co">// Run this function again in 10 seconds</span></a>
<a class="sourceLine" id="cb29-272" title="272">  <span class="at">setTimeout</span>(updateClock<span class="op">,</span> <span class="dv">10000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-273" title="273"><span class="op">}</span>)()<span class="op">;</span> <span class="co">// Note immediate invocation of the function here.</span></a>
<a class="sourceLine" id="cb29-274" title="274"></a>
<a class="sourceLine" id="cb29-275" title="275"><span class="co">// A Promise-based wrapper around setTimeout() that we can use await with.</span></a>
<a class="sourceLine" id="cb29-276" title="276"><span class="co">// Returns a Promise that fulfills in the specified number of milliseconds</span></a>
<a class="sourceLine" id="cb29-277" title="277"><span class="kw">function</span> <span class="at">elapsedTime</span>(ms) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-278" title="278">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="kw">=&gt;</span> <span class="at">setTimeout</span>(resolve<span class="op">,</span> ms))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-279" title="279"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-280" title="280"></a>
<a class="sourceLine" id="cb29-281" title="281"><span class="co">// An async generator function that increments a counter and yields it</span></a>
<a class="sourceLine" id="cb29-282" title="282"><span class="co">// a specified (or infinite) number of times at a specified interval.</span></a>
<a class="sourceLine" id="cb29-283" title="283"><span class="kw">async</span> <span class="kw">function</span><span class="op">*</span> <span class="at">clock</span>(interval<span class="op">,</span> max <span class="op">=</span> <span class="kw">Infinity</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-284" title="284">  <span class="cf">for</span> (<span class="kw">let</span> count <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> count <span class="op">&lt;=</span> max<span class="op">;</span> count<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-285" title="285">    <span class="co">// regular for loop</span></a>
<a class="sourceLine" id="cb29-286" title="286">    <span class="cf">await</span> <span class="at">elapsedTime</span>(interval)<span class="op">;</span> <span class="co">// wait for time to pass</span></a>
<a class="sourceLine" id="cb29-287" title="287">    <span class="kw">yield</span> count<span class="op">;</span> <span class="co">// yield the counter</span></a>
<a class="sourceLine" id="cb29-288" title="288">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-289" title="289"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-290" title="290"></a>
<a class="sourceLine" id="cb29-291" title="291"><span class="co">// A test function that uses the async generator with for/await</span></a>
<a class="sourceLine" id="cb29-292" title="292"><span class="kw">async</span> <span class="kw">function</span> <span class="at">test</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-293" title="293">  <span class="co">// Async so we can use for/await</span></a>
<a class="sourceLine" id="cb29-294" title="294">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> tick <span class="kw">of</span> <span class="at">clock</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">100</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-295" title="295">    <span class="co">// Loop 100 times every 300ms</span></a>
<a class="sourceLine" id="cb29-296" title="296">    <span class="va">console</span>.<span class="at">log</span>(tick)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-297" title="297">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-298" title="298"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-299" title="299"></a>
<a class="sourceLine" id="cb29-300" title="300"><span class="kw">function</span> <span class="at">clock</span>(interval<span class="op">,</span> max <span class="op">=</span> <span class="kw">Infinity</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-301" title="301">  <span class="co">// A Promise-ified version of setTimeout that we can use await with.</span></a>
<a class="sourceLine" id="cb29-302" title="302">  <span class="co">// Note that this takes an absolute time instead of an interval.</span></a>
<a class="sourceLine" id="cb29-303" title="303">  <span class="kw">function</span> <span class="at">until</span>(time) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-304" title="304">    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="kw">=&gt;</span> <span class="at">setTimeout</span>(resolve<span class="op">,</span> time <span class="op">-</span> <span class="va">Date</span>.<span class="at">now</span>()))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-305" title="305">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-306" title="306"></a>
<a class="sourceLine" id="cb29-307" title="307">  <span class="kw">let</span> startTime <span class="op">=</span> <span class="va">Date</span>.<span class="at">now</span>()<span class="op">;</span> <span class="co">// Remember when we started</span></a>
<a class="sourceLine" id="cb29-308" title="308">  <span class="kw">let</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// Remember which iteration we&#39;re on</span></a>
<a class="sourceLine" id="cb29-309" title="309"></a>
<a class="sourceLine" id="cb29-310" title="310">  <span class="co">// Return an asynchronously iterable object</span></a>
<a class="sourceLine" id="cb29-311" title="311">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-312" title="312">    <span class="kw">async</span> <span class="at">next</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-313" title="313">      <span class="co">// The next() method makes this an iterator</span></a>
<a class="sourceLine" id="cb29-314" title="314">      <span class="cf">if</span> (<span class="op">++</span>count <span class="op">&gt;</span> max) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-315" title="315">        <span class="co">// Are we done?</span></a>
<a class="sourceLine" id="cb29-316" title="316">        <span class="cf">return</span> <span class="op">{</span> <span class="dt">done</span><span class="op">:</span> <span class="kw">true</span> <span class="op">};</span> <span class="co">// Iteration result indicating done</span></a>
<a class="sourceLine" id="cb29-317" title="317">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-318" title="318">      <span class="co">// Figure out when the next iteration should begin,</span></a>
<a class="sourceLine" id="cb29-319" title="319">      <span class="kw">let</span> targetTime <span class="op">=</span> startTime <span class="op">+</span> count <span class="op">*</span> interval<span class="op">;</span></a>
<a class="sourceLine" id="cb29-320" title="320">      <span class="co">// wait until that time,</span></a>
<a class="sourceLine" id="cb29-321" title="321">      <span class="cf">await</span> <span class="at">until</span>(targetTime)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-322" title="322">      <span class="co">// and return the count value in an iteration result object.</span></a>
<a class="sourceLine" id="cb29-323" title="323">      <span class="cf">return</span> <span class="op">{</span> <span class="dt">value</span><span class="op">:</span> count <span class="op">};</span></a>
<a class="sourceLine" id="cb29-324" title="324">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-325" title="325">    <span class="co">// This method means that this iterator object is also an iterable.</span></a>
<a class="sourceLine" id="cb29-326" title="326">    [<span class="va">Symbol</span>.<span class="at">asyncIterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-327" title="327">      <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-328" title="328">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-329" title="329">  <span class="op">};</span></a>
<a class="sourceLine" id="cb29-330" title="330"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-331" title="331"></a>
<a class="sourceLine" id="cb29-332" title="332"><span class="co">// Return a new function that computes f(g(...)).</span></a>
<a class="sourceLine" id="cb29-333" title="333"><span class="co">// The returned function h passes all of its arguments to g, then passes</span></a>
<a class="sourceLine" id="cb29-334" title="334"><span class="co">// the return value of g to f, then returns the return value of f.</span></a>
<a class="sourceLine" id="cb29-335" title="335"><span class="co">// Both f and g are invoked with the same this value as h was invoked with.</span></a>
<a class="sourceLine" id="cb29-336" title="336"><span class="kw">function</span> <span class="at">compose</span>(f<span class="op">,</span> g) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-337" title="337">  <span class="cf">return</span> <span class="kw">function</span> (...<span class="at">args</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-338" title="338">    <span class="co">// We use call for f because we&#39;re passing a single value and</span></a>
<a class="sourceLine" id="cb29-339" title="339">    <span class="co">// apply for g because we&#39;re passing an array of values.</span></a>
<a class="sourceLine" id="cb29-340" title="340">    <span class="cf">return</span> <span class="va">f</span>.<span class="at">call</span>(<span class="kw">this</span><span class="op">,</span> <span class="va">g</span>.<span class="at">apply</span>(<span class="kw">this</span><span class="op">,</span> args))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-341" title="341">  <span class="op">};</span></a>
<a class="sourceLine" id="cb29-342" title="342"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-343" title="343"></a>
<a class="sourceLine" id="cb29-344" title="344"><span class="kw">const</span> sum <span class="op">=</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y<span class="op">;</span></a>
<a class="sourceLine" id="cb29-345" title="345"><span class="kw">const</span> square <span class="op">=</span> (x) <span class="kw">=&gt;</span> x <span class="op">*</span> x<span class="op">;</span></a>
<a class="sourceLine" id="cb29-346" title="346"><span class="at">compose</span>(square<span class="op">,</span> sum)(<span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span> <span class="co">// =&gt; 25; the square of the sum</span></a>
<a class="sourceLine" id="cb29-347" title="347"></a>
<a class="sourceLine" id="cb29-348" title="348"><span class="co">// This function writes the specified chunk to the specified stream and</span></a>
<a class="sourceLine" id="cb29-349" title="349"><span class="co">// returns a Promise that will be fulfilled when it is OK to write again.</span></a>
<a class="sourceLine" id="cb29-350" title="350"><span class="co">// Because it returns a Promise, it can be used with await.</span></a>
<a class="sourceLine" id="cb29-351" title="351"><span class="kw">function</span> <span class="at">write</span>(stream<span class="op">,</span> chunk) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-352" title="352">  <span class="co">// Write the specified chunk to the specified stream</span></a>
<a class="sourceLine" id="cb29-353" title="353">  <span class="kw">let</span> hasMoreRoom <span class="op">=</span> <span class="va">stream</span>.<span class="at">write</span>(chunk)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-354" title="354"></a>
<a class="sourceLine" id="cb29-355" title="355">  <span class="cf">if</span> (hasMoreRoom) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-356" title="356">    <span class="co">// If buffer is not full, return</span></a>
<a class="sourceLine" id="cb29-357" title="357">    <span class="cf">return</span> <span class="va">Promise</span>.<span class="at">resolve</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// an already resolved Promise object</span></a>
<a class="sourceLine" id="cb29-358" title="358">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-359" title="359">    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-360" title="360">      <span class="co">// Otherwise, return a Promise that</span></a>
<a class="sourceLine" id="cb29-361" title="361">      <span class="va">stream</span>.<span class="at">once</span>(<span class="st">&quot;drain&quot;</span><span class="op">,</span> resolve)<span class="op">;</span> <span class="co">// resolves on the drain event.</span></a>
<a class="sourceLine" id="cb29-362" title="362">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-363" title="363">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-364" title="364"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-365" title="365"></a>
<a class="sourceLine" id="cb29-366" title="366"><span class="co">// Copy data from the source stream to the destination stream</span></a>
<a class="sourceLine" id="cb29-367" title="367"><span class="co">// respecting backpressure from the destination stream.</span></a>
<a class="sourceLine" id="cb29-368" title="368"><span class="co">// This is much like calling source.pipe(destination).</span></a>
<a class="sourceLine" id="cb29-369" title="369"><span class="kw">async</span> <span class="kw">function</span> <span class="at">copy</span>(source<span class="op">,</span> destination) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-370" title="370">  <span class="co">// Set an error handler on the destination stream in case standard</span></a>
<a class="sourceLine" id="cb29-371" title="371">  <span class="co">// output closes unexpectedly (when piping output to `head`, e.g.)</span></a>
<a class="sourceLine" id="cb29-372" title="372">  <span class="va">destination</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="va">process</span>.<span class="at">exit</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb29-373" title="373"></a>
<a class="sourceLine" id="cb29-374" title="374">  <span class="co">// Use a for/await loop to asynchronously read chunks from the input stream</span></a>
<a class="sourceLine" id="cb29-375" title="375">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> source) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-376" title="376">    <span class="co">// Write the chunk and wait until there is more room in the buffer.</span></a>
<a class="sourceLine" id="cb29-377" title="377">    <span class="cf">await</span> <span class="at">write</span>(destination<span class="op">,</span> chunk)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-378" title="378">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-379" title="379"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-380" title="380"></a>
<a class="sourceLine" id="cb29-381" title="381"><span class="co">// Copy standard input to standard output</span></a>
<a class="sourceLine" id="cb29-382" title="382"><span class="at">copy</span>(<span class="va">process</span>.<span class="at">stdin</span><span class="op">,</span> <span class="va">process</span>.<span class="at">stdout</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-383" title="383"></a>
<a class="sourceLine" id="cb29-384" title="384"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-385" title="385"></a>
<a class="sourceLine" id="cb29-386" title="386"><span class="co">// A streaming file copy function, using &quot;flowing mode&quot;.</span></a>
<a class="sourceLine" id="cb29-387" title="387"><span class="co">// Copies the contents of the named source file to the named destination file.</span></a>
<a class="sourceLine" id="cb29-388" title="388"><span class="co">// On success, invokes the callback with a null argument. On error,</span></a>
<a class="sourceLine" id="cb29-389" title="389"><span class="co">// invokes the callback with an Error object.</span></a>
<a class="sourceLine" id="cb29-390" title="390"><span class="kw">function</span> <span class="at">copyFile</span>(sourceFilename<span class="op">,</span> destinationFilename<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-391" title="391">  <span class="kw">let</span> input <span class="op">=</span> <span class="va">fs</span>.<span class="at">createReadStream</span>(sourceFilename)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-392" title="392">  <span class="kw">let</span> output <span class="op">=</span> <span class="va">fs</span>.<span class="at">createWriteStream</span>(destinationFilename)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-393" title="393"></a>
<a class="sourceLine" id="cb29-394" title="394">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;data&quot;</span><span class="op">,</span> (chunk) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-395" title="395">    <span class="co">// When we get new data,</span></a>
<a class="sourceLine" id="cb29-396" title="396">    <span class="kw">let</span> hasRoom <span class="op">=</span> <span class="va">output</span>.<span class="at">write</span>(chunk)<span class="op">;</span> <span class="co">// write it to the output stream.</span></a>
<a class="sourceLine" id="cb29-397" title="397">    <span class="cf">if</span> (<span class="op">!</span>hasRoom) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-398" title="398">      <span class="co">// If the output stream is full</span></a>
<a class="sourceLine" id="cb29-399" title="399">      <span class="va">input</span>.<span class="at">pause</span>()<span class="op">;</span> <span class="co">// then pause the input stream.</span></a>
<a class="sourceLine" id="cb29-400" title="400">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-401" title="401">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-402" title="402">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-403" title="403">    <span class="co">// When we reach the end of input,</span></a>
<a class="sourceLine" id="cb29-404" title="404">    <span class="va">output</span>.<span class="at">end</span>()<span class="op">;</span> <span class="co">// tell the output stream to end.</span></a>
<a class="sourceLine" id="cb29-405" title="405">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-406" title="406">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-407" title="407">    <span class="co">// If we get an error on the input,</span></a>
<a class="sourceLine" id="cb29-408" title="408">    <span class="at">callback</span>(err)<span class="op">;</span> <span class="co">// call the callback with the error</span></a>
<a class="sourceLine" id="cb29-409" title="409">    <span class="va">process</span>.<span class="at">exit</span>()<span class="op">;</span> <span class="co">// and quit.</span></a>
<a class="sourceLine" id="cb29-410" title="410">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-411" title="411"></a>
<a class="sourceLine" id="cb29-412" title="412">  <span class="va">output</span>.<span class="at">on</span>(<span class="st">&quot;drain&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-413" title="413">    <span class="co">// When the output is no longer full,</span></a>
<a class="sourceLine" id="cb29-414" title="414">    <span class="va">input</span>.<span class="at">resume</span>()<span class="op">;</span> <span class="co">// resume data events on the input</span></a>
<a class="sourceLine" id="cb29-415" title="415">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-416" title="416">  <span class="va">output</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-417" title="417">    <span class="co">// If we get an error on the output,</span></a>
<a class="sourceLine" id="cb29-418" title="418">    <span class="at">callback</span>(err)<span class="op">;</span> <span class="co">// call the callback with the error</span></a>
<a class="sourceLine" id="cb29-419" title="419">    <span class="va">process</span>.<span class="at">exit</span>()<span class="op">;</span> <span class="co">// and quit.</span></a>
<a class="sourceLine" id="cb29-420" title="420">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-421" title="421">  <span class="va">output</span>.<span class="at">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-422" title="422">    <span class="co">// When output is fully written</span></a>
<a class="sourceLine" id="cb29-423" title="423">    <span class="at">callback</span>(<span class="kw">null</span>)<span class="op">;</span> <span class="co">// call the callback with no error.</span></a>
<a class="sourceLine" id="cb29-424" title="424">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-425" title="425"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-426" title="426"></a>
<a class="sourceLine" id="cb29-427" title="427"><span class="co">// Here&#39;s a simple command-line utility to copy files</span></a>
<a class="sourceLine" id="cb29-428" title="428"><span class="kw">let</span> <span class="im">from</span> <span class="op">=</span> <span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb29-429" title="429">  to <span class="op">=</span> <span class="va">process</span>.<span class="at">argv</span>[<span class="dv">3</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-430" title="430"><span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Copying file </span><span class="sc">${</span><span class="im">from</span><span class="sc">}</span><span class="vs"> to </span><span class="sc">${</span>to<span class="sc">}</span><span class="vs">...`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-431" title="431"><span class="at">copyFile</span>(<span class="im">from</span><span class="op">,</span> to<span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-432" title="432">  <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-433" title="433">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-434" title="434">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-435" title="435">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;done.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-436" title="436">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-437" title="437"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-438" title="438"></a>
<a class="sourceLine" id="cb29-439" title="439"><span class="kw">function</span> <span class="at">counter</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-440" title="440">  <span class="kw">let</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-441" title="441">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-442" title="442">    <span class="dt">count</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb29-443" title="443">      <span class="cf">return</span> n<span class="op">++;</span></a>
<a class="sourceLine" id="cb29-444" title="444">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-445" title="445">    <span class="dt">reset</span><span class="op">:</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb29-446" title="446">      n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-447" title="447">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-448" title="448">  <span class="op">};</span></a>
<a class="sourceLine" id="cb29-449" title="449"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-450" title="450"></a>
<a class="sourceLine" id="cb29-451" title="451"><span class="kw">let</span> c <span class="op">=</span> <span class="at">counter</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb29-452" title="452">  d <span class="op">=</span> <span class="at">counter</span>()<span class="op">;</span> <span class="co">// Create two counters</span></a>
<a class="sourceLine" id="cb29-453" title="453"><span class="va">c</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 0</span></a>
<a class="sourceLine" id="cb29-454" title="454"><span class="va">d</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 0: they count independently</span></a>
<a class="sourceLine" id="cb29-455" title="455"><span class="va">c</span>.<span class="at">reset</span>()<span class="op">;</span> <span class="co">// reset() and count() methods share state</span></a>
<a class="sourceLine" id="cb29-456" title="456"><span class="va">c</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 0: because we reset c</span></a>
<a class="sourceLine" id="cb29-457" title="457"><span class="va">d</span>.<span class="at">count</span>()<span class="op">;</span> <span class="co">// =&gt; 1: d was not reset</span></a>
<a class="sourceLine" id="cb29-458" title="458"></a>
<a class="sourceLine" id="cb29-459" title="459"><span class="kw">function</span> <span class="at">counter</span>(n) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-460" title="460">  <span class="co">// Function argument n is the private variable</span></a>
<a class="sourceLine" id="cb29-461" title="461">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-462" title="462">    <span class="co">// Property getter method returns and increments private counter var.</span></a>
<a class="sourceLine" id="cb29-463" title="463">    get <span class="at">count</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-464" title="464">      <span class="cf">return</span> n<span class="op">++;</span></a>
<a class="sourceLine" id="cb29-465" title="465">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-466" title="466">    <span class="co">// Property setter doesn&#39;t allow the value of n to decrease</span></a>
<a class="sourceLine" id="cb29-467" title="467">    set <span class="at">count</span>(m) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-468" title="468">      <span class="cf">if</span> (m <span class="op">&gt;</span> n) n <span class="op">=</span> m<span class="op">;</span></a>
<a class="sourceLine" id="cb29-469" title="469">      <span class="cf">else</span> <span class="cf">throw</span> <span class="at">Error</span>(<span class="st">&quot;count can only be set to a larger value&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-470" title="470">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-471" title="471">  <span class="op">};</span></a>
<a class="sourceLine" id="cb29-472" title="472"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-473" title="473"></a>
<a class="sourceLine" id="cb29-474" title="474"><span class="kw">let</span> c <span class="op">=</span> <span class="at">counter</span>(<span class="dv">1000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-475" title="475"><span class="va">c</span>.<span class="at">count</span><span class="op">;</span> <span class="co">// =&gt; 1000</span></a>
<a class="sourceLine" id="cb29-476" title="476"><span class="va">c</span>.<span class="at">count</span><span class="op">;</span> <span class="co">// =&gt; 1001</span></a>
<a class="sourceLine" id="cb29-477" title="477"><span class="va">c</span>.<span class="at">count</span> <span class="op">=</span> <span class="dv">2000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-478" title="478"><span class="va">c</span>.<span class="at">count</span><span class="op">;</span> <span class="co">// =&gt; 2000</span></a>
<a class="sourceLine" id="cb29-479" title="479"><span class="va">c</span>.<span class="at">count</span> <span class="op">=</span> <span class="dv">2000</span><span class="op">;</span> <span class="co">// !Error: count can only be set to a larger value</span></a>
<a class="sourceLine" id="cb29-480" title="480"></a>
<a class="sourceLine" id="cb29-481" title="481"><span class="co">// A utility function to convert angles from degrees to radians</span></a>
<a class="sourceLine" id="cb29-482" title="482"><span class="kw">function</span> <span class="at">rads</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-483" title="483">  <span class="cf">return</span> (<span class="va">Math</span>.<span class="at">PI</span> <span class="op">*</span> x) / <span class="dv">180</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-484" title="484"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-485" title="485"></a>
<a class="sourceLine" id="cb29-486" title="486"><span class="co">// Get the context object of the document&#39;s canvas element</span></a>
<a class="sourceLine" id="cb29-487" title="487"><span class="kw">let</span> c <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;canvas&quot;</span>).<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-488" title="488"></a>
<a class="sourceLine" id="cb29-489" title="489"><span class="co">// Define some graphics attributes and draw the curves</span></a>
<a class="sourceLine" id="cb29-490" title="490"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#aaa&quot;</span><span class="op">;</span> <span class="co">// Gray fills</span></a>
<a class="sourceLine" id="cb29-491" title="491"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> <span class="co">// 2-pixel black (by default) lines</span></a>
<a class="sourceLine" id="cb29-492" title="492"></a>
<a class="sourceLine" id="cb29-493" title="493"><span class="co">// Draw a circle.</span></a>
<a class="sourceLine" id="cb29-494" title="494"><span class="co">// There is no current point, so draw just the circle with no straight</span></a>
<a class="sourceLine" id="cb29-495" title="495"><span class="co">// line from the current point to the start of the circle.</span></a>
<a class="sourceLine" id="cb29-496" title="496"><span class="va">c</span>.<span class="at">beginPath</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-497" title="497"><span class="va">c</span>.<span class="at">arc</span>(</a>
<a class="sourceLine" id="cb29-498" title="498">  <span class="dv">75</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-499" title="499">  <span class="dv">100</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-500" title="500">  <span class="dv">50</span><span class="op">,</span> <span class="co">// Center at (75,100), radius 50</span></a>
<a class="sourceLine" id="cb29-501" title="501">  <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-502" title="502">  <span class="at">rads</span>(<span class="dv">360</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb29-503" title="503">  <span class="kw">false</span></a>
<a class="sourceLine" id="cb29-504" title="504">)<span class="op">;</span> <span class="co">// Go clockwise from 0 to 360 degrees</span></a>
<a class="sourceLine" id="cb29-505" title="505"><span class="va">c</span>.<span class="at">fill</span>()<span class="op">;</span> <span class="co">// Fill the circle</span></a>
<a class="sourceLine" id="cb29-506" title="506"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span> <span class="co">// Stroke its outline.</span></a>
<a class="sourceLine" id="cb29-507" title="507"></a>
<a class="sourceLine" id="cb29-508" title="508"><span class="co">// Now draw an ellipse in the same way</span></a>
<a class="sourceLine" id="cb29-509" title="509"><span class="va">c</span>.<span class="at">beginPath</span>()<span class="op">;</span> <span class="co">// Start new path not connected to the circle</span></a>
<a class="sourceLine" id="cb29-510" title="510"><span class="va">c</span>.<span class="at">ellipse</span>(</a>
<a class="sourceLine" id="cb29-511" title="511">  <span class="dv">200</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-512" title="512">  <span class="dv">100</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-513" title="513">  <span class="dv">50</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-514" title="514">  <span class="dv">35</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-515" title="515">  <span class="at">rads</span>(<span class="dv">15</span>)<span class="op">,</span> <span class="co">// Center, radii, and rotation</span></a>
<a class="sourceLine" id="cb29-516" title="516">  <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-517" title="517">  <span class="at">rads</span>(<span class="dv">360</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb29-518" title="518">  <span class="kw">false</span></a>
<a class="sourceLine" id="cb29-519" title="519">)<span class="op">;</span> <span class="co">// Start angle, end angle, direction</span></a>
<a class="sourceLine" id="cb29-520" title="520"></a>
<a class="sourceLine" id="cb29-521" title="521"><span class="co">// Draw a wedge. Angles are measured clockwise from the positive x axis.</span></a>
<a class="sourceLine" id="cb29-522" title="522"><span class="co">// Note that arc() adds a line from the current point to the arc start.</span></a>
<a class="sourceLine" id="cb29-523" title="523"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">325</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="co">// Start at the center of the circle.</span></a>
<a class="sourceLine" id="cb29-524" title="524"><span class="va">c</span>.<span class="at">arc</span>(</a>
<a class="sourceLine" id="cb29-525" title="525">  <span class="dv">325</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-526" title="526">  <span class="dv">100</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-527" title="527">  <span class="dv">50</span><span class="op">,</span> <span class="co">// Circle center and radius</span></a>
<a class="sourceLine" id="cb29-528" title="528">  <span class="at">rads</span>(<span class="op">-</span><span class="dv">60</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb29-529" title="529">  <span class="at">rads</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="co">// Start at angle -60 and go to angle 0</span></a>
<a class="sourceLine" id="cb29-530" title="530">  <span class="kw">true</span></a>
<a class="sourceLine" id="cb29-531" title="531">)<span class="op">;</span> <span class="co">// counterclockwise</span></a>
<a class="sourceLine" id="cb29-532" title="532"><span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Add radius back to the center of the circle</span></a>
<a class="sourceLine" id="cb29-533" title="533"></a>
<a class="sourceLine" id="cb29-534" title="534"><span class="co">// Similar wedge, offset a bit, and in the opposite direction</span></a>
<a class="sourceLine" id="cb29-535" title="535"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">340</span><span class="op">,</span> <span class="dv">92</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-536" title="536"><span class="va">c</span>.<span class="at">arc</span>(<span class="dv">340</span><span class="op">,</span> <span class="dv">92</span><span class="op">,</span> <span class="dv">42</span><span class="op">,</span> <span class="at">rads</span>(<span class="op">-</span><span class="dv">60</span>)<span class="op">,</span> <span class="at">rads</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-537" title="537"><span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-538" title="538"></a>
<a class="sourceLine" id="cb29-539" title="539"><span class="co">// Use arcTo() for rounded corners. Here we draw a square with</span></a>
<a class="sourceLine" id="cb29-540" title="540"><span class="co">// upper left corner at (400,50) and corners of varying radii.</span></a>
<a class="sourceLine" id="cb29-541" title="541"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">450</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span> <span class="co">// Begin in the middle of the top edge.</span></a>
<a class="sourceLine" id="cb29-542" title="542"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">500</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">;</span> <span class="co">// Add part of top edge and upper right corner.</span></a>
<a class="sourceLine" id="cb29-543" title="543"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">500</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">400</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">;</span> <span class="co">// Add right edge and lower right corner.</span></a>
<a class="sourceLine" id="cb29-544" title="544"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">400</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">400</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span> <span class="co">// Add bottom edge and lower left corner.</span></a>
<a class="sourceLine" id="cb29-545" title="545"><span class="va">c</span>.<span class="at">arcTo</span>(<span class="dv">400</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Add left edge and upper left corner.</span></a>
<a class="sourceLine" id="cb29-546" title="546"><span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Close path to add the rest of the top edge.</span></a>
<a class="sourceLine" id="cb29-547" title="547"></a>
<a class="sourceLine" id="cb29-548" title="548"><span class="co">// Quadratic Bezier curve: one control point</span></a>
<a class="sourceLine" id="cb29-549" title="549"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">525</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// Begin here</span></a>
<a class="sourceLine" id="cb29-550" title="550"><span class="va">c</span>.<span class="at">quadraticCurveTo</span>(<span class="dv">550</span><span class="op">,</span> <span class="dv">75</span><span class="op">,</span> <span class="dv">625</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// Draw a curve to (625, 125)</span></a>
<a class="sourceLine" id="cb29-551" title="551"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">550</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">75</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span> <span class="co">// Mark the control point (550,75)</span></a>
<a class="sourceLine" id="cb29-552" title="552"></a>
<a class="sourceLine" id="cb29-553" title="553"><span class="co">// Cubic Bezier curve</span></a>
<a class="sourceLine" id="cb29-554" title="554"><span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">625</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="co">// Start at (625, 100)</span></a>
<a class="sourceLine" id="cb29-555" title="555"><span class="va">c</span>.<span class="at">bezierCurveTo</span>(<span class="dv">645</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">705</span><span class="op">,</span> <span class="dv">130</span><span class="op">,</span> <span class="dv">725</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="co">// Curve to (725, 100)</span></a>
<a class="sourceLine" id="cb29-556" title="556"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">645</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">70</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span> <span class="co">// Mark control points</span></a>
<a class="sourceLine" id="cb29-557" title="557"><span class="va">c</span>.<span class="at">fillRect</span>(<span class="dv">705</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">130</span> <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-558" title="558"></a>
<a class="sourceLine" id="cb29-559" title="559"><span class="co">// Finally, fill the curves and stroke their outlines.</span></a>
<a class="sourceLine" id="cb29-560" title="560"><span class="va">c</span>.<span class="at">fill</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-561" title="561"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-562" title="562"></a>
<a class="sourceLine" id="cb29-563" title="563"><span class="co">// Convert [x,y] coordinates to [r,theta] polar coordinates</span></a>
<a class="sourceLine" id="cb29-564" title="564"><span class="kw">function</span> <span class="at">toPolar</span>(x<span class="op">,</span> y) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-565" title="565">  <span class="cf">return</span> [<span class="va">Math</span>.<span class="at">sqrt</span>(x <span class="op">*</span> x <span class="op">+</span> y <span class="op">*</span> y)<span class="op">,</span> <span class="va">Math</span>.<span class="at">atan2</span>(y<span class="op">,</span> x)]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-566" title="566"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-567" title="567"></a>
<a class="sourceLine" id="cb29-568" title="568"><span class="co">// Convert polar to Cartesian coordinates</span></a>
<a class="sourceLine" id="cb29-569" title="569"><span class="kw">function</span> <span class="at">toCartesian</span>(r<span class="op">,</span> theta) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-570" title="570">  <span class="cf">return</span> [r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(theta)<span class="op">,</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(theta)]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-571" title="571"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-572" title="572"></a>
<a class="sourceLine" id="cb29-573" title="573"><span class="kw">let</span> [r<span class="op">,</span> theta] <span class="op">=</span> <span class="at">toPolar</span>(<span class="fl">1.0</span><span class="op">,</span> <span class="fl">1.0</span>)<span class="op">;</span> <span class="co">// r == Math.sqrt(2); theta == Math.PI/4</span></a>
<a class="sourceLine" id="cb29-574" title="574"><span class="kw">let</span> [x<span class="op">,</span> y] <span class="op">=</span> <span class="at">toCartesian</span>(r<span class="op">,</span> theta)<span class="op">;</span> <span class="co">// [x, y] == [1.0, 1,0]</span></a>
<a class="sourceLine" id="cb29-575" title="575"></a>
<a class="sourceLine" id="cb29-576" title="576"><span class="co">// Print the name and value of each property of o.  Return undefined.</span></a>
<a class="sourceLine" id="cb29-577" title="577"><span class="kw">function</span> <span class="at">printprops</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-578" title="578">  <span class="cf">for</span> (<span class="kw">let</span> p <span class="kw">in</span> o) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-579" title="579">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span>p<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>o[p]<span class="sc">}\n</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-580" title="580">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-581" title="581"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-582" title="582"></a>
<a class="sourceLine" id="cb29-583" title="583"><span class="co">// Compute the distance between Cartesian points (x1,y1) and (x2,y2).</span></a>
<a class="sourceLine" id="cb29-584" title="584"><span class="kw">function</span> <span class="at">distance</span>(x1<span class="op">,</span> y1<span class="op">,</span> x2<span class="op">,</span> y2) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-585" title="585">  <span class="kw">let</span> dx <span class="op">=</span> x2 <span class="op">-</span> x1<span class="op">;</span></a>
<a class="sourceLine" id="cb29-586" title="586">  <span class="kw">let</span> dy <span class="op">=</span> y2 <span class="op">-</span> y1<span class="op">;</span></a>
<a class="sourceLine" id="cb29-587" title="587">  <span class="cf">return</span> <span class="va">Math</span>.<span class="at">sqrt</span>(dx <span class="op">*</span> dx <span class="op">+</span> dy <span class="op">*</span> dy)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-588" title="588"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-589" title="589"></a>
<a class="sourceLine" id="cb29-590" title="590"><span class="co">// A recursive function (one that calls itself) that computes factorials</span></a>
<a class="sourceLine" id="cb29-591" title="591"><span class="co">// Recall that x! is the product of x and all positive integers less than it.</span></a>
<a class="sourceLine" id="cb29-592" title="592"><span class="kw">function</span> <span class="at">factorial</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-593" title="593">  <span class="cf">if</span> (x <span class="op">&lt;=</span> <span class="dv">1</span>) <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-594" title="594">  <span class="cf">return</span> x <span class="op">*</span> <span class="at">factorial</span>(x <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-595" title="595"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-596" title="596"></a>
<a class="sourceLine" id="cb29-597" title="597"><span class="co">// Compute factorials and cache results as properties of the function itself.</span></a>
<a class="sourceLine" id="cb29-598" title="598"><span class="kw">function</span> <span class="at">factorial</span>(n) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-599" title="599">  <span class="cf">if</span> (<span class="va">Number</span>.<span class="at">isInteger</span>(n) <span class="op">&amp;&amp;</span> n <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-600" title="600">    <span class="co">// Positive integers only</span></a>
<a class="sourceLine" id="cb29-601" title="601">    <span class="cf">if</span> (<span class="op">!</span>(n <span class="kw">in</span> factorial)) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-602" title="602">      <span class="co">// If no cached result</span></a>
<a class="sourceLine" id="cb29-603" title="603">      factorial[n] <span class="op">=</span> n <span class="op">*</span> <span class="at">factorial</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Compute and cache it</span></a>
<a class="sourceLine" id="cb29-604" title="604">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-605" title="605">    <span class="cf">return</span> factorial[n]<span class="op">;</span> <span class="co">// Return the cached result</span></a>
<a class="sourceLine" id="cb29-606" title="606">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-607" title="607">    <span class="cf">return</span> <span class="kw">NaN</span><span class="op">;</span> <span class="co">// If input was bad</span></a>
<a class="sourceLine" id="cb29-608" title="608">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-609" title="609"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-610" title="610">factorial[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Initialize the cache to hold this base case.</span></a>
<a class="sourceLine" id="cb29-611" title="611"><span class="at">factorial</span>(<span class="dv">6</span>)<span class="op">;</span> <span class="co">// =&gt; 720</span></a>
<a class="sourceLine" id="cb29-612" title="612">factorial[<span class="dv">5</span>]<span class="op">;</span> <span class="co">// =&gt; 120; the call above caches this value</span></a>
<a class="sourceLine" id="cb29-613" title="613"></a>
<a class="sourceLine" id="cb29-614" title="614"><span class="kw">function</span> <span class="at">fetchSequentially</span>(urls) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-615" title="615">  <span class="co">// We&#39;ll store the URL bodies here as we fetch them</span></a>
<a class="sourceLine" id="cb29-616" title="616">  <span class="kw">const</span> bodies <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb29-617" title="617"></a>
<a class="sourceLine" id="cb29-618" title="618">  <span class="co">// Here&#39;s a Promise-returning function that fetches one body</span></a>
<a class="sourceLine" id="cb29-619" title="619">  <span class="kw">function</span> <span class="at">fetchOne</span>(url) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-620" title="620">    <span class="cf">return</span> <span class="at">fetch</span>(url)</a>
<a class="sourceLine" id="cb29-621" title="621">      .<span class="at">then</span>((response) <span class="kw">=&gt;</span> <span class="va">response</span>.<span class="at">text</span>())</a>
<a class="sourceLine" id="cb29-622" title="622">      .<span class="at">then</span>((body) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-623" title="623">        <span class="co">// We save the body to the array, and we&#39;re purposely</span></a>
<a class="sourceLine" id="cb29-624" title="624">        <span class="co">// omitting a return value here (returning undefined)</span></a>
<a class="sourceLine" id="cb29-625" title="625">        <span class="va">bodies</span>.<span class="at">push</span>(body)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-626" title="626">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-627" title="627">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-628" title="628"></a>
<a class="sourceLine" id="cb29-629" title="629">  <span class="co">// Start with a Promise that will fulfill right away (with value undefined)</span></a>
<a class="sourceLine" id="cb29-630" title="630">  <span class="kw">let</span> p <span class="op">=</span> <span class="va">Promise</span>.<span class="at">resolve</span>(<span class="kw">undefined</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-631" title="631"></a>
<a class="sourceLine" id="cb29-632" title="632">  <span class="co">// Now loop through the desired URLs, building a Promise chain</span></a>
<a class="sourceLine" id="cb29-633" title="633">  <span class="co">// of arbitrary length, fetching one URL at each stage of the chain</span></a>
<a class="sourceLine" id="cb29-634" title="634">  <span class="cf">for</span> (url <span class="kw">of</span> urls) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-635" title="635">    p <span class="op">=</span> <span class="va">p</span>.<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="at">fetchOne</span>(url))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-636" title="636">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-637" title="637"></a>
<a class="sourceLine" id="cb29-638" title="638">  <span class="co">// When the last Promise in that chain is fulfilled, then the</span></a>
<a class="sourceLine" id="cb29-639" title="639">  <span class="co">// bodies array is ready. So let&#39;s return a Promise for that</span></a>
<a class="sourceLine" id="cb29-640" title="640">  <span class="co">// bodies array. Note that we don&#39;t include any error handlers:</span></a>
<a class="sourceLine" id="cb29-641" title="641">  <span class="co">// we want to allow errors to propagate to the caller.</span></a>
<a class="sourceLine" id="cb29-642" title="642">  <span class="cf">return</span> <span class="va">p</span>.<span class="at">then</span>(() <span class="kw">=&gt;</span> bodies)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-643" title="643"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-644" title="644"></a>
<a class="sourceLine" id="cb29-645" title="645"><span class="at">fetch</span>(<span class="st">&quot;/api/users/current&quot;</span>) <span class="co">// Make an HTTP (or HTTPS) GET request.</span></a>
<a class="sourceLine" id="cb29-646" title="646">  .<span class="at">then</span>((response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-647" title="647">    <span class="co">// When we get a response, first check it</span></a>
<a class="sourceLine" id="cb29-648" title="648">    <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb29-649" title="649">      <span class="va">response</span>.<span class="at">ok</span> <span class="op">&amp;&amp;</span> <span class="co">// for a success code and the expected type.</span></a>
<a class="sourceLine" id="cb29-650" title="650">      <span class="va">response</span>.<span class="va">headers</span>.<span class="at">get</span>(<span class="st">&quot;Content-Type&quot;</span>) <span class="op">===</span> <span class="st">&quot;application/json&quot;</span></a>
<a class="sourceLine" id="cb29-651" title="651">    ) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-652" title="652">      <span class="cf">return</span> <span class="va">response</span>.<span class="at">json</span>()<span class="op">;</span> <span class="co">// Return a Promise for the body.</span></a>
<a class="sourceLine" id="cb29-653" title="653">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-654" title="654">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>( <span class="co">// Or throw an error.</span></a>
<a class="sourceLine" id="cb29-655" title="655">        <span class="vs">`Unexpected response status </span><span class="sc">${</span><span class="va">response</span>.<span class="at">status</span><span class="sc">}</span><span class="vs"> or content type`</span></a>
<a class="sourceLine" id="cb29-656" title="656">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb29-657" title="657">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-658" title="658">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb29-659" title="659">  .<span class="at">then</span>((currentUser) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-660" title="660">    <span class="co">// When the response.json() Promise resolves</span></a>
<a class="sourceLine" id="cb29-661" title="661">    <span class="at">displayUserInfo</span>(currentUser)<span class="op">;</span> <span class="co">// do something with the parsed body.</span></a>
<a class="sourceLine" id="cb29-662" title="662">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb29-663" title="663">  .<span class="at">catch</span>((error) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-664" title="664">    <span class="co">// Or if anything went wrong, just log the error.</span></a>
<a class="sourceLine" id="cb29-665" title="665">    <span class="co">// If the user&#39;s browser is offline, fetch() itself will reject.</span></a>
<a class="sourceLine" id="cb29-666" title="666">    <span class="co">// If the server returns a bad response then we throw an error above.</span></a>
<a class="sourceLine" id="cb29-667" title="667">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Error while fetching current user:&quot;</span><span class="op">,</span> error)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-668" title="668">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-669" title="669"></a>
<a class="sourceLine" id="cb29-670" title="670"><span class="co">// This function is like fetch(), but it adds support for a timeout</span></a>
<a class="sourceLine" id="cb29-671" title="671"><span class="co">// property in the options object and aborts the fetch if it is not complete</span></a>
<a class="sourceLine" id="cb29-672" title="672"><span class="co">// within the number of milliseconds specified by that property.</span></a>
<a class="sourceLine" id="cb29-673" title="673"><span class="kw">function</span> <span class="at">fetchWithTimeout</span>(url<span class="op">,</span> options <span class="op">=</span> <span class="op">{}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-674" title="674">  <span class="cf">if</span> (<span class="va">options</span>.<span class="at">timeout</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-675" title="675">    <span class="co">// If the timeout property exists and is nonzero</span></a>
<a class="sourceLine" id="cb29-676" title="676">    <span class="kw">let</span> controller <span class="op">=</span> <span class="kw">new</span> <span class="at">AbortController</span>()<span class="op">;</span> <span class="co">// Create a controller</span></a>
<a class="sourceLine" id="cb29-677" title="677">    <span class="va">options</span>.<span class="at">signal</span> <span class="op">=</span> <span class="va">controller</span>.<span class="at">signal</span><span class="op">;</span> <span class="co">// Set the signal property</span></a>
<a class="sourceLine" id="cb29-678" title="678">    <span class="co">// Start a timer that will send the abort signal after the specified</span></a>
<a class="sourceLine" id="cb29-679" title="679">    <span class="co">// number of milliseconds have passed. Note that we never cancel</span></a>
<a class="sourceLine" id="cb29-680" title="680">    <span class="co">// this timer. Calling abort() after the fetch is complete has</span></a>
<a class="sourceLine" id="cb29-681" title="681">    <span class="co">// no effect.</span></a>
<a class="sourceLine" id="cb29-682" title="682">    <span class="at">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-683" title="683">      <span class="va">controller</span>.<span class="at">abort</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-684" title="684">    <span class="op">},</span> <span class="va">options</span>.<span class="at">timeout</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-685" title="685">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-686" title="686">  <span class="co">// Now just perform a normal fetch</span></a>
<a class="sourceLine" id="cb29-687" title="687">  <span class="cf">return</span> <span class="at">fetch</span>(url<span class="op">,</span> options)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-688" title="688"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-689" title="689"></a>
<a class="sourceLine" id="cb29-690" title="690"><span class="kw">function</span><span class="op">*</span> <span class="at">fibonacciSequence</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-691" title="691">  <span class="kw">let</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-692" title="692">    y <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-693" title="693">  <span class="cf">for</span> (<span class="op">;;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-694" title="694">    <span class="kw">yield</span> y<span class="op">;</span></a>
<a class="sourceLine" id="cb29-695" title="695">    [x<span class="op">,</span> y] <span class="op">=</span> [y<span class="op">,</span> x <span class="op">+</span> y]<span class="op">;</span> <span class="co">// Note: destructuring assignment</span></a>
<a class="sourceLine" id="cb29-696" title="696">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-697" title="697"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-698" title="698"></a>
<a class="sourceLine" id="cb29-699" title="699"><span class="co">// Return an iterable object that filters the specified iterable,</span></a>
<a class="sourceLine" id="cb29-700" title="700"><span class="co">// iterating only those elements for which the predicate returns true</span></a>
<a class="sourceLine" id="cb29-701" title="701"><span class="kw">function</span> <span class="at">filter</span>(iterable<span class="op">,</span> predicate) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-702" title="702">  <span class="kw">let</span> iterator <span class="op">=</span> iterable[<span class="va">Symbol</span>.<span class="at">iterator</span>]()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-703" title="703">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-704" title="704">    <span class="co">// This object is both iterator and iterable</span></a>
<a class="sourceLine" id="cb29-705" title="705">    [<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-706" title="706">      <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-707" title="707">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-708" title="708">    <span class="at">next</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-709" title="709">      <span class="cf">for</span> (<span class="op">;;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-710" title="710">        <span class="kw">let</span> v <span class="op">=</span> <span class="va">iterator</span>.<span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-711" title="711">        <span class="cf">if</span> (<span class="va">v</span>.<span class="at">done</span> <span class="op">||</span> <span class="at">predicate</span>(<span class="va">v</span>.<span class="at">value</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-712" title="712">          <span class="cf">return</span> v<span class="op">;</span></a>
<a class="sourceLine" id="cb29-713" title="713">        <span class="op">}</span></a>
<a class="sourceLine" id="cb29-714" title="714">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-715" title="715">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-716" title="716">  <span class="op">};</span></a>
<a class="sourceLine" id="cb29-717" title="717"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-718" title="718"></a>
<a class="sourceLine" id="cb29-719" title="719"><span class="co">// Filter a range so we&#39;re left with only even numbers</span></a>
<a class="sourceLine" id="cb29-720" title="720">[...<span class="at">filter</span>(<span class="kw">new</span> <span class="at">Range</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> (x) <span class="kw">=&gt;</span> x <span class="op">%</span> <span class="dv">2</span> <span class="op">===</span> <span class="dv">0</span>)]<span class="op">;</span> <span class="co">// =&gt; [2,4,6,8,10]</span></a>
<a class="sourceLine" id="cb29-721" title="721"></a>
<a class="sourceLine" id="cb29-722" title="722"><span class="co">// Find all occurrences of a value x in an array a and return an array</span></a>
<a class="sourceLine" id="cb29-723" title="723"><span class="co">// of matching indexes</span></a>
<a class="sourceLine" id="cb29-724" title="724"><span class="kw">function</span> <span class="at">findall</span>(a<span class="op">,</span> x) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-725" title="725">  <span class="kw">let</span> results <span class="op">=</span> []<span class="op">,</span> <span class="co">// The array of indexes we&#39;ll return</span></a>
<a class="sourceLine" id="cb29-726" title="726">    len <span class="op">=</span> <span class="va">a</span>.<span class="at">length</span><span class="op">,</span> <span class="co">// The length of the array to be searched</span></a>
<a class="sourceLine" id="cb29-727" title="727">    pos <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// The position to search from</span></a>
<a class="sourceLine" id="cb29-728" title="728">  <span class="cf">while</span> (pos <span class="op">&lt;</span> len) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-729" title="729">    <span class="co">// While more elements to search...</span></a>
<a class="sourceLine" id="cb29-730" title="730">    pos <span class="op">=</span> <span class="va">a</span>.<span class="at">indexOf</span>(x<span class="op">,</span> pos)<span class="op">;</span> <span class="co">// Search</span></a>
<a class="sourceLine" id="cb29-731" title="731">    <span class="cf">if</span> (pos <span class="op">===</span> <span class="dv">-1</span>) <span class="cf">break</span><span class="op">;</span> <span class="co">// If nothing found, we&#39;re done.</span></a>
<a class="sourceLine" id="cb29-732" title="732">    <span class="va">results</span>.<span class="at">push</span>(pos)<span class="op">;</span> <span class="co">// Otherwise, store index in array</span></a>
<a class="sourceLine" id="cb29-733" title="733">    pos <span class="op">=</span> pos <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// And start next search at next element</span></a>
<a class="sourceLine" id="cb29-734" title="734">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-735" title="735">  <span class="cf">return</span> results<span class="op">;</span> <span class="co">// Return array of indexes</span></a>
<a class="sourceLine" id="cb29-736" title="736"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-737" title="737"></a>
<a class="sourceLine" id="cb29-738" title="738"><span class="co">// Return the document&#39;s cookies as a Map object.</span></a>
<a class="sourceLine" id="cb29-739" title="739"><span class="co">// Assume that cookie values are encoded with encodeURIComponent().</span></a>
<a class="sourceLine" id="cb29-740" title="740"><span class="kw">function</span> <span class="at">getCookies</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-741" title="741">  <span class="kw">let</span> cookies <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>()<span class="op">;</span> <span class="co">// The object we will return</span></a>
<a class="sourceLine" id="cb29-742" title="742">  <span class="kw">let</span> all <span class="op">=</span> <span class="va">document</span>.<span class="at">cookie</span><span class="op">;</span> <span class="co">// Get all cookies in one big string</span></a>
<a class="sourceLine" id="cb29-743" title="743">  <span class="kw">let</span> list <span class="op">=</span> <span class="va">all</span>.<span class="at">split</span>(<span class="st">&quot;; &quot;</span>)<span class="op">;</span> <span class="co">// Split into individual name/value pairs</span></a>
<a class="sourceLine" id="cb29-744" title="744">  <span class="cf">for</span> (<span class="kw">let</span> cookie <span class="kw">of</span> list) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-745" title="745">    <span class="co">// For each cookie in that list</span></a>
<a class="sourceLine" id="cb29-746" title="746">    <span class="cf">if</span> (<span class="op">!</span><span class="va">cookie</span>.<span class="at">includes</span>(<span class="st">&quot;=&quot;</span>)) <span class="cf">continue</span><span class="op">;</span> <span class="co">// Skip if there is no = sign</span></a>
<a class="sourceLine" id="cb29-747" title="747">    <span class="kw">let</span> p <span class="op">=</span> <span class="va">cookie</span>.<span class="at">indexOf</span>(<span class="st">&quot;=&quot;</span>)<span class="op">;</span> <span class="co">// Find the first = sign</span></a>
<a class="sourceLine" id="cb29-748" title="748">    <span class="kw">let</span> name <span class="op">=</span> <span class="va">cookie</span>.<span class="at">substring</span>(<span class="dv">0</span><span class="op">,</span> p)<span class="op">;</span> <span class="co">// Get cookie name</span></a>
<a class="sourceLine" id="cb29-749" title="749">    <span class="kw">let</span> value <span class="op">=</span> <span class="va">cookie</span>.<span class="at">substring</span>(p <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Get cookie value</span></a>
<a class="sourceLine" id="cb29-750" title="750">    value <span class="op">=</span> <span class="at">decodeURIComponent</span>(value)<span class="op">;</span> <span class="co">// Decode the value</span></a>
<a class="sourceLine" id="cb29-751" title="751">    <span class="va">cookies</span>.<span class="at">set</span>(name<span class="op">,</span> value)<span class="op">;</span> <span class="co">// Remember cookie name and value</span></a>
<a class="sourceLine" id="cb29-752" title="752">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-753" title="753">  <span class="cf">return</span> cookies<span class="op">;</span></a>
<a class="sourceLine" id="cb29-754" title="754"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-755" title="755"></a>
<a class="sourceLine" id="cb29-756" title="756"><span class="kw">const</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;http&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-757" title="757"></a>
<a class="sourceLine" id="cb29-758" title="758"><span class="kw">function</span> <span class="at">getJSON</span>(url) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-759" title="759">  <span class="co">// Create and return a new Promise</span></a>
<a class="sourceLine" id="cb29-760" title="760">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-761" title="761">    <span class="co">// Start an HTTP GET request for the specified URL</span></a>
<a class="sourceLine" id="cb29-762" title="762">    request <span class="op">=</span> <span class="va">http</span>.<span class="at">get</span>(url<span class="op">,</span> (response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-763" title="763">      <span class="co">// called when response starts</span></a>
<a class="sourceLine" id="cb29-764" title="764">      <span class="co">// Reject the Promise if the HTTP status is wrong</span></a>
<a class="sourceLine" id="cb29-765" title="765">      <span class="cf">if</span> (<span class="va">response</span>.<span class="at">statusCode</span> <span class="op">!==</span> <span class="dv">200</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-766" title="766">        <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="vs">`HTTP status </span><span class="sc">${</span><span class="va">response</span>.<span class="at">statusCode</span><span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-767" title="767">        <span class="va">response</span>.<span class="at">resume</span>()<span class="op">;</span> <span class="co">// so we don&#39;t leak memory</span></a>
<a class="sourceLine" id="cb29-768" title="768">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-769" title="769">      <span class="co">// And reject if the response headers are wrong</span></a>
<a class="sourceLine" id="cb29-770" title="770">      <span class="cf">else</span> <span class="cf">if</span> (<span class="va">response</span>.<span class="at">headers</span>[<span class="st">&quot;content-type&quot;</span>] <span class="op">!==</span> <span class="st">&quot;application/json&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-771" title="771">        <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Invalid content-type&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-772" title="772">        <span class="va">response</span>.<span class="at">resume</span>()<span class="op">;</span> <span class="co">// don&#39;t leak memory</span></a>
<a class="sourceLine" id="cb29-773" title="773">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-774" title="774">        <span class="co">// Otherwise, register events to read the body of the response</span></a>
<a class="sourceLine" id="cb29-775" title="775">        <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-776" title="776">        <span class="va">response</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf-8&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-777" title="777">        <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;data&quot;</span><span class="op">,</span> (chunk) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-778" title="778">          body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb29-779" title="779">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-780" title="780">        <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-781" title="781">          <span class="co">// When the response body is complete, try to parse it</span></a>
<a class="sourceLine" id="cb29-782" title="782">          <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-783" title="783">            <span class="kw">let</span> parsed <span class="op">=</span> <span class="va">JSON</span>.<span class="at">parse</span>(body)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-784" title="784">            <span class="co">// If it parsed successfully, fulfill the Promise</span></a>
<a class="sourceLine" id="cb29-785" title="785">            <span class="at">resolve</span>(parsed)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-786" title="786">          <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-787" title="787">            <span class="co">// If parsing failed, reject the Promise</span></a>
<a class="sourceLine" id="cb29-788" title="788">            <span class="at">reject</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-789" title="789">          <span class="op">}</span></a>
<a class="sourceLine" id="cb29-790" title="790">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-791" title="791">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-792" title="792">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-793" title="793">    <span class="co">// We also reject the Promise if the request fails before we</span></a>
<a class="sourceLine" id="cb29-794" title="794">    <span class="co">// even get a response (such as when the network is down)</span></a>
<a class="sourceLine" id="cb29-795" title="795">    <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (error) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-796" title="796">      <span class="at">reject</span>(error)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-797" title="797">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-798" title="798">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-799" title="799"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-800" title="800"></a>
<a class="sourceLine" id="cb29-801" title="801"><span class="kw">const</span> https <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;https&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-802" title="802"></a>
<a class="sourceLine" id="cb29-803" title="803"><span class="co">// Read the text content of the URL and asynchronously pass it to the callback.</span></a>
<a class="sourceLine" id="cb29-804" title="804"><span class="kw">function</span> <span class="at">getText</span>(url<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-805" title="805">  <span class="co">// Start an HTTP GET request for the URL</span></a>
<a class="sourceLine" id="cb29-806" title="806">  request <span class="op">=</span> <span class="va">https</span>.<span class="at">get</span>(url)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-807" title="807"></a>
<a class="sourceLine" id="cb29-808" title="808">  <span class="co">// Register a function to handle the &quot;response&quot; event.</span></a>
<a class="sourceLine" id="cb29-809" title="809">  <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;response&quot;</span><span class="op">,</span> (response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-810" title="810">    <span class="co">// The response event means that response headers have been received</span></a>
<a class="sourceLine" id="cb29-811" title="811">    <span class="kw">let</span> httpStatus <span class="op">=</span> <span class="va">response</span>.<span class="at">statusCode</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-812" title="812"></a>
<a class="sourceLine" id="cb29-813" title="813">    <span class="co">// The body of the HTTP response has not been received yet.</span></a>
<a class="sourceLine" id="cb29-814" title="814">    <span class="co">// So we register more event handlers to to be called when it arrives.</span></a>
<a class="sourceLine" id="cb29-815" title="815">    <span class="va">response</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf-8&quot;</span>)<span class="op">;</span> <span class="co">// We&#39;re expecting Unicode text</span></a>
<a class="sourceLine" id="cb29-816" title="816">    <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// which we will accumulate here.</span></a>
<a class="sourceLine" id="cb29-817" title="817"></a>
<a class="sourceLine" id="cb29-818" title="818">    <span class="co">// This event handler is called when a chunk of the body is ready</span></a>
<a class="sourceLine" id="cb29-819" title="819">    <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;data&quot;</span><span class="op">,</span> (chunk) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-820" title="820">      body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb29-821" title="821">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-822" title="822"></a>
<a class="sourceLine" id="cb29-823" title="823">    <span class="co">// This event handler is called when the response is complete</span></a>
<a class="sourceLine" id="cb29-824" title="824">    <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-825" title="825">      <span class="cf">if</span> (httpStatus <span class="op">===</span> <span class="dv">200</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-826" title="826">        <span class="co">// If the HTTP response was good</span></a>
<a class="sourceLine" id="cb29-827" title="827">        <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> body)<span class="op">;</span> <span class="co">// Pass response body to the callback</span></a>
<a class="sourceLine" id="cb29-828" title="828">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-829" title="829">        <span class="co">// Otherwise pass an error</span></a>
<a class="sourceLine" id="cb29-830" title="830">        <span class="at">callback</span>(httpStatus<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-831" title="831">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-832" title="832">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-833" title="833">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-834" title="834"></a>
<a class="sourceLine" id="cb29-835" title="835">  <span class="co">// We also register an event handler for lower-level network errors</span></a>
<a class="sourceLine" id="cb29-836" title="836">  <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-837" title="837">    <span class="at">callback</span>(err<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-838" title="838">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-839" title="839"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-840" title="840"></a>
<a class="sourceLine" id="cb29-841" title="841"><span class="kw">function</span> <span class="at">glob</span>(strings<span class="op">,</span> ...<span class="at">values</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-842" title="842">  <span class="co">// Assemble the strings and values into a single string</span></a>
<a class="sourceLine" id="cb29-843" title="843">  <span class="kw">let</span> s <span class="op">=</span> strings[<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-844" title="844">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">values</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-845" title="845">    s <span class="op">+=</span> values[i] <span class="op">+</span> strings[i <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-846" title="846">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-847" title="847">  <span class="co">// Return a parsed representation of that string</span></a>
<a class="sourceLine" id="cb29-848" title="848">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Glob</span>(s)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-849" title="849"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-850" title="850"></a>
<a class="sourceLine" id="cb29-851" title="851"><span class="kw">let</span> root <span class="op">=</span> <span class="st">&quot;/tmp&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-852" title="852"><span class="kw">let</span> filePattern <span class="op">=</span> glob<span class="vs">`</span><span class="sc">${</span>root<span class="sc">}</span><span class="vs">/*.html`</span><span class="op">;</span> <span class="co">// A RegExp alternative</span></a>
<a class="sourceLine" id="cb29-853" title="853"><span class="st">&quot;/tmp/test.html&quot;</span>.<span class="at">match</span>(filePattern)[<span class="dv">1</span>]<span class="op">;</span> <span class="co">// =&gt; &quot;test&quot;</span></a>
<a class="sourceLine" id="cb29-854" title="854"></a>
<a class="sourceLine" id="cb29-855" title="855"><span class="kw">const</span> stream <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;stream&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-856" title="856"></a>
<a class="sourceLine" id="cb29-857" title="857"><span class="kw">class</span> GrepStream <span class="kw">extends</span> <span class="va">stream</span>.<span class="at">Transform</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-858" title="858">  <span class="at">constructor</span>(pattern) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-859" title="859">    <span class="kw">super</span>(<span class="op">{</span> <span class="dt">decodeStrings</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>)<span class="op">;</span> <span class="co">// Don&#39;t convert strings back to buffers</span></a>
<a class="sourceLine" id="cb29-860" title="860">    <span class="kw">this</span>.<span class="at">pattern</span> <span class="op">=</span> pattern<span class="op">;</span> <span class="co">// The regular expression we want to match</span></a>
<a class="sourceLine" id="cb29-861" title="861">    <span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// Any remnant of the last chunk of data</span></a>
<a class="sourceLine" id="cb29-862" title="862">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-863" title="863"></a>
<a class="sourceLine" id="cb29-864" title="864">  <span class="co">// This method is invoked when there is a string ready to be</span></a>
<a class="sourceLine" id="cb29-865" title="865">  <span class="co">// transformed. It should pass transformed data to the specified</span></a>
<a class="sourceLine" id="cb29-866" title="866">  <span class="co">// callback function. We expect string input so this stream should</span></a>
<a class="sourceLine" id="cb29-867" title="867">  <span class="co">// only be connected to readable streams that have had</span></a>
<a class="sourceLine" id="cb29-868" title="868">  <span class="co">// setEncoding() called on them.</span></a>
<a class="sourceLine" id="cb29-869" title="869">  <span class="at">_transform</span>(chunk<span class="op">,</span> encoding<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-870" title="870">    <span class="cf">if</span> (<span class="kw">typeof</span> chunk <span class="op">!==</span> <span class="st">&quot;string&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-871" title="871">      <span class="at">callback</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Expected a string but got a buffer&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-872" title="872">      <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-873" title="873">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-874" title="874">    <span class="co">// Add the chunk to any previously incomplete line and break</span></a>
<a class="sourceLine" id="cb29-875" title="875">    <span class="co">// everything into lines</span></a>
<a class="sourceLine" id="cb29-876" title="876">    <span class="kw">let</span> lines <span class="op">=</span> (<span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">+</span> chunk).<span class="at">split</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-877" title="877"></a>
<a class="sourceLine" id="cb29-878" title="878">    <span class="co">// The last element of the array is the new incomplete line</span></a>
<a class="sourceLine" id="cb29-879" title="879">    <span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">=</span> <span class="va">lines</span>.<span class="at">pop</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-880" title="880"></a>
<a class="sourceLine" id="cb29-881" title="881">    <span class="co">// Find all matching lines</span></a>
<a class="sourceLine" id="cb29-882" title="882">    <span class="kw">let</span> output <span class="op">=</span> lines <span class="co">// Start with all complete lines,</span></a>
<a class="sourceLine" id="cb29-883" title="883">      .<span class="at">filter</span>((l) <span class="kw">=&gt;</span> <span class="kw">this</span>.<span class="va">pattern</span>.<span class="at">test</span>(l)) <span class="co">// filter them for matches,</span></a>
<a class="sourceLine" id="cb29-884" title="884">      .<span class="at">join</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span> <span class="co">// and join them back up.</span></a>
<a class="sourceLine" id="cb29-885" title="885"></a>
<a class="sourceLine" id="cb29-886" title="886">    <span class="co">// If anything matched, add a final newline</span></a>
<a class="sourceLine" id="cb29-887" title="887">    <span class="cf">if</span> (output) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-888" title="888">      output <span class="op">+=</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-889" title="889">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-890" title="890"></a>
<a class="sourceLine" id="cb29-891" title="891">    <span class="co">// Always call the callback even if there is no output</span></a>
<a class="sourceLine" id="cb29-892" title="892">    <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> output)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-893" title="893">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-894" title="894"></a>
<a class="sourceLine" id="cb29-895" title="895">  <span class="co">// This is called right before the stream is closed.</span></a>
<a class="sourceLine" id="cb29-896" title="896">  <span class="co">// It is our chance to write out any last data.</span></a>
<a class="sourceLine" id="cb29-897" title="897">  <span class="at">_flush</span>(callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-898" title="898">    <span class="co">// If we still have an incomplete line, and it matches</span></a>
<a class="sourceLine" id="cb29-899" title="899">    <span class="co">// pass it to the callback</span></a>
<a class="sourceLine" id="cb29-900" title="900">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">pattern</span>.<span class="at">test</span>(<span class="kw">this</span>.<span class="at">incompleteLine</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-901" title="901">      <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">incompleteLine</span> <span class="op">+</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-902" title="902">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-903" title="903">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-904" title="904"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-905" title="905"></a>
<a class="sourceLine" id="cb29-906" title="906"><span class="co">// Now we can write a program like &#39;grep&#39; with this class.</span></a>
<a class="sourceLine" id="cb29-907" title="907"><span class="kw">let</span> pattern <span class="op">=</span> <span class="kw">new</span> <span class="at">RegExp</span>(<span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>])<span class="op">;</span> <span class="co">// Get a RegExp from command line.</span></a>
<a class="sourceLine" id="cb29-908" title="908"><span class="va">process</span>.<span class="at">stdin</span> <span class="co">// Start with standard input,</span></a>
<a class="sourceLine" id="cb29-909" title="909">  .<span class="at">setEncoding</span>(<span class="st">&quot;utf8&quot;</span>) <span class="co">// read it as Unicode strings,</span></a>
<a class="sourceLine" id="cb29-910" title="910">  .<span class="at">pipe</span>(<span class="kw">new</span> <span class="at">GrepStream</span>(pattern)) <span class="co">// pipe it to our GrepStream,</span></a>
<a class="sourceLine" id="cb29-911" title="911">  .<span class="at">pipe</span>(<span class="va">process</span>.<span class="at">stdout</span>) <span class="co">// and pipe that to standard out.</span></a>
<a class="sourceLine" id="cb29-912" title="912">  .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">process</span>.<span class="at">exit</span>())<span class="op">;</span> <span class="co">// Exit gracefully if stdout closes.</span></a>
<a class="sourceLine" id="cb29-913" title="913"></a>
<a class="sourceLine" id="cb29-914" title="914"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-915" title="915"><span class="kw">const</span> zlib <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;zlib&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-916" title="916"></a>
<a class="sourceLine" id="cb29-917" title="917"><span class="kw">function</span> <span class="at">gzip</span>(filename<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-918" title="918">  <span class="co">// Create the streams</span></a>
<a class="sourceLine" id="cb29-919" title="919">  <span class="kw">let</span> source <span class="op">=</span> <span class="va">fs</span>.<span class="at">createReadStream</span>(filename)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-920" title="920">  <span class="kw">let</span> destination <span class="op">=</span> <span class="va">fs</span>.<span class="at">createWriteStream</span>(filename <span class="op">+</span> <span class="st">&quot;.gz&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-921" title="921">  <span class="kw">let</span> gzipper <span class="op">=</span> <span class="va">zlib</span>.<span class="at">createGzip</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-922" title="922"></a>
<a class="sourceLine" id="cb29-923" title="923">  <span class="co">// Set up the pipeline</span></a>
<a class="sourceLine" id="cb29-924" title="924">  source</a>
<a class="sourceLine" id="cb29-925" title="925">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> callback) <span class="co">// call callback on read error</span></a>
<a class="sourceLine" id="cb29-926" title="926">    .<span class="at">pipe</span>(gzipper)</a>
<a class="sourceLine" id="cb29-927" title="927">    .<span class="at">pipe</span>(destination)</a>
<a class="sourceLine" id="cb29-928" title="928">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> callback) <span class="co">// call callback on write error</span></a>
<a class="sourceLine" id="cb29-929" title="929">    .<span class="at">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> callback)<span class="op">;</span> <span class="co">// call callback when writing is complete</span></a>
<a class="sourceLine" id="cb29-930" title="930"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-931" title="931"></a>
<a class="sourceLine" id="cb29-932" title="932"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-933" title="933"><span class="kw">const</span> crypto <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;crypto&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-934" title="934"></a>
<a class="sourceLine" id="cb29-935" title="935"><span class="co">// Compute a sha256 hash of the contents of the named file and pass the</span></a>
<a class="sourceLine" id="cb29-936" title="936"><span class="co">// hash (as a string) to the specified error-first callback function.</span></a>
<a class="sourceLine" id="cb29-937" title="937"><span class="kw">function</span> <span class="at">sha256</span>(filename<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-938" title="938">  <span class="kw">let</span> input <span class="op">=</span> <span class="va">fs</span>.<span class="at">createReadStream</span>(filename)<span class="op">;</span> <span class="co">// The data stream.</span></a>
<a class="sourceLine" id="cb29-939" title="939">  <span class="kw">let</span> hasher <span class="op">=</span> <span class="va">crypto</span>.<span class="at">createHash</span>(<span class="st">&quot;sha256&quot;</span>)<span class="op">;</span> <span class="co">// For computing the hash.</span></a>
<a class="sourceLine" id="cb29-940" title="940"></a>
<a class="sourceLine" id="cb29-941" title="941">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;readable&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-942" title="942">    <span class="co">// When there is data ready to read</span></a>
<a class="sourceLine" id="cb29-943" title="943">    <span class="kw">let</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb29-944" title="944">    <span class="cf">while</span> ((chunk <span class="op">=</span> <span class="va">input</span>.<span class="at">read</span>())) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-945" title="945">      <span class="co">// Read a chunk, and if non-null,</span></a>
<a class="sourceLine" id="cb29-946" title="946">      <span class="va">hasher</span>.<span class="at">update</span>(chunk)<span class="op">;</span> <span class="co">// pass it to the hasher,</span></a>
<a class="sourceLine" id="cb29-947" title="947">    <span class="op">}</span> <span class="co">// and keep looping until not readable</span></a>
<a class="sourceLine" id="cb29-948" title="948">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-949" title="949">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-950" title="950">    <span class="co">// At the end of the stream,</span></a>
<a class="sourceLine" id="cb29-951" title="951">    <span class="kw">let</span> hash <span class="op">=</span> <span class="va">hasher</span>.<span class="at">digest</span>(<span class="st">&quot;hex&quot;</span>)<span class="op">;</span> <span class="co">// compute the hash,</span></a>
<a class="sourceLine" id="cb29-952" title="952">    <span class="at">callback</span>(<span class="kw">null</span><span class="op">,</span> hash)<span class="op">;</span> <span class="co">// and pass it to the callback.</span></a>
<a class="sourceLine" id="cb29-953" title="953">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-954" title="954">  <span class="va">input</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> callback)<span class="op">;</span> <span class="co">// On error, call callback</span></a>
<a class="sourceLine" id="cb29-955" title="955"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-956" title="956"></a>
<a class="sourceLine" id="cb29-957" title="957"><span class="co">// Here&#39;s a simple command-line utility to compute the hash of a file</span></a>
<a class="sourceLine" id="cb29-958" title="958"><span class="at">sha256</span>(<span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>]<span class="op">,</span> (err<span class="op">,</span> hash) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-959" title="959">  <span class="co">// Pass filename from command line.</span></a>
<a class="sourceLine" id="cb29-960" title="960">  <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-961" title="961">    <span class="co">// If we get an error</span></a>
<a class="sourceLine" id="cb29-962" title="962">    <span class="va">console</span>.<span class="at">error</span>(<span class="va">err</span>.<span class="at">toString</span>())<span class="op">;</span> <span class="co">// print it as an error.</span></a>
<a class="sourceLine" id="cb29-963" title="963">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-964" title="964">    <span class="co">// Otherwise,</span></a>
<a class="sourceLine" id="cb29-965" title="965">    <span class="va">console</span>.<span class="at">log</span>(hash)<span class="op">;</span> <span class="co">// print the hash string.</span></a>
<a class="sourceLine" id="cb29-966" title="966">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-967" title="967"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-968" title="968"></a>
<a class="sourceLine" id="cb29-969" title="969"><span class="kw">function</span> <span class="at">html</span>(strings<span class="op">,</span> ...<span class="at">values</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-970" title="970">  <span class="co">// Convert each value to a string and escape special HTML characters</span></a>
<a class="sourceLine" id="cb29-971" title="971">  <span class="kw">let</span> escaped <span class="op">=</span> <span class="va">values</span>.<span class="at">map</span>((v) <span class="kw">=&gt;</span></a>
<a class="sourceLine" id="cb29-972" title="972">    <span class="at">String</span>(v)</a>
<a class="sourceLine" id="cb29-973" title="973">      .<span class="at">replace</span>(<span class="st">&quot;&amp;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;amp;&quot;</span>)</a>
<a class="sourceLine" id="cb29-974" title="974">      .<span class="at">replace</span>(<span class="st">&quot;&lt;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;lt;&quot;</span>)</a>
<a class="sourceLine" id="cb29-975" title="975">      .<span class="at">replace</span>(<span class="st">&quot;&gt;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;gt;&quot;</span>)</a>
<a class="sourceLine" id="cb29-976" title="976">      .<span class="at">replace</span>(<span class="st">&#39;&quot;&#39;</span><span class="op">,</span> <span class="st">&quot;&amp;quot;&quot;</span>)</a>
<a class="sourceLine" id="cb29-977" title="977">      .<span class="at">replace</span>(<span class="st">&quot;&#39;&quot;</span><span class="op">,</span> <span class="st">&quot;&amp;#39;&quot;</span>)</a>
<a class="sourceLine" id="cb29-978" title="978">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb29-979" title="979"></a>
<a class="sourceLine" id="cb29-980" title="980">  <span class="co">// Return the concatenated strings and escaped values</span></a>
<a class="sourceLine" id="cb29-981" title="981">  <span class="kw">let</span> result <span class="op">=</span> strings[<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-982" title="982">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">escaped</span>.<span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-983" title="983">    result <span class="op">+=</span> escaped[i] <span class="op">+</span> strings[i <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-984" title="984">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-985" title="985">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb29-986" title="986"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-987" title="987"></a>
<a class="sourceLine" id="cb29-988" title="988"><span class="kw">let</span> operator <span class="op">=</span> <span class="st">&quot;&lt;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-989" title="989">html<span class="vs">`&lt;b&gt;x </span><span class="sc">${</span>operator<span class="sc">}</span><span class="vs"> y&lt;/b&gt;`</span><span class="op">;</span> <span class="co">// =&gt; &quot;&lt;b&gt;x &amp;lt; y&lt;/b&gt;&quot;</span></a>
<a class="sourceLine" id="cb29-990" title="990"></a>
<a class="sourceLine" id="cb29-991" title="991"><span class="kw">let</span> kind <span class="op">=</span> <span class="st">&quot;game&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-992" title="992">  name <span class="op">=</span> <span class="st">&quot;D&amp;D&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-993" title="993">html<span class="vs">`&lt;div class=&quot;</span><span class="sc">${</span>kind<span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span> <span class="co">// =&gt;&#39;&lt;div class=&quot;game&quot;&gt;D&amp;amp;D&lt;/div&gt;&#39;</span></a>
<a class="sourceLine" id="cb29-994" title="994"></a>
<a class="sourceLine" id="cb29-995" title="995"><span class="co">// We use a Proxy to create an object that appears to have every</span></a>
<a class="sourceLine" id="cb29-996" title="996"><span class="co">// possible property, with the value of each property equal to its name</span></a>
<a class="sourceLine" id="cb29-997" title="997"><span class="kw">let</span> identity <span class="op">=</span> <span class="kw">new</span> <span class="at">Proxy</span>(</a>
<a class="sourceLine" id="cb29-998" title="998">  <span class="op">{},</span></a>
<a class="sourceLine" id="cb29-999" title="999">  <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1000" title="1000">    <span class="co">// Every property has its own name as its value</span></a>
<a class="sourceLine" id="cb29-1001" title="1001">    <span class="at">get</span>(o<span class="op">,</span> name<span class="op">,</span> target) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1002" title="1002">      <span class="cf">return</span> name<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1003" title="1003">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1004" title="1004">    <span class="co">// Every property name is defined</span></a>
<a class="sourceLine" id="cb29-1005" title="1005">    <span class="at">has</span>(o<span class="op">,</span> name) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1006" title="1006">      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1007" title="1007">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1008" title="1008">    <span class="co">// There are too many properties to enumerate, so we just throw</span></a>
<a class="sourceLine" id="cb29-1009" title="1009">    <span class="at">ownKeys</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1010" title="1010">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">RangeError</span>(<span class="st">&quot;Infinite number of properties&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1011" title="1011">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1012" title="1012">    <span class="co">// All properties exist and are not writable, configurable or enumerable.</span></a>
<a class="sourceLine" id="cb29-1013" title="1013">    <span class="at">getOwnPropertyDescriptor</span>(o<span class="op">,</span> name) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1014" title="1014">      <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1015" title="1015">        <span class="dt">value</span><span class="op">:</span> name<span class="op">,</span></a>
<a class="sourceLine" id="cb29-1016" title="1016">        <span class="dt">enumerable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1017" title="1017">        <span class="dt">writable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1018" title="1018">        <span class="dt">configurable</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1019" title="1019">      <span class="op">};</span></a>
<a class="sourceLine" id="cb29-1020" title="1020">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1021" title="1021">    <span class="co">// All properties are read-only so they can&#39;t be set</span></a>
<a class="sourceLine" id="cb29-1022" title="1022">    <span class="at">set</span>(o<span class="op">,</span> name<span class="op">,</span> value<span class="op">,</span> target) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1023" title="1023">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1024" title="1024">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1025" title="1025">    <span class="co">// All properties are non-configurable, so they can&#39;t be deleted</span></a>
<a class="sourceLine" id="cb29-1026" title="1026">    <span class="at">deleteProperty</span>(o<span class="op">,</span> name) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1027" title="1027">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1028" title="1028">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1029" title="1029">    <span class="co">// All properties exist and are non-configurable so we can&#39;t define more</span></a>
<a class="sourceLine" id="cb29-1030" title="1030">    <span class="at">defineProperty</span>(o<span class="op">,</span> name<span class="op">,</span> desc) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1031" title="1031">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1032" title="1032">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1033" title="1033">    <span class="co">// In effect, this means that the object is not extensible</span></a>
<a class="sourceLine" id="cb29-1034" title="1034">    <span class="at">isExtensible</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1035" title="1035">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1036" title="1036">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1037" title="1037">    <span class="co">// All properties are already defined on this object, so it couldn&#39;t</span></a>
<a class="sourceLine" id="cb29-1038" title="1038">    <span class="co">// inherit anything even if it did have a prototype object.</span></a>
<a class="sourceLine" id="cb29-1039" title="1039">    <span class="at">getPrototypeOf</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1040" title="1040">      <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1041" title="1041">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1042" title="1042">    <span class="co">// The object is not extensible, so we can&#39;t change the prototype</span></a>
<a class="sourceLine" id="cb29-1043" title="1043">    <span class="at">setPrototypeOf</span>(o<span class="op">,</span> proto) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1044" title="1044">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1045" title="1045">    <span class="op">},</span></a>
<a class="sourceLine" id="cb29-1046" title="1046">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1047" title="1047">)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1048" title="1048"></a>
<a class="sourceLine" id="cb29-1049" title="1049"><span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; &quot;x&quot;</span></a>
<a class="sourceLine" id="cb29-1050" title="1050"><span class="va">identity</span>.<span class="at">toString</span><span class="op">;</span> <span class="co">// =&gt; &quot;toString&quot;</span></a>
<a class="sourceLine" id="cb29-1051" title="1051">identity[<span class="dv">0</span>]<span class="op">;</span> <span class="co">// =&gt; &quot;0&quot;</span></a>
<a class="sourceLine" id="cb29-1052" title="1052"><span class="va">identity</span>.<span class="at">x</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Setting properties has no effect</span></a>
<a class="sourceLine" id="cb29-1053" title="1053"><span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; &quot;x&quot;</span></a>
<a class="sourceLine" id="cb29-1054" title="1054"><span class="kw">delete</span> <span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; false: can&#39;t delete properties either</span></a>
<a class="sourceLine" id="cb29-1055" title="1055"><span class="va">identity</span>.<span class="at">x</span><span class="op">;</span> <span class="co">// =&gt; &quot;x&quot;</span></a>
<a class="sourceLine" id="cb29-1056" title="1056"><span class="va">Object</span>.<span class="at">keys</span>(identity)<span class="op">;</span> <span class="co">// !RangeError: can&#39;t list all the keys</span></a>
<a class="sourceLine" id="cb29-1057" title="1057"><span class="cf">for</span> (<span class="kw">let</span> p <span class="kw">of</span> identity)<span class="op">;</span> <span class="co">// !RangeError</span></a>
<a class="sourceLine" id="cb29-1058" title="1058"></a>
<a class="sourceLine" id="cb29-1059" title="1059"><span class="co">// Asynchronously load and execute a script from a specified URL</span></a>
<a class="sourceLine" id="cb29-1060" title="1060"><span class="co">// Returns a Promise that resolves when the script has loaded.</span></a>
<a class="sourceLine" id="cb29-1061" title="1061"><span class="kw">function</span> <span class="at">importScript</span>(url) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1062" title="1062">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1063" title="1063">    <span class="kw">let</span> s <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;script&quot;</span>)<span class="op">;</span> <span class="co">// Create a &lt;script&gt; element</span></a>
<a class="sourceLine" id="cb29-1064" title="1064">    <span class="va">s</span>.<span class="at">onload</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1065" title="1065">      <span class="at">resolve</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1066" title="1066">    <span class="op">};</span> <span class="co">// Resolve promise when loaded</span></a>
<a class="sourceLine" id="cb29-1067" title="1067">    <span class="va">s</span>.<span class="at">onerror</span> <span class="op">=</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1068" title="1068">      <span class="at">reject</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1069" title="1069">    <span class="op">};</span> <span class="co">// Reject on failure</span></a>
<a class="sourceLine" id="cb29-1070" title="1070">    <span class="va">s</span>.<span class="at">src</span> <span class="op">=</span> url<span class="op">;</span> <span class="co">// Set the script URL</span></a>
<a class="sourceLine" id="cb29-1071" title="1071">    <span class="va">document</span>.<span class="va">head</span>.<span class="at">append</span>(s)<span class="op">;</span> <span class="co">// Add &lt;script&gt; to document</span></a>
<a class="sourceLine" id="cb29-1072" title="1072">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1073" title="1073"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-1074" title="1074"></a>
<a class="sourceLine" id="cb29-1075" title="1075"><span class="va">customElements</span>.<span class="at">define</span>(</a>
<a class="sourceLine" id="cb29-1076" title="1076">  <span class="st">&quot;inline-circle&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1077" title="1077">  <span class="kw">class</span> InlineCircle <span class="kw">extends</span> HTMLElement <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1078" title="1078">    <span class="co">// The browser calls this method when an &lt;inline-circle&gt; element</span></a>
<a class="sourceLine" id="cb29-1079" title="1079">    <span class="co">// is inserted into the document. There is also a disconnectedCallback()</span></a>
<a class="sourceLine" id="cb29-1080" title="1080">    <span class="co">// that we don&#39;t need in this example.</span></a>
<a class="sourceLine" id="cb29-1081" title="1081">    <span class="at">connectedCallback</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1082" title="1082">      <span class="co">// Set the styles needed to create circles</span></a>
<a class="sourceLine" id="cb29-1083" title="1083">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">display</span> <span class="op">=</span> <span class="st">&quot;inline-block&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1084" title="1084">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">borderRadius</span> <span class="op">=</span> <span class="st">&quot;50%&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1085" title="1085">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">border</span> <span class="op">=</span> <span class="st">&quot;solid black 1px&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1086" title="1086">      <span class="kw">this</span>.<span class="va">style</span>.<span class="at">transform</span> <span class="op">=</span> <span class="st">&quot;translateY(10%)&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1087" title="1087"></a>
<a class="sourceLine" id="cb29-1088" title="1088">      <span class="co">// If there is not already a size defined, set a default size</span></a>
<a class="sourceLine" id="cb29-1089" title="1089">      <span class="co">// that is based on the current font size.</span></a>
<a class="sourceLine" id="cb29-1090" title="1090">      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="va">style</span>.<span class="at">width</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1091" title="1091">        <span class="kw">this</span>.<span class="va">style</span>.<span class="at">width</span> <span class="op">=</span> <span class="st">&quot;0.8em&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1092" title="1092">        <span class="kw">this</span>.<span class="va">style</span>.<span class="at">height</span> <span class="op">=</span> <span class="st">&quot;0.8em&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1093" title="1093">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1094" title="1094">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1095" title="1095"></a>
<a class="sourceLine" id="cb29-1096" title="1096">    <span class="co">// The static observedAttributes property specifies which attributes</span></a>
<a class="sourceLine" id="cb29-1097" title="1097">    <span class="co">// we want to be notified about changes to. (We use a getter here since</span></a>
<a class="sourceLine" id="cb29-1098" title="1098">    <span class="co">// we can only use &quot;static&quot; with methods.)</span></a>
<a class="sourceLine" id="cb29-1099" title="1099">    <span class="kw">static</span> get <span class="at">observedAttributes</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1100" title="1100">      <span class="cf">return</span> [<span class="st">&quot;diameter&quot;</span><span class="op">,</span> <span class="st">&quot;color&quot;</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1101" title="1101">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1102" title="1102"></a>
<a class="sourceLine" id="cb29-1103" title="1103">    <span class="co">// This callback is invoked when one of the attributes listed above</span></a>
<a class="sourceLine" id="cb29-1104" title="1104">    <span class="co">// changes, either when the custom element is first parsed, or later.</span></a>
<a class="sourceLine" id="cb29-1105" title="1105">    <span class="at">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1106" title="1106">      <span class="cf">switch</span> (name) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1107" title="1107">        <span class="cf">case</span> <span class="st">&quot;diameter&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb29-1108" title="1108">          <span class="co">// If the diameter attribute changes, update the size styles</span></a>
<a class="sourceLine" id="cb29-1109" title="1109">          <span class="kw">this</span>.<span class="va">style</span>.<span class="at">width</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1110" title="1110">          <span class="kw">this</span>.<span class="va">style</span>.<span class="at">height</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1111" title="1111">          <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1112" title="1112">        <span class="cf">case</span> <span class="st">&quot;color&quot;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb29-1113" title="1113">          <span class="co">// If the color attribute changes, update the color styles</span></a>
<a class="sourceLine" id="cb29-1114" title="1114">          <span class="kw">this</span>.<span class="va">style</span>.<span class="at">backgroundColor</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1115" title="1115">          <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1116" title="1116">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1117" title="1117">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1118" title="1118"></a>
<a class="sourceLine" id="cb29-1119" title="1119">    <span class="co">// Define JavaScript properties that correspond to the element&#39;s</span></a>
<a class="sourceLine" id="cb29-1120" title="1120">    <span class="co">// attributes. These getters and setters just get and set the underlying</span></a>
<a class="sourceLine" id="cb29-1121" title="1121">    <span class="co">// attributes. If a JavaScript property is set, that sets the attribute</span></a>
<a class="sourceLine" id="cb29-1122" title="1122">    <span class="co">// which triggers a call to attributeChangedCallback() which updates</span></a>
<a class="sourceLine" id="cb29-1123" title="1123">    <span class="co">// the element styles.</span></a>
<a class="sourceLine" id="cb29-1124" title="1124">    get <span class="at">diameter</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1125" title="1125">      <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;diameter&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1126" title="1126">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1127" title="1127">    set <span class="at">diameter</span>(diameter) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1128" title="1128">      <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;diameter&quot;</span><span class="op">,</span> diameter)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1129" title="1129">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1130" title="1130">    get <span class="at">color</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1131" title="1131">      <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;color&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1132" title="1132">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1133" title="1133">    set <span class="at">color</span>(color) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1134" title="1134">      <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;color&quot;</span><span class="op">,</span> color)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1135" title="1135">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1136" title="1136">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1137" title="1137">)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1138" title="1138"></a>
<a class="sourceLine" id="cb29-1139" title="1139"><span class="co">// Determine if o is an array-like object.</span></a>
<a class="sourceLine" id="cb29-1140" title="1140"><span class="co">// Strings and functions have numeric length properties, but are</span></a>
<a class="sourceLine" id="cb29-1141" title="1141"><span class="co">// excluded by the typeof test. In client-side JavaScript, DOM text</span></a>
<a class="sourceLine" id="cb29-1142" title="1142"><span class="co">// nodes have a numeric length property, and may need to be excluded</span></a>
<a class="sourceLine" id="cb29-1143" title="1143"><span class="co">// with an additional o.nodeType !== 3 test.</span></a>
<a class="sourceLine" id="cb29-1144" title="1144"><span class="kw">function</span> <span class="at">isArrayLike</span>(o) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1145" title="1145">  <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb29-1146" title="1146">    o <span class="op">&amp;&amp;</span> <span class="co">// o is not null, undefined, etc.</span></a>
<a class="sourceLine" id="cb29-1147" title="1147">    <span class="kw">typeof</span> o <span class="op">===</span> <span class="st">&quot;object&quot;</span> <span class="op">&amp;&amp;</span> <span class="co">// o is an object</span></a>
<a class="sourceLine" id="cb29-1148" title="1148">    <span class="va">Number</span>.<span class="at">isFinite</span>(<span class="va">o</span>.<span class="at">length</span>) <span class="op">&amp;&amp;</span> <span class="co">// o.length is a finite number</span></a>
<a class="sourceLine" id="cb29-1149" title="1149">    <span class="va">o</span>.<span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> <span class="co">// o.length is non-negative</span></a>
<a class="sourceLine" id="cb29-1150" title="1150">    <span class="va">Number</span>.<span class="at">isInteger</span>(<span class="va">o</span>.<span class="at">length</span>) <span class="op">&amp;&amp;</span> <span class="co">// o.length is an integer</span></a>
<a class="sourceLine" id="cb29-1151" title="1151">    <span class="va">o</span>.<span class="at">length</span> <span class="op">&lt;</span> <span class="dv">4294967295</span></a>
<a class="sourceLine" id="cb29-1152" title="1152">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1153" title="1153">    <span class="co">// o.length &lt; 2^32 - 1</span></a>
<a class="sourceLine" id="cb29-1154" title="1154">    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// Then o is array-like.</span></a>
<a class="sourceLine" id="cb29-1155" title="1155">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1156" title="1156">    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> <span class="co">// Otherwise it is not.</span></a>
<a class="sourceLine" id="cb29-1157" title="1157">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1158" title="1158"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-1159" title="1159"></a>
<a class="sourceLine" id="cb29-1160" title="1160"><span class="co">// Connect to the joke port (6789) on the server named on the command line</span></a>
<a class="sourceLine" id="cb29-1161" title="1161"><span class="kw">let</span> socket <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;net&quot;</span>).<span class="at">createConnection</span>(<span class="dv">6789</span><span class="op">,</span> <span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1162" title="1162"><span class="va">socket</span>.<span class="at">pipe</span>(<span class="va">process</span>.<span class="at">stdout</span>)<span class="op">;</span> <span class="co">// Pipe data from the socket to stdout</span></a>
<a class="sourceLine" id="cb29-1163" title="1163"><span class="va">process</span>.<span class="va">stdin</span>.<span class="at">pipe</span>(socket)<span class="op">;</span> <span class="co">// Pipe data from stdin to the socket</span></a>
<a class="sourceLine" id="cb29-1164" title="1164"><span class="va">socket</span>.<span class="at">on</span>(<span class="st">&quot;close&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">process</span>.<span class="at">exit</span>())<span class="op">;</span> <span class="co">// Quit when the socket closes.</span></a>
<a class="sourceLine" id="cb29-1165" title="1165"></a>
<a class="sourceLine" id="cb29-1166" title="1166"><span class="co">// A TCP server that delivers interactive knock-knock jokes on port 6789.</span></a>
<a class="sourceLine" id="cb29-1167" title="1167"><span class="co">// (Why is six afraid of seven? Because seven ate nine!)</span></a>
<a class="sourceLine" id="cb29-1168" title="1168"><span class="kw">const</span> net <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;net&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1169" title="1169"><span class="kw">const</span> readline <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;readline&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1170" title="1170"></a>
<a class="sourceLine" id="cb29-1171" title="1171"><span class="co">// Create a Server object and start listening for connections</span></a>
<a class="sourceLine" id="cb29-1172" title="1172"><span class="kw">let</span> server <span class="op">=</span> <span class="va">net</span>.<span class="at">createServer</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1173" title="1173"><span class="va">server</span>.<span class="at">listen</span>(<span class="dv">6789</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Delivering laughs on port 6789&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1174" title="1174"></a>
<a class="sourceLine" id="cb29-1175" title="1175"><span class="co">// When a client connects, tell them a knock-knock joke.</span></a>
<a class="sourceLine" id="cb29-1176" title="1176"><span class="va">server</span>.<span class="at">on</span>(<span class="st">&quot;connection&quot;</span><span class="op">,</span> (socket) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1177" title="1177">  <span class="at">tellJoke</span>(socket)</a>
<a class="sourceLine" id="cb29-1178" title="1178">    .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="va">socket</span>.<span class="at">end</span>()) <span class="co">// When the joke is done, close the socket.</span></a>
<a class="sourceLine" id="cb29-1179" title="1179">    .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1180" title="1180">      <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span> <span class="co">// Log any errors that occur,</span></a>
<a class="sourceLine" id="cb29-1181" title="1181">      <span class="va">socket</span>.<span class="at">end</span>()<span class="op">;</span> <span class="co">// but still close the socket!</span></a>
<a class="sourceLine" id="cb29-1182" title="1182">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1183" title="1183"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1184" title="1184"></a>
<a class="sourceLine" id="cb29-1185" title="1185"><span class="co">// These are all the jokes we know.</span></a>
<a class="sourceLine" id="cb29-1186" title="1186"><span class="kw">const</span> jokes <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1187" title="1187">  <span class="dt">Boo</span><span class="op">:</span> <span class="st">&quot;Don&#39;t cry...it&#39;s only a joke!&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1188" title="1188">  <span class="dt">Lettuce</span><span class="op">:</span> <span class="st">&quot;Let us in! It&#39;s freezing out here!&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1189" title="1189">  <span class="st">&quot;A little old lady&quot;</span><span class="op">:</span> <span class="st">&quot;Wow, I didn&#39;t know you could yodel!&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1190" title="1190"><span class="op">};</span></a>
<a class="sourceLine" id="cb29-1191" title="1191"></a>
<a class="sourceLine" id="cb29-1192" title="1192"><span class="co">// Interactively perform a knock-knock joke over this socket, without blocking.</span></a>
<a class="sourceLine" id="cb29-1193" title="1193"><span class="kw">async</span> <span class="kw">function</span> <span class="at">tellJoke</span>(socket) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1194" title="1194">  <span class="co">// Pick one of the jokes at random</span></a>
<a class="sourceLine" id="cb29-1195" title="1195">  <span class="kw">let</span> randomElement <span class="op">=</span> (a) <span class="kw">=&gt;</span> a[<span class="va">Math</span>.<span class="at">floor</span>(<span class="va">Math</span>.<span class="at">random</span>() <span class="op">*</span> <span class="va">a</span>.<span class="at">length</span>)]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1196" title="1196">  <span class="kw">let</span> who <span class="op">=</span> <span class="at">randomElement</span>(<span class="va">Object</span>.<span class="at">keys</span>(jokes))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1197" title="1197">  <span class="kw">let</span> punchline <span class="op">=</span> jokes[who]<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1198" title="1198"></a>
<a class="sourceLine" id="cb29-1199" title="1199">  <span class="co">// Use the readline module to read the user&#39;s input one line at a time.</span></a>
<a class="sourceLine" id="cb29-1200" title="1200">  <span class="kw">let</span> lineReader <span class="op">=</span> <span class="va">readline</span>.<span class="at">createInterface</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb29-1201" title="1201">    <span class="dt">input</span><span class="op">:</span> socket<span class="op">,</span></a>
<a class="sourceLine" id="cb29-1202" title="1202">    <span class="dt">output</span><span class="op">:</span> socket<span class="op">,</span></a>
<a class="sourceLine" id="cb29-1203" title="1203">    <span class="dt">prompt</span><span class="op">:</span> <span class="st">&quot;&gt;&gt; &quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-1204" title="1204">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1205" title="1205"></a>
<a class="sourceLine" id="cb29-1206" title="1206">  <span class="co">// A utility function to output a line of text to the client</span></a>
<a class="sourceLine" id="cb29-1207" title="1207">  <span class="co">// and then (by default) display a prompt.</span></a>
<a class="sourceLine" id="cb29-1208" title="1208">  <span class="kw">function</span> <span class="at">output</span>(text<span class="op">,</span> prompt <span class="op">=</span> <span class="kw">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1209" title="1209">    <span class="va">socket</span>.<span class="at">write</span>(<span class="vs">`</span><span class="sc">${</span>text<span class="sc">}\r\n</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1210" title="1210">    <span class="cf">if</span> (prompt) <span class="va">lineReader</span>.<span class="at">prompt</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1211" title="1211">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1212" title="1212"></a>
<a class="sourceLine" id="cb29-1213" title="1213">  <span class="co">// Knock-knock jokes have a call-and-response structure.</span></a>
<a class="sourceLine" id="cb29-1214" title="1214">  <span class="co">// We expect different input from the user at different stages and</span></a>
<a class="sourceLine" id="cb29-1215" title="1215">  <span class="co">// take different action when we get that input at different stages.</span></a>
<a class="sourceLine" id="cb29-1216" title="1216">  <span class="kw">let</span> stage <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1217" title="1217"></a>
<a class="sourceLine" id="cb29-1218" title="1218">  <span class="co">// Start the knock-knock joke off in the traditional way.</span></a>
<a class="sourceLine" id="cb29-1219" title="1219">  <span class="at">output</span>(<span class="st">&quot;Knock knock!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1220" title="1220"></a>
<a class="sourceLine" id="cb29-1221" title="1221">  <span class="co">// Now read lines asynchronously from the client until the joke is done.</span></a>
<a class="sourceLine" id="cb29-1222" title="1222">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> inputLine <span class="kw">of</span> lineReader) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1223" title="1223">    <span class="cf">if</span> (stage <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1224" title="1224">      <span class="cf">if</span> (<span class="va">inputLine</span>.<span class="at">toLowerCase</span>() <span class="op">===</span> <span class="st">&quot;who&#39;s there?&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1225" title="1225">        <span class="co">// If the user gives the right response at stage 0</span></a>
<a class="sourceLine" id="cb29-1226" title="1226">        <span class="co">// then tell the first part of the joke and go to stage 1.</span></a>
<a class="sourceLine" id="cb29-1227" title="1227">        <span class="at">output</span>(who)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1228" title="1228">        stage <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1229" title="1229">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1230" title="1230">        <span class="co">// Otherwise teach the user how to do knock-knock jokes.</span></a>
<a class="sourceLine" id="cb29-1231" title="1231">        <span class="at">output</span>(<span class="st">&#39;Please type &quot;Who</span><span class="sc">\&#39;</span><span class="st">s there?&quot;.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1232" title="1232">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1233" title="1233">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (stage <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1234" title="1234">      <span class="cf">if</span> (<span class="va">inputLine</span>.<span class="at">toLowerCase</span>() <span class="op">===</span> <span class="vs">`</span><span class="sc">${</span><span class="va">who</span>.<span class="at">toLowerCase</span>()<span class="sc">}</span><span class="vs"> who?`</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1235" title="1235">        <span class="co">// If the user&#39;s response is correct at stage 1, then</span></a>
<a class="sourceLine" id="cb29-1236" title="1236">        <span class="co">// deliver the punchline and return since the joke is done.</span></a>
<a class="sourceLine" id="cb29-1237" title="1237">        <span class="at">output</span>(<span class="vs">`</span><span class="sc">${</span>punchline<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1238" title="1238">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1239" title="1239">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1240" title="1240">        <span class="co">// Make the user play along.</span></a>
<a class="sourceLine" id="cb29-1241" title="1241">        <span class="at">output</span>(<span class="vs">`Please type &quot;</span><span class="sc">${</span>who<span class="sc">}</span><span class="vs"> who?&quot;.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1242" title="1242">      <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1243" title="1243">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1244" title="1244">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1245" title="1245"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-1246" title="1246"></a>
<a class="sourceLine" id="cb29-1247" title="1247"><span class="kw">let</span> deg <span class="op">=</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">180</span><span class="op">;</span> <span class="co">// For converting degrees to radians</span></a>
<a class="sourceLine" id="cb29-1248" title="1248"></a>
<a class="sourceLine" id="cb29-1249" title="1249"><span class="co">// Draw a level-n Koch snowflake fractal on the canvas context c,</span></a>
<a class="sourceLine" id="cb29-1250" title="1250"><span class="co">// with lower-left corner at (x,y) and side length len.</span></a>
<a class="sourceLine" id="cb29-1251" title="1251"><span class="kw">function</span> <span class="at">snowflake</span>(c<span class="op">,</span> n<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> len) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1252" title="1252">  <span class="va">c</span>.<span class="at">save</span>()<span class="op">;</span> <span class="co">// Save current transformation</span></a>
<a class="sourceLine" id="cb29-1253" title="1253">  <span class="va">c</span>.<span class="at">translate</span>(x<span class="op">,</span> y)<span class="op">;</span> <span class="co">// Translate origin to starting point</span></a>
<a class="sourceLine" id="cb29-1254" title="1254">  <span class="va">c</span>.<span class="at">moveTo</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// Begin a new subpath at the new origin</span></a>
<a class="sourceLine" id="cb29-1255" title="1255">  <span class="at">leg</span>(n)<span class="op">;</span> <span class="co">// Draw the first leg of the snowflake</span></a>
<a class="sourceLine" id="cb29-1256" title="1256">  <span class="va">c</span>.<span class="at">rotate</span>(<span class="op">-</span><span class="dv">120</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Now rotate 120 degrees counterclockwise</span></a>
<a class="sourceLine" id="cb29-1257" title="1257">  <span class="at">leg</span>(n)<span class="op">;</span> <span class="co">// Draw the second leg</span></a>
<a class="sourceLine" id="cb29-1258" title="1258">  <span class="va">c</span>.<span class="at">rotate</span>(<span class="op">-</span><span class="dv">120</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Rotate again</span></a>
<a class="sourceLine" id="cb29-1259" title="1259">  <span class="at">leg</span>(n)<span class="op">;</span> <span class="co">// Draw the final leg</span></a>
<a class="sourceLine" id="cb29-1260" title="1260">  <span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Close the subpath</span></a>
<a class="sourceLine" id="cb29-1261" title="1261">  <span class="va">c</span>.<span class="at">restore</span>()<span class="op">;</span> <span class="co">// And restore original transformation</span></a>
<a class="sourceLine" id="cb29-1262" title="1262"></a>
<a class="sourceLine" id="cb29-1263" title="1263">  <span class="co">// Draw a single leg of a level-n Koch snowflake.</span></a>
<a class="sourceLine" id="cb29-1264" title="1264">  <span class="co">// This function leaves the current point at the end of the leg it has</span></a>
<a class="sourceLine" id="cb29-1265" title="1265">  <span class="co">// drawn and translates the coordinate system so the current point is (0,0).</span></a>
<a class="sourceLine" id="cb29-1266" title="1266">  <span class="co">// This means you can easily call rotate() after drawing a leg.</span></a>
<a class="sourceLine" id="cb29-1267" title="1267">  <span class="kw">function</span> <span class="at">leg</span>(n) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1268" title="1268">    <span class="va">c</span>.<span class="at">save</span>()<span class="op">;</span> <span class="co">// Save the current transformation</span></a>
<a class="sourceLine" id="cb29-1269" title="1269">    <span class="cf">if</span> (n <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1270" title="1270">      <span class="co">// Nonrecursive case:</span></a>
<a class="sourceLine" id="cb29-1271" title="1271">      <span class="va">c</span>.<span class="at">lineTo</span>(len<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">//   Just draw a horizontal line</span></a>
<a class="sourceLine" id="cb29-1272" title="1272">    <span class="op">}</span> <span class="co">//                                       _  _</span></a>
<a class="sourceLine" id="cb29-1273" title="1273">    <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1274" title="1274">      <span class="co">// Recursive case: draw 4 sub-legs like:  \/</span></a>
<a class="sourceLine" id="cb29-1275" title="1275">      <span class="va">c</span>.<span class="at">scale</span>(<span class="dv">1</span> / <span class="dv">3</span><span class="op">,</span> <span class="dv">1</span> / <span class="dv">3</span>)<span class="op">;</span> <span class="co">// Sub-legs are 1/3 the size of this leg</span></a>
<a class="sourceLine" id="cb29-1276" title="1276">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Recurse for the first sub-leg</span></a>
<a class="sourceLine" id="cb29-1277" title="1277">      <span class="va">c</span>.<span class="at">rotate</span>(<span class="dv">60</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Turn 60 degrees clockwise</span></a>
<a class="sourceLine" id="cb29-1278" title="1278">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Second sub-leg</span></a>
<a class="sourceLine" id="cb29-1279" title="1279">      <span class="va">c</span>.<span class="at">rotate</span>(<span class="op">-</span><span class="dv">120</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Rotate 120 degrees back</span></a>
<a class="sourceLine" id="cb29-1280" title="1280">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Third sub-leg</span></a>
<a class="sourceLine" id="cb29-1281" title="1281">      <span class="va">c</span>.<span class="at">rotate</span>(<span class="dv">60</span> <span class="op">*</span> deg)<span class="op">;</span> <span class="co">// Rotate back to our original heading</span></a>
<a class="sourceLine" id="cb29-1282" title="1282">      <span class="at">leg</span>(n <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Final sub-leg</span></a>
<a class="sourceLine" id="cb29-1283" title="1283">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1284" title="1284">    <span class="va">c</span>.<span class="at">restore</span>()<span class="op">;</span> <span class="co">// Restore the transformation</span></a>
<a class="sourceLine" id="cb29-1285" title="1285">    <span class="va">c</span>.<span class="at">translate</span>(len<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span> <span class="co">// But translate to make end of leg (0,0)</span></a>
<a class="sourceLine" id="cb29-1286" title="1286">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1287" title="1287"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-1288" title="1288"></a>
<a class="sourceLine" id="cb29-1289" title="1289"><span class="kw">let</span> c <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;canvas&quot;</span>).<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1290" title="1290"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">25</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// A level-0 snowflake is a triangle</span></a>
<a class="sourceLine" id="cb29-1291" title="1291"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">175</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// A level-1 snowflake is a 6-sided star</span></a>
<a class="sourceLine" id="cb29-1292" title="1292"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">325</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// etc.</span></a>
<a class="sourceLine" id="cb29-1293" title="1293"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">475</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1294" title="1294"><span class="at">snowflake</span>(c<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">625</span><span class="op">,</span> <span class="dv">125</span><span class="op">,</span> <span class="dv">125</span>)<span class="op">;</span> <span class="co">// A level-4 snowflake looks like a snowflake!</span></a>
<a class="sourceLine" id="cb29-1295" title="1295"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span> <span class="co">// Stroke this very complicated path</span></a>
<a class="sourceLine" id="cb29-1296" title="1296"></a>
<a class="sourceLine" id="cb29-1297" title="1297"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1298" title="1298"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;path&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1299" title="1299"></a>
<a class="sourceLine" id="cb29-1300" title="1300"><span class="kw">async</span> <span class="kw">function</span> <span class="at">listDirectory</span>(dirpath) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1301" title="1301">  <span class="kw">let</span> dir <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="va">promises</span>.<span class="at">opendir</span>(dirpath)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1302" title="1302">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> entry <span class="kw">of</span> dir) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1303" title="1303">    <span class="kw">let</span> name <span class="op">=</span> <span class="va">entry</span>.<span class="at">name</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1304" title="1304">    <span class="cf">if</span> (<span class="va">entry</span>.<span class="at">isDirectory</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb29-1305" title="1305">      name <span class="op">+=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span> <span class="co">// Add a trailing slash to subdirectories</span></a>
<a class="sourceLine" id="cb29-1306" title="1306">    <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1307" title="1307">    <span class="kw">let</span> stats <span class="op">=</span> <span class="cf">await</span> <span class="va">fs</span>.<span class="va">promises</span>.<span class="at">stat</span>(<span class="va">path</span>.<span class="at">join</span>(dirpath<span class="op">,</span> name))<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1308" title="1308">    <span class="kw">let</span> size <span class="op">=</span> <span class="va">stats</span>.<span class="at">size</span><span class="op">;</span></a>
<a class="sourceLine" id="cb29-1309" title="1309">    <span class="va">console</span>.<span class="at">log</span>(<span class="at">String</span>(size).<span class="at">padStart</span>(<span class="dv">10</span>)<span class="op">,</span> name)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-1310" title="1310">  <span class="op">}</span></a>
<a class="sourceLine" id="cb29-1311" title="1311"><span class="op">}</span></a>
<a class="sourceLine" id="cb29-1312" title="1312"></a>
<a class="sourceLine" id="cb29-1313" title="1313"><span class="co">// If the integer 0x00000001 is arranged in memory as 01 00 00 00, then</span></a>
<a class="sourceLine" id="cb29-1314" title="1314"><span class="co">// we&#39;re on a little-endian platform. On a big-endian platform, we&#39;d get</span></a>
<a class="sourceLine" id="cb29-1315" title="1315"><span class="co">// bytes 00 00 00 01 instead.</span></a>
<a class="sourceLine" id="cb29-1316" title="1316"><span class="kw">let</span> littleEndian <span class="op">=</span> <span class="kw">new</span> <span class="at">Int8Array</span>(<span class="kw">new</span> <span class="at">Int32Array</span>([<span class="dv">1</span>]).<span class="at">buffer</span>)[<span class="dv">0</span>] <span class="op">===</span> <span class="dv">1</span><span class="op">;</span></a></code></pre></div>
<hr />
<p>/<em> </em> Return a Proxy object that wraps o, delegating all operations to * that object after logging each operation. objname is a string that * will appear in the log messages to identify the object. If o has own * properties whose values are objects or functions, then if you query * the value of those properties, you’ll get a loggingProxy back, so that * logging behavior of this proxy is “contagious”. */</p>
<hr />
<div class="sourceCode" id="cb30"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb30-1" title="1"><span class="kw">function</span> <span class="at">loggingProxy</span>(o<span class="op">,</span> objname) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-2" title="2">  <span class="co">// Define handlers for our logging Proxy object.</span></a>
<a class="sourceLine" id="cb30-3" title="3">  <span class="co">// Each handler logs a message and then delegates to the target object.</span></a>
<a class="sourceLine" id="cb30-4" title="4">  <span class="kw">const</span> handlers <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb30-5" title="5">    <span class="co">// This handler is a special case because for own properties</span></a>
<a class="sourceLine" id="cb30-6" title="6">    <span class="co">// whose value is an object or function, it returns a proxy rather</span></a>
<a class="sourceLine" id="cb30-7" title="7">    <span class="co">// than returning the value itself.</span></a>
<a class="sourceLine" id="cb30-8" title="8">    <span class="at">get</span>(target<span class="op">,</span> property<span class="op">,</span> receiver) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-9" title="9">      <span class="co">// Log the get operation</span></a>
<a class="sourceLine" id="cb30-10" title="10">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler get(</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="va">property</span>.<span class="at">toString</span>()<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-11" title="11"></a>
<a class="sourceLine" id="cb30-12" title="12">      <span class="co">// Use the Reflect API to get the property value</span></a>
<a class="sourceLine" id="cb30-13" title="13">      <span class="kw">let</span> value <span class="op">=</span> <span class="va">Reflect</span>.<span class="at">get</span>(target<span class="op">,</span> property<span class="op">,</span> receiver)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-14" title="14"></a>
<a class="sourceLine" id="cb30-15" title="15">      <span class="co">// If the property is an own property of the target and</span></a>
<a class="sourceLine" id="cb30-16" title="16">      <span class="co">// the value is an object or function then return a Proxy for it.</span></a>
<a class="sourceLine" id="cb30-17" title="17">      <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb30-18" title="18">        <span class="va">Reflect</span>.<span class="at">ownKeys</span>(target).<span class="at">includes</span>(property) <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb30-19" title="19">        (<span class="kw">typeof</span> value <span class="op">===</span> <span class="st">&quot;object&quot;</span> <span class="op">||</span> <span class="kw">typeof</span> value <span class="op">===</span> <span class="st">&quot;function&quot;</span>)</a>
<a class="sourceLine" id="cb30-20" title="20">      ) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-21" title="21">        <span class="cf">return</span> <span class="at">loggingProxy</span>(value<span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">.</span><span class="sc">${</span><span class="va">property</span>.<span class="at">toString</span>()<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-22" title="22">      <span class="op">}</span></a>
<a class="sourceLine" id="cb30-23" title="23"></a>
<a class="sourceLine" id="cb30-24" title="24">      <span class="co">// Otherwise return the value unmodified.</span></a>
<a class="sourceLine" id="cb30-25" title="25">      <span class="cf">return</span> value<span class="op">;</span></a>
<a class="sourceLine" id="cb30-26" title="26">    <span class="op">},</span></a>
<a class="sourceLine" id="cb30-27" title="27"></a>
<a class="sourceLine" id="cb30-28" title="28">    <span class="co">// There is nothing special about the following three methods:</span></a>
<a class="sourceLine" id="cb30-29" title="29">    <span class="co">// they log the operation and delegate to the target object.</span></a>
<a class="sourceLine" id="cb30-30" title="30">    <span class="co">// They are a special case simply so we can avoid logging the</span></a>
<a class="sourceLine" id="cb30-31" title="31">    <span class="co">// receiver object which can cause infinite recursion.</span></a>
<a class="sourceLine" id="cb30-32" title="32">    <span class="at">set</span>(target<span class="op">,</span> prop<span class="op">,</span> value<span class="op">,</span> receiver) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-33" title="33">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler set(</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="va">prop</span>.<span class="at">toString</span>()<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-34" title="34">      <span class="cf">return</span> <span class="va">Reflect</span>.<span class="at">set</span>(target<span class="op">,</span> prop<span class="op">,</span> value<span class="op">,</span> receiver)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-35" title="35">    <span class="op">},</span></a>
<a class="sourceLine" id="cb30-36" title="36">    <span class="at">apply</span>(target<span class="op">,</span> receiver<span class="op">,</span> args) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-37" title="37">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler </span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">(</span><span class="sc">${</span>args<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-38" title="38">      <span class="cf">return</span> <span class="va">Reflect</span>.<span class="at">apply</span>(target<span class="op">,</span> receiver<span class="op">,</span> args)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-39" title="39">    <span class="op">},</span></a>
<a class="sourceLine" id="cb30-40" title="40">    <span class="at">construct</span>(target<span class="op">,</span> args<span class="op">,</span> receiver) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-41" title="41">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler </span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">(</span><span class="sc">${</span>args<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-42" title="42">      <span class="cf">return</span> <span class="va">Reflect</span>.<span class="at">construct</span>(target<span class="op">,</span> args<span class="op">,</span> receiver)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-43" title="43">    <span class="op">},</span></a>
<a class="sourceLine" id="cb30-44" title="44">  <span class="op">};</span></a>
<a class="sourceLine" id="cb30-45" title="45"></a>
<a class="sourceLine" id="cb30-46" title="46">  <span class="co">// We can automatically generate the rest of the handlers.</span></a>
<a class="sourceLine" id="cb30-47" title="47">  <span class="co">// Metaprogramming FTW!</span></a>
<a class="sourceLine" id="cb30-48" title="48">  <span class="va">Reflect</span>.<span class="at">ownKeys</span>(Reflect).<span class="at">forEach</span>((handlerName) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb30-49" title="49">    <span class="cf">if</span> (<span class="op">!</span>(handlerName <span class="kw">in</span> handlers)) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-50" title="50">      handlers[handlerName] <span class="op">=</span> <span class="kw">function</span> (target<span class="op">,</span> ...<span class="at">args</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb30-51" title="51">        <span class="co">// Log the operation</span></a>
<a class="sourceLine" id="cb30-52" title="52">        <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Handler </span><span class="sc">${</span>handlerName<span class="sc">}</span><span class="vs">(</span><span class="sc">${</span>objname<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>args<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-53" title="53">        <span class="co">// Delegate the operation</span></a>
<a class="sourceLine" id="cb30-54" title="54">        <span class="cf">return</span> Reflect[handlerName](target<span class="op">,</span> ...<span class="at">args</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-55" title="55">      <span class="op">};</span></a>
<a class="sourceLine" id="cb30-56" title="56">    <span class="op">}</span></a>
<a class="sourceLine" id="cb30-57" title="57">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-58" title="58"></a>
<a class="sourceLine" id="cb30-59" title="59">  <span class="co">// Return a proxy for the object using these logging handlers</span></a>
<a class="sourceLine" id="cb30-60" title="60">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Proxy</span>(o<span class="op">,</span> handlers)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-61" title="61"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> This class represents a subrectangle of a canvas or image. We use Tiles to * divide a canvas into regions that can be processed independently by Workers. */</p>
<hr />
<div class="sourceCode" id="cb31"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb31-1" title="1"><span class="kw">class</span> Tile <span class="op">{</span></a>
<a class="sourceLine" id="cb31-2" title="2">  <span class="at">constructor</span>(x<span class="op">,</span> y<span class="op">,</span> width<span class="op">,</span> height) <span class="op">{</span></a>
<a class="sourceLine" id="cb31-3" title="3">    <span class="kw">this</span>.<span class="at">x</span> <span class="op">=</span> x<span class="op">;</span> <span class="co">// The properties of a Tile object</span></a>
<a class="sourceLine" id="cb31-4" title="4">    <span class="kw">this</span>.<span class="at">y</span> <span class="op">=</span> y<span class="op">;</span> <span class="co">// represent the position and size</span></a>
<a class="sourceLine" id="cb31-5" title="5">    <span class="kw">this</span>.<span class="at">width</span> <span class="op">=</span> width<span class="op">;</span> <span class="co">// of the tile within a larger</span></a>
<a class="sourceLine" id="cb31-6" title="6">    <span class="kw">this</span>.<span class="at">height</span> <span class="op">=</span> height<span class="op">;</span> <span class="co">// rectangle.</span></a>
<a class="sourceLine" id="cb31-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb31-8" title="8"></a>
<a class="sourceLine" id="cb31-9" title="9">  <span class="co">// This static method is a generator that divides a rectangle of the</span></a>
<a class="sourceLine" id="cb31-10" title="10">  <span class="co">// specified width and height into the specified number of rows and</span></a>
<a class="sourceLine" id="cb31-11" title="11">  <span class="co">// columns and yields numRows*numCols Tile objects to cover the rectangle.</span></a>
<a class="sourceLine" id="cb31-12" title="12">  <span class="kw">static</span> <span class="op">*</span><span class="at">tiles</span>(width<span class="op">,</span> height<span class="op">,</span> numRows<span class="op">,</span> numCols) <span class="op">{</span></a>
<a class="sourceLine" id="cb31-13" title="13">    <span class="kw">let</span> columnWidth <span class="op">=</span> <span class="va">Math</span>.<span class="at">ceil</span>(width / numCols)<span class="op">;</span></a>
<a class="sourceLine" id="cb31-14" title="14">    <span class="kw">let</span> rowHeight <span class="op">=</span> <span class="va">Math</span>.<span class="at">ceil</span>(height / numRows)<span class="op">;</span></a>
<a class="sourceLine" id="cb31-15" title="15"></a>
<a class="sourceLine" id="cb31-16" title="16">    <span class="cf">for</span> (<span class="kw">let</span> row <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> row <span class="op">&lt;</span> numRows<span class="op">;</span> row<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb31-17" title="17">      <span class="kw">let</span> tileHeight <span class="op">=</span></a>
<a class="sourceLine" id="cb31-18" title="18">        row <span class="op">&lt;</span> numRows <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb31-19" title="19">          <span class="op">?</span> rowHeight <span class="co">// height of most rows</span></a>
<a class="sourceLine" id="cb31-20" title="20">          : height <span class="op">-</span> rowHeight <span class="op">*</span> (numRows <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// height of last row</span></a>
<a class="sourceLine" id="cb31-21" title="21">      <span class="cf">for</span> (<span class="kw">let</span> col <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> col <span class="op">&lt;</span> numCols<span class="op">;</span> col<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb31-22" title="22">        <span class="kw">let</span> tileWidth <span class="op">=</span></a>
<a class="sourceLine" id="cb31-23" title="23">          col <span class="op">&lt;</span> numCols <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb31-24" title="24">            <span class="op">?</span> columnWidth <span class="co">// width of most columns</span></a>
<a class="sourceLine" id="cb31-25" title="25">            : width <span class="op">-</span> columnWidth <span class="op">*</span> (numCols <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// and last column</span></a>
<a class="sourceLine" id="cb31-26" title="26"></a>
<a class="sourceLine" id="cb31-27" title="27">        <span class="kw">yield</span> <span class="kw">new</span> <span class="at">Tile</span>(</a>
<a class="sourceLine" id="cb31-28" title="28">          col <span class="op">*</span> columnWidth<span class="op">,</span></a>
<a class="sourceLine" id="cb31-29" title="29">          row <span class="op">*</span> rowHeight<span class="op">,</span></a>
<a class="sourceLine" id="cb31-30" title="30">          tileWidth<span class="op">,</span></a>
<a class="sourceLine" id="cb31-31" title="31">          tileHeight</a>
<a class="sourceLine" id="cb31-32" title="32">        )<span class="op">;</span></a>
<a class="sourceLine" id="cb31-33" title="33">      <span class="op">}</span></a>
<a class="sourceLine" id="cb31-34" title="34">    <span class="op">}</span></a>
<a class="sourceLine" id="cb31-35" title="35">  <span class="op">}</span></a>
<a class="sourceLine" id="cb31-36" title="36"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> This class represents a pool of workers, all running the same code. The * worker code you specify must respond to each message it receives by * performing some kind of computation and then posting a single message with * the result of that computation. <em> </em> Given a WorkerPool and message that represents work to be performed, simply * call addWork(), with the message as an argument. If there is a Worker * object that is currently idle, the message will be posted to that worker * immediately. If there are no idle Worker objects, the message will be * queued and will be posted to a Worker when one becomes available. <em> </em> addWork() returns a Promise, which will resolve with the message recieved * from the work, or will reject if the worker throws an unhandled error. */</p>
<hr />
<div class="sourceCode" id="cb32"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb32-1" title="1"><span class="kw">class</span> WorkerPool <span class="op">{</span></a>
<a class="sourceLine" id="cb32-2" title="2">  <span class="at">constructor</span>(numWorkers<span class="op">,</span> workerSource) <span class="op">{</span></a>
<a class="sourceLine" id="cb32-3" title="3">    <span class="kw">this</span>.<span class="at">idleWorkers</span> <span class="op">=</span> []<span class="op">;</span> <span class="co">// Workers that are not currently working</span></a>
<a class="sourceLine" id="cb32-4" title="4">    <span class="kw">this</span>.<span class="at">workQueue</span> <span class="op">=</span> []<span class="op">;</span> <span class="co">// Work not currently being processed</span></a>
<a class="sourceLine" id="cb32-5" title="5">    <span class="kw">this</span>.<span class="at">workerMap</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">Map</span>()<span class="op">;</span> <span class="co">// Map workers to resolve and reject funcs</span></a>
<a class="sourceLine" id="cb32-6" title="6"></a>
<a class="sourceLine" id="cb32-7" title="7">    <span class="co">// Create the specified number of workers, add message and error</span></a>
<a class="sourceLine" id="cb32-8" title="8">    <span class="co">// handlers and save them in the idleWorkers array.</span></a>
<a class="sourceLine" id="cb32-9" title="9">    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> numWorkers<span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb32-10" title="10">      <span class="kw">let</span> worker <span class="op">=</span> <span class="kw">new</span> <span class="at">Worker</span>(workerSource)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-11" title="11">      <span class="va">worker</span>.<span class="at">onmessage</span> <span class="op">=</span> (message) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb32-12" title="12">        <span class="kw">this</span>.<span class="at">_workerDone</span>(worker<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="va">message</span>.<span class="at">data</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-13" title="13">      <span class="op">};</span></a>
<a class="sourceLine" id="cb32-14" title="14">      <span class="va">worker</span>.<span class="at">onerror</span> <span class="op">=</span> (error) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb32-15" title="15">        <span class="kw">this</span>.<span class="at">_workerDone</span>(worker<span class="op">,</span> error<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-16" title="16">      <span class="op">};</span></a>
<a class="sourceLine" id="cb32-17" title="17">      <span class="kw">this</span>.<span class="at">idleWorkers</span>[i] <span class="op">=</span> worker<span class="op">;</span></a>
<a class="sourceLine" id="cb32-18" title="18">    <span class="op">}</span></a>
<a class="sourceLine" id="cb32-19" title="19">  <span class="op">}</span></a>
<a class="sourceLine" id="cb32-20" title="20"></a>
<a class="sourceLine" id="cb32-21" title="21">  <span class="co">// This internal method is called when a worker finishes working, either</span></a>
<a class="sourceLine" id="cb32-22" title="22">  <span class="co">// by sending a message or by throwing an error.</span></a>
<a class="sourceLine" id="cb32-23" title="23">  <span class="at">_workerDone</span>(worker<span class="op">,</span> error<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb32-24" title="24">    <span class="co">// Look up the resolve() and reject() functions for this worker</span></a>
<a class="sourceLine" id="cb32-25" title="25">    <span class="co">// and then remove the worker&#39;s entry from the map.</span></a>
<a class="sourceLine" id="cb32-26" title="26">    <span class="kw">let</span> [resolver<span class="op">,</span> rejector] <span class="op">=</span> <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">get</span>(worker)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-27" title="27">    <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">delete</span>(worker)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-28" title="28"></a>
<a class="sourceLine" id="cb32-29" title="29">    <span class="co">// If there is no queued work, put this worker back in</span></a>
<a class="sourceLine" id="cb32-30" title="30">    <span class="co">// the list of idle workers. Otherwise, take work from the queue</span></a>
<a class="sourceLine" id="cb32-31" title="31">    <span class="co">// and send it to this worker.</span></a>
<a class="sourceLine" id="cb32-32" title="32">    <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">workQueue</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb32-33" title="33">      <span class="kw">this</span>.<span class="va">idleWorkers</span>.<span class="at">push</span>(worker)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-34" title="34">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb32-35" title="35">      <span class="kw">let</span> [work<span class="op">,</span> resolver<span class="op">,</span> rejector] <span class="op">=</span> <span class="kw">this</span>.<span class="va">workQueue</span>.<span class="at">shift</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb32-36" title="36">      <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">set</span>(worker<span class="op">,</span> [resolver<span class="op">,</span> rejector])<span class="op">;</span></a>
<a class="sourceLine" id="cb32-37" title="37">      <span class="va">worker</span>.<span class="at">postMessage</span>(work)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-38" title="38">    <span class="op">}</span></a>
<a class="sourceLine" id="cb32-39" title="39"></a>
<a class="sourceLine" id="cb32-40" title="40">    <span class="co">// Finally, resolve or reject the promise associated with the worker.</span></a>
<a class="sourceLine" id="cb32-41" title="41">    error <span class="op">===</span> <span class="kw">null</span> <span class="op">?</span> <span class="at">resolver</span>(response) : <span class="at">rejector</span>(error)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-42" title="42">  <span class="op">}</span></a>
<a class="sourceLine" id="cb32-43" title="43"></a>
<a class="sourceLine" id="cb32-44" title="44">  <span class="co">// This method adds work to the worker pool and returns a Promise that</span></a>
<a class="sourceLine" id="cb32-45" title="45">  <span class="co">// will resolve with a worker&#39;s response when the work is done. The work</span></a>
<a class="sourceLine" id="cb32-46" title="46">  <span class="co">// is a value to be passed to a worker with postMessage(). If there is an</span></a>
<a class="sourceLine" id="cb32-47" title="47">  <span class="co">// idle worker, the work message will be sent immediately. Otherwise it</span></a>
<a class="sourceLine" id="cb32-48" title="48">  <span class="co">// will be queued until a worker is available.</span></a>
<a class="sourceLine" id="cb32-49" title="49">  <span class="at">addWork</span>(work) <span class="op">{</span></a>
<a class="sourceLine" id="cb32-50" title="50">    <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb32-51" title="51">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">idleWorkers</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb32-52" title="52">        <span class="kw">let</span> worker <span class="op">=</span> <span class="kw">this</span>.<span class="va">idleWorkers</span>.<span class="at">pop</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb32-53" title="53">        <span class="kw">this</span>.<span class="va">workerMap</span>.<span class="at">set</span>(worker<span class="op">,</span> [resolve<span class="op">,</span> reject])<span class="op">;</span></a>
<a class="sourceLine" id="cb32-54" title="54">        <span class="va">worker</span>.<span class="at">postMessage</span>(work)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-55" title="55">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb32-56" title="56">        <span class="kw">this</span>.<span class="va">workQueue</span>.<span class="at">push</span>([work<span class="op">,</span> resolve<span class="op">,</span> reject])<span class="op">;</span></a>
<a class="sourceLine" id="cb32-57" title="57">      <span class="op">}</span></a>
<a class="sourceLine" id="cb32-58" title="58">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb32-59" title="59">  <span class="op">}</span></a>
<a class="sourceLine" id="cb32-60" title="60"><span class="op">}</span></a></code></pre></div>
<hr />
<p>/<em> </em> This class holds the state information necessary to render a Mandelbrot set. * The cx and cy properties give the point in the complex plane that is the * center of the image. The perPixel property specifies how much the real and * imaginary parts of that complex number changes for each pixel of the image. * The maxIterations property specifies how hard we work to compute the set. * Larger numbers require more computation but produce crisper images. * Note that the size of the canvas is not part of the state. Given cx, cy, and * perPixel we simply render whatever portion of the Mandelbrot set fits in * the canvas at its current size. <em> </em> Objects of this type are used with history.pushState() and are used to read * the desired state from a bookmarked or shared URL. */</p>
<hr />
<p>```js class PageState { // This factory method returns an initial state to display the entire set. static initialState() { let s = new PageState(); s.cx = -0.5; s.cy = 0; s.perPixel = 3 / window.innerHeight; s.maxIterations = 500; return s; }</p>
<p>// This factory method obtains state from a URL, or returns null if // a valid state could not be read from the URL. static fromURL(url) { let s = new PageState(); let u = new URL(url); // Initialize state from the url’s search params. s.cx = parseFloat(u.searchParams.get(“cx”)); s.cy = parseFloat(u.searchParams.get(“cy”)); s.perPixel = parseFloat(u.searchParams.get(“pp”)); s.maxIterations = parseInt(u.searchParams.get(“it”)); // If we got valid values, return the PageState object, otherwise null. return isNaN(s.cx) || isNaN(s.cy) || isNaN(s.perPixel) || isNaN(s.maxIterations) ? null : s; }</p>
<p>// This instance method encodes the current state into the search // parameters of the browser’s current location. toURL() { let u = new URL(window.location); u.searchParams.set(“cx”, this.cx); u.searchParams.set(“cy”, this.cy); u.searchParams.set(“pp”, this.perPixel); u.searchParams.set(“it”, this.maxIterations); return u.href; } }</p>
<p>// These constants control the parallelism of the Mandelbrot set computation. // You may need to adjust them to get optimum performance on your computer. const ROWS = 3, COLS = 4, NUMWORKERS = navigator.hardwareConcurrency || 2;</p>
// This is the main class of our Mandelbrot set program. Simply invoke the // constructor function with the
<canvas>
element to render into. The program // assumes that this
<canvas>
<p>element is styled so that it is always as big // as the browser window. class MandelbrotCanvas { constructor(canvas) { // Store the canvas, get its context object, and initialize a WorkerPool this.canvas = canvas; this.context = canvas.getContext(“2d”); this.workerPool = new WorkerPool(NUMWORKERS, “mandelbrotWorker.js”);</p>
<pre><code>// Define some properties that we&#39;ll use later
this.tiles = null; // Subregions of the canvas
this.pendingRender = null; // We&#39;re not currently rendering
this.wantsRerender = false; // No render is currently requested
this.resizeTimer = null; // Prevents us from resizing too frequently
this.colorTable = null; // For converting raw data to pixel values.

// Set up our event handlers
this.canvas.addEventListener(&quot;pointerdown&quot;, (e) =&gt; this.handlePointer(e));
window.addEventListener(&quot;keydown&quot;, (e) =&gt; this.handleKey(e));
window.addEventListener(&quot;resize&quot;, (e) =&gt; this.handleResize(e));
window.addEventListener(&quot;popstate&quot;, (e) =&gt; this.setState(e.state, false));

// Initialize our state from the URL or start with the initial state.
this.state = PageState.fromURL(window.location) || PageState.initialState();

// Save this state with the history mechanism.
history.replaceState(this.state, &quot;&quot;, this.state.toURL());

// Set the canvas size and get an array of tiles that cover it.
this.setSize();

// And render the Mandelbrot set into the canvas.
this.render();</code></pre>
<p>}</p>
<p>// Set the canvas size and initialize an array of Tile objects. This // method is called from the constructor and also by the handleResize() // method when the browser window is resized. setSize() { this.width = this.canvas.width = window.innerWidth; this.height = this.canvas.height = window.innerHeight; this.tiles = […Tile.tiles(this.width, this.height, ROWS, COLS)]; }</p>
<p>// This function makes a change to the PageState, then re-renders the // Mandelbrot set using that new state, and also saves the new state with // history.pushState(). If the first argument is a function that function // will be called with the state object as its argument and should make // changes to the state. If the first argument is an object, then we simply // copy the properties of that object into the state object. If the optional // second argument is false, then the new state will not be saved. (We // do this when calling setState in response to a popstate event.) setState(f, save = true) { // If the argument is a function, call it to update the state. // Otherwise, copy its properties into the current state. if (typeof f === “function”) { f(this.state); } else { for (let property in f) { this.state[property] = f[property]; } }</p>
<pre><code>// In either case, start rendering the new state ASAP.
this.render();

// Normally we save the new state. Except when we&#39;re called with
// a second argument of false which we do when we get a popstate event.
if (save) {
  history.pushState(this.state, &quot;&quot;, this.state.toURL());
}</code></pre>
<p>}</p>
<p>// This method asynchronously draws the portion of the Mandelbrot set // specified by the PageState object into the canvas. It is called by // the constructor, by setState() when the state changes, and by the // resize event handler when the size of the canvas changes. render() { // Sometimes the user may use the keyboard or mouse to request renders // more quickly than we can perform them. We don’t want to submit all // the renders to the worker pool. Instead if we’re rendering, we’ll // just make a note that a new render is needed, and when the current // render completes, we’ll render the current state, possibly skipping // multiple intermediate states. if (this.pendingRender) { // If we’re already rendering, this.wantsRerender = true; // make a note to rerender later return; // and don’t do anything more now. }</p>
<pre><code>// Get our state variables and compute the complex number for the
// upper left corner of the canvas.
let { cx, cy, perPixel, maxIterations } = this.state;
let x0 = cx - (perPixel * this.width) / 2;
let y0 = cy - (perPixel * this.height) / 2;

// For each of our ROWS*COLS tiles, call addWork() with a message
// for the code in mandelbrotWorker.js. Collect the resulting Promise
// objects into an array.
let promises = this.tiles.map((tile) =&gt;
  this.workerPool.addWork({
    tile: tile,
    x0: x0 + tile.x * perPixel,
    y0: y0 + tile.y * perPixel,
    perPixel: perPixel,
    maxIterations: maxIterations,
  })
);

// Use Promise.all() to get an array of responses from the array of
// promises. Each response is the computation for one of our tiles.
// Recall from mandelbrotWorker.js that each response includes the
// Tile object, an ImageData object that includes iteration counts
// instead of pixel values, and the minimum and maximum iterations
// for that tile.
this.pendingRender = Promise.all(promises)
  .then((responses) =&gt; {
    // First, find the overall max and min iterations over all tiles.
    // We need these numbers so we can assign colors to the pixels.
    let min = maxIterations,
      max = 0;
    for (let r of responses) {
      if (r.min &lt; min) min = r.min;
      if (r.max &gt; max) max = r.max;
    }

    // Now we need a way to convert the raw iteration counts from the
    // workers into pixel colors that will be displayed in the canvas.
    // We know that all the pixels have between min and max iterations
    // so we precompute the colors for each iteration count and store
    // them in the colorTable array.

    // If we haven&#39;t allocated a color table yet, or if it is no longer
    // the right size, then allocate a new one.
    if (!this.colorTable || this.colorTable.length !== maxIterations + 1) {
      this.colorTable = new Uint32Array(maxIterations + 1);
    }

    // Given the max and the min, compute appropriate values in the
    // color table. Pixels in the set will be colored fully opaque
    // black. Pixels outside the set will be translucent black with higher
    // iteration counts resulting in higher opacity. Pixels with
    // minimum iteration counts will be transparent and the white
    // background will show through, resulting in a grayscale image.
    if (min === max) {
      // If all the pixels are the same,
      if (min === maxIterations) {
        // Then make them all black
        this.colorTable[min] = 0xff000000;
      } else {
        // Or all transparent.
        this.colorTable[min] = 0;
      }
    } else {
      // In the normal case where min and max are different, use a
      // logarithic scale to assign each possible iteration count an
      // opacity between 0 and 255, and then use the shift left
      // operator to turn that into a pixel value.
      let maxlog = Math.log(1 + max - min);
      for (let i = min; i &lt;= max; i++) {
        this.colorTable[i] =
          Math.ceil((Math.log(1 + i - min) / maxlog) * 255) &lt;&lt; 24;
      }
    }

    // Now translate the iteration numbers in each response&#39;s
    // ImageData to colors from the colorTable.
    for (let r of responses) {
      let iterations = new Uint32Array(r.imageData.data.buffer);
      for (let i = 0; i &lt; iterations.length; i++) {
        iterations[i] = this.colorTable[iterations[i]];
      }
    }

    // Finally, render all the imageData objects into their
    // corresponding tiles of the canvas using putImageData().
    // (First, though, remove any CSS transforms on the canvas that may
    // have been set by the pointerdown event handler.)
    this.canvas.style.transform = &quot;&quot;;
    for (let r of responses) {
      this.context.putImageData(r.imageData, r.tile.x, r.tile.y);
    }
  })
  .catch((reason) =&gt; {
    // If anything went wrong in any of our Promises, we&#39;ll log
    // an error here. This shouldn&#39;t happen, but this will help with
    // debugging if it does.
    console.error(&quot;Promise rejected in render():&quot;, reason);
  })
  .finally(() =&gt; {
    // When we are done rendering, clear the pendingRender flags
    this.pendingRender = null;
    // And if render requests came in while we were busy, rerender now.
    if (this.wantsRerender) {
      this.wantsRerender = false;
      this.render();
    }
  });</code></pre>
<p>}</p>
<p>// If the user resizes the window, this function will be called repeatedly. // Resizing a canvas and rerendering the Mandlebrot set is an expensive // operation that we can’t do multiple times a second, so we use a timer // to defer handling the resize until 200ms have elapsed since the last // resize event was received. handleResize(event) { // If we were already deferring a resize, clear it. if (this.resizeTimer) clearTimeout(this.resizeTimer); // And defer this resize instead. this.resizeTimer = setTimeout(() =&gt; { this.resizeTimer = null; // Note that resize has been handled this.setSize(); // Resize canvas and tiles this.render(); // Rerender at the new size }, 200); }</p>
<p>// If the user presses a key, this event handler will be called. // We call setState() in response to various keys, and setState() renders // the new state, updates the URL, and saves the state in browser history. handleKey(event) { switch (event.key) { case “Escape”: // Type Escape to go back to the initial state this.setState(PageState.initialState()); break; case “+”: // Type + to increase the number of iterations this.setState((s) =&gt; { s.maxIterations = Math.round(s.maxIterations * 1.5); }); break; case “-”: // Type - to decrease the number of iterations this.setState((s) =&gt; { s.maxIterations = Math.round(s.maxIterations / 1.5); if (s.maxIterations &lt; 1) s.maxIterations = 1; }); break; case “o”: // Type o to zoom out this.setState((s) =&gt; (s.perPixel <em>= 2)); break; case “ArrowUp”: // Up arrow to scroll up this.setState((s) =&gt; (s.cy -= (this.height / 10) </em> s.perPixel)); break; case “ArrowDown”: // Down arrow to scroll down this.setState((s) =&gt; (s.cy += (this.height / 10) * s.perPixel)); break; case “ArrowLeft”: // Left arrow to scroll left this.setState((s) =&gt; (s.cx -= (this.width / 10) * s.perPixel)); break; case “ArrowRight”: // Right arrow to scroll right this.setState((s) =&gt; (s.cx += (this.width / 10) * s.perPixel)); break; } }</p>
<p>// This method is called when we get a pointerdown event on the canvas. // The pointerdown event might be the start of a zoom gesture (a click or // tap) or a pan gesture (a drag). This handler registers handlers for // the pointermove and pointerup events in order to respond to the rest // of the gesture. (These two extra handlers are removed when the gesture // ends with a pointerup.) handlePointer(event) { // The pixel coordinates and time of the initial pointer down. // Because the canvas is as big as the window, these event coordinates // are also canvas coordinates. const x0 = event.clientX, y0 = event.clientY, t0 = Date.now();</p>
<pre><code>// This is the handler for move events.
const pointerMoveHandler = (event) =&gt; {
  // How much have we moved, and how much time has passed?
  let dx = event.clientX - x0,
    dy = event.clientY - y0,
    dt = Date.now() - t0;

  // If the pointer has moved enough or enough time has passed that
  // this is not a regular click, then use CSS to pan the display.
  // (We will rerender it for real when we get the pointerup event.)
  if (dx &gt; 10 || dy &gt; 10 || dt &gt; 500) {
    this.canvas.style.transform = `translate(${dx}px, ${dy}px)`;
  }
};

// This is the handler for pointerup events
const pointerUpHandler = (event) =&gt; {
  // When the pointer goes up, the gesture is over, so remove
  // the move and up handlers until the next gesture.
  this.canvas.removeEventListener(&quot;pointermove&quot;, pointerMoveHandler);
  this.canvas.removeEventListener(&quot;pointerup&quot;, pointerUpHandler);

  // How much did the pointer move, and how much time passed?
  const dx = event.clientX - x0,
    dy = event.clientY - y0,
    dt = Date.now() - t0;
  // Unpack the state object into individual constants.
  const { cx, cy, perPixel } = this.state;

  // If the pointer moved far enough or if enough time passed, then
  // this was a pan gesture, and we need to change state to change
  // the center point. Otherwise, the user clicked or tapped on a
  // point and we need to center and zoom in on that point.
  if (dx &gt; 10 || dy &gt; 10 || dt &gt; 500) {
    // The user panned the image by (dx, dy) pixels.
    // Convert those values to offsets in the complex plane.
    this.setState({ cx: cx - dx * perPixel, cy: cy - dy * perPixel });
  } else {
    // The user clicked. Compute how many pixels the center moves.
    let cdx = x0 - this.width / 2;
    let cdy = y0 - this.height / 2;

    // Use CSS to quickly and temporarily zoom in
    this.canvas.style.transform = `translate(${-cdx * 2}px, ${
      -cdy * 2
    }px) scale(2)`;

    // Set the complex coordinates of the new center point and
    // zoom in by a factor of 2.
    this.setState((s) =&gt; {
      s.cx += cdx * s.perPixel;
      s.cy += cdy * s.perPixel;
      s.perPixel /= 2;
    });
  }
};

// When the user begins a gesture we register handlers for the
// pointermove and pointerup events that follow.
this.canvas.addEventListener(&quot;pointermove&quot;, pointerMoveHandler);
this.canvas.addEventListener(&quot;pointerup&quot;, pointerUpHandler);</code></pre>
<p>} }</p>
// Finally, here’s how we set up the canvas. Note that this JavaScript file // is self-sufficient. The HTML file only needs to include this one
<script>
. let canvas = document.createElement(“canvas”); // Create a canvas element document.body.append(canvas); // Insert it into the body document.body.style = “margin:0”; // No margin for the
<body>
<p>canvas.style.width = “100%”; // Make canvas as wide as body canvas.style.height = “100%”; // and as high as the body. new MandelbrotCanvas(canvas); // And start rendering into it!</p>
<p>// This is a simple worker that receives a message from its parent thread, // performs the computation described by that message and then posts the // result of that computation back to the parent thread. onmessage = function (message) { // First, we unpack the message we received: // - tile is an object with width and height properties. It specifies the // size of the rectangle of pixels for which we will be computing // Mandelbrot set membership. // - (x0, y0) is the point in the complex plane that corresponds to the // upper-left pixel in the tile. // - perPixel is the pixel size in both the real and imaginary dimensions. // - maxIterations specifies the maximum number of iterations we will // perform before deciding that a pixel is in the set. const { tile, x0, y0, perPixel, maxIterations } = message.data; const { width, height } = tile;</p>
<p>// Next, we create an ImageData object to represent the rectangular array // of pixels, get its internal ArrayBuffer, and create a typed array view // of that buffer so we can treat each pixel as a single integer instead of // four individual bytes. We’ll store the number of iterations for each // pixel in this iterations array. (The iterations will be transformed into // actual pixel colors in the parent thread.) const imageData = new ImageData(width, height); const iterations = new Uint32Array(imageData.data.buffer);</p>
<p>// Now we begin the computation. There are three nested for loops here. // The outer two loop over the rows and columns of pixels, and the inner // loop iterates each pixel to see if it “escapes” or not. The various // loop variables are the following: // - row and column are integers representing the pixel coordinate. // - x and y represent the complex point for each pixel: x + yi. // - index is the index in the iterations array for the current pixel. // - n tracks the number of iterations for each pixel. // - max and min track the largest and smallest number of iterations // we’ve seen so far for any pixel in the rectangle. let index = 0, max = 0, min = maxIterations; for (let row = 0, y = y0; row &lt; height; row++, y += perPixel) { for (let column = 0, x = x0; column &lt; width; column++, x += perPixel) { // For each pixel we start with the complex number c = x+yi. // Then we repeatedly compute the complex number z(n+1) based on // this recursive formula: // z(0) = c // z(n+1) = z(n)^2 + c // If |z(n)| (the magnitude of z(n)) is &gt; 2, then the // pixel is not part of the set and we stop after n iterations. let n; // The number of iterations so far let r = x, i = y; // Start with z(0) set to c for (n = 0; n &lt; maxIterations; n++) { let rr = r * r, ii = i * i; // Square the two parts of z(n). if (rr + ii &gt; 4) { // If |z(n)|^2 is &gt; 4 then break; // we’ve escaped and can stop iterating. } i = 2 * r * i + y; // Compute imaginary part of z(n+1). r = rr - ii + x; // And the real part of z(n+1). } iterations[index++] = n; // Remember # iterations for each pixel. if (n &gt; max) max = n; // Track the maximum number we’ve seen. if (n &lt; min) min = n; // And the minimum as well. } }</p>
<p>// When the computation is complete, send the results back to the parent // thread. The imageData object will be copied, but the giant ArrayBuffer // it contains will be transferred for a nice performance boost. postMessage({ tile, imageData, min, max }, [imageData.data.buffer]); };</p>
<p>// Return an iterable object that iterates the result of applying f() // to each value from the source iterable function map(iterable, f) { let iterator = iterable<a href="">Symbol.iterator</a>; return { // This object is both iterator and iterable <a href="">Symbol.iterator</a> { return this; }, next() { let v = iterator.next(); if (v.done) { return v; } else { return { value: f(v.value) }; } }, }; }</p>
<p>// Map a range of integers to their squares and convert to an array […map(new Range(1, 4), (x) =&gt; x * x)]; // =&gt; [1, 4, 9, 16]</p>
<p>// Return a function that expects an array argument and applies f to // each element, returning the array of return values. // Contrast this with the map() function from earlier. function mapper(f) { return (a) =&gt; map(a, f); }</p>
<p>const increment = (x) =&gt; x + 1; const incrementAll = mapper(increment); incrementAll([1, 2, 3]); // =&gt; [2,3,4]</p>
<p>// Return a memoized version of f. // It only works if arguments to f all have distinct string representations. function memoize(f) { const cache = new Map(); // Value cache stored in the closure.</p>
<p>return function (…args) { // Create a string version of the arguments to use as a cache key. let key = args.length + args.join(“+”); if (cache.has(key)) { return cache.get(key); } else { let result = f.apply(this, args); cache.set(key, result); return result; } }; }</p>
<p>// Return the Greatest Common Divisor of two integers using the Euclidian // algorithm: http://en.wikipedia.org/wiki/Euclidean_algorithm function gcd(a, b) { // Type checking for a and b has been omitted if (a &lt; b) { // Ensure that a &gt;= b when we start [a, b] = [b, a]; // Destructuring assignment to swap variables } while (b !== 0) { // This is Euclid’s algorithm for GCD [a, b] = [b, a % b]; } return a; }</p>
<p>const gcdmemo = memoize(gcd); gcdmemo(85, 187); // =&gt; 17</p>
<p>// Note that when we write a recursive function that we will be memoizing, // we typically want to recurse to the memoized version, not the original. const factorial = memoize(function (n) { return n &lt;= 1 ? 1 : n * factorial(n - 1); }); factorial(5); // =&gt; 120: also caches values for 4, 3, 2 and 1.</p>
<p>// Like Object.assign() but doesn’t override existing properties // (and also doesn’t handle Symbol properties) function merge(target, …sources) { for (let source of sources) { for (let key of Object.keys(source)) { if (!(key in target)) { // This is different than Object.assign() target[key] = source[key]; } } } return target; } Object.assign({ x: 1 }, { x: 2, y: 2 }, { y: 3, z: 4 }); // =&gt; {x: 2, y: 3, z: 4} merge({ x: 1 }, { x: 2, y: 2 }, { y: 3, z: 4 }); // =&gt; {x: 1, y: 2, z: 4}</p>
<p>// This higher-order function returns a new function that passes its // arguments to f and returns the logical negation of f’s return value; function not(f) { return function (…args) { // Return a new function let result = f.apply(this, args); // that calls f return !result; // and negates its result. }; }</p>
<p>const even = (x) =&gt; x % 2 === 0; // A function to determine if a number is even const odd = not(even); // A new function that does the opposite [1, 1, 3, 5, 5].every(odd); // =&gt; true: every element of the array is odd</p>
// Set the onload property of the Window object to a function. // The function is the event handler: it is invoked when the document loads. window.onload = function () { // Look up a
<form>
<p>element let form = document.querySelector(“form#shipping”); // Register an event handler function on the form that will be invoked // before the form is submitted. Assume isFormValid() is defined elsewhere. form.onsubmit = function (event) { // When the user submits the form if (!isFormValid(this)) { // check whether form inputs are valid event.preventDefault(); // and if not, prevent form submission. } }; };</p>
<p>// We define some simple functions here function add(x, y) { return x + y; } function subtract(x, y) { return x - y; } function multiply(x, y) { return x * y; } function divide(x, y) { return x / y; }</p>
<p>// Here’s a function that takes one of the preceding functions // as an argument and invokes it on two operands function operate(operator, operand1, operand2) { return operator(operand1, operand2); }</p>
<p>// We could invoke this function like this to compute the value (2+3) + (4*5): let i = operate(add, operate(add, 2, 3), operate(multiply, 4, 5));</p>
<p>// For the sake of the example, we implement the simple functions again, // this time within an object literal; const operators = { add: (x, y) =&gt; x + y, subtract: (x, y) =&gt; x - y, multiply: (x, y) =&gt; x * y, divide: (x, y) =&gt; x / y, pow: Math.pow, // This works for predefined functions too };</p>
<p>// This function takes the name of an operator, looks up that operator // in the object, and then invokes it on the supplied operands. Note // the syntax used to invoke the operator function. function operate2(operation, operand1, operand2) { if (typeof operators[operation] === “function”) { return operators<a href="operand1,%20operand2">operation</a>; } else throw “unknown operator”; }</p>
<p>operate2(“add”, “hello”, operate2(“add”, " “,”world“)); // =&gt;”hello world" operate2(“pow”, 10, 2); // =&gt; 100</p>
<p>const child_process = require(“child_process”); const util = require(“util”); const execP = util.promisify(child_process.exec);</p>
<p>function parallelExec(commands) { // Use the array of commands to create an array of Promises let promises = commands.map((command) =&gt; execP(command, { encoding: “utf8” }) ); // Return a Promise that will fulfill to an array of the fulfillment // values of each of the individual promises. (Instead of returning objects // with stdout and stderr properties we just return the stdout value.) return Promise.all(promises).then((outputs) =&gt; outputs.map((out) =&gt; out.stdout) ); }</p>
<p>module.exports = parallelExec;</p>
<p>const threads = require(“worker_threads”);</p>
<p>if (threads.isMainThread) { // In the main thread, we create a shared typed array with // one element. Both threads will be able to read and write // sharedArray[0] at the same time. let sharedBuffer = new SharedArrayBuffer(4); let sharedArray = new Int32Array(sharedBuffer);</p>
<p>// Now create a worker thread, passing the shared array to it with // as its initial workerData value so we don’t have to bother with // sending and receiving a message let worker = new threads.Worker(__filename, { workerData: sharedArray });</p>
<p>// Wait for the worker to start running and then increment the // shared integer 10 million times. worker.on(“online”, () =&gt; { for (let i = 0; i &lt; 10_000_000; i++) sharedArray[0]++;</p>
<pre><code>// Once we&#39;re done with our increments, we start listening for
// message events so we know when the worker is done.
worker.on(&quot;message&quot;, () =&gt; {
  // Although the shared integer has been incremented
  // 20 million times, its value will generally be much less.
  // On my computer the final value is typically under 12 million.
  console.log(sharedArray[0]);
});</code></pre>
<p>}); } else { // In the worker thread, we get the shared array from workerData // and then increment it 10 million times. let sharedArray = threads.workerData; for (let i = 0; i &lt; 10_000_000; i++) sharedArray[0]++; // When we’re done incrementing, let the main thread know threads.parentPort.postMessage(“done”); }</p>
<p>const child_process = require(“child_process”);</p>
<p>// Start a new node process running the code in child.js in our directory let child = child_process.fork(<code>${__dirname}/child.js</code>);</p>
<p>// Send a message to the child child.send({ x: 4, y: 3 });</p>
<p>// Print the child’s response when it arrives. child.on(“message”, (message) =&gt; { console.log(message.hypotenuse); // This should print “5” // Since we only send one message we only expect one response. // After we receive it we call disconnect() to terminate the connection // between parent and child. This allows both processes to exit cleanly. child.disconnect(); });</p>
<p>// The arguments to this function are passed on the left function partialLeft(f, …outerArgs) { return function (…innerArgs) { // Return this function let args = […outerArgs, …innerArgs]; // Build the argument list return f.apply(this, args); // Then invoke f with it }; }</p>
<p>// The arguments to this function are passed on the right function partialRight(f, …outerArgs) { return function (…innerArgs) { // Return this function let args = […innerArgs, …outerArgs]; // Build the argument list return f.apply(this, args); // Then invoke f with it }; }</p>
<p>// The arguments to this function serve as a template. Undefined values // in the argument list are filled in with values from the inner set. function partial(f, …outerArgs) { return function (…innerArgs) { let args = […outerArgs]; // local copy of outer args template let innerIndex = 0; // which inner arg is next // Loop through the args, filling in undefined values from inner args for (let i = 0; i &lt; args.length; i++) { if (args[i] === undefined) args[i] = innerArgs[innerIndex++]; } // Now append any remaining inner arguments args.push(…innerArgs.slice(innerIndex)); return f.apply(this, args); }; }</p>
<p>// Here is a function with three arguments const f = function (x, y, z) { return x * (y - z); }; // Notice how these three partial applications differ partialLeft(f, 2)(3, 4); // =&gt; -2: Bind first argument: 2 * (3 - 4) partialRight(f, 2)(3, 4); // =&gt; 6: Bind last argument: 3 * (4 - 2) partial(f, undefined, 2)(3, 4); // =&gt; -6: Bind middle argument: 3 * (2 - 4)</p>
<p>const increment = partialLeft(sum, 1); const cuberoot = partialRight(Math.pow, 1 / 3); cuberoot(increment(26)); // =&gt; 3</p>
<p>const not = partialLeft(compose, (x) =&gt; !x); const even = (x) =&gt; x % 2 === 0; const odd = not(even); const isNumber = not(isNaN); odd(3) &amp;&amp; isNumber(2); // =&gt; true</p>
<p>// sum() and square() functions are defined above. Here are some more: const product = (x, y) =&gt; x * y; const neg = partial(product, -1); const sqrt = partial(Math.pow, undefined, 0.5); const reciprocal = partial(Math.pow, undefined, neg(1));</p>
<p>// Now compute the mean and standard deviation. let data = [1, 1, 3, 5, 5]; // Our data let mean = product(reduce(data, sum), reciprocal(data.length)); let stddev = sqrt( product( reduce(map(data, compose(square, partial(sum, neg(mean)))), sum), reciprocal(sum(data.length, neg(1))) ) ); [mean, stddev]; // =&gt; [3, 2]</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> Create an <svg> element and draw a pie chart into it. </em> * This function expects an object argument with the following properties: <em> </em> width, height: the size of the SVG graphic, in pixels * cx, cy, r: the center and radius of the pie * lx, ly: the upper-left corner of the chart legend * data: an object whose property names are data labels and whose * property values are the values associated with each label <em> </em> The function returns an <svg> element. The caller must insert it into * the document in order to make it visible. */</p>
<hr />
<div class="sourceCode" id="cb38"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb38-1" title="1"><span class="kw">function</span> <span class="at">pieChart</span>(options) <span class="op">{</span></a>
<a class="sourceLine" id="cb38-2" title="2">  <span class="kw">let</span> <span class="op">{</span> width<span class="op">,</span> height<span class="op">,</span> cx<span class="op">,</span> cy<span class="op">,</span> r<span class="op">,</span> lx<span class="op">,</span> ly<span class="op">,</span> data <span class="op">}</span> <span class="op">=</span> options<span class="op">;</span></a>
<a class="sourceLine" id="cb38-3" title="3"></a>
<a class="sourceLine" id="cb38-4" title="4">  <span class="co">// This is the XML namespace for svg elements</span></a>
<a class="sourceLine" id="cb38-5" title="5">  <span class="kw">let</span> svg <span class="op">=</span> <span class="st">&quot;http://www.w3.org/2000/svg&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb38-6" title="6"></a>
<a class="sourceLine" id="cb38-7" title="7">  <span class="co">// Create the &lt;svg&gt; element, and specify pixel size and user coordinates</span></a>
<a class="sourceLine" id="cb38-8" title="8">  <span class="kw">let</span> chart <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;svg&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-9" title="9">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;width&quot;</span><span class="op">,</span> width)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-10" title="10">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;height&quot;</span><span class="op">,</span> height)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-11" title="11">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;viewBox&quot;</span><span class="op">,</span> <span class="vs">`0 0 </span><span class="sc">${</span>width<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>height<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-12" title="12"></a>
<a class="sourceLine" id="cb38-13" title="13">  <span class="co">// Define the text styles we&#39;ll use for the chart. If we leave these</span></a>
<a class="sourceLine" id="cb38-14" title="14">  <span class="co">// values unset here, they can be set with CSS instead.</span></a>
<a class="sourceLine" id="cb38-15" title="15">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;font-family&quot;</span><span class="op">,</span> <span class="st">&quot;sans-serif&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-16" title="16">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;font-size&quot;</span><span class="op">,</span> <span class="st">&quot;18&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-17" title="17"></a>
<a class="sourceLine" id="cb38-18" title="18">  <span class="co">// Get labels and values as arrays and add up the values so we know how</span></a>
<a class="sourceLine" id="cb38-19" title="19">  <span class="co">// big the pie is.</span></a>
<a class="sourceLine" id="cb38-20" title="20">  <span class="kw">let</span> labels <span class="op">=</span> <span class="va">Object</span>.<span class="at">keys</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-21" title="21">  <span class="kw">let</span> values <span class="op">=</span> <span class="va">Object</span>.<span class="at">values</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-22" title="22">  <span class="kw">let</span> total <span class="op">=</span> <span class="va">values</span>.<span class="at">reduce</span>((x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-23" title="23"></a>
<a class="sourceLine" id="cb38-24" title="24">  <span class="co">// Figure out the angles for all the slices. Slice i starts at angles[i]</span></a>
<a class="sourceLine" id="cb38-25" title="25">  <span class="co">// and ends at angles[i+1]. The angles are measured in radians.</span></a>
<a class="sourceLine" id="cb38-26" title="26">  <span class="kw">let</span> angles <span class="op">=</span> [<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb38-27" title="27">  <span class="va">values</span>.<span class="at">forEach</span>((x<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="va">angles</span>.<span class="at">push</span>(angles[i] <span class="op">+</span> (x / total) <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">PI</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb38-28" title="28"></a>
<a class="sourceLine" id="cb38-29" title="29">  <span class="co">// Now loop through the slices of the pie</span></a>
<a class="sourceLine" id="cb38-30" title="30">  <span class="va">values</span>.<span class="at">forEach</span>((value<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-31" title="31">    <span class="co">// Compute the two points where our slice intersects the circle</span></a>
<a class="sourceLine" id="cb38-32" title="32">    <span class="co">// These formulas are chosen so that an angle of 0 is at 12 o&#39;clock</span></a>
<a class="sourceLine" id="cb38-33" title="33">    <span class="co">// and positive angles increase clockwise.</span></a>
<a class="sourceLine" id="cb38-34" title="34">    <span class="kw">let</span> x1 <span class="op">=</span> cx <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angles[i])<span class="op">;</span></a>
<a class="sourceLine" id="cb38-35" title="35">    <span class="kw">let</span> y1 <span class="op">=</span> cy <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angles[i])<span class="op">;</span></a>
<a class="sourceLine" id="cb38-36" title="36">    <span class="kw">let</span> x2 <span class="op">=</span> cx <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angles[i <span class="op">+</span> <span class="dv">1</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb38-37" title="37">    <span class="kw">let</span> y2 <span class="op">=</span> cy <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angles[i <span class="op">+</span> <span class="dv">1</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb38-38" title="38"></a>
<a class="sourceLine" id="cb38-39" title="39">    <span class="co">// This is a flag for angles larger than a half circle</span></a>
<a class="sourceLine" id="cb38-40" title="40">    <span class="co">// It is required by the SVG arc drawing component</span></a>
<a class="sourceLine" id="cb38-41" title="41">    <span class="kw">let</span> big <span class="op">=</span> angles[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">-</span> angles[i] <span class="op">&gt;</span> <span class="va">Math</span>.<span class="at">PI</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb38-42" title="42"></a>
<a class="sourceLine" id="cb38-43" title="43">    <span class="co">// This string describes how to draw a slice of the pie chart:</span></a>
<a class="sourceLine" id="cb38-44" title="44">    <span class="kw">let</span> path <span class="op">=</span></a>
<a class="sourceLine" id="cb38-45" title="45">      <span class="vs">`M</span><span class="sc">${</span>cx<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>cy<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span> <span class="co">// Move to circle center.</span></a>
<a class="sourceLine" id="cb38-46" title="46">      <span class="vs">`L</span><span class="sc">${</span>x1<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>y1<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span> <span class="co">// Draw line to (x1,y1).</span></a>
<a class="sourceLine" id="cb38-47" title="47">      <span class="vs">`A</span><span class="sc">${</span>r<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>r<span class="sc">}</span><span class="vs"> 0 </span><span class="sc">${</span>big<span class="sc">}</span><span class="vs"> 1`</span> <span class="op">+</span> <span class="co">// Draw an arc of radius r...</span></a>
<a class="sourceLine" id="cb38-48" title="48">      <span class="vs">`</span><span class="sc">${</span>x2<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>y2<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span> <span class="co">// ...ending at to (x2,y2).</span></a>
<a class="sourceLine" id="cb38-49" title="49">      <span class="st">&quot;Z&quot;</span><span class="op">;</span> <span class="co">// Close path back to (cx,cy).</span></a>
<a class="sourceLine" id="cb38-50" title="50"></a>
<a class="sourceLine" id="cb38-51" title="51">    <span class="co">// Compute the CSS color for this slice. This formula works for only</span></a>
<a class="sourceLine" id="cb38-52" title="52">    <span class="co">// about 15 colors. So don&#39;t include more than 15 slices in a chart.</span></a>
<a class="sourceLine" id="cb38-53" title="53">    <span class="kw">let</span> color <span class="op">=</span> <span class="vs">`hsl(</span><span class="sc">${</span>(i <span class="op">*</span> <span class="dv">40</span>) <span class="op">%</span> <span class="dv">360</span><span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="dv">90</span> <span class="op">-</span> <span class="dv">3</span> <span class="op">*</span> i<span class="sc">}</span><span class="vs">%,</span><span class="sc">${</span><span class="dv">50</span> <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> i<span class="sc">}</span><span class="vs">%)`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb38-54" title="54"></a>
<a class="sourceLine" id="cb38-55" title="55">    <span class="co">// We describe a slice with a &lt;path&gt; element. Note createElementNS().</span></a>
<a class="sourceLine" id="cb38-56" title="56">    <span class="kw">let</span> slice <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;path&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-57" title="57"></a>
<a class="sourceLine" id="cb38-58" title="58">    <span class="co">// Now set attributes on the &lt;path&gt; element</span></a>
<a class="sourceLine" id="cb38-59" title="59">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;d&quot;</span><span class="op">,</span> path)<span class="op">;</span> <span class="co">// Set the path for this slice</span></a>
<a class="sourceLine" id="cb38-60" title="60">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;fill&quot;</span><span class="op">,</span> color)<span class="op">;</span> <span class="co">// Set slice color</span></a>
<a class="sourceLine" id="cb38-61" title="61">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke&quot;</span><span class="op">,</span> <span class="st">&quot;black&quot;</span>)<span class="op">;</span> <span class="co">// Outline slice in black</span></a>
<a class="sourceLine" id="cb38-62" title="62">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke-width&quot;</span><span class="op">,</span> <span class="st">&quot;1&quot;</span>)<span class="op">;</span> <span class="co">// 1 CSS pixel thick</span></a>
<a class="sourceLine" id="cb38-63" title="63">    <span class="va">chart</span>.<span class="at">append</span>(slice)<span class="op">;</span> <span class="co">// Add slice to chart</span></a>
<a class="sourceLine" id="cb38-64" title="64"></a>
<a class="sourceLine" id="cb38-65" title="65">    <span class="co">// Now draw a little matching square for the key</span></a>
<a class="sourceLine" id="cb38-66" title="66">    <span class="kw">let</span> icon <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;rect&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-67" title="67">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;x&quot;</span><span class="op">,</span> lx)<span class="op">;</span> <span class="co">// Position the square</span></a>
<a class="sourceLine" id="cb38-68" title="68">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;y&quot;</span><span class="op">,</span> ly <span class="op">+</span> <span class="dv">30</span> <span class="op">*</span> i)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-69" title="69">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;width&quot;</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">;</span> <span class="co">// Size the square</span></a>
<a class="sourceLine" id="cb38-70" title="70">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;height&quot;</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-71" title="71">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;fill&quot;</span><span class="op">,</span> color)<span class="op">;</span> <span class="co">// Same fill color as slice</span></a>
<a class="sourceLine" id="cb38-72" title="72">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke&quot;</span><span class="op">,</span> <span class="st">&quot;black&quot;</span>)<span class="op">;</span> <span class="co">// Same outline, too.</span></a>
<a class="sourceLine" id="cb38-73" title="73">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke-width&quot;</span><span class="op">,</span> <span class="st">&quot;1&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-74" title="74">    <span class="va">chart</span>.<span class="at">append</span>(icon)<span class="op">;</span> <span class="co">// Add to the chart</span></a>
<a class="sourceLine" id="cb38-75" title="75"></a>
<a class="sourceLine" id="cb38-76" title="76">    <span class="co">// And add a label to the right of the rectangle</span></a>
<a class="sourceLine" id="cb38-77" title="77">    <span class="kw">let</span> label <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;text&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-78" title="78">    <span class="va">label</span>.<span class="at">setAttribute</span>(<span class="st">&quot;x&quot;</span><span class="op">,</span> lx <span class="op">+</span> <span class="dv">30</span>)<span class="op">;</span> <span class="co">// Position the text</span></a>
<a class="sourceLine" id="cb38-79" title="79">    <span class="va">label</span>.<span class="at">setAttribute</span>(<span class="st">&quot;y&quot;</span><span class="op">,</span> ly <span class="op">+</span> <span class="dv">30</span> <span class="op">*</span> i <span class="op">+</span> <span class="dv">16</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-80" title="80">    <span class="va">label</span>.<span class="at">append</span>(<span class="vs">`</span><span class="sc">${</span>labels[i]<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span> <span class="co">// Add text to label</span></a>
<a class="sourceLine" id="cb38-81" title="81">    <span class="va">chart</span>.<span class="at">append</span>(label)<span class="op">;</span> <span class="co">// Add label to the chart</span></a>
<a class="sourceLine" id="cb38-82" title="82">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-83" title="83"></a>
<a class="sourceLine" id="cb38-84" title="84">  <span class="cf">return</span> chart<span class="op">;</span></a>
<a class="sourceLine" id="cb38-85" title="85"><span class="op">}</span></a>
<a class="sourceLine" id="cb38-86" title="86"></a>
<a class="sourceLine" id="cb38-87" title="87"><span class="kw">function</span> <span class="at">pipe</span>(readable<span class="op">,</span> writable<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb38-88" title="88">  <span class="co">// First, set up error handling</span></a>
<a class="sourceLine" id="cb38-89" title="89">  <span class="kw">function</span> <span class="at">handleError</span>(err) <span class="op">{</span></a>
<a class="sourceLine" id="cb38-90" title="90">    <span class="va">readable</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb38-91" title="91">    <span class="va">writable</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb38-92" title="92">    <span class="at">callback</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-93" title="93">  <span class="op">}</span></a>
<a class="sourceLine" id="cb38-94" title="94"></a>
<a class="sourceLine" id="cb38-95" title="95">  <span class="co">// Next define the pipe and handle the normal termination case</span></a>
<a class="sourceLine" id="cb38-96" title="96">  readable</a>
<a class="sourceLine" id="cb38-97" title="97">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> handleError)</a>
<a class="sourceLine" id="cb38-98" title="98">    .<span class="at">pipe</span>(writable)</a>
<a class="sourceLine" id="cb38-99" title="99">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> handleError)</a>
<a class="sourceLine" id="cb38-100" title="100">    .<span class="at">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> callback)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-101" title="101"><span class="op">}</span></a>
<a class="sourceLine" id="cb38-102" title="102"></a>
<a class="sourceLine" id="cb38-103" title="103"><span class="co">// Define a regular polygon with n sides, centered at (x,y) with radius r.</span></a>
<a class="sourceLine" id="cb38-104" title="104"><span class="co">// The vertices are equally spaced along the circumference of a circle.</span></a>
<a class="sourceLine" id="cb38-105" title="105"><span class="co">// Put the first vertex straight up or at the specified angle.</span></a>
<a class="sourceLine" id="cb38-106" title="106"><span class="co">// Rotate clockwise, unless the last argument is true.</span></a>
<a class="sourceLine" id="cb38-107" title="107"><span class="kw">function</span> <span class="at">polygon</span>(c<span class="op">,</span> n<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> r<span class="op">,</span> angle <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> counterclockwise <span class="op">=</span> <span class="kw">false</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb38-108" title="108">  <span class="va">c</span>.<span class="at">moveTo</span>(</a>
<a class="sourceLine" id="cb38-109" title="109">    x <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angle)<span class="op">,</span> <span class="co">// Begin a new subpath at the first vertex</span></a>
<a class="sourceLine" id="cb38-110" title="110">    y <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angle)</a>
<a class="sourceLine" id="cb38-111" title="111">  )<span class="op">;</span> <span class="co">// Use trigonometry to compute position</span></a>
<a class="sourceLine" id="cb38-112" title="112">  <span class="kw">let</span> delta <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">PI</span>) / n<span class="op">;</span> <span class="co">// Angular distance between vertices</span></a>
<a class="sourceLine" id="cb38-113" title="113">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb38-114" title="114">    <span class="co">// For each of the remaining vertices</span></a>
<a class="sourceLine" id="cb38-115" title="115">    angle <span class="op">+=</span> counterclockwise <span class="op">?</span> <span class="op">-</span>delta : delta<span class="op">;</span> <span class="co">// Adjust angle</span></a>
<a class="sourceLine" id="cb38-116" title="116">    <span class="va">c</span>.<span class="at">lineTo</span>(</a>
<a class="sourceLine" id="cb38-117" title="117">      x <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angle)<span class="op">,</span> <span class="co">// Add line to next vertex</span></a>
<a class="sourceLine" id="cb38-118" title="118">      y <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angle)</a>
<a class="sourceLine" id="cb38-119" title="119">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb38-120" title="120">  <span class="op">}</span></a>
<a class="sourceLine" id="cb38-121" title="121">  <span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Connect last vertex back to the first</span></a>
<a class="sourceLine" id="cb38-122" title="122"><span class="op">}</span></a>
<a class="sourceLine" id="cb38-123" title="123"></a>
<a class="sourceLine" id="cb38-124" title="124"><span class="co">// Assume there is just one canvas, and get its context object to draw with.</span></a>
<a class="sourceLine" id="cb38-125" title="125"><span class="kw">let</span> c <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;canvas&quot;</span>).<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-126" title="126"></a>
<a class="sourceLine" id="cb38-127" title="127"><span class="co">// Start a new path and add polygon subpaths</span></a>
<a class="sourceLine" id="cb38-128" title="128"><span class="va">c</span>.<span class="at">beginPath</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb38-129" title="129"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span> <span class="co">// Triangle</span></a>
<a class="sourceLine" id="cb38-130" title="130"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">4</span>)<span class="op">;</span> <span class="co">// Square</span></a>
<a class="sourceLine" id="cb38-131" title="131"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">55</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span> <span class="co">// Pentagon</span></a>
<a class="sourceLine" id="cb38-132" title="132"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">365</span><span class="op">,</span> <span class="dv">53</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">6</span>)<span class="op">;</span> <span class="co">// Hexagon</span></a>
<a class="sourceLine" id="cb38-133" title="133"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">365</span><span class="op">,</span> <span class="dv">53</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">4</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="co">// Small square inside the hexagon</span></a>
<a class="sourceLine" id="cb38-134" title="134"></a>
<a class="sourceLine" id="cb38-135" title="135"><span class="co">// Set some properties that control how the graphics will look</span></a>
<a class="sourceLine" id="cb38-136" title="136"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#ccc&quot;</span><span class="op">;</span> <span class="co">// Light gray interiors</span></a>
<a class="sourceLine" id="cb38-137" title="137"><span class="va">c</span>.<span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">&quot;#008&quot;</span><span class="op">;</span> <span class="co">// outlined with dark blue lines</span></a>
<a class="sourceLine" id="cb38-138" title="138"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">5</span><span class="op">;</span> <span class="co">// five pixels wide.</span></a>
<a class="sourceLine" id="cb38-139" title="139"></a>
<a class="sourceLine" id="cb38-140" title="140"><span class="co">// Now draw all the polygons (each in its own subpath) with these calls</span></a>
<a class="sourceLine" id="cb38-141" title="141"><span class="va">c</span>.<span class="at">fill</span>()<span class="op">;</span> <span class="co">// Fill the shapes</span></a>
<a class="sourceLine" id="cb38-142" title="142"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span> <span class="co">// And stroke their outlines</span></a>
<a class="sourceLine" id="cb38-143" title="143"></a>
<a class="sourceLine" id="cb38-144" title="144"><span class="kw">const</span> https <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;https&quot;</span>)<span class="op">;</span></a></code></pre></div>
<hr />
<p>/<em> </em> Convert the body object to a JSON string then HTTPS POST it to the * specified API endpoint on the specified host. When the response arrives, * parse the response body as JSON and resolve the returned Promise with * that parsed value. */</p>
<hr />
<p>```js function postJSON(host, endpoint, body, port, username, password) { // Return a Promise object immediately, then call resolve or reject // when the HTTPS request succeeds or fails. return new Promise((resolve, reject) =&gt; { // Convert the body object to a string let bodyText = JSON.stringify(body);</p>
<pre><code>// Configure the HTTPS request
let requestOptions = {
  method: &quot;POST&quot;, // Or &quot;GET&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, etc.
  host: host, // The host to connect to
  path: endpoint, // The URL path
  headers: {
    // HTTP headers for the request
    &quot;Content-Type&quot;: &quot;application/json&quot;,
    &quot;Content-Length&quot;: Buffer.byteLength(bodyText),
  },
};

if (port) {
  // If a port is specified,
  requestOptions.port = port; // use it for the request.
}
// If credentials are specified, add an Authorization header.
if (username &amp;&amp; password) {
  requestOptions.auth = `${username}:${password}`;
}

// Now create the request based on the configuration object
let request = https.request(requestOptions);

// Write the body of the POST request and end the request.
request.write(bodyText);
request.end();

// Fail on request errors (such as no network connection)
request.on(&quot;error&quot;, (e) =&gt; reject(e));

// Handle the response when it starts to arrive.
request.on(&quot;response&quot;, (response) =&gt; {
  if (response.statusCode !== 200) {
    reject(new Error(`HTTP status ${response.statusCode}`));
    // We don&#39;t care about the response body in this case, but
    // we don&#39;t want it to stick around in a buffer somewhere, so
    // we put the stream into flowing mode without registering
    // a &quot;data&quot; handler so that the body is discarded.
    response.resume();
    return;
  }

  // We want text, not bytes. We&#39;re assuming the text will be
  // JSON-formatted but aren&#39;t bothering to check the
  // Content-Type header.
  response.setEncoding(&quot;utf8&quot;);

  // Node doesn&#39;t have a streaming JSON parser, so we read the
  // entire response body into a string.
  let body = &quot;&quot;;
  response.on(&quot;data&quot;, (chunk) =&gt; {
    body += chunk;
  });

  // And now handle the response when it is complete.
  response.on(&quot;end&quot;, () =&gt; {
    // When the response is done,
    try {
      // try to parse it as JSON
      resolve(JSON.parse(body)); // and resolve the result.
    } catch (e) {
      // Or, if anything goes wrong,
      reject(e); // reject with the error
    }
  });
});</code></pre>
<p>}); }</p>
<p>// This function takes an array of input values and a “promiseMaker” function. // For any input value x in the array, promiseMaker(x) should return a Promise // that will fulfill to an output value. This function returns a Promise // that fulfills to an array of the computed output values. // // Rather than creating the Promises all at once and letting them run in // parallel, however, promiseSequence() only runs one Promise at a time // and does not call promiseMaker() for a value until the previous Promise // has fulfilled. function promiseSequence(inputs, promiseMaker) { // Make a private copy of the array that we can modify inputs = […inputs];</p>
<p>// Here’s the function that we’ll use as a Promise callback // This is the pseudorecursive magic that makes this all work. function handleNextInput(outputs) { if (inputs.length === 0) { // If there are no more inputs left, then return the array // of outputs, finally fulfilling this Promise and all the // previous resolved-but-not-fulfilled Promises. return outputs; } else { // If there are still input values to process, then we’ll // return a Promise object, resolving the current Promise // with the future value from a new Promise. let nextInput = inputs.shift(); // Get the next input value, return ( promiseMaker(nextInput) // compute the next output value, // Then create a new outputs array with the new output value .then((output) =&gt; outputs.concat(output)) // Then “recurse”, passing the new, longer, outputs array .then(handleNextInput) ); } }</p>
<p>// Start with a Promise that fulfills to an empty array and use // the function above as its callback. return Promise.resolve([]).then(handleNextInput); }</p>
<p>// Given a URL, return a Promise that fulfills to the URL body text function fetchBody(url) { return fetch(url).then((r) =&gt; r.text()); } // Use it to sequentially fetch a bunch of URL bodies promiseSequence(urls, fetchBody) .then((bodies) =&gt; { /* do something with the array of strings */</p>
<hr />
<p>```js }) .catch(console.error);</p>
<p>// This object has accessor properties that return random numbers. // The expression “random.octet”, for example, yields a random number // between 0 and 255 each time it is evaluated. const random = { get octet() { return Math.floor(Math.random() * 256); }, get uint16() { return Math.floor(Math.random() * 65536); }, get int16() { return Math.floor(Math.random() * 65536) - 32768; }, };</p>
<p>// This is a factory function that returns a new range object. function range(from, to) { // Use Object.create() to create an object that inherits from the // prototype object defined below. The prototype object is stored as // a property of this function, and defines the shared methods (behavior) // for all range objects. let r = Object.create(range.methods);</p>
<p>// Store the start and end points (state) of this new range object. // These are noninherited properties that are unique to this object. r.from = from; r.to = to;</p>
<p>// Finally return the new object return r; }</p>
<p>// This prototype object defines methods inherited by all range objects. range.methods = { // Return true if x is in the range, false otherwise // This method works for textual and Date ranges as well as numeric. includes(x) { return this.from &lt;= x &amp;&amp; x &lt;= this.to; },</p>
<p>// A generator function that makes instances of the class iterable. // Note that it only works for numeric ranges. *<a href="">Symbol.iterator</a> { for (let x = Math.ceil(this.from); x &lt;= this.to; x++) yield x; },</p>
<p>// Return a string representation of the range toString() { return “(” + this.from + “…” + this.to + “)”; }, };</p>
<p>// This is a constructor function that initializes new Range objects. // Note that it does not create or return the object. It just initializes this. function Range(from, to) { // Store the start and end points (state) of this new range object. // These are noninherited properties that are unique to this object. this.from = from; this.to = to; }</p>
<p>// All Range objects inherit from this object. // Note that the property name must be “prototype” for this to work. Range.prototype = { // Return true if x is in the range, false otherwise // This method works for textual and Date ranges as well as numeric. includes: function (x) { return this.from &lt;= x &amp;&amp; x &lt;= this.to; },</p>
<p>// A generator function that makes instances of the class iterable. // Note that it only works for numeric ranges. [Symbol.iterator]: function* () { for (let x = Math.ceil(this.from); x &lt;= this.to; x++) yield x; },</p>
<p>// Return a string representation of the range toString: function () { return “(” + this.from + “…” + this.to + “)”; }, };</p>
<p>class Range { constructor(from, to) { // Store the start and end points (state) of this new range object. // These are noninherited properties that are unique to this object. this.from = from; this.to = to; }</p>
<p>// Return true if x is in the range, false otherwise // This method works for textual and Date ranges as well as numeric. includes(x) { return this.from &lt;= x &amp;&amp; x &lt;= this.to; }</p>
<p>// A generator function that makes instances of the class iterable. // Note that it only works for numeric ranges. *<a href="">Symbol.iterator</a> { for (let x = Math.ceil(this.from); x &lt;= this.to; x++) yield x; }</p>
<p>// Return a string representation of the range toString() { return <code>(${this.from}...${this.to})</code>; } }</p>
<p>const fs = require(“fs”); // Require the filesystem module</p>
<p>// Read a config file, parse its contents as JSON, and pass the // resulting value to the callback. If anything goes wrong, // print an error message to stderr and invoke the callback with null function readConfigFile(path, callback) { fs.readFile(path, “utf8”, (err, text) =&gt; { if (err) { // Something went wrong reading the file console.error(err); callback(null); return; } let data = null; try { data = JSON.parse(text); } catch (e) { // Something went wrong parsing the file contents console.error(e); } callback(data); }); }</p>
<p>const util = require(“util”); const fs = require(“fs”); // Require the filesystem module const pfs = { // Promise-based variants of some fs functions readFile: util.promisify(fs.readFile), };</p>
<p>function readConfigFile(path) { return pfs.readFile(path, “utf-8”).then((text) =&gt; { return JSON.parse(text); }); }</p>
<p>const fs = require(“fs”); const util = require(“util”); const pfs = { readFile: util.promisify(fs.readFile) };</p>
<p>async function readConfigFile(path) { let text = await pfs.readFile(path, “utf-8”); return JSON.parse(text); }</p>
<p>const fs = require(“fs”); function readConfigFileSync(path) { let text = fs.readFileSync(path, “utf-8”); return JSON.parse(text); }</p>
<p>function readOnlyProxy(o) { function readonly() { throw new TypeError(“Readonly”); } return new Proxy(o, { set: readonly, defineProperty: readonly, deleteProperty: readonly, setPrototypeOf: readonly, }); }</p>
<p>let o = { x: 1, y: 2 }; // Normal writable object let p = readOnlyProxy(o); // Readonly version of it p.x; // =&gt; 1: reading properties works p.x = 2; // !TypeError: can’t change properties delete p.y; // !TypeError: can’t delete properties p.z = 3; // !TypeError: can’t add properties p.__proto__ = {}; // !TypeError: can’t change the prototype</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> This class defines a custom HTML <search-box> element that displays an </em> <input> text input field plus two icons or emoji. By default, it displays a * magnifying glass emoji (indicating search) to the left of the text field * and an X emoji (indicating cancel) to the right of the text field. It * hides the border on the input field and displays a border around itself, * creating the appearance that the two emoji are inside the input * field. Similarly, when the internal input field is focused, the focus ring * is displayed around the <search-box>. <em> </em> You can override the default icons by including <span> or <img> children * of <search-box> with slot=“left” and slot=“right” attributes. <em> </em> <search-box> supports the normal HTML disabled and hidden attributes and * also size and placeholder attributes, which have the same meaning for this * element as they do for the <input> element. <em> </em> Input events from the internal <input> element bubble up and appear with * their target field set to the <search-box> element. <em> </em> The element fires a “search” event with the detail property set to the * current input string when the user clicks on the left emoji (the magnifying * glass). The “search” event is also dispatched when the internal text field * generates a “change” event (when the text has changed and the user types * Return or Tab). <em> </em> The element fires a “clear” event when the user clicks on the right emoji * (the X). If no handler calls preventDefault() on the event then the element * clears the user’s input once event dispatch is complete. <em> </em> Note that there are no onsearch and onclear properties or attributes: * handlers for the “search” and “clear” events can only be registered with * addEventListener(). */</p>
<hr />
<div class="sourceCode" id="cb40"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb40-1" title="1"><span class="kw">class</span> SearchBox <span class="kw">extends</span> HTMLElement <span class="op">{</span></a>
<a class="sourceLine" id="cb40-2" title="2">  <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb40-3" title="3">    <span class="kw">super</span>()<span class="op">;</span> <span class="co">// Invoke the superclass constructor; must be first.</span></a>
<a class="sourceLine" id="cb40-4" title="4"></a>
<a class="sourceLine" id="cb40-5" title="5">    <span class="co">// Create a shadow DOM tree and attach it to this element, setting</span></a>
<a class="sourceLine" id="cb40-6" title="6">    <span class="co">// the value of this.shadowRoot.</span></a>
<a class="sourceLine" id="cb40-7" title="7">    <span class="kw">this</span>.<span class="at">attachShadow</span>(<span class="op">{</span> <span class="dt">mode</span><span class="op">:</span> <span class="st">&quot;open&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-8" title="8"></a>
<a class="sourceLine" id="cb40-9" title="9">    <span class="co">// Clone the template that defines the descendants and stylesheet for</span></a>
<a class="sourceLine" id="cb40-10" title="10">    <span class="co">// this custom component, and append that content to the shadow root.</span></a>
<a class="sourceLine" id="cb40-11" title="11">    <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">append</span>(<span class="va">SearchBox</span>.<span class="va">template</span>.<span class="va">content</span>.<span class="at">cloneNode</span>(<span class="kw">true</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb40-12" title="12"></a>
<a class="sourceLine" id="cb40-13" title="13">    <span class="co">// Get references to the important elements in the shadow DOM</span></a>
<a class="sourceLine" id="cb40-14" title="14">    <span class="kw">this</span>.<span class="at">input</span> <span class="op">=</span> <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">querySelector</span>(<span class="st">&quot;#input&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-15" title="15">    <span class="kw">let</span> leftSlot <span class="op">=</span> <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">querySelector</span>(<span class="st">&#39;slot[name=&quot;left&quot;]&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-16" title="16">    <span class="kw">let</span> rightSlot <span class="op">=</span> <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">querySelector</span>(<span class="st">&#39;slot[name=&quot;right&quot;]&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-17" title="17"></a>
<a class="sourceLine" id="cb40-18" title="18">    <span class="co">// When the internal input field gets or loses focus, set or remove</span></a>
<a class="sourceLine" id="cb40-19" title="19">    <span class="co">// the &quot;focused&quot; attribute which will cause our internal stylesheet</span></a>
<a class="sourceLine" id="cb40-20" title="20">    <span class="co">// to display or hide a fake focus ring on the entire component. Note</span></a>
<a class="sourceLine" id="cb40-21" title="21">    <span class="co">// that the &quot;blur&quot; and &quot;focus&quot; events bubble and appear to originate</span></a>
<a class="sourceLine" id="cb40-22" title="22">    <span class="co">// from the &lt;search-box&gt;.</span></a>
<a class="sourceLine" id="cb40-23" title="23">    <span class="kw">this</span>.<span class="va">input</span>.<span class="at">onfocus</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-24" title="24">      <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;focused&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-25" title="25">    <span class="op">};</span></a>
<a class="sourceLine" id="cb40-26" title="26">    <span class="kw">this</span>.<span class="va">input</span>.<span class="at">onblur</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-27" title="27">      <span class="kw">this</span>.<span class="at">removeAttribute</span>(<span class="st">&quot;focused&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-28" title="28">    <span class="op">};</span></a>
<a class="sourceLine" id="cb40-29" title="29"></a>
<a class="sourceLine" id="cb40-30" title="30">    <span class="co">// If the user clicks on the magnifying glass, trigger a &quot;search&quot;</span></a>
<a class="sourceLine" id="cb40-31" title="31">    <span class="co">// event.  Also trigger it if the input field fires a &quot;change&quot;</span></a>
<a class="sourceLine" id="cb40-32" title="32">    <span class="co">// event. (The &quot;change&quot; event does not bubble out of the Shadow DOM.)</span></a>
<a class="sourceLine" id="cb40-33" title="33">    <span class="va">leftSlot</span>.<span class="at">onclick</span> <span class="op">=</span> <span class="kw">this</span>.<span class="va">input</span>.<span class="at">onchange</span> <span class="op">=</span> (event) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-34" title="34">      <span class="va">event</span>.<span class="at">stopPropagation</span>()<span class="op">;</span> <span class="co">// Prevent click events from bubbling</span></a>
<a class="sourceLine" id="cb40-35" title="35">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">disabled</span>) <span class="cf">return</span><span class="op">;</span> <span class="co">// Do nothing when disabled</span></a>
<a class="sourceLine" id="cb40-36" title="36">      <span class="kw">this</span>.<span class="at">dispatchEvent</span>(</a>
<a class="sourceLine" id="cb40-37" title="37">        <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&quot;search&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-38" title="38">          <span class="dt">detail</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">input</span>.<span class="at">value</span><span class="op">,</span></a>
<a class="sourceLine" id="cb40-39" title="39">        <span class="op">}</span>)</a>
<a class="sourceLine" id="cb40-40" title="40">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb40-41" title="41">    <span class="op">};</span></a>
<a class="sourceLine" id="cb40-42" title="42"></a>
<a class="sourceLine" id="cb40-43" title="43">    <span class="co">// If the user clicks on the X, trigger a &quot;clear&quot; event.</span></a>
<a class="sourceLine" id="cb40-44" title="44">    <span class="co">// If preventDefault() is not called on the event, clear the input.</span></a>
<a class="sourceLine" id="cb40-45" title="45">    <span class="va">rightSlot</span>.<span class="at">onclick</span> <span class="op">=</span> (event) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-46" title="46">      <span class="va">event</span>.<span class="at">stopPropagation</span>()<span class="op">;</span> <span class="co">// Don&#39;t let the click bubble up</span></a>
<a class="sourceLine" id="cb40-47" title="47">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">disabled</span>) <span class="cf">return</span><span class="op">;</span> <span class="co">// Don&#39;t do anything if disabled</span></a>
<a class="sourceLine" id="cb40-48" title="48">      <span class="kw">let</span> e <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&quot;clear&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">cancelable</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-49" title="49">      <span class="kw">this</span>.<span class="at">dispatchEvent</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-50" title="50">      <span class="cf">if</span> (<span class="op">!</span><span class="va">e</span>.<span class="at">defaultPrevented</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-51" title="51">        <span class="co">// If the event was not &quot;cancelled&quot;</span></a>
<a class="sourceLine" id="cb40-52" title="52">        <span class="kw">this</span>.<span class="va">input</span>.<span class="at">value</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// then clear the input field</span></a>
<a class="sourceLine" id="cb40-53" title="53">      <span class="op">}</span></a>
<a class="sourceLine" id="cb40-54" title="54">    <span class="op">};</span></a>
<a class="sourceLine" id="cb40-55" title="55">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-56" title="56"></a>
<a class="sourceLine" id="cb40-57" title="57">  <span class="co">// When some of our attributes are set or changed, we need to set the</span></a>
<a class="sourceLine" id="cb40-58" title="58">  <span class="co">// corresponding value on the internal &lt;input&gt; element. This life cycle</span></a>
<a class="sourceLine" id="cb40-59" title="59">  <span class="co">// method, together with the static observedAttributes property below,</span></a>
<a class="sourceLine" id="cb40-60" title="60">  <span class="co">// takes care of that.</span></a>
<a class="sourceLine" id="cb40-61" title="61">  <span class="at">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-62" title="62">    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;disabled&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-63" title="63">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">disabled</span> <span class="op">=</span> newValue <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb40-64" title="64">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;placeholder&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-65" title="65">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">placeholder</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb40-66" title="66">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;size&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-67" title="67">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">size</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb40-68" title="68">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;value&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-69" title="69">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">value</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb40-70" title="70">    <span class="op">}</span></a>
<a class="sourceLine" id="cb40-71" title="71">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-72" title="72"></a>
<a class="sourceLine" id="cb40-73" title="73">  <span class="co">// Finally, we define property getters and setters for properties that</span></a>
<a class="sourceLine" id="cb40-74" title="74">  <span class="co">// correspond to the HTML attributes we support. The getters simply return</span></a>
<a class="sourceLine" id="cb40-75" title="75">  <span class="co">// the value (or the presence) of the attribute. And the setters just set</span></a>
<a class="sourceLine" id="cb40-76" title="76">  <span class="co">// the value (or the presence) of the attribute. When a setter method</span></a>
<a class="sourceLine" id="cb40-77" title="77">  <span class="co">// changes an attribute, the browser will automatically invoke the</span></a>
<a class="sourceLine" id="cb40-78" title="78">  <span class="co">// attributeChangedCallback above.</span></a>
<a class="sourceLine" id="cb40-79" title="79"></a>
<a class="sourceLine" id="cb40-80" title="80">  get <span class="at">placeholder</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb40-81" title="81">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;placeholder&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-82" title="82">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-83" title="83">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb40-84" title="84">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;size&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-85" title="85">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-86" title="86">  get <span class="at">value</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb40-87" title="87">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;value&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-88" title="88">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-89" title="89">  get <span class="at">disabled</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb40-90" title="90">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">hasAttribute</span>(<span class="st">&quot;disabled&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-91" title="91">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-92" title="92">  get <span class="at">hidden</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb40-93" title="93">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">hasAttribute</span>(<span class="st">&quot;hidden&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-94" title="94">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-95" title="95"></a>
<a class="sourceLine" id="cb40-96" title="96">  set <span class="at">placeholder</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-97" title="97">    <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;placeholder&quot;</span><span class="op">,</span> value)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-98" title="98">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-99" title="99">  set <span class="at">size</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-100" title="100">    <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;size&quot;</span><span class="op">,</span> value)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-101" title="101">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-102" title="102">  set <span class="at">value</span>(text) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-103" title="103">    <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;value&quot;</span><span class="op">,</span> text)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-104" title="104">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-105" title="105">  set <span class="at">disabled</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-106" title="106">    <span class="cf">if</span> (value) <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;disabled&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-107" title="107">    <span class="cf">else</span> <span class="kw">this</span>.<span class="at">removeAttribute</span>(<span class="st">&quot;disabled&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-108" title="108">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-109" title="109">  set <span class="at">hidden</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-110" title="110">    <span class="cf">if</span> (value) <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;hidden&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-111" title="111">    <span class="cf">else</span> <span class="kw">this</span>.<span class="at">removeAttribute</span>(<span class="st">&quot;hidden&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-112" title="112">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-113" title="113"><span class="op">}</span></a>
<a class="sourceLine" id="cb40-114" title="114"></a>
<a class="sourceLine" id="cb40-115" title="115"><span class="co">// This static field is required for the attributeChangedCallback method.</span></a>
<a class="sourceLine" id="cb40-116" title="116"><span class="co">// Only attributes named in this array will trigger calls to that method.</span></a>
<a class="sourceLine" id="cb40-117" title="117"><span class="va">SearchBox</span>.<span class="at">observedAttributes</span> <span class="op">=</span> [<span class="st">&quot;disabled&quot;</span><span class="op">,</span> <span class="st">&quot;placeholder&quot;</span><span class="op">,</span> <span class="st">&quot;size&quot;</span><span class="op">,</span> <span class="st">&quot;value&quot;</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb40-118" title="118"></a>
<a class="sourceLine" id="cb40-119" title="119"><span class="co">// Create a &lt;template&gt; element to hold the stylesheet and the tree of</span></a>
<a class="sourceLine" id="cb40-120" title="120"><span class="co">// elements that we&#39;ll use for each instance of the SearchBox element.</span></a>
<a class="sourceLine" id="cb40-121" title="121"><span class="va">SearchBox</span>.<span class="at">template</span> <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;template&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-122" title="122"></a>
<a class="sourceLine" id="cb40-123" title="123"><span class="co">// We initialize the template by parsing this string of HTML. Note, however,</span></a>
<a class="sourceLine" id="cb40-124" title="124"><span class="co">// that when we instantiate a SearchBox, we are able to just clone the nodes</span></a>
<a class="sourceLine" id="cb40-125" title="125"><span class="co">// in the template and do have to parse the HTML again.</span></a>
<a class="sourceLine" id="cb40-126" title="126"><span class="va">SearchBox</span>.<span class="va">template</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb40-127" title="127"><span class="vs">&lt;style&gt;</span></a></code></pre></div>
<hr />
<p>/<em> </em> The :host selector refers to the <search-box> element in the light * DOM. These styles are defaults and can be overridden by the user of the * <search-box> with styles in the light DOM. */</p>
<hr />
<p>```js :host { display: inline-block; /* The default is inline display */</p>
<hr />
<p>```js border: solid black 1px; /* A rounded border around the <input> and <slots> */</p>
<hr />
<p>```js border-radius: 5px; padding: 4px 6px; /* And some space inside the border */</p>
<hr />
<p>```js } :host([hidden]) { /* Note the parentheses: when host has hidden… */</p>
<hr />
<p>```js display:none; /* …attribute set don’t display it */</p>
<hr />
<p>```js } :host([disabled]) { /* When host has the disabled attribute… */</p>
<hr />
<p>```js opacity: 0.5; /* …gray it out */</p>
<hr />
<p>```js } :host([focused]) { /* When host has the focused attribute… */</p>
<hr />
<p>```js box-shadow: 0 0 2px 2px #6AE; /* display this fake focus ring. */</p>
<hr />
<p>```js }</p>
<p>/* The rest of the stylesheet only applies to elements in the Shadow DOM. */</p>
<hr />
<p>```js input { border-width: 0; /* Hide the border of the internal input field. */</p>
<hr />
<p>```js outline: none; /* Hide the focus ring, too. */</p>
<hr />
<p>```js font: inherit; /* <input> elements don’t inherit font by default */</p>
<hr />
<p>```js background: inherit; /* Same for background color. */</p>
<hr />
<p>```js } slot { cursor: default; /* An arrow pointer cursor over the buttons */</p>
<hr />
<p>```js user-select: none; /* Don’t let the user select the emoji text */</p>
<hr />
<p>``<code>js } &lt;/style&gt; &lt;div&gt;   &lt;slot name="left"&gt;\u{1f50d}&lt;/slot&gt;  &lt;!-- U+1F50D is a magnifying glass --&gt;   &lt;input type="text" id="input" /&gt;    &lt;!-- The actual input element --&gt;   &lt;slot name="right"&gt;\u{2573}&lt;/slot&gt;  &lt;!-- U+2573 is an X --&gt; &lt;/div&gt;</code>;</p>
<p>// Finally, we call customElement.define() to register the SearchBox element // as the implementation of the <search-box> tag. Custom elements are required // to have a tag name that contains a hyphen. customElements.define(“search-box”, SearchBox);</p>
<p>function* sequence(…iterables) { for (let iterable of iterables) { yield* iterable; } }</p>
<p>[…sequence(“abc”, oneDigitPrimes())]; // =&gt; [“a”,“b”,“c”,2,3,5,7]</p>
<p>// This object generates strictly increasing serial numbers const serialnum = { // This data property holds the next serial number. // The _ in the property name hints that it is for internal use only. _n: 0,</p>
<p>// Return the current value and increment it get next() { return this._n++; },</p>
<p>// Set a new value of n, but only if it is larger than current set next(n) { if (n &gt; this._n) this._n = n; else throw new Error(“serial number can only be set to a larger value”); }, }; serialnum.next = 10; // Set the starting serial number serialnum.next; // =&gt; 10 serialnum.next; // =&gt; 11: different value each time we get next</p>
<p>// Store the name/value pair as a cookie, encoding the value with // encodeURIComponent() in order to escape semicolons, commas, and spaces. // If daysToLive is a number, set the max-age attribute so that the cookie // expires after the specified number of days. Pass 0 to delete a cookie. function setCookie(name, value, daysToLive = null) { let cookie = <code>${name}=${encodeURIComponent(value)}</code>; if (daysToLive !== null) { cookie += <code>; max-age=${daysToLive * 60 * 60 * 24}</code>; } document.cookie = cookie; }</p>
<p>function setTheme(name) { // Create a new <link rel="stylesheet"> element to load the named stylesheet let link = document.createElement(“link”); link.id = “theme”; link.rel = “stylesheet”; link.href = <code>themes/${name}.css</code>;</p>
<p>// Look for an existing link with id “theme” let currentTheme = document.querySelector(“#theme”); if (currentTheme) { // If there is an existing theme, replace it with the new one. currentTheme.replaceWith(link); } else { // Otherwise, just insert the link to the theme stylesheet. document.head.append(link); } }</p>
<p>let authHeaders = new Headers(); // Don’t use Basic auth unless it is over an HTTPS connection. authHeaders.set(“Authorization”, <code>Basic ${btoa(</code><span class="math inline"><em>u</em><em>s</em><em>e</em><em>r</em><em>n</em><em>a</em><em>m</em><em>e</em>:</span>{password}<code>)}</code>); fetch(“/api/users/”, { headers: authHeaders }) .then((response) =&gt; response.json()) // Error handling omitted… .then((usersList) =&gt; displayAllUsers(usersList));</p>
<p>async function search(term) { let url = new URL(“/api/search”); url.searchParams.set(“q”, term); let response = await fetch(url); if (!response.ok) throw new Error(response.statusText); let resultsArray = await response.json(); return resultsArray; }</p>
<p>// Return the largest prime smaller than n, using the sieve of Eratosthenes function sieve(n) { let a = new Uint8Array(n + 1); // a[x] will be 1 if x is composite let max = Math.floor(Math.sqrt(n)); // Don’t do factors higher than this let p = 2; // 2 is the first prime while (p &lt;= max) { // For primes less than max for ( let i = 2 * p; i &lt;= n; i += p // Mark multiples of p as composite ) a[i] = 1; while (a[++p] /* empty */); // The next unmarked index is prime } while (a[n]) n–; // Loop backward to find the last prime return n; // And return it }</p>
<p>// Smear the pixels of the rectangle to the right, producing a // sort of motion blur as if objects are moving from right to left. // n must be 2 or larger. Larger values produce bigger smears. // The rectangle is specified in the default coordinate system. function smear(c, n, x, y, w, h) { // Get the ImageData object that represents the rectangle of pixels to smear let pixels = c.getImageData(x, y, w, h);</p>
<p>// This smear is done in-place and requires only the source ImageData. // Some image processing algorithms require an additional ImageData to // store transformed pixel values. If we needed an output buffer, we could // create a new ImageData with the same dimensions like this: // let output_pixels = c.createImageData(pixels);</p>
<p>// Get the dimensions of the grid of pixels in the ImageData object let width = pixels.width, height = pixels.height;</p>
<p>// This is the byte array that holds the raw pixel data, left-to-right and // top-to-bottom. Each pixel occupies 4 consecutive bytes in R,G,B,A order. let data = pixels.data;</p>
<p>// Each pixel after the first in each row is smeared by replacing it with // 1/nth of its own value plus m/nths of the previous pixel’s value let m = n - 1;</p>
<p>for (let row = 0; row &lt; height; row++) { // For each row let i = row * width * 4 + 4; // The offset of the second pixel of the row for (let col = 1; col &lt; width; col++, i += 4) { // For each column data[i] = (data[i] + data[i - 4] * m) / n; // Red pixel component data[i + 1] = (data[i + 1] + data[i - 3] * m) / n; // Green data[i + 2] = (data[i + 2] + data[i - 2] * m) / n; // Blue data[i + 3] = (data[i + 3] + data[i - 1] * m) / n; // Alpha component } }</p>
<p>// Now copy the smeared image data back to the same position on the canvas c.putImageData(pixels, x, y); }</p>
<p>const threads = require(“worker_threads”);</p>
<p>// The worker_threads module exports the boolean isMainThread property. // This property is true when Node is running the main thread and it is // false when Node is running a worker. We can use this fact to implement // the main and worker threads in the same file. if (threads.isMainThread) { // If we’re running in the main thread, then all we do is export // a function. Instead of performing a computationally intensive // task on the main thread, this function passes the task to a worker // and returns a Promise that will resolve when the worker is done. module.exports = function reticulateSplines(splines) { return new Promise((resolve, reject) =&gt; { // Create a worker that loads and runs this same file of code. // Note the use of the special __filename variable. let reticulator = new threads.Worker(__filename);</p>
<pre><code>  // Pass a copy of the splines array to the worker
  reticulator.postMessage(splines);

  // And then resolve or reject the Promise when we get
  // a message or error from the worker.
  reticulator.on(&quot;message&quot;, resolve);
  reticulator.on(&quot;error&quot;, reject);
});</code></pre>
<p>}; } else { // If we get here, it means we’re in the worker, so we register a // handler to get messages from the main thread. This worker is designed // to only receive a single message, so we register the event handler // with once() instead of on(). This allows the worker to exit naturally // when its work is complete. threads.parentPort.once(“message”, (splines) =&gt; { // When we get the splines from the parent thread, loop // through them and reticulate all of them. for (let spline of splines) { // For the sake of example, assume that spline objects usually // have a reticulate() method that does a lot of computation. spline.reticulate ? spline.reticulate() : (spline.reticulated = true); }</p>
<pre><code>// When all the splines have (finally!) been reticulated
// pass a copy back to the main thread.
threads.parentPort.postMessage(splines);</code></pre>
<p>}); }</p>
<p>// This is a simple static HTTP server that serves files from a specified // directory. It also implements a special /test/mirror endpoint that // echoes the incoming request, which can be useful when debugging clients. const http = require(“http”); // Use “https” if you have a certificate const url = require(“url”); // For parsing URLs const path = require(“path”); // For manipulating filesystem paths const fs = require(“fs”); // For reading files</p>
<p>// Serve files from the specified root directory via an HTTP server that // listens on the specified port. function serve(rootDirectory, port) { let server = new http.Server(); // Create a new HTTP server server.listen(port); // Listen on the specified port console.log(“Listening on port”, port);</p>
<p>// When requests come in, handle them with this function server.on(“request”, (request, response) =&gt; { // Get the path portion of the request URL, ignoring // any query parameters that are appended to it. let endpoint = url.parse(request.url).pathname;</p>
<pre><code>// If the request was for &quot;/test/mirror&quot;, send back the request
// verbatim. Useful when you need to see the request headers and body.
if (endpoint === &quot;/test/mirror&quot;) {
  // Set response header
  response.setHeader(&quot;Content-Type&quot;, &quot;text/plain; charset=UTF-8&quot;);

  // Specify response status code
  response.writeHead(200); // 200 OK

  // Begin the response body with the request
  response.write(
    `${request.method} ${request.url} HTTP/${request.httpVersion}\r\n`
  );

  // Output the request headers
  let headers = request.rawHeaders;
  for (let i = 0; i &lt; headers.length; i += 2) {
    response.write(`${headers[i]}: ${headers[i + 1]}\r\n`);
  }

  // End headers with an extra blank line
  response.write(&quot;\r\n&quot;);

  // Now we need to copy any request body to the response body
  // Since they are both streams, we can use a pipe
  request.pipe(response);
}
// Otherwise, serve a file from the local directory.
else {
  // Map the endpoint to a file in the local filesystem
  let filename = endpoint.substring(1); // strip leading /
  // Don&#39;t allow &quot;../&quot; in the path because it would be a security
  // hole to serve anything outside the root directory.
  filename = filename.replace(/\.\.\//g, &quot;&quot;);
  // Now convert from relative to absolute filename
  filename = path.resolve(rootDirectory, filename);

  // Now guess the type file&#39;s content type based on extension
  let type;
  switch (path.extname(filename)) {
    case &quot;.html&quot;:
    case &quot;.htm&quot;:
      type = &quot;text/html&quot;;
      break;
    case &quot;.js&quot;:
      type = &quot;text/javascript&quot;;
      break;
    case &quot;.css&quot;:
      type = &quot;text/css&quot;;
      break;
    case &quot;.png&quot;:
      type = &quot;image/png&quot;;
      break;
    case &quot;.txt&quot;:
      type = &quot;text/plain&quot;;
      break;
    default:
      type = &quot;application/octet-stream&quot;;
      break;
  }

  let stream = fs.createReadStream(filename);
  stream.once(&quot;readable&quot;, () =&gt; {
    // If the stream becomes readable, then set the
    // Content-Type header and a 200 OK status. Then pipe the
    // file reader stream to the response. The pipe will
    // automatically call response.end() when the stream ends.
    response.setHeader(&quot;Content-Type&quot;, type);
    response.writeHead(200);
    stream.pipe(response);
  });

  stream.on(&quot;error&quot;, (err) =&gt; {
    // Instead, if we get an error trying to open the stream
    // then the file probably does not exist or is not readable.
    // Send a 404 Not Found plain-text response with the
    // error message.
    response.setHeader(&quot;Content-Type&quot;, &quot;text/plain; charset=UTF-8&quot;);
    response.writeHead(404);
    response.end(err.message);
  });
}</code></pre>
<p>}); }</p>
<p>// When we’re invoked from the command line, call the serve() function serve(process.argv[2] || “/tmp”, parseInt(process.argv[3]) || 8000);</p>
<p>// This is how we could define a stats module const stats = (function () { // Utility functions private to the module const sum = (x, y) =&gt; x + y; const square = (x) =&gt; x * x;</p>
<p>// A public function that will be exported function mean(data) { return data.reduce(sum) / data.length; }</p>
<p>// A public function that we will export function stddev(data) { let m = mean(data); return Math.sqrt( data .map((x) =&gt; x - m) .map(square) .reduce(sum) / (data.length - 1) ); }</p>
<p>// We export the public function as properties of an object return { mean, stddev }; })();</p>
<p>// And here is how we might use the module stats.mean([1, 3, 5, 7, 9]); // =&gt; 5 stats.stddev([1, 3, 5, 7, 9]); // =&gt; Math.sqrt(10)</p>
<p>let data = [1, 1, 3, 5, 5]; // This is our array of numbers</p>
<p>// The mean is the sum of the elements divided by the number of elements let total = 0; for (let i = 0; i &lt; data.length; i++) total += data[i]; let mean = total / data.length; // mean == 3; The mean of our data is 3</p>
<p>// To compute the standard deviation, we first sum the squares of // the deviation of each element from the mean. total = 0; for (let i = 0; i &lt; data.length; i++) { let deviation = data[i] - mean; total += deviation * deviation; } let stddev = Math.sqrt(total / (data.length - 1)); // stddev == 2</p>
<p>// First, define two simple functions const sum = (x, y) =&gt; x + y; const square = (x) =&gt; x * x;</p>
<p>// Then use those functions with Array methods to compute mean and stddev let data = [1, 1, 3, 5, 5]; let mean = data.reduce(sum) / data.length; // mean == 3 let deviations = data.map((x) =&gt; x - mean); let stddev = Math.sqrt(deviations.map(square).reduce(sum) / (data.length - 1)); stddev; // =&gt; 2</p>
<p>const map = function (a, …args) { return a.map(…args); }; const reduce = function (a, …args) { return a.reduce(…args); }; const sum = (x, y) =&gt; x + y; const square = (x) =&gt; x * x;</p>
<p>let data = [1, 1, 3, 5, 5]; let mean = reduce(data, sum) / data.length; let deviations = map(data, (x) =&gt; x - mean); let stddev = Math.sqrt( reduce(map(deviations, square), sum) / (data.length - 1) ); stddev; // =&gt; 2</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> An asynchronous function for streaming the body of a Response object </em> obtained from a fetch() request. Pass the Response object as the first * argument followed by two optional callbacks. <em> </em> If you specify a function as the second argument, that reportProgress * callback will be called once for each chunk that is received. The first * argument passed is the total number of bytes received so far. The second * argument is a number between 0 and 1 specifying how complete the download * is. If the Response object has no “Content-Length” header, however, then * this second argument will always be NaN. <em> </em> If you want to process the data in chunks as they arrive, specify a * function as the third argument. The chunks will be passed, as Uint8Array * objects, to this processChunk callback. <em> </em> streamBody() returns a Promise that resolves to a string. If a processChunk * callback was supplied then this string is the concatenation of the values * returned by that callback. Otherwise the string is the concatenation of * the chunk values converted to UTF-8 strings. */</p>
<hr />
<p>```js async function streamBody(response, reportProgress, processChunk) { // How many bytes are we expecting, or NaN if no header let expectedBytes = parseInt(response.headers.get(“Content-Length”)); let bytesRead = 0; // How many bytes received so far let reader = response.body.getReader(); // Read bytes with this function let decoder = new TextDecoder(“utf-8”); // For converting bytes to text let body = ""; // Text read so far</p>
<p>while (true) { // Loop until we exit below let { done, value } = await reader.read(); // Read a chunk</p>
<pre><code>if (value) {
  // If we got a byte array:
  if (processChunk) {
    // Process the bytes if
    let processed = processChunk(value); // a callback was passed.
    if (processed) {
      body += processed;
    }
  } else {
    // Otherwise, convert bytes
    body += decoder.decode(value, { stream: true }); // to text.
  }

  if (reportProgress) {
    // If a progress callback was
    bytesRead += value.length; // passed, then call it
    reportProgress(bytesRead, bytesRead / expectedBytes);
  }
}
if (done) {
  // If this is the last chunk,
  break; // exit the loop
}</code></pre>
<p>}</p>
<p>return body; // Return the body text we accumulated }</p>
<p>// Yield the first n elements of the specified iterable object function* take(n, iterable) { let it = iterable<a href="">Symbol.iterator</a>; // Get iterator for iterable object while (n– &gt; 0) { // Loop n times: let next = it.next(); // Get the next item from the iterator. if (next.done) return; // If there are no more values, return early else yield next.value; // otherwise, yield the value } }</p>
<p>// An array of the first 5 Fibonacci numbers […take(5, fibonacciSequence())]; // =&gt; [1, 1, 2, 3, 5]</p>
<p>// Return the plain-text content of element e, recursing into child elements. // This method works like the textContent property function textContent(e) { let s = ""; // Accumulate the text here for (let child = e.firstChild; child !== null; child = child.nextSibling) { let type = child.nodeType; if (type === 3) { // If it is a Text node s += child.nodeValue; // add the text content to our string. } else if (type === 1) { // And if it is an Element node s += textContent(child); // then recurse. } } return s; }</p>
<p>// This function takes a function and returns a wrapped version function timed(f) { return function (…args) { // Collect args into a rest parameter array console.log(<code>Entering function ${f.name}</code>); let startTime = Date.now(); try { // Pass all of our arguments to the wrapped function return f(…args); // Spread the args back out again } finally { // Before we return the wrapped return value, print elapsed time. console.log(<code>Exiting ${f.name} after ${Date.now() - startTime}ms</code>); } }; }</p>
<p>// Compute the sum of the numbers between 1 and n by brute force function benchmark(n) { let sum = 0; for (let i = 1; i &lt;= n; i++) sum += i; return sum; }</p>
<p>// Now invoke the timed version of that test function timed(benchmark)(1000000); // =&gt; 500000500000; this is the sum of the numbers</p>
<p>// Replace the method named m of the object o with a version that logs // messages before and after invoking the original method. function trace(o, m) { let original = o[m]; // Remember original method in the closure. o[m] = function (…args) { // Now define the new method. console.log(new Date(), “Entering:”, m); // Log message. let result = original.apply(this, args); // Invoke original. console.log(new Date(), “Exiting:”, m); // Log message. return result; // Return result. }; }</p>
<p>// Shear transform: // x’ = x + kx<em>y; // y’ = ky</em>x + y; function shear(c, kx, ky) { c.transform(1, ky, kx, 1, 0, 0); }</p>
<p>// Rotate theta radians counterclockwise around the point (x,y) // This can also be accomplished with a translate, rotate, translate sequence function rotateAbout(c, theta, x, y) { let ct = Math.cos(theta); let st = Math.sin(theta); c.transform(ct, -st, st, ct, -x * ct - y * st + x, x * st - y * ct + y); }</p>
<p>// Recursively traverse the Document or Element e, invoking the function // f on e and on each of its descendants function traverse(e, f) { f(e); // Invoke f() on e for (let child of e.children) { // Iterate over the children traverse(child, f); // And recurse on each one } }</p>
<p>function traverse2(e, f) { f(e); // Invoke f() on e let child = e.firstElementChild; // Iterate the children linked-list style while (child !== null) { traverse2(child, f); // And recurse child = child.nextElementSibling; } }</p>
<p>// Initialize the counter property of the function object. // Function declarations are hoisted so we really can // do this assignment before the function declaration. uniqueInteger.counter = 0;</p>
<p>// This function returns a different integer each time it is called. // It uses a property of itself to remember the next value to be returned. function uniqueInteger() { return uniqueInteger.counter++; // Return and increment counter property } uniqueInteger(); // =&gt; 0 uniqueInteger(); // =&gt; 1</p>
<p>let uniqueInteger = (function () { // Define and invoke let counter = 0; // Private state of function below return function () { return counter++; }; })(); uniqueInteger(); // =&gt; 0 uniqueInteger(); // =&gt; 1</p>
<p>// The canvas.toBlob() function is callback-based. // This is a Promise-based wrapper for it. async function getCanvasBlob(canvas) { return new Promise((resolve, reject) =&gt; { canvas.toBlob(resolve); }); }</p>
<p>// Here is how we upload a PNG file from a canvas async function uploadCanvasImage(canvas) { let pngblob = await getCanvasBlob(canvas); let formdata = new FormData(); formdata.set(“canvasimage”, pngblob); let response = await fetch(“/upload”, { method: “POST”, body: formdata }); let body = await response.json(); }</p>
<p>function wait(duration) { // Create and return a new Promise return new Promise((resolve, reject) =&gt; { // These control the Promise // If the argument is invalid, reject the Promise if (duration &lt; 0) { reject(new Error(“Time travel not yet implemented”)); } // Otherwise, wait asynchronously and then resolve the Promise. // setTimeout will invoke resolve() with no arguments, which means // that the Promise will fulfill with the undefined value. setTimeout(resolve, duration); }); }</p>
<p>// Begin by creating an audioContext object. Safari still requires // us to use webkitAudioContext instead of AudioContext. let audioContext = new (this.AudioContext || this.webkitAudioContext)();</p>
<p>// Define the base sound as a combination of three pure sine waves let notes = [293.7, 370.0, 440.0]; // D major chord: D, F# and A</p>
<p>// Create oscillator nodes for each of the notes we want to play let oscillators = notes.map((note) =&gt; { let o = audioContext.createOscillator(); o.frequency.value = note; return o; });</p>
<p>// Shape the sound by controlling its volume over time. // Starting at time 0 quickly ramp up to full volume. // Then starting at time 0.1 slowly ramp down to 0. let volumeControl = audioContext.createGain(); volumeControl.gain.setTargetAtTime(1, 0.0, 0.02); volumeControl.gain.setTargetAtTime(0, 0.1, 0.2);</p>
<p>// We’re going to send the sound to the default destination: // the user’s speakers let speakers = audioContext.destination;</p>
<p>// Connect each of the source notes to the volume control oscillators.forEach((o) =&gt; o.connect(volumeControl));</p>
<p>// And connect the output of the volume control to the speakers. volumeControl.connect(speakers);</p>
<p>// Now start playing the sounds and let them run for 1.25 seconds. let startTime = audioContext.currentTime; let stopTime = startTime + 1.25; oscillators.forEach((o) =&gt; { o.start(startTime); o.stop(stopTime); });</p>
<p>// If we want to create a sequence of sounds we can use event handlers oscillators[0].addEventListener(“ended”, () =&gt; { // This event handler is invoked when the note stops playing });</p>
<p>function words(s) { var r = /+|$/g; // Match one or more spaces or end r.lastIndex = s.match(/[^ ]/).index; // Start matching at first nonspace return { // Return an iterable iterator object <a href="">Symbol.iterator</a> { // This makes us iterable return this; }, next() { // This makes us an iterator let start = r.lastIndex; // Resume where the last match ended if (start &lt; s.length) { // If we’re not done let match = r.exec(s); // Match the next word boundary if (match) { // If we found one, return the word return { value: s.substring(start, match.index) }; } } return { done: true }; // Otherwise, say that we’re done }, }; }</p>
<p>[…words(" abc def ghi! ")]; // =&gt; [“abc”, “def”, “ghi!”]</p>
<p>function write(stream, chunk, callback) { // Write the specified chunk to the specified stream let hasMoreRoom = stream.write(chunk);</p>
<p>// Check the return value of the write() method: if (hasMoreRoom) { // If it returned true, then setImmediate(callback); // invoke callback asynchronously. } else { // If it returned false, then stream.once(“drain”, callback); // invoke callback on drain event. } }</p>
<p>// Given an array of iterables, yield their elements in interleaved order. function* zip(…iterables) { // Get an iterator for each iterable let iterators = iterables.map((i) =&gt; i<a href="">Symbol.iterator</a>); let index = 0; while (iterators.length &gt; 0) { // While there are still some iterators if (index &gt;= iterators.length) { // If we reached the last iterator index = 0; // go back to the first one. } let item = iterators[index].next(); // Get next item from next iterator. if (item.done) { // If that iterator is done iterators.splice(index, 1); // then remove it from the array. } else { // Otherwise, yield item.value; // yield the iterated value index++; // and move on to the next iterator. } } }</p>
<p>// Interleave three iterable objects […zip(oneDigitPrimes(), “ab”, [0])]; // =&gt; [2,“a”,0,3,“b”,5,7]</p>
<p>// This utility function asynchronously obtains the database object (creating // and initializing the DB if necessary) and passes it to the callback. function withDB(callback) { let request = indexedDB.open(“zipcodes”, 1); // Request v1 of the database request.onerror = console.error; // Log any errors request.onsuccess = () =&gt; { // Or call this when done let db = request.result; // The result of the request is the database callback(db); // Invoke the callback with the database };</p>
<p>// If version 1 of the database does not yet exist, then this event // handler will be triggered. This is used to create and initialize // object stores and indexes when the DB is first created or to modify // them when we switch from one version of the DB schema to another. request.onupgradeneeded = () =&gt; { initdb(request.result, callback); }; }</p>
<p>// withDB() calls this function if the database has not been initialized yet. // We set up the database and populate it with data, then pass the database to // the callback function. // // Our zip code database includes one object store that holds objects like this: // // { // zipcode: “02134”, // city: “Allston”, // state: “MA”, // } // // We use the “zipcode” property as the database key and create an index for // the city name. function initdb(db, callback) { // Create the object store, specifying a name for the store and // an options object that includes the “key path” specifying the // property name of the key field for this store. let store = db.createObjectStore( “zipcodes”, // store name { keyPath: “zipcode” } );</p>
<p>// Now index the object store by city name as well as by zip code. // With this method the key path string is passed directly as a // required argument rather than as part of an options object. store.createIndex(“cities”, “city”);</p>
<p>// Now get the data we are going to initialize the database with. // The zipcodes.json data file was generated from CC-licensed data from // www.geonames.org: https://download.geonames.org/export/zip/US.zip fetch(“zipcodes.json”) // Make an HTTP GET request .then((response) =&gt; response.json()) // Parse the body as JSON .then((zipcodes) =&gt; { // Get 40K zip code records // In order to insert zip code data into the database we need a // transaction object. To create our transaction object, we need // to specify which object stores we’ll be using (we only have // one) and we need to tell it that we’ll be doing writes to the // database, not just reads: let transaction = db.transaction([“zipcodes”], “readwrite”); transaction.onerror = console.error;</p>
<pre><code>  // Get our object store from the transaction
  let store = transaction.objectStore(&quot;zipcodes&quot;);

  // The best part about the IndexedDB API is that object stores
  // are *really* simple. Here&#39;s how we add (or update) our records:
  for (let record of zipcodes) {
    store.put(record);
  }

  // When the transaction completes successfully, the database
  // is initialized and ready for use, so we can call the
  // callback function that was originally passed to withDB()
  transaction.oncomplete = () =&gt; {
    callback(db);
  };
});</code></pre>
<p>}</p>
<p>// Given a zip code, use the IndexedDB API to asynchronously look up the city // with that zip code, and pass it to the specified callback, or pass null if // no city is found. export function lookupCity(zip, callback) { withDB((db) =&gt; { // Create a read-only transaction object for this query. The // argument is an array of object stores we will need to use. let transaction = db.transaction([“zipcodes”]);</p>
<pre><code>// Get the object store from the transaction
let zipcodes = transaction.objectStore(&quot;zipcodes&quot;);

// Now request the object that matches the specified zipcode key.
// The lines above were synchronous, but this one is async.
let request = zipcodes.get(zip);
request.onerror = console.error; // Log errors
request.onsuccess = () =&gt; {
  // Or call this function on success
  let record = request.result; // This is the query result
  if (record) {
    // If we found a match, pass it to the callback
    callback(`${record.city}, ${record.state}`);
  } else {
    // Otherwise, tell the callback that we failed
    callback(null);
  }
};</code></pre>
<p>}); }</p>
<p>// Given the name of a city, use the IndexedDB API to asynchronously // look up all zip code records for all cities (in any state) that have // that (case-sensitive) name. export function lookupZipcodes(city, callback) { withDB((db) =&gt; { // As above, we create a transaction and get the object store let transaction = db.transaction([“zipcodes”]); let store = transaction.objectStore(“zipcodes”);</p>
<pre><code>// This time we also get the city index of the object store
let index = store.index(&quot;cities&quot;);

// Ask for all matching records in the index with the specified
// city name, and when we get them we pass them to the callback.
// If we expected more results, we might use openCursor() instead.
let request = index.getAll(city);
request.onerror = console.error;
request.onsuccess = () =&gt; {
  callback(request.result);
};</code></pre>
<p>}); }</p>
<p>import { lookupCity, lookupZipcodes } from “./zipcodeDatabase.js”;</p>
<p>window.addEventListener(“load”, () =&gt; { let zipcodeInput = document.querySelector(“#zipcodeInput”); let cityOutput = document.querySelector(“#cityOutput”); zipcodeInput.onchange = () =&gt; { lookupCity(zipcodeInput.value, (city) =&gt; { cityOutput.value = city || “Unknown zip code”; }); };</p>
<p>let cityInput = document.querySelector(“#cityInput”); let zipcodesOutput = document.querySelector(“#zipcodesOutput”); cityInput.onchange = () =&gt; { zipcodesOutput.textContent = “Matching zipcodes:”; lookupZipcodes(cityInput.value, (zipcodes) =&gt; { zipcodes.forEach((zip) =&gt; { let item = document.createElement(“li”); item.append(<code>${zip.zipcode}: ${zip.city}, ${zip.state}</code>); zipcodesOutput.append(item); }); }); }; });</p>
<p>const child_process = require(“child_process”); const util = require(“util”); const execP = util.promisify(child_process.exec);</p>
<p>function parallelExec(commands) { // Use the array of commands to create an array of Promises let promises = commands.map((command) =&gt; execP(command, { encoding: “utf8” }) ); // Return a Promise that will fulfill to an array of the fulfillment // values of each of the individual promises. (Instead of returning objects // with stdout and stderr properties we just return the stdout value.) return Promise.all(promises).then((outputs) =&gt; outputs.map((out) =&gt; out.stdout) ); }</p>
<p>module.exports = parallelExec; const threads = require(“worker_threads”);</p>
<p>if (threads.isMainThread) { // In the main thread, we create a shared typed array with // one element. Both threads will be able to read and write // sharedArray[0] at the same time. let sharedBuffer = new SharedArrayBuffer(4); let sharedArray = new Int32Array(sharedBuffer);</p>
<p>// Now create a worker thread, passing the shared array to it with // as its initial workerData value so we don’t have to bother with // sending and receiving a message let worker = new threads.Worker(__filename, { workerData: sharedArray });</p>
<p>// Wait for the worker to start running and then increment the // shared integer 10 million times. worker.on(“online”, () =&gt; { for (let i = 0; i &lt; 10_000_000; i++) sharedArray[0]++;</p>
<pre><code>// Once we&#39;re done with our increments, we start listening for
// message events so we know when the worker is done.
worker.on(&quot;message&quot;, () =&gt; {
  // Although the shared integer has been incremented
  // 20 million times, its value will generally be much less.
  // On my computer the final value is typically under 12 million.
  console.log(sharedArray[0]);
});</code></pre>
<p>}); } else { // In the worker thread, we get the shared array from workerData // and then increment it 10 million times. let sharedArray = threads.workerData; for (let i = 0; i &lt; 10_000_000; i++) sharedArray[0]++; // When we’re done incrementing, let the main thread know threads.parentPort.postMessage(“done”); } const child_process = require(“child_process”);</p>
<p>// Start a new node process running the code in child.js in our directory let child = child_process.fork(<code>${__dirname}/child.js</code>);</p>
<p>// Send a message to the child child.send({ x: 4, y: 3 });</p>
<p>// Print the child’s response when it arrives. child.on(“message”, (message) =&gt; { console.log(message.hypotenuse); // This should print “5” // Since we only send one message we only expect one response. // After we receive it we call disconnect() to terminate the connection // between parent and child. This allows both processes to exit cleanly. child.disconnect(); }); // The arguments to this function are passed on the left function partialLeft(f, …outerArgs) { return function (…innerArgs) { // Return this function let args = […outerArgs, …innerArgs]; // Build the argument list return f.apply(this, args); // Then invoke f with it }; }</p>
<p>// The arguments to this function are passed on the right function partialRight(f, …outerArgs) { return function (…innerArgs) { // Return this function let args = […innerArgs, …outerArgs]; // Build the argument list return f.apply(this, args); // Then invoke f with it }; }</p>
<p>// The arguments to this function serve as a template. Undefined values // in the argument list are filled in with values from the inner set. function partial(f, …outerArgs) { return function (…innerArgs) { let args = […outerArgs]; // local copy of outer args template let innerIndex = 0; // which inner arg is next // Loop through the args, filling in undefined values from inner args for (let i = 0; i &lt; args.length; i++) { if (args[i] === undefined) args[i] = innerArgs[innerIndex++]; } // Now append any remaining inner arguments args.push(…innerArgs.slice(innerIndex)); return f.apply(this, args); }; }</p>
<p>// Here is a function with three arguments const f = function (x, y, z) { return x * (y - z); }; // Notice how these three partial applications differ partialLeft(f, 2)(3, 4); // =&gt; -2: Bind first argument: 2 * (3 - 4) partialRight(f, 2)(3, 4); // =&gt; 6: Bind last argument: 3 * (4 - 2) partial(f, undefined, 2)(3, 4); // =&gt; -6: Bind middle argument: 3 * (2 - 4)</p>
<p>const increment = partialLeft(sum, 1); const cuberoot = partialRight(Math.pow, 1 / 3); cuberoot(increment(26)); // =&gt; 3</p>
<p>const not = partialLeft(compose, (x) =&gt; !x); const even = (x) =&gt; x % 2 === 0; const odd = not(even); const isNumber = not(isNaN); odd(3) &amp;&amp; isNumber(2); // =&gt; true</p>
<p>// sum() and square() functions are defined above. Here are some more: const product = (x, y) =&gt; x * y; const neg = partial(product, -1); const sqrt = partial(Math.pow, undefined, 0.5); const reciprocal = partial(Math.pow, undefined, neg(1));</p>
<p>// Now compute the mean and standard deviation. let data = [1, 1, 3, 5, 5]; // Our data let mean = product(reduce(data, sum), reciprocal(data.length)); let stddev = sqrt( product( reduce(map(data, compose(square, partial(sum, neg(mean)))), sum), reciprocal(sum(data.length, neg(1))) ) ); [mean, stddev]; // =&gt; [3, 2]</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> Create an <svg> element and draw a pie chart into it. </em> * This function expects an object argument with the following properties: <em> </em> width, height: the size of the SVG graphic, in pixels * cx, cy, r: the center and radius of the pie * lx, ly: the upper-left corner of the chart legend * data: an object whose property names are data labels and whose * property values are the values associated with each label <em> </em> The function returns an <svg> element. The caller must insert it into * the document in order to make it visible. */</p>
<hr />
<div class="sourceCode" id="cb49"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb49-1" title="1"><span class="kw">function</span> <span class="at">pieChart</span>(options) <span class="op">{</span></a>
<a class="sourceLine" id="cb49-2" title="2">  <span class="kw">let</span> <span class="op">{</span> width<span class="op">,</span> height<span class="op">,</span> cx<span class="op">,</span> cy<span class="op">,</span> r<span class="op">,</span> lx<span class="op">,</span> ly<span class="op">,</span> data <span class="op">}</span> <span class="op">=</span> options<span class="op">;</span></a>
<a class="sourceLine" id="cb49-3" title="3"></a>
<a class="sourceLine" id="cb49-4" title="4">  <span class="co">// This is the XML namespace for svg elements</span></a>
<a class="sourceLine" id="cb49-5" title="5">  <span class="kw">let</span> svg <span class="op">=</span> <span class="st">&quot;http://www.w3.org/2000/svg&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb49-6" title="6"></a>
<a class="sourceLine" id="cb49-7" title="7">  <span class="co">// Create the &lt;svg&gt; element, and specify pixel size and user coordinates</span></a>
<a class="sourceLine" id="cb49-8" title="8">  <span class="kw">let</span> chart <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;svg&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-9" title="9">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;width&quot;</span><span class="op">,</span> width)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-10" title="10">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;height&quot;</span><span class="op">,</span> height)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-11" title="11">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;viewBox&quot;</span><span class="op">,</span> <span class="vs">`0 0 </span><span class="sc">${</span>width<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>height<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-12" title="12"></a>
<a class="sourceLine" id="cb49-13" title="13">  <span class="co">// Define the text styles we&#39;ll use for the chart. If we leave these</span></a>
<a class="sourceLine" id="cb49-14" title="14">  <span class="co">// values unset here, they can be set with CSS instead.</span></a>
<a class="sourceLine" id="cb49-15" title="15">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;font-family&quot;</span><span class="op">,</span> <span class="st">&quot;sans-serif&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-16" title="16">  <span class="va">chart</span>.<span class="at">setAttribute</span>(<span class="st">&quot;font-size&quot;</span><span class="op">,</span> <span class="st">&quot;18&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-17" title="17"></a>
<a class="sourceLine" id="cb49-18" title="18">  <span class="co">// Get labels and values as arrays and add up the values so we know how</span></a>
<a class="sourceLine" id="cb49-19" title="19">  <span class="co">// big the pie is.</span></a>
<a class="sourceLine" id="cb49-20" title="20">  <span class="kw">let</span> labels <span class="op">=</span> <span class="va">Object</span>.<span class="at">keys</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-21" title="21">  <span class="kw">let</span> values <span class="op">=</span> <span class="va">Object</span>.<span class="at">values</span>(data)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-22" title="22">  <span class="kw">let</span> total <span class="op">=</span> <span class="va">values</span>.<span class="at">reduce</span>((x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-23" title="23"></a>
<a class="sourceLine" id="cb49-24" title="24">  <span class="co">// Figure out the angles for all the slices. Slice i starts at angles[i]</span></a>
<a class="sourceLine" id="cb49-25" title="25">  <span class="co">// and ends at angles[i+1]. The angles are measured in radians.</span></a>
<a class="sourceLine" id="cb49-26" title="26">  <span class="kw">let</span> angles <span class="op">=</span> [<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb49-27" title="27">  <span class="va">values</span>.<span class="at">forEach</span>((x<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="va">angles</span>.<span class="at">push</span>(angles[i] <span class="op">+</span> (x / total) <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">PI</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb49-28" title="28"></a>
<a class="sourceLine" id="cb49-29" title="29">  <span class="co">// Now loop through the slices of the pie</span></a>
<a class="sourceLine" id="cb49-30" title="30">  <span class="va">values</span>.<span class="at">forEach</span>((value<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb49-31" title="31">    <span class="co">// Compute the two points where our slice intersects the circle</span></a>
<a class="sourceLine" id="cb49-32" title="32">    <span class="co">// These formulas are chosen so that an angle of 0 is at 12 o&#39;clock</span></a>
<a class="sourceLine" id="cb49-33" title="33">    <span class="co">// and positive angles increase clockwise.</span></a>
<a class="sourceLine" id="cb49-34" title="34">    <span class="kw">let</span> x1 <span class="op">=</span> cx <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angles[i])<span class="op">;</span></a>
<a class="sourceLine" id="cb49-35" title="35">    <span class="kw">let</span> y1 <span class="op">=</span> cy <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angles[i])<span class="op">;</span></a>
<a class="sourceLine" id="cb49-36" title="36">    <span class="kw">let</span> x2 <span class="op">=</span> cx <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angles[i <span class="op">+</span> <span class="dv">1</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb49-37" title="37">    <span class="kw">let</span> y2 <span class="op">=</span> cy <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angles[i <span class="op">+</span> <span class="dv">1</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb49-38" title="38"></a>
<a class="sourceLine" id="cb49-39" title="39">    <span class="co">// This is a flag for angles larger than a half circle</span></a>
<a class="sourceLine" id="cb49-40" title="40">    <span class="co">// It is required by the SVG arc drawing component</span></a>
<a class="sourceLine" id="cb49-41" title="41">    <span class="kw">let</span> big <span class="op">=</span> angles[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">-</span> angles[i] <span class="op">&gt;</span> <span class="va">Math</span>.<span class="at">PI</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb49-42" title="42"></a>
<a class="sourceLine" id="cb49-43" title="43">    <span class="co">// This string describes how to draw a slice of the pie chart:</span></a>
<a class="sourceLine" id="cb49-44" title="44">    <span class="kw">let</span> path <span class="op">=</span></a>
<a class="sourceLine" id="cb49-45" title="45">      <span class="vs">`M</span><span class="sc">${</span>cx<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>cy<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span> <span class="co">// Move to circle center.</span></a>
<a class="sourceLine" id="cb49-46" title="46">      <span class="vs">`L</span><span class="sc">${</span>x1<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>y1<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span> <span class="co">// Draw line to (x1,y1).</span></a>
<a class="sourceLine" id="cb49-47" title="47">      <span class="vs">`A</span><span class="sc">${</span>r<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>r<span class="sc">}</span><span class="vs"> 0 </span><span class="sc">${</span>big<span class="sc">}</span><span class="vs"> 1`</span> <span class="op">+</span> <span class="co">// Draw an arc of radius r...</span></a>
<a class="sourceLine" id="cb49-48" title="48">      <span class="vs">`</span><span class="sc">${</span>x2<span class="sc">}</span><span class="vs">,</span><span class="sc">${</span>y2<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span> <span class="co">// ...ending at to (x2,y2).</span></a>
<a class="sourceLine" id="cb49-49" title="49">      <span class="st">&quot;Z&quot;</span><span class="op">;</span> <span class="co">// Close path back to (cx,cy).</span></a>
<a class="sourceLine" id="cb49-50" title="50"></a>
<a class="sourceLine" id="cb49-51" title="51">    <span class="co">// Compute the CSS color for this slice. This formula works for only</span></a>
<a class="sourceLine" id="cb49-52" title="52">    <span class="co">// about 15 colors. So don&#39;t include more than 15 slices in a chart.</span></a>
<a class="sourceLine" id="cb49-53" title="53">    <span class="kw">let</span> color <span class="op">=</span> <span class="vs">`hsl(</span><span class="sc">${</span>(i <span class="op">*</span> <span class="dv">40</span>) <span class="op">%</span> <span class="dv">360</span><span class="sc">}</span><span class="vs">,</span><span class="sc">${</span><span class="dv">90</span> <span class="op">-</span> <span class="dv">3</span> <span class="op">*</span> i<span class="sc">}</span><span class="vs">%,</span><span class="sc">${</span><span class="dv">50</span> <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> i<span class="sc">}</span><span class="vs">%)`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb49-54" title="54"></a>
<a class="sourceLine" id="cb49-55" title="55">    <span class="co">// We describe a slice with a &lt;path&gt; element. Note createElementNS().</span></a>
<a class="sourceLine" id="cb49-56" title="56">    <span class="kw">let</span> slice <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;path&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-57" title="57"></a>
<a class="sourceLine" id="cb49-58" title="58">    <span class="co">// Now set attributes on the &lt;path&gt; element</span></a>
<a class="sourceLine" id="cb49-59" title="59">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;d&quot;</span><span class="op">,</span> path)<span class="op">;</span> <span class="co">// Set the path for this slice</span></a>
<a class="sourceLine" id="cb49-60" title="60">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;fill&quot;</span><span class="op">,</span> color)<span class="op">;</span> <span class="co">// Set slice color</span></a>
<a class="sourceLine" id="cb49-61" title="61">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke&quot;</span><span class="op">,</span> <span class="st">&quot;black&quot;</span>)<span class="op">;</span> <span class="co">// Outline slice in black</span></a>
<a class="sourceLine" id="cb49-62" title="62">    <span class="va">slice</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke-width&quot;</span><span class="op">,</span> <span class="st">&quot;1&quot;</span>)<span class="op">;</span> <span class="co">// 1 CSS pixel thick</span></a>
<a class="sourceLine" id="cb49-63" title="63">    <span class="va">chart</span>.<span class="at">append</span>(slice)<span class="op">;</span> <span class="co">// Add slice to chart</span></a>
<a class="sourceLine" id="cb49-64" title="64"></a>
<a class="sourceLine" id="cb49-65" title="65">    <span class="co">// Now draw a little matching square for the key</span></a>
<a class="sourceLine" id="cb49-66" title="66">    <span class="kw">let</span> icon <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;rect&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-67" title="67">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;x&quot;</span><span class="op">,</span> lx)<span class="op">;</span> <span class="co">// Position the square</span></a>
<a class="sourceLine" id="cb49-68" title="68">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;y&quot;</span><span class="op">,</span> ly <span class="op">+</span> <span class="dv">30</span> <span class="op">*</span> i)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-69" title="69">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;width&quot;</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">;</span> <span class="co">// Size the square</span></a>
<a class="sourceLine" id="cb49-70" title="70">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;height&quot;</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-71" title="71">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;fill&quot;</span><span class="op">,</span> color)<span class="op">;</span> <span class="co">// Same fill color as slice</span></a>
<a class="sourceLine" id="cb49-72" title="72">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke&quot;</span><span class="op">,</span> <span class="st">&quot;black&quot;</span>)<span class="op">;</span> <span class="co">// Same outline, too.</span></a>
<a class="sourceLine" id="cb49-73" title="73">    <span class="va">icon</span>.<span class="at">setAttribute</span>(<span class="st">&quot;stroke-width&quot;</span><span class="op">,</span> <span class="st">&quot;1&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-74" title="74">    <span class="va">chart</span>.<span class="at">append</span>(icon)<span class="op">;</span> <span class="co">// Add to the chart</span></a>
<a class="sourceLine" id="cb49-75" title="75"></a>
<a class="sourceLine" id="cb49-76" title="76">    <span class="co">// And add a label to the right of the rectangle</span></a>
<a class="sourceLine" id="cb49-77" title="77">    <span class="kw">let</span> label <span class="op">=</span> <span class="va">document</span>.<span class="at">createElementNS</span>(svg<span class="op">,</span> <span class="st">&quot;text&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-78" title="78">    <span class="va">label</span>.<span class="at">setAttribute</span>(<span class="st">&quot;x&quot;</span><span class="op">,</span> lx <span class="op">+</span> <span class="dv">30</span>)<span class="op">;</span> <span class="co">// Position the text</span></a>
<a class="sourceLine" id="cb49-79" title="79">    <span class="va">label</span>.<span class="at">setAttribute</span>(<span class="st">&quot;y&quot;</span><span class="op">,</span> ly <span class="op">+</span> <span class="dv">30</span> <span class="op">*</span> i <span class="op">+</span> <span class="dv">16</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-80" title="80">    <span class="va">label</span>.<span class="at">append</span>(<span class="vs">`</span><span class="sc">${</span>labels[i]<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span> <span class="co">// Add text to label</span></a>
<a class="sourceLine" id="cb49-81" title="81">    <span class="va">chart</span>.<span class="at">append</span>(label)<span class="op">;</span> <span class="co">// Add label to the chart</span></a>
<a class="sourceLine" id="cb49-82" title="82">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-83" title="83"></a>
<a class="sourceLine" id="cb49-84" title="84">  <span class="cf">return</span> chart<span class="op">;</span></a>
<a class="sourceLine" id="cb49-85" title="85"><span class="op">}</span></a>
<a class="sourceLine" id="cb49-86" title="86"><span class="kw">function</span> <span class="at">pipe</span>(readable<span class="op">,</span> writable<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb49-87" title="87">  <span class="co">// First, set up error handling</span></a>
<a class="sourceLine" id="cb49-88" title="88">  <span class="kw">function</span> <span class="at">handleError</span>(err) <span class="op">{</span></a>
<a class="sourceLine" id="cb49-89" title="89">    <span class="va">readable</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb49-90" title="90">    <span class="va">writable</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb49-91" title="91">    <span class="at">callback</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-92" title="92">  <span class="op">}</span></a>
<a class="sourceLine" id="cb49-93" title="93"></a>
<a class="sourceLine" id="cb49-94" title="94">  <span class="co">// Next define the pipe and handle the normal termination case</span></a>
<a class="sourceLine" id="cb49-95" title="95">  readable</a>
<a class="sourceLine" id="cb49-96" title="96">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> handleError)</a>
<a class="sourceLine" id="cb49-97" title="97">    .<span class="at">pipe</span>(writable)</a>
<a class="sourceLine" id="cb49-98" title="98">    .<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> handleError)</a>
<a class="sourceLine" id="cb49-99" title="99">    .<span class="at">on</span>(<span class="st">&quot;finish&quot;</span><span class="op">,</span> callback)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-100" title="100"><span class="op">}</span></a>
<a class="sourceLine" id="cb49-101" title="101"><span class="co">// Define a regular polygon with n sides, centered at (x,y) with radius r.</span></a>
<a class="sourceLine" id="cb49-102" title="102"><span class="co">// The vertices are equally spaced along the circumference of a circle.</span></a>
<a class="sourceLine" id="cb49-103" title="103"><span class="co">// Put the first vertex straight up or at the specified angle.</span></a>
<a class="sourceLine" id="cb49-104" title="104"><span class="co">// Rotate clockwise, unless the last argument is true.</span></a>
<a class="sourceLine" id="cb49-105" title="105"><span class="kw">function</span> <span class="at">polygon</span>(c<span class="op">,</span> n<span class="op">,</span> x<span class="op">,</span> y<span class="op">,</span> r<span class="op">,</span> angle <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> counterclockwise <span class="op">=</span> <span class="kw">false</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb49-106" title="106">  <span class="va">c</span>.<span class="at">moveTo</span>(</a>
<a class="sourceLine" id="cb49-107" title="107">    x <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angle)<span class="op">,</span> <span class="co">// Begin a new subpath at the first vertex</span></a>
<a class="sourceLine" id="cb49-108" title="108">    y <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angle)</a>
<a class="sourceLine" id="cb49-109" title="109">  )<span class="op">;</span> <span class="co">// Use trigonometry to compute position</span></a>
<a class="sourceLine" id="cb49-110" title="110">  <span class="kw">let</span> delta <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">PI</span>) / n<span class="op">;</span> <span class="co">// Angular distance between vertices</span></a>
<a class="sourceLine" id="cb49-111" title="111">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb49-112" title="112">    <span class="co">// For each of the remaining vertices</span></a>
<a class="sourceLine" id="cb49-113" title="113">    angle <span class="op">+=</span> counterclockwise <span class="op">?</span> <span class="op">-</span>delta : delta<span class="op">;</span> <span class="co">// Adjust angle</span></a>
<a class="sourceLine" id="cb49-114" title="114">    <span class="va">c</span>.<span class="at">lineTo</span>(</a>
<a class="sourceLine" id="cb49-115" title="115">      x <span class="op">+</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(angle)<span class="op">,</span> <span class="co">// Add line to next vertex</span></a>
<a class="sourceLine" id="cb49-116" title="116">      y <span class="op">-</span> r <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(angle)</a>
<a class="sourceLine" id="cb49-117" title="117">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb49-118" title="118">  <span class="op">}</span></a>
<a class="sourceLine" id="cb49-119" title="119">  <span class="va">c</span>.<span class="at">closePath</span>()<span class="op">;</span> <span class="co">// Connect last vertex back to the first</span></a>
<a class="sourceLine" id="cb49-120" title="120"><span class="op">}</span></a>
<a class="sourceLine" id="cb49-121" title="121"></a>
<a class="sourceLine" id="cb49-122" title="122"><span class="co">// Assume there is just one canvas, and get its context object to draw with.</span></a>
<a class="sourceLine" id="cb49-123" title="123"><span class="kw">let</span> c <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;canvas&quot;</span>).<span class="at">getContext</span>(<span class="st">&quot;2d&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb49-124" title="124"></a>
<a class="sourceLine" id="cb49-125" title="125"><span class="co">// Start a new path and add polygon subpaths</span></a>
<a class="sourceLine" id="cb49-126" title="126"><span class="va">c</span>.<span class="at">beginPath</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb49-127" title="127"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">70</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span> <span class="co">// Triangle</span></a>
<a class="sourceLine" id="cb49-128" title="128"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">60</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">4</span>)<span class="op">;</span> <span class="co">// Square</span></a>
<a class="sourceLine" id="cb49-129" title="129"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">55</span><span class="op">,</span> <span class="dv">50</span>)<span class="op">;</span> <span class="co">// Pentagon</span></a>
<a class="sourceLine" id="cb49-130" title="130"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">365</span><span class="op">,</span> <span class="dv">53</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">6</span>)<span class="op">;</span> <span class="co">// Hexagon</span></a>
<a class="sourceLine" id="cb49-131" title="131"><span class="at">polygon</span>(c<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">365</span><span class="op">,</span> <span class="dv">53</span><span class="op">,</span> <span class="dv">20</span><span class="op">,</span> <span class="va">Math</span>.<span class="at">PI</span> / <span class="dv">4</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="co">// Small square inside the hexagon</span></a>
<a class="sourceLine" id="cb49-132" title="132"></a>
<a class="sourceLine" id="cb49-133" title="133"><span class="co">// Set some properties that control how the graphics will look</span></a>
<a class="sourceLine" id="cb49-134" title="134"><span class="va">c</span>.<span class="at">fillStyle</span> <span class="op">=</span> <span class="st">&quot;#ccc&quot;</span><span class="op">;</span> <span class="co">// Light gray interiors</span></a>
<a class="sourceLine" id="cb49-135" title="135"><span class="va">c</span>.<span class="at">strokeStyle</span> <span class="op">=</span> <span class="st">&quot;#008&quot;</span><span class="op">;</span> <span class="co">// outlined with dark blue lines</span></a>
<a class="sourceLine" id="cb49-136" title="136"><span class="va">c</span>.<span class="at">lineWidth</span> <span class="op">=</span> <span class="dv">5</span><span class="op">;</span> <span class="co">// five pixels wide.</span></a>
<a class="sourceLine" id="cb49-137" title="137"></a>
<a class="sourceLine" id="cb49-138" title="138"><span class="co">// Now draw all the polygons (each in its own subpath) with these calls</span></a>
<a class="sourceLine" id="cb49-139" title="139"><span class="va">c</span>.<span class="at">fill</span>()<span class="op">;</span> <span class="co">// Fill the shapes</span></a>
<a class="sourceLine" id="cb49-140" title="140"><span class="va">c</span>.<span class="at">stroke</span>()<span class="op">;</span> <span class="co">// And stroke their outlines</span></a>
<a class="sourceLine" id="cb49-141" title="141"><span class="kw">const</span> https <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;https&quot;</span>)<span class="op">;</span></a></code></pre></div>
<hr />
<p>/<em> </em> Convert the body object to a JSON string then HTTPS POST it to the * specified API endpoint on the specified host. When the response arrives, * parse the response body as JSON and resolve the returned Promise with * that parsed value. */</p>
<hr />
<div class="sourceCode" id="cb50"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb50-1" title="1"><span class="kw">function</span> <span class="at">postJSON</span>(host<span class="op">,</span> endpoint<span class="op">,</span> body<span class="op">,</span> port<span class="op">,</span> username<span class="op">,</span> password) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-2" title="2">  <span class="co">// Return a Promise object immediately, then call resolve or reject</span></a>
<a class="sourceLine" id="cb50-3" title="3">  <span class="co">// when the HTTPS request succeeds or fails.</span></a>
<a class="sourceLine" id="cb50-4" title="4">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-5" title="5">    <span class="co">// Convert the body object to a string</span></a>
<a class="sourceLine" id="cb50-6" title="6">    <span class="kw">let</span> bodyText <span class="op">=</span> <span class="va">JSON</span>.<span class="at">stringify</span>(body)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-7" title="7"></a>
<a class="sourceLine" id="cb50-8" title="8">    <span class="co">// Configure the HTTPS request</span></a>
<a class="sourceLine" id="cb50-9" title="9">    <span class="kw">let</span> requestOptions <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-10" title="10">      <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="co">// Or &quot;GET&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, etc.</span></a>
<a class="sourceLine" id="cb50-11" title="11">      <span class="dt">host</span><span class="op">:</span> host<span class="op">,</span> <span class="co">// The host to connect to</span></a>
<a class="sourceLine" id="cb50-12" title="12">      <span class="dt">path</span><span class="op">:</span> endpoint<span class="op">,</span> <span class="co">// The URL path</span></a>
<a class="sourceLine" id="cb50-13" title="13">      <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-14" title="14">        <span class="co">// HTTP headers for the request</span></a>
<a class="sourceLine" id="cb50-15" title="15">        <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb50-16" title="16">        <span class="st">&quot;Content-Length&quot;</span><span class="op">:</span> <span class="va">Buffer</span>.<span class="at">byteLength</span>(bodyText)<span class="op">,</span></a>
<a class="sourceLine" id="cb50-17" title="17">      <span class="op">},</span></a>
<a class="sourceLine" id="cb50-18" title="18">    <span class="op">};</span></a>
<a class="sourceLine" id="cb50-19" title="19"></a>
<a class="sourceLine" id="cb50-20" title="20">    <span class="cf">if</span> (port) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-21" title="21">      <span class="co">// If a port is specified,</span></a>
<a class="sourceLine" id="cb50-22" title="22">      <span class="va">requestOptions</span>.<span class="at">port</span> <span class="op">=</span> port<span class="op">;</span> <span class="co">// use it for the request.</span></a>
<a class="sourceLine" id="cb50-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb50-24" title="24">    <span class="co">// If credentials are specified, add an Authorization header.</span></a>
<a class="sourceLine" id="cb50-25" title="25">    <span class="cf">if</span> (username <span class="op">&amp;&amp;</span> password) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-26" title="26">      <span class="va">requestOptions</span>.<span class="at">auth</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>username<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>password<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb50-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb50-28" title="28"></a>
<a class="sourceLine" id="cb50-29" title="29">    <span class="co">// Now create the request based on the configuration object</span></a>
<a class="sourceLine" id="cb50-30" title="30">    <span class="kw">let</span> request <span class="op">=</span> <span class="va">https</span>.<span class="at">request</span>(requestOptions)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-31" title="31"></a>
<a class="sourceLine" id="cb50-32" title="32">    <span class="co">// Write the body of the POST request and end the request.</span></a>
<a class="sourceLine" id="cb50-33" title="33">    <span class="va">request</span>.<span class="at">write</span>(bodyText)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-34" title="34">    <span class="va">request</span>.<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb50-35" title="35"></a>
<a class="sourceLine" id="cb50-36" title="36">    <span class="co">// Fail on request errors (such as no network connection)</span></a>
<a class="sourceLine" id="cb50-37" title="37">    <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="at">reject</span>(e))<span class="op">;</span></a>
<a class="sourceLine" id="cb50-38" title="38"></a>
<a class="sourceLine" id="cb50-39" title="39">    <span class="co">// Handle the response when it starts to arrive.</span></a>
<a class="sourceLine" id="cb50-40" title="40">    <span class="va">request</span>.<span class="at">on</span>(<span class="st">&quot;response&quot;</span><span class="op">,</span> (response) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-41" title="41">      <span class="cf">if</span> (<span class="va">response</span>.<span class="at">statusCode</span> <span class="op">!==</span> <span class="dv">200</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-42" title="42">        <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="vs">`HTTP status </span><span class="sc">${</span><span class="va">response</span>.<span class="at">statusCode</span><span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb50-43" title="43">        <span class="co">// We don&#39;t care about the response body in this case, but</span></a>
<a class="sourceLine" id="cb50-44" title="44">        <span class="co">// we don&#39;t want it to stick around in a buffer somewhere, so</span></a>
<a class="sourceLine" id="cb50-45" title="45">        <span class="co">// we put the stream into flowing mode without registering</span></a>
<a class="sourceLine" id="cb50-46" title="46">        <span class="co">// a &quot;data&quot; handler so that the body is discarded.</span></a>
<a class="sourceLine" id="cb50-47" title="47">        <span class="va">response</span>.<span class="at">resume</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb50-48" title="48">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb50-49" title="49">      <span class="op">}</span></a>
<a class="sourceLine" id="cb50-50" title="50"></a>
<a class="sourceLine" id="cb50-51" title="51">      <span class="co">// We want text, not bytes. We&#39;re assuming the text will be</span></a>
<a class="sourceLine" id="cb50-52" title="52">      <span class="co">// JSON-formatted but aren&#39;t bothering to check the</span></a>
<a class="sourceLine" id="cb50-53" title="53">      <span class="co">// Content-Type header.</span></a>
<a class="sourceLine" id="cb50-54" title="54">      <span class="va">response</span>.<span class="at">setEncoding</span>(<span class="st">&quot;utf8&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-55" title="55"></a>
<a class="sourceLine" id="cb50-56" title="56">      <span class="co">// Node doesn&#39;t have a streaming JSON parser, so we read the</span></a>
<a class="sourceLine" id="cb50-57" title="57">      <span class="co">// entire response body into a string.</span></a>
<a class="sourceLine" id="cb50-58" title="58">      <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb50-59" title="59">      <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;data&quot;</span><span class="op">,</span> (chunk) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-60" title="60">        body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb50-61" title="61">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-62" title="62"></a>
<a class="sourceLine" id="cb50-63" title="63">      <span class="co">// And now handle the response when it is complete.</span></a>
<a class="sourceLine" id="cb50-64" title="64">      <span class="va">response</span>.<span class="at">on</span>(<span class="st">&quot;end&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-65" title="65">        <span class="co">// When the response is done,</span></a>
<a class="sourceLine" id="cb50-66" title="66">        <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-67" title="67">          <span class="co">// try to parse it as JSON</span></a>
<a class="sourceLine" id="cb50-68" title="68">          <span class="at">resolve</span>(<span class="va">JSON</span>.<span class="at">parse</span>(body))<span class="op">;</span> <span class="co">// and resolve the result.</span></a>
<a class="sourceLine" id="cb50-69" title="69">        <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-70" title="70">          <span class="co">// Or, if anything goes wrong,</span></a>
<a class="sourceLine" id="cb50-71" title="71">          <span class="at">reject</span>(e)<span class="op">;</span> <span class="co">// reject with the error</span></a>
<a class="sourceLine" id="cb50-72" title="72">        <span class="op">}</span></a>
<a class="sourceLine" id="cb50-73" title="73">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-74" title="74">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-75" title="75">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-76" title="76"><span class="op">}</span></a>
<a class="sourceLine" id="cb50-77" title="77"><span class="co">// This function adds property accessor methods for a property with</span></a>
<a class="sourceLine" id="cb50-78" title="78"><span class="co">// the specified name to the object o. The methods are named get&lt;name&gt;</span></a>
<a class="sourceLine" id="cb50-79" title="79"><span class="co">// and set&lt;name&gt;. If a predicate function is supplied, the setter</span></a>
<a class="sourceLine" id="cb50-80" title="80"><span class="co">// method uses it to test its argument for validity before storing it.</span></a>
<a class="sourceLine" id="cb50-81" title="81"><span class="co">// If the predicate returns false, the setter method throws an exception.</span></a>
<a class="sourceLine" id="cb50-82" title="82"><span class="co">//</span></a>
<a class="sourceLine" id="cb50-83" title="83"><span class="co">// The unusual thing about this function is that the property value</span></a>
<a class="sourceLine" id="cb50-84" title="84"><span class="co">// that is manipulated by the getter and setter methods is not stored in</span></a>
<a class="sourceLine" id="cb50-85" title="85"><span class="co">// the object o. Instead, the value is stored only in a local variable</span></a>
<a class="sourceLine" id="cb50-86" title="86"><span class="co">// in this function. The getter and setter methods are also defined</span></a>
<a class="sourceLine" id="cb50-87" title="87"><span class="co">// locally to this function and therefore have access to this local variable.</span></a>
<a class="sourceLine" id="cb50-88" title="88"><span class="co">// This means that the value is private to the two accessor methods, and it</span></a>
<a class="sourceLine" id="cb50-89" title="89"><span class="co">// cannot be set or modified except through the setter method.</span></a>
<a class="sourceLine" id="cb50-90" title="90"><span class="kw">function</span> <span class="at">addPrivateProperty</span>(o<span class="op">,</span> name<span class="op">,</span> predicate) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-91" title="91">  <span class="kw">let</span> value<span class="op">;</span> <span class="co">// This is the property value</span></a>
<a class="sourceLine" id="cb50-92" title="92"></a>
<a class="sourceLine" id="cb50-93" title="93">  <span class="co">// The getter method simply returns the value.</span></a>
<a class="sourceLine" id="cb50-94" title="94">  o[<span class="vs">`get</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>] <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-95" title="95">    <span class="cf">return</span> value<span class="op">;</span></a>
<a class="sourceLine" id="cb50-96" title="96">  <span class="op">};</span></a>
<a class="sourceLine" id="cb50-97" title="97"></a>
<a class="sourceLine" id="cb50-98" title="98">  <span class="co">// The setter method stores the value or throws an exception if</span></a>
<a class="sourceLine" id="cb50-99" title="99">  <span class="co">// the predicate rejects the value.</span></a>
<a class="sourceLine" id="cb50-100" title="100">  o[<span class="vs">`set</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>] <span class="op">=</span> (v) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-101" title="101">    <span class="cf">if</span> (predicate <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="at">predicate</span>(v)) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-102" title="102">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">TypeError</span>(<span class="vs">`set</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">: invalid value </span><span class="sc">${</span>v<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-103" title="103">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-104" title="104">      value <span class="op">=</span> v<span class="op">;</span></a>
<a class="sourceLine" id="cb50-105" title="105">    <span class="op">}</span></a>
<a class="sourceLine" id="cb50-106" title="106">  <span class="op">};</span></a>
<a class="sourceLine" id="cb50-107" title="107"><span class="op">}</span></a>
<a class="sourceLine" id="cb50-108" title="108"></a>
<a class="sourceLine" id="cb50-109" title="109"><span class="co">// The following code demonstrates the addPrivateProperty() method.</span></a>
<a class="sourceLine" id="cb50-110" title="110"><span class="kw">let</span> o <span class="op">=</span> <span class="op">{};</span> <span class="co">// Here is an empty object</span></a>
<a class="sourceLine" id="cb50-111" title="111"></a>
<a class="sourceLine" id="cb50-112" title="112"><span class="co">// Add property accessor methods getName and setName()</span></a>
<a class="sourceLine" id="cb50-113" title="113"><span class="co">// Ensure that only string values are allowed</span></a>
<a class="sourceLine" id="cb50-114" title="114"><span class="at">addPrivateProperty</span>(o<span class="op">,</span> <span class="st">&quot;Name&quot;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> <span class="kw">typeof</span> x <span class="op">===</span> <span class="st">&quot;string&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-115" title="115"></a>
<a class="sourceLine" id="cb50-116" title="116"><span class="va">o</span>.<span class="at">setName</span>(<span class="st">&quot;Frank&quot;</span>)<span class="op">;</span> <span class="co">// Set the property value</span></a>
<a class="sourceLine" id="cb50-117" title="117"><span class="va">o</span>.<span class="at">getName</span>()<span class="op">;</span> <span class="co">// =&gt; &quot;Frank&quot;</span></a>
<a class="sourceLine" id="cb50-118" title="118"><span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;o.getName(): &quot;</span><span class="op">,</span> <span class="va">o</span>.<span class="at">getName</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb50-119" title="119"><span class="co">// o.setName(0); // !TypeError: try to set a value of the wrong type</span></a>
<a class="sourceLine" id="cb50-120" title="120"></a>
<a class="sourceLine" id="cb50-121" title="121"><span class="co">/*</span></a>
<a class="sourceLine" id="cb50-122" title="122"></a>
<a class="sourceLine" id="cb50-123" title="123"><span class="co">node addPrivateProperty.js</span></a>
<a class="sourceLine" id="cb50-124" title="124"><span class="co">o.getName(): Frank |</span></a>
<a class="sourceLine" id="cb50-125" title="125"><span class="co">  09: 01: 36 | bryan @LAPTOP - 9 LGJ3JGS: [ js - files ] js - files_exitstatus: 0[ ╗__________________________________________________________o &gt;</span></a>
<a class="sourceLine" id="cb50-126" title="126"></a>
<a class="sourceLine" id="cb50-127" title="127"></a>
<a class="sourceLine" id="cb50-128" title="128"><span class="co">*/</span></a>
<a class="sourceLine" id="cb50-129" title="129"><span class="co">// This function takes an array of input values and a &quot;promiseMaker&quot; function.</span></a>
<a class="sourceLine" id="cb50-130" title="130"><span class="co">// For any input value x in the array, promiseMaker(x) should return a Promise</span></a>
<a class="sourceLine" id="cb50-131" title="131"><span class="co">// that will fulfill to an output value. This function returns a Promise</span></a>
<a class="sourceLine" id="cb50-132" title="132"><span class="co">// that fulfills to an array of the computed output values.</span></a>
<a class="sourceLine" id="cb50-133" title="133"><span class="co">//</span></a>
<a class="sourceLine" id="cb50-134" title="134"><span class="co">// Rather than creating the Promises all at once and letting them run in</span></a>
<a class="sourceLine" id="cb50-135" title="135"><span class="co">// parallel, however, promiseSequence() only runs one Promise at a time</span></a>
<a class="sourceLine" id="cb50-136" title="136"><span class="co">// and does not call promiseMaker() for a value until the previous Promise</span></a>
<a class="sourceLine" id="cb50-137" title="137"><span class="co">// has fulfilled.</span></a>
<a class="sourceLine" id="cb50-138" title="138"><span class="kw">function</span> <span class="at">promiseSequence</span>(inputs<span class="op">,</span> promiseMaker) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-139" title="139">  <span class="co">// Make a private copy of the array that we can modify</span></a>
<a class="sourceLine" id="cb50-140" title="140">  inputs <span class="op">=</span> [...<span class="at">inputs</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb50-141" title="141"></a>
<a class="sourceLine" id="cb50-142" title="142">  <span class="co">// Here&#39;s the function that we&#39;ll use as a Promise callback</span></a>
<a class="sourceLine" id="cb50-143" title="143">  <span class="co">// This is the pseudorecursive magic that makes this all work.</span></a>
<a class="sourceLine" id="cb50-144" title="144">  <span class="kw">function</span> <span class="at">handleNextInput</span>(outputs) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-145" title="145">    <span class="cf">if</span> (<span class="va">inputs</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-146" title="146">      <span class="co">// If there are no more inputs left, then return the array</span></a>
<a class="sourceLine" id="cb50-147" title="147">      <span class="co">// of outputs, finally fulfilling this Promise and all the</span></a>
<a class="sourceLine" id="cb50-148" title="148">      <span class="co">// previous resolved-but-not-fulfilled Promises.</span></a>
<a class="sourceLine" id="cb50-149" title="149">      <span class="cf">return</span> outputs<span class="op">;</span></a>
<a class="sourceLine" id="cb50-150" title="150">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-151" title="151">      <span class="co">// If there are still input values to process, then we&#39;ll</span></a>
<a class="sourceLine" id="cb50-152" title="152">      <span class="co">// return a Promise object, resolving the current Promise</span></a>
<a class="sourceLine" id="cb50-153" title="153">      <span class="co">// with the future value from a new Promise.</span></a>
<a class="sourceLine" id="cb50-154" title="154">      <span class="kw">let</span> nextInput <span class="op">=</span> <span class="va">inputs</span>.<span class="at">shift</span>()<span class="op">;</span> <span class="co">// Get the next input value,</span></a>
<a class="sourceLine" id="cb50-155" title="155">      <span class="cf">return</span> (</a>
<a class="sourceLine" id="cb50-156" title="156">        <span class="at">promiseMaker</span>(nextInput) <span class="co">// compute the next output value,</span></a>
<a class="sourceLine" id="cb50-157" title="157">          <span class="co">// Then create a new outputs array with the new output value</span></a>
<a class="sourceLine" id="cb50-158" title="158">          .<span class="at">then</span>((output) <span class="kw">=&gt;</span> <span class="va">outputs</span>.<span class="at">concat</span>(output))</a>
<a class="sourceLine" id="cb50-159" title="159">          <span class="co">// Then &quot;recurse&quot;, passing the new, longer, outputs array</span></a>
<a class="sourceLine" id="cb50-160" title="160">          .<span class="at">then</span>(handleNextInput)</a>
<a class="sourceLine" id="cb50-161" title="161">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb50-162" title="162">    <span class="op">}</span></a>
<a class="sourceLine" id="cb50-163" title="163">  <span class="op">}</span></a>
<a class="sourceLine" id="cb50-164" title="164"></a>
<a class="sourceLine" id="cb50-165" title="165">  <span class="co">// Start with a Promise that fulfills to an empty array and use</span></a>
<a class="sourceLine" id="cb50-166" title="166">  <span class="co">// the function above as its callback.</span></a>
<a class="sourceLine" id="cb50-167" title="167">  <span class="cf">return</span> <span class="va">Promise</span>.<span class="at">resolve</span>([]).<span class="at">then</span>(handleNextInput)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-168" title="168"><span class="op">}</span></a>
<a class="sourceLine" id="cb50-169" title="169"></a>
<a class="sourceLine" id="cb50-170" title="170"><span class="co">// Given a URL, return a Promise that fulfills to the URL body text</span></a>
<a class="sourceLine" id="cb50-171" title="171"><span class="kw">function</span> <span class="at">fetchBody</span>(url) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-172" title="172">  <span class="cf">return</span> <span class="at">fetch</span>(url).<span class="at">then</span>((r) <span class="kw">=&gt;</span> <span class="va">r</span>.<span class="at">text</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb50-173" title="173"><span class="op">}</span></a>
<a class="sourceLine" id="cb50-174" title="174"><span class="co">// Use it to sequentially fetch a bunch of URL bodies</span></a>
<a class="sourceLine" id="cb50-175" title="175"><span class="at">promiseSequence</span>(urls<span class="op">,</span> fetchBody)</a>
<a class="sourceLine" id="cb50-176" title="176">  .<span class="at">then</span>((bodies) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-177" title="177">    <span class="co">/* do something with the array of strings */</span></a></code></pre></div>
<hr />
<p>```js }) .catch(console.error); // This object has accessor properties that return random numbers. // The expression “random.octet”, for example, yields a random number // between 0 and 255 each time it is evaluated. const random = { get octet() { return Math.floor(Math.random() * 256); }, get uint16() { return Math.floor(Math.random() * 65536); }, get int16() { return Math.floor(Math.random() * 65536) - 32768; }, }; // This is a factory function that returns a new range object. function range(from, to) { // Use Object.create() to create an object that inherits from the // prototype object defined below. The prototype object is stored as // a property of this function, and defines the shared methods (behavior) // for all range objects. let r = Object.create(range.methods);</p>
<p>// Store the start and end points (state) of this new range object. // These are noninherited properties that are unique to this object. r.from = from; r.to = to;</p>
<p>// Finally return the new object return r; }</p>
<p>// This prototype object defines methods inherited by all range objects. range.methods = { // Return true if x is in the range, false otherwise // This method works for textual and Date ranges as well as numeric. includes(x) { return this.from &lt;= x &amp;&amp; x &lt;= this.to; },</p>
<p>// A generator function that makes instances of the class iterable. // Note that it only works for numeric ranges. *<a href="">Symbol.iterator</a> { for (let x = Math.ceil(this.from); x &lt;= this.to; x++) yield x; },</p>
<p>// Return a string representation of the range toString() { return “(” + this.from + “…” + this.to + “)”; }, }; // This is a constructor function that initializes new Range objects. // Note that it does not create or return the object. It just initializes this. function Range(from, to) { // Store the start and end points (state) of this new range object. // These are noninherited properties that are unique to this object. this.from = from; this.to = to; }</p>
<p>// All Range objects inherit from this object. // Note that the property name must be “prototype” for this to work. Range.prototype = { // Return true if x is in the range, false otherwise // This method works for textual and Date ranges as well as numeric. includes: function (x) { return this.from &lt;= x &amp;&amp; x &lt;= this.to; },</p>
<p>// A generator function that makes instances of the class iterable. // Note that it only works for numeric ranges. [Symbol.iterator]: function* () { for (let x = Math.ceil(this.from); x &lt;= this.to; x++) yield x; },</p>
<p>// Return a string representation of the range toString: function () { return “(” + this.from + “…” + this.to + “)”; }, }; class Range { constructor(from, to) { // Store the start and end points (state) of this new range object. // These are noninherited properties that are unique to this object. this.from = from; this.to = to; }</p>
<p>// Return true if x is in the range, false otherwise // This method works for textual and Date ranges as well as numeric. includes(x) { return this.from &lt;= x &amp;&amp; x &lt;= this.to; }</p>
<p>// A generator function that makes instances of the class iterable. // Note that it only works for numeric ranges. *<a href="">Symbol.iterator</a> { for (let x = Math.ceil(this.from); x &lt;= this.to; x++) yield x; }</p>
<p>// Return a string representation of the range toString() { return <code>(${this.from}...${this.to})</code>; } } const fs = require(“fs”); // Require the filesystem module</p>
<p>// Read a config file, parse its contents as JSON, and pass the // resulting value to the callback. If anything goes wrong, // print an error message to stderr and invoke the callback with null function readConfigFile(path, callback) { fs.readFile(path, “utf8”, (err, text) =&gt; { if (err) { // Something went wrong reading the file console.error(err); callback(null); return; } let data = null; try { data = JSON.parse(text); } catch (e) { // Something went wrong parsing the file contents console.error(e); } callback(data); }); } const util = require(“util”); const fs = require(“fs”); // Require the filesystem module const pfs = { // Promise-based variants of some fs functions readFile: util.promisify(fs.readFile), };</p>
<p>function readConfigFile(path) { return pfs.readFile(path, “utf-8”).then((text) =&gt; { return JSON.parse(text); }); } const fs = require(“fs”); const util = require(“util”); const pfs = { readFile: util.promisify(fs.readFile) };</p>
<p>async function readConfigFile(path) { let text = await pfs.readFile(path, “utf-8”); return JSON.parse(text); } const fs = require(“fs”); function readConfigFileSync(path) { let text = fs.readFileSync(path, “utf-8”); return JSON.parse(text); } function readOnlyProxy(o) { function readonly() { throw new TypeError(“Readonly”); } return new Proxy(o, { set: readonly, defineProperty: readonly, deleteProperty: readonly, setPrototypeOf: readonly, }); }</p>
<p>let o = { x: 1, y: 2 }; // Normal writable object let p = readOnlyProxy(o); // Readonly version of it p.x; // =&gt; 1: reading properties works p.x = 2; // !TypeError: can’t change properties delete p.y; // !TypeError: can’t delete properties p.z = 3; // !TypeError: can’t add properties p.__proto__ = {}; // !TypeError: can’t change the prototype</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<p>```js</p>
<hr />
<p>/<em> This class defines a custom HTML <search-box> element that displays an </em> <input> text input field plus two icons or emoji. By default, it displays a * magnifying glass emoji (indicating search) to the left of the text field * and an X emoji (indicating cancel) to the right of the text field. It * hides the border on the input field and displays a border around itself, * creating the appearance that the two emoji are inside the input * field. Similarly, when the internal input field is focused, the focus ring * is displayed around the <search-box>. <em> </em> You can override the default icons by including <span> or <img> children * of <search-box> with slot=“left” and slot=“right” attributes. <em> </em> <search-box> supports the normal HTML disabled and hidden attributes and * also size and placeholder attributes, which have the same meaning for this * element as they do for the <input> element. <em> </em> Input events from the internal <input> element bubble up and appear with * their target field set to the <search-box> element. <em> </em> The element fires a “search” event with the detail property set to the * current input string when the user clicks on the left emoji (the magnifying * glass). The “search” event is also dispatched when the internal text field * generates a “change” event (when the text has changed and the user types * Return or Tab). <em> </em> The element fires a “clear” event when the user clicks on the right emoji * (the X). If no handler calls preventDefault() on the event then the element * clears the user’s input once event dispatch is complete. <em> </em> Note that there are no onsearch and onclear properties or attributes: * handlers for the “search” and “clear” events can only be registered with * addEventListener(). */</p>
<hr />
<div class="sourceCode" id="cb51"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb51-1" title="1"><span class="kw">class</span> SearchBox <span class="kw">extends</span> HTMLElement <span class="op">{</span></a>
<a class="sourceLine" id="cb51-2" title="2">  <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb51-3" title="3">    <span class="kw">super</span>()<span class="op">;</span> <span class="co">// Invoke the superclass constructor; must be first.</span></a>
<a class="sourceLine" id="cb51-4" title="4"></a>
<a class="sourceLine" id="cb51-5" title="5">    <span class="co">// Create a shadow DOM tree and attach it to this element, setting</span></a>
<a class="sourceLine" id="cb51-6" title="6">    <span class="co">// the value of this.shadowRoot.</span></a>
<a class="sourceLine" id="cb51-7" title="7">    <span class="kw">this</span>.<span class="at">attachShadow</span>(<span class="op">{</span> <span class="dt">mode</span><span class="op">:</span> <span class="st">&quot;open&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-8" title="8"></a>
<a class="sourceLine" id="cb51-9" title="9">    <span class="co">// Clone the template that defines the descendants and stylesheet for</span></a>
<a class="sourceLine" id="cb51-10" title="10">    <span class="co">// this custom component, and append that content to the shadow root.</span></a>
<a class="sourceLine" id="cb51-11" title="11">    <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">append</span>(<span class="va">SearchBox</span>.<span class="va">template</span>.<span class="va">content</span>.<span class="at">cloneNode</span>(<span class="kw">true</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb51-12" title="12"></a>
<a class="sourceLine" id="cb51-13" title="13">    <span class="co">// Get references to the important elements in the shadow DOM</span></a>
<a class="sourceLine" id="cb51-14" title="14">    <span class="kw">this</span>.<span class="at">input</span> <span class="op">=</span> <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">querySelector</span>(<span class="st">&quot;#input&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-15" title="15">    <span class="kw">let</span> leftSlot <span class="op">=</span> <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">querySelector</span>(<span class="st">&#39;slot[name=&quot;left&quot;]&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-16" title="16">    <span class="kw">let</span> rightSlot <span class="op">=</span> <span class="kw">this</span>.<span class="va">shadowRoot</span>.<span class="at">querySelector</span>(<span class="st">&#39;slot[name=&quot;right&quot;]&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-17" title="17"></a>
<a class="sourceLine" id="cb51-18" title="18">    <span class="co">// When the internal input field gets or loses focus, set or remove</span></a>
<a class="sourceLine" id="cb51-19" title="19">    <span class="co">// the &quot;focused&quot; attribute which will cause our internal stylesheet</span></a>
<a class="sourceLine" id="cb51-20" title="20">    <span class="co">// to display or hide a fake focus ring on the entire component. Note</span></a>
<a class="sourceLine" id="cb51-21" title="21">    <span class="co">// that the &quot;blur&quot; and &quot;focus&quot; events bubble and appear to originate</span></a>
<a class="sourceLine" id="cb51-22" title="22">    <span class="co">// from the &lt;search-box&gt;.</span></a>
<a class="sourceLine" id="cb51-23" title="23">    <span class="kw">this</span>.<span class="va">input</span>.<span class="at">onfocus</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-24" title="24">      <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;focused&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-25" title="25">    <span class="op">};</span></a>
<a class="sourceLine" id="cb51-26" title="26">    <span class="kw">this</span>.<span class="va">input</span>.<span class="at">onblur</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-27" title="27">      <span class="kw">this</span>.<span class="at">removeAttribute</span>(<span class="st">&quot;focused&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-28" title="28">    <span class="op">};</span></a>
<a class="sourceLine" id="cb51-29" title="29"></a>
<a class="sourceLine" id="cb51-30" title="30">    <span class="co">// If the user clicks on the magnifying glass, trigger a &quot;search&quot;</span></a>
<a class="sourceLine" id="cb51-31" title="31">    <span class="co">// event.  Also trigger it if the input field fires a &quot;change&quot;</span></a>
<a class="sourceLine" id="cb51-32" title="32">    <span class="co">// event. (The &quot;change&quot; event does not bubble out of the Shadow DOM.)</span></a>
<a class="sourceLine" id="cb51-33" title="33">    <span class="va">leftSlot</span>.<span class="at">onclick</span> <span class="op">=</span> <span class="kw">this</span>.<span class="va">input</span>.<span class="at">onchange</span> <span class="op">=</span> (event) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-34" title="34">      <span class="va">event</span>.<span class="at">stopPropagation</span>()<span class="op">;</span> <span class="co">// Prevent click events from bubbling</span></a>
<a class="sourceLine" id="cb51-35" title="35">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">disabled</span>) <span class="cf">return</span><span class="op">;</span> <span class="co">// Do nothing when disabled</span></a>
<a class="sourceLine" id="cb51-36" title="36">      <span class="kw">this</span>.<span class="at">dispatchEvent</span>(</a>
<a class="sourceLine" id="cb51-37" title="37">        <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&quot;search&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-38" title="38">          <span class="dt">detail</span><span class="op">:</span> <span class="kw">this</span>.<span class="va">input</span>.<span class="at">value</span><span class="op">,</span></a>
<a class="sourceLine" id="cb51-39" title="39">        <span class="op">}</span>)</a>
<a class="sourceLine" id="cb51-40" title="40">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb51-41" title="41">    <span class="op">};</span></a>
<a class="sourceLine" id="cb51-42" title="42"></a>
<a class="sourceLine" id="cb51-43" title="43">    <span class="co">// If the user clicks on the X, trigger a &quot;clear&quot; event.</span></a>
<a class="sourceLine" id="cb51-44" title="44">    <span class="co">// If preventDefault() is not called on the event, clear the input.</span></a>
<a class="sourceLine" id="cb51-45" title="45">    <span class="va">rightSlot</span>.<span class="at">onclick</span> <span class="op">=</span> (event) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-46" title="46">      <span class="va">event</span>.<span class="at">stopPropagation</span>()<span class="op">;</span> <span class="co">// Don&#39;t let the click bubble up</span></a>
<a class="sourceLine" id="cb51-47" title="47">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">disabled</span>) <span class="cf">return</span><span class="op">;</span> <span class="co">// Don&#39;t do anything if disabled</span></a>
<a class="sourceLine" id="cb51-48" title="48">      <span class="kw">let</span> e <span class="op">=</span> <span class="kw">new</span> <span class="at">CustomEvent</span>(<span class="st">&quot;clear&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">cancelable</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-49" title="49">      <span class="kw">this</span>.<span class="at">dispatchEvent</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-50" title="50">      <span class="cf">if</span> (<span class="op">!</span><span class="va">e</span>.<span class="at">defaultPrevented</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-51" title="51">        <span class="co">// If the event was not &quot;cancelled&quot;</span></a>
<a class="sourceLine" id="cb51-52" title="52">        <span class="kw">this</span>.<span class="va">input</span>.<span class="at">value</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// then clear the input field</span></a>
<a class="sourceLine" id="cb51-53" title="53">      <span class="op">}</span></a>
<a class="sourceLine" id="cb51-54" title="54">    <span class="op">};</span></a>
<a class="sourceLine" id="cb51-55" title="55">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-56" title="56"></a>
<a class="sourceLine" id="cb51-57" title="57">  <span class="co">// When some of our attributes are set or changed, we need to set the</span></a>
<a class="sourceLine" id="cb51-58" title="58">  <span class="co">// corresponding value on the internal &lt;input&gt; element. This life cycle</span></a>
<a class="sourceLine" id="cb51-59" title="59">  <span class="co">// method, together with the static observedAttributes property below,</span></a>
<a class="sourceLine" id="cb51-60" title="60">  <span class="co">// takes care of that.</span></a>
<a class="sourceLine" id="cb51-61" title="61">  <span class="at">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-62" title="62">    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;disabled&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-63" title="63">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">disabled</span> <span class="op">=</span> newValue <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span></a>
<a class="sourceLine" id="cb51-64" title="64">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;placeholder&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-65" title="65">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">placeholder</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb51-66" title="66">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;size&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-67" title="67">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">size</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb51-68" title="68">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&quot;value&quot;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-69" title="69">      <span class="kw">this</span>.<span class="va">input</span>.<span class="at">value</span> <span class="op">=</span> newValue<span class="op">;</span></a>
<a class="sourceLine" id="cb51-70" title="70">    <span class="op">}</span></a>
<a class="sourceLine" id="cb51-71" title="71">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-72" title="72"></a>
<a class="sourceLine" id="cb51-73" title="73">  <span class="co">// Finally, we define property getters and setters for properties that</span></a>
<a class="sourceLine" id="cb51-74" title="74">  <span class="co">// correspond to the HTML attributes we support. The getters simply return</span></a>
<a class="sourceLine" id="cb51-75" title="75">  <span class="co">// the value (or the presence) of the attribute. And the setters just set</span></a>
<a class="sourceLine" id="cb51-76" title="76">  <span class="co">// the value (or the presence) of the attribute. When a setter method</span></a>
<a class="sourceLine" id="cb51-77" title="77">  <span class="co">// changes an attribute, the browser will automatically invoke the</span></a>
<a class="sourceLine" id="cb51-78" title="78">  <span class="co">// attributeChangedCallback above.</span></a>
<a class="sourceLine" id="cb51-79" title="79"></a>
<a class="sourceLine" id="cb51-80" title="80">  get <span class="at">placeholder</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb51-81" title="81">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;placeholder&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-82" title="82">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-83" title="83">  get <span class="at">size</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb51-84" title="84">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;size&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-85" title="85">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-86" title="86">  get <span class="at">value</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb51-87" title="87">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getAttribute</span>(<span class="st">&quot;value&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-88" title="88">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-89" title="89">  get <span class="at">disabled</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb51-90" title="90">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">hasAttribute</span>(<span class="st">&quot;disabled&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-91" title="91">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-92" title="92">  get <span class="at">hidden</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb51-93" title="93">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">hasAttribute</span>(<span class="st">&quot;hidden&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-94" title="94">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-95" title="95"></a>
<a class="sourceLine" id="cb51-96" title="96">  set <span class="at">placeholder</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-97" title="97">    <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;placeholder&quot;</span><span class="op">,</span> value)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-98" title="98">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-99" title="99">  set <span class="at">size</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-100" title="100">    <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;size&quot;</span><span class="op">,</span> value)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-101" title="101">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-102" title="102">  set <span class="at">value</span>(text) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-103" title="103">    <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;value&quot;</span><span class="op">,</span> text)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-104" title="104">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-105" title="105">  set <span class="at">disabled</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-106" title="106">    <span class="cf">if</span> (value) <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;disabled&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-107" title="107">    <span class="cf">else</span> <span class="kw">this</span>.<span class="at">removeAttribute</span>(<span class="st">&quot;disabled&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-108" title="108">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-109" title="109">  set <span class="at">hidden</span>(value) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-110" title="110">    <span class="cf">if</span> (value) <span class="kw">this</span>.<span class="at">setAttribute</span>(<span class="st">&quot;hidden&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-111" title="111">    <span class="cf">else</span> <span class="kw">this</span>.<span class="at">removeAttribute</span>(<span class="st">&quot;hidden&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-112" title="112">  <span class="op">}</span></a>
<a class="sourceLine" id="cb51-113" title="113"><span class="op">}</span></a>
<a class="sourceLine" id="cb51-114" title="114"></a>
<a class="sourceLine" id="cb51-115" title="115"><span class="co">// This static field is required for the attributeChangedCallback method.</span></a>
<a class="sourceLine" id="cb51-116" title="116"><span class="co">// Only attributes named in this array will trigger calls to that method.</span></a>
<a class="sourceLine" id="cb51-117" title="117"><span class="va">SearchBox</span>.<span class="at">observedAttributes</span> <span class="op">=</span> [<span class="st">&quot;disabled&quot;</span><span class="op">,</span> <span class="st">&quot;placeholder&quot;</span><span class="op">,</span> <span class="st">&quot;size&quot;</span><span class="op">,</span> <span class="st">&quot;value&quot;</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb51-118" title="118"></a>
<a class="sourceLine" id="cb51-119" title="119"><span class="co">// Create a &lt;template&gt; element to hold the stylesheet and the tree of</span></a>
<a class="sourceLine" id="cb51-120" title="120"><span class="co">// elements that we&#39;ll use for each instance of the SearchBox element.</span></a>
<a class="sourceLine" id="cb51-121" title="121"><span class="va">SearchBox</span>.<span class="at">template</span> <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;template&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-122" title="122"></a>
<a class="sourceLine" id="cb51-123" title="123"><span class="co">// We initialize the template by parsing this string of HTML. Note, however,</span></a>
<a class="sourceLine" id="cb51-124" title="124"><span class="co">// that when we instantiate a SearchBox, we are able to just clone the nodes</span></a>
<a class="sourceLine" id="cb51-125" title="125"><span class="co">// in the template and do have to parse the HTML again.</span></a>
<a class="sourceLine" id="cb51-126" title="126"><span class="va">SearchBox</span>.<span class="va">template</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb51-127" title="127"><span class="vs">&lt;style&gt;</span></a></code></pre></div>
<hr />
<p>/<em> </em> The :host selector refers to the <search-box> element in the light * DOM. These styles are defaults and can be overridden by the user of the * <search-box> with styles in the light DOM. */</p>
<hr />
<p>```js :host { display: inline-block; /* The default is inline display */</p>
<hr />
<p>```js border: solid black 1px; /* A rounded border around the <input> and <slots> */</p>
<hr />
<p>```js border-radius: 5px; padding: 4px 6px; /* And some space inside the border */</p>
<hr />
<p>```js } :host([hidden]) { /* Note the parentheses: when host has hidden… */</p>
<hr />
<p>```js display:none; /* …attribute set don’t display it */</p>
<hr />
<p>```js } :host([disabled]) { /* When host has the disabled attribute… */</p>
<hr />
<p>```js opacity: 0.5; /* …gray it out */</p>
<hr />
<p>```js } :host([focused]) { /* When host has the focused attribute… */</p>
<hr />
<p>```js box-shadow: 0 0 2px 2px #6AE; /* display this fake focus ring. */</p>
<hr />
<p>```js }</p>
<p>/* The rest of the stylesheet only applies to elements in the Shadow DOM. */</p>
<hr />
<p>```js input { border-width: 0; /* Hide the border of the internal input field. */</p>
<hr />
<p>```js outline: none; /* Hide the focus ring, too. */</p>
<hr />
<p>```js font: inherit; /* <input> elements don’t inherit font by default */</p>
<hr />
<p>```js background: inherit; /* Same for background color. */</p>
<hr />
<p>```js } slot { cursor: default; /* An arrow pointer cursor over the buttons */</p>
<hr />
<p>```js user-select: none; /* Don’t let the user select the emoji text */</p>
<hr />
<p>``<code>js } &lt;/style&gt; &lt;div&gt;   &lt;slot name="left"&gt;\u{1f50d}&lt;/slot&gt;  &lt;!-- U+1F50D is a magnifying glass --&gt;   &lt;input type="text" id="input" /&gt;    &lt;!-- The actual input element --&gt;   &lt;slot name="right"&gt;\u{2573}&lt;/slot&gt;  &lt;!-- U+2573 is an X --&gt; &lt;/div&gt;</code>;</p>
<p>// Finally, we call customElement.define() to register the SearchBox element // as the implementation of the <search-box> tag. Custom elements are required // to have a tag name that contains a hyphen. customElements.define(“search-box”, SearchBox); function* sequence(…iterables) { for (let iterable of iterables) { yield* iterable; } }</p>
<p>[…sequence(“abc”, oneDigitPrimes())]; // =&gt; [“a”,“b”,“c”,2,3,5,7] // This object generates strictly increasing serial numbers const serialnum = { // This data property holds the next serial number. // The _ in the property name hints that it is for internal use only. _n: 0,</p>
<p>// Return the current value and increment it get next() { return this._n++; },</p>
<p>// Set a new value of n, but only if it is larger than current set next(n) { if (n &gt; this._n) this._n = n; else throw new Error(“serial number can only be set to a larger value”); }, }; serialnum.next = 10; // Set the starting serial number serialnum.next; // =&gt; 10 serialnum.next; // =&gt; 11: different value each time we get next // Store the name/value pair as a cookie, encoding the value with // encodeURIComponent() in order to escape semicolons, commas, and spaces. // If daysToLive is a number, set the max-age attribute so that the cookie // expires after the specified number of days. Pass 0 to delete a cookie. function setCookie(name, value, daysToLive = null) { let cookie = <code>${name}=${encodeURIComponent(value)}</code>; if (daysToLive !== null) { cookie += <code>; max-age=${daysToLive * 60 * 60 * 24}</code>; } document.cookie = cookie; } function setTheme(name) { // Create a new <link rel="stylesheet"> element to load the named stylesheet let link = document.createElement(“link”); link.id = “theme”; link.rel = “stylesheet”; link.href = <code>themes/${name}.css</code>;</p>
<p>// Look for an existing link with id “theme” let currentTheme = document.querySelector(“#theme”); if (currentTheme) { // If there is an existing theme, replace it with the new one. currentTheme.replaceWith(link); } else { // Otherwise, just insert the link to the theme stylesheet. document.head.append(link); } } let authHeaders = new Headers(); // Don’t use Basic auth unless it is over an HTTPS connection. authHeaders.set(“Authorization”, <code>Basic ${btoa(</code><span class="math inline"><em>u</em><em>s</em><em>e</em><em>r</em><em>n</em><em>a</em><em>m</em><em>e</em>:</span>{password}<code>)}</code>); fetch(“/api/users/”, { headers: authHeaders }) .then((response) =&gt; response.json()) // Error handling omitted… .then((usersList) =&gt; displayAllUsers(usersList)); async function search(term) { let url = new URL(“/api/search”); url.searchParams.set(“q”, term); let response = await fetch(url); if (!response.ok) throw new Error(response.statusText); let resultsArray = await response.json(); return resultsArray; } // Return the largest prime smaller than n, using the sieve of Eratosthenes function sieve(n) { let a = new Uint8Array(n + 1); // a[x] will be 1 if x is composite let max = Math.floor(Math.sqrt(n)); // Don’t do factors higher than this let p = 2; // 2 is the first prime while (p &lt;= max) { // For primes less than max for ( let i = 2 * p; i &lt;= n; i += p // Mark multiples of p as composite ) a[i] = 1; while (a[++p] /* empty */); // The next unmarked index is prime } while (a[n]) n–; // Loop backward to find the last prime return n; // And return it } // Smear the pixels of the rectangle to the right, producing a // sort of motion blur as if objects are moving from right to left. // n must be 2 or larger. Larger values produce bigger smears. // The rectangle is specified in the default coordinate system. function smear(c, n, x, y, w, h) { // Get the ImageData object that represents the rectangle of pixels to smear let pixels = c.getImageData(x, y, w, h);</p>
<p>// This smear is done in-place and requires only the source ImageData. // Some image processing algorithms require an additional ImageData to // store transformed pixel values. If we needed an output buffer, we could // create a new ImageData with the same dimensions like this: // let output_pixels = c.createImageData(pixels);</p>
<p>// Get the dimensions of the grid of pixels in the ImageData object let width = pixels.width, height = pixels.height;</p>
<p>// This is the byte array that holds the raw pixel data, left-to-right and // top-to-bottom. Each pixel occupies 4 consecutive bytes in R,G,B,A order. let data = pixels.data;</p>
<p>// Each pixel after the first in each row is smeared by replacing it with // 1/nth of its own value plus m/nths of the previous pixel’s value let m = n - 1;</p>
<p>for (let row = 0; row &lt; height; row++) { // For each row let i = row * width * 4 + 4; // The offset of the second pixel of the row for (let col = 1; col &lt; width; col++, i += 4) { // For each column data[i] = (data[i] + data[i - 4] * m) / n; // Red pixel component data[i + 1] = (data[i + 1] + data[i - 3] * m) / n; // Green data[i + 2] = (data[i + 2] + data[i - 2] * m) / n; // Blue data[i + 3] = (data[i + 3] + data[i - 1] * m) / n; // Alpha component } }</p>
<p>// Now copy the smeared image data back to the same position on the canvas c.putImageData(pixels, x, y); } const threads = require(“worker_threads”);</p>
<p>// The worker_threads module exports the boolean isMainThread property. // This property is true when Node is running the main thread and it is // false when Node is running a worker. We can use this fact to implement // the main and worker threads in the same file. if (threads.isMainThread) { // If we’re running in the main thread, then all we do is export // a function. Instead of performing a computationally intensive // task on the main thread, this function passes the task to a worker // and returns a Promise that will resolve when the worker is done. module.exports = function reticulateSplines(splines) { return new Promise((resolve, reject) =&gt; { // Create a worker that loads and runs this same file of code. // Note the use of the special __filename variable. let reticulator = new threads.Worker(__filename);</p>
<pre><code>  // Pass a copy of the splines array to the worker
  reticulator.postMessage(splines);

  // And then resolve or reject the Promise when we get
  // a message or error from the worker.
  reticulator.on(&quot;message&quot;, resolve);
  reticulator.on(&quot;error&quot;, reject);
});</code></pre>
<p>}; } else { // If we get here, it means we’re in the worker, so we register a // handler to get messages from the main thread. This worker is designed // to only receive a single message, so we register the event handler // with once() instead of on(). This allows the worker to exit naturally // when its work is complete. threads.parentPort.once(“message”, (splines) =&gt; { // When we get the splines from the parent thread, loop // through them and reticulate all of them. for (let spline of splines) { // For the sake of example, assume that spline objects usually // have a reticulate() method that does a lot of computation. spline.reticulate ? spline.reticulate() : (spline.reticulated = true); }</p>
<pre><code>// When all the splines have (finally!) been reticulated
// pass a copy back to the main thread.
threads.parentPort.postMessage(splines);</code></pre>
<p>}); } // This is a simple static HTTP server that serves files from a specified // directory. It also implements a special /test/mirror endpoint that // echoes the incoming request, which can be useful when debugging clients. const http = require(“http”); // Use “https” if you have a certificate const url = require(“url”); // For parsing URLs const path = require(“path”); // For manipulating filesystem paths const fs = require(“fs”); // For reading files</p>
<p>// Serve files from the specified root directory via an HTTP server that // listens on the specified port. function serve(rootDirectory, port) { let server = new http.Server(); // Create a new HTTP server server.listen(port); // Listen on the specified port console.log(“Listening on port”, port);</p>
<p>// When requests come in, handle them with this function server.on(“request”, (request, response) =&gt; { // Get the path portion of the request URL, ignoring // any query parameters that are appended to it. let endpoint = url.parse(request.url).pathname;</p>
<pre><code>// If the request was for &quot;/test/mirror&quot;, send back the request
// verbatim. Useful when you need to see the request headers and body.
if (endpoint === &quot;/test/mirror&quot;) {
  // Set response header
  response.setHeader(&quot;Content-Type&quot;, &quot;text/plain; charset=UTF-8&quot;);

  // Specify response status code
  response.writeHead(200); // 200 OK

  // Begin the response body with the request
  response.write(
    `${request.method} ${request.url} HTTP/${request.httpVersion}\r\n`
  );

  // Output the request headers
  let headers = request.rawHeaders;
  for (let i = 0; i &lt; headers.length; i += 2) {
    response.write(`${headers[i]}: ${headers[i + 1]}\r\n`);
  }

  // End headers with an extra blank line
  response.write(&quot;\r\n&quot;);

  // Now we need to copy any request body to the response body
  // Since they are both streams, we can use a pipe
  request.pipe(response);
}
// Otherwise, serve a file from the local directory.
else {
  // Map the endpoint to a file in the local filesystem
  let filename = endpoint.substring(1); // strip leading /
  // Don&#39;t allow &quot;../&quot; in the path because it would be a security
  // hole to serve anything outside the root directory.
  filename = filename.replace(/\.\.\//g, &quot;&quot;);
  // Now convert from relative to absolute filename
  filename = path.resolve(rootDirectory, filename);

  // Now guess the type file&#39;s content type based on extension
  let type;
  switch (path.extname(filename)) {
    case &quot;.html&quot;:
    case &quot;.htm&quot;:
      type = &quot;text/html&quot;;
      break;
    case &quot;.js&quot;:
      type = &quot;text/javascript&quot;;
      break;
    case &quot;.css&quot;:
      type = &quot;text/css&quot;;
      break;
    case &quot;.png&quot;:
      type = &quot;image/png&quot;;
      break;
    case &quot;.txt&quot;:
      type = &quot;text/plain&quot;;
      break;
    default:
      type = &quot;application/octet-stream&quot;;
      break;
  }

  let stream = fs.createReadStream(filename);
  stream.once(&quot;readable&quot;, () =&gt; {
    // If the stream becomes readable, then set the
    // Content-Type header and a 200 OK status. Then pipe the
    // file reader stream to the response. The pipe will
    // automatically call response.end() when the stream ends.
    response.setHeader(&quot;Content-Type&quot;, type);
    response.writeHead(200);
    stream.pipe(response);
  });

  stream.on(&quot;error&quot;, (err) =&gt; {
    // Instead, if we get an error trying to open the stream
    // then the file probably does not exist or is not readable.
    // Send a 404 Not Found plain-text response with the
    // error message.
    response.setHeader(&quot;Content-Type&quot;, &quot;text/plain; charset=UTF-8&quot;);
    response.writeHead(404);
    response.end(err.message);
  });
}</code></pre>
<p>}); }</p>
<p>// When we’re invoked from the command line, call the serve() function serve(process.argv[2] || “/tmp”, parseInt(process.argv[3]) || 8000); // This is how we could define a stats module const stats = (function () { // Utility functions private to the module const sum = (x, y) =&gt; x + y; const square = (x) =&gt; x * x;</p>
<p>// A public function that will be exported function mean(data) { return data.reduce(sum) / data.length; }</p>
<p>// A public function that we will export function stddev(data) { let m = mean(data); return Math.sqrt( data .map((x) =&gt; x - m) .map(square) .reduce(sum) / (data.length - 1) ); }</p>
<p>// We export the public function as properties of an object return { mean, stddev }; })();</p>
<p>// And here is how we might use the module stats.mean([1, 3, 5, 7, 9]); // =&gt; 5 stats.stddev([1, 3, 5, 7, 9]); // =&gt; Math.sqrt(10) let data = [1, 1, 3, 5, 5]; // This is our array of numbers</p>
<p>// The mean is the sum of the elements divided by the number of elements let total = 0; for (let i = 0; i &lt; data.length; i++) total += data[i]; let mean = total / data.length; // mean == 3; The mean of our data is 3</p>
<p>// To compute the standard deviation, we first sum the squares of // the deviation of each element from the mean. total = 0; for (let i = 0; i &lt; data.length; i++) { let deviation = data[i] - mean; total += deviation * deviation; } let stddev = Math.sqrt(total / (data.length - 1)); // stddev == 2 // First, define two simple functions const sum = (x, y) =&gt; x + y; const square = (x) =&gt; x * x;</p>
<p>// Then use those functions with Array methods to compute mean and stddev let data = [1, 1, 3, 5, 5]; let mean = data.reduce(sum) / data.length; // mean == 3 let deviations = data.map((x) =&gt; x - mean); let stddev = Math.sqrt(deviations.map(square).reduce(sum) / (data.length - 1)); stddev; // =&gt; 2 const map = function (a, …args) { return a.map(…args); }; const reduce = function (a, …args) { return a.reduce(…args); }; const sum = (x, y) =&gt; x + y; const square = (x) =&gt; x * x;</p>
<p>let data = [1, 1, 3, 5, 5]; let mean = reduce(data, sum) / data.length; let deviations = map(data, (x) =&gt; x - mean); let stddev = Math.sqrt( reduce(map(deviations, square), sum) / (data.length - 1) ); stddev; // =&gt; 2</p>
<p>//———————————————————————————————— //————————————————————————————————</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb55-1" title="1"></a>
<a class="sourceLine" id="cb55-2" title="2"></a>
<a class="sourceLine" id="cb55-3" title="3"><span class="op">---</span></a>
<a class="sourceLine" id="cb55-4" title="4"></a>
<a class="sourceLine" id="cb55-5" title="5"></a>
<a class="sourceLine" id="cb55-6" title="6"><span class="co">/*</span></a>
<a class="sourceLine" id="cb55-7" title="7"><span class="co"> An asynchronous function for streaming the body of a Response object</span></a>
<a class="sourceLine" id="cb55-8" title="8"><span class="co"> * obtained from a fetch() request. Pass the Response object as the first</span></a>
<a class="sourceLine" id="cb55-9" title="9"><span class="co"> * argument followed by two optional callbacks.</span></a>
<a class="sourceLine" id="cb55-10" title="10"><span class="co"> *</span></a>
<a class="sourceLine" id="cb55-11" title="11"><span class="co"> * If you specify a function as the second argument, that reportProgress</span></a>
<a class="sourceLine" id="cb55-12" title="12"><span class="co"> * callback will be called once for each chunk that is received. The first</span></a>
<a class="sourceLine" id="cb55-13" title="13"><span class="co"> * argument passed is the total number of bytes received so far. The second</span></a>
<a class="sourceLine" id="cb55-14" title="14"><span class="co"> * argument is a number between 0 and 1 specifying how complete the download</span></a>
<a class="sourceLine" id="cb55-15" title="15"><span class="co"> * is. If the Response object has no &quot;Content-Length&quot; header, however, then</span></a>
<a class="sourceLine" id="cb55-16" title="16"><span class="co"> * this second argument will always be NaN.</span></a>
<a class="sourceLine" id="cb55-17" title="17"><span class="co"> *</span></a>
<a class="sourceLine" id="cb55-18" title="18"><span class="co"> * If you want to process the data in chunks as they arrive, specify a</span></a>
<a class="sourceLine" id="cb55-19" title="19"><span class="co"> * function as the third argument. The chunks will be passed, as Uint8Array</span></a>
<a class="sourceLine" id="cb55-20" title="20"><span class="co"> * objects, to this processChunk callback.</span></a>
<a class="sourceLine" id="cb55-21" title="21"><span class="co"> *</span></a>
<a class="sourceLine" id="cb55-22" title="22"><span class="co"> * streamBody() returns a Promise that resolves to a string. If a processChunk</span></a>
<a class="sourceLine" id="cb55-23" title="23"><span class="co"> * callback was supplied then this string is the concatenation of the values</span></a>
<a class="sourceLine" id="cb55-24" title="24"><span class="co"> * returned by that callback. Otherwise the string is the concatenation of</span></a>
<a class="sourceLine" id="cb55-25" title="25"><span class="co"> * the chunk values converted to UTF-8 strings.</span></a>
<a class="sourceLine" id="cb55-26" title="26"><span class="co"> */</span></a>
<a class="sourceLine" id="cb55-27" title="27"></a>
<a class="sourceLine" id="cb55-28" title="28"></a>
<a class="sourceLine" id="cb55-29" title="29"><span class="op">---</span></a></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb56-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">streamBody</span>(response<span class="op">,</span> reportProgress<span class="op">,</span> processChunk) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-2" title="2">  <span class="co">// How many bytes are we expecting, or NaN if no header</span></a>
<a class="sourceLine" id="cb56-3" title="3">  <span class="kw">let</span> expectedBytes <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">response</span>.<span class="va">headers</span>.<span class="at">get</span>(<span class="st">&quot;Content-Length&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb56-4" title="4">  <span class="kw">let</span> bytesRead <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// How many bytes received so far</span></a>
<a class="sourceLine" id="cb56-5" title="5">  <span class="kw">let</span> reader <span class="op">=</span> <span class="va">response</span>.<span class="va">body</span>.<span class="at">getReader</span>()<span class="op">;</span> <span class="co">// Read bytes with this function</span></a>
<a class="sourceLine" id="cb56-6" title="6">  <span class="kw">let</span> decoder <span class="op">=</span> <span class="kw">new</span> <span class="at">TextDecoder</span>(<span class="st">&quot;utf-8&quot;</span>)<span class="op">;</span> <span class="co">// For converting bytes to text</span></a>
<a class="sourceLine" id="cb56-7" title="7">  <span class="kw">let</span> body <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// Text read so far</span></a>
<a class="sourceLine" id="cb56-8" title="8"></a>
<a class="sourceLine" id="cb56-9" title="9">  <span class="cf">while</span> (<span class="kw">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-10" title="10">    <span class="co">// Loop until we exit below</span></a>
<a class="sourceLine" id="cb56-11" title="11">    <span class="kw">let</span> <span class="op">{</span> done<span class="op">,</span> value <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">reader</span>.<span class="at">read</span>()<span class="op">;</span> <span class="co">// Read a chunk</span></a>
<a class="sourceLine" id="cb56-12" title="12"></a>
<a class="sourceLine" id="cb56-13" title="13">    <span class="cf">if</span> (value) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-14" title="14">      <span class="co">// If we got a byte array:</span></a>
<a class="sourceLine" id="cb56-15" title="15">      <span class="cf">if</span> (processChunk) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-16" title="16">        <span class="co">// Process the bytes if</span></a>
<a class="sourceLine" id="cb56-17" title="17">        <span class="kw">let</span> processed <span class="op">=</span> <span class="at">processChunk</span>(value)<span class="op">;</span> <span class="co">// a callback was passed.</span></a>
<a class="sourceLine" id="cb56-18" title="18">        <span class="cf">if</span> (processed) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-19" title="19">          body <span class="op">+=</span> processed<span class="op">;</span></a>
<a class="sourceLine" id="cb56-20" title="20">        <span class="op">}</span></a>
<a class="sourceLine" id="cb56-21" title="21">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-22" title="22">        <span class="co">// Otherwise, convert bytes</span></a>
<a class="sourceLine" id="cb56-23" title="23">        body <span class="op">+=</span> <span class="va">decoder</span>.<span class="at">decode</span>(value<span class="op">,</span> <span class="op">{</span> <span class="dt">stream</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span> <span class="co">// to text.</span></a>
<a class="sourceLine" id="cb56-24" title="24">      <span class="op">}</span></a>
<a class="sourceLine" id="cb56-25" title="25"></a>
<a class="sourceLine" id="cb56-26" title="26">      <span class="cf">if</span> (reportProgress) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-27" title="27">        <span class="co">// If a progress callback was</span></a>
<a class="sourceLine" id="cb56-28" title="28">        bytesRead <span class="op">+=</span> <span class="va">value</span>.<span class="at">length</span><span class="op">;</span> <span class="co">// passed, then call it</span></a>
<a class="sourceLine" id="cb56-29" title="29">        <span class="at">reportProgress</span>(bytesRead<span class="op">,</span> bytesRead / expectedBytes)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-30" title="30">      <span class="op">}</span></a>
<a class="sourceLine" id="cb56-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-32" title="32">    <span class="cf">if</span> (done) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-33" title="33">      <span class="co">// If this is the last chunk,</span></a>
<a class="sourceLine" id="cb56-34" title="34">      <span class="cf">break</span><span class="op">;</span> <span class="co">// exit the loop</span></a>
<a class="sourceLine" id="cb56-35" title="35">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-36" title="36">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-37" title="37"></a>
<a class="sourceLine" id="cb56-38" title="38">  <span class="cf">return</span> body<span class="op">;</span> <span class="co">// Return the body text we accumulated</span></a>
<a class="sourceLine" id="cb56-39" title="39"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-40" title="40"><span class="co">// Yield the first n elements of the specified iterable object</span></a>
<a class="sourceLine" id="cb56-41" title="41"><span class="kw">function</span><span class="op">*</span> <span class="at">take</span>(n<span class="op">,</span> iterable) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-42" title="42">  <span class="kw">let</span> it <span class="op">=</span> iterable[<span class="va">Symbol</span>.<span class="at">iterator</span>]()<span class="op">;</span> <span class="co">// Get iterator for iterable object</span></a>
<a class="sourceLine" id="cb56-43" title="43">  <span class="cf">while</span> (n<span class="op">--</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-44" title="44">    <span class="co">// Loop n times:</span></a>
<a class="sourceLine" id="cb56-45" title="45">    <span class="kw">let</span> next <span class="op">=</span> <span class="va">it</span>.<span class="at">next</span>()<span class="op">;</span> <span class="co">// Get the next item from the iterator.</span></a>
<a class="sourceLine" id="cb56-46" title="46">    <span class="cf">if</span> (<span class="va">next</span>.<span class="at">done</span>) <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-47" title="47">    <span class="co">// If there are no more values, return early</span></a>
<a class="sourceLine" id="cb56-48" title="48">    <span class="cf">else</span> <span class="kw">yield</span> <span class="va">next</span>.<span class="at">value</span><span class="op">;</span> <span class="co">// otherwise, yield the value</span></a>
<a class="sourceLine" id="cb56-49" title="49">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-50" title="50"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-51" title="51"></a>
<a class="sourceLine" id="cb56-52" title="52"><span class="co">// An array of the first 5 Fibonacci numbers</span></a>
<a class="sourceLine" id="cb56-53" title="53">[...<span class="at">take</span>(<span class="dv">5</span><span class="op">,</span> <span class="at">fibonacciSequence</span>())]<span class="op">;</span> <span class="co">// =&gt; [1, 1, 2, 3, 5]</span></a>
<a class="sourceLine" id="cb56-54" title="54"><span class="co">// Return the plain-text content of element e, recursing into child elements.</span></a>
<a class="sourceLine" id="cb56-55" title="55"><span class="co">// This method works like the textContent property</span></a>
<a class="sourceLine" id="cb56-56" title="56"><span class="kw">function</span> <span class="at">textContent</span>(e) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-57" title="57">  <span class="kw">let</span> s <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span> <span class="co">// Accumulate the text here</span></a>
<a class="sourceLine" id="cb56-58" title="58">  <span class="cf">for</span> (<span class="kw">let</span> child <span class="op">=</span> <span class="va">e</span>.<span class="at">firstChild</span><span class="op">;</span> child <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span> child <span class="op">=</span> <span class="va">child</span>.<span class="at">nextSibling</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-59" title="59">    <span class="kw">let</span> type <span class="op">=</span> <span class="va">child</span>.<span class="at">nodeType</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-60" title="60">    <span class="cf">if</span> (type <span class="op">===</span> <span class="dv">3</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-61" title="61">      <span class="co">// If it is a Text node</span></a>
<a class="sourceLine" id="cb56-62" title="62">      s <span class="op">+=</span> <span class="va">child</span>.<span class="at">nodeValue</span><span class="op">;</span> <span class="co">// add the text content to our string.</span></a>
<a class="sourceLine" id="cb56-63" title="63">    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (type <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-64" title="64">      <span class="co">// And if it is an Element node</span></a>
<a class="sourceLine" id="cb56-65" title="65">      s <span class="op">+=</span> <span class="at">textContent</span>(child)<span class="op">;</span> <span class="co">// then recurse.</span></a>
<a class="sourceLine" id="cb56-66" title="66">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-67" title="67">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-68" title="68">  <span class="cf">return</span> s<span class="op">;</span></a>
<a class="sourceLine" id="cb56-69" title="69"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-70" title="70"><span class="kw">const</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;fs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-71" title="71"><span class="kw">let</span> filename <span class="op">=</span> <span class="st">&quot;./streetNames.txt&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-72" title="72"><span class="kw">let</span> finalArr <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb56-73" title="73"><span class="va">fs</span>.<span class="at">readFile</span>(filename<span class="op">,</span> (err<span class="op">,</span> text) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-74" title="74">  <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span></a>
<a class="sourceLine" id="cb56-75" title="75"></a>
<a class="sourceLine" id="cb56-76" title="76">  <span class="kw">const</span> arr <span class="op">=</span> <span class="va">text</span>.<span class="at">toString</span>().<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\r\n</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>).<span class="at">split</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-77" title="77"></a>
<a class="sourceLine" id="cb56-78" title="78">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="kw">of</span> arr) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-79" title="79">    <span class="va">console</span>.<span class="at">log</span>(i)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-80" title="80">    <span class="va">finalArr</span>.<span class="at">push</span>(<span class="vs">`&quot;</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&quot;`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-81" title="81">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-82" title="82">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;finalArr: &quot;</span><span class="op">,</span> finalArr)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-83" title="83">  <span class="va">fs</span>.<span class="at">writeFile</span>(</a>
<a class="sourceLine" id="cb56-84" title="84">    <span class="vs">`</span><span class="sc">${</span>filename<span class="sc">}</span><span class="vs">.js`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb56-85" title="85">    <span class="vs">`let </span><span class="sc">${</span>filename</a>
<a class="sourceLine" id="cb56-86" title="86">      .<span class="at">slice</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb56-87" title="87">      .<span class="at">split</span>(<span class="st">&quot;.&quot;</span>)</a>
<a class="sourceLine" id="cb56-88" title="88">      .<span class="at">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb56-89" title="89">      .<span class="at">join</span>(<span class="st">&quot;.&quot;</span>)<span class="sc">}</span><span class="vs">Arr = [</span><span class="sc">${</span>finalArr<span class="sc">}</span><span class="vs">];`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb56-90" title="90">    (err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-91" title="91">      <span class="co">// In case of a error throw err.</span></a>
<a class="sourceLine" id="cb56-92" title="92">      <span class="cf">if</span> (err) <span class="cf">throw</span> err<span class="op">;</span></a>
<a class="sourceLine" id="cb56-93" title="93">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-94" title="94">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb56-95" title="95"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-96" title="96"><span class="co">// This function takes a function and returns a wrapped version</span></a>
<a class="sourceLine" id="cb56-97" title="97"><span class="kw">function</span> <span class="at">timed</span>(f) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-98" title="98">  <span class="cf">return</span> <span class="kw">function</span> (...<span class="at">args</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-99" title="99">    <span class="co">// Collect args into a rest parameter array</span></a>
<a class="sourceLine" id="cb56-100" title="100">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Entering function </span><span class="sc">${</span><span class="va">f</span>.<span class="at">name</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-101" title="101">    <span class="kw">let</span> startTime <span class="op">=</span> <span class="va">Date</span>.<span class="at">now</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb56-102" title="102">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-103" title="103">      <span class="co">// Pass all of our arguments to the wrapped function</span></a>
<a class="sourceLine" id="cb56-104" title="104">      <span class="cf">return</span> <span class="at">f</span>(...<span class="at">args</span>)<span class="op">;</span> <span class="co">// Spread the args back out again</span></a>
<a class="sourceLine" id="cb56-105" title="105">    <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-106" title="106">      <span class="co">// Before we return the wrapped return value, print elapsed time.</span></a>
<a class="sourceLine" id="cb56-107" title="107">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Exiting </span><span class="sc">${</span><span class="va">f</span>.<span class="at">name</span><span class="sc">}</span><span class="vs"> after </span><span class="sc">${</span><span class="va">Date</span>.<span class="at">now</span>() <span class="op">-</span> startTime<span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-108" title="108">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-109" title="109">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-110" title="110"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-111" title="111"></a>
<a class="sourceLine" id="cb56-112" title="112"><span class="co">// Compute the sum of the numbers between 1 and n by brute force</span></a>
<a class="sourceLine" id="cb56-113" title="113"><span class="kw">function</span> <span class="at">benchmark</span>(n) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-114" title="114">  <span class="kw">let</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-115" title="115">  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> n<span class="op">;</span> i<span class="op">++</span>) sum <span class="op">+=</span> i<span class="op">;</span></a>
<a class="sourceLine" id="cb56-116" title="116">  <span class="cf">return</span> sum<span class="op">;</span></a>
<a class="sourceLine" id="cb56-117" title="117"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-118" title="118"></a>
<a class="sourceLine" id="cb56-119" title="119"><span class="co">// Now invoke the timed version of that test function</span></a>
<a class="sourceLine" id="cb56-120" title="120"><span class="at">timed</span>(benchmark)(<span class="dv">1000000</span>)<span class="op">;</span> <span class="co">// =&gt; 500000500000; this is the sum of the numbers</span></a>
<a class="sourceLine" id="cb56-121" title="121"><span class="co">// Replace the method named m of the object o with a version that logs</span></a>
<a class="sourceLine" id="cb56-122" title="122"><span class="co">// messages before and after invoking the original method.</span></a>
<a class="sourceLine" id="cb56-123" title="123"><span class="kw">function</span> <span class="at">trace</span>(o<span class="op">,</span> m) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-124" title="124">  <span class="kw">let</span> original <span class="op">=</span> o[m]<span class="op">;</span> <span class="co">// Remember original method in the closure.</span></a>
<a class="sourceLine" id="cb56-125" title="125">  o[m] <span class="op">=</span> <span class="kw">function</span> (...<span class="at">args</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-126" title="126">    <span class="co">// Now define the new method.</span></a>
<a class="sourceLine" id="cb56-127" title="127">    <span class="va">console</span>.<span class="at">log</span>(<span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span> <span class="st">&quot;Entering:&quot;</span><span class="op">,</span> m)<span class="op">;</span> <span class="co">// Log message.</span></a>
<a class="sourceLine" id="cb56-128" title="128">    <span class="kw">let</span> result <span class="op">=</span> <span class="va">original</span>.<span class="at">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">;</span> <span class="co">// Invoke original.</span></a>
<a class="sourceLine" id="cb56-129" title="129">    <span class="va">console</span>.<span class="at">log</span>(<span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span> <span class="st">&quot;Exiting:&quot;</span><span class="op">,</span> m)<span class="op">;</span> <span class="co">// Log message.</span></a>
<a class="sourceLine" id="cb56-130" title="130">    <span class="cf">return</span> result<span class="op">;</span> <span class="co">// Return result.</span></a>
<a class="sourceLine" id="cb56-131" title="131">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-132" title="132"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-133" title="133"><span class="co">// Shear transform:</span></a>
<a class="sourceLine" id="cb56-134" title="134"><span class="co">//   x&#39; = x + kx*y;</span></a>
<a class="sourceLine" id="cb56-135" title="135"><span class="co">//   y&#39; = ky*x + y;</span></a>
<a class="sourceLine" id="cb56-136" title="136"><span class="kw">function</span> <span class="at">shear</span>(c<span class="op">,</span> kx<span class="op">,</span> ky) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-137" title="137">  <span class="va">c</span>.<span class="at">transform</span>(<span class="dv">1</span><span class="op">,</span> ky<span class="op">,</span> kx<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-138" title="138"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-139" title="139"></a>
<a class="sourceLine" id="cb56-140" title="140"><span class="co">// Rotate theta radians counterclockwise around the point (x,y)</span></a>
<a class="sourceLine" id="cb56-141" title="141"><span class="co">// This can also be accomplished with a translate, rotate, translate sequence</span></a>
<a class="sourceLine" id="cb56-142" title="142"><span class="kw">function</span> <span class="at">rotateAbout</span>(c<span class="op">,</span> theta<span class="op">,</span> x<span class="op">,</span> y) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-143" title="143">  <span class="kw">let</span> ct <span class="op">=</span> <span class="va">Math</span>.<span class="at">cos</span>(theta)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-144" title="144">  <span class="kw">let</span> st <span class="op">=</span> <span class="va">Math</span>.<span class="at">sin</span>(theta)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-145" title="145">  <span class="va">c</span>.<span class="at">transform</span>(ct<span class="op">,</span> <span class="op">-</span>st<span class="op">,</span> st<span class="op">,</span> ct<span class="op">,</span> <span class="op">-</span>x <span class="op">*</span> ct <span class="op">-</span> y <span class="op">*</span> st <span class="op">+</span> x<span class="op">,</span> x <span class="op">*</span> st <span class="op">-</span> y <span class="op">*</span> ct <span class="op">+</span> y)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-146" title="146"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-147" title="147"><span class="co">// Recursively traverse the Document or Element e, invoking the function</span></a>
<a class="sourceLine" id="cb56-148" title="148"><span class="co">// f on e and on each of its descendants</span></a>
<a class="sourceLine" id="cb56-149" title="149"><span class="kw">function</span> <span class="at">traverse</span>(e<span class="op">,</span> f) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-150" title="150">  <span class="at">f</span>(e)<span class="op">;</span> <span class="co">// Invoke f() on e</span></a>
<a class="sourceLine" id="cb56-151" title="151">  <span class="cf">for</span> (<span class="kw">let</span> child <span class="kw">of</span> <span class="va">e</span>.<span class="at">children</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-152" title="152">    <span class="co">// Iterate over the children</span></a>
<a class="sourceLine" id="cb56-153" title="153">    <span class="at">traverse</span>(child<span class="op">,</span> f)<span class="op">;</span> <span class="co">// And recurse on each one</span></a>
<a class="sourceLine" id="cb56-154" title="154">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-155" title="155"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-156" title="156"></a>
<a class="sourceLine" id="cb56-157" title="157"><span class="kw">function</span> <span class="at">traverse2</span>(e<span class="op">,</span> f) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-158" title="158">  <span class="at">f</span>(e)<span class="op">;</span> <span class="co">// Invoke f() on e</span></a>
<a class="sourceLine" id="cb56-159" title="159">  <span class="kw">let</span> child <span class="op">=</span> <span class="va">e</span>.<span class="at">firstElementChild</span><span class="op">;</span> <span class="co">// Iterate the children linked-list style</span></a>
<a class="sourceLine" id="cb56-160" title="160">  <span class="cf">while</span> (child <span class="op">!==</span> <span class="kw">null</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-161" title="161">    <span class="at">traverse2</span>(child<span class="op">,</span> f)<span class="op">;</span> <span class="co">// And recurse</span></a>
<a class="sourceLine" id="cb56-162" title="162">    child <span class="op">=</span> <span class="va">child</span>.<span class="at">nextElementSibling</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-163" title="163">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-164" title="164"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-165" title="165"><span class="co">// Initialize the counter property of the function object.</span></a>
<a class="sourceLine" id="cb56-166" title="166"><span class="co">// Function declarations are hoisted so we really can</span></a>
<a class="sourceLine" id="cb56-167" title="167"><span class="co">// do this assignment before the function declaration.</span></a>
<a class="sourceLine" id="cb56-168" title="168"><span class="va">uniqueInteger</span>.<span class="at">counter</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-169" title="169"></a>
<a class="sourceLine" id="cb56-170" title="170"><span class="co">// This function returns a different integer each time it is called.</span></a>
<a class="sourceLine" id="cb56-171" title="171"><span class="co">// It uses a property of itself to remember the next value to be returned.</span></a>
<a class="sourceLine" id="cb56-172" title="172"><span class="kw">function</span> <span class="at">uniqueInteger</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb56-173" title="173">  <span class="cf">return</span> <span class="va">uniqueInteger</span>.<span class="at">counter</span><span class="op">++;</span> <span class="co">// Return and increment counter property</span></a>
<a class="sourceLine" id="cb56-174" title="174"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-175" title="175"><span class="at">uniqueInteger</span>()<span class="op">;</span> <span class="co">// =&gt; 0</span></a>
<a class="sourceLine" id="cb56-176" title="176"><span class="at">uniqueInteger</span>()<span class="op">;</span> <span class="co">// =&gt; 1</span></a>
<a class="sourceLine" id="cb56-177" title="177"><span class="kw">let</span> uniqueInteger <span class="op">=</span> (<span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb56-178" title="178">  <span class="co">// Define and invoke</span></a>
<a class="sourceLine" id="cb56-179" title="179">  <span class="kw">let</span> counter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// Private state of function below</span></a>
<a class="sourceLine" id="cb56-180" title="180">  <span class="cf">return</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb56-181" title="181">    <span class="cf">return</span> counter<span class="op">++;</span></a>
<a class="sourceLine" id="cb56-182" title="182">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-183" title="183"><span class="op">}</span>)()<span class="op">;</span></a>
<a class="sourceLine" id="cb56-184" title="184"><span class="at">uniqueInteger</span>()<span class="op">;</span> <span class="co">// =&gt; 0</span></a>
<a class="sourceLine" id="cb56-185" title="185"><span class="at">uniqueInteger</span>()<span class="op">;</span> <span class="co">// =&gt; 1</span></a>
<a class="sourceLine" id="cb56-186" title="186"><span class="co">// The canvas.toBlob() function is callback-based.</span></a>
<a class="sourceLine" id="cb56-187" title="187"><span class="co">// This is a Promise-based wrapper for it.</span></a>
<a class="sourceLine" id="cb56-188" title="188"><span class="kw">async</span> <span class="kw">function</span> <span class="at">getCanvasBlob</span>(canvas) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-189" title="189">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-190" title="190">    <span class="va">canvas</span>.<span class="at">toBlob</span>(resolve)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-191" title="191">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-192" title="192"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-193" title="193"></a>
<a class="sourceLine" id="cb56-194" title="194"><span class="co">// Here is how we upload a PNG file from a canvas</span></a>
<a class="sourceLine" id="cb56-195" title="195"><span class="kw">async</span> <span class="kw">function</span> <span class="at">uploadCanvasImage</span>(canvas) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-196" title="196">  <span class="kw">let</span> pngblob <span class="op">=</span> <span class="cf">await</span> <span class="at">getCanvasBlob</span>(canvas)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-197" title="197">  <span class="kw">let</span> formdata <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb56-198" title="198">  <span class="va">formdata</span>.<span class="at">set</span>(<span class="st">&quot;canvasimage&quot;</span><span class="op">,</span> pngblob)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-199" title="199">  <span class="kw">let</span> response <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;/upload&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> formdata <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-200" title="200">  <span class="kw">let</span> body <span class="op">=</span> <span class="cf">await</span> <span class="va">response</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb56-201" title="201"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-202" title="202"><span class="kw">function</span> <span class="at">wait</span>(duration) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-203" title="203">  <span class="co">// Create and return a new Promise</span></a>
<a class="sourceLine" id="cb56-204" title="204">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-205" title="205">    <span class="co">// These control the Promise</span></a>
<a class="sourceLine" id="cb56-206" title="206">    <span class="co">// If the argument is invalid, reject the Promise</span></a>
<a class="sourceLine" id="cb56-207" title="207">    <span class="cf">if</span> (duration <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-208" title="208">      <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Time travel not yet implemented&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb56-209" title="209">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-210" title="210">    <span class="co">// Otherwise, wait asynchronously and then resolve the Promise.</span></a>
<a class="sourceLine" id="cb56-211" title="211">    <span class="co">// setTimeout will invoke resolve() with no arguments, which means</span></a>
<a class="sourceLine" id="cb56-212" title="212">    <span class="co">// that the Promise will fulfill with the undefined value.</span></a>
<a class="sourceLine" id="cb56-213" title="213">    <span class="at">setTimeout</span>(resolve<span class="op">,</span> duration)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-214" title="214">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-215" title="215"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-216" title="216"><span class="co">// Begin by creating an audioContext object. Safari still requires</span></a>
<a class="sourceLine" id="cb56-217" title="217"><span class="co">// us to use webkitAudioContext instead of AudioContext.</span></a>
<a class="sourceLine" id="cb56-218" title="218"><span class="kw">let</span> audioContext <span class="op">=</span> <span class="kw">new</span> (<span class="kw">this</span>.<span class="at">AudioContext</span> <span class="op">||</span> <span class="kw">this</span>.<span class="at">webkitAudioContext</span>)()<span class="op">;</span></a>
<a class="sourceLine" id="cb56-219" title="219"></a>
<a class="sourceLine" id="cb56-220" title="220"><span class="co">// Define the base sound as a combination of three pure sine waves</span></a>
<a class="sourceLine" id="cb56-221" title="221"><span class="kw">let</span> notes <span class="op">=</span> [<span class="fl">293.7</span><span class="op">,</span> <span class="fl">370.0</span><span class="op">,</span> <span class="fl">440.0</span>]<span class="op">;</span> <span class="co">// D major chord: D, F# and A</span></a>
<a class="sourceLine" id="cb56-222" title="222"></a>
<a class="sourceLine" id="cb56-223" title="223"><span class="co">// Create oscillator nodes for each of the notes we want to play</span></a>
<a class="sourceLine" id="cb56-224" title="224"><span class="kw">let</span> oscillators <span class="op">=</span> <span class="va">notes</span>.<span class="at">map</span>((note) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-225" title="225">  <span class="kw">let</span> o <span class="op">=</span> <span class="va">audioContext</span>.<span class="at">createOscillator</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb56-226" title="226">  <span class="va">o</span>.<span class="va">frequency</span>.<span class="at">value</span> <span class="op">=</span> note<span class="op">;</span></a>
<a class="sourceLine" id="cb56-227" title="227">  <span class="cf">return</span> o<span class="op">;</span></a>
<a class="sourceLine" id="cb56-228" title="228"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-229" title="229"></a>
<a class="sourceLine" id="cb56-230" title="230"><span class="co">// Shape the sound by controlling its volume over time.</span></a>
<a class="sourceLine" id="cb56-231" title="231"><span class="co">// Starting at time 0 quickly ramp up to full volume.</span></a>
<a class="sourceLine" id="cb56-232" title="232"><span class="co">// Then starting at time 0.1 slowly ramp down to 0.</span></a>
<a class="sourceLine" id="cb56-233" title="233"><span class="kw">let</span> volumeControl <span class="op">=</span> <span class="va">audioContext</span>.<span class="at">createGain</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb56-234" title="234"><span class="va">volumeControl</span>.<span class="va">gain</span>.<span class="at">setTargetAtTime</span>(<span class="dv">1</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.02</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-235" title="235"><span class="va">volumeControl</span>.<span class="va">gain</span>.<span class="at">setTargetAtTime</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-236" title="236"></a>
<a class="sourceLine" id="cb56-237" title="237"><span class="co">// We&#39;re going to send the sound to the default destination:</span></a>
<a class="sourceLine" id="cb56-238" title="238"><span class="co">// the user&#39;s speakers</span></a>
<a class="sourceLine" id="cb56-239" title="239"><span class="kw">let</span> speakers <span class="op">=</span> <span class="va">audioContext</span>.<span class="at">destination</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-240" title="240"></a>
<a class="sourceLine" id="cb56-241" title="241"><span class="co">// Connect each of the source notes to the volume control</span></a>
<a class="sourceLine" id="cb56-242" title="242"><span class="va">oscillators</span>.<span class="at">forEach</span>((o) <span class="kw">=&gt;</span> <span class="va">o</span>.<span class="at">connect</span>(volumeControl))<span class="op">;</span></a>
<a class="sourceLine" id="cb56-243" title="243"></a>
<a class="sourceLine" id="cb56-244" title="244"><span class="co">// And connect the output of the volume control to the speakers.</span></a>
<a class="sourceLine" id="cb56-245" title="245"><span class="va">volumeControl</span>.<span class="at">connect</span>(speakers)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-246" title="246"></a>
<a class="sourceLine" id="cb56-247" title="247"><span class="co">// Now start playing the sounds and let them run for 1.25 seconds.</span></a>
<a class="sourceLine" id="cb56-248" title="248"><span class="kw">let</span> startTime <span class="op">=</span> <span class="va">audioContext</span>.<span class="at">currentTime</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-249" title="249"><span class="kw">let</span> stopTime <span class="op">=</span> startTime <span class="op">+</span> <span class="fl">1.25</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-250" title="250"><span class="va">oscillators</span>.<span class="at">forEach</span>((o) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-251" title="251">  <span class="va">o</span>.<span class="at">start</span>(startTime)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-252" title="252">  <span class="va">o</span>.<span class="at">stop</span>(stopTime)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-253" title="253"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-254" title="254"></a>
<a class="sourceLine" id="cb56-255" title="255"><span class="co">// If we want to create a sequence of sounds we can use event handlers</span></a>
<a class="sourceLine" id="cb56-256" title="256">oscillators[<span class="dv">0</span>].<span class="at">addEventListener</span>(<span class="st">&quot;ended&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-257" title="257">  <span class="co">// This event handler is invoked when the note stops playing</span></a>
<a class="sourceLine" id="cb56-258" title="258"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-259" title="259"><span class="kw">function</span> <span class="at">words</span>(s) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-260" title="260">  <span class="kw">var</span> r <span class="op">=</span> <span class="ss">/</span><span class="sc">\s+|$</span><span class="ss">/g</span><span class="op">;</span> <span class="co">// Match one or more spaces or end</span></a>
<a class="sourceLine" id="cb56-261" title="261">  <span class="va">r</span>.<span class="at">lastIndex</span> <span class="op">=</span> <span class="va">s</span>.<span class="at">match</span>(<span class="ss">/</span><span class="sc">[^ ]</span><span class="ss">/</span>).<span class="at">index</span><span class="op">;</span> <span class="co">// Start matching at first nonspace</span></a>
<a class="sourceLine" id="cb56-262" title="262">  <span class="cf">return</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-263" title="263">    <span class="co">// Return an iterable iterator object</span></a>
<a class="sourceLine" id="cb56-264" title="264">    [<span class="va">Symbol</span>.<span class="at">iterator</span>]() <span class="op">{</span></a>
<a class="sourceLine" id="cb56-265" title="265">      <span class="co">// This makes us iterable</span></a>
<a class="sourceLine" id="cb56-266" title="266">      <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-267" title="267">    <span class="op">},</span></a>
<a class="sourceLine" id="cb56-268" title="268">    <span class="at">next</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb56-269" title="269">      <span class="co">// This makes us an iterator</span></a>
<a class="sourceLine" id="cb56-270" title="270">      <span class="kw">let</span> start <span class="op">=</span> <span class="va">r</span>.<span class="at">lastIndex</span><span class="op">;</span> <span class="co">// Resume where the last match ended</span></a>
<a class="sourceLine" id="cb56-271" title="271">      <span class="cf">if</span> (start <span class="op">&lt;</span> <span class="va">s</span>.<span class="at">length</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-272" title="272">        <span class="co">// If we&#39;re not done</span></a>
<a class="sourceLine" id="cb56-273" title="273">        <span class="kw">let</span> match <span class="op">=</span> <span class="va">r</span>.<span class="at">exec</span>(s)<span class="op">;</span> <span class="co">// Match the next word boundary</span></a>
<a class="sourceLine" id="cb56-274" title="274">        <span class="cf">if</span> (match) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-275" title="275">          <span class="co">// If we found one, return the word</span></a>
<a class="sourceLine" id="cb56-276" title="276">          <span class="cf">return</span> <span class="op">{</span> <span class="dt">value</span><span class="op">:</span> <span class="va">s</span>.<span class="at">substring</span>(start<span class="op">,</span> <span class="va">match</span>.<span class="at">index</span>) <span class="op">};</span></a>
<a class="sourceLine" id="cb56-277" title="277">        <span class="op">}</span></a>
<a class="sourceLine" id="cb56-278" title="278">      <span class="op">}</span></a>
<a class="sourceLine" id="cb56-279" title="279">      <span class="cf">return</span> <span class="op">{</span> <span class="dt">done</span><span class="op">:</span> <span class="kw">true</span> <span class="op">};</span> <span class="co">// Otherwise, say that we&#39;re done</span></a>
<a class="sourceLine" id="cb56-280" title="280">    <span class="op">},</span></a>
<a class="sourceLine" id="cb56-281" title="281">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-282" title="282"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-283" title="283"></a>
<a class="sourceLine" id="cb56-284" title="284">[...<span class="at">words</span>(<span class="st">&quot; abc def  ghi! &quot;</span>)]<span class="op">;</span> <span class="co">// =&gt; [&quot;abc&quot;, &quot;def&quot;, &quot;ghi!&quot;]</span></a>
<a class="sourceLine" id="cb56-285" title="285"><span class="kw">function</span> <span class="at">write</span>(stream<span class="op">,</span> chunk<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-286" title="286">  <span class="co">// Write the specified chunk to the specified stream</span></a>
<a class="sourceLine" id="cb56-287" title="287">  <span class="kw">let</span> hasMoreRoom <span class="op">=</span> <span class="va">stream</span>.<span class="at">write</span>(chunk)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-288" title="288"></a>
<a class="sourceLine" id="cb56-289" title="289">  <span class="co">// Check the return value of the write() method:</span></a>
<a class="sourceLine" id="cb56-290" title="290">  <span class="cf">if</span> (hasMoreRoom) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-291" title="291">    <span class="co">// If it returned true, then</span></a>
<a class="sourceLine" id="cb56-292" title="292">    <span class="at">setImmediate</span>(callback)<span class="op">;</span> <span class="co">// invoke callback asynchronously.</span></a>
<a class="sourceLine" id="cb56-293" title="293">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-294" title="294">    <span class="co">// If it returned false, then</span></a>
<a class="sourceLine" id="cb56-295" title="295">    <span class="va">stream</span>.<span class="at">once</span>(<span class="st">&quot;drain&quot;</span><span class="op">,</span> callback)<span class="op">;</span> <span class="co">// invoke callback on drain event.</span></a>
<a class="sourceLine" id="cb56-296" title="296">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-297" title="297"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-298" title="298"><span class="co">// Given an array of iterables, yield their elements in interleaved order.</span></a>
<a class="sourceLine" id="cb56-299" title="299"><span class="kw">function</span><span class="op">*</span> <span class="at">zip</span>(...<span class="at">iterables</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-300" title="300">  <span class="co">// Get an iterator for each iterable</span></a>
<a class="sourceLine" id="cb56-301" title="301">  <span class="kw">let</span> iterators <span class="op">=</span> <span class="va">iterables</span>.<span class="at">map</span>((i) <span class="kw">=&gt;</span> i[<span class="va">Symbol</span>.<span class="at">iterator</span>]())<span class="op">;</span></a>
<a class="sourceLine" id="cb56-302" title="302">  <span class="kw">let</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-303" title="303">  <span class="cf">while</span> (<span class="va">iterators</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-304" title="304">    <span class="co">// While there are still some iterators</span></a>
<a class="sourceLine" id="cb56-305" title="305">    <span class="cf">if</span> (index <span class="op">&gt;=</span> <span class="va">iterators</span>.<span class="at">length</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-306" title="306">      <span class="co">// If we reached the last iterator</span></a>
<a class="sourceLine" id="cb56-307" title="307">      index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// go back to the first one.</span></a>
<a class="sourceLine" id="cb56-308" title="308">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-309" title="309">    <span class="kw">let</span> item <span class="op">=</span> iterators[index].<span class="at">next</span>()<span class="op">;</span> <span class="co">// Get next item from next iterator.</span></a>
<a class="sourceLine" id="cb56-310" title="310">    <span class="cf">if</span> (<span class="va">item</span>.<span class="at">done</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-311" title="311">      <span class="co">// If that iterator is done</span></a>
<a class="sourceLine" id="cb56-312" title="312">      <span class="va">iterators</span>.<span class="at">splice</span>(index<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// then remove it from the array.</span></a>
<a class="sourceLine" id="cb56-313" title="313">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-314" title="314">      <span class="co">// Otherwise,</span></a>
<a class="sourceLine" id="cb56-315" title="315">      <span class="kw">yield</span> <span class="va">item</span>.<span class="at">value</span><span class="op">;</span> <span class="co">// yield the iterated value</span></a>
<a class="sourceLine" id="cb56-316" title="316">      index<span class="op">++;</span> <span class="co">// and move on to the next iterator.</span></a>
<a class="sourceLine" id="cb56-317" title="317">    <span class="op">}</span></a>
<a class="sourceLine" id="cb56-318" title="318">  <span class="op">}</span></a>
<a class="sourceLine" id="cb56-319" title="319"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-320" title="320"></a>
<a class="sourceLine" id="cb56-321" title="321"><span class="co">// Interleave three iterable objects</span></a>
<a class="sourceLine" id="cb56-322" title="322">[...<span class="at">zip</span>(<span class="at">oneDigitPrimes</span>()<span class="op">,</span> <span class="st">&quot;ab&quot;</span><span class="op">,</span> [<span class="dv">0</span>])]<span class="op">;</span> <span class="co">// =&gt; [2,&quot;a&quot;,0,3,&quot;b&quot;,5,7]</span></a>
<a class="sourceLine" id="cb56-323" title="323"><span class="co">// This utility function asynchronously obtains the database object (creating</span></a>
<a class="sourceLine" id="cb56-324" title="324"><span class="co">// and initializing the DB if necessary) and passes it to the callback.</span></a>
<a class="sourceLine" id="cb56-325" title="325"><span class="kw">function</span> <span class="at">withDB</span>(callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-326" title="326">  <span class="kw">let</span> request <span class="op">=</span> <span class="va">indexedDB</span>.<span class="at">open</span>(<span class="st">&quot;zipcodes&quot;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Request v1 of the database</span></a>
<a class="sourceLine" id="cb56-327" title="327">  <span class="va">request</span>.<span class="at">onerror</span> <span class="op">=</span> <span class="va">console</span>.<span class="at">error</span><span class="op">;</span> <span class="co">// Log any errors</span></a>
<a class="sourceLine" id="cb56-328" title="328">  <span class="va">request</span>.<span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-329" title="329">    <span class="co">// Or call this when done</span></a>
<a class="sourceLine" id="cb56-330" title="330">    <span class="kw">let</span> db <span class="op">=</span> <span class="va">request</span>.<span class="at">result</span><span class="op">;</span> <span class="co">// The result of the request is the database</span></a>
<a class="sourceLine" id="cb56-331" title="331">    <span class="at">callback</span>(db)<span class="op">;</span> <span class="co">// Invoke the callback with the database</span></a>
<a class="sourceLine" id="cb56-332" title="332">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-333" title="333"></a>
<a class="sourceLine" id="cb56-334" title="334">  <span class="co">// If version 1 of the database does not yet exist, then this event</span></a>
<a class="sourceLine" id="cb56-335" title="335">  <span class="co">// handler will be triggered. This is used to create and initialize</span></a>
<a class="sourceLine" id="cb56-336" title="336">  <span class="co">// object stores and indexes when the DB is first created or to modify</span></a>
<a class="sourceLine" id="cb56-337" title="337">  <span class="co">// them when we switch from one version of the DB schema to another.</span></a>
<a class="sourceLine" id="cb56-338" title="338">  <span class="va">request</span>.<span class="at">onupgradeneeded</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-339" title="339">    <span class="at">initdb</span>(<span class="va">request</span>.<span class="at">result</span><span class="op">,</span> callback)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-340" title="340">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-341" title="341"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-342" title="342"></a>
<a class="sourceLine" id="cb56-343" title="343"><span class="co">// withDB() calls this function if the database has not been initialized yet.</span></a>
<a class="sourceLine" id="cb56-344" title="344"><span class="co">// We set up the database and populate it with data, then pass the database to</span></a>
<a class="sourceLine" id="cb56-345" title="345"><span class="co">// the callback function.</span></a>
<a class="sourceLine" id="cb56-346" title="346"><span class="co">//</span></a>
<a class="sourceLine" id="cb56-347" title="347"><span class="co">// Our zip code database includes one object store that holds objects like this:</span></a>
<a class="sourceLine" id="cb56-348" title="348"><span class="co">//</span></a>
<a class="sourceLine" id="cb56-349" title="349"><span class="co">//   {</span></a>
<a class="sourceLine" id="cb56-350" title="350"><span class="co">//     zipcode: &quot;02134&quot;,</span></a>
<a class="sourceLine" id="cb56-351" title="351"><span class="co">//     city: &quot;Allston&quot;,</span></a>
<a class="sourceLine" id="cb56-352" title="352"><span class="co">//     state: &quot;MA&quot;,</span></a>
<a class="sourceLine" id="cb56-353" title="353"><span class="co">//   }</span></a>
<a class="sourceLine" id="cb56-354" title="354"><span class="co">//</span></a>
<a class="sourceLine" id="cb56-355" title="355"><span class="co">// We use the &quot;zipcode&quot; property as the database key and create an index for</span></a>
<a class="sourceLine" id="cb56-356" title="356"><span class="co">// the city name.</span></a>
<a class="sourceLine" id="cb56-357" title="357"><span class="kw">function</span> <span class="at">initdb</span>(db<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-358" title="358">  <span class="co">// Create the object store, specifying a name for the store and</span></a>
<a class="sourceLine" id="cb56-359" title="359">  <span class="co">// an options object that includes the &quot;key path&quot; specifying the</span></a>
<a class="sourceLine" id="cb56-360" title="360">  <span class="co">// property name of the key field for this store.</span></a>
<a class="sourceLine" id="cb56-361" title="361">  <span class="kw">let</span> store <span class="op">=</span> <span class="va">db</span>.<span class="at">createObjectStore</span>(</a>
<a class="sourceLine" id="cb56-362" title="362">    <span class="st">&quot;zipcodes&quot;</span><span class="op">,</span> <span class="co">// store name</span></a>
<a class="sourceLine" id="cb56-363" title="363">    <span class="op">{</span> <span class="dt">keyPath</span><span class="op">:</span> <span class="st">&quot;zipcode&quot;</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb56-364" title="364">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb56-365" title="365"></a>
<a class="sourceLine" id="cb56-366" title="366">  <span class="co">// Now index the object store by city name as well as by zip code.</span></a>
<a class="sourceLine" id="cb56-367" title="367">  <span class="co">// With this method the key path string is passed directly as a</span></a>
<a class="sourceLine" id="cb56-368" title="368">  <span class="co">// required argument rather than as part of an options object.</span></a>
<a class="sourceLine" id="cb56-369" title="369">  <span class="va">store</span>.<span class="at">createIndex</span>(<span class="st">&quot;cities&quot;</span><span class="op">,</span> <span class="st">&quot;city&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-370" title="370"></a>
<a class="sourceLine" id="cb56-371" title="371">  <span class="co">// Now get the data we are going to initialize the database with.</span></a>
<a class="sourceLine" id="cb56-372" title="372">  <span class="co">// The zipcodes.json data file was generated from CC-licensed data from</span></a>
<a class="sourceLine" id="cb56-373" title="373">  <span class="co">// www.geonames.org: https://download.geonames.org/export/zip/US.zip</span></a>
<a class="sourceLine" id="cb56-374" title="374">  <span class="at">fetch</span>(<span class="st">&quot;zipcodes.json&quot;</span>) <span class="co">// Make an HTTP GET request</span></a>
<a class="sourceLine" id="cb56-375" title="375">    .<span class="at">then</span>((response) <span class="kw">=&gt;</span> <span class="va">response</span>.<span class="at">json</span>()) <span class="co">// Parse the body as JSON</span></a>
<a class="sourceLine" id="cb56-376" title="376">    .<span class="at">then</span>((zipcodes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-377" title="377">      <span class="co">// Get 40K zip code records</span></a>
<a class="sourceLine" id="cb56-378" title="378">      <span class="co">// In order to insert zip code data into the database we need a</span></a>
<a class="sourceLine" id="cb56-379" title="379">      <span class="co">// transaction object. To create our transaction object, we need</span></a>
<a class="sourceLine" id="cb56-380" title="380">      <span class="co">// to specify which object stores we&#39;ll be using (we only have</span></a>
<a class="sourceLine" id="cb56-381" title="381">      <span class="co">// one) and we need to tell it that we&#39;ll be doing writes to the</span></a>
<a class="sourceLine" id="cb56-382" title="382">      <span class="co">// database, not just reads:</span></a>
<a class="sourceLine" id="cb56-383" title="383">      <span class="kw">let</span> transaction <span class="op">=</span> <span class="va">db</span>.<span class="at">transaction</span>([<span class="st">&quot;zipcodes&quot;</span>]<span class="op">,</span> <span class="st">&quot;readwrite&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-384" title="384">      <span class="va">transaction</span>.<span class="at">onerror</span> <span class="op">=</span> <span class="va">console</span>.<span class="at">error</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-385" title="385"></a>
<a class="sourceLine" id="cb56-386" title="386">      <span class="co">// Get our object store from the transaction</span></a>
<a class="sourceLine" id="cb56-387" title="387">      <span class="kw">let</span> store <span class="op">=</span> <span class="va">transaction</span>.<span class="at">objectStore</span>(<span class="st">&quot;zipcodes&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-388" title="388"></a>
<a class="sourceLine" id="cb56-389" title="389">      <span class="co">// The best part about the IndexedDB API is that object stores</span></a>
<a class="sourceLine" id="cb56-390" title="390">      <span class="co">// are *really* simple. Here&#39;s how we add (or update) our records:</span></a>
<a class="sourceLine" id="cb56-391" title="391">      <span class="cf">for</span> (<span class="kw">let</span> record <span class="kw">of</span> zipcodes) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-392" title="392">        <span class="va">store</span>.<span class="at">put</span>(record)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-393" title="393">      <span class="op">}</span></a>
<a class="sourceLine" id="cb56-394" title="394"></a>
<a class="sourceLine" id="cb56-395" title="395">      <span class="co">// When the transaction completes successfully, the database</span></a>
<a class="sourceLine" id="cb56-396" title="396">      <span class="co">// is initialized and ready for use, so we can call the</span></a>
<a class="sourceLine" id="cb56-397" title="397">      <span class="co">// callback function that was originally passed to withDB()</span></a>
<a class="sourceLine" id="cb56-398" title="398">      <span class="va">transaction</span>.<span class="at">oncomplete</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-399" title="399">        <span class="at">callback</span>(db)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-400" title="400">      <span class="op">};</span></a>
<a class="sourceLine" id="cb56-401" title="401">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-402" title="402"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-403" title="403"></a>
<a class="sourceLine" id="cb56-404" title="404"><span class="co">// Given a zip code, use the IndexedDB API to asynchronously look up the city</span></a>
<a class="sourceLine" id="cb56-405" title="405"><span class="co">// with that zip code, and pass it to the specified callback, or pass null if</span></a>
<a class="sourceLine" id="cb56-406" title="406"><span class="co">// no city is found.</span></a>
<a class="sourceLine" id="cb56-407" title="407"><span class="im">export</span> <span class="kw">function</span> <span class="at">lookupCity</span>(zip<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-408" title="408">  <span class="at">withDB</span>((db) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-409" title="409">    <span class="co">// Create a read-only transaction object for this query. The</span></a>
<a class="sourceLine" id="cb56-410" title="410">    <span class="co">// argument is an array of object stores we will need to use.</span></a>
<a class="sourceLine" id="cb56-411" title="411">    <span class="kw">let</span> transaction <span class="op">=</span> <span class="va">db</span>.<span class="at">transaction</span>([<span class="st">&quot;zipcodes&quot;</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb56-412" title="412"></a>
<a class="sourceLine" id="cb56-413" title="413">    <span class="co">// Get the object store from the transaction</span></a>
<a class="sourceLine" id="cb56-414" title="414">    <span class="kw">let</span> zipcodes <span class="op">=</span> <span class="va">transaction</span>.<span class="at">objectStore</span>(<span class="st">&quot;zipcodes&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-415" title="415"></a>
<a class="sourceLine" id="cb56-416" title="416">    <span class="co">// Now request the object that matches the specified zipcode key.</span></a>
<a class="sourceLine" id="cb56-417" title="417">    <span class="co">// The lines above were synchronous, but this one is async.</span></a>
<a class="sourceLine" id="cb56-418" title="418">    <span class="kw">let</span> request <span class="op">=</span> <span class="va">zipcodes</span>.<span class="at">get</span>(zip)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-419" title="419">    <span class="va">request</span>.<span class="at">onerror</span> <span class="op">=</span> <span class="va">console</span>.<span class="at">error</span><span class="op">;</span> <span class="co">// Log errors</span></a>
<a class="sourceLine" id="cb56-420" title="420">    <span class="va">request</span>.<span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-421" title="421">      <span class="co">// Or call this function on success</span></a>
<a class="sourceLine" id="cb56-422" title="422">      <span class="kw">let</span> record <span class="op">=</span> <span class="va">request</span>.<span class="at">result</span><span class="op">;</span> <span class="co">// This is the query result</span></a>
<a class="sourceLine" id="cb56-423" title="423">      <span class="cf">if</span> (record) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-424" title="424">        <span class="co">// If we found a match, pass it to the callback</span></a>
<a class="sourceLine" id="cb56-425" title="425">        <span class="at">callback</span>(<span class="vs">`</span><span class="sc">${</span><span class="va">record</span>.<span class="at">city</span><span class="sc">}</span><span class="vs">, </span><span class="sc">${</span><span class="va">record</span>.<span class="at">state</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-426" title="426">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-427" title="427">        <span class="co">// Otherwise, tell the callback that we failed</span></a>
<a class="sourceLine" id="cb56-428" title="428">        <span class="at">callback</span>(<span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-429" title="429">      <span class="op">}</span></a>
<a class="sourceLine" id="cb56-430" title="430">    <span class="op">};</span></a>
<a class="sourceLine" id="cb56-431" title="431">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-432" title="432"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-433" title="433"></a>
<a class="sourceLine" id="cb56-434" title="434"><span class="co">// Given the name of a city, use the IndexedDB API to asynchronously</span></a>
<a class="sourceLine" id="cb56-435" title="435"><span class="co">// look up all zip code records for all cities (in any state) that have</span></a>
<a class="sourceLine" id="cb56-436" title="436"><span class="co">// that (case-sensitive) name.</span></a>
<a class="sourceLine" id="cb56-437" title="437"><span class="im">export</span> <span class="kw">function</span> <span class="at">lookupZipcodes</span>(city<span class="op">,</span> callback) <span class="op">{</span></a>
<a class="sourceLine" id="cb56-438" title="438">  <span class="at">withDB</span>((db) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-439" title="439">    <span class="co">// As above, we create a transaction and get the object store</span></a>
<a class="sourceLine" id="cb56-440" title="440">    <span class="kw">let</span> transaction <span class="op">=</span> <span class="va">db</span>.<span class="at">transaction</span>([<span class="st">&quot;zipcodes&quot;</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb56-441" title="441">    <span class="kw">let</span> store <span class="op">=</span> <span class="va">transaction</span>.<span class="at">objectStore</span>(<span class="st">&quot;zipcodes&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-442" title="442"></a>
<a class="sourceLine" id="cb56-443" title="443">    <span class="co">// This time we also get the city index of the object store</span></a>
<a class="sourceLine" id="cb56-444" title="444">    <span class="kw">let</span> index <span class="op">=</span> <span class="va">store</span>.<span class="at">index</span>(<span class="st">&quot;cities&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-445" title="445"></a>
<a class="sourceLine" id="cb56-446" title="446">    <span class="co">// Ask for all matching records in the index with the specified</span></a>
<a class="sourceLine" id="cb56-447" title="447">    <span class="co">// city name, and when we get them we pass them to the callback.</span></a>
<a class="sourceLine" id="cb56-448" title="448">    <span class="co">// If we expected more results, we might use openCursor() instead.</span></a>
<a class="sourceLine" id="cb56-449" title="449">    <span class="kw">let</span> request <span class="op">=</span> <span class="va">index</span>.<span class="at">getAll</span>(city)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-450" title="450">    <span class="va">request</span>.<span class="at">onerror</span> <span class="op">=</span> <span class="va">console</span>.<span class="at">error</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-451" title="451">    <span class="va">request</span>.<span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-452" title="452">      <span class="at">callback</span>(<span class="va">request</span>.<span class="at">result</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-453" title="453">    <span class="op">};</span></a>
<a class="sourceLine" id="cb56-454" title="454">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-455" title="455"><span class="op">}</span></a>
<a class="sourceLine" id="cb56-456" title="456"><span class="im">import</span> <span class="op">{</span> lookupCity<span class="op">,</span> lookupZipcodes <span class="op">}</span> <span class="im">from</span> <span class="st">&quot;./zipcodeDatabase.js&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-457" title="457"></a>
<a class="sourceLine" id="cb56-458" title="458"><span class="va">window</span>.<span class="at">addEventListener</span>(<span class="st">&quot;load&quot;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-459" title="459">  <span class="kw">let</span> zipcodeInput <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#zipcodeInput&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-460" title="460">  <span class="kw">let</span> cityOutput <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#cityOutput&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-461" title="461">  <span class="va">zipcodeInput</span>.<span class="at">onchange</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-462" title="462">    <span class="at">lookupCity</span>(<span class="va">zipcodeInput</span>.<span class="at">value</span><span class="op">,</span> (city) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-463" title="463">      <span class="va">cityOutput</span>.<span class="at">value</span> <span class="op">=</span> city <span class="op">||</span> <span class="st">&quot;Unknown zip code&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-464" title="464">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-465" title="465">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-466" title="466"></a>
<a class="sourceLine" id="cb56-467" title="467">  <span class="kw">let</span> cityInput <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#cityInput&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-468" title="468">  <span class="kw">let</span> zipcodesOutput <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#zipcodesOutput&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-469" title="469">  <span class="va">cityInput</span>.<span class="at">onchange</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-470" title="470">    <span class="va">zipcodesOutput</span>.<span class="at">textContent</span> <span class="op">=</span> <span class="st">&quot;Matching zipcodes:&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb56-471" title="471">    <span class="at">lookupZipcodes</span>(<span class="va">cityInput</span>.<span class="at">value</span><span class="op">,</span> (zipcodes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-472" title="472">      <span class="va">zipcodes</span>.<span class="at">forEach</span>((zip) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-473" title="473">        <span class="kw">let</span> item <span class="op">=</span> <span class="va">document</span>.<span class="at">createElement</span>(<span class="st">&quot;li&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-474" title="474">        <span class="va">item</span>.<span class="at">append</span>(<span class="vs">`</span><span class="sc">${</span><span class="va">zip</span>.<span class="at">zipcode</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span><span class="va">zip</span>.<span class="at">city</span><span class="sc">}</span><span class="vs">, </span><span class="sc">${</span><span class="va">zip</span>.<span class="at">state</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-475" title="475">        <span class="va">zipcodesOutput</span>.<span class="at">append</span>(item)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-476" title="476">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-477" title="477">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-478" title="478">  <span class="op">};</span></a>
<a class="sourceLine" id="cb56-479" title="479"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
</body>
</html>
