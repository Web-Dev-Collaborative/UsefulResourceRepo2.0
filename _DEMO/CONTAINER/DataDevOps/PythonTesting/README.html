<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>README</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
  </head>
  <body>
    <h1 id="data-platform-devops---testing">Data Platform DevOps - Testing</h1>
    <p><strong>Produced by Dave Lusty and Cindy Weng</strong></p>
    <h2 id="introduction">Introduction</h2>
    <p>
      This demo shows how to use DevOps pipelines to run automated testing in
      Azure DevOps with Python testing carried out using PyTest. The video is
      <a href="https://youtu.be/R7tJZelEt-Q">not available yet</a>
    </p>
    <p>There are multiple tasks associated with this demo:</p>
    <ul>
      <li>Create the test project in Python</li>
      <li>Write individual tests around your testing scenarios</li>
      <li>Set up the tests in Azure DevOps</li>
      <li>Import the test results to the pipeline</li>
    </ul>
    <h2 id="create-python-test-file">Create Python Test File</h2>
    <p>
      The below code gives a very basic introduction to PyTest. For full
      documentation see
      <a href="https://docs.pytest.org/en/latest/index.html">this page</a> which
      will include information on the various test methods available. For each
      Python module you create, you should also create unit tests to ensure it
      produces the expected results. It is generally wise to write your tests
      before writing your code. As an example, if you created a function to add
      two numbers you may want a test that calls the function with values of 2
      and 3 and expects a response of 5. When working with a data lake you’ll
      need a host of tests including testing outliers to ensure data formats are
      working as expected. If you’re testing dates, use tests in the morning and
      afternoon, before and after noon and midnight, and whole hours as well as
      precise times. Map out your expected results first, write the tests and
      then create test data to match and run against.
    </p>
    <p>
      The code below has been designed to produce one pass and two failures, and
      matches the C# code in the
      <a
        href="https://github.com/davedoesdemos/DataDevOps/tree/master/TestingIntro"
        >testing intro demo</a
      >.
    </p>
    <p>
      Test 1 will test whether 3 is equal to 2 with an accuracy of 1 - this will
      pass. Test 2 will test whether 3 is equal to 6 with an accuracy of 1 -
      this will fail. Test 3 will test whether 3 is equal to 2 with no margin
      for error - this will fail.
    </p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode python"
      ><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> pytest</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="im">from</span> pytest <span class="im">import</span> approx</a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">def</span> test_method1():</a>
<a class="sourceLine" id="cb1-5" title="5">    x<span class="op">=</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb1-6" title="6">    y<span class="op">=</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="cf">assert</span> x <span class="op">==</span> approx(y, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">def</span> test_method2():</a>
<a class="sourceLine" id="cb1-10" title="10">    x<span class="op">=</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb1-11" title="11">    y<span class="op">=</span><span class="dv">6</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="cf">assert</span> x <span class="op">==</span> approx(y, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw">def</span> test_method3():</a>
<a class="sourceLine" id="cb1-15" title="15">    x<span class="op">=</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb1-16" title="16">    y<span class="op">=</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="cf">assert</span> x <span class="op">==</span> y</a></code></pre>
    </div>
    <p>
      You can add any code you like within the tests to connect to data sources,
      filesystems or any other programatic testing you can think of. For unit
      testing this will usually be your own libraries while integration testing
      will test the wider environment.
    </p>
    <p>
      Save the above code into a file named tests.py in your Git repository.
      This is where Azure DevOps will get the file from when you commit it and
      run a build against the repository.
    </p>
    <h2 id="create-batch-file">Create Batch File</h2>
    <p>
      Create a batch file in your repository called runtests.bat. This file will
      install PyTest and then run the tests. Replace
      <code>&lt;your path to tests&gt;</code> with the path in your repository
      to the test files.
    </p>
    <pre><code>pip install pytest
pytest &lt;your path to tests&gt;\tests.py --junitxml=&lt;your path to tests&gt;\results.xml</code></pre>
    <h2 id="running-the-tests">Running the Tests</h2>
    <h3 id="running-the-tests-locally">Running the tests locally</h3>
    <p>
      When writing code, you should test it locally before commiting to the
      repository. To do this, install PyTest and run the test as follows from
      the command line:
    </p>
    <pre><code>pip install pytest
pytest tests.py</code></pre>
    <p>
      This will install the PyTest module and then use it to run the tests in
      the tests.py file. You will see the results directly on your screen. When
      unit testing you would then correct any errors in your code and run the
      tests again.
    </p>
    <h3 id="running-the-tests-in-azure-devops">
      Running the tests in Azure DevOps
    </h3>
    <p>
      To run the tests in Azure DevOps, create a project and pipeline as in the
      <a
        href="https://github.com/davedoesdemos/DataDevOps/tree/master/TestingIntro"
        >testing intro demo</a
      >. This time we will add in a Batch Script task and a Publish Test Results
      task. For this demo I used a Windows agent for Azure DevOps, but a Linux
      agent would work in the same way using a shell script.
    </p>
    <p>
      Configure the batch task to run your runtests.bat file, which you can
      browse to using the browse button on the task. Also expand the “Control
      Options” section and choose “Continue on Error” for this task. When a test
      fails the batch file outputs a failure code but we want to carry on and
      publish the results to the build rather than fail completely.
    </p>
    <figure>
      <img src="images/batch.png" alt="batch.png" />
      <figcaption>batch.png</figcaption>
    </figure>
    <p>
      Configure the publish task to publish the results.xml file. This will end
      up in the same location as your batch file and tests.py file when the
      tests run. This task will copy the results into the build so you can view
      the results easily and see what changed through integration with Git and
      Boards in the DevOps portal.
    </p>
    <figure>
      <img src="images/publishTestResults.png" alt="publishTestResults.png" />
      <figcaption>publishTestResults.png</figcaption>
    </figure>
    <p>Save and queue the job in DevOps to see the tests run.</p>
    <h2 id="view-the-results">View the Results</h2>
    <p>In your build output, click the tests tab.</p>
    <figure>
      <img src="images/testsTab.png" alt="testsTab.png" />
      <figcaption>testsTab.png</figcaption>
    </figure>
    <p>
      Here you’ll see the output of the tests and which ones have failed. You
      should see one pass and two failures based on the (fixed) tests we
      performed. Your own testing will be more dynamic than this.
    </p>
    <figure>
      <img src="images/testOutput.png" alt="testOutput.png" />
      <figcaption>testOutput.png</figcaption>
    </figure>
  </body>
</html>
