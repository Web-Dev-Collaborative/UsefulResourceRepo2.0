<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="AWSDocsDocPageApp">
   
<!-- Mirrored from docs.aws.amazon.com/lambda/latest/dg/with-kinesis.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 21 Feb 2021 15:02:04 GMT -->
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Using AWS Lambda with Amazon Kinesis - AWS Lambda</title>
      <meta name="viewport" content="width=device-width,initial-scale=1" />
      <meta name="assets_root" content="/assets" />
      <meta name="target_state" content="with-kinesis" />
      <meta name="default_state" content="with-kinesis" />
      <link rel="icon" type="image/ico" href="https://docs.aws.amazon.com/assets/images/favicon.ico" />
      <link rel="shortcut icon" type="image/ico" href="https://docs.aws.amazon.com/assets/images/favicon.ico" />
      <link rel="canonical" href="with-kinesis.html" />
      <meta name="description" content="How to set up and start using the AWS Lambda service." />
      <meta name="deployment_region" content="IAD" />
      <meta name="product" content="AWS Lambda" />
      <meta name="guide" content="Developer Guide" />
      <meta name="locales" content="de_de:Deutsch/en_us:English/es_es:Español/fr_fr:Français/it_it:Italiano/ja_jp:日本語/ko_kr:한국어/pt_br:Português/zh_cn:中文 (简体)/zh_tw:中文 (繁體)" />
      <meta name="abstract" content="" />
      <meta name="guide-locale" content="en_us" />
      <meta name="tocs" content="toc-contents.json" />
      <meta name="feedback-item" content="Lambda" />
      <meta name="this_doc_product" content="AWS Lambda" />
      <meta name="this_doc_guide" content="Developer Guide" />
      <link href="https://docs.aws.amazon.com/assets/css/vendor4.css?version=2020.09.30" rel="stylesheet" />
      <link href="https://docs.aws.amazon.com/assets/css/awsdocs-common.css?version=2020.09.30" rel="stylesheet" /><script type="text/javascript" src="https://docs.aws.amazon.com/assets/js/vendor3.js?version=2020.09.30" defer=""></script><script type="text/javascript" src="https://docs.aws.amazon.com/assets/js/vendor4.js?version=2020.09.30" defer=""></script><script type="text/javascript" src="https://docs.aws.amazon.com/assets/js/vendor1.js?version=2020.09.30" defer=""></script><script type="text/javascript" src="https://docs.aws.amazon.com/assets/js/awsdocs-common.js?version=2020.09.30" defer=""></script><script type="text/javascript" src="https://docs.aws.amazon.com/assets/js/awsdocs-doc-app.js?version=2020.09.30" defer=""></script></head>
   <body class="awsdocs awsui">
      <div class="awsdocs-container">
         <awsdocs-header></awsdocs-header>
         <awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)">
            <div id="guide-toc" dom-region="navigation">
               <awsdocs-toc></awsdocs-toc>
            </div>
            <div id="main-column" dom-region="content" tabindex="-1">
               <awsdocs-view class="awsdocs-view">
                  <div id="awsdocs-content">
                     <head>
                        <title>Using AWS Lambda with Amazon Kinesis - AWS Lambda</title>
                        <meta name="pdf" content="lambda-dg.pdf#with-kinesis" />
                        <meta name="kindle" content="https://www.amazon.com/dp/B07GFJLN6D" />
                        <meta name="github" content="https://github.com/awsdocs/aws-lambda-developer-guide/tree/main/doc_source/with-kinesis.md" />
                        <meta name="rss" content="lambda-updates.rss" />
                        <meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=186" />
                        <meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kinesis.html" />
                        <meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kinesis.html" />
                        <meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kinesis.html" />
                        <meta name="keywords" content="Lambda,AWS Lambda,serverless,serverless applications,cloud computing" />
                     </head>
                     <body>
                        <div id="main">
                           <div style="display: none"><a href="lambda-dg.pdf#with-kinesis" target="_blank" title="Open PDF"></a><a target="_blank" href="https://www.amazon.com/dp/B07GFJLN6D" title="Open Kindle"></a><a href="https://github.com/awsdocs/aws-lambda-developer-guide/tree/main/doc_source/with-kinesis.md" target="_blank" title="Edit this page on GitHub"></a></div>
                           <div id="breadcrumbs" class="breadcrumb"><a href="http://aws.amazon.com/">AWS</a><a href="https://docs.aws.amazon.com/index.html">Documentation</a><a href="https://docs.aws.amazon.com/lambda/index.html">AWS Lambda</a><a href="welcome.html">Developer Guide</a></div>
                           <div id="page-toc-src"><a href="#services-kinesis-configure">Configuring your data stream and function</a><a href="#events-kinesis-permissions">Execution role permissions</a><a href="#services-kinesis-eventsourcemapping">Configuring a stream as an event source</a><a href="#services-kinesis-api">Event source mapping API</a><a href="#services-kinesis-errors">Error handling</a><a href="#events-kinesis-metrics">Amazon CloudWatch metrics</a><a href="#services-kinesis-windows">Time windows</a><a href="#services-kinesis-batchfailurereporting">Reporting batch item failures</a></div>
                           <div id="main-content" class="awsui-util-container">
                              <div id="main-col-body">
                                 <awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner>
                                 <h1 class="topictitle" id="with-kinesis">Using AWS Lambda with Amazon Kinesis</h1>
                                 <div class="awsdocs-page-header-container">
                                    <awsdocs-page-header></awsdocs-page-header>
                                    <awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector>
                                 </div>
                                 <p>You can use an AWS Lambda function to process records in an <a href="https://docs.aws.amazon.com/kinesis/latest/dev/amazon-kinesis-streams.html">Amazon Kinesis data stream</a>. 
                                 </p>
                                 <p>A Kinesis data stream is a set of <a href="https://docs.aws.amazon.com/streams/latest/dev/key-concepts.html#shard">shards</a>. Each shard contains a
                                    sequence of data records. A <b>consumer</b> is an application that processes the data from
                                    a Kinesis data stream. You can map a Lambda function to a shared-throughput consumer
                                    (standard iterator), or to a
                                    dedicated-throughput consumer with <a href="https://docs.aws.amazon.com/kinesis/latest/dev/enhanced-consumers.html">enhanced fan-out</a>. 
                                 </p>
                                 <p>For standard iterators, Lambda polls each shard in your Kinesis stream for records
                                    using HTTP protocol. The
                                    event source mapping shares read throughput with other consumers of the shard. 
                                 </p>
                                 <p>To minimize latency and maximize read throughput, you can create a data stream consumer
                                    with enhanced fan-out.
                                    Stream consumers get a dedicated connection to each shard that doesn't impact other
                                    applications reading from the
                                    stream. The dedicated throughput can help if you have many applications reading the
                                    same data, or if you're
                                    reprocessing a stream with large records. Kinesis pushes records to Lambda over HTTP/2.
                                    
                                 </p>
                                 <p> For details about Kinesis data streams, see <a href="https://docs.aws.amazon.com/kinesis/latest/dev/building-consumers.html">Reading Data from
                                       Amazon Kinesis Data Streams</a>. 
                                 </p>
                                 <p>Lambda reads records from the data stream and invokes your function <a href="invocation-sync.html">synchronously</a> with an event that contains stream records. Lambda reads records in batches and invokes
                                    your
                                    function to process records from the batch.
                                 </p>
                                 <div class="example">
                                    <p class="title"><b>Example Kinesis record event</b></p>
                                    <div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "Records": [
        <span>{</span>
            "kinesis": <span>{</span>
                "kinesisSchemaVersion": "1.0",
                "partitionKey": "1",
                "sequenceNumber": "49590338271490256608559692538361571095921575989136588898",
                "data": "SGVsbG8sIHRoaXMgaXMgYSB0ZXN0Lg==",
                "approximateArrivalTimestamp": 1545084650.987
            },
            "eventSource": "aws:kinesis",
            "eventVersion": "1.0",
            "eventID": "shardId-000000000006:49590338271490256608559692538361571095921575989136588898",
            "eventName": "aws:kinesis:record",
            "invokeIdentityArn": "arn:aws:iam::123456789012:role/lambda-role",
            "awsRegion": "us-east-2",
            "eventSourceARN": "arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream"
        },
        <span>{</span>
            "kinesis": <span>{</span>
                "kinesisSchemaVersion": "1.0",
                "partitionKey": "1",
                "sequenceNumber": "49590338271490256608559692540925702759324208523137515618",
                "data": "VGhpcyBpcyBvbmx5IGEgdGVzdC4=",
                "approximateArrivalTimestamp": 1545084711.166
            },
            "eventSource": "aws:kinesis",
            "eventVersion": "1.0",
            "eventID": "shardId-000000000006:49590338271490256608559692540925702759324208523137515618",
            "eventName": "aws:kinesis:record",
            "invokeIdentityArn": "arn:aws:iam::123456789012:role/lambda-role",
            "awsRegion": "us-east-2",
            "eventSourceARN": "arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream"
        }
    ]
}</code></pre></div>
                                 </div>
                                 <p>By default, Lambda invokes your function as soon as records are available in the stream.
                                    If the batch
                                    that Lambda reads from the stream only has one record in it, Lambda sends only one
                                    record to the function. To avoid invoking the function
                                    with a small number of records, you can tell the event source to buffer records for
                                    up to five minutes by configuring a
                                    <em>batch window</em>. Before invoking the function, Lambda continues to read records from the stream
                                    until it has gathered a full batch, or until the batch window expires.
                                 </p>
                                 <p>If your function returns an error, Lambda retries the batch until processing succeeds
                                    or the data expires. To
                                    avoid stalled shards, you can configure the event source mapping to retry with a smaller
                                    batch size, limit the
                                    number of retries, or discard records that are too old. To retain discarded events,
                                    you can configure the event
                                    source mapping to send details about failed batches to an SQS queue or SNS topic.
                                 </p>
                                 <p>You can also increase concurrency by processing multiple batches from each shard in
                                    parallel. Lambda can process
                                    up to 10 batches in each shard simultaneously. If you increase the number of concurrent
                                    batches per shard, Lambda still ensures
                                    in-order processing at the partition-key level.
                                 </p>
                                 <p>Configure the <code class="code">ParallelizationFactor</code> setting to process one shard of a Kinesis or DynamoDB data stream with more than
                                    one Lambda invocation simultaneously. You can specify the number of concurrent batches
                                    that Lambda polls from a shard via a parallelization factor from 1 (default) to 10.
                                    For example, when <code class="code">ParallelizationFactor</code> is set to 2, you can have 200 concurrent Lambda invocations at maximum to process
                                    100 Kinesis data shards. This helps scale up the processing throughput when the data
                                    volume is volatile and the <code class="code">IteratorAge</code> is high. For more information, see <a href="http://aws.amazon.com/blogs/compute/new-aws-lambda-scaling-controls-for-kinesis-and-dynamodb-event-sources/" rel="noopener noreferrer" target="_blank"><span>New AWS Lambda scaling controls for Kinesis and DynamoDB event sources</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                 </p>
                                 <div class="highlights">
                                    <p><strong>Sections</strong></p>
                                    <ul>
                                       <li><a href="#services-kinesis-configure">Configuring your data stream and function</a></li>
                                       <li><a href="#events-kinesis-permissions">Execution role permissions</a></li>
                                       <li><a href="#services-kinesis-eventsourcemapping">Configuring a stream as an event source</a></li>
                                       <li><a href="#services-kinesis-api">Event source mapping API</a></li>
                                       <li><a href="#services-kinesis-errors">Error handling</a></li>
                                       <li><a href="#events-kinesis-metrics">Amazon CloudWatch metrics</a></li>
                                       <li><a href="#services-kinesis-windows">Time windows</a></li>
                                       <li><a href="#services-kinesis-batchfailurereporting">Reporting batch item failures</a></li>
                                       <li><a href="with-kinesis-example.html">Tutorial: Using AWS Lambda with Amazon Kinesis</a></li>
                                       <li><a href="with-kinesis-create-package.html">Sample function code</a></li>
                                       <li><a href="with-kinesis-example-use-app-spec.html">AWS SAM template for a Kinesis application</a></li>
                                    </ul>
                                 </div>
                                 
                                 <h2 id="services-kinesis-configure">Configuring your data stream and function</h2>
                                 
                                 
                                 <p>Your Lambda function is a consumer application for your data stream. It processes
                                    one batch of records at a
                                    time from each shard. You can map a Lambda function to a data stream (standard iterator),
                                    or to a consumer of a
                                    stream (<a href="https://docs.aws.amazon.com/kinesis/latest/dev/enhanced-consumers.html">enhanced fan-out</a>).
                                 </p>
                                 
                                 
                                 <p>For standard iterators, Lambda polls each shard in your Kinesis stream for records
                                    at a base rate of once per
                                    second. When more records are available, Lambda keeps processing batches until the
                                    function catches up with the
                                    stream. The event source mapping shares read throughput with other consumers of the
                                    shard.
                                 </p>
                                 
                                 
                                 <p>To minimize latency and maximize read throughput, create a data stream consumer with
                                    enhanced fan-out.
                                    Enhanced fan-out consumers get a dedicated connection to each shard that doesn't impact
                                    other applications reading
                                    from the stream. Stream consumers use HTTP/2 to reduce latency by pushing records
                                    to Lambda over a long-lived
                                    connection and by compressing request headers. You can create a stream consumer with
                                    the Kinesis <a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_RegisterStreamConsumer.html">RegisterStreamConsumer</a> API.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws kinesis register-stream-consumer --consumer-name con1 \
--stream-arn arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream</code></code></pre>
                                 <p>You should see the following output:</p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "Consumer": <span>{</span>
        "ConsumerName": "con1",
        "ConsumerARN": "arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream/consumer/con1:1540591608",
        "ConsumerStatus": "CREATING",
        "ConsumerCreationTimestamp": 1540591608.0
    }
}</code></pre>
                                 
                                 <p>To increase the speed at which your function processes records, add shards to your
                                    data stream. Lambda
                                    processes records in each shard in order. It stops processing additional records in
                                    a shard if your function
                                    returns an error. With more shards, there are more batches being processed at once,
                                    which lowers the impact of
                                    errors on concurrency.
                                 </p>
                                 
                                 <p>If your function can't scale up to handle the total number of concurrent batches,
                                    <a href="gettingstarted-limits.html">request a quota increase</a> or <a href="configuration-concurrency.html">reserve concurrency</a> for your function.
                                 </p>
                                  
                                 
                                 <h2 id="events-kinesis-permissions">Execution role permissions</h2>
                                 
                                 <p>Lambda needs the following permissions to manage resources that are related to your
                                    Kinesis data stream. Add them
                                    to your function's <a href="lambda-intro-execution-role.html">execution role</a>.
                                 </p>
                                 
                                 <div class="itemizedlist">
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          
                                          <p><a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_DescribeStream.html">kinesis:DescribeStream</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_DescribeStreamSummary.html">kinesis:DescribeStreamSummary</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_GetRecords.html">kinesis:GetRecords</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_GetShardIterator.html">kinesis:GetShardIterator</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_ListShards.html">kinesis:ListShards</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_ListStreams.html">kinesis:ListStreams</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="https://docs.aws.amazon.com/kinesis/latest/APIReference/API_SubscribeToShard.html">kinesis:SubscribeToShard</a></p>
                                          
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 <p>The <code class="code">AWSLambdaKinesisExecutionRole</code> managed policy includes these permissions. For more
                                    information, see <a href="lambda-intro-execution-role.html">AWS Lambda execution role</a>.
                                 </p>
                                  
                                 <p>To send records of failed batches to a queue or topic, your function needs
                                    additional permissions. Each destination service requires a different permission,
                                    as follows:
                                 </p>
                                 
                                 <div class="itemizedlist">
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          <p><b>Amazon SQS</b> – <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_SendMessage.html">sqs:SendMessage</a></p>
                                       </li>
                                       <li class="listitem">
                                          <p><b>Amazon SNS</b> – <a href="https://docs.aws.amazon.com/sns/latest/api/API_Publish.html">sns:Publish</a></p>
                                       </li>
                                    </ul>
                                 </div>
                                 
                                  
                                 
                                 <h2 id="services-kinesis-eventsourcemapping">Configuring a stream as an event source</h2>
                                 
                                 
                                 <p>Create an event source mapping to tell Lambda to send records from your data stream
                                    to a Lambda function. You
                                    can create multiple event source mappings to process the same data with multiple Lambda
                                    functions, or to process
                                    items from multiple data streams with a single function.
                                 </p>
                                 
                                 <p>To configure your function to read from Kinesis in the Lambda console, create a <b>Kinesis</b>
                                    trigger.
                                 </p>
                                  
                                 <div class="procedure">
                                    <p class="title"><b>To create a trigger</b></p>
                                    <ol>
                                       <li>
                                          <p>Open the <a href="https://console.aws.amazon.com/lambda/home#/functions" rel="noopener noreferrer" target="_blank"><span>Functions page</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the Lambda console.
                                          </p>
                                       </li>
                                       <li>
                                          
                                          <p>Choose a function.</p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Under <b>Designer</b>, choose <b>Add trigger</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Choose a trigger type.</p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Configure the required options and then choose <b>Add</b>.
                                          </p>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                 
                                 
                                 <p>Lambda supports the following options for Kinesis event sources.</p>
                                 
                                 <div class="itemizedlist">
                                    
                                    <p class="title"><b>Event source options</b></p>
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          
                                          <p><b>Kinesis stream</b> – The Kinesis stream to read records from.
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><b>Consumer</b> (optional) – Use a stream consumer to read from the stream over a
                                             dedicated connection.
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><b>Batch size</b> – The number of records to send to the function in each batch, up
                                             to 10,000. Lambda passes all of the records in the batch to the function in a single
                                             call, as long as the total
                                             size of the events doesn't exceed the <a href="gettingstarted-limits.html">payload limit</a> for
                                             synchronous invocation (6 MB).
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                          <p><b>Batch window</b> – Specify the maximum amount of time to gather records before
                                             invoking the function, in seconds.
                                          </p>
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><b>Starting position</b> – Process only new records, all existing records, or records
                                             created after a certain date.
                                          </p>
                                          
                                          <div class="itemizedlist">
                                              
                                              
                                              
                                             
                                             <ul class="itemizedlist" type="disc">
                                                <li class="listitem">
                                                   
                                                   <p><b>Latest</b> – Process new records that are added to the stream.
                                                   </p>
                                                   
                                                </li>
                                                <li class="listitem">
                                                   
                                                   <p><b>Trim horizon</b> – Process all records in the stream.
                                                   </p>
                                                   
                                                </li>
                                                <li class="listitem">
                                                   
                                                   <p><b>At timestamp</b> – Process records starting from a specific time.
                                                   </p>
                                                   
                                                </li>
                                             </ul>
                                          </div>
                                          
                                          <p>After processing any existing records, the function is caught up and continues to
                                             process new
                                             records.
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                          <p><b>On-failure destination</b> – An SQS queue or SNS topic
                                             for records that can't be processed. When Lambda discards a batch of records because
                                             it's too old or has exhausted
                                             all retries, it sends details about the batch to the queue or topic.
                                          </p>
                                       </li>
                                       <li class="listitem">
                                          <p><b>Retry attempts</b> – The maximum number of times that
                                             Lambda retries when the function returns an error. This doesn't apply to service errors
                                             or throttles where the
                                             batch didn't reach the function.
                                          </p>
                                       </li>
                                       <li class="listitem">
                                          <p><b>Maximum age of record</b> – The maximum age of a record that
                                             Lambda sends to your function.
                                          </p>
                                       </li>
                                       <li class="listitem">
                                          <p><b>Split batch on error</b> – When the function returns an error,
                                             split the batch into two before retrying.
                                          </p>
                                       </li>
                                       <li class="listitem">
                                          <p><b>Concurrent batches per shard</b> – Process multiple batches from the same shard
                                             concurrently.
                                          </p>
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><b>Enabled</b> – Set to true to enable the event source mapping. Set to false to stop
                                             processing records. Lambda keeps track of the last record processed and resumes processing
                                             from that point when
                                             it's reenabled.
                                          </p>
                                          
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 
                                 <div class="awsdocs-note">
                                    <div class="awsdocs-note-title">
                                       <awsui-icon name="status-info" variant="link"></awsui-icon><span>Note</span></div>
                                    <div class="awsdocs-note-text">
                                       <p>Kinesis charges for each shard and, for enhanced fan-out, data read from the stream.
                                          For pricing details, see
                                          <a href="https://aws.amazon.com/kinesis/data-streams/pricing" rel="noopener noreferrer" target="_blank"><span>Amazon Kinesis pricing</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                                       </p>
                                    </div>
                                 </div>
                                 
                                 <p>To manage the event source configuration later, choose the trigger in the designer.</p>
                                  
                                 
                                 <h2 id="services-kinesis-api">Event source mapping API</h2>
                                  
                                 <p>To manage an event source with the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">AWS CLI</a> or <a href="http://aws.amazon.com/getting-started/tools-sdks/" rel="noopener noreferrer" target="_blank"><span>AWS SDK</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, you can use the following API operations:
                                 </p>
                                 
                                 <div class="itemizedlist">
                                     
                                     
                                     
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          
                                          <p><a href="API_CreateEventSourceMapping.html">CreateEventSourceMapping</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="API_ListEventSourceMappings.html">ListEventSourceMappings</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="API_GetEventSourceMapping.html">GetEventSourceMapping</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="API_UpdateEventSourceMapping.html">UpdateEventSourceMapping</a></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p><a href="API_DeleteEventSourceMapping.html">DeleteEventSourceMapping</a></p>
                                          
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 
                                 <p>To create the event source mapping with the AWS CLI, use the <code class="code">create-event-source-mapping</code> command.
                                    The following example uses the AWS CLI to map a function named <code class="code">my-function</code> to a Kinesis data stream. The
                                    data stream is specified by an Amazon Resource Name (ARN), with a batch size of 500,
                                    starting from the timestamp
                                    in Unix time.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda create-event-source-mapping --function-name my-function \
--batch-size 500 --starting-position AT_TIMESTAMP --starting-position-timestamp 1541139109 \
--event-source-arn arn:aws:kinesis:<code class="replaceable">us-east-2:123456789012:stream/lambda-stream</code></code></code></pre>
                                 <p>You should see the following output:</p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "UUID": "2b733gdc-8ac3-cdf5-af3a-1827b3b11284",
    "BatchSize": 500,
    "MaximumBatchingWindowInSeconds": 0,
    "ParallelizationFactor": 1,
    "EventSourceArn": "arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream",
    "FunctionArn": "arn:aws:lambda:us-east-2:123456789012:function:my-function",
    "LastModified": 1541139209.351,
    "LastProcessingResult": "No records processed",
    "State": "Creating",
    "StateTransitionReason": "User action",
    "DestinationConfig": <span>{</span>},
    "MaximumRecordAgeInSeconds": 604800,
    "BisectBatchOnFunctionError": false,
    "MaximumRetryAttempts": 10000
}</code></pre>
                                 <p>To use a consumer, specify the consumer's ARN instead of the stream's ARN.</p>
                                  
                                 <p>Configure additional options to customize how batches are processed and to specify
                                    when
                                    to discard records that can't be processed. The following example updates an event
                                    source mapping to send a
                                    failure record to an SQS queue after two retry attempts, or if the records are more
                                    than an hour old.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda update-event-source-mapping --uuid f89f8514-cdd9-4602-9e1f-01a5b77d449b \
--maximum-retry-attempts 2  --maximum-record-age-in-seconds 3600
--destination-config '<span>{</span>"OnFailure": <span>{</span>"Destination": "arn:aws:sqs:us-east-2:123456789012:dlq"}}'</code></code></pre>
                                 <p>You should see this output:</p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "UUID": "f89f8514-cdd9-4602-9e1f-01a5b77d449b",
    "BatchSize": 100,
    "MaximumBatchingWindowInSeconds": 0,
    "ParallelizationFactor": 1,
    "EventSourceArn": "arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream",
    "FunctionArn": "arn:aws:lambda:us-east-2:123456789012:function:my-function",
    "LastModified": 1573243620.0,
    "LastProcessingResult": "PROBLEM: Function call failed",
    <code class="userinput">"State": "Updating",
    "StateTransitionReason": "User action",</code>
    "DestinationConfig": <span>{</span>},
    "MaximumRecordAgeInSeconds": 604800,
    "BisectBatchOnFunctionError": false,
    "MaximumRetryAttempts": 10000
}</code></pre>
                                 <p>Updated settings are applied asynchronously and aren't reflected in the output until
                                    the process completes. Use
                                    the <code class="code">get-event-source-mapping</code> command to view the current status.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda get-event-source-mapping --uuid f89f8514-cdd9-4602-9e1f-01a5b77d449b</code></code></pre>
                                 <p>You should see this output:</p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "UUID": "f89f8514-cdd9-4602-9e1f-01a5b77d449b",
    "BatchSize": 100,
    "MaximumBatchingWindowInSeconds": 0,
    "ParallelizationFactor": 1,
    "EventSourceArn": "arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream",
    "FunctionArn": "arn:aws:lambda:us-east-2:123456789012:function:my-function",
    "LastModified": 1573244760.0,
    "LastProcessingResult": "PROBLEM: Function call failed",
    "State": "Enabled",
    "StateTransitionReason": "User action",
    <code class="userinput">"DestinationConfig": <span>{</span>
        "OnFailure": <span>{</span>
            "Destination": "arn:aws:sqs:us-east-2:123456789012:dlq"
        }
    },
    "MaximumRecordAgeInSeconds": 3600,</code>
    "BisectBatchOnFunctionError": false,
    <code class="userinput">"MaximumRetryAttempts": 2</code>
}</code></pre>
                                  <p>To process multiple batches concurrently, use the <code class="code">--parallelization-factor</code> option.
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda update-event-source-mapping --uuid 2b733gdc-8ac3-cdf5-af3a-1827b3b11284 \
--parallelization-factor 5</code></code></pre>
                                 
                                  
                                 <h2 id="services-kinesis-errors">Error handling</h2>
                                  
                                 <p>The event source mapping that reads records from your Kinesis stream invokes your
                                    function synchronously and retries on errors. If the function is throttled or the
                                    Lambda service returns an error without
                                    invoking the function, Lambda retries until the records expire or exceed the maximum
                                    age that you configure on the event
                                    source mapping.
                                 </p>
                                  
                                 <p>If the function receives the records but returns an error, Lambda retries until
                                    the records in the batch expire, exceed the maximum age, or reach the configured retry
                                    quota. For function errors,
                                    you can also configure the event source mapping to split a failed batch into two batches.
                                    Retrying with smaller
                                    batches isolates bad records and works around timeout issues. Splitting a batch does
                                    not count towards the retry quota.
                                 </p> 
                                  
                                 <p>If the error handling measures fail, Lambda discards the records and continues processing
                                    batches from the stream. With the default settings, this means that a bad record can
                                    block processing on the affected
                                    shard for up to one week. To avoid this, configure your function's event source mapping
                                    with a reasonable
                                    number of retries and a maximum record age that fits your use case.
                                 </p>
                                  
                                 <p>To retain a record of discarded batches, configure a failed-event destination. Lambda
                                    sends a document to the destination queue or topic with details about the batch.
                                 </p>
                                 
                                 <div class="procedure">
                                    <p class="title"><b>To configure a destination for failed-event records</b></p>
                                    <ol>
                                       <li>
                                          <p>Open the <a href="https://console.aws.amazon.com/lambda/home#/functions" rel="noopener noreferrer" target="_blank"><span>Functions page</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the Lambda console.
                                          </p>
                                       </li>
                                       <li>
                                          
                                          <p>Choose a function.</p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Under <b>Designer</b>, choose <b>Add destination</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>For <b>Source</b>, choose <b>Stream invocation</b>.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>For <b>Stream</b>, choose a stream that is mapped to the function.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>For <b>Destination type</b>, choose the type of resource that receives the invocation
                                             record.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>For <b>Destination</b>, choose a resource.
                                          </p>
                                          
                                       </li>
                                       <li>
                                          
                                          <p>Choose <b>Save</b>.
                                          </p>
                                          
                                       </li>
                                    </ol>
                                 </div>
                                  
                                 <p>The following example shows an invocation record for a Kinesis stream.</p>
                                 
                                 <div class="example">
                                    <p class="title"><b>Example invocation Record</b></p>
                                    <div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "requestContext": <span>{</span>
        "requestId": "c9b8fa9f-5a7f-xmpl-af9c-0c604cde93a5",
        "functionArn": "arn:aws:lambda:us-east-2:123456789012:function:myfunction",
        "condition": "RetryAttemptsExhausted",
        "approximateInvokeCount": 1
    },
    "responseContext": <span>{</span>
        "statusCode": 200,
        "executedVersion": "$LATEST",
        "functionError": "Unhandled"
    },
    "version": "1.0",
    "timestamp": "2019-11-14T00:38:06.021Z",
    "KinesisBatchInfo": <span>{</span>
        "shardId": "shardId-000000000001",
        "startSequenceNumber": "49601189658422359378836298521827638475320189012309704722",
        "endSequenceNumber": "49601189658422359378836298522902373528957594348623495186",
        "approximateArrivalOfFirstRecord": "2019-11-14T00:38:04.835Z",
        "approximateArrivalOfLastRecord": "2019-11-14T00:38:05.580Z",
        "batchSize": 500,
        "streamArn": "arn:aws:kinesis:us-east-2:123456789012:stream/mystream"
    }
}</code></pre></div>
                                 </div>
                                  
                                 <p>You can use this information to retrieve the affected records from the stream for
                                    troubleshooting. The actual records aren't included, so you must process this record
                                    and retrieve them from the
                                    stream before they expire and are lost.
                                 </p>
                                 
                                  
                                 
                                 <h2 id="events-kinesis-metrics">Amazon CloudWatch metrics</h2>
                                 
                                  
                                 <p>Lambda emits the <code class="code">IteratorAge</code> metric when your function finishes processing a batch of records. The
                                    metric indicates how old the last record in the batch was when processing finished.
                                    If your function is processing
                                    new events, you can use the iterator age to estimate the latency between when a record
                                    is added and when the
                                    function processes it.
                                 </p>
                                 
                                 <p>An increasing trend in iterator age can indicate issues with your function. For more
                                    information, see <a href="monitoring-metrics.html">Working with AWS Lambda function metrics</a>.
                                 </p>
                                 
                                  
                                 
                                 <h2 id="services-kinesis-windows">Time windows</h2>
                                 
                                 
                                 <p>Lambda functions can run continuous stream processing applications. A stream represents
                                    unbounded data that flows
                                    continuously through your application. To analyze information from this continuously
                                    updating input, you can bound
                                    the included records using a window defined in terms of time.
                                 </p>
                                 
                                 
                                 <p>Lambda invocations are stateless—you cannot use them for processing data across multiple
                                    continuous invocations
                                    without an external database. However, with windowing enabled, you can maintain your
                                    state across invocations. This
                                    state contains the aggregate result of the messages previously processed for the current
                                    window. Your state
                                    can be a maximum of 1 MB per shard. If it exceeds that size, Lambda terminates the
                                    window early.
                                 </p>
                                 
                                  
                                 
                                 <h3 id="streams-tumbling">Tumbling windows</h3>
                                 
                                 <p>Lambda functions can aggregate data using tumbling windows: distinct time windows
                                    that open and close at
                                    regular intervals. Tumbling windows enable you to process streaming data sources through
                                    contiguous,
                                    non-overlapping time windows.
                                 </p>
                                 
                                 
                                 <p>Each record of a stream belongs to a specific window. A record is processed only once,
                                    when Lambda processes
                                    the window that the record belongs to. In each window, you can perform calculations,
                                    such as a sum or average, at
                                    the <a href="https://docs.aws.amazon.com/streams/latest/dev/key-concepts.html#partition-key">partition key</a> level
                                    within a shard.
                                 </p>
                                  
                                 
                                  
                                 
                                 <h3 id="streams-tumbling-processing">Aggregation and processing</h3>
                                 
                                 <p>Your user managed function is invoked both for aggregation and for processing the
                                    final results of that
                                    aggregation. Lambda aggregates all records received in the window. You can receive
                                    these records in multiple
                                    batches, each as a separate invocation. Each invocation receives a state. You can
                                    also process records and return
                                    a new state, which is passed in the next invocation. Lambda returns a <code class="code">TimeWindowEventResponse</code> in JSON
                                    in the following format:
                                 </p>
                                 
                                 
                                 <div class="example">
                                    <p class="title"><b>Example 
                                          <code class="code">TimeWindowEventReponse</code> values</b></p>
                                    <div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "state": <span>{</span>
        "1": 282,
        "2": 715
    },
    "batchItemFailures": []
}</code></pre></div>
                                 </div>
                                 
                                 
                                 <div class="awsdocs-note">
                                    <div class="awsdocs-note-title">
                                       <awsui-icon name="status-info" variant="link"></awsui-icon><span>Note</span></div>
                                    <div class="awsdocs-note-text">
                                       <p>For Java functions, we recommend using a Map&lt;String, String&gt; to represent the state.</p>
                                    </div>
                                 </div>
                                 
                                 
                                 <p>At the end of the window, the flag <code class="code">isFinalInvokeForWindow</code> is set to <code class="code">true</code> to indicate
                                    that this is the final state and that it’s ready for processing. After processing,
                                    the window completes and your
                                    final invocation completes, and then the state is dropped.
                                 </p>
                                 
                                 
                                 <p>At the end of your window, Lambda uses final processing for actions on the aggregation
                                    results. Your final
                                    processing is synchronously invoked. After successful invocation, your function checkpoints
                                    the sequence number
                                    and stream processing continues. If invocation is unsuccessful, your Lambda function
                                    suspends further processing
                                    until a successful invocation.
                                 </p>
                                  
                                 
                                 
                                 
                                 <div class="example">
                                    <p class="title"><b>Example  KinesisTimeWindowEvent</b></p>
                                    <div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">
<span>{</span>
    "Records": [
        <span>{</span>
            "kinesis": <span>{</span>
                "kinesisSchemaVersion": "1.0",
                "partitionKey": "1",
                "sequenceNumber": "49590338271490256608559692538361571095921575989136588898",
                "data": "SGVsbG8sIHRoaXMgaXMgYSB0ZXN0Lg==",
                "approximateArrivalTimestamp": 1607497475.000
            },
            "eventSource": "aws:kinesis",
            "eventVersion": "1.0",
            "eventID": "shardId-000000000006:49590338271490256608559692538361571095921575989136588898",
            "eventName": "aws:kinesis:record",
            "invokeIdentityArn": "arn:aws:iam::123456789012:role/lambda-kinesis-role",
            "awsRegion": "us-east-1",
            "eventSourceARN": "arn:aws:kinesis:us-east-1:123456789012:stream/lambda-stream"
        }
    ],
    "window": <span>{</span>
        "start": "2020-12-09T07:04:00Z",
        "end": "2020-12-09T07:06:00Z"
    },
    "state": <span>{</span>
        "1": 282,
        "2": 715
    },
    "shardId": "shardId-000000000006",
    "eventSourceARN": "arn:aws:kinesis:us-east-1:123456789012:stream/lambda-stream",
    "isFinalInvokeForWindow": false,
    "isWindowTerminatedEarly": false
}
</code></pre></div>
                                 </div>
                                 
                                  
                                 
                                 <h3 id="streams-tumbling-config">Configuration</h3>
                                 
                                 <p>You can configure tumbling windows when you create or update an <a href="invocation-eventsourcemapping.html">event source mapping</a>. To configure a tumbling window, specify the window in seconds. The following
                                    example AWS Command Line Interface (AWS CLI) command creates a streaming event source
                                    mapping that has a tumbling window of 120
                                    seconds. The Lambda function defined for aggregation and processing is named
                                    <code class="code">tumbling-window-example-function</code>.
                                 </p>
                                 
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><code class="userinput">aws lambda create-event-source-mapping --event-source-arn arn:aws:kinesis:us-east-1:123456789012:stream/lambda-stream --function-name "arn:aws:lambda:us-east-1:123456789018:function:tumbling-window-example-function" --region us-east-1 --starting-position TRIM_HORIZON --tumbling-window-in-seconds <code class="replaceable">120</code></code></code></pre>
                                 
                                 <p>Lambda determines tumbling window boundaries based on the time when records were inserted
                                    into the stream. All
                                    records have an approximate timestamp available that Lambda uses in boundary determinations.
                                 </p>
                                 
                                 
                                 <p>Tumbling window aggregations do not support resharding. When the shard ends, Lambda
                                    considers the window
                                    closed, and the child shards start their own window in a fresh state.
                                 </p>
                                 
                                 
                                 <p>Tumbling windows fully support the existing retry policies <code class="code">maxRetryAttempts</code> and
                                    <code class="code">maxRecordAge</code>.
                                 </p>
                                 
                                 
                                 
                                 <div class="example">
                                    <p class="title"><b>Example  Handler.py – Aggregation and processing</b></p>
                                    <div class="example-contents">
                                       <p>The following Python function demonstrates how to aggregate and then process your
                                          final state:
                                       </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">def lambda_handler(event, context):
    print('Incoming event: ', event)
    print('Incoming state: ', event['state'])

#Check if this is the end of the window to either aggregate or process.
    if event['isFinalInvokeForWindow']:
        # logic to handle final state of the window
        print('Destination invoke')
    else:
        print('Aggregate invoke')

#Check for early terminations
    if event['isWindowTerminatedEarly']:
        print('Window terminated early')

    #Aggregation logic
    state = event['state']
    for record in event['Records']:
        state[record['kinesis']['partitionKey']] = state.get(record['kinesis']['partitionKey'], 0) + 1

    print('Returning state: ', state)
    return <span>{</span>'state': state}</code></pre></div>
                                 </div>
                                  
                                 
                                  
                                 
                                 <h2 id="services-kinesis-batchfailurereporting">Reporting batch item failures</h2>
                                 
                                 
                                 <p>When consuming and processing streaming data from an event source, by default Lambda
                                    checkpoints to the highest
                                    sequence number of a batch only when the batch is a complete success. Lambda treats
                                    all other results as a complete
                                    failure and retries processing the batch up to the retry limit. To allow for partial
                                    successes while processing
                                    batches from a stream, turn on <code class="code">ReportBatchItemFailures</code>. Allowing partial successes can help to reduce
                                    the number of retries on a record, though it doesn’t entirely prevent the possibility
                                    of retries in a successful record.
                                 </p>
                                 
                                 
                                 <p>To turn on <code class="code">ReportBatchItemFailures</code>, include the enum value
                                    <code class="userinput">ReportBatchItemFailures</code> in the <code class="code">FunctionResponseTypes</code> list. This list indicates
                                    which response types are enabled for your function. You can configure this list when
                                    you create or update an <a href="invocation-eventsourcemapping.html">event source mapping</a>.
                                 </p>
                                 
                                  
                                 
                                 <h3 id="streams-batchfailurereporting-syntax">Report syntax</h3>
                                 
                                 
                                 <p>When configuring reporting on batch item failures, the <code class="code">StreamsEventResponse</code> class is returned with a
                                    list of batch item failures. You can use a <code class="code">StreamsEventResponse</code> object to return the sequence number
                                    of the first failed record in the batch. You can also create your own custom class
                                    using the correct response
                                    syntax. The following JSON structure shows the required response syntax:
                                 </p>
                                 
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span> 
  "BatchItemFailures": [ 
        <span>{</span>
            "ItemIdentifier": "&lt;id&gt;"
        }
    ]
}</code></pre>
                                  
                                 
                                  
                                 <h3 id="streams-batchfailurereporting-conditions">Success and failure conditions</h3>
                                 
                                 <p>Lambda treats a batch as a complete success if you return any of the following:</p>
                                 
                                 <div class="itemizedlist">
                                     
                                     
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          
                                          <p>An empty <code class="code">batchItemFailure</code> list
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>A null <code class="code">batchItemFailure</code> list
                                          </p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>An empty <code class="code">EventResponse</code></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>A null <code class="code">EventResponse</code></p>
                                          
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 
                                 <p>Lambda treats a batch as a complete failure if you return any of the following:</p>
                                 
                                 <div class="itemizedlist">
                                     
                                     
                                     
                                    
                                    <ul class="itemizedlist" type="disc">
                                       <li class="listitem">
                                          
                                          <p>An empty string <code class="code">itemIdentifier</code></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>A null <code class="code">itemIdentifier</code></p>
                                          
                                       </li>
                                       <li class="listitem">
                                          
                                          <p>An <code class="code">itemIdentifier</code> with a bad key name
                                          </p>
                                          
                                       </li>
                                    </ul>
                                 </div>
                                 
                                 <p>Lambda retries failures based on your retry strategy.</p>
                                  
                                 
                                  
                                 
                                 <h3 id="streams-batchfailurereporting-bisect">Bisecting a batch</h3>
                                 
                                 <p>If your invocation fails and <code class="code">BisectBatchOnFunctionError</code> is turned on, the batch is bisected
                                    regardless of your <code class="code">ReportBatchItemFailures</code> setting.
                                 </p>
                                 
                                 
                                 <p>When a partial batch success response is received and both <code class="code">BisectBatchOnFunctionError</code> and
                                    <code class="code">ReportBatchItemFailures</code> are turned on, the batch is bisected at the returned sequence number and
                                    Lambda retries only the remaining records.
                                 </p>
                                  
                                 
                                 
                                 
                                 <awsdocs-tabs>
                                    <dl style="display: none">
                                       
                                       <dt>Java</dt>
                                       <dd tab-id="java">
                                          
                                          <div class="example">
                                             <p class="title"><b>Example Handler.java – return new StreamsEventResponse()</b></p>
                                             <div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="java ">import com.amazonaws.services.lambda.runtime.Context;
import com.amazonaws.services.lambda.runtime.RequestHandler;
import com.amazonaws.services.lambda.runtime.events.KinesisEvent;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

public class ProcessKinesisRecords implements RequestHandler&lt;KinesisEvent, Serializable&gt; <span>{</span>

    @Override
    public Serializable handleRequest(KinesisEvent input, Context context) <span>{</span>

        List&lt;StreamsEventResponse.BatchItemFailure&gt; batchItemFailures = new ArrayList&lt;*gt;();
        String curRecordSequenceNumber = "";

        for (KinesisEvent.KinesisEventRecord kinesisEventRecord : input.getRecords()) <span>{</span>
            try <span>{</span>
                //Process your record
                KinesisEvent.Record kinesisRecord = kinesisEventRecord.getKinesis();
                curRecordSequenceNumber = kinesisRecord.getSequenceNumber();

            } catch (Exception e) <span>{</span>
                //Return failed record's sequence number
                batchItemFailures.add(new StreamsEventResponse.BatchItemFailure(curRecordSequenceNumber));
                    return new StreamsEventResponse(batchItemFailures);
            }
        }
       
       return new StreamsEventResponse(batchItemFailures);   
    }
}</code></pre></div>
                                          </div>
                                          
                                       </dd>
                                       
                                       <dt>Python</dt>
                                       <dd tab-id="python">
                                          
                                          <div class="example">
                                             <p class="title"><b>Example Handler.py – return batchItemFailures[]</b></p>
                                             <div class="example-contents"><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">def handler(event, context):
    records = event.get("Records")
    curRecordSequenceNumber = "";
    
    for record in records:
        try:
            # Process your record
            curRecordSequenceNumber = record["kinesis"]["sequenceNumber"]
        except Exception as e:
            # Return failed record's sequence number
            return <span>{</span>"batchItemFailures":[<span>{</span>"itemIdentifier": curRecordSequenceNumber}]}

    return <span>{</span>"batchItemFailures":[]}</code></pre></div>
                                          </div>
                                          
                                       </dd>
                                       
                                    </dl>
                                 </awsdocs-tabs>
                                 
                                 
                                 <awsdocs-copyright class="copyright-print"></awsdocs-copyright>
                                 <awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback>
                              </div>
                              <noscript>
                                 <div>
                                    <div>
                                       <div>
                                          <div id="js_error_message">
                                             <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your
                                                   browser.</strong></p>
                                             <p>To use the AWS Documentation, Javascript must be
                                                enabled. Please refer to your browser's Help pages for instructions.
                                             </p>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </noscript>
                              <div id="main-col-footer" class="awsui-util-font-size-0">
                                 <div id="doc-conventions"><a target="_top" href="https://docs.aws.amazon.com/general/latest/gr/docconventions.html">Document Conventions</a></div>
                                 <div class="prev-next">
                                    <div id="previous" class="prev-link" accesskey="p" href="services-kinesisfirehose.html">Kinesis Firehose</div>
                                    <div id="next" class="next-link" accesskey="n" href="with-kinesis-example.html">Tutorial</div>
                                 </div>
                              </div>
                              <awsdocs-page-utilities></awsdocs-page-utilities>
                           </div>
                           <div id="quick-feedback-yes" style="display: none;">
                              <div class="title">Did this page help you? - Yes</div>
                              <div class="content">
                                 <p>Thanks for letting us know we're doing a good
                                    job!
                                 </p>
                                 <p>If you've got a moment, please tell us what we did right
                                    so we can do more of it.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=https://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kinesis.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                           <div id="quick-feedback-no" style="display: none;">
                              <div class="title">Did this page help you? - No</div>
                              <div class="content">
                                 <p>Thanks for letting us know this page needs work. We're
                                    sorry we let you down.
                                 </p>
                                 <p>If you've got a moment, please tell us how we can make
                                    the documentation better.
                                 </p>
                                 <p>
                                    <awsui-button id="fblink" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Lambda&amp;topic_url=https://docs.aws.amazon.com/en_us/lambda/latest/dg/with-kinesis.html"></awsui-button>
                                 </p>
                              </div>
                           </div>
                        </div>
                     </body>
                  </div>
               </awsdocs-view>
               <div class="page-loading-indicator" id="page-loading-indicator">
                  <awsui-spinner size="large"></awsui-spinner>
               </div>
            </div>
            <div id="tools-panel" dom-region="tools">
               <awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel>
            </div>
         </awsui-app-layout>
         <awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner>
         <!--
                SiteCatalyst code version: H.25.2.
                Copyright 1996-2012 Adobe, Inc. All Rights Reserved
                More info available at http://www.omniture.com
            --><script language="JavaScript" type="text/javascript">
var awsdocs = awsdocs || {};
awsdocs.prop66 = 'AWS Lambda';
awsdocs.prop65 =  'Developer Guide';
            </script><script src="https://a0.awsstatic.com/s_code/js/3.0/awshome_s_code.js" language="JavaScript" type="text/javascript"></script>
         <!--/DO NOT REMOVE/-->
         <!--End SiteCatalyst code version: H.25.2.--></div>
   </body>

<!-- Mirrored from docs.aws.amazon.com/lambda/latest/dg/with-kinesis.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 21 Feb 2021 15:02:07 GMT -->
</html>