<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<link rel="stylesheet" href="./prism.css">
<script async defer src="./prism.js"></script>
</head>
<body>;
<h1 id="week-12-full-stack-applications-part-2" data-ignore="true">WEEK 12<br><em>Full-Stack Applications (Part 2)</em></h1>
<hr />
<!-- code_chunk_output -->
<p><a href="#your-first-group-project"><em>Your First Group Project</em></a> - <a href="#setting-up-your-groups-project-repository">Setting Up Your Group’s Project Repository</a></p>
<p><a href="#authentication-learning-objectives"><strong>Authentication Learning Objectives</strong></a> - <a href="#using-bcrypt-to-hash-passwords"><strong>Using Bcrypt to Hash Passwords</strong></a> - <a href="#what-is-cryptography">What is cryptography?</a> - <a href="#what-is-hashing">What is hashing?</a> - <a href="#using-bcrypt-to-hash-user-passwords">Using Bcrypt to hash user passwords</a> - <a href="#configuring-sessions-in-express"><strong>Configuring Sessions in Express</strong></a> - <a href="#overview-of-sessions">Overview of sessions</a> - <a href="#configuring-express-to-use-sessions">Configuring Express to use sessions</a> - <a href="#setting-and-accessing-session-values">Setting and accessing session values</a> - <a href="#session-store-configuration">Session store configuration</a> - <a href="#securing-the-session-http-cookie">Securing the session HTTP cookie</a> - <a href="#implementing-session-based-authentication"><strong>Implementing Session-Based Authentication</strong></a> - <a href="#overview-of-authentication-and-authorization">Overview of authentication and authorization</a> - <a href="#supporting-user-self-registration">Supporting user self-registration</a> - <a href="#supporting-user-login">Supporting user login</a> - <a href="#persisting-user-login-state">Persisting user login state</a> - <a href="#restoring-the-authenticated-user-from-session">Restoring the authenticated user from session</a> - <a href="#protecting-a-route">Protecting a route</a> - <a href="#associating-data-with-a-user">Associating data with a user</a> - <a href="#the-importance-of-using-https">The importance of using HTTPS</a> - <a href="#next-steps">Next steps</a> - <a href="#project-amusement-park-tracker-with-authentication"><em>Project: Amusement Park Tracker with Authentication</em></a></p>
<p><a href="#application-programming-interfaces-learning-objectives"><strong>Application Programming Interfaces Learning Objectives</strong></a> - <a href="#getting-started-with-restful-endpoints"><strong>Getting Started With RESTful Endpoints</strong></a> - <a href="#rules-of-rest">Rules of ReST</a> - <a href="#what-does-a-restful-api-look-like">What does a RESTful API look like?</a> - <a href="#designing-your-api">Designing your API</a> - <a href="#github-api-example">GitHub API example</a> - <a href="#restful-vs-remote-procedure-calls-rpc">RESTful vs remote procedure calls (RPC)</a> - <a href="#express-apis"><strong>Express APIs</strong></a> - <a href="#project-setup">Project setup</a> - <a href="#set-up-the-task-model">Set up the Task model</a> - <a href="#initial-router-setup">Initial router setup</a> - <a href="#global-error-handling">Global error handling</a> - <a href="#reading-all-tasks">Reading all tasks</a> - <a href="#create-a-task">Create a task</a> - <a href="#read-a-task">Read a task</a> - <a href="#update-a-task">Update a task</a> - <a href="#delete-a-task">Delete a task</a> - <a href="#cross-origin-resource-sharing-cors"><strong>Cross-Origin Resource Sharing (CORS)</strong></a> - <a href="#why-cors">Why CORS</a> - <a href="#setting-up-cors">Setting up CORS</a> - <a href="#preflighted-requests">Preflighted requests</a> - <a href="#setting-up-cors-for-the-entire-api">Setting up CORS for the entire API</a> - <a href="#twitter-lite-project"><em>Twitter Lite Project</em></a> - <a href="#twitter-lite-project-with-authentication"><em>Twitter Lite Project… with Authentication!</em></a></p>
<p><a href="#api-security-learning-objectives"><strong>API Security Learning Objectives</strong></a> - <a href="#oauth-20"><strong>OAuth 2.0</strong></a> - <a href="#high-level-overview-of-oauth-20">High level overview of OAuth 2.0</a> - <a href="#getting-your-app-ready-for-oauth-20">Getting your app ready for OAuth 2.0</a> - <a href="#oauth-20-in-detail">OAuth 2.0 in detail</a> - <a href="#token-based-authentication"><strong>Token-Based Authentication</strong></a> - <a href="#json-web-token-jwt">JSON Web Token (JWT)</a> - <a href="#setting-up-token-based-authentication">Setting up token-based authentication</a></p>
<!-- /code_chunk_output -->
<hr />
<hr />
<h1 id="week-12-day-1-project-planning" data-ignore="true">WEEK-12 DAY-1<br><em>Project Planning</em></h1>
<hr />
<h1 id="your-first-group-project">Your First Group Project</h1>
<p>This is a big thing! You’re getting ready to start work on your first big project to become the first entry in your portfolio for interviewing and showcasing. After you get your team together, you need to choose a project and, then, start doing some analysis.</p>
<h2 id="the-groundwork">The groundwork</h2>
<p>Somebody set up the group project repositories, one for the front-end and one for the backend. In those repositories, create a <strong>documentation</strong> directory with two subdirectories: <strong>feature-list</strong> and <strong>feature-packets</strong>.</p>
<p>Now, it’s important to note:</p>
<p><strong>THERE IS NOT A DEDICATED BACKEND TEAM NOR A DEDICATED FRONTEND TEAM</strong>.</p>
<p>Your workflow will be: as a pair, choose a feature that you want to complete, and then do that from front to back, UI to database. That is the good way to do things.</p>
<h2 id="choosing-a-project">Choosing a Project</h2>
<p>This project is meant to challenge you and your team to build something from the ground up. You’ve had practice using the tools of PostgreSQL, Sequelize, and npm to create skeleton projects. Then, you’ve installed packages like Express.js and Pug.js to get your framework in place. Now, you can bring all of that to bear in this first, big application.</p>
<p>You will pick one of the following options to clone.</p>
<ul>
<li><a href="http://www.bandcamp.com">Bandcamp</a></li>
<li><a href="http://www.goodreads.com">Goodreads</a></li>
<li><a href="http://www.medium.com">Medium</a></li>
<li><a href="https://www.producthunt.com/">Product Hunt</a></li>
<li><a href="https://www.rememberthemilk.com/">Remember the Milk</a></li>
<li><a href="http://www.stackoverflow.com">Stack Overflow</a></li>
<li><a href="http://www.teawithstrangers.com/">TeaWithStrangers</a></li>
<li><a href="http://www.quora.com">Quora</a></li>
<li><a href="http://www.yelp.com">Yelp</a></li>
</ul>
<p>These projects were chosen because they allow you to focus on basic CRUD actions rather than complicated front-end features like infinite scroll and single-page apps. Remember that this project is focused on express and we have not yet taught you a front-end framework so you’ll be limited to vanilla javascript.</p>
<h2 id="the-feature-list">The feature list</h2>
<p>Once you have picked a project, spend time with your team figuring out the features that you want your application to have. Ask yourselves</p>
<ul>
<li>What features are needed to make this an application that people would use?</li>
<li>What features would be nice to have if the minimum viable product gets finished?</li>
<li>Will these features demonstrate everything we’ve learned during the first half of the course?</li>
</ul>
<p>Try to create the feature list from the perspective of the person who will be using your application. You can see examples of that in our example repository.</p>
<p>Save this feature list in the <strong>feature-list</strong> subdirectory of the <strong>documentation</strong> directory of the team’s repository.</p>
<h2 id="feature-scoping">Feature scoping</h2>
<p>Post your feature scoping list to the Slack channel and tag the instructors. They will work with you to help you determine what is a good amount of work for your MVP and, then, for your stretch goals.</p>
<h2 id="feature-packets">Feature packets</h2>
<p>Once your team knows what is the MVP, work on the feature packets. Create a new Markdown document for each feature for your MVP. In it, include the following documentation:</p>
<ul>
<li>Models needed</li>
<li>Endpoints needed</li>
<li>Templates needed</li>
<li>Wire frames or sketches</li>
</ul>
<p>This will help guide the team’s development efforts.</p>
<h2 id="code-code-code">Code, code, code!</h2>
<p>Once those are done, your team is set up for success! Determine whether you want to work on features together, one at a time, or have pairs work on features together, or if everyone in the group gets their own feature.</p>
<p>Be smart about your Git workflow. Create branches, commit to them, then create Pull Requests on GitHub to let others see your changes.</p>
<p>Coordinate many times per day so everyone knows what’s going on.</p>
<p>Keep up the communication.</p>
<p>Don’t let someone fail. This is a team effort.</p>
<h2 id="evaluating-your-completion">Evaluating your completion</h2>
<p>Full-stack projects will be evaluated against the following "Minimal Viable Product" features.</p>
<ol type="1">
<li>New account creation, login, and guest/demo login</li>
<li>A production README file for your GitHub repository containing
<ul>
<li>Brief explanation of what the app is and does</li>
<li>Link to live site</li>
<li>Discussion of technologies used</li>
<li>Discussion of two features that show off the team’s technical abilities</li>
<li>Discussion of both challenges faced and the way the team solved them</li>
<li>Code snippets to highlight the best code</li>
</ul></li>
<li>Hosting on Heroku (you’ll get instructions next week)</li>
<li>For four features:
<ul>
<li>Adequate styling</li>
<li>Smooth, bug-free navigation</li>
<li>Adequate and appropriate seed data to demonstrate the feature</li>
</ul></li>
</ol>
<p>In order for this to be considered complete, you must have the first three criteria completed. In addition to that, you will also need to have four of your features demonstrating the checklist under item 4. After the following section is a list of required features if you decide to clone one of the sites from the list above.</p>
<h2 id="show-and-tell">Show and tell</h2>
<p>Instead of an assessment on the following Monday, each team will demonstrate what they’ve been able to accomplish! This type of demonstration normally occurs in real software development shops after a sprint ends. That’s what you’ll be doing: showing what you’ve been able to accomplish in such a short amount of time!</p>
<h2 id="required-features-for-approved-clones">Required Features for Approved Clones</h2>
<p>If you decide to do a direct clone of the one of the sites above, here are the four minimum features that you must implement for each of the choices.</p>
<h4 id="bandcamp">Bandcamp</h4>
<ul>
<li>Artist page</li>
<li>Song player</li>
<li>Search</li>
<li>Upload/download songs</li>
<li><strong>Bonus</strong>: Purchase songs</li>
<li><strong>Bonus</strong>: Follows</li>
</ul>
<h4 id="goodreads">Goodreads</h4>
<ul>
<li>Books</li>
<li>Bookshelves</li>
<li>Reviews</li>
<li>Read Status (will read, have read, etc.)</li>
<li><strong>Bonus</strong>: Search across multiple models</li>
<li><strong>Bonus</strong>: Tags</li>
</ul>
<h4 id="medium">Medium</h4>
<ul>
<li>Stories</li>
<li>Commenting on stories</li>
<li>Follows and feed</li>
<li>Likes</li>
<li><strong>Bonus</strong>: Topics/categories</li>
<li><strong>Bonus</strong>: Bookmarks</li>
</ul>
<h4 id="product-hunt">Product Hunt</h4>
<ul>
<li>Products</li>
<li>Profile Page</li>
<li>Product Discussion</li>
<li>Search (Users or Products)</li>
<li><strong>Bonus</strong>: Collections</li>
<li><strong>Bonus</strong>: Upvotes and Tags</li>
</ul>
<h4 id="quora">Quora</h4>
<ul>
<li>Questions</li>
<li>Answers/comments on answers</li>
<li>Search Questions</li>
<li>Topics/Tags</li>
<li><strong>Bonus</strong>: Upvotes, order questions by popularity</li>
<li><strong>Bonus</strong>: Replies to comments</li>
</ul>
<h4 id="remember-the-milk">Remember the Milk</h4>
<ul>
<li>Tasks</li>
<li>Lists</li>
<li>List summary (time, num tasks, num completed)</li>
<li>Search</li>
<li><strong>Bonus</strong>: Autocomplete SmartAdd of task properties</li>
<li><strong>Bonus</strong>: Subtasks</li>
</ul>
<h4 id="stack-overflow">Stack Overflow</h4>
<ul>
<li>Ask Questions</li>
<li>Answer Questions</li>
<li>Search for Questions</li>
<li>Upvote / Downvote Answer</li>
<li><strong>Bonus</strong>: Question Categories</li>
<li><strong>Bonus</strong>: Comment on Questions / Answers</li>
<li><strong>Bonus</strong>: Polymorphic Up/Down Votes: Questions, Answers, Comments</li>
<li><strong>Bonus</strong>: Code Snippets in Answers</li>
</ul>
<h4 id="teawithstrangers">TeaWithStrangers</h4>
<ul>
<li>Choose City</li>
<li>Host Event</li>
<li>Join Event in your city</li>
<li>Dashboard of joined events/hosted events</li>
<li><strong>Bonus</strong>: Google Map API showing events based on location</li>
<li><strong>Bonus</strong>: Suggestions based on event details and user profiles</li>
</ul>
<h4 id="yelp">Yelp</h4>
<ul>
<li>Business Page</li>
<li>Search / filters</li>
<li>Reviews / ratings</li>
<li>Map</li>
<li><strong>Bonus</strong>: Mark reviews funny, cool, useful etc.</li>
<li><strong>Bonus</strong>: Profile</li>
<li><strong>Bonus</strong>: Friends ________________________________________________________________________________ # Setting Up Your Group’s Project Repository</li>
</ul>
<p>Only <strong>one person</strong> on the team should do this, the "project lead". Once the project is done, everyone should <em>fork</em> the repository to get their own local copies for future reference.</p>
<p>Your group will coordinate and collaborate around a GitHub repository. To do that, you’ll need to set it up so that everyone can contribute. These are the steps to get you on your way.</p>
<h2 id="create-a-new-repository">Create a new repository</h2>
<p>Go to GitHub. On your profile page, you should see a "New" button that allows you to create a new repository. Click it.</p>
<figure>
<img src="images/group-project-repo-setup-new-repo.png" alt="new repository button" /><figcaption>new repository button</figcaption>
</figure>
<p>Fill out the name of the repository, its description, and choose to initialize the repository with a README and a <strong>.gitignore</strong> file for Node.js projects.</p>
<p><strong>MAKE IT PUBLIC EVEN THOUGH THE PICTURE BELOW SHOWS PRIVATE!</strong> If it’s not public, then you can’t show it to the world.</p>
<figure>
<img src="images/group-project-repo-setup-repo-details.png" alt="new repository details" /><figcaption>new repository details</figcaption>
</figure>
<p>Click the "Create repository" button.</p>
<h2 id="give-access-to-your-teammates">Give access to your teammates</h2>
<p>Now that you have a repository, you need to give some privileges to your teammates so they can use the repository, too.</p>
<p>On your project page, click the "Settings" tab.</p>
<figure>
<img src="images/group-project-repo-setup-settings-tab.png" alt="repository settings tab" /><figcaption>repository settings tab</figcaption>
</figure>
<p>Once on the Settings page, click the "Manage access" link.</p>
<figure>
<img src="images/group-project-repo-setup-manage-access.png" alt="manage access link" /><figcaption>manage access link</figcaption>
</figure>
<p>You may have to confirm your password.</p>
<p>Once you get there, click the "Invite teams or people".</p>
<figure>
<img src="images/group-project-repo-setup-invite-teams-or-people.png" alt="invite teams or people button" /><figcaption>invite teams or people button</figcaption>
</figure>
<p>For each person on your team, invite them to the repository and give them "Maintain" access.</p>
<figure>
<img src="images/group-project-repo-setup-invite-member-at-level.png" alt="grant access to user" /><figcaption>grant access to user</figcaption>
</figure>
<p>Now, have everyone clone the repository and you can start working together.</p>
<p>Start by creating a <strong>documentation</strong> directory. Inside that directory, create a directory named <strong>feature-list</strong>. In there, create a README.md document in which you can create the list of features and their estimates so that an instructor can review them.</p>
<hr />
<h1 id="week-12-day-2-authentication-and-authorization" data-ignore="true">WEEK-12 DAY-2<br><em>Authentication and Authorization</em></h1>
<hr />
<h1 id="authentication-learning-objectives">Authentication Learning Objectives</h1>
<p>Almost every online software application has an <strong>authentication</strong> component that compels visitors to identify themselves. After reading and practicing, you should be able to</p>
<ul>
<li>Define the term <em>authentication</em></li>
<li>Describe the difference between asymmetric and symmetric cryptographic algorithms</li>
<li>Identify "strong" vs. "broken" hash functions</li>
<li>Implement session-based authentication in an Express application</li>
<li>Implement a strong hash function to securely store passwords</li>
<li>Describe and use the different security options for cookies</li>
</ul>
<hr />
<h1 id="using-bcrypt-to-hash-passwords">Using Bcrypt to Hash Passwords</h1>
<p>Using BCrypt to hash passwords came from the idea of thinking about how to protect user information in the worst case scenario. For example, what if a hacker tries to inject your application with a SQL query to receive all user information, including user passwords? This is why a password <em>hash</em> is stored in the database instead of a user’s actual password.</p>
<p>By the end of this article, you will be able to: * Understand what cryptography is and why it’s important; * Understand what hashing and encryption are and how they differ from each other; and * Use Bcrypt to hash stored user passwords.</p>
<h2 id="what-is-cryptography">What is cryptography?</h2>
<p>Cryptography is a way to use algorithms and secret keys to keep information secure. It is comprised of techniques for secure communication for adversaries. Adversaries are third-parties who could possibly fake a user’s identity to gain their secret values.</p>
<p>In modern times, cryptography is synonymous with encryption. Take note that encoding and encrypting are two different processes. An example of an encoding technique is compression, where you would encode the string "aaabcccabbccc" into "a3bc3ab2c3". This is a classic encoding scheme for highly repetitive data. If you know the encoding scheme, you are able to manually decipher the encoded data into it’s original form.</p>
<h3 id="what-is-encryption">What is encryption?</h3>
<p>Encrypting is different from encoding. Encryption is the process of translating something that’s readable into something that looks like nonsense (i.e. not readable) and being able to translate it from a non-readable state back into something that’s readable.</p>
<p>An example of an encryption technique is the <a href="https://www.geeksforgeeks.org/caesar-cipher-in-cryptography/">Caesar Cipher</a> algorithm. Imagine that you are using a <code>caesarCipher</code> function below to transform the string "abcd". The function uses its key of <code>2</code> to shift all its characters two characters to "the right" to have a final encrypted string of "cdef".</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="at">caesarCipher</span>(<span class="st">&quot;abcd&quot;</span><span class="op">,</span> <span class="dv">2</span>) <span class="co">// returns &quot;cdef&quot;</span></a></code></pre></div>
<p>A string is encrypted when we still don’t know for certain what the original input was even though if we understand the algorithm used (i.e. understanding Caesar Cipher, but not being able to read or determine its input from its output).</p>
<h3 id="how-does-encryption-work">How does encryption work?</h3>
<p>There are two kinds of encryption, <strong>symmetric</strong> and <strong>asymmetric</strong> encryption. The Caesar cipher is <em>symmetric</em> because it uses one value to determine how to encrypt data, the number of values to shift the letters in the message. If you know that one value, like <code>2</code> from the previous example, then you can reconstitute the original message by using that knowledge, shifting the letters left two steps.</p>
<p>Asymmetric encryption uses two pieces of information called the public and private keys. The public key is shared with anyone wanting to encrypt a message for the recipient. The private key is used to decrypt the message. Encrypt with public key, decrypt with private key. This is why it’s known as asymmetric, because one key does the encrypting and the other key does the decrypting.</p>
<p>Establishing an HTTPS connection is an example of asymmetric encryption. To break down the steps of encryption between a computer and a Web server that is going to establish a secure HTTP connection (i.e., HTTPS), they would do the following:</p>
<ol type="1">
<li>The server passes on its public key to encrypt data along with its SSL certificate.</li>
<li>The browser client uses the server’s public key to encrypt a value and generate a new private key.</li>
<li>The client sends the encrypted value and the client’s new private key to the server.</li>
<li>The browser’s private key is used to decrypt messages that have been encrypted with the server’s public key.</li>
<li>The server sends encrypted data to the client using the client’s public key.</li>
<li>The browser decrypts the data from the server and renders the decrypted information.</li>
</ol>
<h3 id="when-is-it-appropriate-to-use-encryption">When is it appropriate to use encryption?</h3>
<p>It’s appropriate to use encryption to secure over the wire communication between the client and server (e.g. HTTPS or TLS/SSL). Data at rest (i.e. stored in a database) can also be encrypted. For example, credit card numbers should be encrypted (if they’re stored at all). Sometimes data just needs to be protected at rest and you don’t need the ability to decrypt it. For example, passwords need to be protected at rest, but you don’t need the ability to translate a password back into human readable form. For this reason, hashing is a far more popular way of protecting user passwords.</p>
<h2 id="what-is-hashing">What is hashing?</h2>
<p>Hashing is the process of converting a message of any length into a short, fixed-length string. Hashed values cannot be translated back to their original input values. Hashing is deterministic, meaning that every time you hash the same input, you will receive the same output. This is why we use hashing to secure user credentials.</p>
<h3 id="how-does-hashing-work">How does hashing work?</h3>
<p>There are many different types of hashing functions. It’s important to use cryptographic hashing functions, as they minimize hash collisions (i.e. creating the same hashed value from different inputs). We’ll be focusing on using the BCrypt library which uses the Blowfish cipher, an encryption algorithm.</p>
<h3 id="what-is-a-salt">What is a "salt"?</h3>
<p>Imagine if multiple users have the same password. This means that they would have the same password digest stored in the database. If one of the users has an exposed password, a hacker could find all the users with the same password digest and hack into all accounts with the exposed password. This is where salting comes into play. The basic idea behind salting is to begin by generating a small, random string or set of bits known as a <code>salt</code>. You would then append the <code>salt</code> to your the user’s password before hashing.</p>
<p>If you create a new <code>salt</code> for each user, each time you hash a password for a different user, you are guaranteed to generate a unique password digest to store in the database. Instead of just storing a possibly generic password digest, the password and the unique <code>salt</code> generated for the user is stored.</p>
<p>Now when you see a password digest, the digest is no longer the digest of a common password. It’s a secure digest of a common password concatenated with a salt to randomize the digest output.</p>
<h3 id="when-is-it-appropriate-to-use-hashing">When is it appropriate to use hashing?</h3>
<p>Hashing is a popular way of storing passwords. A hashed password is often referred to as a "password digest". When a user creates an account, their password digest is saved to the database. This keeps the user credentials safe by ensuring that the user’s actual password is never stored in the database. You almost never need to convert user passwords back into something that’s human readable. You simply hash a provided password and compare the hash to the stored hash. If the hashes match, then the user has provided the correct password.</p>
<p>Although the password digest is in the database, the user’s credentials are still safe even if user information is extracted via SQL injection because of how hashing is deterministic. If a hacker uses a user’s password digest in attempt to logging in, the password digest would get hashed into a new hashed value that would not equate to the user’s stored password digest.</p>
<h2 id="using-bcrypt-to-hash-user-passwords">Using Bcrypt to hash user passwords</h2>
<p>BCrypt is a password hashing function that’s widely used to hash user passwords. In this section, you’ll learn how to implement <a href="https://www.npmjs.com/package/bcrypt">BCrypt</a> into your application.</p>
<p>Begin by installing the <code>bcryptjs</code> npm package:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="ex">npm</span> install bcryptjs</a></code></pre></div>
<p>Now require it in your application:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;bcryptjs&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>You can either use BCrypt synchronously or asynchronously. It is recommended to generate hashes asynchronously. As of version <code>2.4.0</code>, <code>bcryptjs</code>’s asynchronous methods return a promise if a callback is omitted.</p>
<p>To generate a hashed value, you’ll await the <code>hash</code> method. The <code>hash</code> method takes in a password to hash and the number of <code>saltRounds</code> to generate a salt. Note that whenever you invoke the <code>hash</code> function with a number of <code>saltRounds</code>, the function generates the <code>salt</code> for you within the hash function.</p>
<p>Auto-generates salt based on number of <code>saltRounds</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">const</span> saltRounds <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">const</span> hash <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> saltRounds)<span class="op">;</span></a></code></pre></div>
<p>Manually generates salt before generating password digest:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">const</span> saltRounds <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">const</span> salt <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">genSalt</span>(saltRounds)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">const</span> hash <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> salt)<span class="op">;</span></a></code></pre></div>
<p>In order to log in a user with their credentials, you would use BCrypt’s <code>compare()</code> method to check whether a user-provided password matches a stored database hash. <code>await</code> the call to the <code>compare()</code> to return a <code>isPassword</code>. Note that <code>isPassword</code> is a Boolean value.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">const</span> isPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">compare</span>(password<span class="op">,</span> hash)<span class="op">;</span></a></code></pre></div>
<p>As a recap, your asynchronous implementation of BCrypt hashing should look something like this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;bcryptjs&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">getHash</span>(password<span class="op">,</span> saltRounds) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-4" title="4">  <span class="kw">const</span> hash <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> saltRounds)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-5" title="5">  <span class="va">console</span>.<span class="at">log</span>(hash)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-6" title="6">  <span class="cf">return</span> hash<span class="op">;</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb7-8" title="8"></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="kw">async</span> <span class="kw">function</span> <span class="at">isPassword</span>(password<span class="op">,</span> hash) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-10" title="10">  <span class="kw">const</span> isPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">compare</span>(password<span class="op">,</span> hash)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="va">console</span>.<span class="at">log</span>(isPassword)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-12" title="12">  <span class="cf">return</span> isPassword<span class="op">;</span></a>
<a class="sourceLine" id="cb7-13" title="13"><span class="op">};</span></a>
<a class="sourceLine" id="cb7-14" title="14"></a>
<a class="sourceLine" id="cb7-15" title="15">(<span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb7-16" title="16">  <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="at">getHash</span>(<span class="st">&#39;P@ssw0rd&#39;</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-17" title="17">  <span class="kw">const</span> passwordIsMatch <span class="op">=</span> <span class="cf">await</span> <span class="at">isPassword</span>(<span class="st">&#39;P@ssw0rd&#39;</span><span class="op">,</span> hashedPassword)<span class="op">;</span></a>
<a class="sourceLine" id="cb7-18" title="18"><span class="op">}</span>)()<span class="op">;</span></a></code></pre></div>
<p>Hashes can also be generated synchronously with BCrypt’s <code>hashSync()</code> method. Like in asynchronous execution, there are also two ways of hash generation. The first way generates a <code>salt</code> and <code>hash</code> on separate function calls. The <code>hash</code> then uses the <code>salt</code> to generate a password digest.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">const</span> saltRounds <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">const</span> salt <span class="op">=</span> <span class="va">bcrypt</span>.<span class="at">genSaltSync</span>(saltRounds)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">const</span> hash <span class="op">=</span> <span class="va">bcrypt</span>.<span class="at">hashSync</span>(<span class="st">&quot;B4c0/</span><span class="sc">\/</span><span class="st">&quot;</span><span class="op">,</span> salt)<span class="op">;</span></a></code></pre></div>
<p>The second way auto-generates a salt to be used in the hash function. In this case, BCrypt’s <code>hashSync()</code> method takes in a password to be hashed and a number of salt rounds.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">const</span> saltRounds <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">const</span> hash <span class="op">=</span> <span class="va">bcrypt</span>.<span class="at">hashSync</span>(<span class="st">&#39;bacon&#39;</span><span class="op">,</span> saltRounds)<span class="op">;</span></a></code></pre></div>
<p>You would then use BCrypt’s <code>compareSync()</code> method to compare a password with a stored database hash to determine whether or not a user has entered valid credentials.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="va">bcrypt</span>.<span class="at">compareSync</span>(<span class="st">&quot;B4c0/</span><span class="sc">\/</span><span class="st">&quot;</span><span class="op">,</span> hash)<span class="op">;</span> <span class="co">// true</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="va">bcrypt</span>.<span class="at">compareSync</span>(<span class="st">&quot;not_bacon&quot;</span><span class="op">,</span> hash)<span class="op">;</span> <span class="co">// false</span></a></code></pre></div>
<p>Now that you have learned how to use the <code>bcryptjs</code> library, you can safely store hashed passwords in your database without the worry that a hacker can reverse engineer them!</p>
<hr />
<h1 id="configuring-sessions-in-express">Configuring Sessions in Express</h1>
<p>In this reading, you’ll learn about HTTP sessions. You’ll also learn about how to configure a session store as well as how to secure the session cookie.</p>
<p>Let’s begin by revisiting how HTTP is stateless. Since HTTP is stateless, query string parameters and HTTP cookies provide ways to persist values across requests. However, storing data in query string parameters can become cumbersome and possibly look strange to end users. This is where session storage comes into play.</p>
<p>By the end of this article, you should be able to:</p>
<ul>
<li>Use the <code>express-session</code> middleware to configure an Express application to support sessions;</li>
<li>Use the <code>req.session</code> object to store and retrieve a value;</li>
<li>Configure the <code>express-session</code> middleware to use a production-ready session storage provider; and,</li>
<li>Use the available security options (i.e. secure, httpOnly, domain, path, and expires) to secure a session’s HTTP cookie.</li>
</ul>
<h2 id="overview-of-sessions">Overview of sessions</h2>
<p>Let’s begin by revisiting how HTTP is a stateless protocol. This means that each HTTP request is independent from other requests that were executed before or after. Once the server has processed an incoming request and returned a response, it forgets about the client.</p>
<h3 id="what-are-sessions">What are sessions?</h3>
<p>Even though HTTP cookies allow the persistence of values across requests, cookies aren’t an efficient way to store anything other than small amounts of data. Transmitting HTTP cookies between the server and client (and back again) can undesirably increase the amount of traffic on the server.</p>
<p>Most browsers don’t reliably support more than 50 cookies per domain and the total size of all of the data in the cookies has to be less than 4093 characters of text. That may sound like a lot, but when you are storing data for a person’s session in there, you will run out of room very quickly.</p>
<p>Sessions build upon the idea of an HTTP cookie. Instead of storing data in the cookie itself, a unique identifier known as the <strong>session ID</strong> is stored. This <strong>session ID</strong> is linked to an object stored on the server.</p>
<h3 id="why-are-sessions-useful">Why are sessions useful?</h3>
<p>Sessions give you a way to identify a series of requests as being connected to the same client. Once you know that a request is connected to a known client session, you can associate the state (data) of that session without having to send that data to the client and rely upon them to send that data back to the server unaltered.</p>
<h3 id="what-are-the-drawbacks">What are the drawbacks?</h3>
<p>Although sessions are useful, there are still drawbacks to using sessions. Using sessions increases the overhead required to serve clients. Server affinity, the ability of a router to send a request to the same server over and over for a specific client, can be an issue depending on the session store that you’re using.</p>
<h2 id="configuring-express-to-use-sessions">Configuring Express to use sessions</h2>
<p>Clone the starter project files at: <a href="https://github.com/-starters/express-sessions-starter.git">starter files</a></p>
<p>Install the project’s dependencies and run it.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" title="1"><span class="ex">npm</span> install</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="ex">npm</span> start</a></code></pre></div>
<p>The application is a simple website that contains three pages: "Home", "About", and "Contact".</p>
<p>Currently, when you browse from page to page, the server doesn’t recognize or associate the page requests as being part of the same session.</p>
<p>Open up your web developer tools to view cookies under the "Application" tab. Click on "Storage &gt; Cookies &gt; <code>http://localhost:8080</code>" to view the cookies for your <code>localhost</code> domain. Currently, you shouldn’t see any cookies listed.</p>
<p>Let’s configure the application to use sessions!</p>
<h3 id="installing-and-configuring-express-session">Installing and configuring <code>express-session</code></h3>
<p>Install the <code>express-session</code> npm package.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1"><span class="ex">npm</span> install express-session</a></code></pre></div>
<p>Since the <code>express-session</code> npm package handles your session cookies, you no longer need to install the <code>cookie-parser</code> package separately. If <code>cookie-parser</code> is configured separately, <code>express-session</code> and <code>cookie-parser</code> would both need to use the same <code>secret</code> value. You’ll learn more about this <code>secret</code> value below.</p>
<p>Add the <code>express-session</code> middleware to the <code>app</code> module.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="kw">const</span> session <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-session&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-5" title="5"></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb13-7" title="7"></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="va">app</span>.<span class="at">use</span>(<span class="at">session</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb13-10" title="10">  <span class="dt">secret</span><span class="op">:</span> <span class="st">&#39;a5d63fc5-17a5-459c-b3ba-6d81792158fc&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-11" title="11">  <span class="dt">resave</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-12" title="12">  <span class="dt">saveUninitialized</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb13-14" title="14"></a>
<a class="sourceLine" id="cb13-15" title="15"><span class="co">// Code removed for brevity.</span></a></code></pre></div>
<blockquote>
<p><strong>Note:</strong> Ideally the session <code>secret</code> option value is set from an environment variable. Using a literal value here is being done to keep this example as simple as possible.</p>
</blockquote>
<h3 id="configuration-options">Configuration options</h3>
<p>Let’s take a closer look at the session middleware you configured in <code>app.js</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="at">session</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="dt">secret</span><span class="op">:</span> <span class="st">&#39;a5d63fc5-17a5-459c-b3ba-6d81792158fc&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="dt">resave</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="dt">saveUninitialized</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Notice the following keys that configure your session creation:</p>
<p><strong>secret</strong>: This is the secret used to sign the <strong>session ID</strong> cookie. The <code>secret</code> value above was generated using the <a href="https://www.npmjs.com/package/uuid">uuid npm package</a>. The <code>uuid</code> package allows you to generate universally unique identifiers (UUIDs) from random cryptographically-strong values, a timestamp, or a user-supplied string.</p>
<p><strong>resave</strong>: This option forces the session to be saved into the session <em>store</em>, even if the session was never modified during the request. You would typically want to set this option as <code>false</code> to prevent overwriting sessions during race conditions, which are undesired parallel requests. However if your session store sets an expiration date on stored sessions, then you likely need to set "resave" as <code>true</code>.</p>
<p><strong>saveUninitialized</strong>: This forces an <em>uninitialized</em> session to be saved to the store. An uninitialized session is when a session is new but not modified. It’s useful to set this option as <code>false</code> when creating login sessions, reducing use of server storage, or complying with permission laws to set cookies. Setting the option as <code>false</code> also prevents race conditions when multiple requests are made without a session.</p>
<p>Not setting the <code>resave</code> and <code>saveUninitialized</code> options results in the following warning in the console:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" title="1"><span class="ex">express-session</span> deprecated undefined resave option<span class="kw">;</span> <span class="ex">provide</span> resave option app.js:8:9</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="ex">express-session</span> deprecated undefined saveUninitialized option<span class="kw">;</span> <span class="ex">provide</span> saveUninitialized option app.js:8:9</a></code></pre></div>
<p>Another configuration option that you can set, but which is not listed in the example above, is the <strong>name</strong> of the cookie. By default, the <strong>express-session</strong> middleware uses the name <code>connect.sid</code>. Imagine if you have an application running on <code>localhost:8080</code> and a different application on <code>localhost:3000</code>. Since cookies are scoped to the general <code>localhost</code> domain, this means that cookies set for <code>localhost:8080</code> would appear in your <code>localhost:3000</code> cookies. This is why it’s important to set a specific <code>name</code> property and separate each application’s session cookies from each other.</p>
<h3 id="testing">Testing</h3>
<p>In order to test whether your session cookie is properly created in the next step, begin by opening up your developer tools to view the cookies of the <code>localhost</code> domain. Remember to access the cookies by clicking Application &gt; Storage &gt; Cookies &gt; <code>http://localhost:8080</code>.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/configuring-sessions-devtools-1.png" alt="before-session-cookie-creation" /><figcaption>before-session-cookie-creation</figcaption>
</figure>
<p>As you can see, the session cookie isn’t being created. This is because setting <code>saveUninitialized</code> to <code>false</code> prevents the session from being created until the session has been used. Let’s use the <code>session</code> in your application! Keep your developer tools open to be able to view your cookies as they appear.</p>
<h2 id="setting-and-accessing-session-values">Setting and accessing session values</h2>
<p>Let’s use <code>session</code> to track each page that the user visits!</p>
<p>Create a middleware function that adds each request URL to an array of page visits stored in session.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb16-4" title="4"></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="va">app</span>.<span class="at">use</span>(<span class="at">session</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb16-6" title="6">  <span class="dt">secret</span><span class="op">:</span> <span class="st">&#39;a5d63fc5-17a5-459c-b3ba-6d81792158fc&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb16-7" title="7">  <span class="dt">resave</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb16-8" title="8">  <span class="dt">saveUninitialized</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb16-9" title="9"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb16-10" title="10"></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb16-12" title="12">  <span class="co">// Attempt to get the `history` array from session.</span></a>
<a class="sourceLine" id="cb16-13" title="13">  <span class="co">// If it&#39;s not initialized, then create an array</span></a>
<a class="sourceLine" id="cb16-14" title="14">  <span class="co">// and assigned it back to session.</span></a>
<a class="sourceLine" id="cb16-15" title="15">  <span class="kw">let</span> <span class="op">{</span> history <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">session</span><span class="op">;</span></a>
<a class="sourceLine" id="cb16-16" title="16">  <span class="cf">if</span> (<span class="op">!</span>history) <span class="op">{</span></a>
<a class="sourceLine" id="cb16-17" title="17">    history <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb16-18" title="18">    <span class="va">req</span>.<span class="va">session</span>.<span class="at">history</span> <span class="op">=</span> history<span class="op">;</span></a>
<a class="sourceLine" id="cb16-19" title="19">  <span class="op">}</span></a>
<a class="sourceLine" id="cb16-20" title="20"></a>
<a class="sourceLine" id="cb16-21" title="21">  <span class="co">// Construct the full URL for the current request.</span></a>
<a class="sourceLine" id="cb16-22" title="22">  <span class="co">// Note: Using `req.get(&#39;host&#39;)` to get the hostname also</span></a>
<a class="sourceLine" id="cb16-23" title="23">  <span class="co">// gives you the port number.</span></a>
<a class="sourceLine" id="cb16-24" title="24">  <span class="kw">const</span> url <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="va">req</span>.<span class="at">protocol</span><span class="sc">}</span><span class="vs">://</span><span class="sc">${</span><span class="va">req</span>.<span class="at">get</span>(<span class="st">&#39;host&#39;</span>)<span class="sc">}${</span><span class="va">req</span>.<span class="at">originalUrl</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb16-25" title="25"></a>
<a class="sourceLine" id="cb16-26" title="26">  <span class="co">// Add the URL to the beginning of the array.</span></a>
<a class="sourceLine" id="cb16-27" title="27">  <span class="va">history</span>.<span class="at">unshift</span>(url)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-28" title="28"></a>
<a class="sourceLine" id="cb16-29" title="29">  <span class="co">// Note: We don&#39;t need to update the `session.history` property</span></a>
<a class="sourceLine" id="cb16-30" title="30">  <span class="co">// with the updated array because arrays are passed by reference.</span></a>
<a class="sourceLine" id="cb16-31" title="31">  <span class="co">// Because arrays are passed by reference, when we get a</span></a>
<a class="sourceLine" id="cb16-32" title="32">  <span class="co">// reference to the array in the above code</span></a>
<a class="sourceLine" id="cb16-33" title="33">  <span class="co">// `let { history } = req.session;` and modify the array by</span></a>
<a class="sourceLine" id="cb16-34" title="34">  <span class="co">// calling `history.unshift(url);` we&#39;re modifying the original</span></a>
<a class="sourceLine" id="cb16-35" title="35">  <span class="co">// array that&#39;s stored in session!</span></a>
<a class="sourceLine" id="cb16-36" title="36"></a>
<a class="sourceLine" id="cb16-37" title="37">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb16-38" title="38"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-39" title="39"></a>
<a class="sourceLine" id="cb16-40" title="40"><span class="co">// Code removed for brevity.</span></a></code></pre></div>
<p>After refreshing your page, you should now see a cookie in your developer tools.</p>
<figure>
<embed src="images/configuring-sessions-devtools-2.pngimages/configuring-sessions-devtools-2.pngpthFrom=2%20depthTo=6%20orderedList=false%7D%20--%3E" /><figcaption>after-session-cookie-creation</figcaption>
</figure>
<p>Notice how the code accessed the <code>session</code> attribute of the <code>req</code> object. In order to store or access session data, you use the <code>req.session</code> property.</p>
<p>In the example above, you attempted to get the <code>history</code> array from session. If the array was not already initialized, you created an array and assigned it to the "history" property of the <code>req.session</code> object.</p>
<p>Now you’ll want to update each of the route handlers to pass the <code>req.session.history</code> array to the views.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-3" title="3">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-4" title="4">    <span class="dt">history</span><span class="op">:</span> <span class="va">req</span>.<span class="va">session</span>.<span class="at">history</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-5" title="5">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/about&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-9" title="9">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;about&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-10" title="10">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;About&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-11" title="11">    <span class="dt">history</span><span class="op">:</span> <span class="va">req</span>.<span class="va">session</span>.<span class="at">history</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-14" title="14"></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/contact&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-16" title="16">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;contact&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb17-17" title="17">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Contact&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-18" title="18">    <span class="dt">history</span><span class="op">:</span> <span class="va">req</span>.<span class="va">session</span>.<span class="at">history</span><span class="op">,</span></a>
<a class="sourceLine" id="cb17-19" title="19">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb17-20" title="20"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Then update the <code>layout.pug</code> view to render the history array.</p>
<pre class="pug"><code>doctype html
html(lang=&quot;en&quot;)
  head
    title Sessions - #{title}
  body
    h1 Sessions - #{title}
    ul
      li: a(href=&#39;/&#39;) Home
      li: a(href=&#39;/about&#39;) About
      li: a(href=&#39;/contact&#39;) Contact
    block content
    footer
      h2 History
      ul
        for item in history
          li: a(href=item)= item</code></pre>
<p>Now when you browse from page to page, your history is tracked by the server using <code>session</code>. The middleware function below (that you have already added to your <code>app.js</code>) takes care of generating the <code>history</code> array of visited links. In each of your GET routes, your <code>req.session.history</code> array is passed into the view as a <code>history</code> attribute. Your views then use the <code>history</code> attribute to render a list of visited links in the footer of each page.</p>
<p>Note that browsing history is specific to each user session. If you open a private, Incognito tab, you’ll see that the private client gets its own array of visited pages.</p>
<h2 id="session-store-configuration">Session store configuration</h2>
<p>The default in-memory store that you have been using (<code>MemoryStore</code>) is meant only for local development. There are many available session store options. For example, <code>connect-pg-simple</code> and <code>connect-session-sequelize</code> are two PostgreSQL compatible session store options.</p>
<p>Let’s install and configure the <code>connect-pg-simple</code> session store!</p>
<p>Install the npm package.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" title="1"><span class="ex">npm</span> install connect-pg-simple</a></code></pre></div>
<p>Next, create a database and a database user. You can use the <code>psql</code> terminal commands below.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" title="1"><span class="ex">create</span> database session_example<span class="kw">;</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="ex">create</span> user session_example_app with encrypted password <span class="st">&#39;«a strong password for the session_example_app user»&#39;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="ex">grant</span> all privileges on database session_example to session_example_app<span class="kw">;</span></a></code></pre></div>
<p>Then create the <code>session</code> table in the <code>session_example</code> database. You can run the following command from the root of your project to create the <code>session</code> table.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" title="1"><span class="ex">psql</span> -U session_example_app session_example <span class="op">&lt;</span> node_modules/connect-pg-simple/table.sql</a></code></pre></div>
<p>Or you can run the following SQL statements in <code>psql</code> against the <code>session_example</code> database:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="ot">&quot;session&quot;</span> (</a>
<a class="sourceLine" id="cb22-2" title="2">  <span class="ot">&quot;sid&quot;</span> <span class="dt">varchar</span> <span class="kw">NOT</span> <span class="kw">NULL</span> COLLATE <span class="ot">&quot;default&quot;</span>,</a>
<a class="sourceLine" id="cb22-3" title="3">  <span class="ot">&quot;sess&quot;</span> json <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb22-4" title="4">  <span class="ot">&quot;expire&quot;</span> <span class="dt">timestamp</span>(<span class="dv">6</span>) <span class="kw">NOT</span> <span class="kw">NULL</span></a>
<a class="sourceLine" id="cb22-5" title="5">)</a>
<a class="sourceLine" id="cb22-6" title="6"><span class="kw">WITH</span> (OIDS<span class="op">=</span><span class="kw">FALSE</span>);</a>
<a class="sourceLine" id="cb22-7" title="7"></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="kw">ALTER</span> <span class="kw">TABLE</span> <span class="ot">&quot;session&quot;</span> <span class="kw">ADD</span> <span class="kw">CONSTRAINT</span> <span class="ot">&quot;session_pkey&quot;</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="ot">&quot;sid&quot;</span>) <span class="kw">NOT</span> <span class="kw">DEFERRABLE</span> <span class="kw">INITIALLY</span> <span class="kw">IMMEDIATE</span>;</a>
<a class="sourceLine" id="cb22-9" title="9"></a>
<a class="sourceLine" id="cb22-10" title="10"><span class="kw">CREATE</span> <span class="kw">INDEX</span> <span class="ot">&quot;IDX_session_expire&quot;</span> <span class="kw">ON</span> <span class="ot">&quot;session&quot;</span> (<span class="ot">&quot;expire&quot;</span>);</a></code></pre></div>
<p>Update the npm <code>start</code> script by setting <code>PGUSER</code>, <code>PGDATABASE</code>, and <code>PGPASSWORD</code> environment variables. These variables are used by the <code>pg</code> npm package, which is used by the <code>connect-pg-simple</code> package to communicate to the PostgreSQL database. Make sure to set the <code>PGPASSWORD</code> to the password you’ve given to the <code>session_example_app</code> user.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb23-1" title="1"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb23-2" title="2">  <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;PGUSER=session_example_app PGDATABASE=session_example PGPASSWORD=password nodemon app.js&quot;</span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="fu">}</span></a></code></pre></div>
<p>An alternative way to update the npm <code>start</code> script is by defining the <code>DATABASE_URL</code> environment variable. The <code>DATABASE_URL</code> is used by <code>connect-pg-simple</code> to determine how to connect to the PostgreSQL database containing the <code>session</code> table.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb24-1" title="1"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb24-2" title="2">  <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;DATABASE_URL=postgresql://session_example_app:password@localhost:5432/session_example nodemon app.js&quot;</span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="fu">}</span></a></code></pre></div>
<p>Now update the <code>app</code> module as follows.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb25-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb25-2" title="2"></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="kw">const</span> session <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-session&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="kw">const</span> store <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;connect-pg-simple&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb25-6" title="6"></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb25-8" title="8"></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb25-10" title="10"><span class="va">app</span>.<span class="at">use</span>(<span class="at">session</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb25-11" title="11">  <span class="dt">store</span><span class="op">:</span> <span class="kw">new</span> (<span class="at">store</span>(session))()<span class="op">,</span></a>
<a class="sourceLine" id="cb25-12" title="12">  <span class="dt">secret</span><span class="op">:</span> <span class="st">&#39;a5d63fc5-17a5-459c-b3ba-6d81792158fc&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb25-13" title="13">  <span class="dt">resave</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb25-14" title="14">  <span class="dt">saveUninitialized</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb25-15" title="15"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb25-16" title="16"></a>
<a class="sourceLine" id="cb25-17" title="17"><span class="co">// Code removed for brevity.</span></a></code></pre></div>
<p>Test your app again, and it should behave as it did before, but now the session data is stored in the database!</p>
<p>In <code>psql</code>, connect to the <code>session_example</code> database and run the following query:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> <span class="kw">session</span>;</a></code></pre></div>
<p>You should see a <code>sid</code> session ID, a session cookie, and a <code>history</code> array of visited urls stored in your PostgreSQL database, like the example below.</p>
<pre><code>sid: 2kseXpBRl9h1ZHoBndzEyu_cem9l0GN4
sess: {&quot;cookie&quot;:{&quot;originalMaxAge&quot;:null,&quot;expires&quot;:null,&quot;httpOnly&quot;:true,&quot;path&quot;:&quot;/&quot;},&quot;history&quot;:[&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/contact&quot;,&quot;http://localhost:8080/about&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/about&quot;,&quot;http://localhost:8080/contact&quot;,&quot;http://localhost:8080/about&quot;]}
expire: 2020-04-11 12:19:13</code></pre>
<h2 id="securing-the-session-http-cookie">Securing the session HTTP cookie</h2>
<p>As you see in your database query, you have a <code>cookie</code> object with the following keys of <code>originalMaxAge</code>, <code>expires</code>, <code>httpOnly</code>, and <code>path</code>.</p>
<p>A session cookie has a default configuration of:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb28-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb28-2" title="2">  <span class="dt">httpOnly</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb28-3" title="3">  <span class="dt">maxAge</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></a>
<a class="sourceLine" id="cb28-4" title="4">  <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb28-5" title="5">  <span class="dt">secure</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb28-6" title="6"><span class="op">}</span></a></code></pre></div>
<p>A secure session cookie should be configured like so:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb29-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb29-2" title="2">  <span class="dt">httpOnly</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-3" title="3">  <span class="dt">maxAge</span><span class="op">:</span> «time <span class="kw">in</span> milliseconds»<span class="op">,</span></a>
<a class="sourceLine" id="cb29-4" title="4">  <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb29-5" title="5">  <span class="dt">secure</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb29-6" title="6"><span class="op">}</span></a></code></pre></div>
<p>It’s important to configure cookies as secure HTTP cookies because it’s possible for sessions to be hijacked. Insecure cookies allow hackers to make requests to the web application through another user’s session.</p>
<p>Setting the cookie’s <code>httpOnly</code> property to <code>true</code> prevents JavaScript on the page from accessing the cookie. This helps prevent cross-site scripting (XSS) attacks by making the <code>httpOnly</code> cookies inaccessible through the <code>document.cookie</code> API.</p>
<p>Setting the cookie’s <code>secure</code> property requires that HTTPS is used. HTTPS uses a digital certificate for authentication known as an SSL certificate to make a web application more secure. Using <code>secure</code> cookies and HTTPS prevents anyone from being able to <em>sniff</em> or hijack the cookie as requests and responses are passed between the client and the server.</p>
<p>In production, the <code>secure</code> property should be set to <code>true</code>. If your Express application is behind a proxy you would need to configure it to trust the proxy with <code>app.set('trust proxy', 1)</code>.</p>
<p>Appropriately setting a <code>maxAge</code> on the cookie keeps the cookie from living longer than it needs to. Have you ever logged into a bank website and noticed how quickly the website will log you out if you’re inactive? This is to prevent someone from stealing or accessing your information when sitting down at your computer while you’re away. Expiring sessions as quickly as possible helps to protect your users from accidentally allowing someone to access the web application using their identity.</p>
<p><code>path</code> - Defaults to <code>/</code></p>
<h3 id="additional-session-configuration-cookie-options">Additional session configuration cookie options</h3>
<p>You can also configure session cookies with the following options that are not set by default:</p>
<p><code>domain</code></p>
<p>Since no domain is set by default, this causes browsers to interpret the current domain as the cookie’s domain. This is connected to why setting cookies in a <code>localhost</code> domain (i.e. <code>localhost:8080</code>) would set cookies in a different <code>localhost</code> domain (i.e. <code>localhost:3000</code>).</p>
<p><code>expires</code></p>
<p>Instead of setting this property directly, you can use <code>maxAge</code> instead. Note that <code>maxAge</code> takes in an integer number representing milliseconds to calculate when the cookie should expire.</p>
<h2 id="what-you-have-learned">What you have learned</h2>
<p>You now know what HTTP sessions are as well as how to configure and access the session store in your Express application. You also know how to configure cookie options to secure the session cookie.</p>
<p>Now that you have learned about sessions, you can implement sessions in your own applications!</p>
<hr />
<h1 id="implementing-session-based-authentication">Implementing Session-Based Authentication</h1>
<p>In this reading, you’ll learn how to implement session-based authentication in an Express application.</p>
<p>By the end of this article, you should be able to:</p>
<ul>
<li>Understand what authentication and authorization are and how they differ from each other;</li>
<li>Understand how to support user self-registration and login within a web application; and</li>
<li>Add session-based authentication to an Express website including user flows to support self-registration and login.</li>
</ul>
<h2 id="overview-of-authentication-and-authorization">Overview of authentication and authorization</h2>
<p>So far, all of the users of your applications have been anonymous. While the server can use a feature like sessions to determine if a request is from a client that’s been served before, the server still doesn’t know the identity of that user.</p>
<p>If an application can’t identify its users, it doesn’t have a way to associate data with specific users. The ability to know whose data belongs to whom is an extremely important feature.</p>
<p>Think about popular web applications, such as Facebook. Being able to identify the current user is necessary so Facebook can determine who your friends are, what posts to display to you, and if you post, who to associate the post with.</p>
<h3 id="what-is-authentication">What is authentication?</h3>
<p>Authentication is the process of identifying a user. To authenticate a user, a <code>key</code> and a <code>secret</code> is required.</p>
<ul>
<li>The <code>key</code> is typically a username or an email address.</li>
<li>The <code>secret</code> is typically a password.</li>
</ul>
<p>The user’s <code>key</code> and <code>secret</code> fields are stored in the application’s database as a user account.</p>
<p>A user’s account can also contain other information about the user. For example, an account can contain personal information such as a birth date, a mobile phone number, or a physical address.</p>
<p>Application preferences are also stored in a user account. These preferences can include how many items to include in lists, the designation of a default home page, or color scheme (light vs dark mode).</p>
<h3 id="authentication-process">Authentication process</h3>
<p>When a user authenticates, they provide their username and password via an HTML form. The form then posts to the server. The login route handler attempts to retrieve the user from the database using their username. If a user is found, then the user account’s <em>hashed</em> password is checked against the provided password. Passwords are stored in the database as encrypted <em>hashes</em>.</p>
<p>The user’s provided password needs to be hashed first before it can be compared to the password hash from the database. If the password hashes match, then the user is logged in. With session-based authentication, the user’s ID is stored in the session. Subsequent requests to the application can then check if the session contains a user ID. If a user ID is available, then the user is logged in!</p>
<p>The application can then retrieve the user’s account information and make it available to other middleware, the route handler, and the view.</p>
<h3 id="what-is-authorization">What is authorization?</h3>
<p>Authorization is the process of determining if the currently logged in user has access to an application’s data or features. Sometimes, data is associated directly with a user. For example, a table in the database for storing posts or comments would include a <code>userId</code> column. The <code>userId</code> column would have the primary key <code>id</code> value from the <code>Users</code> table.</p>
<p>Relating data to specific users allows the application to retrieve just the user’s own records. Sometimes data should only be accessed by users that are assigned a specific user function or role.</p>
<p>For example, a user might belong to an "Admin" role. Any user in the "Admin" role has permissions to add, update, or even delete other application users. "Admin" role users may also have additional access to certain application features. Don’t let that power go to your head!</p>
<p>We’ll explore how role-based access control works in a future article.</p>
<h2 id="supporting-user-self-registration">Supporting user self-registration</h2>
<p>Before a user can login to an application or website, the application needs to know who that user is… they need to register!</p>
<h3 id="getting-the-starter-project">Getting the starter project</h3>
<p>Clone the starter project:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb30-1" title="1"><span class="fu">git</span> clone https://github.com/-starters/express-reading-list-with-auth-starter.git</a></code></pre></div>
<p>Install the project’s dependencies:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb31-1" title="1"><span class="ex">npm</span> install</a></code></pre></div>
<p>Add an <code>.env</code> file containing the environment variables from the <code>.env.example</code> file:</p>
<pre><code>PORT=8080
DB_USERNAME=reading_list_app
DB_PASSWORD=«the reading_list_app user password»
DB_DATABASE=reading_list
DB_HOST=localhost</code></pre>
<p>Create the database and database user (if needed). Open psql by running the command <code>psql</code> (to use the currently logged in user) or <code>psql -U «super user username»</code> to specify the username of the super user to use. Then execute the following SQL statements:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb33-1" title="1"><span class="kw">create</span> <span class="kw">database</span> reading_list;</a>
<a class="sourceLine" id="cb33-2" title="2"><span class="kw">create</span> <span class="fu">user</span> reading_list_app <span class="kw">with</span> encrypted <span class="kw">password</span> <span class="st">&#39;«a strong password for the reading_list_app user»&#39;</span>;</a>
<a class="sourceLine" id="cb33-3" title="3"><span class="kw">grant</span> <span class="kw">all</span> <span class="kw">privileges</span> <span class="kw">on</span> <span class="kw">database</span> reading_list <span class="kw">to</span> reading_list_app;</a></code></pre></div>
<p>Make sure that the <code>.env</code> file contains the correct database user password!</p>
<p>Start and test the application:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb34-1" title="1"><span class="ex">npm</span> start</a></code></pre></div>
<h3 id="creating-the-user-model">Creating the User model</h3>
<p>The <code>User</code> model should include the following properties:</p>
<ul>
<li><code>emailAddress</code> - A string representing the user’s email address;</li>
<li><code>firstName</code> - A string representing the user’s first name;</li>
<li><code>lastName</code> - A string representing the user’s last name; and</li>
<li><code>hashedPassword</code> - A string representing the user’s hashed password.</li>
</ul>
<p>From the terminal, run the following command to use the Sequelize CLI to generate the <code>User</code> model:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb35-1" title="1"><span class="ex">npx</span> sequelize model:generate --name User --attributes <span class="st">&quot;emailAddress:string, firstName:string, lastName:string, hashedPassword:string&quot;</span></a></code></pre></div>
<p>If the command succeeds, you’ll see the following output in the console:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb36-1" title="1"><span class="ex">New</span> model was created at [path to the project folder]/db/models/user.js .</a>
<a class="sourceLine" id="cb36-2" title="2"><span class="ex">New</span> migration was created at [path to the project folder]/db/migrations/20200410231702-User.js</a></code></pre></div>
<p>This confirms that two files were generated: a file for the <code>User</code> model and a file for a database migration to add the <code>Users</code> table to the database.</p>
<p>Open the <code>./db/models/user.js</code> file and update the <code>User</code> model’s attribute data types and nullability:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb37-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb37-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-3" title="3">  <span class="kw">const</span> User <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;User&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-4" title="4">    <span class="dt">emailAddress</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-5" title="5">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">255</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb37-6" title="6">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb37-7" title="7">      <span class="dt">unique</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb37-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb37-9" title="9">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-10" title="10">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">50</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb37-11" title="11">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb37-12" title="12">    <span class="op">},</span></a>
<a class="sourceLine" id="cb37-13" title="13">    <span class="dt">lastName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-14" title="14">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">50</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb37-15" title="15">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb37-16" title="16">    <span class="op">},</span></a>
<a class="sourceLine" id="cb37-17" title="17">    <span class="dt">hashedPassword</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-18" title="18">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="va">STRING</span>.<span class="at">BINARY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb37-19" title="19">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb37-20" title="20">    <span class="op">}</span></a>
<a class="sourceLine" id="cb37-21" title="21">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb37-22" title="22">  <span class="va">User</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb37-23" title="23">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb37-24" title="24">  <span class="op">};</span></a>
<a class="sourceLine" id="cb37-25" title="25">  <span class="cf">return</span> User<span class="op">;</span></a>
<a class="sourceLine" id="cb37-26" title="26"><span class="op">};</span></a></code></pre></div>
<p>Take a moment to notice that the <code>emailAddress</code> attribute is configured to be <code>unique</code>. This means that there is a <em>unique constraint</em> on that column in the database. The <em>unique constraint</em> ensures that each user in the database will have a unique <code>emailAddress</code>. Without the assurance of knowing that each user has a unique <code>emailAddress</code>, you wouldn’t be able to reliably identify a user by their email address.</p>
<p>The Sequelize <code>STRING</code> data type has an available property of <code>BINARY</code>. Setting an attribute to have a datatype of <code>STRING.BINARY</code> means that the string is stored as raw-byte data. According to the PostgreSQL documentation, a <a href="https://www.postgresql.org/docs/8.1/datatype-binary.html">binary string</a> is a sequence of octets (or bytes).</p>
<p>Make sure to also set the <code>hashedPassword</code> attribute with a datatype of <code>STRING.BINARY</code> in the migration file:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb38-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb38-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-3" title="3">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Users&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-5" title="5">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-6" title="6">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-7" title="7">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-8" title="8">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-9" title="9">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb38-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb38-11" title="11">      <span class="dt">emailAddress</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-12" title="12">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span>(<span class="dv">255</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb38-13" title="13">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-14" title="14">        <span class="dt">unique</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb38-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb38-16" title="16">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-17" title="17">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span>(<span class="dv">50</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb38-18" title="18">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb38-19" title="19">      <span class="op">},</span></a>
<a class="sourceLine" id="cb38-20" title="20">      <span class="dt">lastName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-21" title="21">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span>(<span class="dv">50</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb38-22" title="22">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb38-23" title="23">      <span class="op">},</span></a>
<a class="sourceLine" id="cb38-24" title="24">      <span class="dt">hashedPassword</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-25" title="25">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="va">STRING</span>.<span class="at">BINARY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-26" title="26">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb38-27" title="27">      <span class="op">},</span></a>
<a class="sourceLine" id="cb38-28" title="28">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-29" title="29">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-30" title="30">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb38-31" title="31">      <span class="op">},</span></a>
<a class="sourceLine" id="cb38-32" title="32">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-33" title="33">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-34" title="34">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb38-35" title="35">      <span class="op">}</span></a>
<a class="sourceLine" id="cb38-36" title="36">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-37" title="37">  <span class="op">},</span></a>
<a class="sourceLine" id="cb38-38" title="38">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb38-39" title="39">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Users&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-40" title="40">  <span class="op">}</span></a>
<a class="sourceLine" id="cb38-41" title="41"><span class="op">};</span></a></code></pre></div>
<p>Then apply the migration:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb39-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate</a></code></pre></div>
<p>In the console, you should see something similar to the following output:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb40-1" title="1"><span class="ex">Loaded</span> configuration file <span class="st">&quot;config/database.js&quot;</span>.</a>
<a class="sourceLine" id="cb40-2" title="2"><span class="ex">Using</span> environment <span class="st">&quot;development&quot;</span>.</a>
<a class="sourceLine" id="cb40-3" title="3">== <span class="ex">20200410231702-create-user</span>: migrating =======</a>
<a class="sourceLine" id="cb40-4" title="4">== <span class="ex">20200410231702-create-user</span>: migrated (0.028s)</a></code></pre></div>
<p>To confirm the creation of the <code>Users</code> table, you can run the following command from within psql:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb41-1" title="1">\<span class="ex">d</span> <span class="st">&quot;Users&quot;</span></a></code></pre></div>
<blockquote>
<p>Be sure that you’re connected to the <code>reading_list</code> database in psql. If you are, the cursor should read <code>reading_list=#</code>. If you’re not connected to the correct database, you can run the command <code>\c reading_list</code> to connect to the <code>reading_list</code> database.</p>
</blockquote>
<p>After running the <code>\d "Users"</code> command, you should see the following output within psql:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb42-1" title="1">                                          <span class="ex">Table</span> <span class="st">&quot;public.Users&quot;</span></a>
<a class="sourceLine" id="cb42-2" title="2">     <span class="ex">Column</span>     <span class="kw">|</span>           <span class="ex">Type</span>           <span class="kw">|</span> <span class="ex">Collation</span> <span class="kw">|</span> <span class="ex">Nullable</span> <span class="kw">|</span>               <span class="ex">Default</span></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="ex">----------------+--------------------------+-----------+----------+-------------------------------------</span></a>
<a class="sourceLine" id="cb42-4" title="4"> <span class="fu">id</span>             <span class="kw">|</span> <span class="ex">integer</span>                  <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span> <span class="ex">nextval</span>(<span class="st">&#39;&quot;Users_id_seq&quot;&#39;</span>::regclass)</a>
<a class="sourceLine" id="cb42-5" title="5"> <span class="ex">emailAddress</span>   <span class="kw">|</span> <span class="ex">character</span> varying(255)   <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb42-6" title="6"> <span class="ex">firstName</span>      <span class="kw">|</span> <span class="ex">character</span> varying(50)    <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb42-7" title="7"> <span class="ex">lastName</span>       <span class="kw">|</span> <span class="ex">character</span> varying(50)    <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb42-8" title="8"> <span class="ex">hashedPassword</span> <span class="kw">|</span> <span class="ex">bytea</span>                    <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb42-9" title="9"> <span class="ex">createdAt</span>      <span class="kw">|</span> <span class="ex">timestamp</span> with time zone <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb42-10" title="10"> <span class="ex">updatedAt</span>      <span class="kw">|</span> <span class="ex">timestamp</span> with time zone <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb42-11" title="11"><span class="ex">Indexes</span>:</a>
<a class="sourceLine" id="cb42-12" title="12">    <span class="st">&quot;Users_pkey&quot;</span> <span class="ex">PRIMARY</span> KEY, btree (id)</a>
<a class="sourceLine" id="cb42-13" title="13">    <span class="st">&quot;Users_emailAddress_key&quot;</span> <span class="ex">UNIQUE</span> CONSTRAINT, btree (<span class="st">&quot;emailAddress&quot;</span>)</a></code></pre></div>
<h3 id="adding-the-user-registration-form">Adding the user registration form</h3>
<p>Now you’ll want to create a form that collects the required account information from the user.</p>
<p>To start, now that the application will have two resources, "books" and "users", let’s do a little refactoring! Create a <code>routes</code> folder in the root of the project and then rename the <code>routes.js</code> file as <code>book.js</code> and move the file into the <code>routes</code> folder.</p>
<p>Update the <code>routes</code> module reference in the <code>app.js</code> file:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb43-1" title="1"><span class="kw">const</span> bookRoutes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes/book&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-2" title="2"></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb43-4" title="4"></a>
<a class="sourceLine" id="cb43-5" title="5"><span class="va">app</span>.<span class="at">use</span>(bookRoutes)<span class="op">;</span></a></code></pre></div>
<p>Then move the <code>csrfProtection</code> and <code>asyncHandler</code> variable declarations to a new <code>./routes/utils</code> module:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb44-1" title="1"><span class="co">// ./routes/utils.js</span></a>
<a class="sourceLine" id="cb44-2" title="2"></a>
<a class="sourceLine" id="cb44-3" title="3"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-4" title="4"></a>
<a class="sourceLine" id="cb44-5" title="5"><span class="kw">const</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-6" title="6"></a>
<a class="sourceLine" id="cb44-7" title="7"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-8" title="8"></a>
<a class="sourceLine" id="cb44-9" title="9"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb44-10" title="10">  csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb44-11" title="11">  asyncHandler<span class="op">,</span></a>
<a class="sourceLine" id="cb44-12" title="12"><span class="op">};</span></a></code></pre></div>
<p>And update the <code>./routes/book.js</code> file to import those items from the <code>utils</code> module:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb45-1" title="1"><span class="kw">const</span> <span class="op">{</span> csrfProtection<span class="op">,</span> asyncHandler <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./utils&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Add a module named <code>user</code> to the <code>routes</code> folder containing the following code to define the routes for the "Register" page:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb46-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-2" title="2"><span class="kw">const</span> <span class="op">{</span> check<span class="op">,</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-validator&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-3" title="3"></a>
<a class="sourceLine" id="cb46-4" title="4"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-5" title="5"><span class="kw">const</span> <span class="op">{</span> csrfProtection<span class="op">,</span> asyncHandler <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./utils&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-6" title="6"></a>
<a class="sourceLine" id="cb46-7" title="7"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb46-8" title="8"></a>
<a class="sourceLine" id="cb46-9" title="9"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/user/register&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-10" title="10">  <span class="kw">const</span> user <span class="op">=</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">build</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb46-11" title="11">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-register&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-12" title="12">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Register&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb46-13" title="13">    user<span class="op">,</span></a>
<a class="sourceLine" id="cb46-14" title="14">    <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb46-15" title="15">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-16" title="16"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-17" title="17"></a>
<a class="sourceLine" id="cb46-18" title="18"><span class="kw">const</span> userValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb46-19" title="19">  <span class="co">// </span><span class="al">TODO</span><span class="co"> Define the user validators.</span></a>
<a class="sourceLine" id="cb46-20" title="20">]<span class="op">;</span></a>
<a class="sourceLine" id="cb46-21" title="21"></a>
<a class="sourceLine" id="cb46-22" title="22"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/user/register&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> userValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb46-23" title="23">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-24" title="24">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-25" title="25">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb46-26" title="26">      firstName<span class="op">,</span></a>
<a class="sourceLine" id="cb46-27" title="27">      lastName<span class="op">,</span></a>
<a class="sourceLine" id="cb46-28" title="28">      password<span class="op">,</span></a>
<a class="sourceLine" id="cb46-29" title="29">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb46-30" title="30"></a>
<a class="sourceLine" id="cb46-31" title="31">    <span class="kw">const</span> user <span class="op">=</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb46-32" title="32">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb46-33" title="33">      firstName<span class="op">,</span></a>
<a class="sourceLine" id="cb46-34" title="34">      lastName<span class="op">,</span></a>
<a class="sourceLine" id="cb46-35" title="35">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-36" title="36"></a>
<a class="sourceLine" id="cb46-37" title="37">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-38" title="38"></a>
<a class="sourceLine" id="cb46-39" title="39">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb46-40" title="40">      <span class="cf">await</span> <span class="va">user</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb46-41" title="41">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-42" title="42">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-43" title="43">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-44" title="44">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-register&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-45" title="45">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Register&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb46-46" title="46">        user<span class="op">,</span></a>
<a class="sourceLine" id="cb46-47" title="47">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb46-48" title="48">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb46-49" title="49">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-50" title="50">    <span class="op">}</span></a>
<a class="sourceLine" id="cb46-51" title="51">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb46-52" title="52"></a>
<a class="sourceLine" id="cb46-53" title="53"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Rename the <code>textField</code> mixin to <code>field</code> in the <code>utils.pug</code> template file:</p>
<pre class="pug"><code>mixin field(labelText, fieldName, fieldValue, fieldType = &#39;text&#39;)
  div(class=&#39;form-group&#39;)
    label(for=fieldName)= labelText
    input(type=fieldType id=fieldName name=fieldName value=fieldValue class=&#39;form-control&#39;)</code></pre>
<p>Notice that a <code>fieldType</code> parameter was added that defaults to a value of <code>text</code>. Adding this parameter will give you a way to add a password field to the register form.</p>
<p>Then add the <code>user-register.pug</code> template file to the <code>views</code> folder containing the following code:</p>
<pre class="pug"><code>//- ./views/user-register.pug

extends layout.pug

include utils.pug

block content
  +validationErrorSummary(errors)
  form(action=&#39;/user/register&#39; method=&#39;post&#39;)
    input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
    +field(&#39;First Name&#39;, &#39;firstName&#39;, user.firstName)
    +field(&#39;Last Name&#39;, &#39;lastName&#39;, user.lastName)
    +field(&#39;Email Address&#39;, &#39;emailAddress&#39;, user.emailAddress)
    +field(&#39;Password&#39;, &#39;password&#39;, user.password, &#39;password&#39;)
    +field(&#39;Confirm Password&#39;, &#39;confirmPassword&#39;, &#39;&#39;, &#39;password&#39;)
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Register
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<p>Notice that there are two "password" fields: "Password" and "Confirm Password". When using the <code>input</code> element with a <code>type</code> attribute of <code>password</code>, the field will replace typed characters with bullets to hide what has been typed into the field. This is a great protection from prying eyes, but you need a way for users to be able to confirm the password that they’re providing. Making them type their password twice is doing exactly that.</p>
<blockquote>
<p><strong>Note:</strong> After renaming the <code>textField</code> mixin to <code>field</code>, be sure to update the <code>book-form-fields.pug</code> template to call the mixin using the new name!</p>
</blockquote>
<h3 id="validating-the-user-registration-form">Validating the user registration form</h3>
<p>Implement the following validation rules:</p>
<ul>
<li><code>firstName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul></li>
<li><code>lastName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul></li>
<li><code>emailAddress</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 255 characters</li>
<li>Is a valid email address</li>
</ul></li>
<li><code>password</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul></li>
<li><code>confirmPassword</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul></li>
</ul>
<p>Here’s what the initial pass at setting up the validators looks like using the <code>express-validator</code> library:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb49-1" title="1"><span class="kw">const</span> userValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb49-2" title="2">  <span class="at">check</span>(<span class="st">&#39;firstName&#39;</span>)</a>
<a class="sourceLine" id="cb49-3" title="3">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-4" title="4">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for First Name&#39;</span>)</a>
<a class="sourceLine" id="cb49-5" title="5">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">50</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-6" title="6">    .<span class="at">withMessage</span>(<span class="st">&#39;First Name must not be more than 50 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb49-7" title="7">  <span class="at">check</span>(<span class="st">&#39;lastName&#39;</span>)</a>
<a class="sourceLine" id="cb49-8" title="8">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-9" title="9">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Last Name&#39;</span>)</a>
<a class="sourceLine" id="cb49-10" title="10">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">50</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-11" title="11">    .<span class="at">withMessage</span>(<span class="st">&#39;Last Name must not be more than 50 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb49-12" title="12">  <span class="at">check</span>(<span class="st">&#39;emailAddress&#39;</span>)</a>
<a class="sourceLine" id="cb49-13" title="13">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-14" title="14">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Email Address&#39;</span>)</a>
<a class="sourceLine" id="cb49-15" title="15">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">255</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-16" title="16">    .<span class="at">withMessage</span>(<span class="st">&#39;Email Address must not be more than 255 characters long&#39;</span>)</a>
<a class="sourceLine" id="cb49-17" title="17">    .<span class="at">isEmail</span>()</a>
<a class="sourceLine" id="cb49-18" title="18">    .<span class="at">withMessage</span>(<span class="st">&#39;Email Address is not a valid email&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb49-19" title="19">  <span class="at">check</span>(<span class="st">&#39;password&#39;</span>)</a>
<a class="sourceLine" id="cb49-20" title="20">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-21" title="21">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Password&#39;</span>)</a>
<a class="sourceLine" id="cb49-22" title="22">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">50</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-23" title="23">    .<span class="at">withMessage</span>(<span class="st">&#39;Password must not be more than 50 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb49-24" title="24">  <span class="at">check</span>(<span class="st">&#39;confirmPassword&#39;</span>)</a>
<a class="sourceLine" id="cb49-25" title="25">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-26" title="26">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Confirm Password&#39;</span>)</a>
<a class="sourceLine" id="cb49-27" title="27">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">50</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb49-28" title="28">    .<span class="at">withMessage</span>(<span class="st">&#39;Confirm Password must not be more than 50 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb49-29" title="29">]<span class="op">;</span></a></code></pre></div>
<p>You can use a regular expression to enforce password complexity:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb50-1" title="1"><span class="at">check</span>(<span class="st">&#39;password&#39;</span>)</a>
<a class="sourceLine" id="cb50-2" title="2">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb50-3" title="3">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Password&#39;</span>)</a>
<a class="sourceLine" id="cb50-4" title="4">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">50</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb50-5" title="5">    .<span class="at">withMessage</span>(<span class="st">&#39;Password must not be more than 50 characters long&#39;</span>)</a>
<a class="sourceLine" id="cb50-6" title="6">    .<span class="at">matches</span>(<span class="ss">/</span><span class="sc">^(?</span><span class="ss">=.</span><span class="sc">*[a-z])(?</span><span class="ss">=.</span><span class="sc">*[A-Z])(?</span><span class="ss">=.</span><span class="sc">*[0-9])(?</span><span class="ss">=.</span><span class="sc">*[!@#$%^&amp;*])</span><span class="ss">/</span><span class="op">,</span> <span class="st">&#39;g&#39;</span>)</a>
<a class="sourceLine" id="cb50-7" title="7">    .<span class="at">withMessage</span>(<span class="st">&#39;Password must contain at least 1 lowercase letter, uppercase letter, number, and special character (i.e. &quot;!@#$%^&amp;*&quot;)&#39;</span>)</a></code></pre></div>
<p><code>^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&amp;*])</code></p>
<p>This article from <a href="https://www.thepolyglotdeveloper.com/2015/05/use-regex-to-test-password-strength-in-javascript/">The Polyglot Developer</a> breaks down the RegEx that tests the password strength in the validation above. To recap: * The hat operator <code>^</code> is used to start matching at the beginning of the password. * The expression <code>(?=.*[a-z])</code> is used to check that the password contains at least one lowercase character. * The expression <code>(?=.*[A-Z])</code> is used to check that the password contains at least one uppercase character. * The expression <code>(?=.*[0-9])</code> is used to check that the password contains at least one numeric character. * The expression <code>(?=.*[!@#$%^&amp;*])</code> is used to check that the password contains at least one special character.</p>
<p>The validation below checks that the two passwords should match:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb51-1" title="1"><span class="at">check</span>(<span class="st">&#39;confirmPassword&#39;</span>)</a>
<a class="sourceLine" id="cb51-2" title="2">  .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb51-3" title="3">  .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Confirm Password&#39;</span>)</a>
<a class="sourceLine" id="cb51-4" title="4">  .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">50</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb51-5" title="5">  .<span class="at">withMessage</span>(<span class="st">&#39;Confirm Password must not be more than 50 characters long&#39;</span>)</a>
<a class="sourceLine" id="cb51-6" title="6">  .<span class="at">custom</span>((value<span class="op">,</span> <span class="op">{</span> req <span class="op">}</span>) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-7" title="7">    <span class="cf">if</span> (value <span class="op">!==</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">password</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb51-8" title="8">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;Confirm Password does not match Password&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-9" title="9">    <span class="op">}</span></a>
<a class="sourceLine" id="cb51-10" title="10">    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb51-11" title="11">  <span class="op">}</span>)</a></code></pre></div>
<p>You can use another custom validator to check if the provided email address is already in use by another account:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb52-1" title="1"><span class="at">check</span>(<span class="st">&#39;emailAddress&#39;</span>)</a>
<a class="sourceLine" id="cb52-2" title="2">  .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb52-3" title="3">  .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Email Address&#39;</span>)</a>
<a class="sourceLine" id="cb52-4" title="4">  .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">255</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb52-5" title="5">  .<span class="at">withMessage</span>(<span class="st">&#39;Email Address must not be more than 255 characters long&#39;</span>)</a>
<a class="sourceLine" id="cb52-6" title="6">  .<span class="at">isEmail</span>()</a>
<a class="sourceLine" id="cb52-7" title="7">  .<span class="at">withMessage</span>(<span class="st">&#39;Email Address is not a valid email&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb52-8" title="8">  .<span class="at">custom</span>((value) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb52-9" title="9">    <span class="cf">return</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> <span class="dt">emailAddress</span><span class="op">:</span> value <span class="op">}</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb52-10" title="10">      .<span class="at">then</span>((user) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb52-11" title="11">        <span class="cf">if</span> (user) <span class="op">{</span></a>
<a class="sourceLine" id="cb52-12" title="12">          <span class="cf">return</span> <span class="va">Promise</span>.<span class="at">reject</span>(<span class="st">&#39;The provided Email Address is already in use by another account&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb52-13" title="13">        <span class="op">}</span></a>
<a class="sourceLine" id="cb52-14" title="14">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb52-15" title="15">  <span class="op">}</span>)<span class="op">,</span></a></code></pre></div>
<h3 id="hashing-user-passwords">Hashing user passwords</h3>
<p>To keep your user’s personal information as secure as possible, you need to avoid storing user passwords in clear text. You can do this by encrypting the password with BCrypt, a password hashing function.</p>
<p>Install the <code>bcryptjs</code> npm package:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb53-1" title="1"><span class="ex">npm</span> install bcryptjs</a></code></pre></div>
<p>Update the <code>POST</code> <code>/user/register</code> route handler to use <code>bcrypt</code> to hash the user’s password:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb54-1" title="1"><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;bcryptjs&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb54-2" title="2"></a>
<a class="sourceLine" id="cb54-3" title="3"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb54-4" title="4"></a>
<a class="sourceLine" id="cb54-5" title="5"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/user/register&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> userValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb54-6" title="6">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb54-7" title="7">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb54-8" title="8">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb54-9" title="9">      firstName<span class="op">,</span></a>
<a class="sourceLine" id="cb54-10" title="10">      lastName<span class="op">,</span></a>
<a class="sourceLine" id="cb54-11" title="11">      password<span class="op">,</span></a>
<a class="sourceLine" id="cb54-12" title="12">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb54-13" title="13"></a>
<a class="sourceLine" id="cb54-14" title="14">    <span class="kw">const</span> user <span class="op">=</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb54-15" title="15">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb54-16" title="16">      firstName<span class="op">,</span></a>
<a class="sourceLine" id="cb54-17" title="17">      lastName<span class="op">,</span></a>
<a class="sourceLine" id="cb54-18" title="18">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb54-19" title="19"></a>
<a class="sourceLine" id="cb54-20" title="20">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb54-21" title="21"></a>
<a class="sourceLine" id="cb54-22" title="22">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb54-23" title="23">      <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb54-24" title="24">      <span class="va">user</span>.<span class="at">hashedPassword</span> <span class="op">=</span> hashedPassword<span class="op">;</span></a>
<a class="sourceLine" id="cb54-25" title="25">      <span class="cf">await</span> <span class="va">user</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb54-26" title="26">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb54-27" title="27">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb54-28" title="28">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb54-29" title="29">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-register&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb54-30" title="30">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Register&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb54-31" title="31">        user<span class="op">,</span></a>
<a class="sourceLine" id="cb54-32" title="32">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb54-33" title="33">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb54-34" title="34">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb54-35" title="35">    <span class="op">}</span></a>
<a class="sourceLine" id="cb54-36" title="36">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Notice that the asynchronous method <code>bcrypt.hash()</code> is called to hash the <code>password</code> variable. The hashed value returned from the method call is used to set the <code>user.hashedPassword</code> property.</p>
<h3 id="adding-the-user-routes-to-the-app-module">Adding the user routes to the <code>app</code> module</h3>
<p>In the <code>app</code> module, add the user routes:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb55-1" title="1"><span class="kw">const</span> bookRoutes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes/book&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb55-2" title="2"><span class="kw">const</span> userRoutes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes/user&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb55-3" title="3"></a>
<a class="sourceLine" id="cb55-4" title="4"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb55-5" title="5"></a>
<a class="sourceLine" id="cb55-6" title="6"><span class="va">app</span>.<span class="at">use</span>(bookRoutes)<span class="op">;</span></a>
<a class="sourceLine" id="cb55-7" title="7"><span class="va">app</span>.<span class="at">use</span>(userRoutes)<span class="op">;</span></a></code></pre></div>
<h3 id="testing-user-registration">Testing user registration</h3>
<p>Run the application (<code>npm start</code>) and test the <code>/user/register</code> route by filling out and submitting the form to create a new user.</p>
<p>Using psql, view the user in the database by running the following SELECT SQL statement:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb56-1" title="1"><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> <span class="ot">&quot;Users&quot;</span>;</a></code></pre></div>
<p>You should see a user with a hashed password like in this example:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb57-1" title="1"> <span class="fu">id</span> <span class="kw">|</span>    <span class="ex">emailAddress</span>    <span class="kw">|</span> <span class="ex">firstName</span> <span class="kw">|</span> <span class="ex">lastName</span>  <span class="kw">|</span>                                                       <span class="ex">hashedPassword</span>                                                       <span class="kw">|</span>         <span class="ex">createdAt</span>          <span class="kw">|</span>         <span class="ex">updatedAt</span></a>
<a class="sourceLine" id="cb57-2" title="2"><span class="ex">----+--------------------+-----------+-----------+----------------------------------------------------------------------------------------------------------------------------+----------------------------+----------------------------</span></a>
<a class="sourceLine" id="cb57-3" title="3">  <span class="ex">1</span> <span class="kw">|</span> <span class="ex">james@smashdev.com</span> <span class="kw">|</span> <span class="ex">James</span>     <span class="kw">|</span> <span class="ex">Churchill</span> <span class="kw">|</span> \<span class="ex">x24326124303824446c32684c546e676f49524f322e2e7335704d42697558554955617730325264796d58534e544d3552542e6d686b365a46336e724f</span> <span class="kw">|</span> <span class="ex">2020-04-10</span> 18:54:07.635-07 <span class="kw">|</span> <span class="ex">2020-04-10</span> 18:54:07.635-07</a>
<a class="sourceLine" id="cb57-4" title="4"><span class="kw">(</span><span class="ex">1</span> row<span class="kw">)</span></a></code></pre></div>
<h2 id="supporting-user-login">Supporting user login</h2>
<p>Now that you have a way to support user registration, you need a way to allow existing users to log in using their email address and password.</p>
<h3 id="adding-the-user-login-form">Adding the user login form</h3>
<p>Start by adding the routes and validators for the "Login" page to the <code>./routes/user</code> module just below the existing routes for the "Register" page:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb58-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/user/login&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb58-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-login&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb58-3" title="3">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Login&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb58-4" title="4">    <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb58-5" title="5">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb58-6" title="6"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb58-7" title="7"></a>
<a class="sourceLine" id="cb58-8" title="8"><span class="kw">const</span> loginValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb58-9" title="9">  <span class="at">check</span>(<span class="st">&#39;emailAddress&#39;</span>)</a>
<a class="sourceLine" id="cb58-10" title="10">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb58-11" title="11">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Email Address&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb58-12" title="12">  <span class="at">check</span>(<span class="st">&#39;password&#39;</span>)</a>
<a class="sourceLine" id="cb58-13" title="13">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb58-14" title="14">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Password&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb58-15" title="15">]<span class="op">;</span></a>
<a class="sourceLine" id="cb58-16" title="16"></a>
<a class="sourceLine" id="cb58-17" title="17"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/user/login&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> loginValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb58-18" title="18">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb58-19" title="19">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb58-20" title="20">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb58-21" title="21">      password<span class="op">,</span></a>
<a class="sourceLine" id="cb58-22" title="22">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb58-23" title="23"></a>
<a class="sourceLine" id="cb58-24" title="24">    <span class="kw">let</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb58-25" title="25">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb58-26" title="26"></a>
<a class="sourceLine" id="cb58-27" title="27">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb58-28" title="28">      <span class="co">// </span><span class="al">TODO</span><span class="co"> Attempt to login the user.</span></a>
<a class="sourceLine" id="cb58-29" title="29">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb58-30" title="30">      errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb58-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb58-32" title="32"></a>
<a class="sourceLine" id="cb58-33" title="33">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-login&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb58-34" title="34">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Login&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb58-35" title="35">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb58-36" title="36">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb58-37" title="37">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb58-38" title="38">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb58-39" title="39">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>Notice the slightly different approach of declaring the <code>errors</code> array outside of the <code>else</code> block. Using this approach will allow you to manually add an error message to the <code>errors</code> array if the user login process fails (you’ll implement this process in just a bit).</p>
</blockquote>
<p>Then add the <code>user-login.pug</code> template file to the <code>views</code> folder containing the following code:</p>
<pre class="pug"><code>//- ./views/user-login.pug

extends layout.pug

include utils.pug

block content
  +validationErrorSummary(errors)
  form(action=&#39;/user/login&#39; method=&#39;post&#39;)
    input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
    +field(&#39;Email Address&#39;, &#39;emailAddress&#39;, emailAddress)
    +field(&#39;Password&#39;, &#39;password&#39;, null, &#39;password&#39;)
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Login
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<h3 id="implementing-the-user-login-process">Implementing the user login process</h3>
<p>To implement the user login process, the following steps need to be followed:</p>
<ol type="1">
<li>Attempt to retrieve the user from the database using the supplied email address.</li>
</ol>
<div class="sourceCode" id="cb60"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb60-1" title="1"><span class="co">// Attempt to get the user by their email address.</span></a>
<a class="sourceLine" id="cb60-2" title="2"><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> emailAddress <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ol start="2" type="1">
<li>If a user was found in the database, then use the <code>bcrypt.compare()</code> method to compare the supplied password to the user’s hashed password.</li>
</ol>
<div class="sourceCode" id="cb61"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb61-1" title="1"><span class="co">// Attempt to get the user by their email address.</span></a>
<a class="sourceLine" id="cb61-2" title="2"><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> emailAddress <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb61-3" title="3"></a>
<a class="sourceLine" id="cb61-4" title="4"><span class="cf">if</span> (user <span class="op">!==</span> <span class="kw">null</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb61-5" title="5">  <span class="co">// If the user exists then compare their password</span></a>
<a class="sourceLine" id="cb61-6" title="6">  <span class="co">// to the provided password.</span></a>
<a class="sourceLine" id="cb61-7" title="7">  <span class="kw">const</span> passwordMatch <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">compare</span>(password<span class="op">,</span> <span class="va">user</span>.<span class="va">hashedPassword</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb61-8" title="8"><span class="op">}</span></a></code></pre></div>
<ol start="3" type="1">
<li>If the hashed passwords match (i.e. the <code>bcrypt.compare()</code> method returns <code>true</code>), then login the user and redirect them to the default route (i.e. <code>/</code>).</li>
</ol>
<div class="sourceCode" id="cb62"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb62-1" title="1"><span class="co">// Attempt to get the user by their email address.</span></a>
<a class="sourceLine" id="cb62-2" title="2"><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> emailAddress <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-3" title="3"></a>
<a class="sourceLine" id="cb62-4" title="4"><span class="cf">if</span> (user <span class="op">!==</span> <span class="kw">null</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb62-5" title="5">  <span class="co">// If the user exists then compare their password</span></a>
<a class="sourceLine" id="cb62-6" title="6">  <span class="co">// to the provided password.</span></a>
<a class="sourceLine" id="cb62-7" title="7">  <span class="kw">const</span> passwordMatch <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">compare</span>(password<span class="op">,</span> <span class="va">user</span>.<span class="va">hashedPassword</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb62-8" title="8"></a>
<a class="sourceLine" id="cb62-9" title="9">  <span class="cf">if</span> (passwordMatch) <span class="op">{</span></a>
<a class="sourceLine" id="cb62-10" title="10">    <span class="co">// If the password hashes match, then login the user</span></a>
<a class="sourceLine" id="cb62-11" title="11">    <span class="co">// and redirect them to the default route.</span></a>
<a class="sourceLine" id="cb62-12" title="12">    <span class="co">// </span><span class="al">TODO</span><span class="co"> Login the user.</span></a>
<a class="sourceLine" id="cb62-13" title="13">    <span class="cf">return</span> <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb62-15" title="15"><span class="op">}</span></a></code></pre></div>
<blockquote>
<p><strong>Note:</strong> We’ll implement a method to "login" the user in just a bit. For now, add a <code>TODO</code> comment as a placeholder for the actual method call.</p>
</blockquote>
<ol start="4" type="1">
<li>If a user wasn’t found in the database or the hashed passwords don’t match, then add a validation error message and render the <code>user-login</code> view to let the user know that the login process failed.</li>
</ol>
<div class="sourceCode" id="cb63"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb63-1" title="1"><span class="co">// Attempt to get the user by their email address.</span></a>
<a class="sourceLine" id="cb63-2" title="2"><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> emailAddress <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb63-3" title="3"></a>
<a class="sourceLine" id="cb63-4" title="4"><span class="cf">if</span> (user <span class="op">!==</span> <span class="kw">null</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb63-5" title="5">  <span class="co">// If the user exists then compare their password</span></a>
<a class="sourceLine" id="cb63-6" title="6">  <span class="co">// to the provided password.</span></a>
<a class="sourceLine" id="cb63-7" title="7">  <span class="kw">const</span> passwordMatch <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">compare</span>(password<span class="op">,</span> <span class="va">user</span>.<span class="va">hashedPassword</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb63-8" title="8"></a>
<a class="sourceLine" id="cb63-9" title="9">  <span class="cf">if</span> (passwordMatch) <span class="op">{</span></a>
<a class="sourceLine" id="cb63-10" title="10">    <span class="co">// If the password hashes match, then login the user</span></a>
<a class="sourceLine" id="cb63-11" title="11">    <span class="co">// and redirect them to the default route.</span></a>
<a class="sourceLine" id="cb63-12" title="12">    <span class="co">// </span><span class="al">TODO</span><span class="co"> Login the user.</span></a>
<a class="sourceLine" id="cb63-13" title="13">    <span class="cf">return</span> <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb63-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb63-15" title="15"><span class="op">}</span></a>
<a class="sourceLine" id="cb63-16" title="16"></a>
<a class="sourceLine" id="cb63-17" title="17"><span class="co">// Otherwise display an error message to the user.</span></a>
<a class="sourceLine" id="cb63-18" title="18"><span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Login failed for the provided email address and password&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Notice that you’re not letting the user know if the supplied email address or password is to blame for the failed login attempt. This is intentional! Not providing this information, while potentially frustrating to end users, makes it more difficult for hackers to guess at email address and password combinations.</p>
<p>Here’s the completed <code>POST</code> <code>/user/login</code> route:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb64-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/user/login&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> loginValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb64-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-3" title="3">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-4" title="4">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb64-5" title="5">      password<span class="op">,</span></a>
<a class="sourceLine" id="cb64-6" title="6">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb64-7" title="7"></a>
<a class="sourceLine" id="cb64-8" title="8">    <span class="kw">let</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb64-9" title="9">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-10" title="10"></a>
<a class="sourceLine" id="cb64-11" title="11">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb64-12" title="12">      <span class="co">// Attempt to get the user by their email address.</span></a>
<a class="sourceLine" id="cb64-13" title="13">      <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> emailAddress <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-14" title="14"></a>
<a class="sourceLine" id="cb64-15" title="15">      <span class="cf">if</span> (user <span class="op">!==</span> <span class="kw">null</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb64-16" title="16">        <span class="co">// If the user exists then compare their password</span></a>
<a class="sourceLine" id="cb64-17" title="17">        <span class="co">// to the provided password.</span></a>
<a class="sourceLine" id="cb64-18" title="18">        <span class="kw">const</span> passwordMatch <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">compare</span>(password<span class="op">,</span> <span class="va">user</span>.<span class="va">hashedPassword</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb64-19" title="19"></a>
<a class="sourceLine" id="cb64-20" title="20">        <span class="cf">if</span> (passwordMatch) <span class="op">{</span></a>
<a class="sourceLine" id="cb64-21" title="21">          <span class="co">// If the password hashes match, then login the user</span></a>
<a class="sourceLine" id="cb64-22" title="22">          <span class="co">// and redirect them to the default route.</span></a>
<a class="sourceLine" id="cb64-23" title="23">          <span class="co">// </span><span class="al">TODO</span><span class="co"> Login the user.</span></a>
<a class="sourceLine" id="cb64-24" title="24">          <span class="cf">return</span> <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-25" title="25">        <span class="op">}</span></a>
<a class="sourceLine" id="cb64-26" title="26">      <span class="op">}</span></a>
<a class="sourceLine" id="cb64-27" title="27"></a>
<a class="sourceLine" id="cb64-28" title="28">      <span class="co">// Otherwise display an error message to the user.</span></a>
<a class="sourceLine" id="cb64-29" title="29">      <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Login failed for the provided email address and password&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-30" title="30">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-31" title="31">      errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb64-33" title="33"></a>
<a class="sourceLine" id="cb64-34" title="34">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-login&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb64-35" title="35">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Login&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb64-36" title="36">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb64-37" title="37">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb64-38" title="38">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb64-39" title="39">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-40" title="40">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<h3 id="improving-the-user-navigation">Improving the user navigation</h3>
<p>One small change to the <code>user-register</code> and <code>user-login</code> views before you test the user login form. As a convenience for the user, add links below the user registration and login forms that allow the user to easily navigate between the "Register" and "Login" pages:</p>
<pre class="pug"><code>//- ./views/user-register.pug

extends layout.pug

include utils.pug

block content
  +validationErrorSummary(errors)
  form(action=&#39;/user/register&#39; method=&#39;post&#39;)
    input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
    +field(&#39;First Name&#39;, &#39;firstName&#39;, user.firstName)
    +field(&#39;Last Name&#39;, &#39;lastName&#39;, user.lastName)
    +field(&#39;Email Address&#39;, &#39;emailAddress&#39;, user.emailAddress)
    +field(&#39;Password&#39;, &#39;password&#39;, user.password, &#39;password&#39;)
    +field(&#39;Confirm Password&#39;, &#39;confirmPassword&#39;, &#39;&#39;, &#39;password&#39;)
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Register
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel
  div
    p: a(href=&#39;/user/login&#39;) Already have an account?</code></pre>
<pre class="pug"><code>//- ./views/user-login.pug

extends layout.pug

include utils.pug

block content
  +validationErrorSummary(errors)
  form(action=&#39;/user/login&#39; method=&#39;post&#39;)
    input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
    +field(&#39;Email Address&#39;, &#39;emailAddress&#39;, emailAddress)
    +field(&#39;Password&#39;, &#39;password&#39;, null, &#39;password&#39;)
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Login
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel
  div
    p: a(href=&#39;/user/register&#39;) Don&#39;t have an account?</code></pre>
<h3 id="testing-user-login">Testing user login</h3>
<p>Run the application (if it’s not already running) and browse to the <code>/user/login</code> route. Test the user login form by completing the following actions:</p>
<ul>
<li>Submit the form with no values.
<ul>
<li>You should see two validation messages asking you to provide values.</li>
</ul></li>
<li>Submit the form with an email address that isn’t associated with a user record in the database and a password (doesn’t matter if the password is correct or not).
<ul>
<li>You should see a validation message letting you know that the login attempt failed.</li>
</ul></li>
<li>Submit the form with an email address that’s associated with a user record in the database <strong>but with an incorrect password</strong>.
<ul>
<li>You should see a validation message letting you know that the login attempt failed.</li>
</ul></li>
<li>Submit the form with an email address that’s associated with a user record in the database <strong>and with a correct password</strong>.
<ul>
<li>This time you should be redirected to the "Home" page.</li>
</ul></li>
</ul>
<p>The login process succeeded, but a crucial piece is still missing: persisting the user’s login state.</p>
<h2 id="persisting-user-login-state">Persisting user login state</h2>
<p>Now it’s time to handle persisting the user’s login state after they’ve successfully logged into the website!</p>
<p>Remember that HTTP is a stateless protocol. Each HTTP request is independent from other requests that were executed before or after. Once the server has processed an incoming request and returned a response, it forgets about the client.</p>
<p>To persist to user’s login state, we can implement and use sessions!</p>
<h3 id="configuring-express-to-use-sessions-1">Configuring Express to use sessions</h3>
<p>Install the <code>express-session</code> npm package.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb67-1" title="1"><span class="ex">npm</span> install express-session</a></code></pre></div>
<p>Add a new environment variable named <code>SESSION_SECRET</code> to the <code>.env</code> file:</p>
<pre><code>SESSION_SECRET=f1f079b1-68fe-4324-8010-0a5cff63a288</code></pre>
<p>Don’t forget to update the <code>.env.example</code> file too:</p>
<pre><code>SESSION_SECRET=«strong session secret»</code></pre>
<p>After updating the <code>.env</code> file, update the <code>config</code> module to export a property named <code>sessionSecret</code> initialized to the <code>process.env.SESSION_SECRET</code> property value:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb70-1" title="1"><span class="co">// ./config/index.js</span></a>
<a class="sourceLine" id="cb70-2" title="2"></a>
<a class="sourceLine" id="cb70-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb70-4" title="4">  <span class="dt">environment</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">||</span> <span class="st">&#39;development&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-5" title="5">  <span class="dt">port</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-6" title="6">  <span class="dt">sessionSecret</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">SESSION_SECRET</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-7" title="7">  <span class="dt">db</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb70-8" title="8">    <span class="dt">username</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_USERNAME</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-9" title="9">    <span class="dt">password</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_PASSWORD</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-10" title="10">    <span class="dt">database</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_DATABASE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-11" title="11">    <span class="dt">host</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_HOST</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-12" title="12">  <span class="op">},</span></a>
<a class="sourceLine" id="cb70-13" title="13"><span class="op">};</span></a></code></pre></div>
<p>Now it’s time to add the <code>express-session</code> middleware to the <code>app</code> module Start with importing the <code>express-session</code> module:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb71-1" title="1"><span class="kw">const</span> session <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-session&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Then use the <code>require()</code> function to get the session secret environment variable from the <code>config</code> module:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb72-1" title="1"><span class="kw">const</span> <span class="op">{</span> sessionSecret <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./config&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now you can add the <code>session</code> middleware to the application just after the call to the <code>app.use()</code> method that adds the <code>cookieParser</code> middleware:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb73-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>(sessionSecret))<span class="op">;</span></a>
<a class="sourceLine" id="cb73-2" title="2"><span class="va">app</span>.<span class="at">use</span>(<span class="at">session</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb73-3" title="3">  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;reading-list.sid&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb73-4" title="4">  <span class="dt">secret</span><span class="op">:</span> sessionSecret<span class="op">,</span></a>
<a class="sourceLine" id="cb73-5" title="5">  <span class="dt">resave</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb73-6" title="6">  <span class="dt">saveUninitialized</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb73-7" title="7"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Some things to note about the above code:</p>
<ul>
<li>Notice that the <code>sessionSecret</code> config value is passed to the <code>cookieParser</code> middleware. If your application is using both <code>cookie-parser</code> and <code>express-session</code> they need to use the same <code>secret</code> value.</li>
<li>The <code>name</code> option is set to <code>reading-list.sid</code> so that session cookies for the Reading List application won’t affect any other applications that are using the general <code>localhost</code> domain.</li>
</ul>
<p>Here’s what the top portion of the <code>app</code> module should look like now:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb74-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb74-2" title="2"></a>
<a class="sourceLine" id="cb74-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-4" title="4"><span class="kw">const</span> morgan <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;morgan&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-5" title="5"><span class="kw">const</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cookie-parser&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-6" title="6"><span class="kw">const</span> session <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-session&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-7" title="7"></a>
<a class="sourceLine" id="cb74-8" title="8"><span class="kw">const</span> <span class="op">{</span> sessionSecret <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./config&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-9" title="9"><span class="kw">const</span> bookRoutes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes/book&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-10" title="10"><span class="kw">const</span> userRoutes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes/user&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-11" title="11"></a>
<a class="sourceLine" id="cb74-12" title="12"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb74-13" title="13"></a>
<a class="sourceLine" id="cb74-14" title="14"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-15" title="15"><span class="va">app</span>.<span class="at">use</span>(<span class="at">morgan</span>(<span class="st">&#39;dev&#39;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb74-16" title="16"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>(sessionSecret))<span class="op">;</span></a>
<a class="sourceLine" id="cb74-17" title="17"><span class="va">app</span>.<span class="at">use</span>(<span class="at">session</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb74-18" title="18">  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;reading-list.sid&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-19" title="19">  <span class="dt">secret</span><span class="op">:</span> sessionSecret<span class="op">,</span></a>
<a class="sourceLine" id="cb74-20" title="20">  <span class="dt">resave</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-21" title="21">  <span class="dt">saveUninitialized</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb74-22" title="22"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb74-23" title="23"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>(<span class="op">{</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb74-24" title="24"><span class="va">app</span>.<span class="at">use</span>(bookRoutes)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-25" title="25"><span class="va">app</span>.<span class="at">use</span>(userRoutes)<span class="op">;</span></a>
<a class="sourceLine" id="cb74-26" title="26"></a>
<a class="sourceLine" id="cb74-27" title="27"><span class="co">// Code removed for brevity.</span></a></code></pre></div>
<blockquote>
<p><strong>Note:</strong> Remember that the default in-memory session store (<code>MemoryStore</code>) is only meant for local development. While the in-memory session store works for the purposes of this article, you’d want to replace it with a more robust option (i.e. <code>connect-pg-simple</code> and <code>connect-session-sequelize</code>) before deploying your application to a production environment.</p>
</blockquote>
<h3 id="using-sessions-to-persist-a-users-login-state">Using sessions to persist a user’s login state</h3>
<p>Now that you’ve configured sessions in Express application, you can persist the user’s login state using a session.</p>
<p>Add a new module named <code>auth</code> to the root of your project and add the following code to the module:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb75-1" title="1"><span class="co">// ./auth.js</span></a>
<a class="sourceLine" id="cb75-2" title="2"></a>
<a class="sourceLine" id="cb75-3" title="3"><span class="kw">const</span> loginUser <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> user) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb75-4" title="4">  <span class="va">req</span>.<span class="va">session</span>.<span class="at">auth</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb75-5" title="5">    <span class="dt">userId</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb75-6" title="6">  <span class="op">};</span></a>
<a class="sourceLine" id="cb75-7" title="7"><span class="op">};</span></a>
<a class="sourceLine" id="cb75-8" title="8"></a>
<a class="sourceLine" id="cb75-9" title="9"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb75-10" title="10">  loginUser<span class="op">,</span></a>
<a class="sourceLine" id="cb75-11" title="11"><span class="op">};</span></a></code></pre></div>
<p>Putting all of the authentication related code in its own module helps to keep things organized in the project. It also helps to keep your modules focused on solving a single problem or group of related problems. All of this will improve the readability and maintainability of your project.</p>
<p>Now update the <code>./routes/user</code> module to import the <code>loginUser()</code> function from the <code>auth</code> module:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb76-1" title="1"><span class="kw">const</span> <span class="op">{</span> loginUser <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../auth&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Then within the <code>POST</code> <code>/user/login</code> route handler add a call to the <code>loginUser()</code> function just before redirecting the user to the default route if the password matched:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb77-1" title="1"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb77-2" title="2"></a>
<a class="sourceLine" id="cb77-3" title="3"><span class="cf">if</span> (passwordMatch) <span class="op">{</span></a>
<a class="sourceLine" id="cb77-4" title="4">  <span class="co">// If the password hashes match, then login the user</span></a>
<a class="sourceLine" id="cb77-5" title="5">  <span class="co">// and redirect them to the default route.</span></a>
<a class="sourceLine" id="cb77-6" title="6">  <span class="at">loginUser</span>(req<span class="op">,</span> res<span class="op">,</span> user)<span class="op">;</span></a>
<a class="sourceLine" id="cb77-7" title="7">  <span class="cf">return</span> <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb77-8" title="8"><span class="op">}</span></a></code></pre></div>
<p>You can also login the user after a new user has registered. In the <code>POST</code> <code>/user/register</code> route handler add a call to the <code>loginUser()</code> function after saving the user to the database but before redirecting then to the default route:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb78-1" title="1"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb78-2" title="2"></a>
<a class="sourceLine" id="cb78-3" title="3"><span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb78-4" title="4">  <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb78-5" title="5">  <span class="va">user</span>.<span class="at">hashedPassword</span> <span class="op">=</span> hashedPassword<span class="op">;</span></a>
<a class="sourceLine" id="cb78-6" title="6">  <span class="cf">await</span> <span class="va">user</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb78-7" title="7">  <span class="at">loginUser</span>(req<span class="op">,</span> res<span class="op">,</span> user)<span class="op">;</span></a>
<a class="sourceLine" id="cb78-8" title="8">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb78-9" title="9"><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-10" title="10">  <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb78-11" title="11"><span class="op">}</span></a></code></pre></div>
<p>For your reference, here are the updated <code>POST</code> <code>/user/register</code> and <code>/user/login</code> route handlers:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb79-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/user/register&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> userValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb79-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-3" title="3">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-4" title="4">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb79-5" title="5">      firstName<span class="op">,</span></a>
<a class="sourceLine" id="cb79-6" title="6">      lastName<span class="op">,</span></a>
<a class="sourceLine" id="cb79-7" title="7">      password<span class="op">,</span></a>
<a class="sourceLine" id="cb79-8" title="8">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb79-9" title="9"></a>
<a class="sourceLine" id="cb79-10" title="10">    <span class="kw">const</span> user <span class="op">=</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb79-11" title="11">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb79-12" title="12">      firstName<span class="op">,</span></a>
<a class="sourceLine" id="cb79-13" title="13">      lastName<span class="op">,</span></a>
<a class="sourceLine" id="cb79-14" title="14">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-15" title="15"></a>
<a class="sourceLine" id="cb79-16" title="16">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-17" title="17"></a>
<a class="sourceLine" id="cb79-18" title="18">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb79-19" title="19">      <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-20" title="20">      <span class="va">user</span>.<span class="at">hashedPassword</span> <span class="op">=</span> hashedPassword<span class="op">;</span></a>
<a class="sourceLine" id="cb79-21" title="21">      <span class="cf">await</span> <span class="va">user</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb79-22" title="22">      <span class="at">loginUser</span>(req<span class="op">,</span> res<span class="op">,</span> user)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-23" title="23">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-24" title="24">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-25" title="25">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-26" title="26">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-register&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-27" title="27">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Register&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb79-28" title="28">        user<span class="op">,</span></a>
<a class="sourceLine" id="cb79-29" title="29">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb79-30" title="30">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb79-31" title="31">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb79-33" title="33">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb79-34" title="34"></a>
<a class="sourceLine" id="cb79-35" title="35"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb79-36" title="36"></a>
<a class="sourceLine" id="cb79-37" title="37"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/user/login&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> loginValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb79-38" title="38">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-39" title="39">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-40" title="40">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb79-41" title="41">      password<span class="op">,</span></a>
<a class="sourceLine" id="cb79-42" title="42">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb79-43" title="43"></a>
<a class="sourceLine" id="cb79-44" title="44">    <span class="kw">let</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb79-45" title="45">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-46" title="46"></a>
<a class="sourceLine" id="cb79-47" title="47">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb79-48" title="48">      <span class="co">// Attempt to get the user by their email address.</span></a>
<a class="sourceLine" id="cb79-49" title="49">      <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> emailAddress <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-50" title="50"></a>
<a class="sourceLine" id="cb79-51" title="51">      <span class="cf">if</span> (user <span class="op">!==</span> <span class="kw">null</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb79-52" title="52">        <span class="co">// If the user exists then compare their password</span></a>
<a class="sourceLine" id="cb79-53" title="53">        <span class="co">// to the provided password.</span></a>
<a class="sourceLine" id="cb79-54" title="54">        <span class="kw">const</span> passwordMatch <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">compare</span>(password<span class="op">,</span> <span class="va">user</span>.<span class="va">hashedPassword</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb79-55" title="55"></a>
<a class="sourceLine" id="cb79-56" title="56">        <span class="cf">if</span> (passwordMatch) <span class="op">{</span></a>
<a class="sourceLine" id="cb79-57" title="57">          <span class="co">// If the password hashes match, then login the user</span></a>
<a class="sourceLine" id="cb79-58" title="58">          <span class="co">// and redirect them to the default route.</span></a>
<a class="sourceLine" id="cb79-59" title="59">          <span class="at">loginUser</span>(req<span class="op">,</span> res<span class="op">,</span> user)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-60" title="60">          <span class="cf">return</span> <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-61" title="61">        <span class="op">}</span></a>
<a class="sourceLine" id="cb79-62" title="62">      <span class="op">}</span></a>
<a class="sourceLine" id="cb79-63" title="63"></a>
<a class="sourceLine" id="cb79-64" title="64">      <span class="co">// Otherwise display an error message to the user.</span></a>
<a class="sourceLine" id="cb79-65" title="65">      <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Login failed for the provided email address and password&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-66" title="66">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-67" title="67">      errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-68" title="68">    <span class="op">}</span></a>
<a class="sourceLine" id="cb79-69" title="69"></a>
<a class="sourceLine" id="cb79-70" title="70">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;user-login&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb79-71" title="71">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Login&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb79-72" title="72">      emailAddress<span class="op">,</span></a>
<a class="sourceLine" id="cb79-73" title="73">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb79-74" title="74">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb79-75" title="75">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb79-76" title="76">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<h3 id="testing-user-login-state-persistence">Testing user login state persistence</h3>
<p>Run the application (if it’s not already running) and use the "Register" and "Login" pages to register a new user and login an existing user. Everything should work as it did before, but the user’s login state is being persisted in session.</p>
<p>At this point in the project, there isn’t any visual indication if the user is logged in or not (that’s something that you’ll fix in a bit). If you open the DevTools in Chrome and view the "Application" tab, you can view the cookies for <code>http://localhost:8080</code>. After registering a new user or logging in an existing user, you should see a cookie named <code>reading-list.sid</code>. That’s the session cookie!</p>
<h2 id="restoring-the-authenticated-user-from-session">Restoring the authenticated user from session</h2>
<p>Now that you’re persisting a user’s login state to session, you need to make that user’s information easily accessible to your application when it’s processing requests.</p>
<p>In the <code>auth</code> module, define a middleware function named <code>restoreUser()</code> to retrieve the user’s information from the database if they’re authenticated:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb80-1" title="1"><span class="co">// ./auth.js</span></a>
<a class="sourceLine" id="cb80-2" title="2"></a>
<a class="sourceLine" id="cb80-3" title="3"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb80-4" title="4"></a>
<a class="sourceLine" id="cb80-5" title="5"><span class="kw">const</span> loginUser <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> user) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-6" title="6">  <span class="va">req</span>.<span class="va">session</span>.<span class="at">auth</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-7" title="7">    <span class="dt">userId</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb80-8" title="8">  <span class="op">};</span></a>
<a class="sourceLine" id="cb80-9" title="9"><span class="op">};</span></a>
<a class="sourceLine" id="cb80-10" title="10"></a>
<a class="sourceLine" id="cb80-11" title="11"><span class="kw">const</span> restoreUser <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-12" title="12">  <span class="co">// Log the session object to the console</span></a>
<a class="sourceLine" id="cb80-13" title="13">  <span class="co">// to assist with debugging.</span></a>
<a class="sourceLine" id="cb80-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">req</span>.<span class="at">session</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb80-15" title="15"></a>
<a class="sourceLine" id="cb80-16" title="16">  <span class="cf">if</span> (<span class="va">req</span>.<span class="va">session</span>.<span class="at">auth</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb80-17" title="17">    <span class="kw">const</span> <span class="op">{</span> userId <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="va">session</span>.<span class="at">auth</span><span class="op">;</span></a>
<a class="sourceLine" id="cb80-18" title="18"></a>
<a class="sourceLine" id="cb80-19" title="19">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-20" title="20">      <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">User</span>.<span class="at">findByPk</span>(userId)<span class="op">;</span></a>
<a class="sourceLine" id="cb80-21" title="21"></a>
<a class="sourceLine" id="cb80-22" title="22">      <span class="cf">if</span> (user) <span class="op">{</span></a>
<a class="sourceLine" id="cb80-23" title="23">        <span class="va">res</span>.<span class="va">locals</span>.<span class="at">authenticated</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb80-24" title="24">        <span class="va">res</span>.<span class="va">locals</span>.<span class="at">user</span> <span class="op">=</span> user<span class="op">;</span></a>
<a class="sourceLine" id="cb80-25" title="25">        <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb80-26" title="26">      <span class="op">}</span></a>
<a class="sourceLine" id="cb80-27" title="27">    <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb80-28" title="28">      <span class="va">res</span>.<span class="va">locals</span>.<span class="at">authenticated</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb80-29" title="29">      <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb80-30" title="30">    <span class="op">}</span></a>
<a class="sourceLine" id="cb80-31" title="31">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-32" title="32">    <span class="va">res</span>.<span class="va">locals</span>.<span class="at">authenticated</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb80-33" title="33">    <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb80-34" title="34">  <span class="op">}</span></a>
<a class="sourceLine" id="cb80-35" title="35"><span class="op">};</span></a>
<a class="sourceLine" id="cb80-36" title="36"></a>
<a class="sourceLine" id="cb80-37" title="37"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb80-38" title="38">  loginUser<span class="op">,</span></a>
<a class="sourceLine" id="cb80-39" title="39">  restoreUser<span class="op">,</span></a>
<a class="sourceLine" id="cb80-40" title="40"><span class="op">};</span></a></code></pre></div>
<p>The <code>restoreUser()</code> middleware function starts by logging the <code>req.session</code> object to the console. Doing this will help with testing and debugging.</p>
<p>Then the function checks if the <code>req.session.auth</code> property is defined to determine if there’s an authenticated user. If there is, then it uses destructuring to extract the <code>userId</code> from the <code>req.session.auth</code> property and calls the <code>db.User.findByPk()</code> method to retrieve the user from the database.</p>
<p>If the user is successfully retrieved from the database, then the <code>res.locals</code> object is used to define and set two properties:</p>
<ul>
<li><code>authenticated</code> - Set to <code>true</code> to indicate that the current request has an authenticated user; and</li>
<li><code>user</code> - Set to the user that was just retrieved from the database.</li>
</ul>
<p>The <code>res.locals</code> object is scoped to the current request and available to anything that follows the <code>restoreUser()</code> middleware function, including middleware and route handler functions and any views that are rendered as part of the current request/response cycle. It’s a convenient way to pass values to other middleware, route handlers, or views.</p>
<p>If the <code>req.session.auth</code> property isn’t defined or if the <code>db.User.findByPk()</code> method call throws an error then the <code>res.locals.authenticated</code> property is set to <code>false</code> to indicate that the current request doesn’t have an authenticated user (i.e. it’s an anonymous request).</p>
<p>After defining the <code>restoreUser()</code> function and exporting it from the <code>auth</code> module, you need to import it into the <code>app</code> module:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb81-1" title="1"><span class="kw">const</span> <span class="op">{</span> restoreUser <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./auth&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Then add the <code>restoreUser()</code> middleware function to the application just before the routes are added:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb82-1" title="1"><span class="va">app</span>.<span class="at">use</span>(restoreUser)<span class="op">;</span></a>
<a class="sourceLine" id="cb82-2" title="2"><span class="va">app</span>.<span class="at">use</span>(bookRoutes)<span class="op">;</span></a>
<a class="sourceLine" id="cb82-3" title="3"><span class="va">app</span>.<span class="at">use</span>(userRoutes)<span class="op">;</span></a></code></pre></div>
<p>Retrieving the user’s information from the database on every request, instead of storing the user’s information in the session, ensures that the user’s information doesn’t get stale. While it’s possible to refresh the session if the user were to change their information using the application, using that approach could break if a user can change their information using other means (e.g. a mobile app).</p>
<h3 id="displaying-the-users-login-state">Displaying the user’s login state</h3>
<p>It’s helpful to display to the end user whether or not they’re currently logged in. A common approach is to display login and registration links or a welcome message in the header of the website.</p>
<p>If the user isn’t logged in, they would see links to log in or register:</p>
<blockquote>
<p>Login | Register</p>
</blockquote>
<p>If the user is logged in, they would be welcomed and have access to logging out:</p>
<blockquote>
<p>Welcome «current user name»! | Logout</p>
</blockquote>
<p>To do that, update your <code>./views/layout.pug</code> template to the following:</p>
<pre class="pug"><code>doctype html
html
  head
    meta(charset=&#39;utf-8&#39;)
    meta(name=&#39;viewport&#39; content=&#39;width=device-width, initial-scale=1, shrink-to-fit=no&#39;)
    link(rel=&#39;stylesheet&#39; href=&#39;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css&#39; integrity=&#39;sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh&#39; crossorigin=&#39;anonymous&#39;)
    title Reading List - #{title}
  body
    nav(class=&#39;navbar navbar-expand-lg navbar-dark bg-primary&#39;)
      a(class=&#39;navbar-brand&#39; href=&#39;/&#39;) Reading List
      button(class=&#39;navbar-toggler&#39; type=&#39;button&#39; data-toggle=&#39;collapse&#39; data-target=&#39;#navbarText&#39; aria-controls=&#39;navbarText&#39; aria-expanded=&#39;false&#39; aria-label=&#39;Toggle navigation&#39;)
        span(class=&#39;navbar-toggler-icon&#39;)
      div(class=&#39;collapse navbar-collapse&#39; id=&#39;navbarText&#39;)
        ul(class=&#39;navbar-nav mr-auto&#39;)
          //- Empty menu keeps the content that follows the
          //- unordered list correctly positioned on the
          //- right side of the navbar.
        if locals.authenticated
          span(class=&#39;navbar-text px-4&#39;) Welcome #{user.firstName}!
          form(class=&#39;form-inline pr-4&#39; action=&#39;/user/logout&#39; method=&#39;post&#39;)
            button(class=&#39;btn btn-sm btn-warning&#39; type=&#39;submit&#39;) Logout
        else
          span(class=&#39;navbar-text px-4&#39;)
            a(class=&#39;btn btn-sm btn-dark mr-2&#39; href=&#39;/user/login&#39;) Login
            a(class=&#39;btn btn-sm btn-dark&#39; href=&#39;/user/register&#39;) Register
    .container
      h2(class=&#39;py-4&#39;) #{title}
      block content
    script(src=&#39;https://code.jquery.com/jquery-3.4.1.slim.min.js&#39; integrity=&#39;sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n&#39; crossorigin=&#39;anonymous&#39;) script(src=&#39;https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js&#39; integrity=&#39;sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo&#39; crossorigin=&#39;anonymous&#39;) script(src=&#39;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js&#39; integrity=&#39;sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6&#39; crossorigin=&#39;anonymous&#39;)</code></pre>
<p>A good portion of the new code is related to styling the Bootstrap Navbar component. The section that’s responsible for displaying the user’s login state is this bit:</p>
<pre class="pug"><code>if locals.authenticated
  span(class=&#39;navbar-text px-4&#39;) Welcome #{user.firstName}!
  form(class=&#39;form-inline pr-4&#39; action=&#39;/user/logout&#39; method=&#39;post&#39;)
    button(class=&#39;btn btn-sm btn-warning&#39; type=&#39;submit&#39;) Logout
else
  span(class=&#39;navbar-text px-4&#39;)
    a(class=&#39;btn btn-sm btn-dark mr-2&#39; href=&#39;/user/login&#39;) Login
    a(class=&#39;btn btn-sm btn-dark&#39; href=&#39;/user/register&#39;) Register</code></pre>
<p>Notice that the view is using the <code>locals.authenticated</code> property to determine if the current user is logged in or not. <code>locals</code> within a view is the same object that’s available via <code>res.locals</code>. Remember that the <code>restoreUser</code> function defined in the <code>auth</code> module is responsible for determining if there’s an authenticated user stored in session and defining the initializing the <code>res.locals.authenticated</code> property to the appropriate value.</p>
<p>If the current user isn’t logged in, then links (styled as buttons using Bootstrap CSS classes) are rendered to the "Login" and "Register" pages. If the current user is logged in, then a short, friendly "welcome" message is rendered along with a simple form that contains a single "Logout" submit button.</p>
<p>Now if you run and test your application, you’ll see the current user’s login state displayed in the header! If you log in and click the "Logout" button in the header, you’ll receive a "Page Not Found" error. This is occurring because the <code>POST</code> <code>/user/logout</code> route doesn’t exist. Time to fix that!</p>
<h3 id="implementing-user-logout">Implementing user logout</h3>
<p>Before adding the new route to logout a user, define and export a <code>logoutUser()</code> function in the <code>auth</code> module:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb85-1" title="1"><span class="kw">const</span> logoutUser <span class="op">=</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb85-2" title="2">  <span class="kw">delete</span> <span class="va">req</span>.<span class="va">session</span>.<span class="at">auth</span><span class="op">;</span></a>
<a class="sourceLine" id="cb85-3" title="3"><span class="op">};</span></a></code></pre></div>
<p>The <code>logoutUser()</code> function uses the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/delete">JavaScript <code>delete</code> operator</a> to remove the <code>auth</code> property from the <code>req.session</code> object which destroys the user’s persisted login state.</p>
<p>Now you’re ready to add the <code>POST</code> <code>/user/logout</code> to the <code>./routes/user</code> module to process <code>POST</code> requests from the logout form. Start by importing the <code>logoutUser()</code> function from the <code>auth</code> module:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb86-1" title="1"><span class="kw">const</span> <span class="op">{</span> loginUser<span class="op">,</span> logoutUser <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../auth&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Then add the new route:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb87-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/user/logout&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb87-2" title="2">  <span class="at">logoutUser</span>(req<span class="op">,</span> res)<span class="op">;</span></a>
<a class="sourceLine" id="cb87-3" title="3">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/user/login&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb87-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Notice that the route doesn’t use the <code>csrfProtection</code> middleware. The <code>POST</code> <code>/user/logout</code> route isn’t modifying any of the user’s data in the database, so for simplicity’s sake the route isn’t requiring a valid CSRF token to be present on the request.</p>
<p>After calling the <code>logoutUser()</code> function to logout the user, the user is redirected to the <code>/user/login</code> route. In some situations, it’d be more appropriate to redirect the user to the default route, but in just a bit you’re going to update the default route to only be visible if the current user is logged in. Given that, it’s a better option to redirect the user to the "Login" page.</p>
<h3 id="testing-the-latest-changes">Testing the latest changes</h3>
<p>Run the application (if it’s not already running) and use the "Login" page to login an existing user. After logging into the website, you should now see the user’s first name displayed in the header.</p>
<p>Remember that the <code>restoreUser()</code> function logs the <code>req.session</code> object to the console. After logging in, you should see something like this logged to the console:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb88-1" title="1"><span class="ex">Session</span> {</a>
<a class="sourceLine" id="cb88-2" title="2">  <span class="ex">cookie</span>: { path: <span class="st">&#39;/&#39;</span>, _expires: null, originalMaxAge: null, httpOnly: true },</a>
<a class="sourceLine" id="cb88-3" title="3">  <span class="ex">auth</span>: { userId: 1 }</a>
<a class="sourceLine" id="cb88-4" title="4">}</a></code></pre></div>
<p>The <code>session.auth.userId</code> property value is the user ID of the currently logged in user.</p>
<p>Now if you click the "Logout" button, you’ll be redirected to the "Login" page. In the console you’ll see that the <code>session.auth</code> property is no longer defined on the <code>session</code> object:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb89-1" title="1"><span class="ex">Session</span> {</a>
<a class="sourceLine" id="cb89-2" title="2">  <span class="ex">cookie</span>: { path: <span class="st">&#39;/&#39;</span>, _expires: null, originalMaxAge: null, httpOnly: true }</a>
<a class="sourceLine" id="cb89-3" title="3">}</a></code></pre></div>
<h2 id="protecting-a-route">Protecting a route</h2>
<p>Now that the Reading List application supports user self-registration and login, it’s time to restrict access to the routes that should only be accessible to authenticated users.</p>
<p>For some applications, you might need to restrict access to one or two routes. For the Reading List application, you’ll restrict access to all of the routes in the <code>./routes/book</code> module so that the user needs to log in view their list of books (in just a bit you’ll update the <code>Book</code> model so that each book record will be associated with a user) or to add, update, or delete a book.</p>
<h3 id="defining-a-middleware-function-to-require-an-authenticated-user">Defining a middleware function to require an authenticated user</h3>
<p>Add a new function named <code>requireAuth()</code> to the <code>auth</code> module. Update the <code>requireAuth()</code> function to redirect the user to the "Login" page if the <code>res.locals.authenticated</code> property is set to <code>false</code>, otherwise pass control to the next middleware function by calling the <code>next()</code> method:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb90-1" title="1"><span class="co">// ./auth.js</span></a>
<a class="sourceLine" id="cb90-2" title="2"></a>
<a class="sourceLine" id="cb90-3" title="3"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb90-4" title="4"></a>
<a class="sourceLine" id="cb90-5" title="5"><span class="kw">const</span> loginUser <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> user) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb90-6" title="6">  <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb90-7" title="7"><span class="op">};</span></a>
<a class="sourceLine" id="cb90-8" title="8"></a>
<a class="sourceLine" id="cb90-9" title="9"><span class="kw">const</span> logoutUser <span class="op">=</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb90-10" title="10">  <span class="kw">delete</span> <span class="va">req</span>.<span class="va">session</span>.<span class="at">auth</span><span class="op">;</span></a>
<a class="sourceLine" id="cb90-11" title="11"><span class="op">};</span></a>
<a class="sourceLine" id="cb90-12" title="12"></a>
<a class="sourceLine" id="cb90-13" title="13"><span class="kw">const</span> requireAuth <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb90-14" title="14">  <span class="cf">if</span> (<span class="op">!</span><span class="va">res</span>.<span class="va">locals</span>.<span class="at">authenticated</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb90-15" title="15">    <span class="cf">return</span> <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/user/login&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb90-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb90-17" title="17">  <span class="cf">return</span> <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb90-18" title="18"><span class="op">};</span></a>
<a class="sourceLine" id="cb90-19" title="19"></a>
<a class="sourceLine" id="cb90-20" title="20"><span class="kw">const</span> restoreUser <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb90-21" title="21">  <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb90-22" title="22"><span class="op">};</span></a>
<a class="sourceLine" id="cb90-23" title="23"></a>
<a class="sourceLine" id="cb90-24" title="24"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb90-25" title="25">  loginUser<span class="op">,</span></a>
<a class="sourceLine" id="cb90-26" title="26">  logoutUser<span class="op">,</span></a>
<a class="sourceLine" id="cb90-27" title="27">  requireAuth<span class="op">,</span></a>
<a class="sourceLine" id="cb90-28" title="28">  restoreUser<span class="op">,</span></a>
<a class="sourceLine" id="cb90-29" title="29"><span class="op">};</span></a></code></pre></div>
<p>Import the <code>requireAuth</code> function into the <code>./routes/book</code> module:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb91-1" title="1"><span class="kw">const</span> <span class="op">{</span> requireAuth <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../auth&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Then add the <code>requireAuth</code> to every route:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb92-1" title="1"><span class="co">// ./routes/book.js</span></a>
<a class="sourceLine" id="cb92-2" title="2"></a>
<a class="sourceLine" id="cb92-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb92-4" title="4"><span class="kw">const</span> <span class="op">{</span> check<span class="op">,</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-validator&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb92-5" title="5"></a>
<a class="sourceLine" id="cb92-6" title="6"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb92-7" title="7"><span class="kw">const</span> <span class="op">{</span> csrfProtection<span class="op">,</span> asyncHandler <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./utils&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb92-8" title="8"><span class="kw">const</span> <span class="op">{</span> requireAuth <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../auth&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb92-9" title="9"></a>
<a class="sourceLine" id="cb92-10" title="10"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb92-11" title="11"></a>
<a class="sourceLine" id="cb92-12" title="12"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb92-13" title="13">  <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-14" title="14"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb92-15" title="15"></a>
<a class="sourceLine" id="cb92-16" title="16"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb92-17" title="17">  <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-18" title="18"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb92-19" title="19"></a>
<a class="sourceLine" id="cb92-20" title="20"><span class="kw">const</span> bookValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb92-21" title="21">  <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-22" title="22">]<span class="op">;</span></a>
<a class="sourceLine" id="cb92-23" title="23"></a>
<a class="sourceLine" id="cb92-24" title="24"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb92-25" title="25">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb92-26" title="26">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-27" title="27">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb92-28" title="28"></a>
<a class="sourceLine" id="cb92-29" title="29"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/edit/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb92-30" title="30">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb92-31" title="31">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-32" title="32">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb92-33" title="33"></a>
<a class="sourceLine" id="cb92-34" title="34"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/edit/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb92-35" title="35">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb92-36" title="36">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-37" title="37">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb92-38" title="38"></a>
<a class="sourceLine" id="cb92-39" title="39"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/delete/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> </a>
<a class="sourceLine" id="cb92-40" title="40">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb92-41" title="41">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-42" title="42">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb92-43" title="43"></a>
<a class="sourceLine" id="cb92-44" title="44"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/delete/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> </a>
<a class="sourceLine" id="cb92-45" title="45">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb92-46" title="46">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb92-47" title="47">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb92-48" title="48"></a>
<a class="sourceLine" id="cb92-49" title="49"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Run the application (if it’s not already running) and browse to the default route (<code>/</code>). You’ll be redirected to the "Login" page. Go ahead and login using an existing account. After logging in, you’ll be redirected to the default route (<code>/</code>) to view your list of books.</p>
<h2 id="associating-data-with-a-user">Associating data with a user</h2>
<p>Now that you’ve restricted access to all of the book related routes so that a logged or authenticated user is required, you can update the <code>Book</code> model so that each book record will be associated with a user.</p>
<h3 id="defining-an-association">Defining an association</h3>
<p>To start, run the following command in a terminal from the root of your project to remove all of the seed data from the database:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb93-1" title="1"><span class="ex">npx</span> dotenv sequelize db:seed:undo:all</a></code></pre></div>
<p>Then update the <code>Book</code> and <code>User</code> models as follows:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb94-1" title="1"><span class="co">// ./db/models/book.js</span></a>
<a class="sourceLine" id="cb94-2" title="2"></a>
<a class="sourceLine" id="cb94-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb94-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb94-5" title="5">  <span class="kw">const</span> Book <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Book&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb94-6" title="6">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb94-7" title="7">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb94-8" title="8">  <span class="va">Book</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb94-9" title="9">    <span class="va">Book</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">User</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb94-10" title="10">      <span class="dt">as</span><span class="op">:</span> <span class="st">&#39;user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb94-11" title="11">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;userId&#39;</span></a>
<a class="sourceLine" id="cb94-12" title="12">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb94-13" title="13">  <span class="op">};</span></a>
<a class="sourceLine" id="cb94-14" title="14">  <span class="cf">return</span> Book<span class="op">;</span></a>
<a class="sourceLine" id="cb94-15" title="15"><span class="op">};</span></a></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb95-1" title="1"><span class="co">// ./db/models/user.js</span></a>
<a class="sourceLine" id="cb95-2" title="2"></a>
<a class="sourceLine" id="cb95-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb95-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb95-5" title="5">  <span class="kw">const</span> User <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;User&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb95-6" title="6">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb95-7" title="7">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb95-8" title="8">  <span class="va">User</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb95-9" title="9">    <span class="va">User</span>.<span class="at">hasMany</span>(<span class="va">models</span>.<span class="at">Book</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb95-10" title="10">      <span class="dt">as</span><span class="op">:</span> <span class="st">&#39;books&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb95-11" title="11">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;userId&#39;</span></a>
<a class="sourceLine" id="cb95-12" title="12">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb95-13" title="13">  <span class="op">};</span></a>
<a class="sourceLine" id="cb95-14" title="14">  <span class="cf">return</span> User<span class="op">;</span></a>
<a class="sourceLine" id="cb95-15" title="15"><span class="op">};</span></a></code></pre></div>
<p>Updating the models in this way creates a one-to-many association between the <code>User</code> and <code>Book</code> models (i.e. a user can have one or more books).</p>
<p>After defining the association in the models, you need to create a new migration to add the a foreign key column to the <code>Books</code> table in the database. Run the following command to add a skeleton migration file:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb96-1" title="1"><span class="ex">npx</span> sequelize migration:generate --name update-book</a></code></pre></div>
<p>Then update the contents of the <code>./db/migrations/[timestamp]-update-book.js</code> file to this:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb97-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb97-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb97-3" title="3">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb97-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">addColumn</span>(<span class="st">&#39;Book&#39;</span><span class="op">,</span> <span class="st">&#39;userId&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb97-5" title="5">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb97-6" title="6">      <span class="dt">references</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb97-7" title="7">        <span class="dt">model</span><span class="op">:</span> <span class="st">&#39;Users&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb97-8" title="8">        <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;id&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb97-9" title="9">      <span class="op">},</span></a>
<a class="sourceLine" id="cb97-10" title="10">      <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb97-11" title="11">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb97-12" title="12">  <span class="op">},</span></a>
<a class="sourceLine" id="cb97-13" title="13">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb97-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb97-15" title="15"><span class="op">};</span></a></code></pre></div>
<p>The above migration uses the <code>queryInterface.addColumn()</code> method to add a new column to the <code>Books</code> table. In this specific case, you’re adding a column named <code>userId</code> that’s a foreign key to the <code>Users</code> table <code>id</code> column.</p>
<p>Now apply the pending migration:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb98-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate</a></code></pre></div>
<h3 id="updating-the-seed-data">Updating the seed data</h3>
<p>Open the <code>./db/seeders/[timestamp]-test-data.js</code> file and update its contents to this:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb99-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb99-2" title="2"></a>
<a class="sourceLine" id="cb99-3" title="3"><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;bcryptjs&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb99-4" title="4"></a>
<a class="sourceLine" id="cb99-5" title="5"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb99-6" title="6">  <span class="dt">up</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb99-7" title="7">    <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(<span class="st">&#39;Users&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb99-8" title="8">      <span class="op">{</span></a>
<a class="sourceLine" id="cb99-9" title="9">        <span class="dt">emailAddress</span><span class="op">:</span> <span class="st">&#39;john@smith.com&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-10" title="10">        <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;John&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-11" title="11">        <span class="dt">lastName</span><span class="op">:</span> <span class="st">&#39;Smith&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-12" title="12">        <span class="dt">hashedPassword</span><span class="op">:</span> <span class="va">bcrypt</span>.<span class="at">hashSync</span>(<span class="st">&#39;P@ssw0rd&#39;</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb99-13" title="13">        <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb99-14" title="14">        <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb99-15" title="15">      <span class="op">}</span></a>
<a class="sourceLine" id="cb99-16" title="16">    ]<span class="op">,</span> <span class="op">{</span> <span class="dt">returning</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb99-17" title="17"></a>
<a class="sourceLine" id="cb99-18" title="18">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(<span class="st">&#39;Books&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb99-19" title="19">      <span class="op">{</span></a>
<a class="sourceLine" id="cb99-20" title="20">        <span class="dt">userId</span><span class="op">:</span> users[<span class="dv">0</span>].<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-21" title="21">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;The Martian&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-22" title="22">        <span class="dt">author</span><span class="op">:</span> <span class="st">&#39;Andy Weir&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-23" title="23">        <span class="dt">releaseDate</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>(<span class="st">&#39;2014-02-11&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb99-24" title="24">        <span class="dt">pageCount</span><span class="op">:</span> <span class="dv">384</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-25" title="25">        <span class="dt">publisher</span><span class="op">:</span> <span class="st">&#39;Crown&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-26" title="26">        <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb99-27" title="27">        <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb99-28" title="28">      <span class="op">},</span></a>
<a class="sourceLine" id="cb99-29" title="29">      <span class="op">{</span></a>
<a class="sourceLine" id="cb99-30" title="30">        <span class="dt">userId</span><span class="op">:</span> users[<span class="dv">0</span>].<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-31" title="31">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Ready Player One&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-32" title="32">        <span class="dt">author</span><span class="op">:</span> <span class="st">&#39;Ernest Cline&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-33" title="33">        <span class="dt">releaseDate</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>(<span class="st">&#39;2011-08-16&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb99-34" title="34">        <span class="dt">pageCount</span><span class="op">:</span> <span class="dv">384</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-35" title="35">        <span class="dt">publisher</span><span class="op">:</span> <span class="st">&#39;Crown&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-36" title="36">        <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb99-37" title="37">        <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb99-38" title="38">      <span class="op">},</span></a>
<a class="sourceLine" id="cb99-39" title="39">      <span class="op">{</span></a>
<a class="sourceLine" id="cb99-40" title="40">        <span class="dt">userId</span><span class="op">:</span> users[<span class="dv">0</span>].<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-41" title="41">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Harry Potter and the Sorcerer</span><span class="sc">\&#39;</span><span class="st">s Stone&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-42" title="42">        <span class="dt">author</span><span class="op">:</span> <span class="st">&#39;J.K. Rowling&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-43" title="43">        <span class="dt">releaseDate</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>(<span class="st">&#39;1998-10-01&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb99-44" title="44">        <span class="dt">pageCount</span><span class="op">:</span> <span class="dv">309</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-45" title="45">        <span class="dt">publisher</span><span class="op">:</span> <span class="st">&#39;Scholastic Press&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb99-46" title="46">        <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb99-47" title="47">        <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb99-48" title="48">      <span class="op">},</span></a>
<a class="sourceLine" id="cb99-49" title="49">    ]<span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb99-50" title="50">  <span class="op">},</span></a>
<a class="sourceLine" id="cb99-51" title="51">  <span class="dt">down</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb99-52" title="52">    <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&#39;Books&#39;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb99-53" title="53">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&#39;Users&#39;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb99-54" title="54">  <span class="op">}</span></a>
<a class="sourceLine" id="cb99-55" title="55"><span class="op">};</span></a></code></pre></div>
<p>An additional call to the <code>queryInterface.bulkInsert()</code> method has been added to seed a test user, "John Smith", into the <code>Users</code> database table. Notice that an object literal has been supplied to the <code>queryInterface.bulkInsert()</code> method to specify the <code>returning</code> option. The <code>returning</code> optional configures the bulk insert to return the newly inserted data. This gives you a way to set the <code>userId</code> foreign key column when bulk inserting the test data into the <code>Books</code> table.</p>
<p>To seed the database, run the following command:</p>
<pre><code>npx dotenv sequelize db:seed:all</code></pre>
<h3 id="updating-the-book-related-routes">Updating the book related routes</h3>
<p>Now that books are associated with a user, you can update the default route to retrieve the list of books for the currently authenticated user:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb101-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-2" title="2">  <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> <span class="dt">userId</span><span class="op">:</span> <span class="va">res</span>.<span class="va">locals</span>.<span class="va">user</span>.<span class="at">id</span> <span class="op">},</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb101-3" title="3">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-list&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Books&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb101-4" title="4"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>The options object passed into the <code>db.Book.findAll()</code> method call has been updated with a <code>where</code> property. The <code>where</code> property is set to an object literal that defines the properties to filter the query results by. In this case, you’re filtering by the <code>userId</code> column, using the <code>res.locals.user.id</code> property value.</p>
<p>When users initially create an account, they won’t have any books in their reading list. You can update the <code>book-list</code> view to display a friendly message when that occurs:</p>
<pre class="pug"><code>// ./views/book-list.pug

extends layout.pug

block content
  div(class=&#39;py-3&#39;)
    a(class=&#39;btn btn-success&#39; href=&#39;/book/add&#39; role=&#39;button&#39;) Add Book
  if books &amp;&amp; books.length &gt; 0
    table(class=&#39;table table-striped table-hover&#39;)
      thead(class=&#39;thead-dark&#39;)
        tr
          th(scope=&#39;col&#39;) Title
          th(scope=&#39;col&#39;) Author
          th(scope=&#39;col&#39;) Release Date
          th(scope=&#39;col&#39;) Page Count
          th(scope=&#39;col&#39;) Publisher
          th(scope=&#39;col&#39;)
      tbody
        each book in books
          tr
            td= book.title
            td= book.author
            td= book.releaseDate
            td= book.pageCount
            td= book.publisher
            td
              a(class=&#39;btn btn-primary&#39; href=`/book/edit/${book.id}` role=&#39;button&#39;) Edit
              a(class=&#39;btn btn-danger ml-2&#39; href=`/book/delete/${book.id}` role=&#39;button&#39;) Delete
  else
    p: em You don&#39;t have any books in your reading list!</code></pre>
<p>When a user adds a new book, you need to update the book’s <code>userId</code> property with the authenticated user’s <code>id</code>:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb103-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb103-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb103-3" title="3">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb103-4" title="4">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb103-5" title="5">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb103-6" title="6">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb103-7" title="7">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb103-8" title="8">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb103-9" title="9">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb103-10" title="10"></a>
<a class="sourceLine" id="cb103-11" title="11">    <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb103-12" title="12">      <span class="dt">userId</span><span class="op">:</span> <span class="va">res</span>.<span class="va">locals</span>.<span class="va">user</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb103-13" title="13">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb103-14" title="14">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb103-15" title="15">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb103-16" title="16">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb103-17" title="17">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb103-18" title="18">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb103-19" title="19"></a>
<a class="sourceLine" id="cb103-20" title="20">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb103-21" title="21"></a>
<a class="sourceLine" id="cb103-22" title="22">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb103-23" title="23">      <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb103-24" title="24">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb103-25" title="25">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb103-26" title="26">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb103-27" title="27">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb103-28" title="28">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb103-29" title="29">        book<span class="op">,</span></a>
<a class="sourceLine" id="cb103-30" title="30">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb103-31" title="31">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb103-32" title="32">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb103-33" title="33">    <span class="op">}</span></a>
<a class="sourceLine" id="cb103-34" title="34">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>And lastly, you need to ensure that the current can only edit or delete their own books. To be clear, as long as the user uses the application’s user interface to edit and delete books, this would never be an issue. This situation would only arise if a user maliciously edited their current URL to attempt to edit or delete a book that belonged to another user.</p>
<p>Luckily, this issue is easy to prevent. In the <code>./routes/book</code> module, add the following function above the route definitions:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb104-1" title="1"><span class="kw">const</span> checkPermissions <span class="op">=</span> (book<span class="op">,</span> currentUser) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb104-2" title="2">  <span class="cf">if</span> (<span class="va">book</span>.<span class="at">userId</span> <span class="op">!==</span> <span class="va">currentUser</span>.<span class="at">id</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb104-3" title="3">    <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;Illegal operation.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb104-4" title="4">    <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">403</span><span class="op">;</span> <span class="co">// Forbidden</span></a>
<a class="sourceLine" id="cb104-5" title="5">    <span class="cf">throw</span> err<span class="op">;</span></a>
<a class="sourceLine" id="cb104-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb104-7" title="7"><span class="op">};</span></a></code></pre></div>
<p>The <code>checkPermissions()</code> function accepts a book and current user and throws an error if the book’s associated user doesn’t match the current user.</p>
<p>Then update each of the edit and delete routes to call the <code>checkPermissions()</code> function:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb105-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/edit/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb105-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-3" title="3">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-4" title="4">    <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-5" title="5"></a>
<a class="sourceLine" id="cb105-6" title="6">    <span class="at">checkPermissions</span>(book<span class="op">,</span> <span class="va">res</span>.<span class="va">locals</span>.<span class="at">user</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-7" title="7"></a>
<a class="sourceLine" id="cb105-8" title="8">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-edit&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-9" title="9">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Edit Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb105-10" title="10">      book<span class="op">,</span></a>
<a class="sourceLine" id="cb105-11" title="11">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb105-12" title="12">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-13" title="13">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb105-14" title="14"></a>
<a class="sourceLine" id="cb105-15" title="15"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/edit/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb105-16" title="16">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-17" title="17">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-18" title="18">    <span class="kw">const</span> bookToUpdate <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-19" title="19"></a>
<a class="sourceLine" id="cb105-20" title="20">    <span class="at">checkPermissions</span>(bookToUpdate<span class="op">,</span> <span class="va">res</span>.<span class="va">locals</span>.<span class="at">user</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-21" title="21"></a>
<a class="sourceLine" id="cb105-22" title="22">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-23" title="23">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb105-24" title="24">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb105-25" title="25">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb105-26" title="26">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb105-27" title="27">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb105-28" title="28">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb105-29" title="29"></a>
<a class="sourceLine" id="cb105-30" title="30">    <span class="kw">const</span> book <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-31" title="31">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb105-32" title="32">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb105-33" title="33">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb105-34" title="34">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb105-35" title="35">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb105-36" title="36">    <span class="op">};</span></a>
<a class="sourceLine" id="cb105-37" title="37"></a>
<a class="sourceLine" id="cb105-38" title="38">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-39" title="39"></a>
<a class="sourceLine" id="cb105-40" title="40">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb105-41" title="41">      <span class="cf">await</span> <span class="va">bookToUpdate</span>.<span class="at">update</span>(book)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-42" title="42">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-43" title="43">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-44" title="44">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-45" title="45">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-edit&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-46" title="46">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Edit Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb105-47" title="47">        <span class="dt">book</span><span class="op">:</span> <span class="op">{</span> ...<span class="at">book</span><span class="op">,</span> bookId <span class="op">},</span></a>
<a class="sourceLine" id="cb105-48" title="48">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb105-49" title="49">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb105-50" title="50">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-51" title="51">    <span class="op">}</span></a>
<a class="sourceLine" id="cb105-52" title="52">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb105-53" title="53"></a>
<a class="sourceLine" id="cb105-54" title="54"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/delete/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb105-55" title="55">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-56" title="56">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-57" title="57">    <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-58" title="58"></a>
<a class="sourceLine" id="cb105-59" title="59">    <span class="at">checkPermissions</span>(book<span class="op">,</span> <span class="va">res</span>.<span class="va">locals</span>.<span class="at">user</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-60" title="60"></a>
<a class="sourceLine" id="cb105-61" title="61">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-delete&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-62" title="62">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Delete Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb105-63" title="63">      book<span class="op">,</span></a>
<a class="sourceLine" id="cb105-64" title="64">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb105-65" title="65">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-66" title="66">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb105-67" title="67"></a>
<a class="sourceLine" id="cb105-68" title="68"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/delete/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb105-69" title="69">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb105-70" title="70">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-71" title="71">    <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-72" title="72"></a>
<a class="sourceLine" id="cb105-73" title="73">    <span class="at">checkPermissions</span>(book<span class="op">,</span> <span class="va">res</span>.<span class="va">locals</span>.<span class="at">user</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-74" title="74"></a>
<a class="sourceLine" id="cb105-75" title="75">    <span class="cf">await</span> <span class="va">book</span>.<span class="at">destroy</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb105-76" title="76">    <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb105-77" title="77">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<h3 id="testing-one-more-time">Testing one more time</h3>
<p>Now you’re ready to do your final testing!</p>
<p>Login using the test user that you defined in your seed data. You should see the test user’s list of books. Now logout the test user and login as another user. You should now see that user’s list of books. If the user doesn’t have any books in their reading list, add a new book. You should now only be seeing this user’s books.</p>
<p>Congrats on completing the Reading List application… now with authentication!</p>
<h2 id="the-importance-of-using-https">The importance of using HTTPS</h2>
<p>As a reminder, form fields are submitted in clear text to the server! This means that passwords can be <em>sniffed</em> or hijacked if the communication between the client and the server isn’t encrypted. This brings us to why HTTPS (hypertext transfer protocol secure) is important. HTTP uses a digital certificate for authentication known as an SSL certificate to make a web application more secure. TSL and SSL protocol are often lumped together, as TLS is another protocol that encrypts communication between the client and server.</p>
<p>The use of HTTPS instead of HTTP means that TSL/SSL encryption is being used to keep form posts away from prying eyes!</p>
<p>In order to implement HTTPS, a domain requires an SSL certificate. SSL certificates can be purchased from companies that verify your identity so that you can be issued you a certificate for your domain. Once you have the certificate (which is simply a digital file), you then install the certificate on the server.</p>
<p>Typically, this server isn’t your Node or Express application, but another web server that serves as a proxy server for your application. A proxy server receives all of the HTTP requests from the internet to your application’s domain and forwards those requests to your application. Your application will then send responses to the proxy server, which then forwards them on to the client.</p>
<h2 id="next-steps">Next steps</h2>
<p>There’s so much more to learn about authentication! For example, it is important to know about implementing user roles as well as other user authentication flows. Examples of other user authentication processes include email confirmation, allowing users to reset their password, and two-factor authentication.</p>
<p>You’ll dive into more components of user authentication as you learn more about web security and authentication!</p>
<hr />
<h1 id="project-amusement-park-tracker-with-authentication">Project: Amusement Park Tracker with Authentication</h1>
<p>This project picks up where the first Amusement Park Tracker project left off! In the provided starter project, you can view, create, update, and delete both parks and attractions. In this project you’ll extend the provided application with the following features:</p>
<ul>
<li>User self-registration and login; and</li>
<li>Ability for users to record visits to park attractions.</li>
</ul>
<h2 id="phase-0-download-the-starter-project">Phase 0: Download the starter project</h2>
<p>Clone the starter project:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb106-1" title="1"><span class="fu">git</span> clone https://github.com/-starters/express-amusement-park-tracker-with-auth.git</a></code></pre></div>
<p>Then complete the following set up steps:</p>
<ul>
<li>Create the database and limited access database user;</li>
<li>Add an <code>.env</code> file containing the variables from the <code>.env.example</code> file;</li>
<li>Install the project’s dependencies (<code>npm install</code>); and</li>
<li>Use the Sequelize CLI to apply the provided database migrations and seeder.</li>
</ul>
<p>Now you can start (<code>npm start</code>) and test the application!</p>
<h2 id="phase-1-create-the-user-model">Phase 1: Create the User model</h2>
<p>The <code>User</code> model should include the following properties:</p>
<ul>
<li><code>emailAddress</code> - A non-nullable string (length: 255) representing the user’s email address;</li>
<li><code>firstName</code> - A non-nullable string (length: 50) representing the user’s first name;</li>
<li><code>lastName</code> - A non-nullable string (length: 50) representing the user’s last name; and</li>
<li><code>hashedPassword</code> - A non-nullable binary string representing the user’s hashed password.</li>
</ul>
<p>Use the Sequelize CLI to generate the <code>User</code> model and migration. Then edit both files to use the expected attribute and column configuration. Remember to make the <code>hashedPassword</code> attribute have a datatype of <code>STRING.BINARY</code>.</p>
<p>Apply the migration when you’re ready.</p>
<h2 id="phase-2-configure-express-to-use-sessions">Phase 2: Configure Express to use sessions</h2>
<p>Take a moment to install:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb107-1" title="1"><span class="ex">npm</span> install express-session</a></code></pre></div>
<p>Now let’s configure your session store. Add the <code>express-session</code> middleware to the <code>app</code> module:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb108-1" title="1"><span class="kw">const</span> session <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-session&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Make sure you have required <code>session</code> from the <code>express-session</code> package and have your application use the session. Make sure you configure the session with both <code>resave</code> and <code>saveUninitialized</code> set to <code>false</code>.</p>
<p>Take a moment set a <code>SESSION_SECRET</code> environment variable in your <code>.env</code> file. Add a key of <code>sessionSecret</code> connected to the <code>process.env.SESSION_SECRET</code> in your <code>./config/index.js</code> module as well. As a reminder, you can generate a <a href="https://www.npmjs.com/package/uuid">UUID</a> to have a more secure <code>sessionSecret</code> variable value.</p>
<p>In the <code>app</code> module, make sure to also import the <code>sessionSecret</code> in your <code>./config</code> require statement. As a reminder, be sure to use the same <code>secret</code> value for the <code>express-session</code> and <code>cookie-parser</code> middleware.</p>
<p>Your session should be configured like so:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb109-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="at">session</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb109-2" title="2">  <span class="dt">secret</span><span class="op">:</span> sessionSecret<span class="op">,</span> </a>
<a class="sourceLine" id="cb109-3" title="3">  <span class="dt">resave</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> </a>
<a class="sourceLine" id="cb109-4" title="4">  <span class="dt">saveUninitialized</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb109-5" title="5"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<h2 id="phase-3-support-user-self-registration">Phase 3: Support user self-registration</h2>
<p>Now it’s time to add the user registration form.</p>
<p>Begin by creating a <code>./routes/user</code> module. Import <code>express</code> and instantiate a <code>router</code> with <code>express.Router()</code>. Import your <code>db</code> from your <code>../db/models</code> and create <code>GET</code> and <code>POST</code> routes for the "Register" page (<code>/user/register</code>). Make sure to use CSRF protection as well the <code>bcryptjs</code> npm package to hash user passwords. Lastly, don’t forget to export the router module you have just created.</p>
<p>Take note that you already have a <code>routes/utils.js</code> module that holds utility functions like the <code>csrfProtection</code> and <code>asyncHandler</code> methods you are familiar with. Import both of these methods into your <code>./routes/user</code> module with a require statement to the <code>./utils</code> module like so:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb110-1" title="1"><span class="kw">const</span> <span class="op">{</span> csrfProtection<span class="op">,</span> asyncHandler <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./utils&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now you can use your <code>csrfProtection</code> and <code>asyncHandler</code> in your <code>./routes/user</code> module!</p>
<p>In your GET <code>/user/register</code> route, use <code>db.User.build()</code> to initialize a new user to pass into the <code>user-register</code> view. Make sure to also pass in a <code>title</code> for your "Register" page as well as a <code>csrfToken</code> (with a value of <code>req.csrfToken()</code>). Add <code>csrfProtection</code> to your route, and let’s create your <code>user-register</code> template.</p>
<p>Render a template that extends the main layout and has a form within <code>block content</code>. Take note of the mixins in the <code>utils.pug</code> file that are available for you to use. The form should contain the following input fields:</p>
<ul>
<li>First Name</li>
<li>Last Name</li>
<li>Email Address</li>
<li>Password</li>
<li>Confirm Password</li>
</ul>
<p>Don’t forget to have a hidden input field for your <code>_csrf</code> field as well as a submit button. Once you have your view set up, let’s create your POST route for user registration!</p>
<p>In your POST <code>/user/register</code> route, make sure to use <code>userValidators</code> in addition to your <code>csrfProtection</code> middleware. This means you’ll need to import <code>check</code> and <code>validationResult</code> from <code>express-validator</code>.</p>
<p>At this moment, implement the following validation rules:</p>
<ul>
<li><code>firstName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul></li>
<li><code>lastName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul></li>
<li><code>emailAddress</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 255 characters</li>
<li>Is a valid email address</li>
<li>Should not be in use by an existing account</li>
</ul></li>
<li><code>password</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
<li>Should contain at least 1 lowercase letter, uppercase letter, number, and special character (i.e. "!@#$%^&amp;*") Hint: review the <em>Implementing Session-Based Authentication</em> reading and see below for reminders on how to <a href="https://www.thepolyglotdeveloper.com/2015/05/use-regex-to-test-password-strength-in-javascript/">use regex</a> for validation!</li>
</ul></li>
<li><code>confirmPassword</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
<li>Should match the provided <code>password</code> value</li>
</ul></li>
</ul>
<h3 id="regex-reminders">Regex Reminders</h3>
<ul>
<li>The hat operator <code>^</code> is used to start matching at the beginning of the password.</li>
<li>The expression <code>(?=.*[a-z])</code> is used to check that the password contains at least one lowercase character.</li>
<li>The expression <code>(?=.*[A-Z])</code> is used to check that the password contains at least one uppercase character.</li>
<li>The expression <code>(?=.*[0-9])</code> is used to check that the password contains at least one numeric character.</li>
<li>The expression <code>(?=.*[!@#$%^&amp;*])</code> is used to check that the password contains at least one special character.</li>
</ul>
<p>Now return to your POST route and wrap your asynchronous route function with your <code>asyncHandler</code> so that you can <code>await</code> certain processes in your route. Begin by destructuring the <code>emailAddress</code>, <code>firstName</code>, <code>lastName</code>, and <code>password</code> from your <code>req.body</code> object. Then use the <code>emailAddress</code>, <code>firstName</code>, and <code>lastName</code> variables (but not the <code>password</code> variable) to build a user with the <code>db.User.build()</code> method.</p>
<p>At this point, generate your <code>validatorErrors</code> within your route by using the <code>validationResult</code> method from <code>express-validator</code>. If the <code>validatorErrors</code> are empty, <code>await</code> the generation of your <code>hashedPassword</code> created with <code>bcrypt.hash()</code>. Make sure import <code>bcrypt</code> by installing and requiring the <code>bcryptjs</code> package. Remember that the first argument of <code>bcrypt.hash()</code> is a password string. You can use use an integer for the second argument to auto-generate a salt that will be incorporated in the password hash process. After hashing the user password, set the <code>user.hashedPassword</code> property and <code>await</code> the save of your user instance. Lastly, redirect the user to the home page (<code>/</code>) upon successful registration.</p>
<p>If the <code>validatorErrors</code> are NOT empty, use <code>array()</code> to transform the <code>validatorErrors</code> object into a mappable array. Map over each <code>error</code> object in the array and pluck out each error’s <code>msg</code> property to generate an array of error messages. Lastly, re-render your <code>user-register</code> form and pass in your <code>title</code> of "Register", the <code>user</code> object, the <code>errors</code> array, and the <code>csrfToken</code>.</p>
<p>Now run your application and test the <code>/user/register</code> route! Remember that you can test your route by registering a user through the form and using Postbird to confirm whether or not your user has been persisted to the database.</p>
<h2 id="phase-4-support-user-login">Phase 4: Support user login</h2>
<p>Now it’s time to add the user login form! Begin by updating the <code>./routes/user</code> module with <code>GET</code> and <code>POST</code> routes for the "Login" page (<code>/user/login</code>). Make sure to use CSRF protection for both routes.</p>
<p>Render your <code>user-login</code> template in your GET <code>/user/login</code> route. Pass along a <code>title</code> for your "Login" page as well as a <code>csrfToken</code>. Now let’s create the view template for your login page!</p>
<p>Create a <code>user-login.pug</code> template in your views directory. Think of how you can include and re-use mixins from your <code>utils.pug</code> file just like in your "Register" page. The "Login" form should contain an "Email Address" field, a "Password" field, a hidden <code>_csrf</code> field, and a submit button.</p>
<p>Now let’s revisit the POST <code>/user/login</code> route. You’ll want to validate your login form data, so take a moment to implement the following validation rules:</p>
<ul>
<li><code>emailAddress</code>
<ul>
<li>Not null or empty</li>
</ul></li>
<li><code>password</code>
<ul>
<li>Not null or empty</li>
</ul></li>
</ul>
<p>After your <code>loginValidators</code> have been created, wrap your asynchronous route function within your <code>asyncHandler</code> function and destructure the <code>emailAddress</code> and <code>password</code> from your <code>req.body</code> object. Generate your <code>validatorErrors</code> by passing in the <code>req</code> body into the <code>validationResult</code> function. Also take a moment to initialize an <code>errors</code> array. You’ll manually <em>push</em> error messages to render into this array.</p>
<p>If your validation errors are empty, try to find the user by their email address. You can <code>await</code> the database fetch of a <code>user</code> by using the <code>db.User.findOne()</code> function <code>where</code> the user has a matching <code>emailAddress</code>. If the user exists, use the <code>bcrypt.compare()</code> function to check whether the <code>user.hashedPassword</code> (parsed into string format) property matches the provided password from <code>req.body</code>. If there is a password match, log in the user (for now just leave yourself a <code>TODO</code> comment to log in the user) and redirect the user to the home page (<code>/</code>).</p>
<p>If your validator errors are empty and the user was not found, or the password did not match the <code>hashedPassword</code>, display an error message to the user by pushing in a "Login failed for the provided email address and password" message into the <code>errors</code> array you initialized.</p>
<p>If your validation errors are not empty, convert your <code>validatorErrors</code> object into an mappable <code>errors</code> array to pluck error messages and generate an array of error messages. Lastly, you need to render a <code>user-login</code> view for this route. Make sure to pass in the "Login" title, the <code>emailAddress</code> from <code>req.body</code>, the <code>errors</code> array, and a <code>csrfToken</code>.</p>
<h3 id="testing-user-login-1">Testing user login</h3>
<p>Run the application and browse to the <code>/user/login</code> route. You can test the user login form with the following actions:</p>
<ul>
<li>Submit the form with no values.
<ul>
<li>You should see two validation messages asking you to provide values.</li>
</ul></li>
<li>Submit the form with an email address that isn’t associated with a user record in the database and a password (doesn’t matter if the password is correct or not).
<ul>
<li>You should see a validation message letting you know that the login attempt failed.</li>
</ul></li>
<li>Submit the form with an email address that’s associated with a user record in the database <strong>but with an incorrect password</strong>.
<ul>
<li>You should see a validation message letting you know that the login attempt failed.</li>
</ul></li>
<li>Submit the form with an email address that’s associated with a user record in the database <strong>and with a correct password</strong>.
<ul>
<li>This time you should be redirected to the "Home" page.</li>
</ul></li>
</ul>
<h2 id="phase-5-persist-user-login-state">Phase 5: Persist user login state</h2>
<p>Now it’s time to handle persisting the user’s login state after they’ve successfully logged into the website!</p>
<h3 id="using-sessions-to-persist-a-users-login-state-1">Using sessions to persist a user’s login state</h3>
<p>Add a new module named <code>auth</code> to the root of your project and add function named <code>loginUser()</code> to handle persisting a user’s login state to session.</p>
<p>Update the <code>./routes/user</code> module to import the <code>loginUser()</code> function from the <code>auth</code> module. Then within the <code>POST</code> <code>/user/login</code> route handler add a call to the <code>loginUser()</code> function just before redirecting the user to the default route if the password matched.</p>
<p>Also, after a new user has registered in the <code>POST</code> <code>/user/register</code> route handler, add a call to the <code>loginUser()</code> function after saving the user to the database but before redirecting then to the default route.</p>
<h3 id="testing-user-login-state-persistence-1">Testing user login state persistence</h3>
<p>Run the application (if it’s not already running) and use the "Register" and "Login" pages to register a new user and login an existing user. Everything should work as it did before, but the user’s login state is being persisted in session.</p>
<p>At this point in the project, there isn’t any visual indication if the user is logged in or not (that’s something that you’ll fix in a bit). If you open your developer tools and view the "Application" tab, you can view the cookies for <code>http://localhost:8080</code>. After registering a new user or logging in an existing user, you should see a cookie named <code>reading-list.sid</code>. That’s the session cookie!</p>
<h2 id="phase-6-restore-the-authenticated-user-from-session">Phase 6: Restore the authenticated user from session</h2>
<p>Now that you’re persisting a user’s login state to session, you need to make that user’s information easily accessible to your application when it’s processing requests.</p>
<p>In the <code>auth</code> module, define a middleware function named <code>restoreUser()</code> to retrieve the user’s information from the database if they’re authenticated.</p>
<p>The function should check if the <code>req.session.auth</code> property is defined to determine if there’s an authenticated user. If there is, extract the <code>userId</code> from the <code>req.session.auth</code> property and retrieve the user from the database.</p>
<p>If the user is successfully retrieved from the database, then use the <code>res.locals</code> object to define and set two properties:</p>
<ul>
<li><code>authenticated</code> - Set to <code>true</code> to indicate that the current request has an authenticated user; and</li>
<li><code>user</code> - Set to the user that was just retrieved from the database.</li>
</ul>
<p>If the <code>req.session.auth</code> property isn’t defined or if retrieving the user from the database throws an error then set the <code>res.locals.authenticated</code> property to <code>false</code> to indicate that the current request doesn’t have an authenticated user (i.e. it’s an anonymous request).</p>
<p>After defining the <code>restoreUser()</code> function, export it from the <code>auth</code> module and import it into the <code>app</code> module. Then add the <code>restoreUser()</code> middleware function to the application just before the routes are added.</p>
<h2 id="phase-7-display-the-users-login-state">Phase 7: Display the user’s login state</h2>
<p>It’s helpful to display to the end user whether or not they’re currently logged in. A common approach is to display login and registration links or a welcome message in the header of the website.</p>
<p>If the user isn’t logged in, they would see links to log in or register:</p>
<blockquote>
<p>Login | Register</p>
</blockquote>
<p>If the user is logged in, they would be welcomed and have access to logging out:</p>
<blockquote>
<p>Welcome «current user name»! | Logout</p>
</blockquote>
<p>To do that, update your <code>./views/layout.pug</code> template to use the <code>locals.authenticated</code> property to determine if the current user is logged in or not.</p>
<p>If the current user is logged in, then render a short, friendly "welcome" message is along with a simple form that contains a single "Logout" submit button:</p>
<pre class="pug"><code>span(class=&#39;navbar-text px-4&#39;) Welcome #{user.firstName}!
form(class=&#39;form-inline pr-4&#39; action=&#39;/user/logout&#39; method=&#39;post&#39;)
  button(class=&#39;btn btn-sm btn-warning&#39; type=&#39;submit&#39;) Logout</code></pre>
<p>If the current user isn’t logged in, then render links (styled as buttons using Bootstrap CSS classes) to the "Login" and "Register" pages.</p>
<pre class="pug"><code>span(class=&#39;navbar-text px-4&#39;)
  a(class=&#39;btn btn-sm btn-dark mr-2&#39; href=&#39;/user/login&#39;) Login
  a(class=&#39;btn btn-sm btn-dark&#39; href=&#39;/user/register&#39;) Register</code></pre>
<p>Now if you run and test your application, you’ll see the current user’s login state displayed in the header! If you log in and click the "Logout" button in the header, you’ll receive a "Page Not Found" error. This is occurring because the <code>POST</code> <code>/user/logout</code> route doesn’t exist. Time to fix that!</p>
<h2 id="phase-8-implement-user-logout">Phase 8: Implement user logout</h2>
<p>Define and export a <code>logoutUser()</code> function in the <code>auth</code> module that removes the <code>auth</code> property from the <code>req.session</code> object.</p>
<p>Then add a <code>POST</code> <code>/user/logout</code> to the <code>./routes/user</code> module to process <code>POST</code> requests from the logout form. Import the <code>logoutUser()</code> function from the <code>auth</code> module and call it within the <code>POST</code> <code>/user/logout</code> route handler then redirect the user to the default route.</p>
<p>The <code>POST</code> <code>/user/logout</code> route isn’t modifying any of the user’s data in the database so there’s no need to protect it from CSRF attacks.</p>
<h3 id="testing-the-latest-changes-1">Testing the latest changes</h3>
<p>Run the application and use the "Login" page to login an existing user. You should now see the user’s first name displayed in the header.</p>
<p>After logging in, you should see something like this logged to the console:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb113-1" title="1"><span class="ex">Session</span> {</a>
<a class="sourceLine" id="cb113-2" title="2">  <span class="ex">cookie</span>: { path: <span class="st">&#39;/&#39;</span>, _expires: null, originalMaxAge: null, httpOnly: true },</a>
<a class="sourceLine" id="cb113-3" title="3">  <span class="ex">auth</span>: { userId: 1 }</a>
<a class="sourceLine" id="cb113-4" title="4">}</a></code></pre></div>
<p>Now click the "Logout" button, and you should be redirected to the "Login" page. In the console you should see that the <code>session.auth</code> property is no longer defined on the <code>session</code> object:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb114-1" title="1"><span class="ex">Session</span> {</a>
<a class="sourceLine" id="cb114-2" title="2">  <span class="ex">cookie</span>: { path: <span class="st">&#39;/&#39;</span>, _expires: null, originalMaxAge: null, httpOnly: true }</a>
<a class="sourceLine" id="cb114-3" title="3">}</a></code></pre></div>
<h2 id="phase-9-support-user-attraction-visits">Phase 9: Support user attraction visits</h2>
<p>Now you’re ready to add support for user attraction visits.</p>
<h3 id="create-the-attractionvisit-model">Create the AttractionVisit model</h3>
<p>The <code>AttractionVisit</code> model should include the following properties:</p>
<ul>
<li><code>visitedOn</code> - A non-nullable date only attribute representing the date that the user visited the attraction;</li>
<li><code>rating</code> - A non-nullable integer attribute representing the user’s rating of the attraction; and</li>
<li><code>comments</code> - A nullable text attribute representing the user’s comments about the attraction.</li>
</ul>
<p>Use the Sequelize CLI to generate the <code>AttractionVisit</code> model and migration. Then edit both files to use the expected attribute and column configuration.</p>
<p>Before applying the migration, associate the model with both the <code>Attraction</code> and <code>User</code> models:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb115-1" title="1"><span class="co">// ./db/models/attractionvisit.js</span></a>
<a class="sourceLine" id="cb115-2" title="2"></a>
<a class="sourceLine" id="cb115-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb115-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb115-5" title="5">  <span class="kw">const</span> AttractionVisit <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;AttractionVisit&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb115-6" title="6"></a>
<a class="sourceLine" id="cb115-7" title="7">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb115-8" title="8"></a>
<a class="sourceLine" id="cb115-9" title="9">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb115-10" title="10">  <span class="va">AttractionVisit</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb115-11" title="11">    <span class="va">AttractionVisit</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Attraction</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb115-12" title="12">      <span class="dt">as</span><span class="op">:</span> <span class="st">&#39;attraction&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb115-13" title="13">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;attractionId&#39;</span></a>
<a class="sourceLine" id="cb115-14" title="14">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb115-15" title="15">    <span class="va">AttractionVisit</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">User</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb115-16" title="16">      <span class="dt">as</span><span class="op">:</span> <span class="st">&#39;user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb115-17" title="17">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;userId&#39;</span></a>
<a class="sourceLine" id="cb115-18" title="18">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb115-19" title="19">  <span class="op">};</span></a>
<a class="sourceLine" id="cb115-20" title="20">  <span class="cf">return</span> AttractionVisit<span class="op">;</span></a>
<a class="sourceLine" id="cb115-21" title="21"><span class="op">};</span></a></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb116-1" title="1"><span class="co">// ./db/models/attraction.js</span></a>
<a class="sourceLine" id="cb116-2" title="2"></a>
<a class="sourceLine" id="cb116-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb116-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb116-5" title="5">  <span class="kw">const</span> Attraction <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Attraction&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb116-6" title="6"></a>
<a class="sourceLine" id="cb116-7" title="7">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb116-8" title="8"></a>
<a class="sourceLine" id="cb116-9" title="9">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb116-10" title="10">  <span class="va">Attraction</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb116-11" title="11">    <span class="va">Attraction</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Park</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb116-12" title="12">      <span class="dt">as</span><span class="op">:</span> <span class="st">&#39;park&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb116-13" title="13">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;parkId&#39;</span></a>
<a class="sourceLine" id="cb116-14" title="14">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb116-15" title="15">    <span class="va">Attraction</span>.<span class="at">hasMany</span>(<span class="va">models</span>.<span class="at">AttractionVisit</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb116-16" title="16">      <span class="dt">as</span><span class="op">:</span> <span class="st">&#39;visits&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb116-17" title="17">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;attractionId&#39;</span></a>
<a class="sourceLine" id="cb116-18" title="18">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb116-19" title="19">  <span class="op">};</span></a>
<a class="sourceLine" id="cb116-20" title="20">  <span class="cf">return</span> Attraction<span class="op">;</span></a>
<a class="sourceLine" id="cb116-21" title="21"><span class="op">};</span></a></code></pre></div>
<div class="sourceCode" id="cb117"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb117-1" title="1"><span class="co">// ./db/models/user.js</span></a>
<a class="sourceLine" id="cb117-2" title="2"></a>
<a class="sourceLine" id="cb117-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb117-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb117-5" title="5">  <span class="kw">const</span> User <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;User&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb117-6" title="6"></a>
<a class="sourceLine" id="cb117-7" title="7">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb117-8" title="8"></a>
<a class="sourceLine" id="cb117-9" title="9">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-10" title="10">  <span class="va">User</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb117-11" title="11">    <span class="va">User</span>.<span class="at">hasMany</span>(<span class="va">models</span>.<span class="at">AttractionVisit</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb117-12" title="12">      <span class="dt">as</span><span class="op">:</span> <span class="st">&#39;visits&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb117-13" title="13">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;userId&#39;</span></a>
<a class="sourceLine" id="cb117-14" title="14">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-15" title="15">  <span class="op">};</span></a>
<a class="sourceLine" id="cb117-16" title="16">  <span class="cf">return</span> User<span class="op">;</span></a>
<a class="sourceLine" id="cb117-17" title="17"><span class="op">};</span></a></code></pre></div>
<p>Then update the <code>./db/migrations/[timestamp]-create-attraction-visit.js</code> migration file with the <code>userId</code> and <code>attractionId</code> foreign key columns:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb118-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb118-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-3" title="3">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;AttractionVisits&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-5" title="5">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-6" title="6">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-7" title="7">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-8" title="8">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-9" title="9">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb118-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb118-11" title="11">      <span class="dt">userId</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-12" title="12">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-13" title="13">        <span class="dt">references</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-14" title="14">          <span class="dt">model</span><span class="op">:</span> <span class="st">&#39;Users&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-15" title="15">          <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;id&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-16" title="16">        <span class="op">},</span></a>
<a class="sourceLine" id="cb118-17" title="17">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-18" title="18">      <span class="op">},</span></a>
<a class="sourceLine" id="cb118-19" title="19">      <span class="dt">attractionId</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-20" title="20">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-21" title="21">        <span class="dt">references</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-22" title="22">          <span class="dt">model</span><span class="op">:</span> <span class="st">&#39;Attractions&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-23" title="23">          <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;id&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-24" title="24">        <span class="op">},</span></a>
<a class="sourceLine" id="cb118-25" title="25">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb118-26" title="26">      <span class="op">},</span></a>
<a class="sourceLine" id="cb118-27" title="27"></a>
<a class="sourceLine" id="cb118-28" title="28">      <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb118-29" title="29"></a>
<a class="sourceLine" id="cb118-30" title="30">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb118-31" title="31">  <span class="op">},</span></a>
<a class="sourceLine" id="cb118-32" title="32">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb118-33" title="33">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;AttractionVisits&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb118-34" title="34">  <span class="op">}</span></a>
<a class="sourceLine" id="cb118-35" title="35"><span class="op">};</span></a></code></pre></div>
<p>These model associations create a one-to-many relationship between the <code>Attraction</code> and <code>AttractionVisit</code> models and a one-to-many relationship between the <code>User</code> and <code>AttractionVisit</code> model. Alternatively, you can think of the relationship as a many-to-many between the <code>Attraction</code> and <code>User</code> models (i.e. an attraction can be visited by many users and a user can visit many attractions).</p>
<p>Apply the migration when you’re ready.</p>
<h3 id="update-the-attraction-detail-page">Update the Attraction Detail page</h3>
<p>Update the Attraction Detail page to display a list of attraction visits. Display an "Add Visit" button (a hyperlink styled as a button using Bootstrap’s CSS classes) above the list of attraction visits that when clicked, navigates the user to the "Add Visit" page.</p>
<h3 id="add-the-add-visit-page">Add the Add Visit page</h3>
<p>Add a <code>./routes/visit</code> module, then add the <code>GET</code> and <code>POST</code> routes for the "Add Visit" page:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb119-1" title="1"><span class="kw">const</span> visitValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb119-2" title="2">  <span class="co">// </span><span class="al">TODO</span><span class="co"> Define validators.</span></a>
<a class="sourceLine" id="cb119-3" title="3">]<span class="op">;</span></a>
<a class="sourceLine" id="cb119-4" title="4"></a>
<a class="sourceLine" id="cb119-5" title="5"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/attraction/:attractionId(</span><span class="sc">\\</span><span class="st">d+)/visit/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb119-6" title="6">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb119-7" title="7">    <span class="co">// </span><span class="al">TODO</span><span class="co"> Implement route handler.</span></a>
<a class="sourceLine" id="cb119-8" title="8">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb119-9" title="9"></a>
<a class="sourceLine" id="cb119-10" title="10"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/attraction/:attractionId(</span><span class="sc">\\</span><span class="st">d+)/visit/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> visitValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb119-11" title="11">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb119-12" title="12">    <span class="co">// </span><span class="al">TODO</span><span class="co"> Implement route handler.</span></a>
<a class="sourceLine" id="cb119-13" title="13">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>In your POST <code>/user/register</code> route, make sure to use <code>visitValidators</code> in addition to your <code>csrfProtection</code> middleware. This means you’ll need to import <code>check</code> and <code>validationResult</code> from <code>express-validator</code>.</p>
<p>Implement the following validation rules:</p>
<ul>
<li><code>visitedOn</code>
<ul>
<li>Not null or empty</li>
<li>Is a valid date</li>
</ul></li>
<li><code>rating</code>
<ul>
<li>Not null or empty</li>
<li>Is an integer between 1 and 5</li>
</ul></li>
</ul>
<p>Render a template that extends the main layout and has a form within <code>block content</code>. Take note of the mixins and <code>validationErrorSummary</code> template that are available for you to use. The form should contain the following input fields:</p>
<ul>
<li>Visited On</li>
<li>Rating</li>
<li>Comments</li>
</ul>
<h3 id="require-a-logged-in-user">Require a logged in user</h3>
<p>To add a new visit, the user needs to be logged into the website. Without a logged in user, you wouldn’t know who to add the visit for!</p>
<p>Add a new function named <code>requireAuth()</code> to the <code>auth</code> module. Update the <code>requireAuth()</code> function to redirect the user to the "Login" page if the <code>res.locals.authenticated</code> property is set to <code>false</code>, otherwise pass control to the next middleware function by calling the <code>next()</code> method.</p>
<p>Then import the <code>requireAuth()</code> function into the <code>./routes/visit</code> module and add it to the <code>GET</code> and <code>POST</code> routes for the "Add Visit" page:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb120-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/attraction/:attractionId(</span><span class="sc">\\</span><span class="st">d+)/visit/add&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb120-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb120-3" title="3">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb120-4" title="4">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb120-5" title="5"></a>
<a class="sourceLine" id="cb120-6" title="6"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/attraction/:attractionId(</span><span class="sc">\\</span><span class="st">d+)/visit/add&#39;</span><span class="op">,</span> requireAuth<span class="op">,</span> csrfProtection<span class="op">,</span> visitValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb120-7" title="7">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb120-8" title="8">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb120-9" title="9">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Now, if the current user isn’t logged in, they’ll be redirected to the "Login" page if they attempt view the "Add Visit" page!</p>
<h2 id="bonus-phase-1-adding-the-edit-visit-and-delete-visit-pages">Bonus Phase 1: Adding the Edit Visit and Delete Visit pages</h2>
<ul>
<li>Add the edit and delete attraction visit routes and views.</li>
<li>Only display the "Edit" and "Delete" buttons on a visit if the visit’s user is the current user.</li>
<li>Check that the current user is the owner of the visit before allowing them to edit or delete it.</li>
</ul>
<h2 id="bonus-phase-2-locking-down-parks-and-attractions">Bonus Phase 2: Locking down parks and attractions</h2>
<ul>
<li>Add an attribute to the <code>User</code> model that allows you to indicate which users are "Admin" users.</li>
<li>Update the park and attraction CRUD routes to only allow authenticated "Admin" users.</li>
</ul>
<hr />
<h1 id="week-12-day-3-data-apis-with-express" data-ignore="true">WEEK-12 DAY-3<br><em>Data APIs With Express</em></h1>
<hr />
<h1 id="application-programming-interfaces-learning-objectives">Application Programming Interfaces Learning Objectives</h1>
<p>Modern Web applications can serve both HTML <em>and</em> data. You see that when you go to Facebook, Twitter, and TurboTax Online. There are some widely-accepted practices for how to architect your applications so that they can do this. After homework, lecture, and practicing, you should be able to</p>
<ul>
<li>Recall that REST is an acronym for Representational State Transfer</li>
<li>Describe how RESTful endpoints differ from traditional remote-procedure call (RPC) services</li>
<li>Identify and describe the RESTful meanings of the combinations of HTTP verbs and endpoint types for both HTML-based applications and APIs
<ul>
<li>HTTP verbs: GET, POST, PUT, PATCH, and DELETE</li>
<li>Endpoint types: collections of resources and singular resources</li>
</ul></li>
<li>Recall that RESTful is <em>not</em> a standard (like ECMAScript or URLs), but a common way to organize data interactions</li>
<li>Explain how RESTful APIs are meant to be stateless</li>
<li>Given a data model, design RESTful endpoints that interact with the data model to define application functionality</li>
<li>Use the <code>express.json()</code> middleware to parse HTTP request bodies with type <code>application/json</code></li>
<li>Determine the maximum data an API response needs and map the content from a Sequelize object to a more limited data object</li>
<li>Define a global Express error handler to return appropriate responses and status codes given a specific Accept header in the HTTP request</li>
<li>Define Cross-Origin Resource Sharing (CORS) and how it is implemented in some Web clients</li>
<li>Explain that CORS is an opt-in feature of Web clients</li>
<li>Configure your API to use CORS to prevent unauthorized access from browser-based Web requests</li>
</ul>
<hr />
<h1 id="getting-started-with-restful-endpoints">Getting Started With RESTful Endpoints</h1>
<p>ReST stands for REpresentational State Transfer. The acronym doesn’t fit perfectly, but we’re developers and we can come up with whatever cool acronyms work for us! This may sound like a complex concept, but don’t let it scare you too much.</p>
<p>In this reading, you will learn the definition of ReST and how to apply its design principles. You will learn about how it replaces another kind of interaction called "remote procedure calls". Finally, you’ll get to a very practical way to implement ReST using the RESTful endpoint design convention.</p>
<h2 id="rules-of-rest">Rules of ReST</h2>
<p>ReST (Representational State Transfer) is an architecture style for designing networked applications. To be clear, ReST is not an official standard. Instead, it’s a set of rules/constraints. Though ReST is commonly associated with APIs, not every API actually follows RESTful conventions.</p>
<p>ReST defines six architectural constraints, and in this reading, we’ll focus on three of them:</p>
<ol type="1">
<li><strong>Decoupled client-server</strong>: The client and the server should be decoupled so that they can evolve separately without any dependence on one another.</li>
<li><strong>Stateless</strong>: This means that there is no necessary session between the client and the server. Data received from the server can be used by the client independently. This allows you to have short discrete operations. Luckily, this is a natural fit for HTTP operations in which requests are intended to be independent and short-lived.</li>
<li><strong>Uniform interface</strong>: RESTful APIs are meant to be self-describing and uniform in their definition. Each operation is intended to be separated by a separate endpoint or URL. In practical real world terms, most RESTful APIs implement the classic CRUD (Create, Read, Update, Delete) operations against a resource that just happens to be in your data model. This uniformity allows developers to easily learn the usage pattern of each API.</li>
</ol>
<h2 id="what-does-a-restful-api-look-like">What does a RESTful API look like?</h2>
<p>Because RESTful APIs are meant to be representational, you can start with the data model that the API is meant to represent. For example, if you’re building a Twitter clone application, you will most likely want to define API endpoints that manage the operations of your users "tweets", such as "create a tweet" and "like a tweet."</p>
<h3 id="urls">URLs</h3>
<p>In RESTful APIs, you generally have two kinds of URLs, ones that points at <em>collections of resources</em> and ones that point at <em>single resources</em>. Using the Twitter application as an example, a path like <strong>/my/tweets</strong> would point to a collection of tweets made by you. A path like <strong>/my/tweets/17</strong> would point to a tweet made by you with the id of 17. Usually, those ids are the primary keys of rows in your database for the record that contains the information for that specific tweet.</p>
<p>The naming scheme, again, is quite simple. A path that ends in a plural noun represents a collection of resources that your API provides for developers to interact with. The following examples are just naming schemes that <em>you would decide</em> as the person creating the paths that your application will handle.</p>
<ul>
<li><strong>/invoices</strong> would represent a collection of invoices that you’re allowed to see</li>
<li><strong>/people</strong> would represent the people in the application that you’re allowed to see</li>
<li><strong>/houses</strong> would represent a collection of houses</li>
</ul>
<p>A path that combines a plural noun and a specific identifier represents a single resource in your application. Often, the identifier is a primary key from the database. However, if you have a unique column that also identifies a specific record, you could use that instead.</p>
<ul>
<li><strong>/invoices/PK-200201</strong> would represent the single invoice that has the the invoice number "PK-200201"</li>
<li><strong>/people/10103</strong> would represent the single person with id 10103</li>
<li><strong>/houses/bdfa5ef9-0c86-4810-bc13-10415250af09</strong> would represent the house with the specific globally unique identifier "bdfa5ef9-0c86-4810-bc13-10415250af09"</li>
</ul>
<h3 id="ajax-urls-and-http-verbs">AJAX URLs and HTTP verbs</h3>
<p>For collections of resources URLs, the following table describes what each HTTP verb means for interacting with that URL. The responses will almost invariably be formatted as JSON.</p>
<table>
<thead>
<tr class="header">
<th>HTTP Verb</th>
<th>Meaning</th>
<th>With respect to <strong>/my/tweets</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GET</td>
<td>Get "all" of the specified resources</td>
<td>Get all of your tweets</td>
</tr>
<tr class="even">
<td>POST</td>
<td>Create a new resource</td>
<td>Create a new tweet</td>
</tr>
<tr class="odd">
<td>PUT</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr class="even">
<td>PATCH</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr class="odd">
<td>DELETE</td>
<td>Delete all of the resources</td>
<td>Delete all of your tweets</td>
</tr>
</tbody>
</table>
<p>For single resource URLs, the following table describes what each HTTP verb means for interacting with that URL. Again, the responses will invariably be formatted as JSON.</p>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 32%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr class="header">
<th>HTTP Verb</th>
<th>Meaning</th>
<th>With respect to <strong>/my/tweets/17</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GET</td>
<td>Get the details of the resource</td>
<td>Get that specific tweet with id 17</td>
</tr>
<tr class="even">
<td>POST</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr class="odd">
<td>PUT</td>
<td>Replace the resource</td>
<td>Replace all of the tweet details with the provided data</td>
</tr>
<tr class="even">
<td>PATCH</td>
<td>Update the resource</td>
<td>Update specific properties of the tweet</td>
</tr>
<tr class="odd">
<td>DELETE</td>
<td>Delete the specified resource</td>
<td>Delete that specific tweet</td>
</tr>
</tbody>
</table>
<p>When dealing with these RESTful endpoints, the actions don’t necessarily mean that records <em>will</em> get created or destroyed in your database, or only one record will be affected.</p>
<p>For example, you may decide to perform "soft deletes" on some of your data. This means that, instead of removing a record from a table, you mark the record "deleted". (You can enable this with the <a href="https://sequelize.org/v5/manual/models-definition.html#configuration"><code>paranoid</code> configuration setting</a> in your Sequelize models.) This means that the HTTP DELETE request would cause a SQL UPDATE rather than DELETE. What is important is that the <em>concept</em> of a delete has been performed.</p>
<p>In another example, consider the path that reads <strong>/weather/current</strong>. That doesn’t point to any static single record in the weather database. Instead, it would return the <em>most recent</em> record of weather in the database. The id of "current" would be treated special and initiate a lookup of the most recent record rather than a specific record like <strong>/weather/10392</strong>.</p>
<h3 id="html-urls-and-http-verbs">HTML URLs and HTTP verbs</h3>
<p>RESTful APIs don’t need to be just data APIs returning JSON. The URLs that return HTML can follow a RESTful concept, as well. What it means, though, is that you will be limited to just the verbs GET and POST. That’s all HTML-based views can generate. The following tables show the paths and HTTP verbs used to interact with HTML-based versions of a RESTful application.</p>
<table>
<thead>
<tr class="header">
<th>Path</th>
<th>HTTP Verb</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>/my/tweets</strong></td>
<td>GET</td>
<td>Get an HTML-based list of your tweets</td>
</tr>
<tr class="even">
<td><strong>/my/tweets/new</strong></td>
<td>GET</td>
<td>Show a form to create a new tweet</td>
</tr>
<tr class="odd">
<td><strong>/my/tweets</strong></td>
<td>POST</td>
<td>Create a new tweet</td>
</tr>
<tr class="even">
<td><strong>/my/tweets/17</strong></td>
<td>GET</td>
<td>See the details of your tweet with the id of 17</td>
</tr>
<tr class="odd">
<td><strong>/my/tweets/17/edit</strong></td>
<td>GET</td>
<td>Show the edit form for your tweet with the id of 17</td>
</tr>
<tr class="even">
<td><strong>/my/tweets/17</strong></td>
<td>POST</td>
<td>Update the tweet with the submitted details</td>
</tr>
<tr class="odd">
<td><strong>/my/tweets/17/delete</strong></td>
<td>POST</td>
<td>Delete your tweet with the id of 17</td>
</tr>
</tbody>
</table>
<p>All of the GET requests get HTML responses for the browser to show. All of the POST requests usually end in a redirect to another page that makes sense:</p>
<ul>
<li>After creating a resource, redirect to its detail page</li>
<li>After editing a resource, redirect to its detail page</li>
<li>After deleting a resource, redirect to the list page</li>
</ul>
<h2 id="designing-your-api">Designing your API</h2>
<p>The simplest way to figure out what paths you need in your application is to figure out what resources you need in your application. For many developers, this means looking at the models in your application (and the database tables that power the models).</p>
<p>If you’re creating a pet shelter management application, you would need to know about animals, animal types, what kennel they’re in, who works there, and more. So, you would have some models like</p>
<ul>
<li><code>Animal</code></li>
<li><code>AnimalType</code></li>
<li><code>HealthRecord</code></li>
<li><code>Kennel</code></li>
<li>and more…</li>
</ul>
<p>For each of those, you could create paths in your RESTful API to allow the Web application to interact with those resources:</p>
<ul>
<li><strong>/animals</strong> would be the collection of animals</li>
<li><strong>/animal-types</strong> would be the collection of animal types</li>
<li><strong>/animals/137/health-records</strong> would be the health records for the specific animal whose id is 137</li>
<li><strong>/kennels</strong> would be the collection of kennels available at the shelter in which you could put the animals</li>
<li>and more…</li>
</ul>
<p>It all depends on what you need to interact with to make your application work like you want it to.</p>
<h2 id="github-api-example">GitHub API example</h2>
<p>GitHub has a much vaunted RESTful API that many people use as a model for how to do <em>good API design</em>. This section checks out some of its features.</p>
<p>First, check out this <a href="https://api.github.com/users/app-academy">GitHub REST API endpoint</a> for a GET request to the <code>app-academy</code> user and the endpoint’s response below. Notice how the information is formatted as JSON. JSON is the preferred format over other formats like XML. Feel free to take a look at the <a href="https://developer.github.com/v3/users/#get-a-single-user">GitHub API documentation</a> for sending a GET request for a single user.</p>
<p>If your browser is rendering the JSON below without the quotes around the property names, you’re likely using the extension <a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a> to <em>prettify</em> your JSON in JavaScript. The <a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a> extension <em>prettifies</em> JSON by parsing the JSON text data into a JavaScript object. Note that you can also parse JSON into JavaScript by using the <code>JSON.parse()</code> method. Another extension, <a href="https://chrome.google.com/webstore/detail/json-viewer/gbmdgpbipfallnflgajpaliibnhdgobh">JSON Viewer</a>, also <em>prettifies</em> JSON but it correctly preserves the quotes around the property names.</p>
<p>If you opened https://api.github.com/users/app-academy endpoint in your browser, you should see the JSON formatted data below. Feel free to navigate to the links in the JSON.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb121-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb121-2" title="2">  <span class="dt">&quot;login&quot;</span><span class="fu">:</span> <span class="st">&quot;app-academy&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-3" title="3">  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">3155975</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-4" title="4">  <span class="dt">&quot;node_id&quot;</span><span class="fu">:</span> <span class="st">&quot;MDQ6VXNlcjMxNTU5NzU=&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-5" title="5">  <span class="dt">&quot;avatar_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://avatars0.githubusercontent.com/u/3155975?v=4&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-6" title="6">  <span class="dt">&quot;gravatar_id&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-7" title="7">  <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-8" title="8">  <span class="dt">&quot;html_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://github.com/app-academy&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-9" title="9">  <span class="dt">&quot;followers_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/followers&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-10" title="10">  <span class="dt">&quot;following_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/following{/other_user}&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-11" title="11">  <span class="dt">&quot;gists_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/gists{/gist_id}&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-12" title="12">  <span class="dt">&quot;starred_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/starred{/owner}{/repo}&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-13" title="13">  <span class="dt">&quot;subscriptions_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/subscriptions&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-14" title="14">  <span class="dt">&quot;organizations_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/orgs&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-15" title="15">  <span class="dt">&quot;repos_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/repos&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-16" title="16">  <span class="dt">&quot;events_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/events{/privacy}&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-17" title="17">  <span class="dt">&quot;received_events_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://api.github.com/users/app-academy/received_events&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-18" title="18">  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;User&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-19" title="19">  <span class="dt">&quot;site_admin&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-20" title="20">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-21" title="21">  <span class="dt">&quot;company&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-22" title="22">  <span class="dt">&quot;blog&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-23" title="23">  <span class="dt">&quot;location&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-24" title="24">  <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-25" title="25">  <span class="dt">&quot;hireable&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-26" title="26">  <span class="dt">&quot;bio&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-27" title="27">  <span class="dt">&quot;public_repos&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-28" title="28">  <span class="dt">&quot;public_gists&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-29" title="29">  <span class="dt">&quot;followers&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-30" title="30">  <span class="dt">&quot;following&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-31" title="31">  <span class="dt">&quot;created_at&quot;</span><span class="fu">:</span> <span class="st">&quot;2012-12-31T00:08:43Z&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb121-32" title="32">  <span class="dt">&quot;updated_at&quot;</span><span class="fu">:</span> <span class="st">&quot;2016-02-27T05:27:57Z&quot;</span></a>
<a class="sourceLine" id="cb121-33" title="33"><span class="fu">}</span></a></code></pre></div>
<p>Navigate to the JSON’s <a href="https://api.github.com/users/app-academy/followers">followers_url</a> and <a href="https://api.github.com/users/app-academy/repos">repos_url</a>. Notice how the url path of those endpoints connect to the endpoint that fetches all the data connected to the <code>app-academy</code> user.</p>
<p>Now open the <a href="https://api.github.com/users/app-academy/followers">followers_url</a> endpoint in your browser. You are now are sending a <code>GET</code> request to GitHub’s server to receive an array of followers associated to the <code>app-academy</code> user. Keep in mind that there are many <a href="https://github.com/public-apis/public-apis">Public APIs</a> available as you plan your first full-stack project next week.</p>
<h2 id="restful-vs-remote-procedure-calls-rpc">RESTful vs remote procedure calls (RPC)</h2>
<p>Defining HTTP APIs can come in many shapes and styles. The style you adopt may flow out of the problem that you are attempting to solve or it could just be your personal preference. In programming, there is usually more than one valid approach, and making HTTP based APIs is no exception. And while RESTful APIs are certainly one of the most popular styles for creating an API, it is not the only way.</p>
<h3 id="a-remote-procedure-call">A remote procedure call</h3>
<p>Remote procedure calls are like methods on objects rather than database operations. Clients make requests centered around specific operations. For example, with a RESTful API, you would see a GET request to this path to retrieve a specific tweet: <code>http://localhost/tweets/12</code>. In an RPC-based API, you could see a path similar to this <code>http://localhost/getTweetById?id=12</code>.</p>
<p>Your route would then have an action to handle that specific "call".</p>
<p>RPC style endpoints are notorious for specifying the method name in the URL.</p>
<p>This can be convenient, because by looking up the URL you can immediately understand what it does and what you get in return, and it can offer a way to get around some of the more complicated nested paths mentioned earlier.</p>
<p>The drawback is that you need comprehensive documentation to know all of the different methods available by an RPC-designed API. Contrast that to RESTful APIs where you need know only the resources; once you know the resources, you immediately know how to interact with them using the HTTP verbs.</p>
<h3 id="which-is-better-rest-or-rpc">Which is better? ReST or RPC?</h3>
<p>"Better" is very subjective. RESTful APIs are definitely more popular nowadays. Although Express is an un-opinionated framework, a typical Express setup is more conducive to following RESTful conventions. For example, routers and routes are organized in a way to match RESTful URLs, and routes are defined around the core HTTP verbs.</p>
<p>Generally speaking, in this course, you’ll want to use RESTful APIs, as it offers a predictable and systematic way of organizing your API.</p>
<h2 id="what-you-learned">What you learned</h2>
<p>In this article, you covered quite a bit. You learned that</p>
<ol type="1">
<li>ReST is an acronym for Representational State Transfer.</li>
<li>RESTful services differ from traditional remote-procedure call styled services.</li>
<li>ReST is not an official standard.</li>
<li>RESTful APIs utilize a client/server architecture.</li>
<li>Data from your APIs are represented by resources and are accessed using Uniform Resource Locators (URLs).</li>
<li>Endpoints are a combination of a resource and an operation.</li>
<li>CRUD operations are represented by HTTP methods (POST, GET, PUT, DELETE, and sometimes PATCH) and a URL.</li>
<li>RESTful APIs are stateless.</li>
</ol>
<hr />
<h1 id="express-apis">Express APIs</h1>
<p>It’s time to dive deeper into RESTful APIs. As you might remember, RESTful APIs utilize a client-server architecture. An example of client-server architecture that you are very familiar with is a web application loaded through a browser that connects the user to a server. RESTful APIs act as an intermediary to allow users to interact with database storage through CRUD operations.</p>
<p>In this reading, you’ll be creating a lightweight API to manage tasks. You can imagine using this API in creating a To-Do list application. This reading will primarily be a walk-through and code demo of how to build out your own basic CRUD API with Express, Sequelize, and Postbird. You’ll use Postbird to easily view your database objects. You’ll also use Postman to send GET, POST, PUT, and DELETE requests to test your routes.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Define a collection of endpoints (i.e. routes) that perform CRUD operations against a single resource using Sequelize and return responses to the client with appropriate HTTP status codes;</li>
<li>Use the built-in <code>express.json()</code> middleware function to parse request body content as JSON;</li>
<li>Use Postbird to view data in your database;</li>
<li>Use Postman to interact with your API;</li>
<li>Transform data for responses so that the content returned to clients only contains what’s necessary and doesn’t expose any sensitive information; and</li>
<li>Understand that a global error handling function catches and processes all unhandled errors to return appropriate responses (status codes and content).</li>
</ul>
<h2 id="project-setup">Project setup</h2>
<p>Begin by cloning the project skeleton:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb122-1" title="1"><span class="fu">git</span> clone https://github.com/-starters/express-sequelize-starter.git</a></code></pre></div>
<p>Open your project’s <code>package.json</code> and view the <code>dependencies</code> and <code>devDependencies</code>. The <code>package.json</code> has included the following packages as dependencies: <code>dotenv</code>, <code>express</code>, <code>express-validator</code>, <code>morgan</code>, <code>per-env</code>, <code>pg</code>, <code>sequelize</code>, <code>dotenv-cli</code>, <code>nodemon</code>, and <code>sequelize-cli</code>.</p>
<p>Since your <code>package.json</code> includes the packages above, running <code>npm install</code> will take care of installing all of the dependencies you need to create an Express application that utilizes Sequelize, dotenv, and the Express validator library. Your project tomorrow will also have a <code>package.json</code> with all the dependencies required of your project.</p>
<h3 id="initializing-sequelize">Initializing Sequelize</h3>
<p>Normally, the Sequelize CLI needs to be configured in order to know where your database configuration is located and where to generate the <code>models</code>, <code>seeders</code>, and <code>migrations</code> folders. The project skeleton has already taken care of configuration by including complete <code>.sequelizerc</code>, <code>./config/index.js</code>, and <code>./config/database.js</code> files.</p>
<h3 id="creating-the-database">Creating the database</h3>
<p>Take a moment to create a database user and database:</p>
<ul>
<li>The login name that you must use is "task_list_app" (make sure to set a login password).</li>
<li>Your user must have the CREATEDB privilege so that you can run <code>npx dotenv sequelize-cli db:create</code>.</li>
<li>The database name that you must use is "task_list_development".</li>
</ul>
<h3 id="connecting-sequelize-to-your-database">Connecting Sequelize to your database</h3>
<p>Although the Sequelize CLI configuration files are already complete, Sequelize CLI still needs access to your database credentials. Remember to create a <code>.env</code> file based off of the <code>.env.example</code> file included in your project skeleton, and to then replace the values with the values you used when creating the database. For example, if you used "password1234" for your password, then set the <code>DB_PASSWORD</code> to be equal to <code>password1234</code> in your own <code>.env</code> file.</p>
<h2 id="set-up-the-task-model">Set up the Task model</h2>
<p>Generate and migrate your <code>Task</code> model with the following command:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb123-1" title="1"><span class="ex">npx</span> sequelize model:generate --name Task --attributes <span class="st">&quot;name:string&quot;</span></a></code></pre></div>
<p>You should see that a <code>New model was created at...</code> and a <code>New migration was created at...</code> to confirm the successful creation of your <code>Task</code> model and migration files.</p>
<p>In the model and migration files, make sure to configure the task <code>name</code> to not be nullable. Each task should have a <code>name</code> column of type <code>string</code> that has a maximum length of <code>255</code> and is not nullable.</p>
<p>It’s important to include <code>dotenv</code> in your migration command so that the Sequelize CLI uses correct database credentials when running the migration. Run your migrations with the command below:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb124-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate</a></code></pre></div>
<p>After migrating, you can use the Postbird client to view the <code>Tasks</code> table in your database.</p>
<p>Postbird is a cross-platform <a href="https://wiki.postgresql.org/wiki/PostgreSQL_Clients">PostgreSQL GUI client</a>. A <code>GUI</code> is a graphical user interface, meaning that its users interact with an application through icons instead of text-based navigation. <a href="https://github.com/Paxa/postbird">Postbird</a> is an open-source GUI client while <a href="http://postgresguide.com/utilities/psql.html">Psql</a> is an interactive terminal - both allow you to interact with Postgres.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postbird-3.png" alt="postbird-migration" /><figcaption>postbird-migration</figcaption>
</figure>
<p>Now generate a seed file by running the following command from the root of your project:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb125-1" title="1"><span class="ex">npx</span> sequelize seed:generate --name test-data</a></code></pre></div>
<p>Go ahead and replace the contents of the <code>./db/seeders/[timestamp]-test-data.js</code> with the following code to seed four tasks into your <code>task_list_development</code> database:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb126-1" title="1"><span class="co">//- ./db/seeders/[timestamp]-test-data.js</span></a>
<a class="sourceLine" id="cb126-2" title="2"></a>
<a class="sourceLine" id="cb126-3" title="3"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb126-4" title="4"></a>
<a class="sourceLine" id="cb126-5" title="5"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb126-6" title="6">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb126-7" title="7">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(</a>
<a class="sourceLine" id="cb126-8" title="8">      <span class="st">&quot;Tasks&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb126-9" title="9">      [</a>
<a class="sourceLine" id="cb126-10" title="10">        <span class="op">{</span></a>
<a class="sourceLine" id="cb126-11" title="11">          <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Clean car&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb126-12" title="12">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb126-13" title="13">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb126-14" title="14">        <span class="op">},</span></a>
<a class="sourceLine" id="cb126-15" title="15">        <span class="op">{</span></a>
<a class="sourceLine" id="cb126-16" title="16">          <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Study data structures&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb126-17" title="17">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb126-18" title="18">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb126-19" title="19">        <span class="op">},</span></a>
<a class="sourceLine" id="cb126-20" title="20">        <span class="op">{</span></a>
<a class="sourceLine" id="cb126-21" title="21">          <span class="dt">name</span><span class="op">:</span> <span class="st">&quot;Buy groceries&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb126-22" title="22">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb126-23" title="23">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb126-24" title="24">        <span class="op">},</span></a>
<a class="sourceLine" id="cb126-25" title="25">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb126-26" title="26">      <span class="op">{}</span></a>
<a class="sourceLine" id="cb126-27" title="27">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb126-28" title="28">  <span class="op">},</span></a>
<a class="sourceLine" id="cb126-29" title="29"></a>
<a class="sourceLine" id="cb126-30" title="30">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb126-31" title="31">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&quot;Tasks&quot;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb126-32" title="32">  <span class="op">},</span></a>
<a class="sourceLine" id="cb126-33" title="33"><span class="op">};</span></a></code></pre></div>
<p>Now run your seed files with the command below:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb127-1" title="1"><span class="ex">npx</span> dotenv sequelize db:seed:all</a></code></pre></div>
<p>After seeding, you should see the tasks you have created in your Postbird client:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postbird-4.png" alt="postbird-seed" /><figcaption>postbird-seed</figcaption>
</figure>
<h2 id="initial-router-setup">Initial router setup</h2>
<p>Now remember that you are creating this API to manage tasks. You’ll need a way to read a task, create a task, update a task, and delete a task in your database. You’ll also need to render error messages to the API in case any of your requests are unsuccessful.</p>
<p>Your skeleton has a basic Express application with a generic error handling function set up in <code>app.js</code>, but you still need to create routes before you can test your API with Postman. Create a <code>routes</code> directory in the root if your project. Within the <code>routes</code> folder, create an <code>index.js</code> file for your root-level router and a <code>tasks.js</code> file for your task router. In both files, begin by requiring <code>express</code> and creating a <code>router</code> with <code>express.Router()</code>.</p>
<p>To test that your API is up and working properly, let’s set up a route handler for a GET request to the <code>/</code> path in the <code>./routes/index.js</code> file. Have your result send JSON response with a message of <code>"Hello to the Express APIs demo app!"</code>. Lastly, make sure you export the router you just created.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb128-1" title="1"><span class="co">//- ./routes/index.js</span></a>
<a class="sourceLine" id="cb128-2" title="2"></a>
<a class="sourceLine" id="cb128-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb128-4" title="4"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb128-5" title="5"></a>
<a class="sourceLine" id="cb128-6" title="6"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb128-7" title="7">  <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span> <span class="dt">message</span><span class="op">:</span> <span class="st">&quot;Hello to the Express APIs demo app!&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb128-8" title="8"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb128-9" title="9"></a>
<a class="sourceLine" id="cb128-10" title="10"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Let’s connect your <code>tasks.js</code> route to your <code>Task</code> database model. Begin by requiring the database models from <code>../db/models</code> and using destructuring to get a reference to the <code>Task</code> model. Then set up a route handler for a GET request to the <code>/</code> path. Make sure you export the router you just created.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb129-1" title="1"><span class="co">//- ./routes/tasks.js</span></a>
<a class="sourceLine" id="cb129-2" title="2"></a>
<a class="sourceLine" id="cb129-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb129-4" title="4"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb129-5" title="5"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../db/models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb129-6" title="6"></a>
<a class="sourceLine" id="cb129-7" title="7"><span class="kw">const</span> <span class="op">{</span> Task <span class="op">}</span> <span class="op">=</span> db<span class="op">;</span></a>
<a class="sourceLine" id="cb129-8" title="8"></a>
<a class="sourceLine" id="cb129-9" title="9"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb129-10" title="10">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Fetch all tasks from the database (Read)</span></a>
<a class="sourceLine" id="cb129-11" title="11">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Render all tasks in JSON format</span></a>
<a class="sourceLine" id="cb129-12" title="12"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb129-13" title="13"></a>
<a class="sourceLine" id="cb129-14" title="14"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Since you are creating an API working with JSON data, you’ll want to update your <code>app.js</code> file to have your application <code>use</code> the <code>express.json()</code> middleware. The <code>express.json()</code> middleware is needed to parse request body content formatted in JSON so that it is available via the <code>req.body</code> property.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb130-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">json</span>())<span class="op">;</span></a></code></pre></div>
<p>At this moment, you should notice that you have a route defined in the <code>app</code> module for the <code>/</code> path. Remove the GET route to <code>/</code> in your <code>app.js</code>.</p>
<p>Lastly, in order to connect to the routes you have just created, import your <code>indexRouter</code> and your <code>tasksRouter</code>. In this demo, you will be using separate routers. Feel free to take a moment to review last Tuesday’s homework reading, "Using Separate Routers".</p>
<p>Mount your <code>indexRouter</code> with a path of <code>/</code> and mount your <code>tasksRouter</code> with a path of <code>/tasks</code>. Your <code>app.js</code> should look something like this:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb131-1" title="1"><span class="co">//- app.js</span></a>
<a class="sourceLine" id="cb131-2" title="2"></a>
<a class="sourceLine" id="cb131-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-4" title="4"><span class="kw">const</span> morgan <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;morgan&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-5" title="5"></a>
<a class="sourceLine" id="cb131-6" title="6"><span class="kw">const</span> <span class="op">{</span> environment <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./config&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-7" title="7"></a>
<a class="sourceLine" id="cb131-8" title="8"><span class="kw">const</span> indexRouter <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./routes/index&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-9" title="9"><span class="kw">const</span> tasksRouter <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./routes/tasks&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-10" title="10"></a>
<a class="sourceLine" id="cb131-11" title="11"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb131-12" title="12"></a>
<a class="sourceLine" id="cb131-13" title="13"><span class="va">app</span>.<span class="at">use</span>(<span class="at">morgan</span>(<span class="st">&quot;dev&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb131-14" title="14"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">json</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb131-15" title="15"></a>
<a class="sourceLine" id="cb131-16" title="16"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> indexRouter)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-17" title="17"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&quot;/tasks&quot;</span><span class="op">,</span> tasksRouter)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-18" title="18"></a>
<a class="sourceLine" id="cb131-19" title="19"><span class="co">// Catch unhandled requests and forward to error handler.</span></a>
<a class="sourceLine" id="cb131-20" title="20"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb131-21" title="21">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;The requested resource couldn&#39;t be found.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-22" title="22">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb131-23" title="23">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-24" title="24"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-25" title="25"></a>
<a class="sourceLine" id="cb131-26" title="26"><span class="co">// Custom error handlers.</span></a>
<a class="sourceLine" id="cb131-27" title="27"></a>
<a class="sourceLine" id="cb131-28" title="28"><span class="co">// Generic error handler.</span></a>
<a class="sourceLine" id="cb131-29" title="29"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb131-30" title="30">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-31" title="31">  <span class="kw">const</span> isProduction <span class="op">=</span> environment <span class="op">===</span> <span class="st">&quot;production&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb131-32" title="32">  <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb131-33" title="33">    <span class="dt">title</span><span class="op">:</span> <span class="va">err</span>.<span class="at">title</span> <span class="op">||</span> <span class="st">&quot;Server Error&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb131-34" title="34">    <span class="dt">message</span><span class="op">:</span> <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb131-35" title="35">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb131-36" title="36">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-37" title="37"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb131-38" title="38"></a>
<a class="sourceLine" id="cb131-39" title="39"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> app<span class="op">;</span></a></code></pre></div>
<p>Now you can start your server and open <code>http://localhost:8080/</code> in your browser to test your API’s index route! You should see your JSON response from the index route rendered in your application.</p>
<h2 id="global-error-handling">Global error handling</h2>
<p>As a reminder, the function below is not an error handler. Remember that error handlers always define four parameters: <code>err</code>, <code>req</code>, <code>res</code>, and <code>next</code>. This middleware function is designed to match any failed requests so that it can create and pass a 404 error into the <code>next()</code> method, which prompts Express to handle the request as an error.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb132-1" title="1"><span class="co">// Catch unhandled requests and forward to next error handler.</span></a>
<a class="sourceLine" id="cb132-2" title="2"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb132-3" title="3">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;The requested resource couldn&#39;t be found.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb132-4" title="4">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb132-5" title="5">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb132-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>After calling the <code>next()</code> method with an argument, Express will invoke the first defined error handler. Remember that a global error handling function is defined to process unhandled errors.</p>
<p>The below error handler renders global error messages in JSON and returns a <code>500 Server Error</code> if the <code>err</code> does not have a valid status or title.</p>
<p>Remember that you don’t want your error stack to be printed when running the application in production. This is why the <code>isProduction</code> variable is set to a boolean value determined by whether or not your application is in production. When your application is in production, the error will be rendered in JSON without the <code>err.stack</code>.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb133-1" title="1"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb133-2" title="2">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb133-3" title="3">  <span class="kw">const</span> isProduction <span class="op">=</span> environment <span class="op">===</span> <span class="st">&quot;production&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb133-4" title="4">  <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb133-5" title="5">    <span class="dt">title</span><span class="op">:</span> <span class="va">err</span>.<span class="at">title</span> <span class="op">||</span> <span class="st">&quot;Server Error&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb133-6" title="6">    <span class="dt">message</span><span class="op">:</span> <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb133-7" title="7">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb133-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb133-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="reading-all-tasks">Reading all tasks</h2>
<p>Now you’ll begin writing your routes to implement CRUD operations to your API.</p>
<p>As a reminder, CRUD stands for create, read, update, and delete. You’ll interact with your <code>Task</code> model to implement CRUD features by using the following built-in methods:</p>
<ul>
<li><code>Task.findAll()</code> to fetch all of your database tasks. (Read)</li>
<li><code>Task.findByPk()</code> to fetch a database task based on the <code>id</code> from your request parameters. (Read)</li>
<li><code>Task.create()</code> to generate a task in your database. (Create)</li>
<li><code>Task.update()</code> to update a task in your database. (Update)</li>
<li><code>Task.destroy()</code> to delete a task from your database. (Delete)</li>
</ul>
<p>First up, the writing the route to fetch all tasks!</p>
<p>Let’s bring back your <code>asyncHandler</code> to <em>catch</em> errors in a DRY way. Add the <code>asyncHandler</code> below to your <code>tasks.js</code> file:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb134-1" title="1"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span></a>
<a class="sourceLine" id="cb134-2" title="2">  <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a></code></pre></div>
<p>Now you can refactor the GET route to fetch all your tasks in the database. Because you are using the <code>async</code> keyword to pass the middleware function below into your <code>asyncHandler</code>, you can <code>await</code> database queries. Refactor your GET <code>/</code> route to <code>await</code> the fetch of all your tasks.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb135-1" title="1"><span class="va">router</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb135-2" title="2">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb135-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb135-4" title="4">    <span class="kw">const</span> tasks <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb135-5" title="5">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Render all tasks in JSON format</span></a>
<a class="sourceLine" id="cb135-6" title="6">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb135-7" title="7">)<span class="op">;</span></a></code></pre></div>
<p>Now you’ll want to render all tasks in JSON format by using <code>res.json({tasks})</code>.</p>
<p>Imagine you are rendering a list of users instead of a list of tasks. You wouldn’t want to expose every user’s private email or address. In the case of a user list, you could pluck out each user’s <code>username</code> and decide to only send that property to the client. Remember that it’s important to only send properties that the client needs and to be careful not to expose too much information.</p>
<p>At this point, your <code>tasks.js</code> file should look like this:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb136-1" title="1"><span class="co">//- ./routes/tasks.js</span></a>
<a class="sourceLine" id="cb136-2" title="2"></a>
<a class="sourceLine" id="cb136-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb136-4" title="4"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb136-5" title="5"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../db/models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb136-6" title="6"></a>
<a class="sourceLine" id="cb136-7" title="7"><span class="kw">const</span> <span class="op">{</span> Task <span class="op">}</span> <span class="op">=</span> db<span class="op">;</span></a>
<a class="sourceLine" id="cb136-8" title="8"></a>
<a class="sourceLine" id="cb136-9" title="9"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span></a>
<a class="sourceLine" id="cb136-10" title="10">  <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb136-11" title="11"></a>
<a class="sourceLine" id="cb136-12" title="12"><span class="va">router</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb136-13" title="13">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb136-14" title="14">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb136-15" title="15">    <span class="kw">const</span> tasks <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb136-16" title="16">    <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span> tasks <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb136-17" title="17">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb136-18" title="18">)<span class="op">;</span></a>
<a class="sourceLine" id="cb136-19" title="19"></a>
<a class="sourceLine" id="cb136-20" title="20"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Now start your server with <code>npm start</code> and go into Postman to make a GET request to <code>localhost:8080/tasks</code> and test the route you have just created! As a reminder, your request should go to <code>/tasks</code> even though you defined a router for the <code>/</code> path because of how you are using the <code>tasksRouter</code> with the <code>/tasks</code> path in your <code>app.js</code>. Every router you create in your <code>tasks.js</code> file just adds its path onto the <code>/tasks</code> route you designated for <code>tasksRouter</code>. You should see the all your tasks from the database render in the response <code>Body</code>.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postman-1.gif" alt="postman-test-read-tasks-index" /><figcaption>postman-test-read-tasks-index</figcaption>
</figure>
<p>Note that if you use your browser to navigate to <code>localhost:8080/tasks</code>, you’ll see the same response rendered as in Postman. This is because you are sending a GET request in Postman and your browser automatically sends a GET request when visiting <code>localhost:8080/tasks</code>.</p>
<h2 id="create-a-task">Create a task</h2>
<p>Now you’ll work on setting up a POST <code>/tasks</code> route to create a task.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb137-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb137-2" title="2">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb137-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb137-4" title="4">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Create and render a task in JSON</span></a>
<a class="sourceLine" id="cb137-5" title="5">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb137-6" title="6">)<span class="op">;</span></a></code></pre></div>
<p>Begin by extracting the task <code>name</code> from the <code>req.body</code>. Then, use <code>Task.create()</code> to to instantiate a <code>task</code> and save it to the database. Lastly, render the <code>task</code> in a JSON response with a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/201">created status</a> of <code>201</code>. Your POST route should look something like this:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb138-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb138-2" title="2">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb138-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb138-4" title="4">    <span class="kw">const</span> <span class="op">{</span> name <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb138-5" title="5">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">create</span>(<span class="op">{</span> name <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb138-6" title="6">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">201</span>).<span class="at">json</span>(<span class="op">{</span> task <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb138-7" title="7">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb138-8" title="8">)<span class="op">;</span></a></code></pre></div>
<p>You can test this route by making a POST request to <code>/tasks</code> in Postman to create a task. Make sure to edit your <code>Headers</code> by adding a <code>Content-Type</code> header with a value of <code>application/json</code>. Send your POST request data through the <code>Body</code> by using the <code>raw</code> format and selecting <code>JSON</code> in the dropdown to create a task.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-2a.gif" alt="postman-test-create-valid-task" /><figcaption>postman-test-create-valid-task</figcaption>
</figure>
<p>After you have created a task, verify your success in Postbird.</p>
<h3 id="validate-data">Validate data</h3>
<p>Now it’s time to validate your data. You can use the combination of the <code>express-validator</code> middleware with a custom middleware function to do so. The <code>express-validator</code> middleware will validate your data and the custom middleware function will create a <code>400 Bad request.</code> error response upon invalid data.</p>
<p>Import <code>check</code> and <code>validationResult</code> from <code>express-validator</code> to add validations to your application by adding the following line to in your <code>tasks.js</code> file:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb139-1" title="1"><span class="kw">const</span> <span class="op">{</span> check<span class="op">,</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express-validator&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now create your array of validation middleware functions with <code>check</code> from <code>express-validator</code> to validate incoming task data:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb140-1" title="1"><span class="kw">const</span> validateTask <span class="op">=</span> [</a>
<a class="sourceLine" id="cb140-2" title="2">  <span class="co">//  Task name cannot be empty:</span></a>
<a class="sourceLine" id="cb140-3" title="3">  <span class="at">check</span>(<span class="st">&quot;name&quot;</span>)</a>
<a class="sourceLine" id="cb140-4" title="4">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb140-5" title="5">    .<span class="at">withMessage</span>(<span class="st">&quot;Task name can&#39;t be empty.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb140-6" title="6">  <span class="co">//  Task name cannot be longer than 255 characters:</span></a>
<a class="sourceLine" id="cb140-7" title="7">  <span class="at">check</span>(<span class="st">&quot;name&quot;</span>)</a>
<a class="sourceLine" id="cb140-8" title="8">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">255</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb140-9" title="9">    .<span class="at">withMessage</span>(<span class="st">&quot;Task name can&#39;t be longer than 255 characters.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb140-10" title="10">]<span class="op">;</span></a></code></pre></div>
<p>Now define a custom middleware function that checks to see if the request has any validation errors:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb141-1" title="1"><span class="kw">const</span> handleValidationErrors <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb141-2" title="2">  <span class="kw">const</span> validationErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb141-3" title="3"></a>
<a class="sourceLine" id="cb141-4" title="4">  <span class="co">// If the validation errors are empty,</span></a>
<a class="sourceLine" id="cb141-5" title="5">  <span class="cf">if</span> (<span class="op">!</span><span class="va">validationErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb141-6" title="6">    <span class="co">// Generate an array of error messages</span></a>
<a class="sourceLine" id="cb141-7" title="7">    <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validationErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb141-8" title="8"></a>
<a class="sourceLine" id="cb141-9" title="9">    <span class="co">// Generate a new `400 Bad request.` Error object</span></a>
<a class="sourceLine" id="cb141-10" title="10">    <span class="co">// and invoke the next function passing in `err`</span></a>
<a class="sourceLine" id="cb141-11" title="11">    <span class="co">// to pass control to the global error handler.</span></a>
<a class="sourceLine" id="cb141-12" title="12">    <span class="kw">const</span> err <span class="op">=</span> <span class="at">Error</span>(<span class="st">&quot;Bad request.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb141-13" title="13">    <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></a>
<a class="sourceLine" id="cb141-14" title="14">    <span class="va">err</span>.<span class="at">title</span> <span class="op">=</span> <span class="st">&quot;Bad request.&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb141-15" title="15">    <span class="va">err</span>.<span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></a>
<a class="sourceLine" id="cb141-16" title="16">    <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb141-17" title="17">  <span class="op">}</span></a>
<a class="sourceLine" id="cb141-18" title="18"></a>
<a class="sourceLine" id="cb141-19" title="19">  <span class="co">// Invoke the next middleware function</span></a>
<a class="sourceLine" id="cb141-20" title="20">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb141-21" title="21"><span class="op">};</span></a></code></pre></div>
<p>Your validated POST route should look something like this:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb142-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb142-2" title="2">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb142-3" title="3">  validateTask<span class="op">,</span></a>
<a class="sourceLine" id="cb142-4" title="4">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb142-5" title="5">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb142-6" title="6">    <span class="kw">const</span> <span class="op">{</span> name <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb142-7" title="7">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">create</span>(<span class="op">{</span> name <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb142-8" title="8">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">201</span>).<span class="at">json</span>(<span class="op">{</span> task <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb142-9" title="9">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb142-10" title="10">)<span class="op">;</span></a></code></pre></div>
<p>You should now receive errors for creating a task with invalid data. Take note about how you are receiving an error <code>status</code> of <code>400</code>.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-2b.png" alt="postman-test-create-invalid-task" /><figcaption>postman-test-create-invalid-task</figcaption>
</figure>
<h2 id="read-a-task">Read a task</h2>
<p>Now it’s time to set up a route for reading a specific task. You’ll use the <code>id</code> from the <code>req.params</code> object. Begin by parsing the <code>id</code> and using <code>Task.findByPk()</code> to fetch the database task that matches the <code>id</code>. If the task was found, you’ll render a JSON response.</p>
<p>As a reminder, <code>req.params</code> is an object that holds values parsed from your URL path. For example, reading the URL path to fetch your task with an <code>id</code> of <code>1</code> is <code>/tasks/1</code>. Since you have defined the GET route for a <code>/:id</code> path, your request parameters (<code>req.params</code>) will have a key of <code>id</code> with a value of <code>1</code>.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb143-1" title="1"><span class="va">router</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb143-2" title="2">  <span class="st">&quot;/:id(</span><span class="sc">\\</span><span class="st">d+)&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb143-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb143-4" title="4">    <span class="kw">const</span> taskId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb143-5" title="5">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">findByPk</span>(taskId)<span class="op">;</span></a>
<a class="sourceLine" id="cb143-6" title="6">    <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span> task <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb143-7" title="7">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb143-8" title="8">)<span class="op">;</span></a></code></pre></div>
<p>Test your new route with Postman!</p>
<figure>
<img src="images/api-tasks-reading-postman-3a.png" alt="postman-test-read-task" /><figcaption>postman-test-read-task</figcaption>
</figure>
<p>However, what if you are querying for a task <code>id</code> that is not in your system? You’ll need to set up error handling to return a <code>404 Task not found.</code> error if the <code>id</code> is invalid. You’ll want to instantiate a new <code>Error</code> object with an error message about the invalid <code>id</code>. The <code>Error</code> object should have a <code>title</code> of "Task not found." and a <code>status</code> of "404".</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb144-1" title="1"><span class="kw">const</span> taskNotFoundError <span class="op">=</span> (id) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb144-2" title="2">  <span class="kw">const</span> err <span class="op">=</span> <span class="at">Error</span>(<span class="vs">`Task with id of </span><span class="sc">${</span>id<span class="sc">}</span><span class="vs"> could not be found.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb144-3" title="3">  <span class="va">err</span>.<span class="at">title</span> <span class="op">=</span> <span class="st">&quot;Task not found.&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb144-4" title="4">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb144-5" title="5">  <span class="cf">return</span> err<span class="op">;</span></a>
<a class="sourceLine" id="cb144-6" title="6"><span class="op">};</span></a></code></pre></div>
<p>You’ll also need to refactor your GET route for <code>/:id</code>. Make sure to add <code>next</code> as a parameter. You’ll call the <code>next()</code> method by passing in the return value from the <code>taskNotFoundError(taskId)</code> function call.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb145-1" title="1"><span class="va">router</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb145-2" title="2">  <span class="st">&quot;/:id(</span><span class="sc">\\</span><span class="st">d+)&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb145-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb145-4" title="4">    <span class="kw">const</span> taskId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb145-5" title="5">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">findByPk</span>(taskId)<span class="op">;</span></a>
<a class="sourceLine" id="cb145-6" title="6"></a>
<a class="sourceLine" id="cb145-7" title="7">    <span class="cf">if</span> (task) <span class="op">{</span></a>
<a class="sourceLine" id="cb145-8" title="8">      <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span> task <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb145-9" title="9">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb145-10" title="10">      <span class="at">next</span>(<span class="at">taskNotFoundError</span>(taskId))<span class="op">;</span></a>
<a class="sourceLine" id="cb145-11" title="11">    <span class="op">}</span></a>
<a class="sourceLine" id="cb145-12" title="12">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb145-13" title="13">)<span class="op">;</span></a></code></pre></div>
<p>Now test your <code>taskNotFoundError</code> function by making a request with an invalid <code>id</code>:</p>
<figure>
<img src="images/api-tasks-reading-postman-3b.png" alt="postman-test-task-not-found" /><figcaption>postman-test-task-not-found</figcaption>
</figure>
<h2 id="update-a-task">Update a task</h2>
<p>You can update a task with either a PUT or PATCH request. The key difference between PUT/PATCH is that a PUT request replaces an object in its entirety while a PATCH request only updates specific attributes.</p>
<p>It’s time to set up a route for updating a task with a PUT request. Parse the task <code>id</code> within your <code>req.params</code> and use the parsed <code>taskId</code> to fetch the <code>task</code> to update. If you have a valid task, await the update and then render the updated <code>task</code> in JSON format.</p>
<p>Don’t forget to use the same data validations that the create route used so that you receive the same type of error messages. Lastly, make sure to pass your <code>taskId</code> into your <code>taskNotFoundError</code> function call to generate a <code>404</code> error if the task does not exist. Then pass the return value of the <code>taskNotFoundError</code> function call into the <code>next</code> method to invoke the global error handler.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb146-1" title="1"><span class="va">router</span>.<span class="at">put</span>(</a>
<a class="sourceLine" id="cb146-2" title="2">  <span class="st">&quot;/:id(</span><span class="sc">\\</span><span class="st">d+)&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb146-3" title="3">  validateTask<span class="op">,</span></a>
<a class="sourceLine" id="cb146-4" title="4">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb146-5" title="5">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb146-6" title="6">    <span class="kw">const</span> taskId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb146-7" title="7">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">findByPk</span>(taskId)<span class="op">;</span></a>
<a class="sourceLine" id="cb146-8" title="8"></a>
<a class="sourceLine" id="cb146-9" title="9">    <span class="cf">if</span> (task) <span class="op">{</span></a>
<a class="sourceLine" id="cb146-10" title="10">      <span class="cf">await</span> <span class="va">task</span>.<span class="at">update</span>(<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">name</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb146-11" title="11">      <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span> task <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb146-12" title="12">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb146-13" title="13">      <span class="at">next</span>(<span class="at">taskNotFoundError</span>(taskId))<span class="op">;</span></a>
<a class="sourceLine" id="cb146-14" title="14">    <span class="op">}</span></a>
<a class="sourceLine" id="cb146-15" title="15">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb146-16" title="16">)<span class="op">;</span></a></code></pre></div>
<p>Begin by sending a GET request to <code>localhost:8080/tasks/2</code> to view the data of your second task:</p>
<figure>
<img src="images/api-tasks-reading-postman-4a.png" alt="postman-get-task-before-update" /><figcaption>postman-get-task-before-update</figcaption>
</figure>
<p>Like when testing your create route, make sure to add a <code>Content-Type</code> header with a value of <code>application/json</code>. Send your PUT request data through the <code>Body</code> by using the <code>raw</code> format and selecting <code>JSON</code> in the dropdown to update the task name:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-4b.gif" alt="postman-test-task-update" /><figcaption>postman-test-task-update</figcaption>
</figure>
<p>Lastly, erase the <code>name</code> value and send a PUT request to test your error handling for invalid update data:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-4c.gif" alt="postman-test-invalid-task-update" /><figcaption>postman-test-invalid-task-update</figcaption>
</figure>
<h2 id="delete-a-task">Delete a task</h2>
<p>It’s time to create the last route! Set up the route for deleting a task and verify that it was properly deleted using Postbird.</p>
<p>You’ll begin by parsing the <code>taskId</code> and using the id to find your <code>task</code> to delete. If a valid <code>task</code> is found, destroy the task and render a <code>204 NO CONTENT</code> response with <code>res.status(204).end()</code> to confirm the deletion. If there is no valid task, pass the <code>taskId</code> into your <code>taskNotFoundError</code> function call to generate a <code>404</code> error. Then pass the return value of the <code>taskNotFoundError</code> function call into the <code>next</code> method to invoke the global error handler.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb147-1" title="1"><span class="va">router</span>.<span class="at">delete</span>(</a>
<a class="sourceLine" id="cb147-2" title="2">  <span class="st">&quot;/:id(</span><span class="sc">\\</span><span class="st">d+)&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb147-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb147-4" title="4">    <span class="kw">const</span> taskId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb147-5" title="5">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">findByPk</span>(taskId)<span class="op">;</span></a>
<a class="sourceLine" id="cb147-6" title="6"></a>
<a class="sourceLine" id="cb147-7" title="7">    <span class="cf">if</span> (task) <span class="op">{</span></a>
<a class="sourceLine" id="cb147-8" title="8">      <span class="cf">await</span> <span class="va">task</span>.<span class="at">destroy</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb147-9" title="9">      <span class="va">res</span>.<span class="at">status</span>(<span class="dv">204</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb147-10" title="10">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb147-11" title="11">      <span class="at">next</span>(<span class="at">taskNotFoundError</span>(taskId))<span class="op">;</span></a>
<a class="sourceLine" id="cb147-12" title="12">    <span class="op">}</span></a>
<a class="sourceLine" id="cb147-13" title="13">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb147-14" title="14">)<span class="op">;</span></a></code></pre></div>
<p>Now test your route and send a DELETE request to <code>localhost:8080/tasks/2</code> to delete your task with an id of <code>2</code>:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-5a.png" alt="postman-test-task-deletion" /><figcaption>postman-test-task-deletion</figcaption>
</figure>
<p>Notice how there is no task with an id of <code>2</code> in the <code>Tasks</code> table <code>Content</code> in Postbird:</p>
<figure>
<img src="images/api-tasks-reading-postbird-5b.png" alt="postbird-test-task-deletion" /><figcaption>postbird-test-task-deletion</figcaption>
</figure>
<p>Now you’ll want to test your <code>taskNotFoundError</code> handler to ensure that it takes care of trying to delete tasks that are not found:</p>
<figure>
<img src="images/api-tasks-reading-postman-5c.png" alt="postman-test-invalid-task-deletion" /><figcaption>postman-test-invalid-task-deletion</figcaption>
</figure>
<h2 id="what-youve-learned">What you’ve learned</h2>
<p>You now know how to define a collection of route endpoints to perform CRUD operations. You know how to return responses to the client with appropriate HTTP status codes. You have also used the built-in <code>express.json()</code> middleware function to parse request body content in JSON format.</p>
<p>In the project, you used Postbird to view your database while using Postman to test your API. Within your routes, you transformed data for responses and processed errors to return appropriate responses (status codes and content).</p>
<p>Now that you’ve learned how to create your own REST API, you can create a client-side project that utilizes your own API! As a reminder, you can use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a> in your client-side project to easily fetch data to render in your views.</p>
<hr />
<h1 id="cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</h1>
<p>Now that you’ve built out an API, it’s time to build out a client to interact with this API. You have a couple of choices here: you can either serve this client application out of the same server or you can build out a separate client application that’s served from a different server.</p>
<p>Serving the client out of your API server reduces complexity and makes the development experience simpler. However, you might want to serve the client and the API out of different servers in order to reduce the overall load on one single server and to improve maintainability of your application as it grows over time.</p>
<p>In this lesson, you’ll build out a client that’s completely separate from the API server. Along the way, you’ll learn about the Cross-Origin Resource Sharing (CORS) issues that need to be considered when accessing API resources from a different origin. By the end of this lesson, you will:</p>
<ol type="1">
<li>Understand that by default a web application running in the browser can only access API resources from the same origin (i.e. domain, protocol, port).</li>
<li>Understand that an API can be configured to use Cross-Origin Resource Sharing (CORS) to grant web applications from a different origin access to some or all of its resources.</li>
<li>Use the <a href="https://www.npmjs.com/package/cors">cors npm package</a> to enable cross-origin resource sharing.</li>
</ol>
<h2 id="why-cors">Why CORS</h2>
<p>In the previous reading, you built out a RESTful API to perform CRUD operations on tasks. Let’s now build out a client to interact with that API.</p>
<h3 id="demo-project-setup">Demo project setup</h3>
<p>To do this, begin by cloning the project skeleton for this frontend:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb148-1" title="1"><span class="fu">git</span> clone https://github.com/-starters/express-apis-frontend.git</a></code></pre></div>
<p>Much of this starter repo should be pretty familiar. There’s an Express server at <code>index.js</code> that’s currently handling GET requests to <code>'/'</code> by rendering the <code>index.pug</code> template.</p>
<p>The <code>index.pug</code> template extends <code>layout.pug</code>. In the head tag of <code>layout.pug</code>, there are two links: one that fetches the <a href="https://getbootstrap.com/docs/4.3/getting-started/introduction/">bootstrap stylesheets</a> and one that imports a CSS file called <code>style.css</code>.</p>
<p>Here’s what’s going on: in <code>index.js</code>, the Express application is using a built-in middleware function called <code>express.static</code>. This middleware function allows the application to serve static assets, such as JavaScript, CSS, or image files, out of a specific directory.</p>
<p>In this repo, the server has been configured to serve the files that are in <code>public</code> as static assets: <code>app.use(express.static(path.join(__dirname, "public")));</code>.</p>
<p>To see what this means, go ahead and run <code>npm install</code> and then start up the server by running <code>npm start</code>. Then, go to <code>localhost:4000/style.css</code> to see the server serving up the <code>style.css</code> file. So in essence, the <code>link(rel="stylesheet" type="text/css" href="style.css")</code> tag that you see in <code>layout.pug</code> is effectively the same as <code>link(rel="stylesheet" type="text/css" href="http://localhost:4000/style.css")</code>.</p>
<p>This was a pretty high-level overview of the <code>express.static</code> middleware function, and you can read more about how this works in the <a href="https://expressjs.com/en/starter/static-files.html">Express documentation on serving static files</a>.</p>
<h3 id="attempting-to-fetch-all-tasks">Attempting to fetch all tasks</h3>
<p>Now, if you look inside of <code>index.pug</code>, there’s a script tag that’s importing the <code>public/js/index.js</code> JavaScript file. Confirm that this importing is working by navigating to <code>localhost:4000/</code>. There’s currently a <code>console.log</code> statement in <code>public/js/index.js</code>, so at this point, you should see a "Hello from index.js!" statement when you open the browser console.</p>
<p>Let’s replace that <code>console.log</code> with some code to fetch all the tasks from the API that you built in the previous reading. Be sure that the API is up and running on <code>localhost:8080</code>. Then, let’s use the Fetch API to make a GET request for all of the tasks.</p>
<p>A few weeks ago, you went over a quick overview of the Fetch API. As a reminder, the Fetch API is used to make HTTP requests. It uses Promises to handle the asynchronous nature of HTTP requests and responses.</p>
<p>You learned that the <code>fetch</code>’s first argument is the URL that you want to make a request to while the second argument is an optional <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#Supplying_request_options">options</a> object.</p>
<p>Take a moment to review this example fetch from MDN. The comments denote the possible values for each key in the additional <code>options</code> object.</p>
<p>Out of the all of the <code>options</code>, you’ll primarily be working with <code>method</code>, <code>headers</code>, and <code>body</code> today:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb149-1" title="1"><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(url<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb149-2" title="2">  <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="co">// GET, POST, PUT, DELETE, etc.</span></a>
<a class="sourceLine" id="cb149-3" title="3">  <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb149-4" title="4">    <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb149-5" title="5">  <span class="op">},</span></a>
<a class="sourceLine" id="cb149-6" title="6">  <span class="dt">body</span><span class="op">:</span> <span class="va">JSON</span>.<span class="at">stringify</span>(data)<span class="op">,</span> <span class="co">// body data type must match &quot;Content-Type&quot; header</span></a>
<a class="sourceLine" id="cb149-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now that you’ve reviewed the Fetch API, let’s use it in <code>public/js/index.js</code> to fetch all tasks from the API server.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb150-1" title="1"><span class="co">// public/js/index.js</span></a>
<a class="sourceLine" id="cb150-2" title="2"></a>
<a class="sourceLine" id="cb150-3" title="3"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb150-4" title="4">  <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/tasks&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb150-5" title="5">  <span class="kw">const</span> <span class="op">{</span> tasks <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb150-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(tasks)<span class="op">;</span></a>
<a class="sourceLine" id="cb150-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>In the code snippet above, an event listener is set up for the <code>DOMContentLoaded</code> event, so when all of the HTML elements are loaded, it fires a fetch request to the API server. Looking in the console, we can see that this failed:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/cors-error.png" alt="cors error" /><figcaption>cors error</figcaption>
</figure>
<h3 id="cors">CORS</h3>
<p>The error message mentions that the request was blocked by "CORS policy". Cross-Origin Resource Sharing means being able to access resources that are located at an origin different than the origin of the application that’s making the request. Simply put, in this case, the origin of this fetch request was made from <code>localhost:4000</code>, and the tasks resources are located at <code>localhost:8080</code>.</p>
<p>To clarify, being from the same origin means having the same protocol (http vs https), domain, and port number. In our current example, both the client and the API server are using the same protocol (http) and domain (localhost), but are served on different ports, which is why it’s considered a cross-origin request.</p>
<p>By default, browsers prevent cross-origin requests from happening for security reasons. Although this might make life a little more difficult for developers, restricting this type of requests is a good thing that reduces the number of attack vectors against your applications.</p>
<p>This cross-origin restriction is enforced by browsers, so if you were to make a server-side request to the API, there’s nothing preventing that by default.</p>
<h2 id="setting-up-cors">Setting up CORS</h2>
<p>Although Cross-Origin Resource Sharing is prevented by default, you can configure your API server to allow these types of cross-origin requests from trusted origins. Let’s walk through an example of how to do this with your API.</p>
<p>To start, install the <a href="https://www.npmjs.com/package/cors">cors npm package</a> by running <code>npm install cors</code>. Be sure that you’re in the correct directory (the API server) when you’re running this.</p>
<h3 id="setting-up-cors-to-fetch-all-tasks">Setting up CORS to fetch all tasks</h3>
<p>Now, go to <code>routes/tasks.js</code>. In there, import the <code>cors</code> middleware at the top of the file. Then, go down to <code>router.get("/")</code> and add the <code>cors()</code> middleware function. Here’s what your <code>routes/tasks.js</code> file should look like:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb151-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb151-2" title="2"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../db/models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb151-3" title="3"><span class="kw">const</span> <span class="op">{</span> check<span class="op">,</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express-validator&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb151-4" title="4"><span class="kw">const</span> cors <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;cors&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb151-5" title="5"></a>
<a class="sourceLine" id="cb151-6" title="6"><span class="co">// CODE IN BETWEEN NOT SHOWN</span></a>
<a class="sourceLine" id="cb151-7" title="7"></a>
<a class="sourceLine" id="cb151-8" title="8"><span class="va">router</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb151-9" title="9">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb151-10" title="10">  <span class="at">cors</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb151-11" title="11">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb151-12" title="12">    <span class="kw">const</span> tasks <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb151-13" title="13">    <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span> tasks <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb151-14" title="14">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb151-15" title="15">)<span class="op">;</span></a>
<a class="sourceLine" id="cb151-16" title="16"></a>
<a class="sourceLine" id="cb151-17" title="17"><span class="co">// REST OF CODE NOT SHOWN</span></a></code></pre></div>
<p>Now, if you go back to <code>localhost:4000/</code> and refresh, the console should no longer show the CORS error. Instead, it should be showing the list of tasks from your API. Yay!</p>
<p>Let’s do more than just console logging the tasks. In your <code>views/index.pug</code> (in the frontend project), add a div with a class name of "tasks-container":</p>
<pre class="pug"><code>extends layout.pug

block content
  h1 Hello World!
  div.tasks-container
  script(src=&quot;js/index.js&quot;)</code></pre>
<p>Then, in <code>public/js/index.js</code>, manipulate the DOM to add the tasks to the "tasks-container" div. Feel free to use some Bootstrap class names to style the task items:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb153-1" title="1"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-2" title="2">  <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/tasks&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-3" title="3">  <span class="kw">const</span> <span class="op">{</span> tasks <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb153-4" title="4"></a>
<a class="sourceLine" id="cb153-5" title="5">  <span class="kw">const</span> tasksContainer <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.tasks-container&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-6" title="6">  <span class="kw">const</span> tasksHtml <span class="op">=</span> <span class="va">tasks</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb153-7" title="7">    (<span class="op">{</span> name <span class="op">}</span>) <span class="kw">=&gt;</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb153-8" title="8"><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></a>
<a class="sourceLine" id="cb153-9" title="9"><span class="vs">        &lt;div class=&quot;card-body&quot;&gt;</span></a>
<a class="sourceLine" id="cb153-10" title="10"><span class="vs">          &lt;p class=&quot;card-text&quot;&gt;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb153-11" title="11"><span class="vs">        &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb153-12" title="12"><span class="vs">      &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb153-13" title="13"><span class="vs">    `</span></a>
<a class="sourceLine" id="cb153-14" title="14">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb153-15" title="15">  <span class="va">tasksContainer</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">tasksHtml</span>.<span class="at">join</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-16" title="16"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Next, let’s set up a view for creating a task.</p>
<h3 id="attempt-to-create-a-task">Attempt to create a task</h3>
<p>First, in <code>views/index.pug</code>, add a link to the "/create" page. Also, go ahead and update the <code>h1</code> to say "Task List" instead:</p>
<pre class="pug"><code>extends layout.pug

block content
  h1 Task List
  div.tasks-container
  a(class=&quot;btn btn-primary&quot; href=&quot;/create&quot;) Create Task
  script(src=&quot;js/index.js&quot;)</code></pre>
<p>Next, set up a <code>views/create.pug</code> template that would allow someone to create a task:</p>
<pre class="pug"><code>extends layout.pug

block content
  .errors-container
  form(class=&quot;create-form&quot;)
    .form-group
      label(for=&#39;name&#39;) Task name
      input#name.form-control(type=&#39;text&#39;, name=&quot;name&quot;, placeholder=&#39;Task name&#39;)
    button.btn.btn-primary(type=&#39;submit&#39;) Create Task

  script(src=&quot;js/create.js&quot;)</code></pre>
<p>Notice how in the template above, it imports a new script at <code>js/create.js</code>. Create a new <code>public/js/create.js</code> file. In there, set up the JavaScript that would make a POST request to <code>localhost:8080/tasks</code> when the "Create Task" form is submitted:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb156-1" title="1"><span class="kw">const</span> form <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.create-form&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb156-2" title="2"></a>
<a class="sourceLine" id="cb156-3" title="3"><span class="va">form</span>.<span class="at">addEventListener</span>(<span class="st">&quot;submit&quot;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb156-4" title="4">  <span class="va">e</span>.<span class="at">preventDefault</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb156-5" title="5">  <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>(form)<span class="op">;</span></a>
<a class="sourceLine" id="cb156-6" title="6">  <span class="kw">const</span> name <span class="op">=</span> <span class="va">formData</span>.<span class="at">get</span>(<span class="st">&quot;name&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb156-7" title="7">  <span class="kw">const</span> body <span class="op">=</span> <span class="op">{</span> name <span class="op">};</span></a>
<a class="sourceLine" id="cb156-8" title="8">  <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/tasks&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb156-9" title="9">    <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb156-10" title="10">    <span class="dt">body</span><span class="op">:</span> <span class="va">JSON</span>.<span class="at">stringify</span>(body)<span class="op">,</span></a>
<a class="sourceLine" id="cb156-11" title="11">    <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb156-12" title="12">      <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb156-13" title="13">    <span class="op">},</span></a>
<a class="sourceLine" id="cb156-14" title="14">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb156-15" title="15"></a>
<a class="sourceLine" id="cb156-16" title="16">  <span class="va">window</span>.<span class="va">location</span>.<span class="at">href</span> <span class="op">=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb156-17" title="17"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>In the code above, when a task is successfully created, the use gets redirected back to the home page (<code>localhost:4000/</code>) where all of the tasks are displayed. The user is redirected by setting <code>window.location.href</code> equal to <code>"/"</code>.</p>
<p>Then, in <code>index.js</code>, set up a route handler for <code>app.get('/create')</code>:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb157-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/create&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb157-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;create&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb157-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Finally, when you click on the <code>Create Task</code> button on the home page, it should take you to a form that looks like this:</p>
<figure>
<img src="images/create-task-form.png" alt="Create Task Form" /><figcaption>Create Task Form</figcaption>
</figure>
<p>If we review back in the <code>public/js/index.js</code> file, when someone fills out the task name field and then submits this form, it should make a POST request to the API server to create a task.</p>
<blockquote>
<p><strong>Note:</strong> The API requests that you’ve added so far do not implement proper error handling because it’s more important to focus on the CORS-related code for now. In tomorrow’s project, you’ll get a more in-depth overview of how to properly handle fetch errors.</p>
</blockquote>
<p>At this point, you might be thinking to yourself, "Wait a second, this is <em>obviously</em> going to fail because we haven’t configured CORS for this specific route yet." And you’re right! So let’s go ahead and add the <code>cors()</code> middleware function to <code>routes/tasks.js</code> in the API:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb158-1" title="1"><span class="co">// POST /tasks (Create)</span></a>
<a class="sourceLine" id="cb158-2" title="2"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb158-3" title="3">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb158-4" title="4">  <span class="at">cors</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb158-5" title="5">  validateTask<span class="op">,</span></a>
<a class="sourceLine" id="cb158-6" title="6">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb158-7" title="7">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb158-8" title="8">    <span class="kw">const</span> <span class="op">{</span> name <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb158-9" title="9">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">create</span>(<span class="op">{</span> name <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb158-10" title="10">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">201</span>).<span class="at">json</span>(<span class="op">{</span> task <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb158-11" title="11">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb158-12" title="12">)<span class="op">;</span></a></code></pre></div>
<p>Great, let’s fill out a task name and then submit this form. And…it failed. It failed with the same CORS error that you previously saw. How frustrating!</p>
<p>So what happened there? Well it turns out that when it comes to CORS, there are actually two types of requests: simple requests and not-so-simple requests.</p>
<p>According to the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">MDN docs on CORS</a>, in order to be considered a "simple" request, it must meet <strong>all</strong> of the following criteria:</p>
<ol type="1">
<li>It has to be one of these HTTP methods: <code>GET</code>, <code>HEAD</code>, or <code>POST</code>.</li>
<li>It can only have "CORS-safelisted request-headers". Essentially this means that if you manually set a header that’s not included on the <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">safelisted request headers list</a>, then the request is no longer a "simple" request.</li>
<li>The <code>Content-Type</code> must be <code>application/x-www-form-urlencoded</code>, <code>multipart/form-data</code>, or <code>text/plain</code>.</li>
</ol>
<p>In the case of the task creation form, it met the first criteria since it was a POST request. It also met the second criteria since the only request header you set was <code>Content-Type</code>, which is on the <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">safelisted request headers list</a>. Unfortunately, because the <code>Content-Type</code> was <code>application/json</code>, it failed the third criteria.</p>
<h2 id="preflighted-requests">Preflighted requests</h2>
<p>What happens when the request is not considered to be a "simple" request?</p>
<p>When the request does not meet all three criteria, then the browser takes some extra precaution and actually makes a preflighted <code>OPTIONS</code> request to the server before making the actual request.</p>
<p>In other words, when it comes to a "not-so-simple" cross-origin request, there are actually two HTTP requests being made. First, a request is made with an <code>OPTIONS</code> method, and if the server responds successfully, then the actual request would go through:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/preflight.svg" alt="preflight" /><figcaption>preflight</figcaption>
</figure>
<p>The problem right now is that because CORS is only set up for the <code>POST /tasks</code> endpoint, when the first <code>OPTIONS</code> request is made, it fails the CORS check:</p>
<figure>
<embed src="images/preflight-fail.svgimages/preflight-fail.svg____________________" /><figcaption>preflight failure</figcaption>
</figure>
<p>To resolve this, go back to <code>routes/tasks.js</code> and set up CORS for the <code>OPTIONS</code> route to "/tasks". As a reminder, the entire <code>tasks</code> router is nested under <code>"/tasks"</code>, so you don’t need to define "/tasks" in the route handler path again:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb159-1" title="1"><span class="co">// POST /tasks (Create)</span></a>
<a class="sourceLine" id="cb159-2" title="2"><span class="va">router</span>.<span class="at">options</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="at">cors</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb159-3" title="3"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb159-4" title="4">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb159-5" title="5">  <span class="at">cors</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb159-6" title="6">  validateTask<span class="op">,</span></a>
<a class="sourceLine" id="cb159-7" title="7">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb159-8" title="8">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb159-9" title="9">    <span class="kw">const</span> <span class="op">{</span> name <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb159-10" title="10">    <span class="kw">const</span> task <span class="op">=</span> <span class="cf">await</span> <span class="va">Task</span>.<span class="at">create</span>(<span class="op">{</span> name <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb159-11" title="11">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">201</span>).<span class="at">json</span>(<span class="op">{</span> task <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb159-12" title="12">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb159-13" title="13">)<span class="op">;</span></a></code></pre></div>
<p>Now, when you try to create the task, both routes are configured for CORS!</p>
<h2 id="setting-up-cors-for-the-entire-api">Setting up CORS for the entire API</h2>
<p>You’ve now properly configured CORS for two of your API endpoints. Unfortunately, there are currently a couple of problems.</p>
<p>First, it would be pretty tedious to have to add the <code>cors()</code> middleware function individually to every single route. In addition, you would also have to think through whether or not the specific requests would also require the associated <code>options</code> route to be set up to handle CORS.</p>
<p>Second, right now those two endpoints are configured to allow requests from <em>any</em> origin. In terms of security, that’s a bad idea. You only want to allow requests from origins that you know and trust.</p>
<p>Let’s address both of these issues.</p>
<p>First, in your API’s <code>app.js</code>, import the <code>cors</code> middleware function at the top and then configure for the entire application to use that middleware function:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb160-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb160-2" title="2"><span class="kw">const</span> morgan <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;morgan&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb160-3" title="3"><span class="kw">const</span> cors <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;cors&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb160-4" title="4"></a>
<a class="sourceLine" id="cb160-5" title="5"><span class="kw">const</span> <span class="op">{</span> environment <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./config&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb160-6" title="6"></a>
<a class="sourceLine" id="cb160-7" title="7"><span class="kw">const</span> indexRouter <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./routes/index&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb160-8" title="8"><span class="kw">const</span> tasksRouter <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./routes/tasks&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb160-9" title="9"></a>
<a class="sourceLine" id="cb160-10" title="10"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb160-11" title="11"></a>
<a class="sourceLine" id="cb160-12" title="12"><span class="va">app</span>.<span class="at">use</span>(<span class="at">morgan</span>(<span class="st">&quot;dev&quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb160-13" title="13"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">json</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb160-14" title="14"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cors</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb160-15" title="15"></a>
<a class="sourceLine" id="cb160-16" title="16"><span class="co">// REST OF CODE NOT SHOWN</span></a></code></pre></div>
<p>Then, configure the <code>cors</code> middleware function to only allow requests from trusted origins. In this case, the client requests are coming from <code>http://localhost:4000</code>:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb161-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cors</span>(<span class="op">{</span> <span class="dt">origin</span><span class="op">:</span> <span class="st">&quot;http://localhost:4000&quot;</span> <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Check out the <a href="https://www.npmjs.com/package/cors">cors npm package</a> documentation for other configuration options you can pass into the <code>cors</code> middleware function.</p>
<p>Finally, since CORS is configured for the entire app now for any requests that come from <code>http://localhost:4000</code>, remove the <code>cors()</code> middleware from the routes that you previously added them to in <code>routes/tasks.js</code>.</p>
<p>You can also remove <code>router.options("/", cors());</code> since the app-wide CORS configuration will also work for <code>OPTIONS</code> requests.</p>
<p>After you’ve removed all usage of <code>cors()</code> from <code>routes/tasks.js</code>, go ahead and remove the import of <code>cors</code> from the top of that file.</p>
<h2 id="what-youve-learned-1">What you’ve learned</h2>
<p>In this reading, you learned:</p>
<ol type="1">
<li>That by default, a web application running in the browser can only access API resources from the same origin (i.e. domain, protocol, port).</li>
<li>That an API can be configured to use Cross-Origin Resource Sharing (CORS) to grant web applications from a different origin access to some or all of its resources.</li>
<li>How to use the <a href="https://www.npmjs.com/package/cors">cors npm package</a> to enable cross-origin resource sharing.</li>
</ol>
<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=6 orderedList=false} -->
<!-- code_chunk_output -->
<ul>
<li><a href="#the-groundwork">The groundwork</a></li>
<li><a href="#choosing-a-project">Choosing a Project</a></li>
<li><a href="#the-feature-list">The feature list</a></li>
<li><a href="#feature-scoping">Feature scoping</a></li>
<li><a href="#feature-packets">Feature packets</a></li>
<li><a href="#code-code-code">Code, code, code!</a></li>
<li><a href="#evaluating-your-completion">Evaluating your completion</a></li>
<li><a href="#show-and-tell">Show and tell</a></li>
<li><a href="#required-features-for-approved-clones">Required Features for Approved Clones</a>
<ul>
<li><a href="#bandcamp">Bandcamp</a></li>
<li><a href="#goodreads">Goodreads</a></li>
<li><a href="#medium">Medium</a></li>
<li><a href="#product-hunt">Product Hunt</a></li>
<li><a href="#quora">Quora</a></li>
<li><a href="#remember-the-milk">Remember the Milk</a></li>
<li><a href="#stack-overflow">Stack Overflow</a></li>
<li><a href="#teawithstrangers">TeaWithStrangers</a></li>
<li><a href="#yelp">Yelp</a></li>
</ul></li>
<li><a href="#create-a-new-repository">Create a new repository</a></li>
<li><a href="#give-access-to-your-teammates">Give access to your teammates</a></li>
<li><a href="#what-is-cryptography">What is cryptography?</a>
<ul>
<li><a href="#what-is-encryption">What is encryption?</a></li>
<li><a href="#how-does-encryption-work">How does encryption work?</a></li>
<li><a href="#when-is-it-appropriate-to-use-encryption">When is it appropriate to use encryption?</a></li>
</ul></li>
<li><a href="#what-is-hashing">What is hashing?</a>
<ul>
<li><a href="#how-does-hashing-work">How does hashing work?</a></li>
<li><a href="#what-is-a-salt">What is a "salt"?</a></li>
<li><a href="#when-is-it-appropriate-to-use-hashing">When is it appropriate to use hashing?</a></li>
</ul></li>
<li><a href="#using-bcrypt-to-hash-user-passwords">Using Bcrypt to hash user passwords</a></li>
<li><a href="#overview-of-sessions">Overview of sessions</a>
<ul>
<li><a href="#what-are-sessions">What are sessions?</a></li>
<li><a href="#why-are-sessions-useful">Why are sessions useful?</a></li>
<li><a href="#what-are-the-drawbacks">What are the drawbacks?</a></li>
</ul></li>
<li><a href="#configuring-express-to-use-sessions">Configuring Express to use sessions</a>
<ul>
<li><a href="#installing-and-configuring-express-session">Installing and configuring <code>express-session</code></a></li>
<li><a href="#configuration-options">Configuration options</a></li>
<li><a href="#testing">Testing</a></li>
</ul></li>
<li><a href="#setting-and-accessing-session-values">Setting and accessing session values</a></li>
<li><a href="#session-store-configuration">Session store configuration</a></li>
<li><a href="#securing-the-session-http-cookie">Securing the session HTTP cookie</a>
<ul>
<li><a href="#additional-session-configuration-cookie-options">Additional session configuration cookie options</a></li>
</ul></li>
<li><a href="#what-you-have-learned">What you have learned</a></li>
<li><a href="#overview-of-authentication-and-authorization">Overview of authentication and authorization</a>
<ul>
<li><a href="#what-is-authentication">What is authentication?</a></li>
<li><a href="#authentication-process">Authentication process</a></li>
<li><a href="#what-is-authorization">What is authorization?</a></li>
</ul></li>
<li><a href="#supporting-user-self-registration">Supporting user self-registration</a>
<ul>
<li><a href="#getting-the-starter-project">Getting the starter project</a></li>
<li><a href="#creating-the-user-model">Creating the User model</a></li>
<li><a href="#adding-the-user-registration-form">Adding the user registration form</a></li>
<li><a href="#validating-the-user-registration-form">Validating the user registration form</a></li>
<li><a href="#hashing-user-passwords">Hashing user passwords</a></li>
<li><a href="#adding-the-user-routes-to-the-app-module">Adding the user routes to the <code>app</code> module</a></li>
<li><a href="#testing-user-registration">Testing user registration</a></li>
</ul></li>
<li><a href="#supporting-user-login">Supporting user login</a>
<ul>
<li><a href="#adding-the-user-login-form">Adding the user login form</a></li>
<li><a href="#implementing-the-user-login-process">Implementing the user login process</a></li>
<li><a href="#improving-the-user-navigation">Improving the user navigation</a></li>
<li><a href="#testing-user-login">Testing user login</a></li>
</ul></li>
<li><a href="#persisting-user-login-state">Persisting user login state</a>
<ul>
<li><a href="#configuring-express-to-use-sessions-1">Configuring Express to use sessions</a></li>
<li><a href="#using-sessions-to-persist-a-users-login-state">Using sessions to persist a user’s login state</a></li>
<li><a href="#testing-user-login-state-persistence">Testing user login state persistence</a></li>
</ul></li>
<li><a href="#restoring-the-authenticated-user-from-session">Restoring the authenticated user from session</a>
<ul>
<li><a href="#displaying-the-users-login-state">Displaying the user’s login state</a></li>
<li><a href="#implementing-user-logout">Implementing user logout</a></li>
<li><a href="#testing-the-latest-changes">Testing the latest changes</a></li>
</ul></li>
<li><a href="#protecting-a-route">Protecting a route</a>
<ul>
<li><a href="#defining-a-middleware-function-to-require-an-authenticated-user">Defining a middleware function to require an authenticated user</a></li>
</ul></li>
<li><a href="#associating-data-with-a-user">Associating data with a user</a>
<ul>
<li><a href="#defining-an-association">Defining an association</a></li>
<li><a href="#updating-the-seed-data">Updating the seed data</a></li>
<li><a href="#updating-the-book-related-routes">Updating the book related routes</a></li>
<li><a href="#testing-one-more-time">Testing one more time</a></li>
</ul></li>
<li><a href="#the-importance-of-using-https">The importance of using HTTPS</a></li>
<li><a href="#next-steps">Next steps</a></li>
<li><a href="#phase-0-download-the-starter-project">Phase 0: Download the starter project</a></li>
<li><a href="#phase-1-create-the-user-model">Phase 1: Create the User model</a></li>
<li><a href="#phase-2-configure-express-to-use-sessions">Phase 2: Configure Express to use sessions</a></li>
<li><a href="#phase-3-support-user-self-registration">Phase 3: Support user self-registration</a>
<ul>
<li><a href="#regex-reminders">Regex Reminders</a></li>
</ul></li>
<li><a href="#phase-4-support-user-login">Phase 4: Support user login</a>
<ul>
<li><a href="#testing-user-login-1">Testing user login</a></li>
</ul></li>
<li><a href="#phase-5-persist-user-login-state">Phase 5: Persist user login state</a>
<ul>
<li><a href="#using-sessions-to-persist-a-users-login-state-1">Using sessions to persist a user’s login state</a></li>
<li><a href="#testing-user-login-state-persistence-1">Testing user login state persistence</a></li>
</ul></li>
<li><a href="#phase-6-restore-the-authenticated-user-from-session">Phase 6: Restore the authenticated user from session</a></li>
<li><a href="#phase-7-display-the-users-login-state">Phase 7: Display the user’s login state</a></li>
<li><a href="#phase-8-implement-user-logout">Phase 8: Implement user logout</a>
<ul>
<li><a href="#testing-the-latest-changes-1">Testing the latest changes</a></li>
</ul></li>
<li><a href="#phase-9-support-user-attraction-visits">Phase 9: Support user attraction visits</a>
<ul>
<li><a href="#create-the-attractionvisit-model">Create the AttractionVisit model</a></li>
<li><a href="#update-the-attraction-detail-page">Update the Attraction Detail page</a></li>
<li><a href="#add-the-add-visit-page">Add the Add Visit page</a></li>
<li><a href="#require-a-logged-in-user">Require a logged in user</a></li>
</ul></li>
<li><a href="#bonus-phase-1-adding-the-edit-visit-and-delete-visit-pages">Bonus Phase 1: Adding the Edit Visit and Delete Visit pages</a></li>
<li><a href="#bonus-phase-2-locking-down-parks-and-attractions">Bonus Phase 2: Locking down parks and attractions</a></li>
<li><a href="#rules-of-rest">Rules of ReST</a></li>
<li><a href="#what-does-a-restful-api-look-like">What does a RESTful API look like?</a>
<ul>
<li><a href="#urls">URLs</a></li>
<li><a href="#ajax-urls-and-http-verbs">AJAX URLs and HTTP verbs</a></li>
<li><a href="#html-urls-and-http-verbs">HTML URLs and HTTP verbs</a></li>
</ul></li>
<li><a href="#designing-your-api">Designing your API</a></li>
<li><a href="#github-api-example">GitHub API example</a></li>
<li><a href="#restful-vs-remote-procedure-calls-rpc">RESTful vs remote procedure calls (RPC)</a>
<ul>
<li><a href="#a-remote-procedure-call">A remote procedure call</a></li>
<li><a href="#which-is-better-rest-or-rpc">Which is better? ReST or RPC?</a></li>
</ul></li>
<li><a href="#what-you-learned">What you learned</a></li>
<li><a href="#project-setup">Project setup</a>
<ul>
<li><a href="#initializing-sequelize">Initializing Sequelize</a></li>
<li><a href="#creating-the-database">Creating the database</a></li>
<li><a href="#connecting-sequelize-to-your-database">Connecting Sequelize to your database</a></li>
</ul></li>
<li><a href="#set-up-the-task-model">Set up the Task model</a></li>
<li><a href="#initial-router-setup">Initial router setup</a></li>
<li><a href="#global-error-handling">Global error handling</a></li>
<li><a href="#reading-all-tasks">Reading all tasks</a></li>
<li><a href="#create-a-task">Create a task</a>
<ul>
<li><a href="#validate-data">Validate data</a></li>
</ul></li>
<li><a href="#read-a-task">Read a task</a></li>
<li><a href="#update-a-task">Update a task</a></li>
<li><a href="#delete-a-task">Delete a task</a></li>
<li><a href="#what-youve-learned">What you’ve learned</a></li>
<li><a href="#why-cors">Why CORS</a>
<ul>
<li><a href="#demo-project-setup">Demo project setup</a></li>
<li><a href="#attempting-to-fetch-all-tasks">Attempting to fetch all tasks</a></li>
<li><a href="#cors">CORS</a></li>
</ul></li>
<li><a href="#setting-up-cors">Setting up CORS</a>
<ul>
<li><a href="#setting-up-cors-to-fetch-all-tasks">Setting up CORS to fetch all tasks</a></li>
<li><a href="#attempt-to-create-a-task">Attempt to create a task</a></li>
</ul></li>
<li><a href="#preflighted-requests">Preflighted requests</a></li>
<li><a href="#setting-up-cors-for-the-entire-api">Setting up CORS for the entire API</a></li>
<li><a href="#what-youve-learned-1">What you’ve learned</a></li>
<li><a href="#phase-0-initialize-project">Phase 0: Initialize project</a>
<ul>
<li><a href="#initializing-sequelize-1">Initializing Sequelize</a></li>
<li><a href="#configuring-your-environment-variables">Configuring your environment variables</a></li>
<li><a href="#creating-your-database">Creating your database</a></li>
</ul></li>
<li><a href="#phase-1-set-up-the-tweet-model">Phase 1: Set up the Tweet model</a></li>
<li><a href="#phase-2-set-up-test-routes">Phase 2: Set up test routes</a>
<ul>
<li><a href="#creating-test-routes">Creating test routes</a></li>
<li><a href="#testing-requests-on-postman">Testing requests on Postman</a></li>
</ul></li>
<li><a href="#phase-3-set-up-tweet-routes">Phase 3: Set up tweet routes</a>
<ul>
<li><a href="#get-tweets">GET /tweets</a></li>
<li><a href="#get-tweetsid">GET /tweets/:id</a></li>
<li><a href="#post-tweets">POST /tweets</a></li>
<li><a href="#put-tweetsid">PUT /tweets/:id</a></li>
<li><a href="#delete-tweetsid">DELETE /tweets/:id</a></li>
</ul></li>
<li><a href="#phase-4-render-tweets-in-the-frontend-application">Phase 4: Render tweets in the frontend application</a></li>
<li><a href="#phase-5-add-the-users-model">Phase 5: Add the users model</a></li>
<li><a href="#phase-1-users-router">Phase 1: Users router</a></li>
<li><a href="#phase-2-protecting-the-tweets-resources">Phase 2: Protecting the tweets resources</a></li>
<li><a href="#phase-3-sign-up-for-user-account-from-the-client">Phase 3: Sign up for user account from the client</a></li>
<li><a href="#phase-4-setting-up-the-log-in-flow">Phase 4: Setting up the log-in flow</a></li>
<li><a href="#phase-5-creating-tweets-from-the-frontend-application">Phase 5: Creating tweets from the frontend application</a></li>
<li><a href="#phase-6-seeing-tweets-with-authors-and-creating-tweets-from-the-client">Phase 6: Seeing tweets with authors and creating tweets from the client</a></li>
<li><a href="#phase-7-set-up-the-profile-page">Phase 7: Set up the profile page</a></li>
<li><a href="#bonus-phase-add-ability-to-delete-your-own-tweet">Bonus Phase: Add ability to delete your own tweet</a></li>
<li><a href="#bonus-phase-combine-create-and-index-views">Bonus Phase: Combine create and index views</a></li>
<li><a href="#bonus-phase-es-modules">Bonus Phase: ES Modules</a></li>
<li><a href="#high-level-overview-of-oauth-20">High level overview of OAuth 2.0</a></li>
<li><a href="#getting-your-app-ready-for-oauth-20">Getting your app ready for OAuth 2.0</a></li>
<li><a href="#oauth-20-in-detail">OAuth 2.0 in detail</a>
<ul>
<li><a href="#everything-over-https">Everything over HTTPS</a></li>
<li><a href="#application-requests-authorization-from-user">Application requests authorization from user</a></li>
<li><a href="#user-issues-authorization-grant">User issues authorization grant</a></li>
<li><a href="#application-uses-the-authorization-grant">Application uses the authorization grant</a></li>
<li><a href="#authorization-server-issues-an-access-token">Authorization server issues an access token</a></li>
<li><a href="#access-token-is-used">Access token is used</a></li>
<li><a href="#protected-resources-are-served">Protected resources are served</a></li>
</ul></li>
<li><a href="#what-you-learned-1">What you learned</a></li>
<li><a href="#json-web-token-jwt">JSON Web Token (JWT)</a>
<ul>
<li><a href="#conceptual-overview-of-a-jwt-an-example">Conceptual overview of a JWT: an example</a></li>
<li><a href="#anatomy-of-a-jwt">Anatomy of a JWT</a></li>
</ul></li>
<li><a href="#setting-up-token-based-authentication">Setting up token-based authentication</a>
<ul>
<li><a href="#create-the-users-table">Create the Users table</a></li>
<li><a href="#users-router">Users router</a></li>
<li><a href="#generate-an-access-token-for-the-client">Generate an access token for the client</a></li>
<li><a href="#using-the-access-token">Using the access token</a></li>
<li><a href="#where-to-store-the-access-token-on-the-client-side">Where to store the access token on the client-side</a></li>
</ul></li>
<li><a href="#what-youve-learned-2">What you’ve learned</a></li>
</ul>
<!-- /code_chunk_output -->
<hr />
<p>Now that you’ve built out an API, it’s time to build out a client to interact with this API. You have a couple of choices here: you can either serve this client application out of the same server or you can build out a separate client application that’s served from a different server.</p>
<p>Serving the client out of your API server reduces complexity and makes the development experience simpler. However, you might want to serve the client and the API out of different servers in order to reduce the overall load on one single server and to improve maintainability of your application as it grows over time.</p>
<p>In this lesson, you’ll build out a client that’s completely separate from the API server. Along the way, you’ll learn about the Cross-Origin Resource Sharing (CORS) issues that need to be considered when accessing API resources from a different origin. By the end of this lesson, you will:</p>
<ol type="1">
<li>Understand that by default a web application running in the browser can only access API resources from the same origin (i.e. domain, protocol, port).</li>
<li>Understand that an API can be configured to use Cross-Origin Resource Sharing (CORS) to grant web applications from a different origin access to some or all of its resources.</li>
<li>Use the <a href="https://www.npmjs.com/package/cors">cors npm package</a> to enable cross-origin resource sharing.</li>
</ol>
<hr />
<h1 id="twitter-lite-project">Twitter Lite Project</h1>
<p>Today you’ll begin building a lightweight Twitter API using Express, Sequelize, and Postbird! There will be two parts to this project: creating an API and creating a client-side application.</p>
<p>When you have completed the first part of the project, your application should have the following features:</p>
<ol type="1">
<li>A default "/" GET route.</li>
<li>A "/tweets" GET route to fetch an index of tweets.</li>
<li>A "/tweets" POST route to create tweets.</li>
<li>A "/tweets/:id" PUT route to update tweets.</li>
<li>A "/tweets/:id" DELETE route to delete tweets.</li>
<li>A backend API that connects to a simple frontend server.</li>
<li>A Users model.</li>
</ol>
<h2 id="phase-0-initialize-project">Phase 0: Initialize project</h2>
<p>Begin by cloning the project skeleton:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb162-1" title="1"><span class="fu">git</span> clone https://github.com/-starters/express-sequelize-starter.git</a></code></pre></div>
<p>Install your packages with <code>npm install</code>.</p>
<h3 id="initializing-sequelize-1">Initializing Sequelize</h3>
<p>Just like in the To-Do list demo project, the Sequelize CLI is already configured to know where your database configuration is located and where to generate the <code>models</code>, <code>seeders</code>, and <code>migrations</code> folders. The project skeleton has already taken care of configuration by including complete <code>.sequelizerc</code>, <code>./config/index.js</code>, and <code>./config/database.js</code> files.</p>
<h3 id="configuring-your-environment-variables">Configuring your environment variables</h3>
<p>Before you set up your database, remember that the Sequelize CLI still needs access to your database credentials. Create an <code>.env</code> file based off of the <code>.env.example</code> file included in your project skeleton.</p>
<h3 id="creating-your-database">Creating your database</h3>
<p>Before initializing the <code>Tweet</code> model, you’ll need to create a new database.</p>
<p>Take a moment to create a database user and database:</p>
<ul>
<li>The login name that you must use is "twitter_lite_app" (make sure to set a login password).</li>
<li>Your user must be granted the CREATEDB privilege so that you can run <code>npx dotenv sequelize-cli db:create</code>.</li>
<li>The database name that you must use is "twitter_lite".</li>
</ul>
<h2 id="phase-1-set-up-the-tweet-model">Phase 1: Set up the Tweet model</h2>
<p>It’s time to generate and migrate your Tweet model with the following commands:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb163-1" title="1"><span class="ex">npx</span> sequelize model:generate --name Tweet --attributes <span class="st">&quot;message:string&quot;</span></a></code></pre></div>
<p>In the model and migration files, make sure to configure the tweet <code>message</code> to not be nullable. Each tweet should have a <code>message</code> column of type <code>string</code> that has a maximum length of <code>280</code> and is not nullable. Then run your migrations:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb164-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate</a></code></pre></div>
<p>After migrating, you should see the <code>Tweets</code> table in your Postbird client:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postbird-3.png" alt="postbird-migration" /><figcaption>postbird-migration</figcaption>
</figure>
<p>Now generate a seed file by running the following command from the root of your project:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb165-1" title="1"><span class="ex">npx</span> sequelize seed:generate --name test-data</a></code></pre></div>
<p>Go ahead and replace the contents of the <code>./db/seeders/[timestamp]-test-data.js</code> with the following code:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb166-1" title="1"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb166-2" title="2"></a>
<a class="sourceLine" id="cb166-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb166-4" title="4">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb166-5" title="5">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(</a>
<a class="sourceLine" id="cb166-6" title="6">      <span class="st">&quot;Tweets&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb166-7" title="7">      [</a>
<a class="sourceLine" id="cb166-8" title="8">        <span class="op">{</span></a>
<a class="sourceLine" id="cb166-9" title="9">          <span class="dt">message</span><span class="op">:</span> <span class="st">&quot;The Martian was awesome!&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb166-10" title="10">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb166-11" title="11">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb166-12" title="12">        <span class="op">},</span></a>
<a class="sourceLine" id="cb166-13" title="13">        <span class="op">{</span></a>
<a class="sourceLine" id="cb166-14" title="14">          <span class="dt">message</span><span class="op">:</span> <span class="st">&quot;Has anyone seen Ready Player One?&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb166-15" title="15">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb166-16" title="16">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb166-17" title="17">        <span class="op">},</span></a>
<a class="sourceLine" id="cb166-18" title="18">        <span class="op">{</span></a>
<a class="sourceLine" id="cb166-19" title="19">          <span class="dt">message</span><span class="op">:</span></a>
<a class="sourceLine" id="cb166-20" title="20">            <span class="st">&quot;Harry Potter and the Sorcerer&#39;s Stone is the best out of all seven HP books :).&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb166-21" title="21">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb166-22" title="22">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb166-23" title="23">        <span class="op">},</span></a>
<a class="sourceLine" id="cb166-24" title="24">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb166-25" title="25">      <span class="op">{}</span></a>
<a class="sourceLine" id="cb166-26" title="26">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb166-27" title="27">  <span class="op">},</span></a>
<a class="sourceLine" id="cb166-28" title="28"></a>
<a class="sourceLine" id="cb166-29" title="29">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb166-30" title="30">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&quot;Tweets&quot;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb166-31" title="31">  <span class="op">},</span></a>
<a class="sourceLine" id="cb166-32" title="32"><span class="op">};</span></a></code></pre></div>
<p>Now run your seed files with the command below:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb167-1" title="1"><span class="ex">npx</span> dotenv sequelize db:seed:all</a></code></pre></div>
<p>After seeding, you should see the tweets you have created in your Postbird client:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postbird-3.png" alt="postbird-seed" /><figcaption>postbird-seed</figcaption>
</figure>
<h2 id="phase-2-set-up-test-routes">Phase 2: Set up test routes</h2>
<p>Notice that your skeleton already has a basic Express application set up in <code>app.js</code>. It’s time for you to set up the routers for your project.</p>
<p>Create a <code>routes</code> module by creating a <code>routes</code> directory in the root of your project. Within your <code>routes</code> folder, create an <code>index.js</code> file for your default router and a <code>tweets.js</code> file for your tweet routers. In both files, begin by requiring <code>express</code> and creating a <code>router</code> with <code>express.Router()</code>. Lastly, make sure you export the routers you just created.</p>
<p>A majority of RESTful APIs serve data in a JSON format. Let’s do the same for this project! To do this, update your <code>app.js</code> file to have your application <code>use(express.json())</code>. The <code>express.json()</code> middleware is needed to parse request body content formatted in JSON so that it is available via the <code>req.body</code> property.</p>
<p>Lastly, in order to connect to the routes modules you have just created, import your <code>./routes/index</code> file as the <code>indexRouter</code> and import your <code>./routes/tweets</code> file as the <code>tweetsRouter</code>. Make sure your application is using the <code>/</code> route with the <code>indexRouter</code> as well as the <code>/tweets</code> route with the <code>tweetsRouter</code>.</p>
<h3 id="creating-test-routes">Creating test routes</h3>
<p>Let’s get started in the <code>./routes/index.js</code> file. Move your GET route for <code>/</code> from <code>app.js</code> into your <code>./routes/index.js</code> file. Update the route to use <code>res.json()</code> in order to render a JSON response of <code>message: "test index root"</code>.</p>
<p>Now you’ll add a test route in your <code>./routes/tweets.js</code>. Create a route that handles a GET request to the <code>/</code> path. Have your result <code>send</code> a JSON response of <code>message: "test tweets index"</code>.</p>
<h3 id="testing-requests-on-postman">Testing requests on Postman</h3>
<p>Now run <code>npm start</code> to start your server and open up Postman to test your GET requests.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postman-1.gif" alt="using-postman" /><figcaption>using-postman</figcaption>
</figure>
<p>When sending a GET request to <code>localhost:8080/</code>, you should see JSON with your "test index root" message in the body response. When sending a GET request to <code>localhost:8080/tweets</code>, you should see JSON with your "test tweets index" message in the body response.</p>
<p>Note that if you use your browser to navigate to <code>localhost:8080/</code> and <code>localhost:8080/tweets</code>, you’ll see the same response as in Postman.</p>
<h2 id="phase-3-set-up-tweet-routes">Phase 3: Set up tweet routes</h2>
<p>Now you’ll add your Tweet routes in your <code>./routes/tweets.js</code>. Begin by requiring your <code>db</code> from your <code>../db/models</code> directory:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb168-1" title="1"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../db/models&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now destructure your <code>Tweet</code> model from the <code>db</code> you have just imported:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb169-1" title="1"><span class="kw">const</span> <span class="op">{</span> Tweet <span class="op">}</span> <span class="op">=</span> db<span class="op">;</span></a></code></pre></div>
<p>In this phase, you’ll interact with your <code>Tweet</code> model by using built-in methods to set up the basic CRUD functionalities for tweets: * <code>Tweet.findAll()</code> to fetch all of your database tweets. (Read) * <code>Tweet.findByPk()</code> to fetch a database tweet based on the <code>id</code> from your request parameters. (Read) * <code>Tweet.create()</code> to generate a tweet in your database. (Create) * <code>Tweet.update()</code> to update a tweet in your database. (Update) * <code>Tweet.destroy()</code> to delete a tweet from your database. (Delete)</p>
<h3 id="get-tweets">GET /tweets</h3>
<p>It’s time to set up a GET <code>/</code> route to fetch all of your seeded tweets when sending a GET request to <code>localhost:8080/tweets</code>. Since you’ll be awaiting a database fetch, let’s bring back your <code>asyncHandler</code> function to help you catch errors in a DRY way!</p>
<p>As a reminder, your <code>asyncHandler</code> takes in a <code>handler</code> function to return a middleware function that invokes the handler function with <code>req</code>, <code>res</code>, and <code>next</code>. It then chains on a <code>catch</code> statement by passing in the <code>next</code> function.</p>
<p>Let’s begin by updating the <code>tweets</code> GET route to <code>/</code>. Wrap the route function with your <code>asyncHandler</code> to be able to <code>await</code> the database fetch of all your tweets. Look at the beginning of the Phase 3 instructions to determine which Tweet model method to use.</p>
<p>Lastly, remember to render the tweets you have fetched from your database in JSON by using <code>res.json({ tweets })</code>.</p>
<h3 id="get-tweetsid">GET /tweets/:id</h3>
<p>Now you’ll set up the GET <code>/:id(\\d+)</code> route to read a specific tweet when sending a GET request to <code>localhost:8080/tweets/:id</code>. Parse the <code>tweetId</code> from your <code>req.params</code> object and use your <code>tweetId</code> to fetch a specific tweet from the database.</p>
<p>Note that the <code>app</code> module contains the following middleware function to catch unhandled requests and pass a <code>404</code> error to the global error handler:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb170-1" title="1"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb170-2" title="2">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;The requested resource couldn&#39;t be found.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb170-3" title="3">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb170-4" title="4">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb170-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This ensures that if a client makes a request to a route that doesn’t exist they’ll receive an appropriate error message.</p>
<p>Any error that occurs in your routes will be handled by the below global error handler so that error messages can be formatted and returned to the client in a consistent way. The error’s title, message, and stacktrace is rendered in JSON. If your application is in production, the error will be rendered without the error stacktrace.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb171-1" title="1"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb171-2" title="2">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb171-3" title="3">  <span class="kw">const</span> isProduction <span class="op">=</span> environment <span class="op">===</span> <span class="st">&quot;production&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb171-4" title="4">  <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb171-5" title="5">    <span class="dt">title</span><span class="op">:</span> <span class="va">err</span>.<span class="at">title</span> <span class="op">||</span> <span class="st">&quot;Server Error&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb171-6" title="6">    <span class="dt">message</span><span class="op">:</span> <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb171-7" title="7">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb171-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb171-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now let’s go back to your GET route for a single tweet. Now that you have written a database fetch for a tweet, you want to render errors for tweets that were not found. Make sure your asynchronous route function is taking in <code>next</code> as a parameter. If you have fetched a valid tweet, render the tweet in JSON. If you have not fetched a valid tweet, you can use a function to generate an error before invoking the <code>next</code> method.</p>
<p>Let’s define your error generator function for tweets not found. In your tweet route module, define a <code>tweetNotFoundError</code> function that takes in a tweet ID. Generate a new <code>Error</code> object with a message stating that a tweet of the given ID could not be found. Assign the error to have a <code>title</code> property to be "Tweet not found." and a <code>status</code> of <code>404</code>. At the end of the function, return the error.</p>
<p>Now that the <code>tweetNotFoundError</code> function is written to generate and return an <code>Error</code> object, you can pass the return value of the <code>tweetNotFoundError</code> function call into the <code>next</code> method to invoke the global error handler.</p>
<p>Take a moment to test your route and error handling in Postman.</p>
<h3 id="post-tweets">POST /tweets</h3>
<p>Set up a POST <code>/</code> route to create a new tweet by sending a POST request to <code>localhost:8080/tweets</code>. Now that you will take in JSON data to handle a request, remember that your application is using the <code>express.json()</code> middleware in <code>app.js</code> to parse the body content’s JSON and access the <code>req.body</code>.</p>
<p>Now that you are taking in data, you’ll need to validate that data. Import <code>check</code> and <code>validationResult</code> from <code>express-validator</code>. Use the <code>express-validator</code> library to check that the <code>message</code> value is present, and that it’s not over 280 characters long.</p>
<p>You’ll also need to handle your validation errors. In previous projects, you’ve been handling validations in each of the route handlers. Today, let’s DRY up our code and set up one middleware function that can check for errors in the <code>req</code> object, and if there are errors, then we can generate an <code>Error</code> from that middleware function and handle it there.</p>
<p>Define a <code>handleValidationErrors</code> function and have it take in <code>req</code>, <code>res</code>, and <code>next</code> as parameters. Begin by generating a <code>validationErrors</code> object by invoking the <code>validationResult</code> function with the request:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb172-1" title="1"><span class="kw">const</span> handleValidationErrors <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb172-2" title="2">  <span class="kw">const</span> validationErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb172-3" title="3">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Generate error object and invoke next middleware function</span></a>
<a class="sourceLine" id="cb172-4" title="4"><span class="op">};</span></a></code></pre></div>
<p>If you do you have validation errors, use <code>array()</code> to transform your <code>validationErrors</code> object into a mappable array. Pluck out each error’s <code>msg</code> attribute to generate an <code>errors</code> array of error messages:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb173-1" title="1"><span class="kw">const</span> errors <span class="op">=</span> <span class="va">validationErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a></code></pre></div>
<p>After generating the <code>errors</code> array, you’ll want to create a new <code>Error</code> object with a 400 <code>status</code> and title of "Bad request":</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb174-1" title="1"><span class="kw">const</span> err <span class="op">=</span> <span class="at">Error</span>(<span class="st">&quot;Bad request.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb174-2" title="2"><span class="va">err</span>.<span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></a>
<a class="sourceLine" id="cb174-3" title="3"><span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></a>
<a class="sourceLine" id="cb174-4" title="4"><span class="va">err</span>.<span class="at">title</span> <span class="op">=</span> <span class="st">&quot;Bad request.&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb174-5" title="5"><span class="at">next</span>(err)<span class="op">;</span></a></code></pre></div>
<p>You’ll also want the <code>Error</code> object to set an <code>errors</code> array as a <code>errors</code> property. Invoke the <code>next</code> middleware function with the <code>Error</code> object you have created. If you do not have any validation errors, invoke the <code>next</code> middleware function without an argument.</p>
<p>Your <code>handleValidationErrors</code> function should look something like this:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb175-1" title="1"><span class="kw">const</span> handleValidationErrors <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb175-2" title="2">  <span class="kw">const</span> validationErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-3" title="3"></a>
<a class="sourceLine" id="cb175-4" title="4">  <span class="cf">if</span> (<span class="op">!</span><span class="va">validationErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb175-5" title="5">    <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validationErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-6" title="6"></a>
<a class="sourceLine" id="cb175-7" title="7">    <span class="kw">const</span> err <span class="op">=</span> <span class="at">Error</span>(<span class="st">&quot;Bad request.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-8" title="8">    <span class="va">err</span>.<span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></a>
<a class="sourceLine" id="cb175-9" title="9">    <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></a>
<a class="sourceLine" id="cb175-10" title="10">    <span class="va">err</span>.<span class="at">title</span> <span class="op">=</span> <span class="st">&quot;Bad request.&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb175-11" title="11">    <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb175-13" title="13">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb175-14" title="14"><span class="op">};</span></a></code></pre></div>
<p>Now that you are adding the <code>.errors</code> property to this error you will need to modify the generic error handler in <code>app.js</code> to add this <code>.errors</code> array to the JSON you return, otherwise when you call our API and get validation errors you won’t be able to see them!</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb176-1" title="1"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb176-2" title="2">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb176-3" title="3">  <span class="kw">const</span> isProduction <span class="op">=</span> environment <span class="op">===</span> <span class="st">&quot;production&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb176-4" title="4">  <span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb176-5" title="5">    <span class="dt">title</span><span class="op">:</span> <span class="va">err</span>.<span class="at">title</span> <span class="op">||</span> <span class="st">&quot;Server Error&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb176-6" title="6">    <span class="dt">message</span><span class="op">:</span> <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb176-7" title="7">    <span class="dt">errors</span><span class="op">:</span> <span class="va">err</span>.<span class="at">errors</span><span class="op">,</span> <span class="co">// Includes our array of validation errors in our JSON response</span></a>
<a class="sourceLine" id="cb176-8" title="8">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb176-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb176-10" title="10"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now make sure the POST route is using your tweet validations and <code>handleValidationErrors</code> function as middleware. Test your new route in Postman. Don’t forget to set the "Content-Type" header to "application/json" and send raw JSON data through the request body. Feel free to review how to send a POST request through the image below.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-2a.gif" alt="postman-post" /><figcaption>postman-post</figcaption>
</figure>
<p>Take a moment to also test your error handling. You should see an error response in JSON upon submitting bad data (i.e. an empty <code>message</code> field). Notice that your error response has the following properties: a <code>status</code> of "400", a <code>title</code> of "Bad request.", and an array of <code>errors</code>. Make sure that you see a <code>400 Bad Request</code> error if there are failing data validations.</p>
<h3 id="put-tweetsid">PUT /tweets/:id</h3>
<p>Set up a PUT <code>/:id(\\d+)</code> route to update a tweet. Begin by parsing the tweet id within your <code>req.params</code> object and using the parsed <code>tweetId</code> to fetch the tweet to update. If you have a valid tweet, await the update and then render the updated tweet in JSON format.</p>
<p>If you have not fetched a valid tweet, use the same <code>404</code> error handling that the <code>GET /tweets/:id</code> route used. Invoke your <code>tweetNotFoundError</code> function to generate a <code>404</code> error. Then pass the return value of the <code>tweetNotFoundError</code> function call into the <code>next</code> method.</p>
<p>Make sure to also use the same <code>400</code> error handling that the <code>POST /tweets</code> route used. Validate your data and handle your validation errors, like in the POST route, to generate an error response upon receiving bad form data.</p>
<p>Test your PUT route:</p>
<ol type="1">
<li>Use Postman to send a GET request to <code>localhost:8080/tweets/1</code> to view the data of your first database tweet.</li>
<li>Configure your "Content-Type" header as "application/json".</li>
<li>Send a PUT request to <code>localhost:8080/tweets/1</code> with updated fields in the <code>raw</code> request body.</li>
<li>View your updated tweet in Postbird.</li>
<li>Send a PUT request to <code>localhost:8080/tweets/1</code> with invalid data to check the error handling.</li>
</ol>
<h3 id="delete-tweetsid">DELETE /tweets/:id</h3>
<p>Set up the DELETE <code>/:id(\\d+)</code> route for deleting a tweet by sending a DELETE request to <code>localhost:8080/tweets/:id</code>. Begin by parsing the tweet ID and using the id to find your tweet to delete. If a valid tweet is found, await to destroy the tweet and render a <code>204</code> response to confirm the deletion by using <code>res.status(204).end()</code>.</p>
<p>If a valid tweet wasn’t found, use the same <code>404</code> error handling that the GET and PUT routes used. Pass the tweet ID into your <code>tweetNotFoundError</code> function call to generate a <code>404</code> error. Then pass your newly generated <code>404</code> error into the <code>next</code> method to invoke the global error handler.</p>
<p>Lastly, send a request with Postman to test your DELETE route and delete a tweet. Verify that the tweet was properly deleted by viewing your seeded objects with Postbird.</p>
<h2 id="phase-4-render-tweets-in-the-frontend-application">Phase 4: Render tweets in the frontend application</h2>
<p>Up to this point, you’ve set up a CRUD API for tweets. All users of your API have access to the following features: * Viewing all existing tweets * Viewing a tweet specific tweet * Creating a tweet * Updating a tweet * Deleting a tweet</p>
<p>Now that you have a fully functioning API, you can create another Express application to serve the pages to render the client-side code for the Twitter Lite user interface. To review, the term "client-side" means that user triggered events (i.e. form submissions), the API request/response cycle, and rendering data is handled by JavaScript code running in the browser.</p>
<p>This new Express application will use the Pug template engine to render HTML pages on the server-side or backend. Regardless, we’ll refer to this Express application as the "frontend" of the Twitter Lite project since the backend rendered pages are primarily used to deliver the client-side JavaScript to the browser.</p>
<p>Here are all the things that you still need to do to make your project a lite version of Twitter: * Add an Express "frontend" application to deliver the client-side code to interact with the API; * Set up users and auth in the API; and * Set up users and auth in the frontend application.</p>
<p>To add the frontend application, clone the repo below into a new folder that’s a sibling to the API project folder.</p>
<pre><code>git clone https://github.com/-starters/express-apis-frontend.git</code></pre>
<p>Move into your frontend <code>express-apis-frontend</code> directory and run <code>npm install</code>. Now you’ll want to start up the frontend server and the backend server in different terminal tabs or windows. Start your backend server from the first terminal window by running the <code>npm start</code> command from the root of the API project. Then open a second terminal to start your frontend server by running <code>npm start</code> from within the <code>express-apis-frontend</code> folder.</p>
<p>Take a moment to navigate to your backend at <code>http://localhost:8080/</code>. You should see a JSON response of a "test index root" message. Now navigate to your frontend at <code>http://localhost:4000/</code>. Open up your developer tools and you should see an <code>h1</code> element with the content of "Hello World!".</p>
<p>Open your <code>public/js/index.js</code> file and add an event listener script. This file is where you will fetch all tweets from <code>http://localhost:8080/tweets</code>. Start off by awaiting the fetch response (<code>res</code>) of all your API tweets. Parse your response into JSON and destructure the <code>tweets</code> property from your parsed response object. You’ll eventually use these <code>tweets</code> to render a list of each tweet message, but just console log all the tweets for now. Make sure to catch and <code>console.error</code> any errors. Your script function should look something like this:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb178-1" title="1"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb178-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb178-3" title="3">    <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/tweets&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb178-4" title="4">    <span class="kw">const</span> <span class="op">{</span> tweets <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb178-5" title="5">    <span class="va">console</span>.<span class="at">log</span>(tweets)<span class="op">;</span></a>
<a class="sourceLine" id="cb178-6" title="6">  <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb178-7" title="7">    <span class="va">console</span>.<span class="at">error</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb178-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb178-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>As a reminder, your <code>index.js</code> script will run as soon as the DOM content in your browser loads for your frontend. Your API fetch call will fire after the DOM content has loaded and the <code>tweets</code> from your response will be logged in your developer tools console.</p>
<p>If you navigate to <code>localhost:4000/</code> to view your frontend application, you should see a <code>Failed to fetch</code> error message. Let’s investigate! Instead of console logging your <code>tweets</code>, try console logging the response (<code>res</code>) to figure out more context around your error. If you look closer, your response has <code>type</code> of "cors" and that you have a success status code of <code>200 OK</code>. This indicates that your application has a CORS error!</p>
<p>Resolve this CORS issue back on the API side by installing the <code>cors</code> npm package. In <code>app.js</code>, require and configure the <code>cors</code> middleware function to allow requests from the origin <code>localhost:4000</code>:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb179-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cors</span>(<span class="op">{</span> <span class="dt">origin</span><span class="op">:</span> <span class="st">&quot;http://localhost:4000&quot;</span> <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Go back to the frontend application and try to console log the tweets again. This time, all the existing tweets should console log! Now let’s actually display the tweets in HTML elements by updating the "DOMContentLoaded" event listener in <code>public/js/index.js</code>.</p>
<p>After your fetch call in the <code>try</code> block, redirect your user to the <code>/log-in</code> page and <code>return</code> out of the event listener function if your <code>res</code> has a status of <code>401</code>. If the response does not have a status of <code>401</code>, parse your response as JSON and destructure the <code>tweets</code> property from your JSON response.</p>
<p>Take a moment to create a <code>div</code> element in your <code>index.pug</code> template before the load of your <code>index.js</code> script. Set the <code>div</code> with an ID of "tweets-container". In your event listener, use the Vanilla JavaScript <code>querySelector()</code> method to find the <code>tweetsContainer</code>. Declare a <code>tweetsHtml</code> variable for an array of stringified HTML blocks that will render tweet messages. Map over your array of <code>tweets</code> to generate the array of stringified HTML blocks.</p>
<p>You can use Bootstrap classes to style the tweets. For each message, render a <code>div.card</code> parent element with a <code>div.card-body</code> child element. Within the <code>div.card-body</code> element should live a <code>p.card-text</code> element that renders each tweet’s <code>message</code> with interpolation. You’ll want to join your <code>tweetsHtml</code> array by an empty string (<code>""</code>) to create a full stringified HTML block for all your tweet message blocks. Set the the <code>innerHTML</code> property of the <code>tweetsContainer</code> to be the joined <code>tweetsHtml</code>.</p>
<p>Lastly, make sure that you are using <code>console.error</code> to log any caught errors. Your script should look something like this:</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb180-1" title="1"><span class="va">document</span>.<span class="at">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb180-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb180-3" title="3">    <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/tweets&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb180-4" title="4">    <span class="kw">const</span> <span class="op">{</span> tweets <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb180-5" title="5">    </a>
<a class="sourceLine" id="cb180-6" title="6">    <span class="kw">const</span> tweetsContainer <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;#tweets-container&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb180-7" title="7">    <span class="kw">const</span> tweetsHtml <span class="op">=</span> <span class="va">tweets</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb180-8" title="8">      (<span class="op">{</span> message <span class="op">}</span>) <span class="kw">=&gt;</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb180-9" title="9"><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></a>
<a class="sourceLine" id="cb180-10" title="10"><span class="vs">        &lt;div class=&quot;card-body&quot;&gt;</span></a>
<a class="sourceLine" id="cb180-11" title="11"><span class="vs">          &lt;p class=&quot;card-text&quot;&gt;</span><span class="sc">${</span>message<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb180-12" title="12"><span class="vs">        &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb180-13" title="13"><span class="vs">      &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb180-14" title="14"><span class="vs">    `</span></a>
<a class="sourceLine" id="cb180-15" title="15">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb180-16" title="16">    <span class="va">tweetsContainer</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">tweetsHtml</span>.<span class="at">join</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb180-17" title="17">  <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb180-18" title="18">    <span class="va">console</span>.<span class="at">error</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb180-19" title="19">  <span class="op">}</span></a>
<a class="sourceLine" id="cb180-20" title="20"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Take a moment to confirm that your frontend is fetching and rendering the tweets on <code>localhost:4000/</code>.</p>
<h2 id="phase-5-add-the-users-model">Phase 5: Add the users model</h2>
<p>Now it’s time to set up the users model to begin implementing user authentication! Use the following Sequelize command to generate a User model with <code>username</code>, <code>email</code>, and <code>hashedPassword</code> attributes.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb181-1" title="1"><span class="ex">npx</span> sequelize model:generate --name User --attributes <span class="st">&#39;username:string,email:string,hashedPassword:string&#39;</span></a></code></pre></div>
<p>Make sure to update the user model and migration files with the following constraints: * <code>username</code> is unique and not nullable * <code>email</code> is unique and not nullable * <code>hashedPassword</code> is the type <code>STRING.BINARY</code> and not nullable.</p>
<p>Now run the migration with <code>npx dotenv sequelize db:migrate</code> and check in Postbird to confirm the creation of your User table.</p>
<hr />
<h1 id="twitter-lite-project-with-authentication">Twitter Lite Project… with Authentication!</h1>
<p>At this point, you’ve set up an API for tweets and connected a frontend application to interact with your API. You’ve also added a Users model to your project to prepare for implementing user authentication.</p>
<p>In this project, you’ll be writing Vanilla JS to render frontend elements. You have been using string template literals to render data from the database as HTML. Later on in the class, you’ll use React to render components and build frontend clients. In the next portion of the project, you will set up the Users router and protect your tweet resources from unauthenticated users.</p>
<p>When you have completed the second part of the project, your application should have the following features:</p>
<ol type="1">
<li>Users routes</li>
<li>Protected tweet resources</li>
<li>User registration</li>
<li>User log-in</li>
<li>Authenticated tweet creation</li>
<li>A form to create tweets</li>
</ol>
<h2 id="phase-1-users-router">Phase 1: Users router</h2>
<p>Begin by creating a users routes module at <code>routes/users.js</code>. Require <code>express</code> to initialize a router with <code>express.Router()</code> and make sure to export the router you just initialized.</p>
<p>In your <code>app.js</code> file, require the <code>usersRouter</code> you have just created and have your application connect the <code>/users</code> path to the <code>usersRouter</code>.</p>
<p>The users router will need to use a couple of helper functions that currently exist in the tweets router: <code>asyncHandler</code> and <code>handleValidationErrors</code>. Go ahead and create a <code>utils.js</code> file within the root of your project and then move those two functions into that file.</p>
<p>Now add a route in the user router to handle POST requests to <code>localhost:8080/users</code>. In this route, use <code>express-validator</code> to validate the params. Make sure to import <code>check</code> from <code>express-validator</code> as well as the <code>asyncHandler</code> and <code>handleValidationErrors</code> helper functions from the <code>../utils.js</code> file:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb182-1" title="1"><span class="kw">const</span> <span class="op">{</span> check <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express-validator&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb182-2" title="2"><span class="kw">const</span> <span class="op">{</span> asyncHandler<span class="op">,</span> handleValidationErrors <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../utils&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>In your POST route, begin by wrapping the route handler with the <code>asyncHandler</code> function because there will be some asynchronous logic inside the route.</p>
<p>Add the following validations to validate your user authentication data so that you can render error messages upon submission of bad registration data. Go ahead and also use the <code>handleValidationErrors</code> helper middleware function.</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb183-1" title="1"><span class="kw">const</span> validateUsername <span class="op">=</span></a>
<a class="sourceLine" id="cb183-2" title="2">  <span class="at">check</span>(<span class="st">&quot;username&quot;</span>)</a>
<a class="sourceLine" id="cb183-3" title="3">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb183-4" title="4">    .<span class="at">withMessage</span>(<span class="st">&quot;Please provide a username&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb183-5" title="5"></a>
<a class="sourceLine" id="cb183-6" title="6"><span class="kw">const</span> validateEmailAndPassword <span class="op">=</span> [</a>
<a class="sourceLine" id="cb183-7" title="7">  <span class="at">check</span>(<span class="st">&quot;email&quot;</span>)</a>
<a class="sourceLine" id="cb183-8" title="8">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb183-9" title="9">    .<span class="at">isEmail</span>()</a>
<a class="sourceLine" id="cb183-10" title="10">    .<span class="at">withMessage</span>(<span class="st">&quot;Please provide a valid email.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb183-11" title="11">  <span class="at">check</span>(<span class="st">&quot;password&quot;</span>)</a>
<a class="sourceLine" id="cb183-12" title="12">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb183-13" title="13">    .<span class="at">withMessage</span>(<span class="st">&quot;Please provide a password.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb183-14" title="14">]<span class="op">;</span></a>
<a class="sourceLine" id="cb183-15" title="15"></a>
<a class="sourceLine" id="cb183-16" title="16"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb183-17" title="17">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb183-18" title="18">  validateUsername<span class="op">,</span></a>
<a class="sourceLine" id="cb183-19" title="19">  validateEmailAndPassword<span class="op">,</span></a>
<a class="sourceLine" id="cb183-20" title="20">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb183-21" title="21">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb183-22" title="22">    <span class="co">// </span><span class="al">TODO</span><span class="co">: User creation logic</span></a>
<a class="sourceLine" id="cb183-23" title="23">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb183-24" title="24">)<span class="op">;</span></a></code></pre></div>
<p>Within the asynchronous route handler function, destructure the <code>username</code>, <code>email</code>, and <code>password</code> from the <code>body</code> of your request. You’ll use these properties to create a new user in your database. For now, leave a <code>TODO</code> note to create the user.</p>
<p>Now to actually create the user, install and require the <code>bcryptjs</code> library to use the <code>bcrypt.hash()</code> method. Invoke the <code>bcrypt.hash()</code> method with the user’s <code>password</code> and a salt round of <code>10</code>. Await the generation of a <code>hashedPassword</code> before creating the user.</p>
<p>At this point, make sure you have required the <code>db</code> from <code>../db/models</code>. Destructure your <code>User</code> model from your <code>db</code> module and await the creation of your user (<code>User.create()</code>). In order to protect the user’s credentials, create the user with the <code>hashedPassword</code> instead of the <code>password</code> from the form request body.</p>
<p>At this point, your user creation route should look something like this:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb184-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb184-2" title="2">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb184-3" title="3">  validateUsername<span class="op">,</span></a>
<a class="sourceLine" id="cb184-4" title="4">  validateEmailAndPassword<span class="op">,</span></a>
<a class="sourceLine" id="cb184-5" title="5">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb184-6" title="6">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb184-7" title="7">    <span class="kw">const</span> <span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb184-8" title="8">    <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb184-9" title="9">    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> hashedPassword <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb184-10" title="10">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Generate JSON Web Token (access token)</span></a>
<a class="sourceLine" id="cb184-11" title="11">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Render user in JSON</span></a>
<a class="sourceLine" id="cb184-12" title="12">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb184-13" title="13">)<span class="op">;</span></a></code></pre></div>
<p>Once the user has been created, you want to return an access token. You’ll be using a JWT as the access token. To generate and decode the JWT, use the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> npm package. Begin by running <code>npm install jsonwebtoken</code>.</p>
<p>There are a few configuration steps to set up JWT generation. You need to set a <em>secret key</em> and a number representing how many seconds before the token expires. Add a <code>JWT_SECRET</code> and <code>JWT_EXPIRES_IN</code> variable to your <code>.env</code> file.</p>
<p>To generate a secret, open up your node repl in your terminal by running <code>node</code> and then use the built-in crypto module to generate your <code>JWT_SECRET</code> key:</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb185-1" title="1"><span class="at">require</span>(<span class="st">&quot;crypto&quot;</span>).<span class="at">randomBytes</span>(<span class="dv">32</span>).<span class="at">toString</span>(<span class="st">&quot;hex&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>For the <code>JWT_EXPIRES_IN</code> set it to <code>604800</code>, which is the number of seconds for one week. Then update your <code>config/index.js</code> file to use these environment variables:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb186-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb186-2" title="2">  <span class="dt">environment</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">||</span> <span class="st">&quot;development&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-3" title="3">  <span class="dt">port</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-4" title="4">  <span class="dt">db</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb186-5" title="5">    <span class="dt">username</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_USERNAME</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-6" title="6">    <span class="dt">password</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_PASSWORD</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-7" title="7">    <span class="dt">database</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_DATABASE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-8" title="8">    <span class="dt">host</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_HOST</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb186-10" title="10">  <span class="dt">jwtConfig</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb186-11" title="11">    <span class="dt">secret</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">JWT_SECRET</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-12" title="12">    <span class="dt">expiresIn</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">JWT_EXPIRES_IN</span><span class="op">,</span></a>
<a class="sourceLine" id="cb186-13" title="13">  <span class="op">},</span></a>
<a class="sourceLine" id="cb186-14" title="14"><span class="op">};</span></a></code></pre></div>
<p>Finally, let’s put this JWT generation logic inside of an <code>auth.js</code> file. Create an <code>auth.js</code> file in the root of your project and require the <code>jsonwebtoken</code> package as well as your <code>jwtConfig</code> variables from your <code>./config</code> module.</p>
<p>Now define a function called <code>getUserToken</code>. This function will take a user object as a parameter and then create a payload from the user. Then, it uses the <code>jsonwebtoken.sign()</code> function to generate a token.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb187-1" title="1"><span class="kw">const</span> jwt <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;jsonwebtoken&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb187-2" title="2"><span class="kw">const</span> <span class="op">{</span> jwtConfig <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./config&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb187-3" title="3"></a>
<a class="sourceLine" id="cb187-4" title="4"><span class="kw">const</span> <span class="op">{</span> secret<span class="op">,</span> expiresIn <span class="op">}</span> <span class="op">=</span> jwtConfig<span class="op">;</span></a>
<a class="sourceLine" id="cb187-5" title="5"></a>
<a class="sourceLine" id="cb187-6" title="6"><span class="kw">const</span> getUserToken <span class="op">=</span> (user) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb187-7" title="7">  <span class="co">// Don&#39;t store the user&#39;s hashed password</span></a>
<a class="sourceLine" id="cb187-8" title="8">  <span class="co">// in the token data.</span></a>
<a class="sourceLine" id="cb187-9" title="9">  <span class="kw">const</span> userDataForToken <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb187-10" title="10">    <span class="dt">id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb187-11" title="11">    <span class="dt">email</span><span class="op">:</span> <span class="va">user</span>.<span class="at">email</span><span class="op">,</span></a>
<a class="sourceLine" id="cb187-12" title="12">  <span class="op">};</span></a>
<a class="sourceLine" id="cb187-13" title="13"></a>
<a class="sourceLine" id="cb187-14" title="14">  <span class="co">// Create the token.</span></a>
<a class="sourceLine" id="cb187-15" title="15">  <span class="kw">const</span> token <span class="op">=</span> <span class="va">jwt</span>.<span class="at">sign</span>(</a>
<a class="sourceLine" id="cb187-16" title="16">    <span class="op">{</span> <span class="dt">data</span><span class="op">:</span> userDataForToken <span class="op">},</span></a>
<a class="sourceLine" id="cb187-17" title="17">    secret<span class="op">,</span></a>
<a class="sourceLine" id="cb187-18" title="18">    <span class="op">{</span> <span class="dt">expiresIn</span><span class="op">:</span> <span class="at">parseInt</span>(expiresIn<span class="op">,</span> <span class="dv">10</span>) <span class="op">}</span> <span class="co">// 604,800 seconds = 1 week</span></a>
<a class="sourceLine" id="cb187-19" title="19">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb187-20" title="20"></a>
<a class="sourceLine" id="cb187-21" title="21">  <span class="cf">return</span> token<span class="op">;</span></a>
<a class="sourceLine" id="cb187-22" title="22"><span class="op">};</span></a>
<a class="sourceLine" id="cb187-23" title="23"></a>
<a class="sourceLine" id="cb187-24" title="24"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span> getUserToken <span class="op">};</span></a></code></pre></div>
<p>Notice how in the code above, we had to convert <code>expiresIn</code> from a string to an integer because environment variables declared in the <code>.env</code> file are strings, and according to the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> docs, anything that gets set to the <code>expiresIn</code> as an <strong>integer</strong> will be calculated as <strong>seconds</strong>, and <strong>strings</strong> will be calculated in <strong>milliseconds</strong>.</p>
<p>Now, go back to the users routes module and import the <code>getUserToken</code> function from the <code>../auth</code> module. Then update the user creation route to call the <code>getUserToken</code> function and return a token to the user when they sign up for an account. Your user creation route should look something like this:</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb188-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb188-2" title="2">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb188-3" title="3">  validateUsername<span class="op">,</span></a>
<a class="sourceLine" id="cb188-4" title="4">  validateEmailAndPassword<span class="op">,</span></a>
<a class="sourceLine" id="cb188-5" title="5">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb188-6" title="6">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb188-7" title="7">    <span class="kw">const</span> <span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb188-8" title="8">    <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb188-9" title="9">    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> hashedPassword <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb188-10" title="10"></a>
<a class="sourceLine" id="cb188-11" title="11">    <span class="kw">const</span> token <span class="op">=</span> <span class="at">getUserToken</span>(user)<span class="op">;</span></a>
<a class="sourceLine" id="cb188-12" title="12">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">201</span>).<span class="at">json</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb188-13" title="13">      <span class="dt">user</span><span class="op">:</span> <span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb188-14" title="14">      token<span class="op">,</span></a>
<a class="sourceLine" id="cb188-15" title="15">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb188-16" title="16">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb188-17" title="17">)<span class="op">;</span></a></code></pre></div>
<p>Once you’ve confirmed that this is working correctly on Postman, let’s put this JWT token to use by protecting the tweets resources and only allowing signed in users to access the tweets routes!</p>
<h2 id="phase-2-protecting-the-tweets-resources">Phase 2: Protecting the tweets resources</h2>
<p>It’s time to protect the tweet resources in your API! On each request to tweet routes, do the following:</p>
<ol type="1">
<li>Parse out the JWT token from the request header.</li>
<li>Decode the JWT.</li>
<li>Find the user based on the JWT payload.</li>
</ol>
<p>If all of the steps above succeed, then the user is considered to be signed in and can access the tweet resources.</p>
<p>To carry out the plan above, go to back to your <code>auth.js</code> file. Here, you’ll want to use two middleware functions. The first will parse out the JWT token from the request header. The second function decodes the JWT to find the user and stores the user in the <code>req</code> object.</p>
<p>For the first middleware function, let’s use the <code>express-bearer-token</code> middleware to do this parsing. Run <code>npm install express-bearer-token</code> to add the middleware to your application. Begin by requiring the middleware as <code>bearerToken</code> as well as requiring your <code>User</code> model from the database models.</p>
<p>Define a middleware function named <code>restoreUser</code> that takes in the parameters: <code>req</code>, <code>res</code>, and <code>next</code>. Begin by destructuring the JWT <code>token</code> from the <code>req</code> object. If the token is invalid, return an invocation of the <code>next</code> function.</p>
<p>If the token is valid, invoke the <code>jwt.verify()</code> method with four arguments:</p>
<ul>
<li>JWT <code>token</code> from the request body;</li>
<li>JWT <code>secret</code> from your configuration file;</li>
<li><code>null</code> options; and</li>
<li>An asynchronous function that takes in an error and a <code>jwtPayload</code> (more steps below).</li>
</ul>
<p>Currently, your <code>restoreUser</code> function should look something like this. Notice if we don’t get a token in the request at all we set the "WWW-Authenticate" header to "Bearer" and return a "401 Unauthorized" status code.</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb189-1" title="1"><span class="kw">const</span> restoreUser <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb189-2" title="2">  <span class="kw">const</span> <span class="op">{</span> token <span class="op">}</span> <span class="op">=</span> req<span class="op">;</span></a>
<a class="sourceLine" id="cb189-3" title="3"></a>
<a class="sourceLine" id="cb189-4" title="4">  <span class="cf">if</span> (<span class="op">!</span>token) <span class="op">{</span></a>
<a class="sourceLine" id="cb189-5" title="5">    <span class="cf">return</span> <span class="va">res</span>.<span class="at">set</span>(<span class="st">&quot;WWW-Authenticate&quot;</span><span class="op">,</span> <span class="st">&quot;Bearer&quot;</span>).<span class="at">status</span>(<span class="dv">401</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb189-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb189-7" title="7"></a>
<a class="sourceLine" id="cb189-8" title="8">  <span class="cf">return</span> <span class="va">jwt</span>.<span class="at">verify</span>(token<span class="op">,</span> secret<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">async</span> (err<span class="op">,</span> jwtPayload) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb189-9" title="9">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Define asynchronous function for jwtPayload logic</span></a>
<a class="sourceLine" id="cb189-10" title="10">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb189-11" title="11"><span class="op">};</span></a></code></pre></div>
<p>In the asynchronous function, check whether there is an error object. If so, set the error’s status to be <code>401</code> and return an invocation of the <code>next</code> function passing in the error object:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb190-1" title="1"><span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb190-2" title="2">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">401</span><span class="op">;</span></a>
<a class="sourceLine" id="cb190-3" title="3">  <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb190-4" title="4"><span class="op">}</span></a></code></pre></div>
<p>If there is no error, extract the user’s <code>id</code> from the <code>data</code> property of your <code>jwtPayload</code>:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb191-1" title="1"><span class="kw">const</span> <span class="op">{</span> id <span class="op">}</span> <span class="op">=</span> <span class="va">jwtPayload</span>.<span class="at">data</span><span class="op">;</span></a></code></pre></div>
<p>Then use a <code>try</code>/<code>catch</code> block to await the fetch of a user (by using <code>User.findByPk()</code>) or catch an error to return an invocation of the <code>next</code> function:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb192-1" title="1"><span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb192-2" title="2">  <span class="va">req</span>.<span class="at">user</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">findByPk</span>(id)<span class="op">;</span></a>
<a class="sourceLine" id="cb192-3" title="3"><span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb192-4" title="4">  <span class="cf">return</span> <span class="at">next</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb192-5" title="5"><span class="op">}</span></a></code></pre></div>
<p>Now check to see whether the <code>req</code> object has an associated <code>user</code> property. If there isn’t a valid user, return a response that sets the "WWW-Authenticate" header with a value of "Bearer" and sends a "401 Unauthorized" status code before invoking the <code>next</code> function:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb193-1" title="1"><span class="cf">if</span> (<span class="op">!</span><span class="va">req</span>.<span class="at">user</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb193-2" title="2">  <span class="cf">return</span> <span class="va">res</span>.<span class="at">set</span>(<span class="st">&quot;WWW-Authenticate&quot;</span><span class="op">,</span> <span class="st">&quot;Bearer&quot;</span>).<span class="at">status</span>(<span class="dv">401</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb193-3" title="3"><span class="op">}</span></a></code></pre></div>
<p>Your complete <code>restoreUser</code> function should look something like this:</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb194-1" title="1"><span class="kw">const</span> restoreUser <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb194-2" title="2">  <span class="kw">const</span> <span class="op">{</span> token <span class="op">}</span> <span class="op">=</span> req<span class="op">;</span></a>
<a class="sourceLine" id="cb194-3" title="3"></a>
<a class="sourceLine" id="cb194-4" title="4">  <span class="cf">if</span> (<span class="op">!</span>token) <span class="op">{</span></a>
<a class="sourceLine" id="cb194-5" title="5">    <span class="cf">return</span> <span class="va">res</span>.<span class="at">set</span>(<span class="st">&quot;WWW-Authenticate&quot;</span><span class="op">,</span> <span class="st">&quot;Bearer&quot;</span>).<span class="at">status</span>(<span class="dv">401</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb194-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb194-7" title="7"></a>
<a class="sourceLine" id="cb194-8" title="8">  <span class="cf">return</span> <span class="va">jwt</span>.<span class="at">verify</span>(token<span class="op">,</span> secret<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">async</span> (err<span class="op">,</span> jwtPayload) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb194-9" title="9">    <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb194-10" title="10">      <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">401</span><span class="op">;</span></a>
<a class="sourceLine" id="cb194-11" title="11">      <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-12" title="12">    <span class="op">}</span></a>
<a class="sourceLine" id="cb194-13" title="13"></a>
<a class="sourceLine" id="cb194-14" title="14">    <span class="kw">const</span> <span class="op">{</span> id <span class="op">}</span> <span class="op">=</span> <span class="va">jwtPayload</span>.<span class="at">data</span><span class="op">;</span></a>
<a class="sourceLine" id="cb194-15" title="15"></a>
<a class="sourceLine" id="cb194-16" title="16">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb194-17" title="17">      <span class="va">req</span>.<span class="at">user</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">findByPk</span>(id)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-18" title="18">    <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb194-19" title="19">      <span class="cf">return</span> <span class="at">next</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-20" title="20">    <span class="op">}</span></a>
<a class="sourceLine" id="cb194-21" title="21"></a>
<a class="sourceLine" id="cb194-22" title="22">    <span class="cf">if</span> (<span class="op">!</span><span class="va">req</span>.<span class="at">user</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb194-23" title="23">      <span class="cf">return</span> <span class="va">res</span>.<span class="at">set</span>(<span class="st">&quot;WWW-Authenticate&quot;</span><span class="op">,</span> <span class="st">&quot;Bearer&quot;</span>).<span class="at">status</span>(<span class="dv">401</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb194-24" title="24">    <span class="op">}</span></a>
<a class="sourceLine" id="cb194-25" title="25"></a>
<a class="sourceLine" id="cb194-26" title="26">    <span class="cf">return</span> <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb194-27" title="27">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-28" title="28"><span class="op">};</span></a></code></pre></div>
<p>Now, take a moment to organize your <code>bearerToken</code> generator function and the <code>restoreUser</code> function into an array named <code>requireAuth</code>. Update your module exports to export the two functions as one <code>requireAuth</code> array:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb195-1" title="1"><span class="kw">const</span> requireAuth <span class="op">=</span> [<span class="at">bearerToken</span>()<span class="op">,</span> restoreUser]<span class="op">;</span></a>
<a class="sourceLine" id="cb195-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span> getUserToken<span class="op">,</span> requireAuth <span class="op">};</span></a></code></pre></div>
<p>Now it’s time to add the <code>requireAuth</code> middleware to the tweets router! Add the following code to your <code>routes/tweets.js</code> file to use the user authentication functions you just created:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb196-1" title="1"><span class="kw">const</span> <span class="op">{</span> requireAuth <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../auth&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-2" title="2"></a>
<a class="sourceLine" id="cb196-3" title="3"><span class="co">// REST OF FILE NOT SHOWN</span></a>
<a class="sourceLine" id="cb196-4" title="4"></a>
<a class="sourceLine" id="cb196-5" title="5"><span class="va">router</span>.<span class="at">use</span>(requireAuth)<span class="op">;</span></a></code></pre></div>
<p>Verify that your tweet protection works by trying to make a GET request to <code>localhost:8080/tweets</code> from Postman. You should see a <code>401</code> response.</p>
<p>To fix this, create another user by posting to <code>localhost:8080/users</code>. This time, when the token comes back in the response, copy that response and paste it in to the <em>Authorization header</em>:</p>
<p><img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postman-jwt-token-1.png" alt="postman-user-jwt-token" /> <img src="images/api-tweets-project-postman-jwt-token-2.png" alt="postman-jwt-token-bearer-header" /></p>
<p>Then try to get all of the tweets again. This time, your request should pass through the <code>requireAuth</code> middleware functions successfully. Now that your tweets are protected, let’s add a view for users to sign up from the client application!</p>
<h2 id="phase-3-sign-up-for-user-account-from-the-client">Phase 3: Sign up for user account from the client</h2>
<p>Begin by adding a GET route in the <code>express-apis-frontend/index.js</code> file to render a <code>sign-up</code> template:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb197-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/sign-up&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb197-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;sign-up&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb197-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Use the snippet below to create a registration form for the <code>sign-up.pug</code> template.</p>
<pre class="pug"><code>extends layout.pug

block content
  div(class=&quot;sign-up-container&quot;)
    div(class=&quot;errors-container&quot;)
    h2 Sign Up
    form(class=&quot;sign-up-form&quot;)
      .form-group
        label(for=&#39;username&#39;) Username
        input#username.form-control(type=&#39;text&#39; name=&#39;username&#39; placeholder=&quot;Username&quot;)
      .form-group
        label(for=&#39;email&#39;) Email address
        input#email.form-control(type=&#39;email&#39;, name=&quot;email&quot;, placeholder=&#39;Enter email&#39;)
      .form-group
        label(for=&#39;password&#39;) Password
        input#password.form-control(type=&#39;password&#39;, name=&quot;password&quot;, placeholder=&#39;Password&#39;)
      button.btn.btn-primary(type=&#39;submit&#39;) Sign Up
    a(href=&#39;/log-in&#39;) Already have an account? Log in here.
  script(src=&quot;js/sign-up.js&quot;)</code></pre>
<p>In the code above, there’s also an anchor element to navigate to the <code>/log-in</code> route that we’ll implement next. Since the user will use the email and password input fields for the later log in form, let’s move those to an <em>includes</em> file to DRY up our code.</p>
<p>Move the following <code>.form-group</code> elements from your <code>sign-up.pug</code> file to a new <code>views/includes/auth-form-fields.pug</code> file:</p>
<pre class="pug"><code>.form-group
  label(for=&#39;email&#39;) Email address
  input#email.form-control(type=&#39;email&#39;, name=&quot;email&quot;, placeholder=&#39;Enter email&#39;)
.form-group
  label(for=&#39;password&#39;) Password
  input#password.form-control(type=&#39;password&#39;, name=&quot;password&quot;, placeholder=&#39;Password&#39;)</code></pre>
<p>Now take a moment to refactor your <code>sign-up.pug</code> template to use your new <em>includes</em> file.</p>
<p>At the bottom of the <code>sign-up.pug</code> template, notice that a <code>js/sign-up.js</code> script has already been imported. Set up this <code>sign-up.js</code> script inside your <code>express-apis-frontend/public/js</code> directory. In the script, you want to add a <em>submit</em> event listener to the sign up form (hint: search for the element with a class of <code>sign-up-form</code>) and an asynchronous callback function to handle the sign up request. Remember that <code>submit</code> events automatically prompt a GET request to re-render the page. Make sure to prevent the form from re-rendering by using <code>e.preventDefault()</code> at the beginning of your event listener:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb200-1" title="1"><span class="kw">const</span> signUpForm <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.sign-up-form&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb200-2" title="2"></a>
<a class="sourceLine" id="cb200-3" title="3"><span class="va">signUpForm</span>.<span class="at">addEventListener</span>(<span class="st">&quot;submit&quot;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb200-4" title="4">  <span class="va">e</span>.<span class="at">preventDefault</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb200-5" title="5">  <span class="co">// Sign up logic here</span></a>
<a class="sourceLine" id="cb200-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Generate a new <code>FormData</code> object with your <code>signUpForm</code>:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb201-1" title="1"><span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>(signUpForm)<span class="op">;</span></a></code></pre></div>
<p>Now use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData/get">formData.get()</a> method to retrieve the <code>username</code>, <code>email</code>, and <code>password</code> from the form. You can use the form values to declare a <code>body</code> variable:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb202-1" title="1"><span class="kw">const</span> email <span class="op">=</span> <span class="co">// </span><span class="al">TODO</span><span class="co">: Get email</span></a>
<a class="sourceLine" id="cb202-2" title="2"><span class="kw">const</span> password <span class="op">=</span> <span class="co">// </span><span class="al">TODO</span><span class="co">: Get password</span></a>
<a class="sourceLine" id="cb202-3" title="3"><span class="kw">const</span> username <span class="op">=</span> <span class="co">// </span><span class="al">TODO</span><span class="co">: Get username</span></a>
<a class="sourceLine" id="cb202-4" title="4"></a>
<a class="sourceLine" id="cb202-5" title="5"><span class="kw">const</span> body <span class="op">=</span> <span class="op">{</span> email<span class="op">,</span> password<span class="op">,</span> username <span class="op">};</span></a></code></pre></div>
<p>When a submit event happens, parse out the data from the form and then use a <code>fetch</code> call to make a POST request to <code>localhost:8080/users</code> to create the user in a <code>try</code> block. Set the <code>fetch</code> call’s <code>method</code> to be "POST" and the <code>body</code> to be a JSON string of the form fields (hint: use <code>JSON.stringify({ email, password, username })</code>). Lastly, set a <code>Content-Type</code> header of "application/json".</p>
<p>Your fetch call should look something like this:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb203-1" title="1"><span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb203-2" title="2">  <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/users&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb203-3" title="3">    <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb203-4" title="4">    <span class="dt">body</span><span class="op">:</span> <span class="va">JSON</span>.<span class="at">stringify</span>(body)<span class="op">,</span></a>
<a class="sourceLine" id="cb203-5" title="5">    <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb203-6" title="6">      <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb203-7" title="7">    <span class="op">},</span></a>
<a class="sourceLine" id="cb203-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb203-9" title="9"><span class="op">}</span></a></code></pre></div>
<p>Fetch calls don’t throw errors on error status code responses. Note that the Fetch API only rejects network failure errors. This means you need to <a href="https://github.com//Module-Web/blob/master/readings/ajax/reading-ajax-steps.md#error-handling">manually handle response errors</a> by checking the response’s <code>ok</code> property. Add the code snippet below in your <code>try</code> block to manually throw an error if the fetch request was rejected:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb204-1" title="1"><span class="cf">if</span> (<span class="op">!</span><span class="va">res</span>.<span class="at">ok</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb204-2" title="2">  <span class="cf">throw</span> res<span class="op">;</span></a>
<a class="sourceLine" id="cb204-3" title="3"><span class="op">}</span></a></code></pre></div>
<p>When the response body returns, store the JWT token and the user id in <code>localStorage</code> and redirect the user to the home page:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb205-1" title="1"><span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-2" title="2">  token<span class="op">,</span></a>
<a class="sourceLine" id="cb205-3" title="3">  <span class="dt">user</span><span class="op">:</span> <span class="op">{</span> id <span class="op">},</span></a>
<a class="sourceLine" id="cb205-4" title="4"><span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb205-5" title="5"></a>
<a class="sourceLine" id="cb205-6" title="6"><span class="va">localStorage</span>.<span class="at">setItem</span>(<span class="st">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span><span class="op">,</span> token)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-7" title="7"><span class="va">localStorage</span>.<span class="at">setItem</span>(<span class="st">&quot;TWITTER_LITE_CURRENT_USER_ID&quot;</span><span class="op">,</span> id)<span class="op">;</span></a></code></pre></div>
<p>If an error happens, await the parsing of the error object as JSON and query for your element with the class of <code>errors-container</code>. Your <code>try</code>/<code>catch</code> block should currently look something like this:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb206-1" title="1"><span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb206-2" title="2">  <span class="co">// CODE OMITTED FOR BREVITY</span></a>
<a class="sourceLine" id="cb206-3" title="3"></a>
<a class="sourceLine" id="cb206-4" title="4">  <span class="cf">if</span> (<span class="op">!</span><span class="va">res</span>.<span class="at">ok</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb206-5" title="5">    <span class="cf">throw</span> res<span class="op">;</span></a>
<a class="sourceLine" id="cb206-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb206-7" title="7">  <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb206-8" title="8">    token<span class="op">,</span></a>
<a class="sourceLine" id="cb206-9" title="9">    <span class="dt">user</span><span class="op">:</span> <span class="op">{</span> id <span class="op">},</span></a>
<a class="sourceLine" id="cb206-10" title="10">  <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb206-11" title="11"></a>
<a class="sourceLine" id="cb206-12" title="12">  <span class="co">// CODE OMITTED FOR BREVITY</span></a>
<a class="sourceLine" id="cb206-13" title="13"><span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb206-14" title="14">  <span class="cf">if</span> (<span class="va">err</span>.<span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">400</span> <span class="op">&amp;&amp;</span> <span class="va">err</span>.<span class="at">status</span> <span class="op">&lt;</span> <span class="dv">600</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb206-15" title="15">    <span class="kw">const</span> errorJSON <span class="op">=</span> <span class="cf">await</span> <span class="va">err</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb206-16" title="16">    <span class="kw">const</span> errorsContainer <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.errors-container&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb206-17" title="17">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Generate and render errors</span></a>
<a class="sourceLine" id="cb206-18" title="18">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb206-19" title="19">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Alert user about bad internet connection</span></a>
<a class="sourceLine" id="cb206-20" title="20">  <span class="op">}</span></a>
<a class="sourceLine" id="cb206-21" title="21"><span class="op">}</span></a></code></pre></div>
<p>Like how you rendered your list of tweets when you first connected the frontend to your application, you’ll set the <code>innerHTML</code> of your <code>errorsContainer</code> to a stringified HTML block. Sometimes there might not be an errors array returned, and in those cases, go ahead and declare the <code>errorsHtml</code> array to display a generic "Something went wrong" message.</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb207-1" title="1"><span class="co">// errorsHtml block to alert user of error:</span></a>
<a class="sourceLine" id="cb207-2" title="2"><span class="kw">let</span> errorsHtml <span class="op">=</span> [</a>
<a class="sourceLine" id="cb207-3" title="3">  <span class="vs">`</span></a>
<a class="sourceLine" id="cb207-4" title="4"><span class="vs">    &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb207-5" title="5"><span class="vs">        Something went wrong. Please try again.</span></a>
<a class="sourceLine" id="cb207-6" title="6"><span class="vs">    &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb207-7" title="7"><span class="vs">  `</span><span class="op">,</span></a>
<a class="sourceLine" id="cb207-8" title="8">]<span class="op">;</span></a></code></pre></div>
<p>Now take a look at the global error handling function in your <code>app.js</code> and notice how you are rendering an <code>errors</code> property in your JSON response. This <code>errors</code> property is the array of error messages from your validations. Iterate through the <code>errors</code> array and display them:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb208-1" title="1"><span class="cf">if</span> (errors <span class="op">&amp;&amp;</span> <span class="va">Array</span>.<span class="at">isArray</span>(errors)) <span class="op">{</span></a>
<a class="sourceLine" id="cb208-2" title="2">  errorsHtml <span class="op">=</span> <span class="va">errors</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb208-3" title="3">    (message) <span class="kw">=&gt;</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb208-4" title="4"><span class="vs">    &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb208-5" title="5"><span class="vs">        </span><span class="sc">${</span>message<span class="sc">}</span></a>
<a class="sourceLine" id="cb208-6" title="6"><span class="vs">    &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb208-7" title="7"><span class="vs">  `</span></a>
<a class="sourceLine" id="cb208-8" title="8">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb208-9" title="9">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Join errorsHtml and set the errorsContainer.innerHTML</span></a>
<a class="sourceLine" id="cb208-10" title="10">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Error rendering</span></a>
<a class="sourceLine" id="cb208-11" title="11"><span class="op">}</span></a></code></pre></div>
<p>Since the Fetch API only throws errors on network errors (like if your internet cut out), so then we would also need to account for those types of errors. To account for these cases, go ahead and use the JavaScript <code>alert()</code> function to let the user know to check their internet connection:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb209-1" title="1"><span class="at">alert</span>(</a>
<a class="sourceLine" id="cb209-2" title="2">  <span class="st">&quot;Something went wrong. Please check your internet connection and try again!&quot;</span></a>
<a class="sourceLine" id="cb209-3" title="3">)<span class="op">;</span></a></code></pre></div>
<p>If the create request succeeds, redirect the user back to the home page right after you set your <code>localStorage</code> items. Use the <code>window.location.href</code> property so that the user can see all existing tweets:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb210-1" title="1"><span class="va">window</span>.<span class="va">location</span>.<span class="at">href</span> <span class="op">=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span></a></code></pre></div>
<p>At this point, your <code>sign-up.js</code> file should look something like this:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb211-1" title="1"><span class="kw">const</span> signUpForm <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.sign-up-form&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-2" title="2"></a>
<a class="sourceLine" id="cb211-3" title="3"><span class="va">signUpForm</span>.<span class="at">addEventListener</span>(<span class="st">&quot;submit&quot;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb211-4" title="4">  <span class="va">e</span>.<span class="at">preventDefault</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb211-5" title="5">  <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>(signUpForm)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-6" title="6"></a>
<a class="sourceLine" id="cb211-7" title="7">  <span class="kw">const</span> username <span class="op">=</span> <span class="va">formData</span>.<span class="at">get</span>(<span class="st">&quot;username&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-8" title="8">  <span class="kw">const</span> email <span class="op">=</span> <span class="va">formData</span>.<span class="at">get</span>(<span class="st">&quot;email&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-9" title="9">  <span class="kw">const</span> password <span class="op">=</span> <span class="va">formData</span>.<span class="at">get</span>(<span class="st">&quot;password&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-10" title="10"></a>
<a class="sourceLine" id="cb211-11" title="11">  <span class="kw">const</span> body <span class="op">=</span> <span class="op">{</span> email<span class="op">,</span> password<span class="op">,</span> username <span class="op">};</span></a>
<a class="sourceLine" id="cb211-12" title="12">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb211-13" title="13">    <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/users&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb211-14" title="14">      <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb211-15" title="15">      <span class="dt">body</span><span class="op">:</span> <span class="va">JSON</span>.<span class="at">stringify</span>(body)<span class="op">,</span></a>
<a class="sourceLine" id="cb211-16" title="16">      <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb211-17" title="17">        <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb211-18" title="18">      <span class="op">},</span></a>
<a class="sourceLine" id="cb211-19" title="19">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-20" title="20"></a>
<a class="sourceLine" id="cb211-21" title="21">    <span class="cf">if</span> (<span class="op">!</span><span class="va">res</span>.<span class="at">ok</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb211-22" title="22">      <span class="cf">throw</span> res<span class="op">;</span></a>
<a class="sourceLine" id="cb211-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb211-24" title="24"></a>
<a class="sourceLine" id="cb211-25" title="25">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb211-26" title="26">      token<span class="op">,</span></a>
<a class="sourceLine" id="cb211-27" title="27">      <span class="dt">user</span><span class="op">:</span> <span class="op">{</span> id <span class="op">},</span></a>
<a class="sourceLine" id="cb211-28" title="28">    <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb211-29" title="29">    <span class="co">// storage access_token in localStorage:</span></a>
<a class="sourceLine" id="cb211-30" title="30">    <span class="va">localStorage</span>.<span class="at">setItem</span>(<span class="st">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span><span class="op">,</span> token)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-31" title="31">    <span class="va">localStorage</span>.<span class="at">setItem</span>(<span class="st">&quot;TWITTER_LITE_CURRENT_USER_ID&quot;</span><span class="op">,</span> id)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-32" title="32">    <span class="co">// redirect to home page to see all tweets:</span></a>
<a class="sourceLine" id="cb211-33" title="33">    <span class="va">window</span>.<span class="va">location</span>.<span class="at">href</span> <span class="op">=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb211-34" title="34">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb211-35" title="35">    <span class="cf">if</span> (<span class="va">err</span>.<span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">400</span> <span class="op">&amp;&amp;</span> <span class="va">err</span>.<span class="at">status</span> <span class="op">&lt;</span> <span class="dv">600</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb211-36" title="36">      <span class="kw">const</span> errorJSON <span class="op">=</span> <span class="cf">await</span> <span class="va">err</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb211-37" title="37">      <span class="kw">const</span> errorsContainer <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.errors-container&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-38" title="38">      <span class="kw">let</span> errorsHtml <span class="op">=</span> [</a>
<a class="sourceLine" id="cb211-39" title="39">        <span class="vs">`</span></a>
<a class="sourceLine" id="cb211-40" title="40"><span class="vs">        &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb211-41" title="41"><span class="vs">            Something went wrong. Please try again.</span></a>
<a class="sourceLine" id="cb211-42" title="42"><span class="vs">        &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb211-43" title="43"><span class="vs">      `</span><span class="op">,</span></a>
<a class="sourceLine" id="cb211-44" title="44">      ]<span class="op">;</span></a>
<a class="sourceLine" id="cb211-45" title="45">      <span class="kw">const</span> <span class="op">{</span> errors <span class="op">}</span> <span class="op">=</span> errorJSON<span class="op">;</span></a>
<a class="sourceLine" id="cb211-46" title="46">      <span class="cf">if</span> (errors <span class="op">&amp;&amp;</span> <span class="va">Array</span>.<span class="at">isArray</span>(errors)) <span class="op">{</span></a>
<a class="sourceLine" id="cb211-47" title="47">        errorsHtml <span class="op">=</span> <span class="va">errors</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb211-48" title="48">          (message) <span class="kw">=&gt;</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb211-49" title="49"><span class="vs">          &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb211-50" title="50"><span class="vs">              </span><span class="sc">${</span>message<span class="sc">}</span></a>
<a class="sourceLine" id="cb211-51" title="51"><span class="vs">          &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb211-52" title="52"><span class="vs">        `</span></a>
<a class="sourceLine" id="cb211-53" title="53">        )<span class="op">;</span></a>
<a class="sourceLine" id="cb211-54" title="54">      <span class="op">}</span></a>
<a class="sourceLine" id="cb211-55" title="55">      <span class="va">errorsContainer</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">errorsHtml</span>.<span class="at">join</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb211-56" title="56">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb211-57" title="57">      <span class="at">alert</span>(</a>
<a class="sourceLine" id="cb211-58" title="58">        <span class="st">&quot;Something went wrong. Please check your internet connection and try again!&quot;</span></a>
<a class="sourceLine" id="cb211-59" title="59">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb211-60" title="60">    <span class="op">}</span></a>
<a class="sourceLine" id="cb211-61" title="61">  <span class="op">}</span></a>
<a class="sourceLine" id="cb211-62" title="62"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>When a user signs up and is redirected to the home page, the request for all tweets should be failing because that request doesn’t currently have the correct authentication headers. Let’s fix this.</p>
<p>In the <code>public/js/index.js</code> file, add the <code>Authorization</code> header to your fetch call.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb212-1" title="1"><span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/tweets&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb212-2" title="2">  <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb212-3" title="3">    <span class="dt">Authorization</span><span class="op">:</span> <span class="vs">`Bearer </span><span class="sc">${</span><span class="va">localStorage</span>.<span class="at">getItem</span>(</a>
<a class="sourceLine" id="cb212-4" title="4">      <span class="st">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span></a>
<a class="sourceLine" id="cb212-5" title="5">    )<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb212-6" title="6">  <span class="op">},</span></a>
<a class="sourceLine" id="cb212-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Then, add the following code into your "DOMContentLoaded" event listener to redirect users to the log-in route if a user is not logged in. The next step is to implement the log-in route!</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb213-1" title="1"><span class="cf">if</span> (<span class="va">res</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">401</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb213-2" title="2">  <span class="va">window</span>.<span class="va">location</span>.<span class="at">href</span> <span class="op">=</span> <span class="st">&quot;/log-in&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb213-3" title="3">  <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb213-4" title="4"><span class="op">}</span></a></code></pre></div>
<p>Now that you’ve implemented a sign-up flow, let’s next implement a log-in flow!</p>
<h2 id="phase-4-setting-up-the-log-in-flow">Phase 4: Setting up the log-in flow</h2>
<p>Go back to the API and add a route to the users router that allows users to fetch a new token, effectively logging them in. Do this by creating POST route to the <code>/token</code> path and using the <code>validateEmailAndPassword</code> middleware. Wrap your asynchronous route handler function with your <code>asyncHandler</code> helper method and destructure the <code>email</code> and <code>password</code> from your request body. Begin by using the <code>email</code> to find your user instance:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb214-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb214-2" title="2">  <span class="st">&quot;/token&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb214-3" title="3">  validateEmailAndPassword<span class="op">,</span></a>
<a class="sourceLine" id="cb214-4" title="4">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb214-5" title="5">    <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb214-6" title="6">    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb214-7" title="7">      <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb214-8" title="8">        email<span class="op">,</span></a>
<a class="sourceLine" id="cb214-9" title="9">      <span class="op">},</span></a>
<a class="sourceLine" id="cb214-10" title="10">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb214-11" title="11"></a>
<a class="sourceLine" id="cb214-12" title="12">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Password validation and error handling</span></a>
<a class="sourceLine" id="cb214-13" title="13">    <span class="co">// </span><span class="al">TODO</span><span class="co">: Token generation</span></a>
<a class="sourceLine" id="cb214-14" title="14">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb214-15" title="15">)<span class="op">;</span></a></code></pre></div>
<p>Now we need a way to validate whether or not the provided password is correct. Let’s implement a password validation function in the User model as an instance method! Add the instance method below to your <code>user.js</code> model file:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb215-1" title="1"><span class="va">User</span>.<span class="va">prototype</span>.<span class="at">validatePassword</span> <span class="op">=</span> <span class="kw">function</span> (password) <span class="op">{</span></a>
<a class="sourceLine" id="cb215-2" title="2">  <span class="co">// Note that since this function is a model instance method,</span></a>
<a class="sourceLine" id="cb215-3" title="3">  <span class="co">// `this` is the user instance here:</span></a>
<a class="sourceLine" id="cb215-4" title="4">  <span class="cf">return</span> <span class="va">bcrypt</span>.<span class="at">compareSync</span>(password<span class="op">,</span> <span class="kw">this</span>.<span class="va">hashedPassword</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb215-5" title="5"><span class="op">};</span></a></code></pre></div>
<p>Note how the <code>hashedPassword</code> has to be converted back from its <em>binary</em> format to a <em>string</em> format before it can be compared with the provided <code>password</code>.</p>
<p>Back in the <code>/token</code> route handler, verify whether the a valid <code>user</code> has been found and use the <code>validatePassword</code> instance method to verify whether or not the user provided the correct credentials. If a valid user was found with a valid password, return a <code>token</code> and the user’s <code>id</code> in the JSON response. If a valid user was not found or the password was incorrect, generate an error and return an invocation of the <code>next</code> function passing in the error:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb216-1" title="1"><span class="cf">if</span> (<span class="op">!</span>user <span class="op">||</span> <span class="op">!</span><span class="va">user</span>.<span class="at">validatePassword</span>(password)) <span class="op">{</span></a>
<a class="sourceLine" id="cb216-2" title="2">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Login failed&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb216-3" title="3">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">401</span><span class="op">;</span></a>
<a class="sourceLine" id="cb216-4" title="4">  <span class="va">err</span>.<span class="at">title</span> <span class="op">=</span> <span class="st">&quot;Login failed&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb216-5" title="5">  <span class="va">err</span>.<span class="at">errors</span> <span class="op">=</span> [<span class="st">&quot;The provided credentials were invalid.&quot;</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb216-6" title="6">  <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb216-7" title="7"><span class="op">}</span></a></code></pre></div>
<p>Make sure to generate a token by invoking your <code>getUserToken()</code> function with the <code>user</code> fetched from your database. Lastly, render a JSON response with the <code>token</code> and the user’s <code>id</code>:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb217-1" title="1"><span class="kw">const</span> token <span class="op">=</span> <span class="at">getUserToken</span>(user)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-2" title="2"><span class="va">res</span>.<span class="at">json</span>(<span class="op">{</span> token<span class="op">,</span> <span class="dt">user</span><span class="op">:</span> <span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Next, go back to the frontend and set up a <code>localhost:4000/log-in</code> route. The logic is fairly similar to the sign-up route. First, set up a GET route in your <code>express-apis-frontend/index.js</code> file to render a <code>log-in</code> template:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb218-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/log-in&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb218-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;log-in&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Then create a <code>views/log-in.pug</code> template with the snippet below:</p>
<pre class="pug"><code>extends layout.pug

block content
  div(class=&quot;log-in-container&quot;)
    div(class=&quot;errors-container&quot;)
    h2 Log In
    form(class=&quot;log-in-form&quot;)
      include includes/auth-form-fields
      button.btn.btn-primary(type=&#39;submit&#39;) Log In
    a(href=&#39;/sign-up&#39;) Don&#39;t have an account? Sign up here.
  script(src=&quot;js/log-in.js&quot;)</code></pre>
<p>Now create a <code>public/js/log-in.js</code> file and add a <em>submit</em> event listener to do fairly similar logic to the event listener in your <code>public/js/sign-up.js</code> file:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb220-1" title="1"><span class="kw">const</span> logInForm <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.log-in-form&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-2" title="2"></a>
<a class="sourceLine" id="cb220-3" title="3"><span class="va">logInForm</span>.<span class="at">addEventListener</span>(<span class="st">&quot;submit&quot;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-4" title="4">  <span class="va">e</span>.<span class="at">preventDefault</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb220-5" title="5">  <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>(logInForm)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-6" title="6">  <span class="kw">const</span> email <span class="op">=</span> <span class="va">formData</span>.<span class="at">get</span>(<span class="st">&quot;email&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-7" title="7">  <span class="kw">const</span> password <span class="op">=</span> <span class="va">formData</span>.<span class="at">get</span>(<span class="st">&quot;password&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-8" title="8">  <span class="kw">const</span> body <span class="op">=</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">};</span></a>
<a class="sourceLine" id="cb220-9" title="9">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-10" title="10">    <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(<span class="st">&quot;http://localhost:8080/users/token&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-11" title="11">      <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb220-12" title="12">      <span class="dt">body</span><span class="op">:</span> <span class="va">JSON</span>.<span class="at">stringify</span>(body)<span class="op">,</span></a>
<a class="sourceLine" id="cb220-13" title="13">      <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-14" title="14">        <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb220-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb220-16" title="16">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-17" title="17">    <span class="cf">if</span> (<span class="op">!</span><span class="va">res</span>.<span class="at">ok</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb220-18" title="18">      <span class="cf">throw</span> res<span class="op">;</span></a>
<a class="sourceLine" id="cb220-19" title="19">    <span class="op">}</span></a>
<a class="sourceLine" id="cb220-20" title="20">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-21" title="21">      token<span class="op">,</span></a>
<a class="sourceLine" id="cb220-22" title="22">      <span class="dt">user</span><span class="op">:</span> <span class="op">{</span> id <span class="op">},</span></a>
<a class="sourceLine" id="cb220-23" title="23">    <span class="op">}</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">res</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb220-24" title="24">    <span class="co">// storage access_token in localStorage:</span></a>
<a class="sourceLine" id="cb220-25" title="25">    <span class="va">localStorage</span>.<span class="at">setItem</span>(<span class="st">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span><span class="op">,</span> token)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-26" title="26">    <span class="va">localStorage</span>.<span class="at">setItem</span>(<span class="st">&quot;TWITTER_LITE_CURRENT_USER_ID&quot;</span><span class="op">,</span> id)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-27" title="27">    <span class="co">// redirect to home page to see all tweets:</span></a>
<a class="sourceLine" id="cb220-28" title="28">    <span class="va">window</span>.<span class="va">location</span>.<span class="at">href</span> <span class="op">=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb220-29" title="29">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb220-30" title="30">    <span class="cf">if</span> (<span class="va">err</span>.<span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">400</span> <span class="op">&amp;&amp;</span> <span class="va">err</span>.<span class="at">status</span> <span class="op">&lt;</span> <span class="dv">600</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb220-31" title="31">      <span class="kw">const</span> errorJSON <span class="op">=</span> <span class="cf">await</span> <span class="va">err</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb220-32" title="32">      <span class="kw">const</span> errorsContainer <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.errors-container&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-33" title="33">      <span class="kw">let</span> errorsHtml <span class="op">=</span> [</a>
<a class="sourceLine" id="cb220-34" title="34">        <span class="vs">`</span></a>
<a class="sourceLine" id="cb220-35" title="35"><span class="vs">        &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb220-36" title="36"><span class="vs">            Something went wrong. Please try again.</span></a>
<a class="sourceLine" id="cb220-37" title="37"><span class="vs">        &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb220-38" title="38"><span class="vs">      `</span><span class="op">,</span></a>
<a class="sourceLine" id="cb220-39" title="39">      ]<span class="op">;</span></a>
<a class="sourceLine" id="cb220-40" title="40">      <span class="kw">const</span> <span class="op">{</span> errors <span class="op">}</span> <span class="op">=</span> errorJSON<span class="op">;</span></a>
<a class="sourceLine" id="cb220-41" title="41">      <span class="cf">if</span> (errors <span class="op">&amp;&amp;</span> <span class="va">Array</span>.<span class="at">isArray</span>(errors)) <span class="op">{</span></a>
<a class="sourceLine" id="cb220-42" title="42">        errorsHtml <span class="op">=</span> <span class="va">errors</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb220-43" title="43">          (message) <span class="kw">=&gt;</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb220-44" title="44"><span class="vs">          &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb220-45" title="45"><span class="vs">              </span><span class="sc">${</span>message<span class="sc">}</span></a>
<a class="sourceLine" id="cb220-46" title="46"><span class="vs">          &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb220-47" title="47"><span class="vs">        `</span></a>
<a class="sourceLine" id="cb220-48" title="48">        )<span class="op">;</span></a>
<a class="sourceLine" id="cb220-49" title="49">      <span class="op">}</span></a>
<a class="sourceLine" id="cb220-50" title="50">      <span class="va">errorsContainer</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">errorsHtml</span>.<span class="at">join</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-51" title="51">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-52" title="52">      <span class="at">alert</span>(</a>
<a class="sourceLine" id="cb220-53" title="53">        <span class="st">&quot;Something went wrong. Please check your internet connection and try again!&quot;</span></a>
<a class="sourceLine" id="cb220-54" title="54">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb220-55" title="55">    <span class="op">}</span></a>
<a class="sourceLine" id="cb220-56" title="56">  <span class="op">}</span></a>
<a class="sourceLine" id="cb220-57" title="57"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>At this point, you might be thinking to yourself that this all seems super repetitive. In server-side Node.js code, you’ve been using CommonJS modules to DRY up your code. Unfortunately, you haven’t learned about client-side modules yet, but when you get to React, you’ll learn more about using a frontend module system in order to clean up your code!</p>
<p>Now create a new user, and then go to the log in form to verify that the log in process works when you log in with the created user credentials.</p>
<h2 id="phase-5-creating-tweets-from-the-frontend-application">Phase 5: Creating tweets from the frontend application</h2>
<p>Let’s first reorganize the API so that tweets belong to a specific user. First, rollback all of your migrations by running the command below:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb221-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate:undo:all</a></code></pre></div>
<p>Then since we need to associate tweets with a user, add a foreign key of <code>userId</code> so that tweets can belong to users. Here’s what your updated tweets migration file should look like:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb222-1" title="1"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb222-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-3" title="3">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&quot;Tweets&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-5" title="5">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-6" title="6">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-7" title="7">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-8" title="8">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-9" title="9">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb222-11" title="11">      <span class="dt">message</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-12" title="12">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span>(<span class="dv">280</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb222-13" title="13">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-14" title="14">      <span class="op">},</span></a>
<a class="sourceLine" id="cb222-15" title="15">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-16" title="16">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-17" title="17">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-18" title="18">      <span class="op">},</span></a>
<a class="sourceLine" id="cb222-19" title="19">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-20" title="20">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-21" title="21">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-22" title="22">      <span class="op">},</span></a>
<a class="sourceLine" id="cb222-23" title="23">      <span class="dt">userId</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-24" title="24">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-25" title="25">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-26" title="26">        <span class="dt">references</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-27" title="27">          <span class="dt">model</span><span class="op">:</span> <span class="st">&quot;Users&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-28" title="28">          <span class="dt">key</span><span class="op">:</span> <span class="st">&quot;id&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb222-29" title="29">        <span class="op">},</span></a>
<a class="sourceLine" id="cb222-30" title="30">      <span class="op">},</span></a>
<a class="sourceLine" id="cb222-31" title="31">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb222-32" title="32">  <span class="op">},</span></a>
<a class="sourceLine" id="cb222-33" title="33">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb222-34" title="34">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&quot;Tweets&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb222-35" title="35">  <span class="op">},</span></a>
<a class="sourceLine" id="cb222-36" title="36"><span class="op">};</span></a></code></pre></div>
<p>However, there’s a problem right now. The <code>create-tweet</code> migration file was created first, and because of the timestamp in the first part of the file name, that specific migration will run first. The problem is that when we try to reference the Users table in the <code>references</code> definition part of the migration, the Users table has not actually been created yet. We’re going to take a <em>hacky</em> approach to resolve this issue and make the <code>create-user</code> migration run first.</p>
<p>To be clear, this is absolutely not how you would want to handle migrations in production. This whole "undo all migrates and then switch up the order of migrations" is purely for learning purposes and to help you get a better of how migrations work. So, go ahead and rename the <code>create-tweet</code> migration file so that the timestamp comes later than the <code>create-user</code> migration file:</p>
<figure>
<img src="images/api-tweets-project-migration-file-rename.png" alt="migration-file-rename" /><figcaption>migration-file-rename</figcaption>
</figure>
<p>Now, that you’ve updated the migrations to properly configure the tables in your database, update the models to also reflect this relationship. This is what your tweet model should look like:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb223-1" title="1"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb223-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-3" title="3">  <span class="kw">const</span> Tweet <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(</a>
<a class="sourceLine" id="cb223-4" title="4">    <span class="st">&quot;Tweet&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb223-5" title="5">    <span class="op">{</span></a>
<a class="sourceLine" id="cb223-6" title="6">      <span class="dt">message</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-7" title="7">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">280</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb223-8" title="8">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb223-9" title="9">      <span class="op">},</span></a>
<a class="sourceLine" id="cb223-10" title="10">    <span class="op">},</span></a>
<a class="sourceLine" id="cb223-11" title="11">    <span class="op">{}</span></a>
<a class="sourceLine" id="cb223-12" title="12">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb223-13" title="13">  <span class="va">Tweet</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span> (models) <span class="op">{</span></a>
<a class="sourceLine" id="cb223-14" title="14">    <span class="va">Tweet</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">User</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-15" title="15">      <span class="dt">as</span><span class="op">:</span> <span class="st">&quot;user&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb223-16" title="16">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&quot;userId&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb223-17" title="17">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-18" title="18">  <span class="op">};</span></a>
<a class="sourceLine" id="cb223-19" title="19">  <span class="cf">return</span> Tweet<span class="op">;</span></a>
<a class="sourceLine" id="cb223-20" title="20"><span class="op">};</span></a></code></pre></div>
<p>This is what your user model should look like after you add the associations:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb224-1" title="1"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb224-2" title="2"><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;bcryptjs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb224-3" title="3"></a>
<a class="sourceLine" id="cb224-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb224-5" title="5">  <span class="kw">const</span> User <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(</a>
<a class="sourceLine" id="cb224-6" title="6">    <span class="st">&quot;User&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-7" title="7">    <span class="op">{</span></a>
<a class="sourceLine" id="cb224-8" title="8">      <span class="dt">email</span><span class="op">:</span> <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span> <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">unique</span><span class="op">:</span> <span class="kw">true</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb224-9" title="9">      <span class="dt">username</span><span class="op">:</span> <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span> <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">unique</span><span class="op">:</span> <span class="kw">true</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb224-10" title="10">      <span class="dt">hashedPassword</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb224-11" title="11">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="va">STRING</span>.<span class="at">BINARY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-12" title="12">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-13" title="13">      <span class="op">},</span></a>
<a class="sourceLine" id="cb224-14" title="14">    <span class="op">},</span></a>
<a class="sourceLine" id="cb224-15" title="15">    <span class="op">{}</span></a>
<a class="sourceLine" id="cb224-16" title="16">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb224-17" title="17">  <span class="va">User</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span> (models) <span class="op">{</span></a>
<a class="sourceLine" id="cb224-18" title="18">    <span class="va">User</span>.<span class="at">hasMany</span>(<span class="va">models</span>.<span class="at">Tweet</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb224-19" title="19">      <span class="dt">as</span><span class="op">:</span> <span class="st">&quot;tweets&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-20" title="20">      <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&quot;userId&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-21" title="21">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb224-22" title="22">  <span class="op">};</span></a>
<a class="sourceLine" id="cb224-23" title="23"></a>
<a class="sourceLine" id="cb224-24" title="24">  <span class="va">User</span>.<span class="va">prototype</span>.<span class="at">validatePassword</span> <span class="op">=</span> <span class="kw">function</span> (password) <span class="op">{</span></a>
<a class="sourceLine" id="cb224-25" title="25">    <span class="co">// because this is a model instance method, `this` is the user instance here:</span></a>
<a class="sourceLine" id="cb224-26" title="26">    <span class="cf">return</span> <span class="va">bcrypt</span>.<span class="at">compareSync</span>(password<span class="op">,</span> <span class="kw">this</span>.<span class="va">hashedPassword</span>.<span class="at">toString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb224-27" title="27">  <span class="op">};</span></a>
<a class="sourceLine" id="cb224-28" title="28"></a>
<a class="sourceLine" id="cb224-29" title="29">  <span class="cf">return</span> User<span class="op">;</span></a>
<a class="sourceLine" id="cb224-30" title="30"><span class="op">};</span></a></code></pre></div>
<p>Finally, let’s also update the seeders to reflect this new relationship between tweets and users. We’ll also use the faker library to generate fake content, so run <code>npm install faker</code>, and then update the seeders to:</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb225-1" title="1"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb225-2" title="2"></a>
<a class="sourceLine" id="cb225-3" title="3"><span class="kw">const</span> faker <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;faker&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-4" title="4"><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;bcryptjs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-5" title="5"></a>
<a class="sourceLine" id="cb225-6" title="6"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb225-7" title="7">  <span class="dt">up</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb225-8" title="8">    <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(</a>
<a class="sourceLine" id="cb225-9" title="9">      <span class="st">&quot;Users&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb225-10" title="10">      [</a>
<a class="sourceLine" id="cb225-11" title="11">        <span class="op">{</span></a>
<a class="sourceLine" id="cb225-12" title="12">          <span class="dt">username</span><span class="op">:</span> <span class="va">faker</span>.<span class="va">internet</span>.<span class="at">userName</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-13" title="13">          <span class="dt">email</span><span class="op">:</span> <span class="va">faker</span>.<span class="va">internet</span>.<span class="at">email</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-14" title="14">          <span class="dt">hashedPassword</span><span class="op">:</span> <span class="va">bcrypt</span>.<span class="at">hashSync</span>(<span class="va">faker</span>.<span class="va">internet</span>.<span class="at">password</span>())<span class="op">,</span></a>
<a class="sourceLine" id="cb225-15" title="15">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-16" title="16">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-17" title="17">        <span class="op">},</span></a>
<a class="sourceLine" id="cb225-18" title="18">        <span class="op">{</span></a>
<a class="sourceLine" id="cb225-19" title="19">          <span class="dt">username</span><span class="op">:</span> <span class="va">faker</span>.<span class="va">internet</span>.<span class="at">userName</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-20" title="20">          <span class="dt">email</span><span class="op">:</span> <span class="va">faker</span>.<span class="va">internet</span>.<span class="at">email</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-21" title="21">          <span class="dt">hashedPassword</span><span class="op">:</span> <span class="va">bcrypt</span>.<span class="at">hashSync</span>(<span class="va">faker</span>.<span class="va">internet</span>.<span class="at">password</span>())<span class="op">,</span></a>
<a class="sourceLine" id="cb225-22" title="22">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-23" title="23">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-24" title="24">        <span class="op">},</span></a>
<a class="sourceLine" id="cb225-25" title="25">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb225-26" title="26">      <span class="op">{</span> <span class="dt">returning</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb225-27" title="27">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb225-28" title="28"></a>
<a class="sourceLine" id="cb225-29" title="29">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(</a>
<a class="sourceLine" id="cb225-30" title="30">      <span class="st">&quot;Tweets&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb225-31" title="31">      [</a>
<a class="sourceLine" id="cb225-32" title="32">        <span class="op">{</span></a>
<a class="sourceLine" id="cb225-33" title="33">          <span class="dt">message</span><span class="op">:</span> <span class="va">faker</span>.<span class="va">company</span>.<span class="at">catchPhrase</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-34" title="34">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-35" title="35">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-36" title="36">          <span class="dt">userId</span><span class="op">:</span> users[<span class="dv">0</span>].<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb225-37" title="37">        <span class="op">},</span></a>
<a class="sourceLine" id="cb225-38" title="38">        <span class="op">{</span></a>
<a class="sourceLine" id="cb225-39" title="39">          <span class="dt">message</span><span class="op">:</span> <span class="va">faker</span>.<span class="va">company</span>.<span class="at">catchPhrase</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-40" title="40">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-41" title="41">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-42" title="42">          <span class="dt">userId</span><span class="op">:</span> users[<span class="dv">0</span>].<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb225-43" title="43">        <span class="op">},</span></a>
<a class="sourceLine" id="cb225-44" title="44">        <span class="op">{</span></a>
<a class="sourceLine" id="cb225-45" title="45">          <span class="dt">message</span><span class="op">:</span> <span class="va">faker</span>.<span class="va">company</span>.<span class="at">catchPhrase</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-46" title="46">          <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-47" title="47">          <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb225-48" title="48">          <span class="dt">userId</span><span class="op">:</span> users[<span class="dv">1</span>].<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb225-49" title="49">        <span class="op">},</span></a>
<a class="sourceLine" id="cb225-50" title="50">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb225-51" title="51">      <span class="op">{}</span></a>
<a class="sourceLine" id="cb225-52" title="52">    )<span class="op">;</span></a>
<a class="sourceLine" id="cb225-53" title="53">  <span class="op">},</span></a>
<a class="sourceLine" id="cb225-54" title="54"></a>
<a class="sourceLine" id="cb225-55" title="55">  <span class="dt">down</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb225-56" title="56">    <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&quot;Tweets&quot;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-57" title="57">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&quot;Users&quot;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-58" title="58">  <span class="op">},</span></a>
<a class="sourceLine" id="cb225-59" title="59"><span class="op">};</span></a></code></pre></div>
<p>Now that you’ve updated the migrations, models, and seeders to reflect the tweets <em>belongsTo</em> users and user <em>hasMany</em> tweets relationships, let’s run all of the migrations and seed scripts:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb226-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate</a>
<a class="sourceLine" id="cb226-2" title="2"><span class="ex">npx</span> dotenv sequelize db:seed:all</a></code></pre></div>
<p>Check Postbird to verify all the data has been properly created. Go to <code>routes/tweets.js</code> and update the post route so that when a tweet is created, the <code>id</code> of the <code>req.user</code> is stored in the <code>userId</code> column of the tweet:</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb227-1" title="1"><span class="kw">const</span> tweet <span class="op">=</span> <span class="cf">await</span> <span class="va">Tweet</span>.<span class="at">create</span>(<span class="op">{</span> message<span class="op">,</span> <span class="dt">userId</span><span class="op">:</span> <span class="va">req</span>.<span class="va">user</span>.<span class="at">id</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Finally, update the GET <code>/</code> tweets route so that it also includes the author of the tweet. You previously learned about eager loading associations. When designing APIs, it’s critical that you don’t return any more info than is necessary.</p>
<p>So for example, in this case, when you eager load the user, if you didn’t filter anything out, then it would include extra info like user email address or the hashedPassword, when really all the client needs to know from this route is the username of the author of the specific tweet and perhaps the user id of the author.</p>
<p>Fortunately, we can use sequelize <code>attributes</code> to filter out the fields that get returned from the sequelize query:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb228-1" title="1"><span class="kw">const</span> tweets <span class="op">=</span> <span class="cf">await</span> <span class="va">Tweet</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb228-2" title="2">  <span class="dt">include</span><span class="op">:</span> [<span class="op">{</span> <span class="dt">model</span><span class="op">:</span> User<span class="op">,</span> <span class="dt">as</span><span class="op">:</span> <span class="st">&quot;user&quot;</span><span class="op">,</span> <span class="dt">attributes</span><span class="op">:</span> [<span class="st">&quot;username&quot;</span>] <span class="op">}</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb228-3" title="3">  <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;createdAt&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb228-4" title="4">  <span class="dt">attributes</span><span class="op">:</span> [<span class="st">&quot;message&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb228-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Let’s now go back to the client to set up a form for an authenticated user to create tweets!</p>
<h2 id="phase-6-seeing-tweets-with-authors-and-creating-tweets-from-the-client">Phase 6: Seeing tweets with authors and creating tweets from the client</h2>
<p>First, let’s update the <code>public/js/index.js</code> script to render the username on top of the message (hint: destructure the user from each tweet and then destructure the username <code>{ message, user: { username } }</code>).</p>
<p>Update the <code>tweetsHtml</code> to render a <code>username</code> as content within a <code>div.card-header</code> element. Make the <code>div.card-header</code> element a child of the <code>div.card</code> element. Feel free to make use fo the HTML snippet below:</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb229-1" title="1"><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;card-header&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb229-2" title="2">  ${username}</a>
<a class="sourceLine" id="cb229-3" title="3"><span class="kw">&lt;/div&gt;</span></a></code></pre></div>
<p>Next, let’s set up a <code>create</code> view for the user to create a tweet. First add the route in your <code>express-apis-frontend/index.js</code> file:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb230-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/create&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb230-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;create&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb230-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Then set up the associated <code>create.pug</code> template with the snippet below:</p>
<pre class="pug"><code>extends layout.pug

block content
  .errors-container
  form(class=&quot;create-form&quot;)
    .form-group
      label(for=&#39;message&#39;) Message
      input#message.form-control(type=&#39;message&#39;, name=&quot;message&quot;, placeholder=&#39;What do you want to tweet?&#39;)
    button.btn.btn-primary(type=&#39;submit&#39;) Tweet

  script(src=&quot;js/create.js&quot;)</code></pre>
<p>Before we implement the <code>public/js/create.js</code> script file, let’s update the <code>layout.pug</code> template to now also render a nav bar at the top of the application to allow users to easily navigate around:</p>
<pre class="pug"><code>doctype html
html
  head
    title Twitter Lite
    link(rel=&#39;stylesheet&#39; href=&#39;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css&#39; integrity=&#39;sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh&#39; crossorigin=&#39;anonymous&#39;)
    link(rel=&#39;stylesheet&#39; type=&#39;text/css&#39; href=&#39;/style.css&#39;)
  body
    nav.navbar.navbar-expand-lg.navbar-light.bg-light
      a.navbar-brand(href=&#39;/&#39;) Twitter Lite
      .navbar-nav
        a.nav-item.nav-link(href=&#39;/create&#39;) Create Tweet
        a.nav-item.nav-link(href=&#39;/profile&#39;) My Tweets
    block content</code></pre>
<p>Notice how there’s a link to a <code>/profile</code> route, which we will implement in the next phase. Now create the <code>public/js/create.js</code> file. In this file, begin by adding an event listener to the element with a class name of <code>create-form</code>. Remember to use <code>e.preventDefault()</code> within the event listener to prevent the form from sending a GET request upon submission. Then parse the form data:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb233-1" title="1"><span class="kw">const</span> form <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&quot;.create-form&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb233-2" title="2"></a>
<a class="sourceLine" id="cb233-3" title="3"><span class="va">form</span>.<span class="at">addEventListener</span>(<span class="st">&quot;submit&quot;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb233-4" title="4">  <span class="va">e</span>.<span class="at">preventDefault</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb233-5" title="5">  <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="at">FormData</span>(form)<span class="op">;</span></a>
<a class="sourceLine" id="cb233-6" title="6">  <span class="kw">const</span> message <span class="op">=</span> <span class="va">formData</span>.<span class="at">get</span>(<span class="st">&quot;message&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb233-7" title="7">  <span class="kw">const</span> body <span class="op">=</span> <span class="op">{</span> message <span class="op">};</span></a>
<a class="sourceLine" id="cb233-8" title="8"></a>
<a class="sourceLine" id="cb233-9" title="9">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Fetch tweets</span></a>
<a class="sourceLine" id="cb233-10" title="10">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Redirect users to login page upon a 401 error</span></a>
<a class="sourceLine" id="cb233-11" title="11">  <span class="co">// </span><span class="al">TODO</span><span class="co">: Handle errors</span></a>
<a class="sourceLine" id="cb233-12" title="12"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Within a <code>try</code> block, use the Fetch API to make a POST request to <code>http://localhost:8080/tweets</code> with the necessary <code>body</code> (formatted as a JSON string) and headers (<code>Content-Type</code> and <code>Authorization</code>). Upon a successful fetch request, remember to redirect the user to the home page by using the <code>window.location.href</code> property.</p>
<p>Now handle the following response and errors caught. If you receive a response with a status of <code>401</code>, redirect users to log-in page. Throw the response (<code>res</code>) for any other response statuses. If you catch an error with a status greater than or equal to <code>400</code> and less than <code>600</code>, parse your caught error as JSON and find your <code>errorsContainer</code> (element with a class of <code>errors-container</code>). Declare an array of error elements by using the <code>errorsHtml</code> snippet below:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb234-1" title="1"><span class="kw">let</span> errorsHtml <span class="op">=</span> [</a>
<a class="sourceLine" id="cb234-2" title="2">  <span class="vs">`</span></a>
<a class="sourceLine" id="cb234-3" title="3"><span class="vs">  &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb234-4" title="4"><span class="vs">      Something went wrong. Please try again.</span></a>
<a class="sourceLine" id="cb234-5" title="5"><span class="vs">  &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb234-6" title="6"><span class="vs">`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb234-7" title="7">]<span class="op">;</span></a></code></pre></div>
<p>Now destructure your <code>errors</code> array from your error parsed as JSON and verify if <code>errors</code> is a valid, truthy array. If <code>errors</code> is a valid array, map through each <code>message</code> in the array to generate an array of stringified error elements:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb235-1" title="1"><span class="kw">const</span> <span class="op">{</span> errors <span class="op">}</span> <span class="op">=</span> errorJSON<span class="op">;</span></a>
<a class="sourceLine" id="cb235-2" title="2"><span class="cf">if</span> (errors <span class="op">&amp;&amp;</span> <span class="va">Array</span>.<span class="at">isArray</span>(errors)) <span class="op">{</span></a>
<a class="sourceLine" id="cb235-3" title="3">  errorsHtml <span class="op">=</span> <span class="va">errors</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb235-4" title="4">    (message) <span class="kw">=&gt;</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb235-5" title="5"><span class="vs">    &lt;div class=&quot;alert alert-danger&quot;&gt;</span></a>
<a class="sourceLine" id="cb235-6" title="6"><span class="vs">        </span><span class="sc">${</span>message<span class="sc">}</span></a>
<a class="sourceLine" id="cb235-7" title="7"><span class="vs">    &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb235-8" title="8"><span class="vs">  `</span></a>
<a class="sourceLine" id="cb235-9" title="9">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb235-10" title="10"><span class="op">}</span></a></code></pre></div>
<p>Now join the elements within your <code>errorsHtml</code> array and set the joined array as the <code>innerHTML</code> of the <code>errorsContainer</code>. Lastly, use the <code>alert()</code> method to notify the end user with a generic error message.</p>
<h2 id="phase-7-set-up-the-profile-page">Phase 7: Set up the profile page</h2>
<p>In the profile page, a user should be able to see their own tweets. Up to this point we haven’t dealt with nested resources yet, but let’s go ahead and build out a route where tweets are nested under a user.</p>
<p>In the users router, add an endpoint for <code>localhost:8080/users/:id/tweets</code>. You’ll need to also import the Tweet model into this router. This route should await the database fetch of all tweets that belong to a specific user based on the <code>id</code> in the request <code>params</code>.</p>
<p>Make sure to import and your <code>requireAuth</code> middleware from the <code>../auth.js</code> file to keep your tweets <em>protected</em>. Also be sure to wrap the route handling function with your <code>asyncHandler</code> to be able to <code>await</code> the database fetch. Lastly, render the tweets in a JSON response.</p>
<p>Go to the client now and set up the profile page. Add the following route in the <code>express-apis-frontend/index.js</code> file to serve a <code>profile.pug</code> template:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb236-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/profile&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb236-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;profile&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb236-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Then set up the <code>profile.pug</code> template:</p>
<pre class="pug"><code>extends layout.pug
block content
  h2 Your Tweets
  .tweets-container
  script(src=&quot;js/profile.js&quot;)</code></pre>
<p>Finally, set up a script in the <code>public/js/profile.js</code> file to fetch all of the tweets that belong to the logged in user. Begin by adding a <code>DOMContentLoaded</code> event listener. Now remember that after a user logs in or signs up, the server gives the client the user’s id, which is stored in localStorage. Use that id to <code>try</code> to make a fetch request to the correct route (hint: interpolate the user’s id into the fetch path). Make sure to include an <code>Authorization</code> header that gets the <code>TWITTER_LITE_ACCESS_TOKEN</code> from localStorage.</p>
<p>Upon a response status of <code>401</code>, re-direct the user to the <code>/log-in</code> page by using the <code>window.location.href</code> property and <code>return</code> out of the event listener function.</p>
<p>Upon a successful fetch, parse the response as JSON and destructure the response <code>tweets</code>. Search for the <code>tweetsContainer</code> (element with a class name of <code>tweets-container</code>) and declare a <code>tweetsHtml</code> variable. Now map over the <code>tweets</code> from your fetch response to generate an array of stringified tweet elements and set the <code>tweetsHtml</code> variable:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb238-1" title="1"><span class="kw">const</span> tweetsHtml <span class="op">=</span> <span class="va">tweets</span>.<span class="at">map</span>(</a>
<a class="sourceLine" id="cb238-2" title="2">  (<span class="op">{</span> message<span class="op">,</span> id <span class="op">}</span>) <span class="kw">=&gt;</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb238-3" title="3"><span class="vs">  &lt;div class=&quot;card&quot; id=&quot;tweet-</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">&quot;&gt;</span></a>
<a class="sourceLine" id="cb238-4" title="4"><span class="vs">    &lt;div class=&quot;card-body&quot;&gt;</span></a>
<a class="sourceLine" id="cb238-5" title="5"><span class="vs">      &lt;p class=&quot;card-text&quot;&gt;</span><span class="sc">${</span>message<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></a>
<a class="sourceLine" id="cb238-6" title="6"><span class="vs">    &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb238-7" title="7"><span class="vs">  &lt;/div&gt;</span></a>
<a class="sourceLine" id="cb238-8" title="8"><span class="vs">`</span></a>
<a class="sourceLine" id="cb238-9" title="9">)<span class="op">;</span></a></code></pre></div>
<p>Make sure to join your stringified tweet elements to set the <code>innerHTML</code> of the <code>tweetsContainer</code>:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb239-1" title="1"><span class="va">tweetsContainer</span>.<span class="at">innerHTML</span> <span class="op">=</span> <span class="va">tweetsHtml</span>.<span class="at">join</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>Lastly, use <code>console.error()</code> to log any caught errors.</p>
<p>Nice work making it to this part of the project! In the next bonus phases, let’s add a little more functionality, improve the UX of the app, and then also clean up the code!</p>
<h2 id="bonus-phase-add-ability-to-delete-your-own-tweet">Bonus Phase: Add ability to delete your own tweet</h2>
<p>Let’s add the ability to delete your own tweets, while not allowing anyone else to delete them!</p>
<p>Update your <code>profile.js</code> script so that after you fetch your own tweets, each message can show a delete button. Then, after the HTML has been added to the DOM, select all of the delete buttons to add a click handler to each button. The click handler’s callback function should make a DELETE request to <code>http://localhost:8080/tweets/:id</code> in order to delete a tweet.</p>
<p>To add click handlers for each delete button, here’s what you might want to write at the bottom of your "DOMContentLoaded" event listener in the <code>profile.js</code> file:</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb240-1" title="1"><span class="kw">const</span> deleteButtons <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelectorAll</span>(<span class="st">&quot;.delete-button&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb240-2" title="2"><span class="cf">if</span> (deleteButtons) <span class="op">{</span></a>
<a class="sourceLine" id="cb240-3" title="3">  <span class="va">deleteButtons</span>.<span class="at">forEach</span>((button) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb240-4" title="4">    <span class="va">button</span>.<span class="at">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> <span class="at">handleDelete</span>(<span class="va">button</span>.<span class="at">id</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb240-5" title="5">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb240-6" title="6"><span class="op">}</span></a></code></pre></div>
<p>In the code snippet above, there’s a <code>handleDelete</code> callback function that’s not shown. Go ahead and implement the logic for that function!</p>
<p>Next, let’s add some logic so that only the author of a tweet can actually delete the tweet. Go to the endpoint for deleting tweets. How can you check whether or not the current user who’s making this request is actually authorized to delete this tweet?</p>
<p>Once you’ve tested that a tweet can only be deleted by its author in Postman, move on to the next bonus phase!</p>
<h2 id="bonus-phase-combine-create-and-index-views">Bonus Phase: Combine create and index views</h2>
<p>Let’s make it easier for users to create a tweet in the app. Right now, the whole process to create a tweet is a little cumbersome. Users have to navigate to a separate page for creating the tweet, and after it’s created, they’re then redirected back to another page to see the newly created.</p>
<p>Go ahead and move the create tweet form from <code>create.pug</code> to above the tweets container in <code>index.pug</code>. This will give the users the ability to create a tweet at the top of their timeline, which is an experience that’s more in line with what the real Twitter does.</p>
<p>In this view, when users create a tweet, go ahead and just re-fetch all of the tweets again. Be sure to keep your code DRY here by extracting the logic to fetch all tweets into its own function.</p>
<p>Also, since you are no longer redirecting users to a different page after a tweet is created make sure you are clearing out the create tweet form inputs upon a successful tweet creation.</p>
<p>As a reminder, since you no longer need a create tweet page, go ahead and delete those template and JavaScript files, and then remove the navigation route from <code>layout.pug</code>.</p>
<p>When you are done with this phase, you should have an index page that allows users to create a tweet and then see that newly created tweet without ever requiring a page reload. This type of experience is more in line with what users expect from modern web apps. You’ll dive deeper into how to build these types of modern frontends as you progress into the React curriculum soon!</p>
<h2 id="bonus-phase-es-modules">Bonus Phase: ES Modules</h2>
<p>Finally, let’s clean up some of the JavaScript code in the client app! Right now a lot of the error handling logic is being duplicated between the different files. DRY up your code with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript modules</a>.</p>
<p>You’ll need to declare <code>type="module"</code> in any script tags that load JavaScript files that use modules. Also, unlike the CommonJS module system (<code>require</code> and <code>module.exports</code>) that you’ve been using in your server-side JavaScript, you’ll need to use the ES module system (<code>import</code> and <code>export</code>) in client-side JavaScript.</p>
<p>In the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript modules</a> documentation, there’s a section that talks about how ES modules are not supported by all browsers. In the React curriculum, you’ll learn more about how to effectively handle client-side modules using build tools like <a href="https://webpack.js.org/">webpack</a>.</p>
<hr />
<h1 id="week-12-day-4-apis" data-ignore="true">WEEK-12 DAY-4<br><em>Apis</em></h1>
<hr />
<h1 id="api-security-learning-objectives">API Security Learning Objectives</h1>
<p>Once you have an API up and running, you need to secure it to ward off leaking sensitive data or allowing people to use it in an unauthorized way. To do so, you will introduce the concept of authentication and authorization, again, but with tools that help support the stateless nature of RESTful APIs. After your homework, lecture, and practice, you should be able to</p>
<ul>
<li>Explain the fundamental concepts of OAuth as a way to authenticate users</li>
<li>Describe the workflow of OAuth resource owner password credentials grant (RFC 6749 Section 4.3)</li>
<li>Describe the components of a JSON Web Token (JWT) and how it is constructed</li>
<li>Configure an Express application to use token-based authentication and authorization using OAuth resource owner password credentials grant</li>
</ul>
<hr />
<h1 id="oauth-2.0">OAuth 2.0</h1>
<p>As an application developer, your application sometimes needs to access your user’s information from a different web application.</p>
<p>For example, let’s say you’re working on a website called MyMint<span>.com</span>, a simple site that lets people with multiple bank accounts access all of their accounts in one centralized place. In this example, Johnny wants to use your web app because he has an account with Chase and Bank of America, and he’s tired of having to go back and forth between chase<span>.com</span> and bankofamerica<span>.com</span> in order to check his financial transactions.</p>
<p>So, Johnny signs up for MyMint<span>.com</span>, and you now need to be able to get Johnny’s transactions from chase<span>.com</span>.</p>
<p>In the past, one way for you to access that information might have been for Johnny to directly give your application his password, and then your web app would go to chase<span>.com</span> to authenticate and then fetch the transactions. This was clearly not ideal from a security point of view.</p>
<p>OAuth 2.0 is a standard that allows for you to access that information without Johnny giving you his passwords to his bank account logins. It is defined by <a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a> "The OAuth 2.0 Authorization Framework". OAuth 2.0 defines a very specific protocol for how your app (MyMint<span>.com</span>), Johnny, and chase<span>.com</span> should coordinate together so that you can securely get Johnny’s chase<span>.com</span> transactions.</p>
<p>This article will help you learn how to</p>
<ul>
<li>Get your application ready for OAuth 2.0</li>
<li>Teach you about how OAuth 2.0 works</li>
<li>Use OAuth 2.0 to authenticate (and authorize) a person for your application from a third-party authority</li>
</ul>
<h2 id="high-level-overview-of-oauth-2.0">High level overview of OAuth 2.0</h2>
<p>At a high level, there are six main steps to the OAuth 2.0 standard. Here is a high-level diagram from a <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">Digital Ocean overview</a> of OAuth 2.0:</p>
<figure>
<img src="images/abstract_flow.png" alt="High Level OAuth2 Flow" /><figcaption>High Level OAuth2 Flow</figcaption>
</figure>
<p>Here are the key players mentioned in the diagram above:</p>
<ol type="1">
<li><strong>Application</strong>- In our example, the application, or client, is the app that you’ve built– MyMint<span>.com</span>.</li>
<li><strong>User</strong>- The user in our example is Johnny. The user is also called the <strong>Resource Owner</strong> because he is the owner of the <strong>protected resource</strong>, which in our example is his financial transactions in chase<span>.com</span>. Other examples of resources that Johnny could have at chase<span>.com</span> would be his mortgage account information and his IRA information.</li>
<li><strong>Service API</strong> We can refer to chase<span>.com</span> in our example as the <strong>Service API</strong>. Notice that it’s broken down further into an <strong>Authorization Server</strong> and a <strong>Resource Server</strong>. The <strong>Authorization Server</strong> is solely responsible for authorizing the <strong>Application</strong> (MyMint<span>.com</span>). The <strong>Resource Server</strong> is where the <strong>protected resources</strong> (Johnny’s financial transactions) are actually stored and served.</li>
</ol>
<p>Now, let’s do a high-level walk through of the six steps above using our example. Each of these will be covered in more detail later in the article. However, it’s good to hold them in context as they’re discussed.</p>
<ol type="1">
<li><strong>Application requests authorization from user</strong>- Your app, MyMint<span>.com</span>, asks Johnny for authorization to access Johnny’s financial transactions from chase<span>.com</span>.</li>
<li><strong>User issues Authorization Grant to Application</strong>- Johnny authorizes the MyMint<span>.com</span>, and an Authorization Grant is issued to MyMint<span>.com</span>.</li>
<li><strong>Application uses the Authorization Grant</strong>- MyMint<span>.com</span> uses the Authorization Grant to request an access token from chase<span>.com</span>’s Authorization Server.</li>
<li><strong>Authorization Server issues access token to Application</strong>- chase<span>.com</span>’s Authorization Server checks the authorization grant and issues an access token to MyMint<span>.com</span>. From this point on, MyMint<span>.com</span> will use that access token to communicate with chase<span>.com</span>’s Resource Server.</li>
<li><strong>Access token is used</strong>- MyMint<span>.com</span> uses the access token to request Johnny’s financial transactions from chase<span>.com</span>’s Resource Server.</li>
<li><strong>Protected Resources are served</strong>- If chase<span>.com</span>’s Resource Server is presented with a valid access token, then it sends back the resources (Johnny’s financial transactions).</li>
</ol>
<h2 id="getting-your-app-ready-for-oauth-2.0">Getting your app ready for OAuth 2.0</h2>
<p>In the high-level overview above, it seems like Johnny gave MyMint<span>.com</span> permission to access chase<span>.com</span>’s resource, and chase<span>.com</span> just agreed to it. At this point, you might be wondering why chase<span>.com</span> would be willing to send MyMint<span>.com</span> protected resources. After all, how can chase<span>.com</span> trust that MyMint<span>.com</span> is actually a credible web application?</p>
<p>In reality, you would need to first register MyMint<span>.com</span> with chase<span>.com</span>’s API before you are able to start requesting resources from it.</p>
<p>Specifically, you would need to provide details about your website and supply a callback URL (more on this later). Once you are registered, chase<span>.com</span> will give you a set of credentials to use during the authorization process. The credentials include:</p>
<ol type="1">
<li><strong>client ID</strong>- public unique identifier for your web application</li>
<li><strong>client secret</strong>- a password that only your application and the API will know about. MyMint<span>.com</span> will use this when requesting resources from chase<span>.com</span>’s servers.</li>
</ol>
<h2 id="oauth-2.0-in-detail">OAuth 2.0 in detail</h2>
<p>Now that you have learned about OAuth 2.0 at a high level, as well as the prerequisites for getting your site ready for OAuth 2.0, let’s discuss each step in more detail.</p>
<h3 id="everything-over-https">Everything over HTTPS</h3>
<p>Note that all communication that occurs in the following sections occurs over HTTPS. This provides encrypted communications between the application and the service APIs. That way, no one can sniff the information as it goes by across the Internet, get the secret information being sent, and use it to maliciously impersonate Johnny, MyMint<span>.com</span>, or chase<span>.com</span>.</p>
<h3 id="application-requests-authorization-from-user">Application requests authorization from user</h3>
<p>Let’s imagine that Johnny is logged in to MyMint<span>.com</span> and now trying to add the ability to start viewing his Chase financial transactions. For simplicity’s sake, let’s suppose that your app, MyMint<span>.com</span>, has a link for Johnny to click when Johnny wants to add his Chase account to MyMint<span>.com</span>. This link would look something like this:</p>
<pre class="plaintext"><code>authorization.chase.com/?client_id=${MyMint_com_client_id}&amp;redirect_uri=${callback_url}</code></pre>
<p>Let’s break down the components of the URL above:</p>
<ol type="1">
<li>authorization.chase<span>.com</span>- This URL is an example of what chase’s authorization endpoint might look like.</li>
<li><code>client_id=${MyMint_com_client_id}</code>- This is MyMint<span>.com</span>’s unique ID that was provided when you registered MyMint<span>.com</span> with chase<span>.com</span>’s API services. chase<span>.com</span> uses this to identify your app.</li>
<li><code>redirect_uri=${callback_url}</code>- During the registration process, you also provided a <code>callback_url</code>, which is the URL that you want chase<span>.com</span> to redirect Johnny to after Johnny authorizes chase<span>.com</span> to send MyMint<span>.com</span> resources. <strong>For the purposes of our example, let’s assume that you decided to use <code>https://mymint&lt;span&gt;.com&lt;/span&gt;/callback-time</code> as your app’s callback URL</strong>.</li>
</ol>
<h3 id="user-issues-authorization-grant">User issues authorization grant</h3>
<p>Once Johnny clicks on this link, Johnny would be directed to chase<span>.com</span>’s authorization page, where he logs in directly to chase<span>.com</span> by providing his Chase username and password. Once Johnny has logged in to his chase<span>.com</span> account, chase<span>.com</span> will ask Johnny whether or not he actually wants to authorize MyMint<span>.com</span> to access his Chase financial transactions data.</p>
<p>If Johnny authorizes MyMint<span>.com</span>, then Chase will issue an Authorization Grant to MyMint<span>.com</span>.</p>
<p>There are actually multiple forms of an <strong>authorization grant</strong>. For this example, the type of authorization grant that we will focus on is the <strong>authorization code</strong>. chase<span>.com</span> will send an authorization code to MyMint<span>.com</span> so that MyMint<span>.com</span> can authenticate itself. chase<span>.com</span> sends this code when it redirects the user back to the callback URL that you provided. That redirect URL for Johnny would look something like this:</p>
<pre class="plaintext"><code>https://mymint.com/callback-time?code=dlsie239084903j4092j340j</code></pre>
<p>That random string of characters, "dlsie239084903j4092j340j", that’s the authorization code that chase<span>.com</span> sends to your application. These types of codes are usually only valid for a short period of time. That greatly reduces the chances of a bad actor from being able to guess a valid authentication code.</p>
<p>Note that because he is interacting directly with chase<span>.com</span>, at no point in time would Johnny ever provide his chase<span>.com</span> credentials to your app, MyMint<span>.com</span>.</p>
<h3 id="application-uses-the-authorization-grant">Application uses the authorization grant</h3>
<p>Now that MyMint<span>.com</span> has received an authorization code, it’s ready to authenticate itself with chase<span>.com</span> so that it can start receiving Johnny’s financial transaction data.</p>
<p>To do this, MyMint<span>.com</span> will send a POST request to chase<span>.com</span>’s auth server using the recently provided authorization code. That post request might look something like this:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb243-1" title="1"><span class="kw">const</span> fetch <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;node-fetch&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb243-2" title="2"><span class="kw">const</span> qs <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;querystring&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb243-3" title="3"></a>
<a class="sourceLine" id="cb243-4" title="4"><span class="kw">const</span> options <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb243-5" title="5">  <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb243-6" title="6">  <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span><span class="st">&#39;content-type&#39;</span><span class="op">:</span> <span class="st">&#39;application/x-www-form-urlencoded&#39;</span><span class="op">},</span></a>
<a class="sourceLine" id="cb243-7" title="7">  <span class="dt">body</span><span class="op">:</span> <span class="va">qs</span>.<span class="at">stringify</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb243-8" title="8">    <span class="dt">grant_type</span><span class="op">:</span> <span class="st">&#39;authorization_code&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb243-9" title="9">    <span class="dt">client_id</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span><span class="va">mymint</span>.<span class="at">com_client_id</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb243-10" title="10">    <span class="dt">client_secret</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span><span class="va">mymint</span>.<span class="at">com_client_secret</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb243-11" title="11">    <span class="dt">code</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>authorization_code<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb243-12" title="12">    <span class="dt">redirect_uri</span><span class="op">:</span> <span class="st">&#39;https://mintmint.com/callback-time&#39;</span> <span class="co">// same callback_url you provided</span></a>
<a class="sourceLine" id="cb243-13" title="13">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb243-14" title="14"><span class="op">};</span></a>
<a class="sourceLine" id="cb243-15" title="15"><span class="kw">const</span> url <span class="op">=</span> <span class="st">&#39;https://authorization.chase.com/oauth/token&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb243-16" title="16"><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(url<span class="op">,</span> options)<span class="op">;</span></a>
<a class="sourceLine" id="cb243-17" title="17"><span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="va">response</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb243-18" title="18"><span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></a></code></pre></div>
<p>Note that in the POST request above, you provided the <code>client_id</code>, <code>client_secret</code> and <code>authorization_code</code>.</p>
<h3 id="authorization-server-issues-an-access-token">Authorization server issues an access token</h3>
<p>If everything is valid, then chase<span>.com</span>’s auth server will send back a response that contains the access token. That response might look like this:</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb244-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb244-2" title="2">  <span class="dt">&quot;access_token&quot;</span><span class="fu">:</span> <span class="st">&quot;eyJz93ak4laUWw&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb244-3" title="3">  <span class="dt">&quot;refresh_token&quot;</span><span class="fu">:</span> <span class="st">&quot;GEbRxBNedjnXbL&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb244-4" title="4">  <span class="dt">&quot;id_token&quot;</span><span class="fu">:</span> <span class="st">&quot;eyJ0XAi4faeEoQ&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb244-5" title="5">  <span class="dt">&quot;token_type&quot;</span><span class="fu">:</span> <span class="st">&quot;Bearer&quot;</span></a>
<a class="sourceLine" id="cb244-6" title="6"><span class="fu">}</span></a></code></pre></div>
<p>MyMint<span>.com</span> is now authorized! Now, whenever MyMint<span>.com</span> wants to request Johnny’s transaction data, it would send along the <code>access_token</code> with each request.</p>
<h3 id="access-token-is-used">Access token is used</h3>
<p>From this point forward, the request for Johnny’s transaction data would be made to chase<span>.com</span>’s resource servers. Here’s an example of what that request might look like:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb245-1" title="1"><span class="kw">var</span> request <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;node-fetch&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb245-2" title="2"></a>
<a class="sourceLine" id="cb245-3" title="3"><span class="kw">const</span> url <span class="op">=</span> <span class="st">&#39;https://resources.chase.com/api/johnny/transactions&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb245-4" title="4"><span class="kw">const</span> options <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb245-5" title="5">  <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb245-6" title="6">    <span class="st">&#39;content-type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb245-7" title="7">    <span class="st">&#39;authorization&#39;</span><span class="op">:</span> <span class="vs">`Bearer </span><span class="sc">${</span>access_token<span class="sc">}</span><span class="vs">`</span></a>
<a class="sourceLine" id="cb245-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb245-9" title="9"><span class="op">};</span></a>
<a class="sourceLine" id="cb245-10" title="10"></a>
<a class="sourceLine" id="cb245-11" title="11"><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="at">fetch</span>(url<span class="op">,</span> options)<span class="op">;</span></a>
<a class="sourceLine" id="cb245-12" title="12"><span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="va">response</span>.<span class="at">json</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb245-13" title="13"><span class="va">console</span>.<span class="at">log</span>(data)<span class="op">;</span></a></code></pre></div>
<h3 id="protected-resources-are-served">Protected resources are served</h3>
<p>If the access_token is valid, then chase<span>.com</span> will send back the requested resources, which in this case is Johnny’s financial transaction data.</p>
<h2 id="what-you-learned-1">What you learned</h2>
<p>During this article, you learned about OAuth 2.0 and the interaction between your application and a server that can authenticate and authorize people’s credentials. You saw that there is a six-step process to this interplay over HTTPS:</p>
<ol type="1">
<li>Your application requests authorization from the person</li>
<li>The person informs the authorization server that they want to issue an authorization grant for your application</li>
<li>The application uses the authorization grant with its secret information to request an access token</li>
<li>The authorization server returns an access token</li>
<li>Your application uses the access token to gain access to the user’s data from the service API</li>
<li>The service API returns the resource that the token allows access to</li>
</ol>
<hr />
<h1 id="token-based-authentication">Token-Based Authentication</h1>
<p>Up until now, you’ve been building out a todo-list API that only dealt with tasks. A todo-list app without users is not very useful, so let add some users!</p>
<p>In particular, let’s set up users and a way of authenticating users so that there is an accurate way of keeping track of who tasks belong to.</p>
<p>In this lesson, you will:</p>
<ol type="1">
<li>Understand what a JSON Web Token (JWT) is and how it can be used to securely send user information between servers or across requests.</li>
<li>Add token-based (session-less) authentication to an Express API.</li>
<li>Use the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> npm package to sign and verify JWTs.</li>
</ol>
<h2 id="json-web-token-jwt">JSON Web Token (JWT)</h2>
<p>In a previous lesson, you learned about session-based authentication. With session-based authentication, when a user logs in, the server stores information about the session and sends back a session id to the client as a cookie. When the user makes a subsequent request, the cookie is presented and checked against the session data that’s stored on the server side. To emphasize, with session-based authentication, data is stored on the server to keep track of sessions.</p>
<p>This presents an issue when it comes to building a RESTful API. Specifically, one of the constraints of REST is statelessness. As a reminder, the term stateless means that the data received from the server can be used by the client independently. Under the statelessness constraint, every request from the client should contain all necessary information for the server to process that request, and the server should not be storing any data about the client state.</p>
<p>What we need here is a way to identify that the user is logged in without requiring the server to store anything. JSON Web Tokens (JWTs) are perfect for these situations.</p>
<h3 id="conceptual-overview-of-a-jwt-an-example">Conceptual overview of a JWT: an example</h3>
<p>So what is a JWT? Let’s first gain some conceptual understanding with an example.</p>
<p>Let’s say you’re throwing a party. It’s a gonna be a big party, and everyone wants to come, but unfortunately only people you send an invite to are allowed to come.</p>
<p>You prepare to start sending out invites, and you need to figure out a way to make sure only your invited guests are allowed into the party. One way would be to just keep a guest list, but you don’t want to have to maintain a guest list.</p>
<p>So, you devise a genius way to send out tamper-proof invites. This invitation method requires:</p>
<ol type="1">
<li><strong>the guest’s email address</strong>: This is effectively a unique identifier for your guests, so for example let’s say you want to invite your friend Johnny Rocket, whose email address is <code>johnny@gmail.com</code>.</li>
<li><strong>secret key/password that only you know</strong>: This is the only thing that you have to store on your end. You decide that your secret password will be "ILoveDogs".</li>
<li><strong><a href="https://developer.mozilla.org/en-US/docs/Glossary/Cryptographic_hash_function">a hashing function</a></strong>: A hashing function is something that will take your guest’s email and your secret password as inputs and then output a specific string digest. Keep in mind, the same input email and secret password will always produce the same output string digest. A key feature of a good hashing function is that it is not invertible. In other words, there should be no way to figure out what the inputs were based on the output string digest other than just trying to brute force your way into it.</li>
</ol>
<blockquote>
<p>Some popular hashing functions are: SHA1, MD5, SHA2, Scrypt, HS256, and Blowfish. In the first part of this article, you’ll see screenshot demos that use the SHA1 hashing function. When you set up the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> library in this reading’s project, you’ll be using the HS256 hashing function (default algorithm of the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> library). Whenever you use BCrypt for encryption in your projects, you will use Blowfish, as it is the default hashing function used with BCrypt.</p>
</blockquote>
<p>Here’s what you do (feel free to <a href="https://www.freeformatter.com/hmac-generator.html">follow along</a>). First, you take the guest’s email address (<code>johnny@gmail.com</code>) and your secret password that nobody else knows (<code>ILoveDogs</code>), and you hash these two inputs with a SHA1 hashing function, which produces a string digest of <code>a94a45d3d125a25ef69775ff702406a8848633c3</code>:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/hash1.png" alt="hash" /><figcaption>hash</figcaption>
</figure>
<p>You then send an email to Johnny:</p>
<pre class="plaintext"><code>
Dear Johnny,

My party is this Friday. Present this code at the door:

&quot;johnny@gmail.com/a94a45d3d125a25ef69775ff702406a8848633c3&quot;
</code></pre>
<p>Now, when Johnny shows up at your party on Friday, he presents you with <code>johnny@gmail.com/a94a45d3d125a25ef69775ff702406a8848633c3</code>. You take the first part of the code that he presents, which is his email, and hash it again with your secret password. You then compare the output against the second part of the code, the string digest, that Johnny presents you with. If it’s the same, then you know the invite is valid and hasn’t been tampered with because the string digest couldn’t have been generated without your secret key.</p>
<p>You have a frenemy named Leroy who didn’t get invited. He’s friends with Johnny Rocket, so he asks Johnny for the string digest, figuring that’s the secret code that everyone needs to present to get in. Leroy shows up at your door and presents his own version of the code, which is just his email plus the digest that Johnny got: <code>leroy@gmail.com/a94a45d3d125a25ef69775ff702406a8848633c3</code>.</p>
<p>So you run <code>leroy@gmail.com</code> + <code>ILoveDogs</code> through your hashing function:</p>
<figure>
<img src="images/hash2.png" alt="second hash" /><figcaption>second hash</figcaption>
</figure>
<p>Immediately, you know that Leroy has an invalid invite because the string digest output of the hashing function (<code>9ca5168290df6b05951af368d668ada58a56b12a</code>) was different than the one he presented.</p>
<p>This concept of validating a "code" against the hashed output of a value and a secret password is essentially how a JSON Web Token (JWT) works.</p>
<h3 id="anatomy-of-a-jwt">Anatomy of a JWT</h3>
<p>JSON Web Token is actually an internet standard that defines how to create JSON-based access tokens.</p>
<p>A JWT is composed of three parts: the header, the payload, and the signature.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/jwt.png" alt="anatomy of a JWT" /><figcaption>anatomy of a JWT</figcaption>
</figure>
<p>If you look at the left side of the image above, you can see the typical format of a JWT. The three parts of the JWT are separated by a period. Although the JWT might seem super cryptic, the first two parts are simply <a href="https://developer.mozilla.org/en-US/docs/Glossary/Base64">base64 encoded</a>. The right side shows the base64 decoded version of the first two parts of the JWT. To clarify, base64 encoding is not an encryption mechanism. Therefore, a JWT is not encrypted by default and anyone who gains access to the token can see the contents of the payload.</p>
<p>The header describes the hashing algorithm that the JWT uses. The payload is the data being stored in the token. The signature is a hash of the header + the payload + a secret key.</p>
<p>To tie it back into our previous example, if you were to follow the JWT standard for your party invite to Johnny Rocket, it might have looked something like this:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb247-1" title="1"><span class="er">base64Encode(</span><span class="fu">{</span> <span class="dt">&quot;typ&quot;</span><span class="fu">:</span> <span class="st">&quot;JWT&quot;</span><span class="fu">,</span> <span class="dt">&quot;alg&quot;</span><span class="fu">:</span> <span class="st">&quot;SHA1&quot;</span> <span class="fu">}</span><span class="er">)</span> <span class="er">//</span> <span class="er">header</span></a>
<a class="sourceLine" id="cb247-2" title="2">  <span class="er">.base64Encode(</span><span class="fu">{</span> <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;johnny@gmail.com&quot;</span> <span class="fu">}</span><span class="er">)</span> <span class="er">//</span> <span class="er">payload</span></a>
<a class="sourceLine" id="cb247-3" title="3">  <span class="er">.SHA1HASH(header</span> <span class="er">+</span> <span class="er">payload</span> <span class="er">+</span> <span class="er">&quot;ILoveDogs&quot;)</span> <span class="er">//</span> <span class="er">signature</span></a></code></pre></div>
<p>Ultimately, you can use a JWT to identify that someone is logged in because you can store identifying information in the payload, and you can also verify the validity of the information. In contrast to sessions, which required storing data on the server-side, a JWT has all of the information you need.</p>
<h2 id="setting-up-token-based-authentication">Setting up token-based authentication</h2>
<p>Now that you know what a JWT is, let’s implement a token-based authentication flow in the todo-list app that we’ve been working through in the last few readings.</p>
<h3 id="create-the-users-table">Create the Users table</h3>
<p>First, create a migration to create the Users table by running: <code>npx sequelize model:generate --name User --attributes email:string,hashedPassword:string</code></p>
<p>This should create a new <code>db/migrations/[timestamp]-create-user.js</code> migration file and a new <code>db/models/user.js</code> file.</p>
<p>Update the <code>db/models/user.js</code> file so that the <code>email</code> is unique and not nullable and the <code>hashedPassword</code> is type <code>STRING.BINARY</code> and not nullable. When you’re done updating the model file, it should look something like this.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb248-1" title="1"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb248-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb248-3" title="3">  <span class="kw">const</span> User <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(</a>
<a class="sourceLine" id="cb248-4" title="4">    <span class="st">&quot;User&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb248-5" title="5">    <span class="op">{</span></a>
<a class="sourceLine" id="cb248-6" title="6">      <span class="dt">email</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb248-7" title="7">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb248-8" title="8">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb248-9" title="9">        <span class="dt">unique</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb248-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb248-11" title="11">      <span class="dt">hashedPassword</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb248-12" title="12">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="va">STRING</span>.<span class="at">BINARY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb248-13" title="13">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb248-14" title="14">      <span class="op">},</span></a>
<a class="sourceLine" id="cb248-15" title="15">    <span class="op">},</span></a>
<a class="sourceLine" id="cb248-16" title="16">    <span class="op">{}</span></a>
<a class="sourceLine" id="cb248-17" title="17">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb248-18" title="18">  <span class="va">User</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span> (models) <span class="op">{</span></a>
<a class="sourceLine" id="cb248-19" title="19">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb248-20" title="20">  <span class="op">};</span></a>
<a class="sourceLine" id="cb248-21" title="21">  <span class="cf">return</span> User<span class="op">;</span></a>
<a class="sourceLine" id="cb248-22" title="22"><span class="op">};</span></a></code></pre></div>
<p>Then, update the <code>db/migrations/[timestamp]-create-user.js</code> file so that the fields and its properties matches the User model:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb249-1" title="1"><span class="st">&quot;use strict&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb249-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-3" title="3">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&quot;Users&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-5" title="5">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-6" title="6">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-7" title="7">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-8" title="8">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-9" title="9">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb249-11" title="11">      <span class="dt">email</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-12" title="12">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-13" title="13">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-14" title="14">        <span class="dt">unique</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb249-16" title="16">      <span class="dt">hashedPassword</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-17" title="17">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="va">STRING</span>.<span class="at">BINARY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-18" title="18">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-19" title="19">      <span class="op">},</span></a>
<a class="sourceLine" id="cb249-20" title="20">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-21" title="21">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-22" title="22">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-23" title="23">      <span class="op">},</span></a>
<a class="sourceLine" id="cb249-24" title="24">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-25" title="25">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-26" title="26">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb249-27" title="27">      <span class="op">},</span></a>
<a class="sourceLine" id="cb249-28" title="28">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb249-29" title="29">  <span class="op">},</span></a>
<a class="sourceLine" id="cb249-30" title="30">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb249-31" title="31">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&quot;Users&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb249-32" title="32">  <span class="op">},</span></a>
<a class="sourceLine" id="cb249-33" title="33"><span class="op">};</span></a></code></pre></div>
<p>Run <code>npx dotenv sequelize db:migrate</code>. Verify that you now have a <code>Users</code> table with the correct columns in Postbird.</p>
<h3 id="users-router">Users router</h3>
<p>Next, create a new router for users at <code>routes/users.js</code>. In the users router, you’ll need the <code>asyncHandler</code> and <code>handleValidationErrors</code> functions that are currently defined in <code>routes/tasks.js</code>. Go ahead and start a new <code>utils.js</code> file at the directory root, and move the <code>asyncHandler</code> function and <code>handleValidationErrors</code> function from <code>routes/tasks.js</code> into <code>utils.js</code>. This is what your <code>utils.js</code> file should look like:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb250-1" title="1"><span class="kw">const</span> <span class="op">{</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express-validator&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb250-2" title="2"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span></a>
<a class="sourceLine" id="cb250-3" title="3">  <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb250-4" title="4"></a>
<a class="sourceLine" id="cb250-5" title="5"><span class="kw">const</span> handleValidationErrors <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb250-6" title="6">  <span class="kw">const</span> validationErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb250-7" title="7"></a>
<a class="sourceLine" id="cb250-8" title="8">  <span class="co">// If the validation errors are empty,</span></a>
<a class="sourceLine" id="cb250-9" title="9">  <span class="cf">if</span> (<span class="op">!</span><span class="va">validationErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb250-10" title="10">    <span class="co">// Generate an array of error messages</span></a>
<a class="sourceLine" id="cb250-11" title="11">    <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validationErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb250-12" title="12"></a>
<a class="sourceLine" id="cb250-13" title="13">    <span class="co">// Generate a new `400 Bad request.` Error object</span></a>
<a class="sourceLine" id="cb250-14" title="14">    <span class="co">// and invoke the next function passing in `err`</span></a>
<a class="sourceLine" id="cb250-15" title="15">    <span class="co">// to pass control to the global error handler.</span></a>
<a class="sourceLine" id="cb250-16" title="16">    <span class="kw">const</span> err <span class="op">=</span> <span class="at">Error</span>(<span class="st">&quot;Bad request.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb250-17" title="17">    <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">400</span><span class="op">;</span></a>
<a class="sourceLine" id="cb250-18" title="18">    <span class="va">err</span>.<span class="at">title</span> <span class="op">=</span> <span class="st">&quot;Bad request.&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb250-19" title="19">    <span class="va">err</span>.<span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></a>
<a class="sourceLine" id="cb250-20" title="20">    <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb250-21" title="21">  <span class="op">}</span></a>
<a class="sourceLine" id="cb250-22" title="22"></a>
<a class="sourceLine" id="cb250-23" title="23">  <span class="co">// Invoke the next middleware function</span></a>
<a class="sourceLine" id="cb250-24" title="24">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb250-25" title="25"><span class="op">};</span></a>
<a class="sourceLine" id="cb250-26" title="26"></a>
<a class="sourceLine" id="cb250-27" title="27"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span> asyncHandler<span class="op">,</span> handleValidationErrors <span class="op">};</span></a></code></pre></div>
<p>In <code>routes/task.js</code>, be sure to remove the original <code>asyncHandler</code> and <code>handleValidationErros</code> function definitions, and instead import them now from <code>utils.js</code>:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb251-1" title="1"><span class="co">//- ./routes/tasks.js</span></a>
<a class="sourceLine" id="cb251-2" title="2"></a>
<a class="sourceLine" id="cb251-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb251-4" title="4"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../db/models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb251-5" title="5"><span class="kw">const</span> <span class="op">{</span> check <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express-validator&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb251-6" title="6"><span class="kw">const</span> <span class="op">{</span> asyncHandler<span class="op">,</span> handleValidationErrors <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../utils&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb251-7" title="7"></a>
<a class="sourceLine" id="cb251-8" title="8"><span class="co">// REST OF FILE NOT SHOWN</span></a></code></pre></div>
<p>Now that you’re done with the refactor, let’s build out the users router!</p>
<p>To start, create a <code>routes/users.js</code> file to hold your users router. Go ahead and declare an express router and export it:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb252-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb252-2" title="2"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb252-3" title="3"></a>
<a class="sourceLine" id="cb252-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Then, add this users router in your <code>app.js</code> file:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb253-1" title="1"><span class="co">// only new code shown:</span></a>
<a class="sourceLine" id="cb253-2" title="2"></a>
<a class="sourceLine" id="cb253-3" title="3"><span class="kw">const</span> usersRouter <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./routes/users&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb253-4" title="4"></a>
<a class="sourceLine" id="cb253-5" title="5"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&quot;/users&quot;</span><span class="op">,</span> usersRouter)<span class="op">;</span></a></code></pre></div>
<p>As a refresher, now all requests to a path that start with ‘/users’ will be routed to the <code>usersRouter</code>.</p>
<p>Back in the users router, let’s set up a route for creating users. There are a couple of things you’ll need to set up. First, set up a router to handle POST requests to http://localhost:8080/users. Since this route handler will interact asynchronously with the database, you’ll need to wrap the route handler function in the <code>asyncHandler</code> function:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb254-1" title="1"><span class="kw">const</span> <span class="op">{</span> asyncHandler <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../utils&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb254-2" title="2"></a>
<a class="sourceLine" id="cb254-3" title="3"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="at">asyncHandler</span>((req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-4" title="4"><span class="co">// </span><span class="al">TODO</span><span class="co">: implement creation of user</span></a>
<a class="sourceLine" id="cb254-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb254-6" title="6"></a>
<a class="sourceLine" id="cb254-7" title="7"><span class="co">// REST OF FILE NOT SHOWN</span></a></code></pre></div>
<p>Then, you’ll also need to add some route-level validations to ensure that the client is passing in a valid email and password. Just like you did in the the tasks router, go ahead and use the <code>express-validator</code> library’s <code>check</code> function to define a series of middleware functions that will check the <code>email</code> and <code>password</code> params.</p>
<p>Go ahead and define these validation middleware functions inside of a <code>validateEmailAndPassword</code> array. In a later section, you’ll be implementing a "log in" route that will require the same <code>email</code> and <code>password</code> validations, so this array of validations can be reused for that route!</p>
<p>Here are a few things you should check for:</p>
<ol type="1">
<li>check that <code>email</code> is a truthy value (i.e. not <code>undefined</code>, <code>null</code>, or an empty string)</li>
<li>check that <code>email</code> is a valid email.</li>
<li>check that <code>password</code> is a truthy value.</li>
</ol>
<p>Feel free to add more validations, like ensuring that the password has a digit in it, but make sure that you at least have the following validations:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb255-1" title="1"><span class="kw">const</span> validateEmailAndPassword <span class="op">=</span> [</a>
<a class="sourceLine" id="cb255-2" title="2">  <span class="at">check</span>(<span class="st">&quot;email&quot;</span>)</a>
<a class="sourceLine" id="cb255-3" title="3">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb255-4" title="4">    .<span class="at">isEmail</span>()</a>
<a class="sourceLine" id="cb255-5" title="5">    .<span class="at">withMessage</span>(<span class="st">&quot;Please provide a valid email.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb255-6" title="6">  <span class="at">check</span>(<span class="st">&quot;password&quot;</span>)</a>
<a class="sourceLine" id="cb255-7" title="7">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb255-8" title="8">    .<span class="at">withMessage</span>(<span class="st">&quot;Please provide a password.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb255-9" title="9">]<span class="op">;</span></a></code></pre></div>
<p>Back in the tasks router, you used the <code>handleValidationErrors</code> function to handle any validation errors that <code>express-validator</code> found. Import that <code>handleValidationErrors</code> function from the <code>utils.js</code> file now so that you can also handle validation errors in the users router. You have a couple of options here on how to set this up. You can either pass in both <code>validateEmailAndPassword</code> and <code>handleValidationErrors</code> as middleware functions in <code>router.post("/")</code> (like you did in the tasks router), or you could simply add <code>handleValidationErrors</code> as the last entry in <code>validateEmailAndPassword</code>:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb256-1" title="1"><span class="kw">const</span> validateEmailAndPassword <span class="op">=</span> [</a>
<a class="sourceLine" id="cb256-2" title="2">  <span class="at">check</span>(<span class="st">&quot;email&quot;</span>)</a>
<a class="sourceLine" id="cb256-3" title="3">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb256-4" title="4">    .<span class="at">isEmail</span>()</a>
<a class="sourceLine" id="cb256-5" title="5">    .<span class="at">withMessage</span>(<span class="st">&quot;Please provide a valid email.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb256-6" title="6">  <span class="at">check</span>(<span class="st">&quot;password&quot;</span>)</a>
<a class="sourceLine" id="cb256-7" title="7">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb256-8" title="8">    .<span class="at">withMessage</span>(<span class="st">&quot;Please provide a password.&quot;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb256-9" title="9">  handleValidationErrors<span class="op">,</span></a>
<a class="sourceLine" id="cb256-10" title="10">]<span class="op">;</span></a></code></pre></div>
<p>Regardless of which option you choose, go ahead and add those validations to <code>router.post("/")</code>:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb257-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb257-2" title="2">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb257-3" title="3">  validateEmailAndPassword<span class="op">,</span></a>
<a class="sourceLine" id="cb257-4" title="4">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb257-5" title="5">    <span class="co">// </span><span class="al">TODO</span><span class="co">: handle user creation</span></a>
<a class="sourceLine" id="cb257-6" title="6">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb257-7" title="7">)<span class="op">;</span></a></code></pre></div>
<p>Now that validations are taken care of, let’s actually implement the user creation!</p>
<p>The first part of creating a user will be fairly similar to what you were doing back in the session-based authentication lesson. You want to hash the password so that you can store it in the <code>hashedPassword</code> column, and you’ll be using the <a href="https://www.npmjs.com/package/bcryptjs">bcryptjs</a> library again to do the hashing. Go ahead and run <code>npm install bcryptjs</code>.</p>
<p>Then, use the library to hash your password before using the <code>User</code> model to create your new user:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb258-1" title="1"><span class="kw">const</span> bcrypt <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;bcryptjs&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb258-2" title="2"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../db/models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb258-3" title="3"></a>
<a class="sourceLine" id="cb258-4" title="4"><span class="kw">const</span> <span class="op">{</span> User <span class="op">}</span> <span class="op">=</span> db<span class="op">;</span></a>
<a class="sourceLine" id="cb258-5" title="5"></a>
<a class="sourceLine" id="cb258-6" title="6"><span class="co">// REST OF FILE IN BETWEEN NOT SHOWN</span></a>
<a class="sourceLine" id="cb258-7" title="7"></a>
<a class="sourceLine" id="cb258-8" title="8"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb258-9" title="9">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb258-10" title="10">  validateEmailAndPassword<span class="op">,</span></a>
<a class="sourceLine" id="cb258-11" title="11">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb258-12" title="12">    <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb258-13" title="13">    <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb258-14" title="14"></a>
<a class="sourceLine" id="cb258-15" title="15">    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> email<span class="op">,</span> hashedPassword <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb258-16" title="16"></a>
<a class="sourceLine" id="cb258-17" title="17">    <span class="co">// </span><span class="al">TODO</span><span class="co">: implement rest of route handler</span></a>
<a class="sourceLine" id="cb258-18" title="18">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb258-19" title="19">)<span class="op">;</span></a></code></pre></div>
<p>At this point, you’ve set up a route that creates a user. The next section will cover how to generate an access token for the user so that the user can be "logged in" for subsequent requests.</p>
<h3 id="generate-an-access-token-for-the-client">Generate an access token for the client</h3>
<p>Let’s finish up the rest of the route handler for <code>router.post("/")</code> in the users router!</p>
<p>Back in the previous lesson when you were implementing session-based authentication, you "logged in" a user by storing the new user’s id in session and then storing the session id as a cookie on the client side.</p>
<p>With token-based authentication, you’ll now instead generate an access token that holds identifying information in its payload, such as user id and email. Then, you’ll return this token to the client, and the client will include this token in all subsequent requests.</p>
<p>The access token will be a JWT, and you’ll use the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> package to handle JWT generation and decoding. Go ahead and run <code>npm install jsonwebtoken</code>.</p>
<p>Here’s the game plan for generating this token:</p>
<ol type="1">
<li>First, let’s add all of the components that are necessary for generating a JWT.</li>
<li>Then, let’s set up a new <code>auth.js</code> file that will have a set of utility functions that handles authentication-related logic.</li>
</ol>
<p>Let’s start with adding all the components that are necessary for generating a JWT!</p>
<p>As a refresher, a JWT has three parts: the header, the payload, and the signature.</p>
<p>The header describes the algorithm that will be used for hashing. By default the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> library uses the <code>HS256</code> algorithm by default.</p>
<p>The payload holds identifying information about the user. You’ll be storing the user id and email in the payload. There’s one more piece that’s necessary in the payload. Specifically, you probably don’t want a JWT to be valid forever, as this would increase the risk of your application’s security being compromised.</p>
<p>Instead, you want to expire these tokens after a certain amount of time. To do this, you can pass an <code>expiresIn</code> option to the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> token generation method. That method will take care of then including a field in the payload that notates how long the token is valid for. Then, when the JWT is later being decoded, that expiration timestamp can be checked to determine whether or not the token is still valid.</p>
<p>Finally, the third part of the JWT is the signature. The signature is the output of hashing the header, the payload, and the secret key, so you’ll need to set up a secret key.</p>
<p>To recap, there are two components you need to set up: a secret key and the duration that a JWT should be valid for.</p>
<p>Let’s store both of those components in environment variables.</p>
<p>To do this, first generate a secret key by opening up a node repl in your terminal (run <code>node</code>). In the node repl, use the built-in <code>crypto</code> module to generate a random string by running the following:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb259-1" title="1"><span class="at">require</span>(<span class="st">&quot;crypto&quot;</span>).<span class="at">randomBytes</span>(<span class="dv">32</span>).<span class="at">toString</span>(<span class="st">&quot;hex&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>Then add the following fields to your <code>.env</code>:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode yml"><code class="sourceCode yaml"><a class="sourceLine" id="cb260-1" title="1">JWT_SECRET=&lt;&lt;YOUR GENERATED RANDOM STRING&gt;&gt;</a>
<a class="sourceLine" id="cb260-2" title="2">JWT_EXPIRES_IN=604800</a></code></pre></div>
<p>"604800" was set as the <code>JWT_EXPIRES_IN</code> value because there are 604800 seconds in a week.</p>
<p>Next, set up your ‘config/index.js’ so that those newly added environment variables are accessible in your app:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb261-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb261-2" title="2">  <span class="dt">environment</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">||</span> <span class="st">&quot;development&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-3" title="3">  <span class="dt">port</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-4" title="4">  <span class="dt">db</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb261-5" title="5">    <span class="dt">username</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_USERNAME</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-6" title="6">    <span class="dt">password</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_PASSWORD</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-7" title="7">    <span class="dt">database</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_DATABASE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-8" title="8">    <span class="dt">host</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_HOST</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb261-10" title="10">  <span class="dt">jwtConfig</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb261-11" title="11">    <span class="dt">secret</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">JWT_SECRET</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-12" title="12">    <span class="dt">expiresIn</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">JWT_EXPIRES_IN</span><span class="op">,</span></a>
<a class="sourceLine" id="cb261-13" title="13">  <span class="op">},</span></a>
<a class="sourceLine" id="cb261-14" title="14"><span class="op">};</span></a></code></pre></div>
<p>Finally, let’s create an <code>auth.js</code> file and declare a <code>getUserToken</code> function that will generate an access token for the user. In this function, take in the user object as a parameter. Then, use the <code>jsonwebtoken</code> library to generate a JWT:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb262-1" title="1"><span class="kw">const</span> jwt <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;jsonwebtoken&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb262-2" title="2"><span class="kw">const</span> <span class="op">{</span> jwtConfig <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./config&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb262-3" title="3"></a>
<a class="sourceLine" id="cb262-4" title="4"><span class="kw">const</span> <span class="op">{</span> secret<span class="op">,</span> expiresIn <span class="op">}</span> <span class="op">=</span> jwtConfig<span class="op">;</span></a>
<a class="sourceLine" id="cb262-5" title="5"></a>
<a class="sourceLine" id="cb262-6" title="6"><span class="kw">const</span> getUserToken <span class="op">=</span> (user) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-7" title="7">  <span class="co">// Don&#39;t store the user&#39;s hashed password</span></a>
<a class="sourceLine" id="cb262-8" title="8">  <span class="co">// in the token data.</span></a>
<a class="sourceLine" id="cb262-9" title="9">  <span class="kw">const</span> userDataForToken <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-10" title="10">    <span class="dt">id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-11" title="11">    <span class="dt">email</span><span class="op">:</span> <span class="va">user</span>.<span class="at">email</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-12" title="12">  <span class="op">};</span></a>
<a class="sourceLine" id="cb262-13" title="13"></a>
<a class="sourceLine" id="cb262-14" title="14">  <span class="co">// Create the token.</span></a>
<a class="sourceLine" id="cb262-15" title="15">  <span class="kw">const</span> token <span class="op">=</span> <span class="va">jwt</span>.<span class="at">sign</span>(</a>
<a class="sourceLine" id="cb262-16" title="16">    <span class="op">{</span> <span class="dt">data</span><span class="op">:</span> userDataForToken <span class="op">},</span></a>
<a class="sourceLine" id="cb262-17" title="17">    secret<span class="op">,</span></a>
<a class="sourceLine" id="cb262-18" title="18">    <span class="op">{</span> <span class="dt">expiresIn</span><span class="op">:</span> <span class="at">parseInt</span>(expiresIn<span class="op">,</span> <span class="dv">10</span>) <span class="op">}</span> <span class="co">// 604,800 seconds = 1 week</span></a>
<a class="sourceLine" id="cb262-19" title="19">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb262-20" title="20"></a>
<a class="sourceLine" id="cb262-21" title="21">  <span class="cf">return</span> token<span class="op">;</span></a>
<a class="sourceLine" id="cb262-22" title="22"><span class="op">};</span></a>
<a class="sourceLine" id="cb262-23" title="23"></a>
<a class="sourceLine" id="cb262-24" title="24"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span> getUserToken <span class="op">};</span></a></code></pre></div>
<p>To recap, in the code snippet above, the <code>jwt.sign</code> method’s first argument is the payload. The second argument is the secret key used to sign the JWT, and the third argument is an <code>options</code> object that you can use to customize the JWT. Notice how we also had to convert <code>expiresIn</code> from a string to an integer. This is because environment variables declared in the <code>.env</code> file are strings, and according to the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> docs, anything that gets set to the <code>expiresIn</code> as an <strong>integer</strong> will be calculated as <strong>seconds</strong>, and <strong>strings</strong> will be calculated in <strong>milliseconds</strong>.</p>
<p>Let’s go back to the users router to finish generating an access token for the client. In the <code>router.post("/")</code> route handler, after the user has been created, use the <code>getUserToken</code> function to generate the JWT. Then, set it in the body of the response:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb263-1" title="1"><span class="kw">const</span> <span class="op">{</span> getUserToken <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../auth&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb263-2" title="2"></a>
<a class="sourceLine" id="cb263-3" title="3"><span class="co">// REST OF FILE NOT SHOWN</span></a>
<a class="sourceLine" id="cb263-4" title="4"></a>
<a class="sourceLine" id="cb263-5" title="5"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb263-6" title="6">  <span class="st">&quot;/&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb263-7" title="7">  validateEmailAndPassword<span class="op">,</span></a>
<a class="sourceLine" id="cb263-8" title="8">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb263-9" title="9">    <span class="kw">const</span> <span class="op">{</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb263-10" title="10">    <span class="kw">const</span> hashedPassword <span class="op">=</span> <span class="cf">await</span> <span class="va">bcrypt</span>.<span class="at">hash</span>(password<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb263-11" title="11">    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> email<span class="op">,</span> hashedPassword <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb263-12" title="12"></a>
<a class="sourceLine" id="cb263-13" title="13">    <span class="kw">const</span> token <span class="op">=</span> <span class="at">getUserToken</span>(user)<span class="op">;</span></a>
<a class="sourceLine" id="cb263-14" title="14">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">201</span>).<span class="at">json</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb263-15" title="15">      <span class="dt">user</span><span class="op">:</span> <span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">id</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb263-16" title="16">      token<span class="op">,</span></a>
<a class="sourceLine" id="cb263-17" title="17">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb263-18" title="18">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb263-19" title="19">)<span class="op">;</span></a></code></pre></div>
<p>Finally, go to Postman and make a POST request to <code>http://localhost:8080/users</code> with the correct params in order to create a user. Verify that you are able to get the <code>token</code> in the response body.</p>
<h3 id="using-the-access-token">Using the access token</h3>
<p>Let’s put the access token to use by protecting the tasks resource. In order to protect the tasks routes, let’s set it up so that the request must contain a valid, unexpired JWT that identifies a signed up user. This means that the client will now be required to include a valid access token in the header of the request if they want to access the tasks routes.</p>
<p>In the server, you’ll need to then set up a couple of functions that will parse the access token from the header of the request, verify that it is a valid JWT, and then find the user based on the identifying data, such as the user id and email, in the payload.</p>
<p>Let’s go to the <code>auth.js</code> file to set this up! First, in order to parse the access token from the request header, install the <a href="https://www.npmjs.com/package/express-bearer-token">express-bearer-token</a> npm package by running <code>npm install express-bearer-token</code>. This package provides a middleware function that will automatically look in the header under the <code>Authorization</code> key for a token, parse it out, and then set the token as a field in the <code>req</code> object. Specifically, it expects for the header to be formatted like: <code>Authorization: Bearer &lt;token&gt;</code>, which is a standard format for setting access tokens in the request header.</p>
<p>Next, now that the token has been parsed out, you need to set up a middleware function that will verify the validity of the JWT. Once it’s been verified, you can take the decoded payload and then use the identifying information to search for the user in the database. Once a user has been found, set it as a field in the <code>req</code> object so that subsequent middleware functions have access to it. If any steps fail along the way, then throw an error and return a 401 Unauthorized status. This is what that function should look like:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb264-1" title="1"><span class="kw">const</span> restoreUser <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-2" title="2">  <span class="co">// token being parsed from request header by the bearerToken middleware</span></a>
<a class="sourceLine" id="cb264-3" title="3">  <span class="co">// function in app.js:</span></a>
<a class="sourceLine" id="cb264-4" title="4">  <span class="kw">const</span> <span class="op">{</span> token <span class="op">}</span> <span class="op">=</span> req<span class="op">;</span></a>
<a class="sourceLine" id="cb264-5" title="5"></a>
<a class="sourceLine" id="cb264-6" title="6">  <span class="cf">if</span> (<span class="op">!</span>token) <span class="op">{</span></a>
<a class="sourceLine" id="cb264-7" title="7">    <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;Unauthorized&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-8" title="8">    <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">401</span><span class="op">;</span></a>
<a class="sourceLine" id="cb264-9" title="9">    <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb264-11" title="11"></a>
<a class="sourceLine" id="cb264-12" title="12">  <span class="cf">return</span> <span class="va">jwt</span>.<span class="at">verify</span>(token<span class="op">,</span> secret<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">async</span> (err<span class="op">,</span> jwtPayload) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-13" title="13">    <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb264-14" title="14">      <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">401</span><span class="op">;</span></a>
<a class="sourceLine" id="cb264-15" title="15">      <span class="cf">return</span> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-16" title="16">    <span class="op">}</span></a>
<a class="sourceLine" id="cb264-17" title="17"></a>
<a class="sourceLine" id="cb264-18" title="18">    <span class="kw">const</span> <span class="op">{</span> id <span class="op">}</span> <span class="op">=</span> <span class="va">jwtPayload</span>.<span class="at">data</span><span class="op">;</span></a>
<a class="sourceLine" id="cb264-19" title="19"></a>
<a class="sourceLine" id="cb264-20" title="20">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-21" title="21">      <span class="va">req</span>.<span class="at">user</span> <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">findByPk</span>(id)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-22" title="22">    <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb264-23" title="23">      <span class="va">e</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">401</span><span class="op">;</span></a>
<a class="sourceLine" id="cb264-24" title="24">      <span class="cf">return</span> <span class="at">next</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb264-26" title="26"></a>
<a class="sourceLine" id="cb264-27" title="27">    <span class="cf">if</span> (<span class="op">!</span><span class="va">req</span>.<span class="at">user</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb264-28" title="28">      <span class="co">// Send a &quot;401 Unauthorized&quot; response status code</span></a>
<a class="sourceLine" id="cb264-29" title="29">      <span class="co">// along with an &quot;WWW-Authenticate&quot; header value of &quot;Bearer&quot;.</span></a>
<a class="sourceLine" id="cb264-30" title="30">      <span class="cf">return</span> <span class="va">res</span>.<span class="at">set</span>(<span class="st">&quot;WWW-Authenticate&quot;</span><span class="op">,</span> <span class="st">&quot;Bearer&quot;</span>).<span class="at">status</span>(<span class="dv">401</span>).<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb264-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb264-32" title="32"></a>
<a class="sourceLine" id="cb264-33" title="33">    <span class="cf">return</span> <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb264-34" title="34">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-35" title="35"><span class="op">};</span></a></code></pre></div>
<p>Make sure to use import the <code>User</code> model at the top of the file as well.</p>
<p>Now that you’ve got both the <a href="https://www.npmjs.com/package/express-bearer-token">express-bearer-token</a> middleware function and the <code>restoreUser</code> function, go ahead and export both of those functions together in an array called <code>requireAuth</code>. This array of middleware functions can then be passed in to any routes or routers that you want to protect. This is what that should look like:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb265-1" title="1"><span class="kw">const</span> bearerToken <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express-bearer-token&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb265-2" title="2"></a>
<a class="sourceLine" id="cb265-3" title="3"><span class="co">// OTHER CODE IN THE FILE NOT SHOWN</span></a>
<a class="sourceLine" id="cb265-4" title="4"></a>
<a class="sourceLine" id="cb265-5" title="5"><span class="kw">const</span> requireAuth <span class="op">=</span> [<span class="at">bearerToken</span>()<span class="op">,</span> restoreUser]<span class="op">;</span></a>
<a class="sourceLine" id="cb265-6" title="6"></a>
<a class="sourceLine" id="cb265-7" title="7"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span> getUserToken<span class="op">,</span> requireAuth <span class="op">};</span></a></code></pre></div>
<p>Finally, let’s put this array of middleware functions to use by going to the tasks router and adding it as a middleware function (before any of the route definitions) for all routes in this router:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb266-1" title="1"><span class="kw">const</span> <span class="op">{</span> requireAuth <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../auth&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb266-2" title="2"></a>
<a class="sourceLine" id="cb266-3" title="3"><span class="co">// REST OF FILE NOT SHOWN</span></a>
<a class="sourceLine" id="cb266-4" title="4"></a>
<a class="sourceLine" id="cb266-5" title="5"><span class="va">router</span>.<span class="at">use</span>(requireAuth)<span class="op">;</span></a>
<a class="sourceLine" id="cb266-6" title="6"></a>
<a class="sourceLine" id="cb266-7" title="7"><span class="co">// ROUTE DEFINITIONS NOT SHOWN</span></a></code></pre></div>
<p>At this point, go ahead and go to Postman to try to make a request for all tasks (<code>GET http://localhost:8080/tasks</code>). This should fail with a 401 response.</p>
<p>To fix this, use the <code>POST http://localhost:8080/users</code> endpoint to create another user. This time, take the <code>token</code> that’s in the response body. Use that <code>token</code> value in the <code>Authorization</code> header:</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postman-jwt-token-2.png" alt="Authorization header" /><figcaption>Authorization header</figcaption>
</figure>
<p>Then, make another request for all tasks, and this time, since the client is authenticated, getting all of the tasks works!</p>
<h3 id="where-to-store-the-access-token-on-the-client-side">Where to store the access token on the client-side</h3>
<p>In the project that you’ll be working on today, you’ll be building out a frontend app that allows users to sign up and log in, and the response to these two types of requests would include the access token.</p>
<p>Once the client receives this access token, it needs to store it somewhere so that it can be included with all subsequent requests. In the previous lesson on session-based auth, the session id was stored in a cookie.</p>
<p>One popular place to store access tokens nowadays is by using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">Web Storage API</a>. The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">Web Storage API</a>, implemented by browsers, exposes two place to store data on the client side: <code>localStorage</code> and <code>sessionStorage</code>.</p>
<blockquote>
<p><code>localStorage</code> stores data without an expiration date. <code>sessionStorage</code> stores data until the browser or the tab is closed.</p>
</blockquote>
<p>In choosing between cookies and something like <code>localStorage</code>, the upside of <code>localStorage</code> is that it’s very simple to use. With <code>cookies</code> there are very specific configurations that must be set on both the server and the client in order to allow for it to work in a cross-domain setting.</p>
<p>On the other hand, data stored in <code>localStorage</code> is retrievable by client-side JavaScript, so if your application does not take the necessary measures against Cross-Site Scripting (XSS), then the access tokens stored in <code>localStorage</code> could be stolen. You’ll learn more about XSS in a later lesson.</p>
<p>For tomorrow’s project, you’ll be using <code>localStorage</code> to store the access token, and again, it is a fairly popular way to store access tokens. At the same time, it’s definitely useful to know what options are available and the pros and cons of each option.</p>
<h2 id="what-youve-learned-2">What you’ve learned</h2>
<p>In this lesson, you learned:</p>
<ol type="1">
<li>What a JSON Web Token (JWT) is and how it can be used to securely send user information between servers or across requests.</li>
<li>How to add token-based (session-less) authentication to an Express API.</li>
<li>How to use the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> npm package to sign and verify JWTs.</li>
</ol>
</body></html>
