<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<link rel="stylesheet" href="./prism.css">
<script async defer src="./prism.js"></script>
</head>
<body>;
<h1 id="week-11-full-stack-applications-part-1" data-ignore="true">WEEK 11<br><em>Full-Stack Applications (Part 1)</em></h1>
<hr />
<!-- code_chunk_output -->
<p><a href="#regular-expressions-learning-objectives"><strong>Regular Expressions Learning Objectives</strong></a> <a href="#http-full-stack-learning-objectives"><strong>HTTP Full-Stack Learning Objectives</strong></a> - <a href="#the-uniform-resource-locator-url"><strong>The Uniform Resource Locator (URL)</strong></a> - <a href="#the-specification">The specification</a> - <a href="#what-is-this-resource-thing">What is this "resource" thing?</a> - <a href="#the-components-of-a-url">The components of a URL</a> - <a href="#reading-rfcs">Reading RFCs</a> - <a href="#regular-expressions-cheat-sheet"><strong>Regular Expressions Cheat Sheet</strong></a> - <a href="#the-operator">The * operator</a> - <a href="#the-operator-1">The ? operator</a> - <a href="#the-operator-2">The + operator</a> - <a href="#the-operator-3">The . operator</a> - <a href="#the-operator-without-brackets">The ^ operator without brackets</a> - <a href="#the-operator-4">The $ operator</a> - <a href="#the-bracket-expression">The [] bracket expression</a> - <a href="#regexone-practice"><em>RegexOne Practice</em></a> - <a href="#http-full-stack-project"><em>HTTP Full-Stack Project</em></a></p>
<p><a href="#express-learning-objectives"><strong>Express Learning Objectives</strong></a> <a href="#pug-template-learning-objectives"><strong>Pug Template Learning Objectives</strong></a> - <a href="#moving-into-the-express-lane"><strong>Moving Into the Express Lane</strong></a> - <a href="#installing-express">Installing Express</a> - <a href="#creating-an-express-application">Creating an Express application</a> - <a href="#handling-requests">Handling requests</a> - <a href="#listening-for-http-connections">Listening for HTTP connections</a> - <a href="#testing-your-application">Testing your application</a> - <a href="#templating-meet-pug"><strong>Templating - <em>Meet Pug!</em></strong></a> - <a href="#what-is-a-template">What is a template?</a> - <a href="#rendering-a-simple-template">Rendering a simple template</a> - <a href="#digging-into-the-pug-template-syntax"><strong>Digging Into the Pug Template Syntax</strong></a> - <a href="#setting-up-a-sandbox-application">Setting up a sandbox application</a> - <a href="#rendering-elements">Rendering elements</a> - <a href="#setting-element-attribute-values">Setting element attribute values</a> - <a href="#rendering-data">Rendering data</a> - <a href="#iteration-and-conditionals">Iteration and conditionals</a> - <a href="#exploring-route-paths"><strong>Exploring Route Paths</strong></a> - <a href="#getting-data-from-a-path">Getting data from a path</a> - <a href="#defining-flexible-route-paths">Defining flexible route paths</a> - <a href="#redirecting-incorrect-requests">Redirecting "incorrect" requests</a> - <a href="#express-routers"><strong>Express Routers</strong></a> - <a href="#setting-up-the-initial-project">Setting up the initial project</a> - <a href="#defining-a-collection-of-route-handlers">Defining a collection of route handlers</a> - <a href="#mounting-a-router-instance">Mounting a Router instance</a> - <a href="#routing-roundup-project"><em>Routing Roundup Project</em></a></p>
<p><a href="#html-forms-learning-objectives"><strong>HTML Forms Learning Objectives</strong></a> - <a href="#html-forms-an-introduction"><strong>HTML Forms: An Introduction</strong></a> - <a href="#key-components-of-a-form">Key components of a form</a> - <a href="#submitting-the-form">Submitting the form</a> - <a href="#html-forms-in-express"><strong>HTML Forms in Express</strong></a> - <a href="#forms-example-setup">Forms example setup</a> - <a href="#getting-the-add-guest-form">Getting the "Add Guest" form</a> - <a href="#a-quick-aside-pug-layout-templates">A quick aside: Pug layout templates</a> - <a href="#submitting-the-guest-form">Submitting the guest form</a> - <a href="#data-validation"><strong>Data Validation</strong></a> - <a href="#importance-of-server-side-data-validation">Importance of server-side data validation</a> - <a href="#server-side-validations">Server-side validations</a> - <a href="#server-side-validations-an-example">Server-side validations: an example</a> - <a href="#express-middleware"><strong>Express Middleware</strong></a> - <a href="#middleware-overview">Middleware overview</a> - <a href="#data-validations-with-middleware">Data validations with middleware</a> - <a href="#protecting-forms-from-csrf"><strong>Protecting forms from CSRF</strong></a> - <a href="#csrf-explained">CSRF explained</a> - <a href="#preventing-csrf">Preventing CSRF</a> - <a href="#formative-forms-project"><em>Formative Forms Project</em></a></p>
<p><a href="#data-driven-web-sites-learning-objectives"><strong>Data-Driven Web Sites Learning Objectives</strong></a> - <a href="#acclimating-to-environment-variables"><strong>Acclimating to Environment Variables</strong></a> - <a href="#what-are-environment-variables">What are environment variables?</a> - <a href="#setting-and-getting-environment-variable-values">Setting and getting environment variable values</a> - <a href="#storing-environment-variables-in-a-env-file">Storing environment variables in a <code>.env</code> file</a> - <a href="#using-a-module-to-organize-environment-variables">Using a module to organize environment variables</a> - <a href="#asynchronous-route-handlers-in-express"><strong>Asynchronous Route Handlers in Express</strong></a> - <a href="#calling-asynchronous-functions-or-methods-within-route-handlers">Calling asynchronous functions or methods within route handlers</a> - <a href="#reducing-boilerplate-code">Reducing boilerplate code</a> - <a href="#handling-errors-in-express"><strong>Handling Errors in Express</strong></a> - <a href="#setting-up-an-example-express-application">Setting up an example Express application</a> - <a href="#the-default-error-handler-in-express">The default error handler in Express</a> - <a href="#defining-a-custom-error-handler">Defining a custom error handler</a> - <a href="#handling-page-not-found-errors">Handling "Page Not Found" errors</a> - <a href="#data-driven-websites-part-1-setting-up-the-project"><em>Data-Driven Websites (Part 1: Setting Up the Project)</em></a> - <a href="#data-driven-websites-project-part-2-integrating-sequelize-with-express"><em>Data-Driven Websites Project (Part 2: Integrating Sequelize with Express)</em></a> - <a href="#data-driven-websites-project-part-3-using-sequelize-to-perform-crud-operations"><em>Data-Driven Websites Project (Part 3: Using Sequelize to Perform CRUD Operations)</em></a></p>
<!-- /code_chunk_output -->
<hr />
<hr />
<h1 id="week-11-day-1-node-http-servers" data-ignore="true">WEEK-11 DAY-1<br><em>Node HTTP Servers</em></h1>
<hr />
<h1 id="regular-expressions-learning-objectives">Regular Expressions Learning Objectives</h1>
<p>Regular expressions are a delight and a nightmare. They please and they confound. They are an important part of every developer’s toolbox. By the time you finish this, you should be able to</p>
<ul>
<li>Define the effect of the * operator and use it in a regular expression</li>
<li>Define the effect of the ? operator and use it in a regular expression</li>
<li>Define the effect of the + operator and use it in a regular expression</li>
<li>Define the effect of the . operator and use it in a regular expression</li>
<li>Define the effect of the ^ operator and use it in a regular expression</li>
<li>Define the effect of the $ operator and use it in a regular expression</li>
<li>Define the effect of the [] bracket expression and use it in a regular expression</li>
<li>Define the effect of the - inside brackets and use it in a regular expression</li>
<li>Define the effect of the ^ inside brackets and use it in a regular expression</li>
</ul>
<hr />
<h1 id="http-full-stack-learning-objectives">HTTP Full-Stack Learning Objectives</h1>
<p>Understanding how Node.js handles incoming HTTP requests using the <code>IncomingMessage</code> and <code>ServerResponse</code> objects provide a strong foundation of being able to predict problems when you use frameworks to ease the burden of writing Web applications. When you complete the associated material for this lesson, you should be able to:</p>
<ul>
<li>Identify the five parts of a URL</li>
<li>Identify at least three protocols handled by the browser</li>
<li>Use an <code>IncomingMessage</code> object to
<ul>
<li>access the headers sent by a client (like a Web browser) as part of the HTTP request</li>
<li>access the HTTP method of the request</li>
<li>access the path of the request</li>
<li>access and read the stream of content for requests that have a body</li>
</ul></li>
<li>Use a <code>ServerResponse</code> object to
<ul>
<li>write the status code, message, and headers for an HTTP response</li>
<li>write the content of the body of the response</li>
<li>properly end the response to indicate to the client (like a Web browser) that all content has been written</li>
</ul></li>
</ul>
<hr />
<h1 id="the-uniform-resource-locator-url">The Uniform Resource Locator (URL)</h1>
<p>We use URLs all the time. Now, it’s time to really understand how they work.</p>
<p>From this reading, you should be able to</p>
<ul>
<li>Recall where to find the definition of a URL,</li>
<li>Identify and recall the five components of a URL, and</li>
<li>Identify properly formatted URLs</li>
</ul>
<h2 id="the-specification">The specification</h2>
<p>Almost all good things that define how the Internet works has one or more things called IETF RFCs which define how they work. There are two acronyms there:</p>
<ul>
<li><strong>IETF</strong>: Internet Engineering Task Force</li>
<li><strong>RFC</strong>: Request For Comments</li>
</ul>
<p>The IETF is an open standards organization that creates voluntary standards to maintain and improve the usability and interoperability of the Internet. Things like the way travels across the Internet is created an maintained by the IETF. In particular, the <em>Simple Mail Transfer Protocol</em> is now governed by <a href="https://tools.ietf.org/html/rfc5321">RFC 5321</a>. RFC 5321 made obsolete RFC 2821 which, in turn, made obsolete RFC 821. The IETF is always working to make the Internet better with respect to its growth and usage.</p>
<p>An RFC is a document usually created by programmers, engineers, and scientists in the form of a memorandum. They publish the RFC for peer review. When enough people have reviewed it, and it seems worthy of adoption, the IETF will change its status to "Internet Standard" which means that everyone should comply with it if they implement that standard.</p>
<p>The <a href="https://tools.ietf.org/html/rfc3986">RFC 3986</a>, <em>Uniform Resource Identifier (URI): Generic Syntax</em>, is an "Internet Standard". That means that software applications that use URLs need to conform to the specification found in that document lest they be publicly shamed by computer programmers trying to use the non-conforming software.</p>
<h2 id="what-is-this-resource-thing">What is this "resource" thing?</h2>
<p>Well, the standard doesn’t do much for you in providing a definition of this word "resource".</p>
<blockquote>
<p>This specification does not limit the scope of what might be a resource; rather, the term "resource" is used in a general sense for whatever might be identified by a URI. Familiar examples include an electronic document, an image, a source of information with a consistent purpose (e.g., "today’s weather report for Los Angeles"), a service (e.g., an HTTP-to-SMS gateway), and a collection of other resources. A resource is not necessarily accessible via the Internet; e.g., human beings, corporations, and bound books in a library can also be resources. Likewise, abstract concepts can be resources, such as the operators and operands of a mathematical equation, the types of a relationship (e.g., "parent" or "employee"), or numeric values (e.g., zero, one, and infinity).</p>
</blockquote>
<p>That influence comes from one of the authors, Dr. Roy Fielding. He has some strong ideas about how the Internet works and, much to his disappointment, it continues to move away from his ideals.</p>
<p>For your purposes, a URL points to a (hopefully) accessible resource that can be accessed, like HTML, CSS, JavaScript, and pure data in the form of JSON.</p>
<h2 id="the-components-of-a-url">The components of a URL</h2>
<p>In Section 3, <em>Syntax Components</em>, of RFC 3986 contains this helpful ASCII art graphic to show you the components of a URL.</p>
<pre><code>  foo://example.com:8042/over/there?name=ferret#nose
  \_/   \______________/\_________/ \_________/ \__/
   |           |            |            |        |
scheme     authority       path        query   fragment</code></pre>
<p>Here’s an explanation of each of those components.</p>
<h3 id="the-scheme-of-a-url">The "scheme" of a URL</h3>
<p>This section used to be called "the protocol", but was updated when URLs became part of a larger family known as URIs, Uniform Resource Identifiers, which is what RFC 3986 actually covers.</p>
<p>You’ve actually used three schemes already in class! Can you remember them?</p>
<p>If you replied "http" and "https", that’s right! When you type an authority in the browser, like "duckduckgo.com" or "localhost:3000", the browser <em>assumes</em> that you want to use HTTP, so it prepends that scheme to the authority. The browser would then make requests to "http://duckduckgo.com" or "http://localhost:3000".</p>
<p>When you double click on an HTML file and it opens locally in your browser, that is using the "file" scheme, meaning that it is looking for a file local to the computer! You’ve done this countless times during this course. You may have noticed the "file" part in the address bar. That’s the scheme it used to access local files as opposed to making an HTTP request.</p>
<p>This is why it was once named "protocol", because it was the protocol that the browser would use to <em>locate the resource</em> using a Uniform Resource Locator.</p>
<h3 id="stuff-between-the-scheme-and-authority">Stuff between the scheme and authority</h3>
<p>The standard tells us that for URLs that have an authority, the characters "://" must exist between the scheme and the authority. That’s why you have to type those characters. You can blame Sir Tim Berners-Lee for that because he defined it in the original RFC for this subject, RFC 1738, <em>Uniform Resource Locators (URL)</em>.</p>
<h3 id="the-authority">The authority</h3>
<p>This part of as URL is normally the domain name of the resource that has the resource that you’re trying to access.</p>
<p>Sometimes it has a port number, too, like when you start a local HTTP server with Node.js. Then, you type "http://localhost:3000". The authority is the entire "localhost:3000". That means that, even if "http://localhost:3000" and "http://localhost:8081" return the exact same content, they’re considered to be two different URLs to the same content.</p>
<h3 id="the-path">The path</h3>
<p>Paths are in the first part of an HTTP request, if you recall. When you click on a link in your browser that takes you to "https://duckduckgo.com/about", that results in an HTTP request that begins with the following line:</p>
<pre><code>GET /about HTTP/1.1</code></pre>
<p>That’s the path.</p>
<p>If the path is omitted from a URL, it is assumed to be "/".</p>
<h3 id="the-query">The query</h3>
<p>This is extra information sent to the browser meant for the processing of the request. For example, when you go to DuckDuckGo and perform a search for "RFC 3986" by typing it into the search box, the URL that your browser is directed to reads "https://duckduckgo.com/?q=RFC+3986".</p>
<p>The question mark and everything that comes after it (up to the <em>fragment</em>) is considered the "query" of the URL. Because it’s part of the URL, it means that different values of the query part of the URL points to different resources even if the exact same content is returned.</p>
<p>With respect to URLs used for the World Wide Web, queries generated by browsers (and possibly by your code) will have the following format:</p>
<ul>
<li>Entries in the query are "URL encoded" key-value pairs with an equal sign between them</li>
<li>Entries are concatenated with the ampersand symbol</li>
</ul>
<p>When the key or value of an entry in a query contains a character that is not one of the reserved or unreserved characters, then it gets "URL encoded". That process replaces each character a percent sign and its hexadecimal <a href="https://en.wikipedia.org/wiki/ASCII#Character_set">ASCII Code</a>.</p>
<p>For example, when your provide the value "Mary<span class="math inline">$quite/contrary" for your query in DuckDuckGo, the browser "URL encodes" the "$</span>" and "/" because those aren’t allowable characters. Those characters’ ASCII Code values are 24 and 2F, respectively. That transforms the string to "Mary%24quite%2Fcontrary".</p>
<p>Luckily, JavaScript has built-in methods called <code>encodeURI</code> (<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURI">link</a>) and <code>decodeURI</code> (<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/decodeURI">link</a>) that handles that transformation for you!</p>
<h3 id="the-fragment">The fragment</h3>
<p>The fragment is never sent to the server. Instead, it tells the browser to access a specific section of the page after it loads. For example, if you look at the following link</p>
<p>https://en.wikipedia.org/wiki/URL#Protocol-relative_URLs</p>
<p>you can see that there is a fragment value of "#Protocol-relative_URLs". If you click on that link, the browser will load that page and, then, scroll that section into view for you.</p>
<p>Unlike with changing values in <em>any</em> of the other sections, if you change the value in the fragment, the browser will <em>not</em> reload the page.</p>
<h2 id="reading-rfcs">Reading RFCs</h2>
<p>Unfortunately, RFCs tend to be very unappealing and technical, not fun to read at all. However, you should try reading them when you have a question about how something works that’s governed by the IETF. You will gain insight that only comes from technical documentation.</p>
<p>As a side note, it is a common thing for programmers to publish April Fool’s RFCs. Their sense of humor is … shockingly technical and dry. Here are some interesting ones, for example.</p>
<ul>
<li><a href="https://tools.ietf.org/html/rfc8565">Hypertext Jeopardy Protocol (HTJP/1.0)</a></li>
<li><a href="https://tools.ietf.org/html/rfc6921">Design Considerations for Faster-Than-Light (FTL) Communication</a></li>
<li><a href="https://tools.ietf.org/html/rfc5841">TCP Option to Denote Packet Mood</a></li>
</ul>
<p>Yep, that’s the kind of humor in deeply computer science-y groups.</p>
<p>¯\(◉◡◔)/¯</p>
<h2 id="what-youve-learned">What you’ve learned</h2>
<p>You learned that the five parts of a URL are</p>
<ol type="1">
<li>The scheme (required),</li>
<li>The authority (required),</li>
<li>The path (optional),</li>
<li>The query (optional), and</li>
<li>The fragment (optional, not sent to the server).</li>
</ol>
<p>You were reminded that you actually know three schemes: http, https, and file.</p>
<p>And, that’s it for URLs. :-)</p>
<hr />
<h1 id="regular-expressions-cheat-sheet">Regular Expressions Cheat Sheet</h1>
<p>This article lists the most commonly-used regular expressions operators. You can use it as a handy reference for later while you write regular expressions.</p>
<h2 id="the-operator">The * operator</h2>
<p>The <code>*</code> operator is known as the <strong>Kleene Star</strong>, one of the <a href="https://regexone.com/lesson/kleene_operators">Kleene operators</a>. You use the Kleene Star operator to match any number, <strong>zero or more</strong>, of the character it follows.</p>
<p>For example, take the following regular expression patterns and compare them with the strings below:</p>
<h4 id="example-1-xyz">Example 1: <code>xy*z</code></h4>
<p>Matches:</p>
<pre><code>xxz
xyyyzzz</code></pre>
<p>Does not match:</p>
<pre><code>yyy
xyxz</code></pre>
<h4 id="example-2-xyz">Example 2: <code>x*yz</code></h4>
<p>Matches:</p>
<pre><code>xxyz
yyyzzz</code></pre>
<p>Does not match:</p>
<pre><code>xxx
xyyz</code></pre>
<h4 id="example-3-xyz">Example 3: <code>xyz*</code></h4>
<p>Matches:</p>
<pre><code>xy
xxyzzz</code></pre>
<p>Does not match:</p>
<pre><code>zzz
xyyz</code></pre>
<h2 id="the-operator-1">The ? operator</h2>
<p>The question mark operator denotes that the character preceding <code>?</code> is an <a href="https://regexone.com/lesson/optional_characters">optional character</a>. Note that when you want to use a normal question mark as a normal character and NOT as a regular expression operator, you need to escape the character with a forward slash like <code>\?</code>.</p>
<p>Take the following pattern and compare it with the strings below. Notice how the <code>s?</code> portion of the expression makes the "s" character optional, allowing the pattern to match both "video" and "videos".</p>
<h4 id="example-1-videos">Example 1: <code>videos?</code></h4>
<p>Matches:</p>
<pre><code>cat video
dog videos</code></pre>
<p>Does not match:</p>
<pre><code>bird vids
hedgehog vides</code></pre>
<h4 id="example-2-videos">Example 2: <code>videos\?</code></h4>
<p>Matches:</p>
<pre><code>dog videos?
videos? hello?</code></pre>
<p>Does not match:</p>
<pre><code>cat video
videos</code></pre>
<p>Note different effect of the regular expression with an escaped question mark verses a non-escaped question mark.</p>
<h4 id="example-3-videos-watched">Example 3: <code>videos? watched\?</code></h4>
<p>Matches:</p>
<pre><code>dog video watched?
cat videos watched?</code></pre>
<p>Does not match:</p>
<pre><code>bird video watched
hedgehog videos not watched</code></pre>
<h2 id="the-operator-2">The + operator</h2>
<p>The <code>+</code> operator is known as the <strong>Kleene Star Plus</strong>. You use Kleene Star Plus to match <strong>one or more</strong> of the character it follows, instead of <strong>zero or more</strong> like the Kleene Star.</p>
<p>For example, take the following regular expression patterns and strings below:</p>
<h4 id="example-1-xyz-1">Example 1: <code>xy+z</code></h4>
<p>Matches:</p>
<pre><code>xyyyzzz
xxxyzz</code></pre>
<p>Does not match:</p>
<pre><code>xxz
xyxz</code></pre>
<p>Note how "xxz" is matched by <code>xy*z</code> but not by <code>xy+z</code>.</p>
<h4 id="example-2-xyz-1">Example 2: <code>x+yz</code></h4>
<p>Matches:</p>
<pre><code>xyzzz
xxxyzz</code></pre>
<p>Does not match:</p>
<pre><code>yzz
xyyz</code></pre>
<h4 id="example-3-xyz-1">Example 3: <code>xyz+</code></h4>
<p>Matches:</p>
<pre><code>xyzzz
xxyz</code></pre>
<p>Does not match:</p>
<pre><code>xy
xxy</code></pre>
<h2 id="the-.-operator">The . operator</h2>
<p>The dot operator matches any <strong>single</strong> character. It acts as a <a href="https://regexone.com/lesson/wildcards_dot">wildcard</a> that can match any single number, letter, symbol, or even whitespace. Like the question mark operator, in order to use <code>.</code> as a normal character instead of a regular expression operator, you need to escape the character with a forward slash (<code>\.</code>).</p>
<p>Take the example expressions and strings below:</p>
<h4 id="example-1-..a..">Example 1: <code>..a..</code></h4>
<p>Matches:</p>
<pre><code>12aa3
brains</code></pre>
<p>Does not match:</p>
<pre><code>123a4
catch</code></pre>
<h4 id="example-2-.at.">Example 2: <code>.at.</code></h4>
<p>Matches:</p>
<pre><code>?att
catch</code></pre>
<p>Does not match:</p>
<pre><code>1a1t
atss</code></pre>
<p>Remember that using a forward slash before a question mark in a regular expression escapes the question mark so that <code>?</code> is not interpreted as a regular expression operator.</p>
<h4 id="example-3-...">Example 3: <code>...\?</code></h4>
<p>Matches:</p>
<pre><code>123?
????</code></pre>
<p>Does not match:</p>
<pre><code>123
?cat</code></pre>
<h2 id="the-operator-without-brackets">The ^ operator without brackets</h2>
<p>The <code>^</code> operator is known as the hat operator. The hat operator can be used in two ways: * Without square brackets to match the start of a line. * Within square brackets to denote when you want to exclude characters.</p>
<p>When using <code>^</code> at the beginning of a regular expression pattern, you are indicating a match with statements that begin with the characters in your pattern. Note the case sensitivity in the examples below.</p>
<h4 id="example-1-dog">Example 1: <code>^Dog</code></h4>
<p>Matches:</p>
<pre><code>Doggie daycare
Dog food</code></pre>
<p>Does not match:</p>
<pre><code>doG master
puppy Dog</code></pre>
<h4 id="example-2-dog">Example 2: <code>^dog</code></h4>
<p>Matches:</p>
<pre><code>doggie
dogs</code></pre>
<p>Does not match:</p>
<pre><code>hotdog
small dog</code></pre>
<h4 id="example-3">Example 3: <code>^\?</code></h4>
<p>Matches:</p>
<pre><code>? hello
???</code></pre>
<p>Does not match:</p>
<pre><code>hi?
\?bye</code></pre>
<h2 id="the-operator-3">The $ operator</h2>
<p>The dollar sign operator is used to define the end of a line. Like how the <code>^</code> hat operator is used to specifically match the beginning characters of a line, the <code>$</code> dollar sign operator is used to specifically match the end of a line.</p>
<p>Take the following patterns and strings below:</p>
<h4 id="example-1-smell">Example 1: <code>smell$</code></h4>
<p>Matches:</p>
<pre><code>doggie smell
doggie has an interesting smell</code></pre>
<p>Does not match:</p>
<pre><code>doggie smells
doggie is smelling</code></pre>
<h4 id="example-2-dog.">Example 2: <code>dog.$</code></h4>
<p>Matches:</p>
<pre><code>sit, dog.
good dog!</code></pre>
<p>Does not match:</p>
<pre><code>sit, doggie
dogs.</code></pre>
<p>In the example below, the hat and dollar sign operators are used together to create a pattern that matches the entire "doggie smell" string from beginning to end.</p>
<h4 id="example-3-doggie-smell">Example 3: <code>^doggie smell$</code></h4>
<p>Matches:</p>
<pre><code>doggie smell</code></pre>
<p>Does not match:</p>
<pre><code>big doggie smell
doggie has an interesting smell
doggie smells</code></pre>
<h2 id="the-bracket-expression">The [] bracket expression</h2>
<p>You use square brackets in regular expressions to match and include characters. You can do so by listing out specific characters or using an alphanumeric range. You can also use the square brackets in conjunction with a hat operator to exclude characters.</p>
<p>Take the following patterns that include characters in the strings below:</p>
<h4 id="example-1-aein">Example 1: <code>[aei]n</code></h4>
<p>Matches:</p>
<pre><code>ban
hen</code></pre>
<p>Does not match:</p>
<pre><code>undo
on</code></pre>
<h4 id="example-2-robot-0-9">Example 2: <code>robot [0-9]</code></h4>
<p>Matches:</p>
<pre><code>robot 7
brobot 180</code></pre>
<p>Does not match:</p>
<pre><code>robots 7
robot seven</code></pre>
<h4 id="example-3-.dw">Example 3: <code>\.[dw]</code></h4>
<p>Matches:</p>
<pre><code>.whale
.dog</code></pre>
<p>Does not match:</p>
<pre><code>.cat
whale</code></pre>
<h3 id="the---inside-brackets">The - inside brackets</h3>
<p>You use the dash character to create <a href="https://regexone.com/lesson/character_ranges">character ranges</a> within square brackets. Multiple ranges can be set in the same square brackets. For example, the expression <code>[A-Za-z0-9_]</code> is often used to match all alphanumeric characters in the English language.</p>
<p>Take the following expressions and strings below:</p>
<h4 id="example-1-0-5-cats">Example 1: <code>[0-5] cats</code></h4>
<p>Matches:</p>
<pre><code>3 cats
33 cats</code></pre>
<p>Does not match:</p>
<pre><code>336 cats
3cats</code></pre>
<h4 id="example-2-a-dl-po-s">Example 2: <code>[A-D][l-p][o-s]</code></h4>
<p>Matches:</p>
<pre><code>Apple
Dose</code></pre>
<p>Does not match:</p>
<pre><code>apple
bone</code></pre>
<h4 id="example-3-a-z0-9a-z">Example 3: <code>[a-z][0-9][A-Z]</code></h4>
<p>Matches:</p>
<pre><code>h4T
bl7XYZ</code></pre>
<p>Does not match:</p>
<pre><code>h44T
XYZ7bl</code></pre>
<h3 id="the-inside-brackets">The ^ inside brackets</h3>
<p>When using <code>^</code> inside of square brackets, you are denoting that you want to <a href="https://regexone.com/lesson/excluding_characters">exclude characters</a>. In order to exclude characters, you need to wrap the operator and the characters you want to exclude within square brackets.</p>
<h4 id="example-1-b">Example 1: <code>[^b]</code></h4>
<p>Matches:</p>
<pre><code>hog
dog</code></pre>
<p>Does not match:</p>
<pre><code>bog
blog</code></pre>
<h4 id="example-2-bcat">Example 2: <code>[^bc]at</code></h4>
<p>Matches:</p>
<pre><code>chat
rat</code></pre>
<p>Does not match:</p>
<pre><code>hat
cat</code></pre>
<h4 id="example-3-bcog">Example 3: <code>[^bc]o[^g]</code></h4>
<p>Matches:</p>
<pre><code>hot
pot</code></pre>
<p>Does not match:</p>
<pre><code>cog
blog</code></pre>
<hr />
<h1 id="regexone-practice">RegexOne Practice</h1>
<hr />
<p>Just like with Flexbox Froggy and CSS Grid Garden, there are Web sites on the Internet that really stand out as excellent resources from which to learn. <a href="https://regexone.com/">RegexOne</a> is one of those resources.</p>
<p>It is a set of simple interactive exercises to help you practice your new-found knowledge of regular expressions. Do all of the 15 exercises and eight problems.</p>
<figure>
<img src="images/regexone-screenshot.png" alt="RegexOne home page" /><figcaption>RegexOne home page</figcaption>
</figure>
<hr />
<h1 id="http-full-stack-project">HTTP Full-Stack Project</h1>
<p>In this project, you are going to use Node.js to build a data-driven Web site. This project already includes the Sequelize models and migrations for you. You will create a Node.js HTTP server and use it to handle incoming requests from a browser. Then, you will generate HTML to respond to the request.</p>
<p>Today’s project does not address the aesthetics of the visual appearance of the Web pages. You will have an opportunity later this week to do that. Today is about <em>functionality</em>.</p>
<h2 id="project-overview">Project overview</h2>
<p>You will build a simple inventory tracking system for managing the amount of stuff that you have. The Sequelize data model is already created for you because you now know how to do that pretty well. You’ll get to flex those muscles later this week, too.</p>
<p>You will build the server that accepts incoming HTTP requests using <em>only</em> functionality built into Node.js. You will process the incoming request, determine what needs to be done, and generate HTML to send back to the client.</p>
<p>This project shows you the underpinnings of how Node.js-based Web applications work. Then, when you use a framework like Express.js or Koa.js, you will know what they’re doing.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Web/http-fullstack/assets/http-fullstack-native-show-final-app.gif" alt="final app" /><figcaption>final app</figcaption>
</figure>
<h3 id="the-data-model">The data model</h3>
<p>To focus on the server portion of this, the data model is very simple. It consists of one entity, the Item. The Item has the following properties.</p>
<table>
<thead>
<tr class="header">
<th>Property name</th>
<th>Data type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>string</td>
<td>not null, unique</td>
</tr>
<tr class="even">
<td>description</td>
<td>text</td>
<td>not null</td>
</tr>
<tr class="odd">
<td>imageName</td>
<td>string</td>
<td></td>
</tr>
<tr class="even">
<td>amount</td>
<td>integer</td>
<td>not null, default 0</td>
</tr>
</tbody>
</table>
<h3 id="the-functionality">The functionality</h3>
<p>You will create two HTML pages, one static and one dynamic. The static HTML page will consist of a form that allows you to add new items that you want to track. The dynamic HTML page will list the each item and its details and give you a way to reduce the amount on hand.</p>
<h2 id="get-started">Get started</h2>
<ul>
<li><p>Clone the starter repository from https://github.com/-starters/node-web-app-starter. But, this time, use an extended version of the Git <code>clone</code> command to put it in a specific directory. You will use the same starter project in the next project, too.</p>
<pre class="shell"><code>git clone https://github.com/-starters/node-web-app-starter native-node-app</code></pre>
Instead of creating a directory named after the repository, "node-web-app-starter", this wil create a directory named "native-node-app" and put the cloned repository into there.</li>
<li>Change the working directory into "native-node-app"</li>
<li>Install the npm dependencies</li>
<li><p>Create a database user named "native_node_app" with the password "oMbE4FNk3db2LwFT" and the CREATEDB privilege which will look like</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb58-1" title="1"><span class="kw">CREATE</span> <span class="fu">USER</span> <span class="op">..</span>. <span class="kw">WITH</span> CREATEDB <span class="kw">PASSWORD</span> <span class="op">..</span>.</a></code></pre></div>
You add the CREATEDB in there so you can do the next step and not be bothered with creating the database yourself</li>
<li>Run the Sequelize CLI with the <code>db:create</code> command to create the database</li>
<li>Run the Sequelize CLI to migrate the database</li>
<li><p>Run the Sequelize CLI to seed the database</p></li>
</ul>
<h2 id="phase-1-installing-one-tool">Phase 1: Installing one tool</h2>
<p>You will use a development tool to restart the server each time you make a change to a JavaScript file. This prevents you from having to hit CTRL+C each time you want to stop and start your server.</p>
<p>The tool is named <a href="https://nodemon.io/">nodemon</a> and is the standard for this type of server restarting. It is a <em>development</em> tool, so you will install it as a special kind of dependency, a <em>development dependency</em>. You can do that with</p>
<pre class="shell"><code>npm install nodemon --save-dev</code></pre>
<p>When you deploy your application to production, npm will ignore the development dependencies because they’re not needed when you run your application for other people to use. Hopefully by that point, your Web application <em>doesn’t restart</em>!</p>
<h2 id="phase-2-getting-the-server-started">Phase 2: Getting the server started</h2>
<p>Open the <strong>package.json</strong> file. It specifies that the "main" file for this project is <strong>server/index.js</strong>. Create a <strong>server</strong> directory and an <strong>index.js</strong> file in there.</p>
<p>Now, in <strong>package.json</strong>, find the "scripts" section. Add a new entry in there named "dev" with the value "nodemon server/index.js". It should look like this.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb60-1" title="1"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb60-2" title="2">  <span class="dt">&quot;dev&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon server/index.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb60-3" title="3">  <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="st">&quot;echo </span><span class="ch">\&quot;</span><span class="st">Error: no test specified</span><span class="ch">\&quot;</span><span class="st"> &amp;&amp; exit 1&quot;</span></a>
<a class="sourceLine" id="cb60-4" title="4"><span class="fu">}</span><span class="er">,</span></a></code></pre></div>
<p>That sets up a way to conveniently run the "nodemon" command by typing the command <code>npm run dev</code>. You can run that right now. Because you have an empty <strong>server/index.js</strong> file, it should report something like this:</p>
<pre><code>[nodemon] starting `node server/index.js server/index.js`
[nodemon] clean exit - waiting for changes before restart</code></pre>
<p>So, it’s just waiting for you to add some code!</p>
<p>To get an HTTP server up and running, you will add code to do the following in the <strong>server/index.js</strong> file.</p>
<ul>
<li>Import the built-in "http" module</li>
<li>Create a server using the "http" module that returns "I have items" to every request</li>
<li>Tell that server to start listening on port 8081</li>
<li>Print a message when the server is ready to accept incoming messages</li>
</ul>
<p>Please look at the sample on the <a href="https://nodejs.org/en/about/">About Node.js®</a> page. It has all of the code that you need to get the above done. You’ll want to change the port number from what it uses to 8081. You’ll also want to change the text it sends to the browser from what it reads to "I have items".</p>
<p>See if you can figure that out on your own. You’ll know you’re done when you open up your browser to http://localhost:8081/ (or refresh it because it’s already there) and see the following.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Web/http-fullstack/assets/http-fullstack-native-i-have-items.png" alt="I have items" /><figcaption>I have items</figcaption>
</figure>
<h2 id="phase-3-understand-the-code">Phase 3: Understand the code</h2>
<p>Hopefully, your code looks similar to the following code.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb62-1" title="1"><span class="kw">const</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;http&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-2" title="2"></a>
<a class="sourceLine" id="cb62-3" title="3"><span class="kw">const</span> hostname <span class="op">=</span> <span class="st">&#39;127.0.0.1&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb62-4" title="4"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb62-5" title="5"></a>
<a class="sourceLine" id="cb62-6" title="6"><span class="kw">const</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>((req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb62-7" title="7">  <span class="va">res</span>.<span class="at">statusCode</span> <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></a>
<a class="sourceLine" id="cb62-8" title="8">  <span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;text/plain&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-9" title="9">  <span class="va">res</span>.<span class="at">end</span>(<span class="st">&#39;I have items&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-11" title="11"></a>
<a class="sourceLine" id="cb62-12" title="12"><span class="va">server</span>.<span class="at">listen</span>(port<span class="op">,</span> hostname<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb62-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Server running at http://</span><span class="sc">${</span>hostname<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">/`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-14" title="14"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Just a reminder: the first three variable declarations and the last call to <code>listen</code> are boilerplate code. Every time you write a Node.js server, you would write the same code over and over. The real meat of the application is in the callback function that you pass to <code>createServer</code>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb63-1" title="1">(req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb63-2" title="2">  <span class="co">// The code here is what matters. This is the stuff</span></a>
<a class="sourceLine" id="cb63-3" title="3">  <span class="co">// that handles requests from the browser and sends</span></a>
<a class="sourceLine" id="cb63-4" title="4">  <span class="co">// content back to it.</span></a>
<a class="sourceLine" id="cb63-5" title="5"><span class="op">}</span></a></code></pre></div>
<p>The first parameter is the "request" object and is of type <code>http.IncomingMessage</code> (<a href="https://nodejs.org/api/http.html#http_class_http_incomingmessage">link</a>). The second parameter is the "response" object and is of type <code>http.ServerResponse</code> (<a href="https://nodejs.org/api/http.html#http_class_http_serverresponse">link</a>).</p>
<p>In the code that you wrote, you set the status code of the response to 200 which means "OK", if you recall. Then, you set the content type of the content of the response to "text/plain" which means the browser should just show the content as plain text. Finally, you use the <code>end</code> method to send some content <em>and</em> end the response.</p>
<p>That last part is <em>very</em> important. If you don’t end the response, the browser will just hang, waiting, expecting more from your server.</p>
<p>In this project, you will use more methods and properties of the <code>IncomingMessage</code> and <code>ServerResponse</code> objects to get your application working.</p>
<h2 id="phase-4-showing-images">Phase 4: Showing images</h2>
<p>In the <strong>assets/images</strong> directory of this project are four images that your server should be able to show. (And more, if you add more.)</p>
<p>A normal thing to do is to translate a URL to a path relative to your application’s root directory. For example, say you typed the following URL into your browser.</p>
<pre><code>http://localhost:8081/images/thread.jpeg</code></pre>
<p>It would make sense to have the server send back the content of <strong>assets/images/thread.jpeg</strong> so the browser can show it. That’s what you will do in this step, but for any of the images.</p>
<p>You’ll need a way to read the contents of each file. The modern way to do this is to use the Promises-based portion of the file system library. At the top of your <strong>index.js</strong>, import the <code>readFile</code> function from the "promises" property of "fs" library.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb65-1" title="1"><span class="kw">const</span> <span class="op">{</span> readFile <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;fs&#39;</span>).<span class="at">promises</span><span class="op">;</span></a></code></pre></div>
<p>You will use the <code>await</code> keyword with that function, so you need to change the signature of the callback method that you pass to the <code>createServer</code> method. Note the addition of the <code>async</code> keyword before the parameter list.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb66-1" title="1"><span class="kw">const</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a></code></pre></div>
<p>Again, you will map requests for images to the corresponding file in the <strong>images</strong> directory. It looks like this.</p>
<pre><code>http://localhost:8081/images/filename.ext
                     \__________________/
                              |
                 +------------+
          _______|_________
         /                 \
./assets/images/filename.ext</code></pre>
<p>If the image exists, you’ll send the contents of the image to the browser. If it does not, then you will tell the browser that it does not exist by sending a 404 NOT FOUND status code.</p>
<h3 id="phase-4a-the-happy-path">Phase 4a: The happy path</h3>
<p>To determine if the path is one that you want, at the top of your <code>async</code> callback, put an if statement that tests if the <code>req.url</code> property (which is a string) starts with "/images/". Replace the comment below to do that.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb68-1" title="1"><span class="kw">const</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>((req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb68-2" title="2">  <span class="cf">if</span> (<span class="co">/* req.url start with &quot;/images&quot; */</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb68-3" title="3"></a>
<a class="sourceLine" id="cb68-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb68-5" title="5"></a>
<a class="sourceLine" id="cb68-6" title="6"></a>
<a class="sourceLine" id="cb68-7" title="7">  <span class="va">res</span>.<span class="at">statusCode</span> <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></a>
<a class="sourceLine" id="cb68-8" title="8">  <span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;text/plain&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb68-9" title="9">  <span class="va">res</span>.<span class="at">end</span>(<span class="st">&#39;I have items&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb68-10" title="10"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>If the test passes, that means that <code>req.url</code> will contain a string like "/images/thread.jpeg". That means that you will want to load the file from "./assets/images/thread.jpeg" which is the concatenation of the string "./assets" and the value of <code>req.url</code>. This code goes inside the <code>if</code> block.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb69-1" title="1"><span class="kw">const</span> imageFilePath <span class="op">=</span> <span class="st">&#39;./assets&#39;</span> <span class="op">+</span> <span class="va">req</span>.<span class="at">url</span><span class="op">;</span></a>
<a class="sourceLine" id="cb69-2" title="2"><span class="kw">const</span> imageFileContents <span class="op">=</span> <span class="cf">await</span> <span class="at">readFile</span>(imageFilePath)<span class="op">;</span></a></code></pre></div>
<p>Notice that you <strong>did not</strong> specify ‘utf-8’ as part of the <code>readFile</code> call. That’s because the content of an image file is <strong>not</strong> UTF-8 encoded text. Instead, it’s binary. This way without the encoding just returns the raw data that is then sent to the browser.</p>
<p>After that, you need to should set the status code of the response to 200 to indicate everything is OK. Then, you need to set the content type which takes a little bit of figuring, so you can delay that for just a moment. Assume that the browser has requested an image in the JPEG format. Finally, you end the response by sending the data of the file that you read.</p>
<p>Add this code inside the <code>if</code> block after reading the file’s contents.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb70-1" title="1"><span class="va">res</span>.<span class="at">statusCode</span> <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></a>
<a class="sourceLine" id="cb70-2" title="2"><span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;image/jpeg&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-3" title="3"><span class="va">res</span>.<span class="at">end</span>(imageFileContents)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-4" title="4"><span class="cf">return</span><span class="op">;</span></a></code></pre></div>
<p>The <code>return</code> at the end prevents any other code after it to run, that code at the bottom that sends back plain text.</p>
<p>You should now be able to see any of the following in your browser!</p>
<ul>
<li>http://localhost:8081/images/thread.jpeg</li>
<li>http://localhost:8081/images/horseshoe.jpeg</li>
<li>http://localhost:8081/images/lint.jpeg</li>
</ul>
<p>Most likely, you can also see the following image, too.</p>
<ul>
<li>http://localhost:8081/images/gravel.png</li>
</ul>
<p>That’s because browsers are really for giving. Even though you tell the browser that you are sending JPEG data with the content type "image/jpeg", the browser inspects the data and figures out it’s an image in the PNG format. But, you should not rely on the forgiveness of the browser. Instead, you should determine the type of image format the file contains from the file extension, either ".jpeg" or ".png". Then, you send back "image/jpeg" or "image/png" based on the file extension.</p>
<p>You can use the built-in "path" library to determine the file extension. Then, you can use that information to send back the correct image format type in the <code>setHeader</code> method.</p>
<p>At the top of the <strong>index.js</strong> file, import the "path" library.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb71-1" title="1"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;path&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Here’s a link to the "path" library: https://nodejs.org/api/path.html. Find the method that will extract the file extension from a path. Then, use that in your code to send back the correct image type.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb72-1" title="1"><span class="kw">const</span> fileExtension <span class="op">=</span> <span class="co">/* Use the path library to get the file extension */</span><span class="op">;</span></a>
<a class="sourceLine" id="cb72-2" title="2"><span class="kw">const</span> imageType <span class="op">=</span> <span class="st">&#39;image/&#39;</span> <span class="op">+</span> <span class="va">fileExtension</span>.<span class="at">substring</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb72-3" title="3"><span class="va">res</span>.<span class="at">statusCode</span> <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></a>
<a class="sourceLine" id="cb72-4" title="4"><span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> imageType)<span class="op">;</span> <span class="co">// Use the image type</span></a></code></pre></div>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Web/http-fullstack/assets/http-fullstack-native-proper-image-type.png" alt="Proper image type" /><figcaption>Proper image type</figcaption>
</figure>
<p>Make sure you still see "I have items" when you go to http://localhost:8081.</p>
<h2 id="phase-4b-no-image-found">Phase 4b: No image found</h2>
<p>Try accessing this URL: images/unknown.png. You will see an error message in your console about an unhandled promise rejection not being able to open ‘./assets/images/unknown.png’. Worse yet, the browser is just hanging. That’s because this line of code:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb73-1" title="1"><span class="kw">const</span> imageFileContents <span class="op">=</span> <span class="cf">await</span> <span class="at">readFile</span>(imageFilePath)<span class="op">;</span></a></code></pre></div>
<p>threw an error, it wasn’t handled, and the <code>end</code> method never gets called on the response object. That means the browser just waits and waits and waits.</p>
<p>If you get a request for an image that does not exist, you can just catch this error and send back a 404 and no content. Replace that single line of code above with this block of code.</p>
<p>Wrap that line of code above in a <code>try</code>/<code>catch</code> block. In the <code>catch</code> block, set the status code of the response to 404. Then, just call the <code>end</code> method of the response with no parameters. The last statement of the <code>catch</code> block should be a <code>return;</code> statement to prevent other code from running after you handle this error.</p>
<p>You’ll have to fix the declaration of the <code>imageFileContents</code> variable so that it works.</p>
<p>Refresh the browser. You should now get a 404 page when you try to access an image that does not exist. You should see the images that do exist when you go to their corresponding URLs.</p>
<p>Make sure you still see "I have items" when you go to http://localhost:8081.</p>
<h2 id="phase-5-showing-a-static-html-page">Phase 5: Showing a static HTML page</h2>
<p>Here’s some HTML that shows a form that you will use to add new items to the database. You will serve this statically. That means you won’t change any of its contents. Instead, you’ll just read the file from disk and send it to the browser.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb74-1" title="1"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></a>
<a class="sourceLine" id="cb74-2" title="2"><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb74-3" title="3"><span class="kw">&lt;head&gt;</span></a>
<a class="sourceLine" id="cb74-4" title="4">  <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;UTF-8&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb74-5" title="5">  <span class="kw">&lt;title&gt;</span>Add an item<span class="kw">&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb74-6" title="6"><span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb74-7" title="7"><span class="kw">&lt;body&gt;</span></a>
<a class="sourceLine" id="cb74-8" title="8">  <span class="kw">&lt;header&gt;</span></a>
<a class="sourceLine" id="cb74-9" title="9">    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/&quot;</span><span class="kw">&gt;</span>Back to the main page<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb74-10" title="10">  <span class="kw">&lt;/header&gt;</span></a>
<a class="sourceLine" id="cb74-11" title="11">  <span class="kw">&lt;main&gt;</span></a>
<a class="sourceLine" id="cb74-12" title="12">    <span class="kw">&lt;form</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="ot"> action=</span><span class="st">&quot;/items&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb74-13" title="13">      <span class="kw">&lt;div&gt;</span></a>
<a class="sourceLine" id="cb74-14" title="14">        <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;name&quot;</span><span class="kw">&gt;</span>Name<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb74-15" title="15">        <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;name&quot;</span><span class="ot"> id=</span><span class="st">&quot;name&quot;</span><span class="ot"> required</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb74-16" title="16">      <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb74-17" title="17">      <span class="kw">&lt;div&gt;</span></a>
<a class="sourceLine" id="cb74-18" title="18">        <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;description&quot;</span><span class="kw">&gt;</span>Description<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb74-19" title="19">        <span class="kw">&lt;textarea</span><span class="ot"> name=</span><span class="st">&quot;description&quot;</span><span class="ot"> id=</span><span class="st">&quot;description&quot;</span><span class="ot"> required</span><span class="kw">&gt;&lt;/textarea&gt;</span></a>
<a class="sourceLine" id="cb74-20" title="20">      <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb74-21" title="21">      <span class="kw">&lt;div&gt;</span></a>
<a class="sourceLine" id="cb74-22" title="22">        <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;amount&quot;</span><span class="kw">&gt;</span>Starting amount<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb74-23" title="23">        <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;amount&quot;</span><span class="ot"> id=</span><span class="st">&quot;amount&quot;</span><span class="ot"> required</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb74-24" title="24">      <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb74-25" title="25">      <span class="kw">&lt;div&gt;</span></a>
<a class="sourceLine" id="cb74-26" title="26">        <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="kw">&gt;</span>Create a new item<span class="kw">&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb74-27" title="27">      <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb74-28" title="28">    <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb74-29" title="29">  <span class="kw">&lt;/main&gt;</span></a>
<a class="sourceLine" id="cb74-30" title="30"><span class="kw">&lt;/body&gt;</span></a>
<a class="sourceLine" id="cb74-31" title="31"><span class="kw">&lt;/html&gt;</span></a></code></pre></div>
<p>You’ll learn a lot more about forms, this week. There are three things to note about this form.</p>
<ul>
<li>The "method" attribute of the <code>form</code> element is "post" which means the value of <code>req.method</code> in our request handler will be "POST". (It is always uppercase when read from the <code>req.method</code> property.)</li>
<li>The "action" attribute of the <code>form</code> element is "/items". That will be the value of <code>req.url</code> that you will need to check when you want to handle the form submission.</li>
<li>The "name" attribute of the <code>input</code> and <code>textarea</code> (and all form elements) are the keys that we will use to get the values that a person supplies by typing into the form.</li>
</ul>
<p>Create a <strong>views</strong> directory in the root of your project. Save the HTML into a file there named <strong>add-item.html</strong>.</p>
<figure>
<img src="images/http-fullstack-native-new-views-directory.png" alt="add-item.html in views directory" /><figcaption>add-item.html in views directory</figcaption>
</figure>
<p>To serve this HTML, create a new <code>if</code> block that checks to see if the value of the <code>req.url</code> property is equal to "/items/new". If it is, then do what you did with the images. The path to the HTML file should be "./views/add-item.html". Read the file’s contents. Set the status code to 200. Set the content type to "text/html". Send the content of the file to the browser and end the response. Use a <code>return;</code> statement to make sure no other code runs.</p>
<p>When you get that working, you should be able to navigate to http://localhost:8081/items/new and see this.</p>
<figure>
<img src="images/http-fullstack-native-serving-static-form.png" alt="seeing form in the browser" /><figcaption>seeing form in the browser</figcaption>
</figure>
<h2 id="phase-6-first-step-in-dynamic-content">Phase 6: First step in dynamic content</h2>
<p>Navigate your browser back to http://localhost:8081 where you see "I have items". (If that’s not working, figure out how it broke and fix it.) Now, you will query the database for the number of items in it and report it. Instead of seeing "I have items", it should report something like "I have 4 items".</p>
<p>This is primarily Sequelize code. At the top of <strong>index.js</strong>, import the Item model.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb75-1" title="1"><span class="kw">const</span> <span class="op">{</span> Item <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../models&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Down at the bottom of your callback after your <code>if</code> blocks and before the line that reads <code>res.statusCode = 200;</code>, use the <code>findAll</code> method of the Item model to get all of the items in the database. That should return an array of the objects. Use the length of that array to show the current number of items in the database by changing <code>res.end('I have items');</code> to include the number of items.</p>
<figure>
<img src="images/http-fullstack-native-show-number-of-items.png" alt="seeing number of items in the browser" /><figcaption>seeing number of items in the browser</figcaption>
</figure>
<p>It may surprise you to learn that this is really what most Web applications do. Read some data from a database. Use that data to generate some content. Send the content to the browser. That’s the simple recipe.</p>
<p>Do something real quick before the next phase. Instead of serving plain text, here, change that content type to serve HTML. Then, in whatever string you’re passing to the <code>res.end</code> method, add this HTML snippet at the beginning of it so you can easily get to the "add a new item" form.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb76-1" title="1"><span class="kw">&lt;div&gt;&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/items/new&quot;</span><span class="kw">&gt;</span>Add a new item<span class="kw">&lt;/a&gt;&lt;/div&gt;</span></a></code></pre></div>
<figure>
<img src="images/http-fullstack-native-with-link-to-add-form.png" alt="seeing number of items with a link" /><figcaption>seeing number of items with a link</figcaption>
</figure>
<p>Test the link by clicking on it. It should take you to the form.</p>
<h2 id="phase-7-handling-the-adding-of-an-item">Phase 7: Handling the adding of an item</h2>
<p>Now’s the time to handle the adding of an item from that form! Click the link to get to the add the form or navigate to http://localhost:8081/items/new in your browser. If you fill out the form and click the button, it just takes you back to the main page and doesn’t do anything. It’s time to change that.</p>
<p>Add a new <code>if</code> block that checks that <em>both</em> of these conditions are true:</p>
<ul>
<li>The value of <code>req.url</code> is equal to "/items"</li>
<li>The value of <code>req.method</code> is equal to "POST"</li>
</ul>
<p>Inside that <code>if</code> block is where you will handle the data that someone sends to the server through the form. You’ll use it to create a new Item and save it to the database. Then, you’ll redirect back to the main page.</p>
<h3 id="phase-7a-getting-the-submitted-data">Phase 7a: Getting the submitted data</h3>
<p>Open up your developer tools. On the Network tab, click the "Preserve log" checkbox above the timeline. Then, fill out the form and click the "Create a new item" button. That will make the request. Select the "items" entry in the list of network requests below the timeline. You should see a section entitled <strong>Form Data</strong>. Click the "view source" link.</p>
<figure>
<img src="images/http-fullstack-native-form-contents-with-urlencoded-request-body.png" alt="seeing the submitted data" /><figcaption>seeing the submitted data</figcaption>
</figure>
<p>What you see is likely like this, but with whatever values you put in the fields.</p>
<pre><code>name=Shoe&amp;description=I+have+one+shoe+that+I+cant+seem+to+find+its+pair.+So%2C+I+guess+I+have+one+of+those.&amp;amount=1</code></pre>
<p>That’s the content that is sent with the HTTP request to your server. The full HTTP request looks something like</p>
<pre><code>POST /items HTTP/1.1
Host: localhost:8081
Content-Type: application/x-www-form-urlencoded
Content-Length: 116
... more headers ...

name=Shoe&amp;description=I+have+one+shoe+that+I+cant+seem+to+find+its+pair.+So%2C+I+guess+I+have+one+of+those.&amp;amount=1</code></pre>
<p>That’s the "URL encoded" format that you read about in the Five Parts Of A URL reading. You’ll parse that in the next step. What you have to do, now, is get it from the <code>IncomingMessage</code> object. That object is a readable stream, so you will read the bytes from the stream and turn them into a string to use in the next step.</p>
<p>When your callback is invoked by the server object, it has <em>only</em> read the headers portion of the HTTP request. The body of the HTTP request (if there is one) could still be traveling over the airwaves and wires from your computer to the server. This way, your Web application can look at the values in the headers and determine whether or not it wants to even respond. Maybe the content length is 400Gb. You don’t want your server spending however long it takes to read all of that data, so you can just end it.</p>
<p>To do this easily, you will use a variety of the <code>for</code> loop that works with asynchronous iterable values as well as normal one. It is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for-await...of">for await…of</a> loop. Like the <code>for of</code> loop, it loops over values rather than indexes. But, the value after the <code>of</code> can return Promises which the for loop will wait on for them to resolve before invoking the block of code.</p>
<p>That’s a lot of words. Here’s what it looks like. Put this in your <code>if</code> block that handles "POST /items".</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb79-1" title="1"><span class="kw">let</span> body <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb79-2" title="2"><span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> req) <span class="op">{</span></a>
<a class="sourceLine" id="cb79-3" title="3">  body <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb79-4" title="4"><span class="op">}</span></a>
<a class="sourceLine" id="cb79-5" title="5"><span class="co">// body now contains all of the data</span></a>
<a class="sourceLine" id="cb79-6" title="6"><span class="co">// from the request</span></a></code></pre></div>
<p>This works because <code>req</code> is an <code>IncomingMessage</code> message object which inherits from <code>ReadableStream</code> which implements the <a href="https://nodejs.org/api/stream.html#stream_readable_symbol_asynciterator">asynchronous iterator</a> property.</p>
<h3 id="phase-7b-parsing-the-submitted-data">Phase 7b: Parsing the submitted data</h3>
<p>Now that you have all of the data in the <code>body</code> variable, it’s time to split it up into the data that you want. From the form, it will look like this as a raw string:</p>
<pre><code>name=value1&amp;description=value2&amp;amount=value3</code></pre>
<p>Use string manipulation to break that into its separate pieces so that you can access each of key value pairs.</p>
<ul>
<li>Split the string on ampersands, first.</li>
<li>Split each value from the previous step on equal signs.</li>
</ul>
<p>To handle the encoded values on the right side of the equal sign, it is a two-step process:</p>
<ul>
<li>Replace each of the "+" characters with a space. You have to use a global regular expression to do this with the <code>replace</code> method because JavaScript will only replace the first occurrence in the string without a global regular expression. If the value is in a variable named <code>s</code>, you would call <code>s.replace(/\+/g, ' ')</code> to replace all of the "+’ characters in a string with spaces.</li>
<li>After replacing the plusses, take the value and pass it to the <code>decodeURIComponent</code> function which will go about translating the percent-sign encoded values into single characters.</li>
</ul>
<h3 id="phase-7c-create-an-item">Phase 7c: Create an Item</h3>
<p>You should have the data broken into pieces that you can now access. Use your Item model to build and save (or create) a new item.</p>
<h3 id="phase-7d-redirect-the-browser">Phase 7d: Redirect the browser</h3>
<p>Redirecting the browser to go to another URL is a two-step process, too. You send back status code 302. You also set the header "Location" to the URL that you want it to navigate to. For this project, set the "Location" to "/". Then end the response.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Web/http-fullstack/assets/http-fullstack-native-show-form-completion.gif" alt="show form completion" /><figcaption>show form completion</figcaption>
</figure>
<p>Make sure that you use a <code>return</code> statement or something to prevent the default code at the bottom of your request handler from running.</p>
<h2 id="phase-8-generate-dynamic-content">Phase 8: Generate dynamic content</h2>
<p>At the bottom of your handler, you’ve already queried the items in your Item objects from the database. Now, it is time to show the items rather than just displaying how many are in the database.</p>
<p>You can use the <code>write</code> method of the <code>ServerResponse</code> object in the <code>res</code> to write your HTML to the browser as you’re generating it. Your code may look something like this.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb81-1" title="1"><span class="kw">const</span> items <span class="op">=</span> <span class="cf">await</span> <span class="va">Item</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb81-2" title="2"><span class="va">res</span>.<span class="at">statusCode</span> <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></a>
<a class="sourceLine" id="cb81-3" title="3"><span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;text/html&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb81-4" title="4"><span class="va">res</span>.<span class="at">end</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb81-5" title="5"><span class="vs">  &lt;div&gt;&lt;a href=&quot;/items/new&quot;&gt;Add a new item&lt;/a&gt;&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb81-6" title="6"><span class="vs">  I have </span><span class="sc">${</span><span class="va">items</span>.<span class="at">length</span><span class="sc">}</span><span class="vs"> items</span></a>
<a class="sourceLine" id="cb81-7" title="7"><span class="vs">`</span>)<span class="op">;</span></a></code></pre></div>
<p>Take a look at this code which just expands on the previous block. It writes the proper beginning of an HTML document, then writes the dynamic content, then ends it with the proper end of an HTML document.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb82-1" title="1"><span class="kw">const</span> items <span class="op">=</span> <span class="cf">await</span> <span class="va">Item</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb82-2" title="2"><span class="va">res</span>.<span class="at">statusCode</span> <span class="op">=</span> <span class="dv">200</span><span class="op">;</span></a>
<a class="sourceLine" id="cb82-3" title="3"><span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;text/html&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb82-4" title="4"><span class="va">res</span>.<span class="at">write</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb82-5" title="5"><span class="vs">  &lt;!DOCTYPE html&gt;</span></a>
<a class="sourceLine" id="cb82-6" title="6"><span class="vs">  &lt;html lang=&quot;en&quot;&gt;</span></a>
<a class="sourceLine" id="cb82-7" title="7"><span class="vs">  &lt;head&gt;</span></a>
<a class="sourceLine" id="cb82-8" title="8"><span class="vs">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></a>
<a class="sourceLine" id="cb82-9" title="9"><span class="vs">    &lt;title&gt;Inventory&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb82-10" title="10"><span class="vs">  &lt;/head&gt;</span></a>
<a class="sourceLine" id="cb82-11" title="11"><span class="vs">  &lt;body&gt;</span></a>
<a class="sourceLine" id="cb82-12" title="12"><span class="vs">    &lt;header&gt;</span></a>
<a class="sourceLine" id="cb82-13" title="13"><span class="vs">      &lt;div&gt;&lt;a href=&quot;/items/new&quot;&gt;Add a new item&lt;/a&gt;&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb82-14" title="14"><span class="vs">    &lt;/header&gt;</span></a>
<a class="sourceLine" id="cb82-15" title="15"><span class="vs">    &lt;main&gt;`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb82-16" title="16"></a>
<a class="sourceLine" id="cb82-17" title="17"><span class="va">res</span>.<span class="at">write</span>(<span class="vs">`I have </span><span class="sc">${</span><span class="va">items</span>.<span class="at">length</span><span class="sc">}</span><span class="vs"> items`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb82-18" title="18"></a>
<a class="sourceLine" id="cb82-19" title="19"><span class="va">res</span>.<span class="at">end</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb82-20" title="20"><span class="vs">    &lt;/main&gt;</span></a>
<a class="sourceLine" id="cb82-21" title="21"><span class="vs">  &lt;/body&gt;</span></a>
<a class="sourceLine" id="cb82-22" title="22"><span class="vs">  &lt;/html&gt;`</span>)<span class="op">;</span></a></code></pre></div>
<p>In the place where there’s only the one line of dynamic content, change it to have something else, something that shows the name of the item, the amount of them you have, and the associated image, if <code>imageName</code> is not <code>null</code> or <code>undefined</code>.</p>
<p>The following screenshot shows where an open <code>table</code> tag has been added to the end of the string for the first write, a close <code>table</code> tag has been added to the beginning of the string of the <code>res.end</code> call, and looping is used to create a new table row (<code>tr</code>) with table data (<code>td</code>) for each of the properties of the Item.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Web/http-fullstack/assets/http-fullstack-native-show-table-of-items.png" alt="table of items" /><figcaption>table of items</figcaption>
</figure>
<p>It looks, in part, like this.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb83-1" title="1"><span class="cf">for</span> (<span class="kw">let</span> item <span class="kw">of</span> items) <span class="op">{</span></a>
<a class="sourceLine" id="cb83-2" title="2">  <span class="va">res</span>.<span class="at">write</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb83-3" title="3"><span class="vs">    &lt;tr&gt;&lt;/td&gt;</span></a>
<a class="sourceLine" id="cb83-4" title="4"><span class="vs">  `</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb83-5" title="5"></a>
<a class="sourceLine" id="cb83-6" title="6">  <span class="co">// Only write an IMG tag if there is a value</span></a>
<a class="sourceLine" id="cb83-7" title="7">  <span class="co">// in imageName</span></a>
<a class="sourceLine" id="cb83-8" title="8"></a>
<a class="sourceLine" id="cb83-9" title="9">  <span class="va">res</span>.<span class="at">write</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb83-10" title="10"><span class="vs">    &lt;/td&gt;</span></a>
<a class="sourceLine" id="cb83-11" title="11"></a>
<a class="sourceLine" id="cb83-12" title="12"><span class="vs">    &lt;!-- Write more TDs here with the details of the item --&gt;</span></a>
<a class="sourceLine" id="cb83-13" title="13"></a>
<a class="sourceLine" id="cb83-14" title="14"><span class="vs">    &lt;td&gt;`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb83-15" title="15">  <span class="cf">if</span> (<span class="va">item</span>.<span class="at">amount</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb83-16" title="16">    <span class="va">res</span>.<span class="at">write</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb83-17" title="17"><span class="vs">      &lt;form method=&quot;post&quot; action=&quot;/items/</span><span class="sc">${</span><span class="va">item</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">/used&quot;&gt;</span></a>
<a class="sourceLine" id="cb83-18" title="18"><span class="vs">        &lt;button type=&quot;submit&quot;&gt;Use one&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb83-19" title="19"><span class="vs">      &lt;/form&gt;</span></a>
<a class="sourceLine" id="cb83-20" title="20"><span class="vs">    `</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb83-21" title="21">  <span class="op">}</span></a>
<a class="sourceLine" id="cb83-22" title="22">  <span class="va">res</span>.<span class="at">write</span>(<span class="vs">`&lt;/td&gt;</span></a>
<a class="sourceLine" id="cb83-23" title="23"><span class="vs">  &lt;/tr&gt;`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb83-24" title="24"><span class="op">}</span></a></code></pre></div>
<p>As seen above, for each item, you should also create a form that has the following content for items with an amount greater than 0.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb84-1" title="1"><span class="kw">&lt;form</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="ot"> action=</span><span class="st">&quot;/items/«item id»/used&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb84-2" title="2">  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="kw">&gt;</span>Use one<span class="kw">&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb84-3" title="3"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>That’s the last handler that you’ll write to complete the project!</p>
<h2 id="phase-9">Phase 9</h2>
<p>When there is a POST request to the path "/items/«item id»/used", you want to reduce the amount by 1 of the item specified by the «item id» in the path. Write another <code>if</code> block that handles that HTTP request. Parse the id from the path. Use that id to get the Item from the database. Reduce the amount by 1. Save the Item back to the database. Redirect back to "/".</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-Web/http-fullstack/assets/http-fullstack-native-show-final-app.gif" alt="final app" /><figcaption>final app</figcaption>
</figure>
<h2 id="complete">Complete!</h2>
<p>That was quite a ride! You created a full-stack Web application! You pulled data from a database to generate HTML. You sent the HTML to the browser. You handled requests, both GET and POST, from the browser to interact with and modify the data in the database. This is literally what Web developers do every single day.</p>
<p>Except with better tools. Tools like you learn about tomorrow.</p>
<hr />
<h1 id="week-11-day-2-hello-express" data-ignore="true">WEEK-11 DAY-2<br><em>Hello, Express!</em></h1>
<hr />
<h1 id="express-learning-objectives">Express Learning Objectives</h1>
<p>Express is the <em>de facto</em> standard for building HTTP applications with Node.js. When you complete this lesson, you should be able to</p>
<ul>
<li>Send plain text responses for any HTTP request</li>
<li>Use pattern matching to match HTTP request paths to route handlers</li>
<li>Use the Pug template engine to generate HTML from Pug templates to send to the browser</li>
<li>Pass data to Pug templates to generate dynamic content</li>
<li>Use the <code>Router</code> class to modularize the definition of routes</li>
</ul>
<hr />
<h1 id="pug-template-learning-objectives">Pug Template Learning Objectives</h1>
<p>Using Pug.js helps reduce the overall creation and maintenance of source code for HTML generation. It is one of many template engines supported by Express.js and remains one of the most popular. At the end of this lesson, you will be able to effectively use Pug.js to</p>
<ul>
<li>Declare HTML tags and their associated ids, classes, attributes, and content</li>
<li>Use conditional statements to determine whether or not to render a block</li>
<li>Use interpolation to mix static text and dynamic values in content and attributes</li>
<li>Use iteration to generate multiple blocks of HTML based on data provided to the template</li>
</ul>
<hr />
<h1 id="moving-into-the-express-lane">Moving Into the Express Lane</h1>
<p>In an earlier lesson, you created a simple HTTP server using JavaScript and Node.js. That HTTP server, or web application, returned a simple response based upon the incoming request’s URL (and HTTP method in one case). For example, a request to the URL <code>http://localhost:300/OK</code> returned a <code>200 OK</code> HTTP response status code.</p>
<p>Overall, this was easy to do using Node’s native APIs, though the requirements were relatively straightforward. Using Node to create a web application with features commonly found in websites unfortunately requires a fair amount of boilerplate code (i.e. verbose, repetitive code). This can slow down and distract developers from working on more important tasks.</p>
<p>Enter Express, a popular Node.js framework for building web applications. Express aims to make common web development tasks easier to implement by reducing the amount of boilerplate code you need to write. This allows you to focus on the things that makes your web application special. At the same time, Express is, in its own words, unopinionated and minimalistic, giving you the flexibility to decide what’s best for your situation.</p>
<p>As an introduction to Express, let’s create a simple web application. Your application will return a plain text response containing "Hello from Express!" for any request to <code>http://localhost:8081/</code>.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Use the <code>express()</code> function to create an Express application;</li>
<li>Recall that routing is determining how an application responds to a client request to a specific URI (or path) and HTTP method combination;</li>
<li>Use the Application <code>get()</code> method to define a route that handles <code>GET</code> requests;</li>
<li>Use the Response object <code>res.send()</code> method to send a plain text response to a client; and</li>
<li>Use the <code>app.listen()</code> method to start a server listening for HTTP connections on a specific port.</li>
</ul>
<h2 id="installing-express">Installing Express</h2>
<p>Before you can use Express to create a web application, you need to install it using npm. Open a terminal or command prompt window, browse to your project’s folder, and initialize npm by running the following command:</p>
<pre><code>npm init -y</code></pre>
<p>You’ll now have <code>package.json</code> and <code>package-lock.json</code> files in the root of your project. The <code>package.json</code> file keeps track of your application’s dependencies—npm packages that your application needs to successfully start and run.</p>
<p>Run the following command to install Express 4.0:</p>
<pre><code>npm install express@^4.0.0</code></pre>
<p>The <code>package.json</code> file will now list Express as a dependency:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb87-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb87-2" title="2"> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;my-project-folder-name&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb87-3" title="3"> <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb87-4" title="4"> <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb87-5" title="5"> <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;index.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb87-6" title="6"> <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb87-7" title="7">   <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="st">&quot;echo </span><span class="ch">\&quot;</span><span class="st">Error: no test specified</span><span class="ch">\&quot;</span><span class="st"> &amp;&amp; exit 1&quot;</span></a>
<a class="sourceLine" id="cb87-8" title="8"> <span class="fu">},</span></a>
<a class="sourceLine" id="cb87-9" title="9"> <span class="dt">&quot;keywords&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb87-10" title="10"> <span class="dt">&quot;author&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb87-11" title="11"> <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;ISC&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb87-12" title="12"> <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb87-13" title="13">   <span class="dt">&quot;express&quot;</span><span class="fu">:</span> <span class="st">&quot;^4.17.1&quot;</span></a>
<a class="sourceLine" id="cb87-14" title="14"> <span class="fu">}</span></a>
<a class="sourceLine" id="cb87-15" title="15"><span class="fu">}</span></a></code></pre></div>
<blockquote>
<p>At the time of this writing, the latest version of Express 4.0 is <code>4.17.1</code>. While newer minor or patch versions of Express 4.0 should work fine, newer major versions (5.0+) might not work as expected. The caret character (<code>^</code>) the precedes the version number in the <code>package.json</code> file (<code>^4.17.1</code>) instructs npm to allow versions greater than <code>4.17.1</code> and less than <code>5.0.0</code>.</p>
</blockquote>
<h3 id="git-and-the-node_modules-folder">Git and the <code>node_modules</code> folder</h3>
<p>In an earlier lesson, you learned that when using <code>npm install</code> to install an npm package locally into your project, npm downloads and installs the specified package to the <code>node_modules</code> folder. Over time, as you install dependencies, the <code>node_modules</code> folder tends to grow to be very large, containing many folders and files.</p>
<p>If you’re using Git for source control, it’s important to add a <code>.gitignore</code> file to the root of your project and add the entry <code>node_modules/</code> so that the <code>node_modules</code> folder won’t be tracked by Git.</p>
<blockquote>
<p>As alternative to creating your own <code>.gitignore</code> file, you can use GitHub’s comprehensive <a href="https://github.com/github/gitignore/blob/master/Node.gitignore"><code>.gitignore</code> file for Node.js projects</a>.</p>
</blockquote>
<h2 id="creating-an-express-application">Creating an Express application</h2>
<p>Now you’re ready to create your Express application!</p>
<p>Add a file named <code>app.js</code> to your project folder and open it in your code editor. Use the <code>require</code> directive to import the <code>express</code> module and assign it to a variable named <code>express</code>. The <code>express</code> variable references a function (exported by the <code>express</code> module) that you can call to create an Express application. Assign the return value from the <code>express</code> function call to a variable named <code>app</code>:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb88-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb88-2" title="2"></a>
<a class="sourceLine" id="cb88-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb88-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a></code></pre></div>
<p>The <code>app</code> variable holds a reference to an Express Application (<code>app</code>) object. You’ll call methods on the <code>app</code> object as you build out your web application.</p>
<h2 id="handling-requests">Handling requests</h2>
<p>Next, you need to configure the routing for your application.</p>
<p>The process of configuring routing is determining how an application should respond to a client request to an endpoint—a specific URI (or path) and HTTP method combination. For example, when a client makes a <code>GET</code> request to your application by browsing to the URL <code>http://localhost:8081/</code>, it should return the plain text response "Hello from Express!".</p>
<blockquote>
<p><strong>Do you remember the parts of a URL?</strong> In the URL <code>http://localhost:8081/</code>, the protocol is <code>http</code>, the domain is <code>localhost</code>, the port is <code>8081</code> (we’ll see in a bit how to configure the port for your application), and the path is <code>/</code>.</p>
</blockquote>
<p>The Express Application (<code>app</code>) object contains a collection of methods for defining an application’s routes:</p>
<ul>
<li><code>get()</code> - to handle <code>GET</code> requests</li>
<li><code>post()</code> - to handle <code>POST</code> requests</li>
<li><code>put()</code> - to handle <code>PUT</code> requests</li>
<li><code>delete()</code> - to handle <code>DELETE</code> requests</li>
</ul>
<p><code>GET</code> and <code>POST</code> are two of the most commonly used HTTP methods, followed by <code>PUT</code> and <code>DELETE</code>.</p>
<blockquote>
<p>See the Express documentation for a <a href="https://expressjs.com/en/4x/api.html#routing-methods">complete list of the available routing methods</a>.</p>
</blockquote>
<p>To define a route to handle <code>GET</code> requests, call the <code>app.get()</code> method passing in the route path and a route handler function:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb89-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb89-2" title="2">  <span class="co">// </span><span class="al">TODO</span><span class="co"> Send a response back to the client.</span></a>
<a class="sourceLine" id="cb89-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Express provides a lot of flexibility with the format of the route path. A route path can be a string, string pattern, regular expression, or an array containing any combination of those. For now, you’ll just use a string, but in later articles you’ll see how to use the other options.</p>
<p>The route handler function is called by Express whenever an incoming request matches the route. The function defines two parameters, <code>req</code> and <code>res</code>, giving you access respectively to the Request and Response objects. The Request (<code>req</code>) object is used to get information about the client request that’s currently being processed. The Response (<code>res</code>) object is used to prepare a response to return to the client.</p>
<p>To send a plain text response to the client, call the <code>res.send()</code> method passing in the desired content:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb90-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb90-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from Express!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb90-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Here’s the code for your application so far:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb91-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb91-2" title="2"></a>
<a class="sourceLine" id="cb91-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb91-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb91-5" title="5"></a>
<a class="sourceLine" id="cb91-6" title="6"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb91-7" title="7"></a>
<a class="sourceLine" id="cb91-8" title="8"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb91-9" title="9">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from Express!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb91-10" title="10"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h2 id="listening-for-http-connections">Listening for HTTP connections</h2>
<p>Great job so far! Now you need to start the server listening for HTTP connections from clients. To do that, call the <code>app.listen()</code> method passing in the desired port to use and an optional callback function:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb92-1" title="1"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb92-2" title="2"></a>
<a class="sourceLine" id="cb92-3" title="3"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>The callback function will be called when the server has started listening for connections. Logging a message to the console gives you an easy way to see when the server is ready for testing.</p>
<p>Here’s the complete code for your application:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb93-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb93-2" title="2"></a>
<a class="sourceLine" id="cb93-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb93-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb93-5" title="5"></a>
<a class="sourceLine" id="cb93-6" title="6"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb93-7" title="7"></a>
<a class="sourceLine" id="cb93-8" title="8"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb93-9" title="9">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from Express!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb93-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb93-11" title="11"></a>
<a class="sourceLine" id="cb93-12" title="12"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb93-13" title="13"></a>
<a class="sourceLine" id="cb93-14" title="14"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb93-15" title="15"></a>
<a class="sourceLine" id="cb93-16" title="16"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<h2 id="testing-your-application">Testing your application</h2>
<p>To test your application, open a terminal or command prompt window, browse to your project’s folder, and run the following command:</p>
<pre><code>node app.js</code></pre>
<p>If your application starts successfully, you’ll see the text "Listening on port 8081…" displayed in the terminal or command prompt window. Next, open a web browser and browse to the address <code>http://localhost:8081/</code>. You should see the text "Hello from Express!" displayed in the browser.</p>
<p>If you see the expected text, congrats! If you don’t, double check the following:</p>
<ul>
<li>Make sure that you started your application by running the command <code>node app.js</code>.</li>
<li>Double check that the URL you entered into your browser’s address bar is <code>http://localhost:8081/</code>.</li>
<li>Check the terminal or command prompt window to see if an error is occurring.</li>
</ul>
<h2 id="what-you-learned">What you learned</h2>
<p>In this article, you learned</p>
<ul>
<li>how to use the <code>express()</code> function to create an Express application;</li>
<li>that routing is determining how an application responds to a client request to a specific URI (or path) and HTTP method combination;</li>
<li>how to use the Application <code>get()</code> method to define a route that handles <code>GET</code> requests;</li>
<li>how to use the Response object <code>res.send()</code> method to send a plain text response to a client; and</li>
<li>how to use the <code>app.listen()</code> method to start a server listening for HTTP connections on a specific port.</li>
</ul>
<h2 id="see-also">See also…</h2>
<p>As you learn about Express, you’ll find it helpful to explore Express’ official documentation at <a href="https://expressjs.com/">expressjs.com</a>.</p>
<hr />
<h1 id="templating---meet-pug">Templating - <em>Meet Pug!</em></h1>
<p>In a previous article, you learned how to use the Response object’s <code>res.send()</code> method to send a plain text response to the client. Sending plain text is, well, plain! A much more common content format when sending a response to browser clients is HTML.</p>
<p>You <strong>could</strong> use the <code>res.send()</code> method to send a string of HTML content to the client:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb95-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb95-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb95-3" title="3"><span class="vs">    &lt;!DOCTYPE html&gt;</span></a>
<a class="sourceLine" id="cb95-4" title="4"><span class="vs">    &lt;html&gt;</span></a>
<a class="sourceLine" id="cb95-5" title="5"><span class="vs">      &lt;head&gt;&lt;title&gt;Welcome&lt;/head&gt;&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb95-6" title="6"><span class="vs">      &lt;body&gt;</span></a>
<a class="sourceLine" id="cb95-7" title="7"><span class="vs">        &lt;h1&gt;Hello from Express!&lt;/h1&gt;</span></a>
<a class="sourceLine" id="cb95-8" title="8"><span class="vs">      &lt;/body&gt;</span></a>
<a class="sourceLine" id="cb95-9" title="9"><span class="vs">    &lt;/html&gt;</span></a>
<a class="sourceLine" id="cb95-10" title="10"><span class="vs">  `</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb95-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>While it works, using this technique is tedious and prone to errors. Can you spot the error in the above HTML (hint: look at the nesting of the HTML elements)?</p>
<p>Luckily, there’s a better way. Developers have used templates (files that contain markup and code) to render HTML content for many years (that’s practically centuries in internet time!) Express integrates with many popular templating engines (libraries that provide support for writing templates). In this article you’ll learn how to use the popular Pug templating engine to render HTML content.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Create a Pug template that contains one or more variables;</li>
<li>Use the <code>app.set()</code> method and the <code>view engine</code> application setting property to configure Express to use the Pug template engine; and</li>
<li>Use the Response object <code>res.render()</code> method to render a Pug template to send an HTML response to a client.</li>
</ul>
<h2 id="what-is-a-template">What is a template?</h2>
<p>A template allows developers to easily combine static and dynamic content. Templates are typically written using a special, proprietary syntax to make it as easy as possible for developers to create content. Here’s an example of a simple Pug template:</p>
<pre class="pug"><code>html
  head
    title Welcome
  body
    h1 Welcome #{username}!</code></pre>
<p>Notice the lack of angle brackets (i.e. <code>&lt;</code> and <code>&gt;</code>) in this example on the <code>html</code>, <code>head</code>, <code>title</code>, <code>body</code>, and <code>h1</code> elements.</p>
<p>You also don’t have to close elements. Pug will take care of that for you. It uses indents to determine which elements are children of other elements. In the above example, <code>head</code> is a child of <code>html</code> because <code>head</code> is indented more than <code>html</code>. When Pug turns that into HTML, it will place the <code>&lt;head&gt;...&lt;/head&gt;</code> element <em>inside</em> the <code>&lt;html&gt;...&lt;/html&gt;</code> element. Look at all the typing that Pug has saved you!</p>
<p>Element content is provided just to the right of the element name. The content for the <code>title</code> element is "Welcome" and the content for the <code>h1</code> element is "Welcome #{username}!".</p>
<p>At runtime, the templating engine combines data (often retrieved from a database) with a template to render the content for the response to return to the client. In the above template, Pug will replace the text <code>#{username}</code> with the <code>username</code> variable value that you give it when you tell express to render that template. Assuming that the <code>username</code> variable is set to the value <code>mycoolusername</code>, Pug would render the following HTML:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb97-1" title="1"><span class="kw">&lt;html&gt;&lt;head&gt;&lt;title&gt;</span>Welcome<span class="kw">&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;</span>Welcome mycoolusername!<span class="kw">&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span></a></code></pre></div>
<blockquote>
<p>Pug, by default, removes indentation and all whitespace between elements. In some rare cases you might need to manually control how whitespace is handled. For information on how to do this, see the <a href="https://pugjs.org/language/plain-text.html#whitespace-control">official Pug documentation</a>.</p>
</blockquote>
<h2 id="rendering-a-simple-template">Rendering a simple template</h2>
<p>Before we further explore Pug’s template syntax, let’s see how to use Express to render a simple template to send a response to a client.</p>
<h3 id="setting-up-the-project">Setting up the project</h3>
<p>Create a folder for your project, open a terminal or command prompt window, browse to your project’s folder, and initialize npm. (You use the <code>-y</code> flag so that you don’t have to answer those annoying questions. <code>npm</code> will just use default values for everything.)</p>
<pre><code>npm init -y</code></pre>
<p>Then install Express using <code>npm</code>.</p>
<pre><code>npm install express</code></pre>
<p>Now you’re ready to create the application. Add a file named <code>app.js</code> to your project folder. Import the <code>express</code> module and assign it to a variable named <code>express</code>, then call the <code>express</code> function and assign the return value to a variable named <code>app</code>:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb100-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb100-2" title="2"></a>
<a class="sourceLine" id="cb100-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb100-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a></code></pre></div>
<p>In the previous article, you used the <code>app.get()</code> method to define a route for handling <code>GET</code> requests. As an alternative to the <code>app.get()</code> method, Express provides a method named <code>all()</code> that can be used to define a route that handles any HTTP method.</p>
<p>Call the <code>app.all()</code> method, passing in an asterisk (<code>*</code>) for the route path and a route handler function that calls the <code>res.send()</code> method to send a plain text response to the client:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb101-1" title="1"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb101-2" title="2"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb101-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from the Pug template example app!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb101-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Remember that the route handler function is called by Express whenever an incoming request matches the route. The function defines two parameters, <code>req</code> and <code>res</code>, giving you access respectively to the Request and Response objects.</p>
<p>The asterisk (<code>*</code>) in the route path is a wildcard character that will match any number of characters in the incoming request’s URL path (e.g. <code>/</code>, <code>/about</code>, <code>/about/foo</code>, and so on). Combining this route path with the <code>get.all()</code> method defines a route that will match any incoming request, regardless of its path or HTTP method.</p>
<blockquote>
<p>This approach is unorthodox and not commonly seen in real world applications. Generally speaking, you should prefer to use the <code>app</code> methods that map to individual HTTP methods. We’re using the <code>app.all()</code> in this article to demonstrate the flexibility that Express provides when defining routes.</p>
</blockquote>
<p>When a route can match any incoming request it can be helpful to know the current request’s method and path. The Request object passed into the route handler function via the <code>req</code> parameter provides information about the incoming request. You can log two Request object properties in particular, <code>req.method</code> and <code>req.path</code>, to the console to see the current request’s method and path:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb102-1" title="1"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb102-2" title="2"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb102-3" title="3">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb102-4" title="4">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb102-5" title="5"></a>
<a class="sourceLine" id="cb102-6" title="6">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from the Pug template example app!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb102-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>The Express Request and Response objects provide a number of helpful properties and methods for working with HTTP requests and responses. To learn more, see the official Express docs for the <a href="https://expressjs.com/en/4x/api.html#req">Request</a> and <a href="https://expressjs.com/en/4x/api.html#res">Response</a> objects.</p>
</blockquote>
<p>Now start the server listening for HTTP connections by calling the <code>app.listen()</code> method:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb103-1" title="1"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb103-2" title="2"></a>
<a class="sourceLine" id="cb103-3" title="3"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb103-4" title="4"></a>
<a class="sourceLine" id="cb103-5" title="5"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Here’s what the code for your application should look like at this point:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb104-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb104-2" title="2"></a>
<a class="sourceLine" id="cb104-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb104-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb104-5" title="5"></a>
<a class="sourceLine" id="cb104-6" title="6"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb104-7" title="7"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb104-8" title="8">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb104-9" title="9">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb104-10" title="10"></a>
<a class="sourceLine" id="cb104-11" title="11">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from the Pug template example app!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb104-12" title="12"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb104-13" title="13"></a>
<a class="sourceLine" id="cb104-14" title="14"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb104-15" title="15"></a>
<a class="sourceLine" id="cb104-16" title="16"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb104-17" title="17"></a>
<a class="sourceLine" id="cb104-18" title="18"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>To test your application, open a terminal, browse to your project’s folder, and run the command:</p>
<pre><code>node app.js</code></pre>
<p>The text "Listening on port 8081…" should display in the terminal or command prompt window. Open a web browser and browse to the address <code>http://localhost:8081/</code> to confirm that the application sends a response containing the plain text "Hello from the Pug template example app!".</p>
<h3 id="creating-a-template">Creating a template</h3>
<p>Templates are stored in the <code>views</code> folder by default. To create a template, add a folder named <code>views</code> to your project, then add a file named <code>layout.pug</code> containing the following code:</p>
<pre class="pug"><code>html
  head
    title= title
  body
    h1= heading</code></pre>
<p>The assignment operator (<code>=</code>) following the <code>title</code> and <code>h1</code> element names instructs Pug to set the content for those elements respectively to the <code>title</code> and <code>heading</code> variables.</p>
<blockquote>
<p>You’ll learn more about how to render data in a Pug template in a later article.</p>
</blockquote>
<h3 id="configuring-express-to-use-a-template-engine">Configuring Express to use a template engine</h3>
<p>Before you can use the Pug template engine in an Express application, you need to install it:</p>
<pre><code>npm install pug@^2.0.0</code></pre>
<p>To configure Express to use Pug as its default template engine, call the <code>app.set()</code> method and set the <code>view engine</code> application setting property to the value <code>pug</code>:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb108-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb108-2" title="2"></a>
<a class="sourceLine" id="cb108-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb108-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb108-5" title="5"></a>
<a class="sourceLine" id="cb108-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb108-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>The <code>view engine</code> property is just one of the available application settings. For a list of available settings see the <a href="https://expressjs.com/en/4x/api.html#app.settings.table">Express documentation</a>.</p>
</blockquote>
<p>Setting the <code>view engine</code> application setting property isn’t required, but it has the following benefits:</p>
<ol type="1">
<li>It makes it clearer to code reviewers that your application is using the Pug template engine; and</li>
<li>You don’t have to supply the file extension of the template when rendering a template (we’ll see how this works next).</li>
</ol>
<h3 id="rendering-a-template">Rendering a template</h3>
<p>Now you’re ready to update your application to use your template. Update your route handler function to call the Response object’s <code>res.render()</code> method, passing in the name of the template:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb109-1" title="1"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb109-2" title="2"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb109-3" title="3">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb109-4" title="4">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb109-5" title="5"></a>
<a class="sourceLine" id="cb109-6" title="6">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb109-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>At this point, if run and test your application, you won’t see any content displayed in the browser.</p>
<blockquote>
<p>If you left your application running in the terminal or command prompt window, you’ll need to stop and restart it so that Node picks up your latest code changes. To do that, press <code>CTRL+C</code> to stop the application and run <code>node app.js</code> to restart the application.</p>
</blockquote>
<p>If you view the source for the page in the browser, you’ll see the following HTML:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb110-1" title="1"><span class="kw">&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span></a></code></pre></div>
<p>Notice that the <code>title</code> and <code>h1</code> elements don’t have any content. The template expects data for the <code>title</code> and <code>heading</code> variables, but you’re currently not passing any data. To fix that, pass an object literal containing <code>title</code> and <code>heading</code> properties as a second argument to the <code>res.render()</code> method call:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb111-1" title="1"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb111-2" title="2"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb111-3" title="3">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb111-4" title="4">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb111-5" title="5"></a>
<a class="sourceLine" id="cb111-6" title="6">  <span class="kw">const</span> pageData <span class="op">=</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Welcome&#39;</span><span class="op">,</span> <span class="dt">heading</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span> <span class="op">};</span></a>
<a class="sourceLine" id="cb111-7" title="7">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> pageData)<span class="op">;</span></a>
<a class="sourceLine" id="cb111-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now if run and test your application, you should see the expected content displayed in the browser.</p>
<p>Here’s what the code for your application should look like after updating it to render the Pug template:</p>
<p><strong>app.js</strong></p>
<div class="sourceCode" id="cb112"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb112-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb112-2" title="2"></a>
<a class="sourceLine" id="cb112-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb112-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb112-5" title="5"></a>
<a class="sourceLine" id="cb112-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb112-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb112-8" title="8"></a>
<a class="sourceLine" id="cb112-9" title="9"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb112-10" title="10"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb112-11" title="11">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb112-12" title="12">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb112-13" title="13"></a>
<a class="sourceLine" id="cb112-14" title="14">  <span class="kw">const</span> pageData <span class="op">=</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Welcome&#39;</span><span class="op">,</span> <span class="dt">heading</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span> <span class="op">};</span></a>
<a class="sourceLine" id="cb112-15" title="15">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> pageData)<span class="op">;</span></a>
<a class="sourceLine" id="cb112-16" title="16"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb112-17" title="17"></a>
<a class="sourceLine" id="cb112-18" title="18"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb112-19" title="19"></a>
<a class="sourceLine" id="cb112-20" title="20"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb112-21" title="21"></a>
<a class="sourceLine" id="cb112-22" title="22"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p><strong>views/layout.pug</strong></p>
<pre class="pug"><code>html
  head
    title= title
  body
    h1= heading</code></pre>
<h2 id="what-you-learned-1">What you learned</h2>
<p>In this article, you learned</p>
<ul>
<li>how to create a Pug template that contains one or more variables;</li>
<li>how to use the <code>app.set()</code> method and the <code>view engine</code> application setting property to configure Express to use the Pug template engine; and</li>
<li>how to use the Response object <code>res.render()</code> method to render a Pug template to send an HTML response to a client.</li>
</ul>
<hr />
<h1 id="digging-into-the-pug-template-syntax">Digging Into the Pug Template Syntax</h1>
<p>Now that you’ve seen how to create and render a simple Pug template, let’s explore Pug’s syntax in more depth. Learning Pug’s syntax takes time and effort, but the payoff is that writing and maintaining templates will generally take less time overall.</p>
<p>When you finish this article, you should be able to use the Pug template syntax to:</p>
<ul>
<li>Render elements;</li>
<li>Set element attribute values;</li>
<li>Set element class and ID attribute values;</li>
<li>Set element content from a variable;</li>
<li>Set an element attribute value from a variable;</li>
<li>Inject a variable value into text using interpolation;</li>
<li>Iterate the elements in an array to generate content; and</li>
<li>Conditionally display content.</li>
</ul>
<h2 id="setting-up-a-sandbox-application">Setting up a sandbox application</h2>
<blockquote>
<p><strong>Exercise your brain!</strong> Use the following application as a sandbox to test and experiment with the Pug syntax as it’s introduced in this article. Doing this will help you to remember what you’ve learned.</p>
</blockquote>
<p>Create a folder for your project, open a terminal or command prompt window, browse to your project’s folder, and initialize npm:</p>
<pre><code>npm init -y</code></pre>
<p>Then install Express 4.0 and Pug 2:</p>
<pre><code>npm install express@^4.0.0 pug@^2.0.0</code></pre>
<p>Add a folder named <code>views</code> to your project, then add a file named <code>layout.pug</code> containing the following code:</p>
<pre class="pug"><code>html
  head
    title= title
  body
    h1= heading</code></pre>
<p>Then add a file named <code>app.js</code> to your project folder containing the following code:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb117-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-2" title="2"></a>
<a class="sourceLine" id="cb117-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb117-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb117-5" title="5"></a>
<a class="sourceLine" id="cb117-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb117-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-8" title="8"></a>
<a class="sourceLine" id="cb117-9" title="9"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb117-10" title="10"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb117-11" title="11">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-12" title="12">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-13" title="13"></a>
<a class="sourceLine" id="cb117-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Pug Template Syntax Sandbox&#39;</span><span class="op">,</span> <span class="dt">heading</span><span class="op">:</span> <span class="st">&#39;Welcome to the Sandbox!&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb117-16" title="16"></a>
<a class="sourceLine" id="cb117-17" title="17"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb117-18" title="18"></a>
<a class="sourceLine" id="cb117-19" title="19"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb117-20" title="20"></a>
<a class="sourceLine" id="cb117-21" title="21"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>To test your application, open a terminal or command prompt window, browse to your project’s folder, and run the command:</p>
<pre><code>node app.js</code></pre>
<p>The text "Listening on port 8081…" should display in the terminal or command prompt window. Open a web browser and browse to the address <code>http://localhost:8081/</code> to confirm that the application sends a response that displays an HTML <code>&lt;h1&gt;</code> element containing the text "Welcome to the Sandbox!".</p>
<h2 id="rendering-elements">Rendering elements</h2>
<p>Consider the following excerpt from a Pug template:</p>
<pre class="pug"><code>ul
  li Item A
  li Item B
  li Item C</code></pre>
<p>This renders an HTML unordered list:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb120-1" title="1"><span class="kw">&lt;ul&gt;</span></a>
<a class="sourceLine" id="cb120-2" title="2">  <span class="kw">&lt;li&gt;</span>Item A<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb120-3" title="3">  <span class="kw">&lt;li&gt;</span>Item B<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb120-4" title="4">  <span class="kw">&lt;li&gt;</span>Item C<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb120-5" title="5"><span class="kw">&lt;/ul&gt;</span></a></code></pre></div>
<p>Text at the beginning of a line (with or without white space) represents an HTML element. Any text included after the element name will be added as the element’s inner text. To add an element as a child element, simply indent the line for the child element by one or more spaces (two spaces is a common convention).</p>
<blockquote>
<p>Whether you decide to use two or four spaces for indenting elements, it’s important to keep your indentation consistent throughout the template. Not doing so might result in Pug throwing an error at runtime.</p>
</blockquote>
<h2 id="setting-element-attribute-values">Setting element attribute values</h2>
<p>To set attribute values on an element, follow the element name with a pair of parentheses containing one or more attribute name/value pairs:</p>
<pre class="pug"><code>a(href=&#39;/about&#39; class=&#39;menu-button&#39;) About</code></pre>
<p>Renders to:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb122-1" title="1"><span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/about&quot;</span><span class="ot"> class=</span><span class="st">&quot;menu-button&quot;</span><span class="kw">&gt;</span>About<span class="kw">&lt;/a&gt;</span></a></code></pre></div>
<h3 id="setting-class-and-id-attribute-values">Setting <code>class</code> and <code>id</code> attribute values</h3>
<p>Element class and ID attributes are very common attributes to set, so Pug provides a shortcut syntax for each. You can set an element’s <code>class</code> attribute using the syntax <code>.classname</code> and an element’s <code>id</code> attribute using <code>#idname</code>:</p>
<pre class="pug"><code>div#container
  a.button Cancel</code></pre>
<p>Renders to:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb124-1" title="1"><span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb124-2" title="2">  <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;button&quot;</span><span class="kw">&gt;</span>Cancel<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb124-3" title="3"><span class="kw">&lt;/div&gt;</span></a></code></pre></div>
<p>You can also combine a class name with an ID name or chain multiple class names:</p>
<pre class="pug"><code>div#container.main
  a.button.large Cancel</code></pre>
<p>Renders to:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb126-1" title="1"><span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;container&quot;</span><span class="ot"> class=</span><span class="st">&quot;main&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb126-2" title="2">  <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;button large&quot;</span><span class="kw">&gt;</span>Cancel<span class="kw">&lt;/a&gt;</span></a>
<a class="sourceLine" id="cb126-3" title="3"><span class="kw">&lt;/div&gt;</span></a></code></pre></div>
<p>This example can be further condensed. <code>&lt;div&gt;</code> elements are so common, Pug allows you to remove the <code>&lt;div&gt;</code> element’s name:</p>
<pre class="pug"><code>#container.main
  a.button.large Cancel</code></pre>
<h2 id="rendering-data">Rendering data</h2>
<p>As you saw in an earlier article, you can provide data to a template by passing an object to the <code>res.render()</code> method:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb128-1" title="1"><span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;Grace&#39;</span><span class="op">,</span> <span class="dt">lastName</span><span class="op">:</span> <span class="st">&#39;Hopper&#39;</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Properties on the object passed as the second argument to the <code>res.render()</code> method are defined within a template as local variables, which can be used to set element content:</p>
<pre class="pug"><code>ul
  li= firstName
  li= lastName</code></pre>
<p>Which would render to:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb130-1" title="1"><span class="kw">&lt;ul&gt;</span></a>
<a class="sourceLine" id="cb130-2" title="2">  <span class="kw">&lt;li&gt;</span>Grace<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb130-3" title="3">  <span class="kw">&lt;li&gt;</span>Hopper<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb130-4" title="4"><span class="kw">&lt;/ul&gt;</span></a></code></pre></div>
<p>Variables can also be used to set element attribute values:</p>
<pre class="pug"><code>form
  div
    label First Name:
    input(type=&#39;text&#39; name=&#39;firstName&#39; value=firstName)
  div
    label Last Name:
    input(type=&#39;text&#39; name=&#39;lastName&#39; value=lastName)</code></pre>
<p>Renders to:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb132-1" title="1"><span class="kw">&lt;form&gt;</span></a>
<a class="sourceLine" id="cb132-2" title="2">  <span class="kw">&lt;div&gt;</span></a>
<a class="sourceLine" id="cb132-3" title="3">    <span class="kw">&lt;label&gt;</span>First Name:<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb132-4" title="4">    <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;firstName&quot;</span><span class="ot"> value=</span><span class="st">&quot;Grace&quot;</span><span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb132-5" title="5">  <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb132-6" title="6">  <span class="kw">&lt;div&gt;</span></a>
<a class="sourceLine" id="cb132-7" title="7">    <span class="kw">&lt;label&gt;</span>Last Name:<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb132-8" title="8">    <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;lastName&quot;</span><span class="ot"> value=</span><span class="st">&quot;Hopper&quot;</span><span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb132-9" title="9">  <span class="kw">&lt;/div&gt;</span></a>
<a class="sourceLine" id="cb132-10" title="10"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>You can also use interpolation to inject a variable value into text:</p>
<pre class="pug"><code>p Welcome #{firstName} #{lastName}!</code></pre>
<p>Renders to:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb134-1" title="1"><span class="kw">&lt;p&gt;</span>Welcome Grace Hopper!<span class="kw">&lt;/p&gt;</span></a></code></pre></div>
<blockquote>
<p>Notice how Pug’s interpolation syntax <code>#{expression}</code> differs from JavaScript’s string template literal interpolation syntax <code>${expression}</code>. In a Pug template, the text to the right of the element name is just plain text, not JavaScript.</p>
</blockquote>
<h2 id="iteration-and-conditionals">Iteration and conditionals</h2>
<p>You can even use dynamic data to control the generation of HTML in your templates. Suppose you pass an array of colors to the <code>res.render()</code> method:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb135-1" title="1"><span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">colors</span><span class="op">:</span> [<span class="st">&#39;Red&#39;</span><span class="op">,</span> <span class="st">&#39;Green&#39;</span><span class="op">,</span> <span class="st">&#39;Blue&#39;</span>] <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Using that array of values, you can generate an ordered list:</p>
<pre class="pug"><code>ul
  each color in colors
    li= color</code></pre>
<p>Which renders as:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb137-1" title="1"><span class="kw">&lt;ul&gt;</span></a>
<a class="sourceLine" id="cb137-2" title="2">  <span class="kw">&lt;li&gt;</span>Red<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb137-3" title="3">  <span class="kw">&lt;li&gt;</span>Green<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb137-4" title="4">  <span class="kw">&lt;li&gt;</span>Blue<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb137-5" title="5"><span class="kw">&lt;/ul&gt;</span></a></code></pre></div>
<p>You can also conditionally display content. First, send a boolean value to the template that indicates if the current user is logged in or not:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb138-1" title="1"><span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">userIsLoggedIn</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Then you can use that boolean variable to determine what content to display:</p>
<pre class="pug"><code>if userIsLoggedIn
  h2 Welcome!
else
  a(href=&#39;/login&#39;) Please login</code></pre>
<p>If the <code>userIsLoggedIn</code> variable is <code>true</code> (indicating that the user has logged in) then the template would render:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb140-1" title="1"><span class="kw">&lt;h2&gt;</span>Welcome!<span class="kw">&lt;/h2&gt;</span></a></code></pre></div>
<p>Otherwise the template would render:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb141-1" title="1"><span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/login&quot;</span><span class="kw">&gt;</span>Please login<span class="kw">&lt;/a&gt;</span></a></code></pre></div>
<h2 id="what-you-learned-2">What you learned</h2>
<p>In this article, you learned how to</p>
<ul>
<li>render elements;</li>
<li>set element attribute values;</li>
<li>set element class and ID attribute values;</li>
<li>set element content from a variable;</li>
<li>set an element attribute value from a variable;</li>
<li>inject a variable value into text using interpolation;</li>
<li>iterate the elements in an array to generate content; and</li>
<li>conditionally display content.</li>
</ul>
<h2 id="see-also-1">See also…</h2>
<p>There’s so much more that you can do with Pug! Be sure to take some time to explore <a href="https://pugjs.org/api/getting-started.html">Pug’s documentation</a>.</p>
<hr />
<h1 id="exploring-route-paths">Exploring Route Paths</h1>
<p>You’ve seen that defining route paths in Express using a string is easy to do:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb142-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/about&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb142-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;About&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb142-3" title="3"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb142-4" title="4"></a>
<a class="sourceLine" id="cb142-5" title="5"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/contact&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb142-6" title="6">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Contact&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb142-7" title="7"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb142-8" title="8"></a>
<a class="sourceLine" id="cb142-9" title="9"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/our-team&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb142-10" title="10">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Our Team&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb142-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>You can also easily include child paths:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb143-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/our-team/sf&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb143-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Our Team - San Francisco&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb143-3" title="3"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb143-4" title="4"></a>
<a class="sourceLine" id="cb143-5" title="5"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/our-team/nyc&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb143-6" title="6">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Our Team - New York City&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb143-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>But what if you need to match multiple paths for a single resource? Having to define a route using a string route path for each variation is time consuming and difficult to maintain. In some cases, it might be impossible to spell out every possible variation. For example, what if the variable part of the path represents the ID of a database record to retrieve? Luckily, Express provides a wealth of options for defining route paths that you can use to solve virtually any routing challenge.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Recall that route parameters are named URL segments used to capture values;</li>
<li>Define a route whose path contains one or more route parameters;</li>
<li>Recall that a route path can be a string, string pattern, regular expression, or an array containing any combination of those;</li>
<li>Define a route path using a string pattern; and</li>
<li>Define a route path using a regular expression.</li>
</ul>
<h2 id="getting-data-from-a-path">Getting data from a path</h2>
<p>Imagine that you’re developing a website for the Best Company Ever. As a starting point, your project’s <code>app.js</code> file contains the following code:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb144-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb144-2" title="2"></a>
<a class="sourceLine" id="cb144-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb144-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb144-5" title="5"></a>
<a class="sourceLine" id="cb144-6" title="6"><span class="co">// </span><span class="al">TODO</span><span class="co"> Define routes.</span></a>
<a class="sourceLine" id="cb144-7" title="7"></a>
<a class="sourceLine" id="cb144-8" title="8"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb144-9" title="9"></a>
<a class="sourceLine" id="cb144-10" title="10"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb144-11" title="11"></a>
<a class="sourceLine" id="cb144-12" title="12"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>To follow along, be sure to initialize npm in your project folder (<code>npm init -y</code>) and install Express (<code>npm install express@^4.0.0</code>). Use <code>node app.js</code> to run the server. Remember that if you leave the server running in the terminal or command prompt window while you’re working, you’ll need to stop and restart it so that Node picks up your latest code changes. To do that, press <code>CTRL+C</code> to stop the server and run <code>node app.js</code> again to restart the server.</p>
</blockquote>
<p>You need to define your application’s first route for a "Product" page that displays information about a product from the Best Company Ever’s catalog. The product to display is variable—meaning that it depends on the product ID that’s passed via the URL path:</p>
<ul>
<li><code>/product/1</code> - displays information for the product whose database ID is <code>1</code>;</li>
<li><code>/product/2</code> - displays information for the product whose database ID is <code>2</code>;</li>
<li>and so on.</li>
</ul>
<p>Your initial thought is to use a query string parameter for the product ID (e.g. <code>/product?id=1</code>) instead of including it in the path. But after a bit of research, you <a href="https://www.google.com/search?q=query+string+parameters+and+search+engine+results">decide against that approach for SEO (search engine optimization) reasons</a>.</p>
<p>Defining routes using string based route paths for the first two products gives you something like this:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb145-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/1&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb145-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Product ID: 1&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb145-3" title="3"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb145-4" title="4"></a>
<a class="sourceLine" id="cb145-5" title="5"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/2&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb145-6" title="6">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Product ID: 2&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb145-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This works, but the Best Company Ever is very successful (of course they are… they’re the best company ever!) and they have over 1,000 products in their catalog. That means you have at least 998 routes left to define! Clearly, using string based route paths simply won’t work. Also, you want to keep your code as DRY (don’t repeat yourself!) as possible.</p>
<h3 id="leveraging-route-parameters">Leveraging route parameters</h3>
<p>Express route parameters are specifically designed for this situation.</p>
<p>A path is divided into segments using forward slashes (<code>/</code>). For example, given the path <code>/locations/ca/search</code>, <code>locations</code>, <code>ca</code>, and <code>search</code> would all be segments. A route parameter is a named path segment that captures the value at that position in the path. The captured value is available within a route handler function via the <code>req.params</code> object.</p>
<p>Here’s the "Product" page route defined using an <code>id</code> route parameter:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb146-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/:id&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb146-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`Product ID: </span><span class="sc">${</span><span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb146-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Using this route definition, the following request URL paths all match:</p>
<ul>
<li><code>/product/1</code> - displays "Product ID: 1"</li>
<li><code>/product/2</code> - displays "Product ID: 2"</li>
<li><code>/product/asdf</code> - displays "Product ID: asdf"</li>
</ul>
<p>That’s progress! But unfortunately, while <code>1</code> and <code>2</code> are valid product IDs, the string <code>asdf</code> is not.</p>
<h3 id="restricting-route-parameter-matches">Restricting route parameter matches</h3>
<p>By default, a route parameter will match almost any character (exceptions include a question mark <code>?</code> which denotes the beginning of the query string and a slash <code>/</code> which marks the beginning of the next path segment). Given that, <code>1</code>, <code>2</code>, and <code>asdf</code> are all valid values.</p>
<p>You can use a regular expression to exert more control over which values will match. Regular expressions use a language agnostic syntax for matching string patterns. For example, a dot <code>.</code> represents any character in a regular expression, so the expression <code>c.t</code> can match <code>cat</code>, <code>cot</code>, or <code>cut</code>, but not <code>can</code> nor <code>bat</code>.</p>
<p>There are many other special characters that you can use to match specific string patterns:</p>
<ul>
<li>the special character <code>\d</code> matches a single digit (i.e. <code>0</code> through <code>9</code>); and</li>
<li>adding a plus sign <code>\d+</code> matches one or more digits.</li>
</ul>
<p>To apply a regular expression to a route parameter, place it in parentheses just after the route parameter name:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb147-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb147-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`Product ID: </span><span class="sc">${</span><span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb147-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now the route will only match URL paths that have a number in the route parameter’s position:</p>
<ul>
<li><code>/product/1</code> - displays "Product ID: 1"</li>
<li><code>/product/2</code> - displays "Product ID: 2"</li>
<li><code>/product/asdf</code> - displays "Cannot GET /product/asdf" (404 Not Found)</li>
</ul>
<blockquote>
<p>The regular expression has an extra backslash <code>\</code> in the route path before <code>\d+</code> because the backslash character is used to escape special characters within a JavaScript string literal. For more information see the "Escape notation" section on the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">MDN Web Docs <code>String</code> page</a>.</p>
</blockquote>
<p>Now the route parameter only matches a numeric value in the URL path but the value via the <code>req.params</code> object is still a string. If you need the route parameter value as a number, you’ll need to convert it:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb148-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb148-2" title="2">  <span class="kw">const</span> productId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb148-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`Product ID: </span><span class="sc">${</span>productId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb148-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>For more information on the <code>parseInt()</code> function, see <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseInt">this page on MDN Web Docs</a>.</p>
</blockquote>
<h2 id="defining-flexible-route-paths">Defining flexible route paths</h2>
<p>As you develop websites and web applications, you’ll likely find that using a combination of strings and route parameters to define your routes will cover the majority of your use cases. Sometimes though, situations will come up that will require a different approach.</p>
<p>Your next task for the Best Company Ever website is to define a route for their "Products" page. After spending some time with the internal stakeholders for the project from the Sales, Marketing, and Customer Support departments, you’ve determined that the following use cases and issues all need to be addressed:</p>
<ul>
<li>Marketing somehow managed to design and publish advertisements using both <code>www.bestcompanyever.com/products</code> and <code>www.bestcompanyever.com/our-products</code> as the URLs for the same "Products" page.</li>
<li>Customer Support has noticed that sometimes customers forget the "s" at the end of "products" and get frustrated when they get a "Page Not Found" error trying to browse to the URL <code>www.bestcompanyever.com/product</code>.</li>
<li>Customer Support has also noticed that sometimes customers mistype the word "products" as "prodcts" or "productts".</li>
<li>Sales would like to allow customers to use "productos" (Spanish for "products") to make it as easy as possible for everyone to find the "Products" page.</li>
</ul>
<p>All of this translates into mapping the following paths to the "Products" page:</p>
<ul>
<li><code>/products</code></li>
<li><code>/our-products</code></li>
<li><code>/product</code></li>
<li><code>/prodcts</code></li>
<li><code>/productts</code></li>
<li><code>/productos</code></li>
</ul>
<p>Having to define a route for each of these paths would be less than ideal. Luckily, Express provides a number of options for defining route paths including using</p>
<ul>
<li>a string (this is what you’ve been using up to this point);</li>
<li>a string pattern;</li>
<li>a regular expression; or</li>
<li>an array containing any combination of those.</li>
</ul>
<p>Let’s use these options to develop a solution!</p>
<h3 id="using-a-string-pattern">Using a string pattern</h3>
<p>Your first attempt at defining the route for the "Products" page looks like this:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb149-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/products&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb149-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb149-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Currently, when running the application (<code>node app.js</code>) the only URL that returns the string "Products" is <code>http://localhost:8081/products</code> (i.e. the path <code>/products</code>). This makes sense, as our route’s path is defined using the string <code>/products</code>.</p>
<p>You can use a string pattern to define a route path that will match more incoming request URL paths. The following characters, when used within a string based route path, behave somewhat like their regular expression counterparts:</p>
<ul>
<li>question mark <code>?</code> - specifies that the previous character can appear zero to one time</li>
<li>plus sign <code>+</code> - specifies that the previous character can appear one or more times</li>
<li>asterisk <code>*</code> - matches any number of characters (i.e. "wildcard" character)</li>
</ul>
<p>Looking at your route again, adding a question mark <code>?</code> after the <code>s</code> in the path <code>/products</code> specifies that the <code>s</code> can appear zero to one time:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb150-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/products?&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb150-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb150-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now your route will match the URL paths <code>/products</code> and <code>/product</code>.</p>
<p>After reviewing the list of paths that you need to match, you notice that you can add an additional question mark <code>?</code> after the <code>u</code>:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb151-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/produ?cts?&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb151-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb151-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now both the <code>u</code> and the <code>s</code> are effectively optional, allowing the following URL paths to match:</p>
<ul>
<li><code>/products</code></li>
<li><code>/product</code></li>
<li><code>/prodcts</code></li>
</ul>
<p>Taking it a step further, you add a plus sign <code>+</code> after the <code>t</code>:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb152-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/produ?ct+s?&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb152-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb152-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>That change allows one or more <code>t</code>s to appear in the URL path, allowing the following URL paths to match:</p>
<ul>
<li><code>/products</code></li>
<li><code>/product</code></li>
<li><code>/prodcts</code></li>
<li><code>/productts</code></li>
</ul>
<p>And now for the master stroke: you add an asterisk <code>*</code> in between the <code>/</code> and <code>p</code>:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb153-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/*produ?ct+s?&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb153-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb153-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now all of the following URL paths match:</p>
<ul>
<li><code>/products</code></li>
<li><code>/product</code></li>
<li><code>/prodcts</code></li>
<li><code>/productts</code></li>
<li><code>/our-products</code></li>
</ul>
<p>Using string patterns to define route paths are useful but fairly limited in capability. For example, our string pattern based route path has the following deficiencies:</p>
<ul>
<li>The asterisk <code>*</code> matches the URL path <code>/our-products</code> but also literally anything else between the <code>/</code> and <code>p</code>, including <code>/cool-products</code>, <code>asdf-products</code>, and so on.</li>
<li>The plus sign <code>+</code> after the <code>t</code> matches <code>tt</code> but also <code>ttt</code>, <code>tttt</code>, and so on.</li>
</ul>
<p>Depending on your specific situation, these shortcomings might be something you can live with. If you can’t, you can write a more sophisticated route path using a regular expression.</p>
<h3 id="using-a-regular-expression">Using a regular expression</h3>
<p>When defining a route, Express allows you to define your route path using a regular expression. You can rewrite your original "Products" page route using a regular expression like this:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb154-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="ss">/</span><span class="sc">^\/</span><span class="ss">products</span><span class="sc">\/?$</span><span class="ss">/i</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb154-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb154-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>At this point, only the URL path <code>/products</code> will match.</p>
<p>Regular expressions can be difficult to read and understand. Here’s a step-by-step breakdown, from left to right, of the above regular expression (don’t worry about committing all of this regular expression syntax to memory; you’ll have access to documentation when designing complex regular expression based routes):</p>
<ul>
<li><code>/</code> - Denotes the beginning of the regular expression.</li>
<li><code>^</code> - Indicates that the expression must match the beginning of the URL path string.</li>
<li><code>\/</code> - Matches a forward slash <code>/</code>. Because forward slashes have special meaning (they mark the beginning and ending of a regular expression) they must be escaped with a backslash <code>\</code>.</li>
<li><code>products</code> - Matches the literal string <code>products</code>.</li>
<li><code>\/?</code> - Matches zero or one instance of a forward slash <code>/</code>.
<ul>
<li>Since you’re using the <code>^</code> and <code>$</code> characters to match the beginning and ending of the URL path string, you need to add an optional forward slash at the end of the expression in order to allow for URL paths that have a trailing forward slash.</li>
</ul></li>
<li><code>$</code> - Indicates that the expression must match the ending of the URL path string.</li>
<li><code>/</code> - Denotes the ending of the regular expression.</li>
<li><code>i</code> - Indicates that the regular expression is case-insensitive.</li>
</ul>
<blockquote>
<p>We’re just scratching the surface of what’s possible with regular expressions. For more information about regular expressions, see <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions">this page on MDN Web Docs</a>.</p>
</blockquote>
<p>Now let’s work on extending the regular expression to match more URL paths.</p>
<p>Since the question mark <code>?</code> character behaves like it does within a string pattern, you can make the <code>u</code> and the <code>s</code> in <code>products</code> optional like you did before:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb155-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="ss">/</span><span class="sc">^\/</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">cts</span><span class="sc">?\/?$</span><span class="ss">/i</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb155-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb155-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This allows the following URL paths to match:</p>
<ul>
<li><code>/products</code></li>
<li><code>/product</code></li>
<li><code>/prodcts</code></li>
</ul>
<p>Instead of using the plus sign <code>+</code> after the <code>t</code> to allow one or more <code>t</code>s to appear in the URL path, you can use a set of curly braces <code>{}</code> to specify the minimum and maximum number of instances:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb156-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="ss">/</span><span class="sc">^\/</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">ct</span><span class="sc">{1,2}</span><span class="ss">s</span><span class="sc">?\/?$</span><span class="ss">/i</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb156-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb156-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now the following URL paths will match:</p>
<ul>
<li><code>/products</code></li>
<li><code>/product</code></li>
<li><code>/prodcts</code></li>
<li><code>/productts</code> (but not <code>/producttts</code>, <code>/productttts</code>, or so on)</li>
</ul>
<p>To match on the URL path <code>/our-products</code>, you can use a set of parentheses <code>()</code> to define a capture group containing the string <code>our-</code> and follow the capture group with a question mark <code>?</code> to make it optional:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb157-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="ss">/</span><span class="sc">^\/(</span><span class="ss">our-</span><span class="sc">)?</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">ct</span><span class="sc">{1,2}</span><span class="ss">s</span><span class="sc">?\/?$</span><span class="ss">/i</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb157-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb157-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>Capture groups are a powerful tool when writing regular expressions. In this example, you’re simply using a capture group as a way to group the characters <code>our-</code> together so that the question mark <code>?</code> that follows the group will apply to the group as if it were a single character.</p>
</blockquote>
<p>Going one step further, you can add another capture group by wrapping <code>(our-)?produ?ct{1,2}s?</code> in another set of parentheses. Then, within the new capture group, append the text <code>|productos</code>:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb158-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="ss">/</span><span class="sc">^\/((</span><span class="ss">our-</span><span class="sc">)?</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">ct</span><span class="sc">{1,2}</span><span class="ss">s</span><span class="sc">?|</span><span class="ss">productos</span><span class="sc">)\/?$</span><span class="ss">/i</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb158-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb158-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The pipe character <code>|</code> is used to create a logical "OR" expression (i.e. "this" or "that"). Adding the pipe <code>|</code> within the new group specifies that the expression <code>(our-)?produ?ct{1,2}s?</code> or <code>productos</code> should match.</p>
<p>With this change in place, the following URL paths all match:</p>
<ul>
<li><code>/products</code></li>
<li><code>/product</code></li>
<li><code>/prodcts</code></li>
<li><code>/productts</code> (but not <code>/producttts</code>, <code>/productttts</code>, or so on)</li>
<li><code>/our-products</code></li>
<li><code>/productos</code></li>
</ul>
<blockquote>
<p><strong>Don’t worry if you found this section difficult to understand.</strong> A lot of developers find regular expressions to be challenging to write, test, and debug. Unless your work requires you to write regular expressions on a frequent basis, it’s likely that you’ll need to spend time brushing up your regular expressions skills before you can successfully write or update an expression. Using a good tool can make a big difference—ask your fellow developers what tool(s) they’ve found to be helpful!</p>
</blockquote>
<h3 id="using-an-array-of-paths">Using an array of paths</h3>
<p>In addition to the techniques you’ve seen so far, you can also use an array of values for the route path:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb159-1" title="1"><span class="va">app</span>.<span class="at">get</span>([<span class="ss">/</span><span class="sc">^\/(</span><span class="ss">our-</span><span class="sc">)?</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">ct</span><span class="sc">{1,2}</span><span class="ss">s</span><span class="sc">?\/?$</span><span class="ss">/i</span><span class="op">,</span> <span class="st">&#39;/productos&#39;</span>]<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb159-2" title="2"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb159-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>When a route is defined using an array of values for the route path, Express will check each of the array’s elements to determine if an incoming request URL path is a match.</p>
<p>Using an array allows you to simplify the regular expression a bit by pulling the <code>/productos</code> path out of the regular expression into its own route path string. This change has no effect on the outward functionality of your application; it’s all about choosing the option that’s easiest to read, understand, and maintain.</p>
<h2 id="redirecting-incorrect-requests">Redirecting "incorrect" requests</h2>
<p>All of the internal stakeholders at the Best Company Ever love the new website. They’re especially happy that you were able to address all of the URL path oddities surrounding the "Products" page.</p>
<p>There’s one final issue to address though. A sharp-eyed tester noticed that when you request the "Products" page using one of the non-preferred paths (e.g. <code>/prodcts</code>) the page displays as expected, but the URL in the browser’s address bar shows the non-preferred path (i.e. <code>http://www.bestcompanyever.com/prodcts</code>). Ideally, when a client requests the "Products" page using anything other than the preferred route of <code>/products</code>, they’d be redirected back to the page using the preferred path.</p>
<p>You can accomplish this by updating the route handler to check if the current request’s path (i.e. <code>req.path</code>) starts with the preferred path, and if not, uses the <code>res.redirect()</code> method to redirect the client:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb160-1" title="1"><span class="co">// If the current request path doesn&#39;t match our preferred</span></a>
<a class="sourceLine" id="cb160-2" title="2"><span class="co">// route path then redirect the client.</span></a>
<a class="sourceLine" id="cb160-3" title="3"><span class="cf">if</span> (<span class="op">!</span><span class="va">req</span>.<span class="va">path</span>.<span class="at">toLowerCase</span>().<span class="at">startsWith</span>(<span class="st">&#39;/products&#39;</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb160-4" title="4">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb160-5" title="5"><span class="op">}</span></a></code></pre></div>
<blockquote>
<p>By default, Express routing isn’t case-sensitive, so the request path <code>/Products</code> would match our preferred route path <code>/products</code>. To prevent from redirecting requests that only differ by casing, the string <code>toLowerCase()</code> method is being used to force the request path to all lowercase. Also, Express allows incoming request paths that have an optional trailing forward slash (i.e. <code>/products/</code>) to match a route path without a trailing forward slash (i.e. <code>/products</code>). Using the string <code>startsWith()</code> method gives us an easy way to check for the preferred path without having to account for the trailing slash.</p>
</blockquote>
<p>After finishing all of the refactoring, the final version of your <code>app.js</code> file should now look like this:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb161-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb161-2" title="2"></a>
<a class="sourceLine" id="cb161-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb161-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb161-5" title="5"></a>
<a class="sourceLine" id="cb161-6" title="6"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb161-7" title="7"></a>
<a class="sourceLine" id="cb161-8" title="8"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb161-9" title="9">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`Product ID: </span><span class="sc">${</span><span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb161-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb161-11" title="11"></a>
<a class="sourceLine" id="cb161-12" title="12"><span class="va">app</span>.<span class="at">get</span>([<span class="ss">/</span><span class="sc">^\/(</span><span class="ss">our-</span><span class="sc">)?</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">ct</span><span class="sc">{1,2}</span><span class="ss">s</span><span class="sc">?\/?$</span><span class="ss">/i</span><span class="op">,</span> <span class="st">&#39;/productos&#39;</span>]<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb161-13" title="13"> <span class="co">// If the current request path doesn&#39;t match our preferred</span></a>
<a class="sourceLine" id="cb161-14" title="14"> <span class="co">// route path then redirect the client.</span></a>
<a class="sourceLine" id="cb161-15" title="15"> <span class="cf">if</span> (<span class="op">!</span><span class="va">req</span>.<span class="va">path</span>.<span class="at">toLowerCase</span>().<span class="at">startsWith</span>(<span class="st">&#39;/products&#39;</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb161-16" title="16">   <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb161-17" title="17"> <span class="op">}</span></a>
<a class="sourceLine" id="cb161-18" title="18"></a>
<a class="sourceLine" id="cb161-19" title="19"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb161-20" title="20"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb161-21" title="21"></a>
<a class="sourceLine" id="cb161-22" title="22"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb161-23" title="23"></a>
<a class="sourceLine" id="cb161-24" title="24"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb161-25" title="25"></a>
<a class="sourceLine" id="cb161-26" title="26"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<h2 id="what-you-learned-3">What you learned</h2>
<p>In this article, you learned</p>
<ul>
<li>that route parameters are named URL segments used to capture values;</li>
<li>how to define a route whose path contains one or more route parameters;</li>
<li>that a route path can be a string, string pattern, regular expression, or an array containing any combination of those;</li>
<li>how to define a route path using a string pattern; and</li>
<li>how to define a route path using a regular expression.</li>
</ul>
<hr />
<h1 id="express-routers">Express Routers</h1>
<p>As you’ve learned about Express routing, you’ve defined routes within a single <code>app.js</code> file. While this is a convenient approach to use while learning, it’s not very practical for "real world" web applications.</p>
<p>In the real world, web applications tend to target groups of resources, where each resource is associated with multiple routes. For example, a customer order management application might target resources like "Customers", "Products", "Product Categories", and "Orders", and each of those resources might have routes for creating, retrieving, updating, and deleting records (often referred to as CRUD operations). Additionally, some resources might need to share the same routes.</p>
<p>In these situations, defining all of your web application’s routes within a single JavaScript file is simply put, a bad idea.</p>
<p>Express routers allow developers to create collections of modular, mountable route handlers. Using routers helps to keep your code organized and DRY (don’t repeat yourself!), ensuring that your code is as readable and maintainable as possible.</p>
<p>As an introduction to Express routers, let’s create routing for a sports team application. You’ll use a router to define routes for "Home", "Schedule", and "Roster" pages. Then you’ll see how to mount that router onto your application so that its routes are shared across multiple teams.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Use the <code>express.Router</code> class to define a collection of route handlers; and</li>
<li>Use the <code>app.use()</code> method to mount a Router instance for a specific route path.</li>
</ul>
<h2 id="setting-up-the-initial-project">Setting up the initial project</h2>
<p>Create a folder for your project, open a terminal or command prompt window, browse to your project’s folder, and initialize npm:</p>
<pre><code>npm init -y</code></pre>
<p>Then install Express 4.0:</p>
<pre><code>npm install express@^4.0.0</code></pre>
<p>Add a file named <code>app.js</code> file to your project containing the following code:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb164-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb164-2" title="2"></a>
<a class="sourceLine" id="cb164-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb164-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb164-5" title="5"></a>
<a class="sourceLine" id="cb164-6" title="6"><span class="co">// </span><span class="al">TODO</span><span class="co"> Mount router instances.</span></a>
<a class="sourceLine" id="cb164-7" title="7"></a>
<a class="sourceLine" id="cb164-8" title="8"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb164-9" title="9"></a>
<a class="sourceLine" id="cb164-10" title="10"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb164-11" title="11"></a>
<a class="sourceLine" id="cb164-12" title="12"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Your application doesn’t contain any routes yet, so hold off on testing for a bit.</p>
<blockquote>
<p>Remember that if you leave your application running in the terminal or command prompt window while you’re working, you’ll need to stop and restart it so that Node picks up your latest code changes. To do that, press <code>CTRL+C</code> to stop the application and run <code>node app.js</code> to restart the application.</p>
</blockquote>
<h2 id="defining-a-collection-of-route-handlers">Defining a collection of route handlers</h2>
<p>While it’s not required, a common convention is to create each Express router instance within its own Node module. Remember that in Node, each file is treated as a separate module. So, to create a new module for your router, add a new file named <code>routes.js</code> to your project.</p>
<blockquote>
<p>Typically, the name of the module reflects the resource that the router will be defining routes for. Going back to the customer order management application, you’d have files named <code>customers.js</code> and <code>products.js</code> containing routers (and route definitions) for the Customers and Products resources. For this article, you’ll keep things simple and just use the filename <code>routes.js</code>.</p>
</blockquote>
<p>At the top of the file, use the <code>require</code> directive to import the <code>express</code> module and assign it to a variable named <code>express</code>:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb165-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>You’ve had a lot of practice using the <code>express</code> function (exported by the <code>express</code> module) to create Express applications. The <code>express</code> module also exports the <code>Router</code> class via a property on the <code>express</code> function, which you can use to create an instance of a router:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb166-1" title="1"><span class="co">// Create the Router instance.</span></a>
<a class="sourceLine" id="cb166-2" title="2"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a></code></pre></div>
<p>Everything that you’ve done so far with defining routes using an Express Application (<code>app</code>) object can be done with a router instance. For this reason, a router can be thought of as a "mini-app".</p>
<blockquote>
<p>The Express Application (<code>app</code>) object and Router objects also handle middleware in the same way. You’ll learn about middleware in a future lesson.</p>
</blockquote>
<p>Using the <code>router.get()</code> method, define a collection of routes for a sports team including "Home", "Schedule", and "Roster" pages:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb167-1" title="1"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb167-2" title="2"></a>
<a class="sourceLine" id="cb167-3" title="3"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb167-4" title="4"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Home&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb167-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb167-6" title="6"></a>
<a class="sourceLine" id="cb167-7" title="7"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/schedule&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb167-8" title="8"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Schedule&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb167-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb167-10" title="10"></a>
<a class="sourceLine" id="cb167-11" title="11"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/roster&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb167-12" title="12"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Roster&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb167-13" title="13"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Code contained within a module isn’t automatically visible or callable to code contained in other modules. To expose code to other modules, you can use the <code>module.exports</code> object. Since you only have one object to export from your module, simply assign the <code>router</code> variable to the <code>module.exports</code> property:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb168-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Here’s the completed code for the <code>routes.js</code> file:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb169-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb169-2" title="2"></a>
<a class="sourceLine" id="cb169-3" title="3"><span class="co">// Create the Router instance.</span></a>
<a class="sourceLine" id="cb169-4" title="4"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb169-5" title="5"></a>
<a class="sourceLine" id="cb169-6" title="6"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb169-7" title="7"></a>
<a class="sourceLine" id="cb169-8" title="8"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb169-9" title="9"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Home&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb169-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb169-11" title="11"></a>
<a class="sourceLine" id="cb169-12" title="12"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/schedule&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb169-13" title="13"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Schedule&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb169-14" title="14"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb169-15" title="15"></a>
<a class="sourceLine" id="cb169-16" title="16"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/roster&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb169-17" title="17"> <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Roster&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb169-18" title="18"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb169-19" title="19"></a>
<a class="sourceLine" id="cb169-20" title="20"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<h2 id="mounting-a-router-instance">Mounting a Router instance</h2>
<p>Now that you’ve finished setting up your router instance, you’re ready to make use of it within your <code>app.js</code> file. At the top of the file just below where you’re importing the <code>express</code> module, use the <code>require</code> directive to import the <code>routes</code> module and assign it to a variable named <code>routes</code>:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb170-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb170-2" title="2"><span class="kw">const</span> routes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes&#39;</span>)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>Notice that the call to the <code>require</code> directive to import the <code>routes</code> module starts with a relative path (i.e. a dot <code>.</code> followed by a forward slash <code>/</code>). This tells Node that the <code>routes</code> module is a local module contained within our project, as opposed to a module contained within an external dependency located in the <code>node_modules</code> folder (that was installed using the <code>npm install</code> command).</p>
</blockquote>
<p>To expose your router instance to the outside world so that it can handle incoming HTTP requests, you need to tell your Express Application (<code>app</code>) object to use it. To do that, call the <code>app.use()</code> method passing in an optional route path along with the <code>routes</code> variable (the instance of your router):</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb171-1" title="1"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb171-2" title="2"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb171-3" title="3"></a>
<a class="sourceLine" id="cb171-4" title="4"><span class="co">// Mount router instances.</span></a>
<a class="sourceLine" id="cb171-5" title="5"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/portland-thorns&#39;</span><span class="op">,</span> routes)<span class="op">;</span></a></code></pre></div>
<p>Providing a route path when mounting your router instance allows you to mount the router instance multiple times each with a different route path:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb172-1" title="1"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb172-2" title="2"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb172-3" title="3"></a>
<a class="sourceLine" id="cb172-4" title="4"><span class="co">// Mount router instances.</span></a>
<a class="sourceLine" id="cb172-5" title="5"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/portland-thorns&#39;</span><span class="op">,</span> routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb172-6" title="6"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/orlando-pride&#39;</span><span class="op">,</span> routes)<span class="op">;</span></a></code></pre></div>
<p>The combination of the router mount paths and the route paths defined within the router allows you to easily and quickly build a hierarchy of routes:</p>
<ul>
<li><code>/portland-thorns/</code></li>
<li><code>/portland-thorns/schedule</code></li>
<li><code>/portland-thorns/roster</code></li>
<li><code>/orlando-pride/</code></li>
<li><code>/orlando-pride/schedule</code></li>
<li><code>/orlando-pride/roster</code></li>
</ul>
<p>If you mounted the router instance without supplying a route path (i.e. <code>app.use(routes)</code>), then your application would only have the following routes configured:</p>
<ul>
<li><code>/</code></li>
<li><code>/schedule</code></li>
<li><code>/roster</code></li>
</ul>
<blockquote>
<p>Mounting a router instance without a route path might not seem very useful at first glance, but it can be helpful technique for keeping your project organized by defining top-level routes in their own module using a router.</p>
</blockquote>
<p>The completed code for your <code>app.js</code> file should look like this:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb173-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb173-2" title="2"><span class="kw">const</span> routes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb173-3" title="3"></a>
<a class="sourceLine" id="cb173-4" title="4"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb173-5" title="5"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb173-6" title="6"></a>
<a class="sourceLine" id="cb173-7" title="7"><span class="co">// Mount router instances.</span></a>
<a class="sourceLine" id="cb173-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/portland-thorns&#39;</span><span class="op">,</span> routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb173-9" title="9"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/orlando-pride&#39;</span><span class="op">,</span> routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb173-10" title="10"></a>
<a class="sourceLine" id="cb173-11" title="11"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb173-12" title="12"></a>
<a class="sourceLine" id="cb173-13" title="13"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb173-14" title="14"></a>
<a class="sourceLine" id="cb173-15" title="15"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<h3 id="testing-the-application">Testing the application</h3>
<p>To test your application, open a terminal or command prompt window, browse to your project’s folder, and run the following command:</p>
<pre><code>node app.js</code></pre>
<p>If your application starts successfully, you’ll see the text "Listening on port 8081…" displayed in the terminal or command prompt window. Next, open a web browser and browse to each of the following addresses for the Portland Thorns:</p>
<ul>
<li><code>http://localhost:8081/portland-thorns</code> - displays the text "Home" in the browser.</li>
<li><code>http://localhost:8081/portland-thorns/schedule</code> - displays the text "Schedule" in the browser.</li>
<li><code>http://localhost:8081/portland-thorns/roster</code> - displays the text "Roster" in the browser.</li>
</ul>
<p>Now browse to the following addresses for the Orlando Pride:</p>
<ul>
<li><code>http://localhost:8081/orlando-pride</code> - displays the text "Home" in the browser.</li>
<li><code>http://localhost:8081/orlando-pride/schedule</code> - displays the text "Schedule" in the browser.</li>
<li><code>http://localhost:8081/orlando-pride/roster</code> - displays the text "Roster" in the browser.</li>
</ul>
<p>Congrats on creating your first Express application with routers!</p>
<h2 id="what-you-learned-4">What you learned</h2>
<p>In this article, you learned</p>
<ul>
<li>how to use the <code>express.Router</code> class to define a collection of route handlers; and</li>
<li>how to use the <code>app.use()</code> method to mount a Router instance for a specific route path.</li>
</ul>
<h2 id="see-also-2">See also…</h2>
<p>For more information about the Express Router class, <a href="https://expressjs.com/en/4x/api.html#router">see the official documentation</a>.</p>
<hr />
<h1 id="routing-roundup-project">Routing Roundup Project</h1>
<p>Now that you’ve learned about routing in Express, it’s time to create an application to apply your knowledge! In this project, you’ll:</p>
<ul>
<li>Create a web application using Express;</li>
<li>Use Express to send an HTTP response containing plain text;</li>
<li>Use Express to send an HTTP response containing HTML rendered from a Pug template;</li>
<li>Define route paths using a string, string pattern, or regular expression;</li>
<li>Define a route path containing a route parameter; and</li>
<li>Use an Express router to define a collection of route handlers.</li>
</ul>
<h2 id="getting-started">Getting started</h2>
<ul>
<li>Clone the repository from https://github.com/-starters/routing-roundup-starter</li>
<li>Run <code>npm install</code> to install the dependencies</li>
<li>When you want to run tests, run <code>npm test</code></li>
</ul>
<h2 id="phase-1-defining-the-default-route">Phase 1: Defining the default route</h2>
<p>To get started, install Express 4.x using <code>npm</code>.</p>
<p>Now you’re ready to create your Express application. Add a file named <code>app.js</code> to your project. For your first route, the application should return the plain text response "Hello from Express!" for <code>GET</code> requests to the default or root resource. Configure your application to listen for HTTP connections on port <code>8081</code>.</p>
<p>If you would like to, setup <code>nodemon</code> as a dev dependency so you don’t have to restart your server when you make code changes.</p>
<p>To manually test your application, use Node to start your application. Open up a browser and browse to the URL <code>http://localhost:8081/</code>. You should see the plain text "Hello from Express!" displayed.</p>
<p>We’ve also provided automated integration tests that you can use to test your application. With your application started and listening for HTTP connections on port <code>8081</code>, run the command <code>npm test</code> from a terminal. (You will need <em>two</em> terminals open to do this, one to run the app and one to run the tests.)</p>
<p>The tests will confirm that each of your application’s routes return the expected HTTP responses. Initially, most of the tests will fail as you haven’t implemented all of the expected routes yet. As you work your way through the project, more tests will start to pass. If you have any trouble with using the tests don’t hesitate to ask a TA for help!</p>
<h2 id="phase-2-using-a-template-to-render-html">Phase 2: Using a template to render HTML</h2>
<p>For your next route, you’ll use Express to send an HTTP response containing HTML rendered from a Pug template.</p>
<p>Start with creating a Pug template with three variables for the request method, the request path, and a random number. Render the variable values using an unordered list:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb175-1" title="1"><span class="kw">&lt;ul&gt;</span></a>
<a class="sourceLine" id="cb175-2" title="2">  <span class="kw">&lt;li&gt;</span>[method]<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb175-3" title="3">  <span class="kw">&lt;li&gt;</span>[path]<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb175-4" title="4">  <span class="kw">&lt;li&gt;</span>[random number]<span class="kw">&lt;/li&gt;</span></a>
<a class="sourceLine" id="cb175-5" title="5"><span class="kw">&lt;/ul&gt;</span></a></code></pre></div>
<p>Replace the <code>[method]</code>, <code>[path]</code>, and <code>[random number]</code> text with the respective variable values.</p>
<p>After you complete your template, install Pug 2 and configure Express to use it as its default view engine. Then define a route that will match any request, regardless of the HTTP method, to a top level resource (such as <code>/about</code> or <code>/foo</code>). Use Express to render your template passing in the request method, the request path, and a random number. For the request method and path, remember that a route handler function’s <code>req</code> parameter references the Express Request object which provides detail about the client request that’s currently being processed. For the random number, use a whole number (no fractional or decimal part) greater than or equal to zero.</p>
<blockquote>
<p>Note: there are multiple ways to define a route path that’ll match any request for a top level resource. Experiment a bit and use the approach that feels the easiest to implement. Think carefully about the order of your route definitions to ensure that you don’t prevent other routes from being able to match their intended requests.</p>
</blockquote>
<blockquote>
<p>Additional note: remember that you can use the <code>console.log()</code> method to output the <code>req</code> parameter to the console as a way to inspect the properties that are available on the Request object. You can also use the <a href="https://expressjs.com/en/4x/api.html#req">official Express documentation</a> to research the available properties.</p>
</blockquote>
<p>To manually test your application, use Node to start your application, open up a browser, and browse to the URL <code>http://localhost:8081/about</code>. You should see the request method (<code>GET</code>), the request path (<code>/about</code>), and a random number displayed in an HTML unordered list.</p>
<p>To test your application using the provided automated integration tests, start your application listening for HTTP connections on port <code>8081</code> and run the command <code>mocha</code> from a terminal. You should see an additional set of tests pass that were previously failing.</p>
<h2 id="phase-3-defining-another-flexible-route">Phase 3: Defining another flexible route</h2>
<p>For this route, you’ll use Express to define a route that’ll match any <code>GET</code> request whose path ends with the letters "xyz". The route should return the plain text response "That’s all I wrote."</p>
<blockquote>
<p>Note: there are multiple ways to define a route path that’ll match any request whose path ends with a specific set of characters. Experiment a bit and use the approach that feels the easiest to implement. Again, think carefully about the order of your route definitions to ensure that all of your application’s routes continue to work as intended.</p>
</blockquote>
<p>To manually test your application, use Node to start your application, open up a browser, and browse to the URL <code>http://localhost:8081/xyz</code> or <code>http://localhost:8081/something-else-xyz</code>. You should see the plain text "That’s all I wrote." displayed.</p>
<p>To test your application using the provided automated integration tests, start your application listening for HTTP connections on port <code>8081</code> and run the command <code>mocha</code> from a terminal. Same as before, you should see an additional set of tests pass that were previously failing.</p>
<h2 id="phase-4-capturing-a-value-from-the-url-path">Phase 4: Capturing a value from the URL path</h2>
<p>Next, you’ll use Express to define a route that’ll match any <code>GET</code> request whose path starts with the path <code>/capital-letters/</code>. The route should return a plain text response of the uppercase version of the text in the path that follows <code>/capital-letters/</code>. For example, a request URL path of <code>/capital-letters/little</code> would return the plain text response "LITTLE".</p>
<p>To complete this part of the project, think about how to define a route whose path contains a named path segment that captures the value at that position in the path. For more information, review the "Exploring Route Paths" article in this lesson to help you arrive at a solution.</p>
<p>To manually test your application, start your application, open up a browser, and browse to the URL <code>http://localhost:8081/capital-letters/express</code>. You should see the plain text "EXPRESS" displayed.</p>
<p>To test your application using the provided automated integration tests, start your application and run the command <code>mocha</code> from a terminal. You should see an additional set of tests pass that were previously failing.</p>
<h2 id="phase-5-defining-a-collection-of-route-handlers">Phase 5: Defining a collection of route handlers</h2>
<p>To complete your project, you’ll use an Express router to define a collection of route handlers. One of those route handlers should respond to the URL path <code>/bio</code> with the plain text "Bio" and another should response to <code>/contact</code> with the plain text "Contact".</p>
<p>Once you’ve defined your router, mount two instances to your application so that:</p>
<ul>
<li><p>A request with the URL path <code>/margot/bio</code> will return the plain text response "Bio" and <code>/margot/contact</code> will return the plain text response "Contact"; and</p></li>
<li><p>A request with the URL path <code>/margeaux/bio</code> will return the plain text response "Bio" and <code>/margeaux/contact</code> will return the plain text response "Contact".</p></li>
</ul>
<p>To manually test your application, start your application, open up a browser, and browse to the URLs <code>http://localhost:8081/margot/bio</code>, <code>http://localhost:8081/margot/contact</code>, <code>http://localhost:8081/margeaux/bio</code>, and <code>http://localhost:8081/margeaux/contact</code>, and check that the application returns the expected responses.</p>
<p>To test your application using the provided automated integration tests, start your application and run the command <code>mocha</code> from a terminal. Now you should see all of the tests pass!</p>
<h2 id="what-weve-learned">What We’ve Learned</h2>
<p>Your Express routing application is now complete! Great job building out your application’s routes using a variety of techniques.</p>
<p>In this project, you:</p>
<ul>
<li>Created a web application using Express;</li>
<li>used Express to send an HTTP response containing plain text;</li>
<li>used Express to send an HTTP response containing HTML rendered from a Pug template;</li>
<li>defined route paths using a string, string pattern, or regular expression;</li>
<li>defined a route path containing a route parameter; and</li>
<li>used an Express router to define a collection of route handlers.</li>
</ul>
<hr />
<h1 id="week-11-day-3-form-handling" data-ignore="true">WEEK-11 DAY-3<br><em>Form Handling</em></h1>
<hr />
<h1 id="html-forms-learning-objectives">HTML Forms Learning Objectives</h1>
<p>HTML forms are the way that you collect data from a user to power your Web application. Using forms is a vital building block for your Web application knowledge. After this lesson, you should be able to:</p>
<ol type="1">
<li>Describe the interaction between the client and server when an HTML form is loaded into the browser, the user submits it, and the server processes it</li>
<li>Create an HTML form using the Pug template engine</li>
<li>Use express to handle a form’s POST request</li>
<li>Use the built-in <code>express.urlencoded()</code> middleware function to parse incoming request body form data</li>
<li>Explain what data validation is and why it’s necessary for the server to validate incoming data</li>
<li>Validate user-provided data from within an Express route handler function</li>
<li>Write a custom middleware function that validates user-provided data</li>
<li>Use the <code>csurf</code> middleware to embed a token value in forms to protect against Cross-Site Request Forgery exploits</li>
</ol>
<hr />
<h1 id="html-forms-an-introduction">HTML Forms: An Introduction</h1>
<p>HTML Forms are an essential and ubiquitous part of the web. You use forms to search, create resources (i.e. account, posts), update resources, and more.</p>
<p>While forms may seem simple on the surface, there’s more complexity that you have to think about as a developer when you’re building a web app that uses HTML forms. In this introductory lesson you will learn about:</p>
<ul>
<li>the key components of a form</li>
<li>the client and browser interaction when it comes to handling HTML forms</li>
<li>the usual flow of a form submission</li>
</ul>
<h2 id="key-components-of-a-form">Key components of a form</h2>
<p>Let’s imagine that a user just landed on a website you built and loads up a form that allows users to sign up for a mailing list.</p>
<p>The browser would load up HTML that includes something like this:</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb176-1" title="1"><span class="kw">&lt;h1&gt;</span>Sign up for an account<span class="kw">&lt;/h1&gt;</span></a>
<a class="sourceLine" id="cb176-2" title="2"><span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;/sign-up&quot;</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb176-3" title="3">  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;name&quot;</span><span class="kw">&gt;</span>Name:<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb176-4" title="4">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> id=</span><span class="st">&quot;name&quot;</span><span class="ot"> name=</span><span class="st">&quot;fullname&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb176-5" title="5"></a>
<a class="sourceLine" id="cb176-6" title="6">  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;email&quot;</span><span class="kw">&gt;</span>Email:<span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb176-7" title="7">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;email&quot;</span><span class="ot"> id=</span><span class="st">&quot;email&quot;</span><span class="ot"> name=</span><span class="st">&quot;email&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb176-8" title="8"></a>
<a class="sourceLine" id="cb176-9" title="9">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value=</span><span class="st">&quot;Sign Up&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb176-10" title="10"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>Let’s first break down the various components of the form.</p>
<h3 id="form"><code>&lt;form&gt;</code></h3>
<p>The <code>&lt;form&gt;</code> element is the parent element of all of the input fields. This element has two attributes that are unique to <code>&lt;form&gt;</code> elements: <code>action</code> and <code>method</code>.</p>
<p>The <code>action</code> attribute defines the location (URL) where the form should send the data to when it is submitted. In this example, the <code>action</code> attribute has a value of <code>/sign-up</code>. The <code>action</code> can be set to either an <a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_is_a_URL#Examples_of_absolute_URLs">absolute URL</a> or a <a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_is_a_URL#Examples_of_relative_URLs">relative URL</a>. If it is a relative URL (ex: <code>/sign-up</code>), then it will be sent to the server that served up the website that the user is on.</p>
<p>The <code>method</code> attribute defines the HTTP verb that should be used to make the request to the server. Browsers support only two values for this attribute: "get" and "post". You will use "post" 99% of the time.</p>
<blockquote>
<p>Forms typically use POST requests because POST requests are used to send data that results in a change on the server. For example, if someone wanted to sign up for an account, that form would use a POST request. In contrast, GET requests are used to retrieve data from the server. A typical use case for a form that uses a GET method is a search form. For example, the search input on www.google.com is part of a form that uses a GET method.</p>
</blockquote>
<p>In this example, when the form is submitted, it will make a POST request to the server’s <code>/sign-up</code> route.</p>
<h3 id="input"><code>&lt;input&gt;</code></h3>
<p>In this example, there are two input fields for entering data: one for the user’s name, and one for the user’s email. These fields are represented by the <code>&lt;input&gt;</code> element.</p>
<p>Notice how there is a <code>type</code> attribute in each <code>&lt;input&gt;</code> element. The type attribute tells the browser what kind of input it expects, and the browser enforces different rules for each type of input.</p>
<p>For example, in the <code>&lt;input&gt;</code> field with <code>type="email"</code>, if the user tries to submit an email that does not have the "@" character in it, then most browsers will display notify users that they have put in an invalid email address.</p>
<p>There are several types of inputs, including number, password, and checkbox. You can learn more about all of the different types types in the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input">MDN docs on input types</a>. Some of the less-commonly-used ones are quite interesting!</p>
<p>There are also other HTML elements that serve as data input fields but are not represented by an <code>&lt;input&gt;</code> element, such as <code>&lt;textarea&gt;</code> and <code>&lt;select&gt;</code>.</p>
<p>The first two <code>&lt;input&gt;</code> fields in the example also have a <code>name</code> attribute. The <code>name</code> attribute is important because when the form data is sent to the server, the data is represented in key-value pairs with the value of the <code>name</code> attribute set as the key. For form submissions with a "post" method, the input field data would be sent to the server in the body of the HTTP request in the <code>x-www-form-urlencoded</code> format. For example, the data for the example form would look something like this when it is submitted to the server:</p>
<pre class="plaintext"><code>fullname=John+Doe&amp;email=john@doe.com</code></pre>
<p>The <code>id</code> attribute ties the <code>&lt;input&gt;</code> element to the <code>&lt;label&gt;</code> element by matching the <code>&lt;label&gt;</code> element’s <code>for</code> attribute. Associating a <code>&lt;label&gt;</code> element with the <code>&lt;input&gt;</code> field in this way offers accessibility and useability benefits. For example, if the user clicks on a <code>&lt;label&gt;</code> element that is associated with an <code>&lt;input&gt;</code> field, then the <code>&lt;input&gt;</code> field would come into focus.</p>
<p>Finally, the last <code>&lt;input&gt;</code> element with <code>type="submit"</code> is unique in that it does not store any data. Instead, this element renders as a button with text that is equal to its <code>value</code> attribute. You could also write <code>&lt;input&gt;</code> elements with <code>type="submit"</code> as a <code>&lt;button&gt;</code> element, like this: <code>&lt;button type="submit"&gt;Sign Up&lt;/button&gt;</code>. When the user clicks on this button, then the form is submitted.</p>
<h2 id="submitting-the-form">Submitting the form</h2>
<p>As mentioned earlier, when this form is submitted, it will make a POST request to the server’s <code>/sign-up</code> route.</p>
<p>In the previous lesson, you learned about routing in an Express server, so you can imagine that the above example might make a request to a route that looks something like this:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb178-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/sign-up&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb178-2" title="2">  <span class="co">// handle the request here</span></a>
<a class="sourceLine" id="cb178-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>When the request reaches the server, the data captured in the form is then validated. For example, you might want to set up a validation that verifies that the user actually typed something into the <code>fullname</code> field before submitting.</p>
<blockquote>
<p>There are various validations that you can set on the frontend elements themselves. For example, if you add a <code>required</code> attribute to an <code>&lt;input&gt;</code> field, then the browser would prevent the user from being able to submit a form if that required field were empty. <strong>However</strong>, frontend validations can be easily manipulated: someone could simply open up the dev tools and remove the <code>required</code> attribute and then submit the form with an empty input. This is why server-side validations are crucial and necessary.</p>
</blockquote>
<p>If the data is invalid, then the server would send back error messages to the frontend to be displayed to the user. For example, if the user had submitted a form with an empty <code>fullname</code> field, then the server can send back an error message to notify the user that the "Name field is required". Specifically, the error would return a complete HTML page containing the entire form along with the error messages. This is so that the user can resolve the error and then resubmit the form, effectively repeating the whole form submission process again.</p>
<p>Validations can also be more robust than simple checks for whether or not a field was filled out. As a developer, you can customize and set up any sort of validation on the data that the user is submitting. In a later reading, you’ll learn more about validations.</p>
<p>Finally, once the user resolves the errors, then the server can successfully process the data. At this point, the server would typically redirect the user to a different page by responding with a <code>302 Found</code> status. For example, if a user had just signed up for a new account, the server might redirect them to the profile page after they have successfully signed up.</p>
<h2 id="what-youve-learned-1">What you’ve learned</h2>
<p>In this reading, you learned about:</p>
<ul>
<li>the key components of a form</li>
<li>the client and browser interaction when it comes to handling HTML forms</li>
<li>the usual flow of a form submission</li>
</ul>
<p>In the next reading, you’ll get an opportunity to build out a form that interacts with an Express server!</p>
<hr />
<h1 id="html-forms-in-express">HTML Forms in Express</h1>
<p>In the previous reading, you learned about the fundamental components of an HTML form and how the client and server interacts when a form is submitted.</p>
<p>In this reading, you’ll learn how to:</p>
<ul>
<li>Create an HTML form using the Pug template engine.</li>
<li>Define a pair of GET and POST routes to deliver an HTML form to the user and process requests from that form.</li>
<li>Create and use a Pug layout template to eliminate code duplication across Pug views.</li>
<li>Configure an Express application to use the built-in <code>urlencoded</code> middleware function to parse incoming request body form data (encoded as x-www-form-urlencoded).</li>
</ul>
<h2 id="forms-example-setup">Forms example setup</h2>
<p>Let’s learn about forms with an example. In this example, your friends are having a wedding, and they want you want to build a simple website that lets them keep track of their guest list!</p>
<p>Here’s how the website will work:</p>
<ol type="1">
<li>The website has two main pages: the home page where your friends can see the full list of guests, and a "guest form" page that has a form where they can add guests.</li>
<li>At the top of both pages, there should be two links that lets them easily navigate back and forth between the home page and the guest form page.</li>
<li>When they add a guest, they should be redirected back to the home page so they can see the newly added guest.</li>
</ol>
<p>Follow along by creating a <code>forms-demo</code> directory, starting up a Node project, installing the dependencies, and then creating the necessary files:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb179-1" title="1"><span class="fu">mkdir</span> forms-demo</a>
<a class="sourceLine" id="cb179-2" title="2"><span class="bu">cd</span> forms-demo</a>
<a class="sourceLine" id="cb179-3" title="3"><span class="ex">npm</span> init --yes</a>
<a class="sourceLine" id="cb179-4" title="4"><span class="ex">npm</span> install express@^4.0.0 pug@^2.0.0</a>
<a class="sourceLine" id="cb179-5" title="5"><span class="ex">npm</span> install nodemon@^2.0.0 --save-dev</a>
<a class="sourceLine" id="cb179-6" title="6"><span class="fu">mkdir</span> views</a>
<a class="sourceLine" id="cb179-7" title="7"><span class="fu">touch</span> index.js views/index.pug</a></code></pre></div>
<p>Since this example will be used and built upon in all of the remaining readings in this lesson, it’s highly recommended that you actively follow along in this example. Executing the above commands should leave you with a <code>forms-demo</code> directory that looks like:</p>
<pre class="plaintext"><code>forms-demo
│   node_modules/
|   views/
│   │   index.pug
│   index.js
│   package-lock.json
│   package.json</code></pre>
<p>Let’s also set up a <code>start</code> script. Update your <code>package.json</code> so that it looks something like:</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb181-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb181-2" title="2">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;forms-demo&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-3" title="3">  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-4" title="4">  <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-5" title="5">  <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;index.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-6" title="6">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb181-7" title="7">    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon index.js&quot;</span></a>
<a class="sourceLine" id="cb181-8" title="8">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb181-9" title="9">  <span class="dt">&quot;keywords&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-10" title="10">  <span class="dt">&quot;author&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-11" title="11">  <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;ISC&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-12" title="12">  <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb181-13" title="13">    <span class="dt">&quot;express&quot;</span><span class="fu">:</span> <span class="st">&quot;^4.17.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb181-14" title="14">    <span class="dt">&quot;pug&quot;</span><span class="fu">:</span> <span class="st">&quot;^2.0.4&quot;</span></a>
<a class="sourceLine" id="cb181-15" title="15">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb181-16" title="16">  <span class="dt">&quot;devDependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb181-17" title="17">    <span class="dt">&quot;nodemon&quot;</span><span class="fu">:</span> <span class="st">&quot;^2.0.2&quot;</span></a>
<a class="sourceLine" id="cb181-18" title="18">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb181-19" title="19"><span class="fu">}</span></a></code></pre></div>
<p>Don’t worry if the minor and patch versions of your dependencies don’t end up matching exactly.</p>
<p>In your <code>index.js</code> file, set up the your Express server. In the server file, keep track of your guests with an array. When the server is first started, the guests array should be empty. Keep in mind that this guests array will be reset every time the server/application restarts. In a future lesson, you’ll learn how to persist this type of data to a database in your Express applications.</p>
<p>Go ahead and also set up a root route that renders the <code>index.pug</code> template along with the <code>title</code> and <code>guests</code> array:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb182-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb182-2" title="2"></a>
<a class="sourceLine" id="cb182-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb182-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb182-5" title="5"></a>
<a class="sourceLine" id="cb182-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb182-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&quot;view engine&quot;</span><span class="op">,</span> <span class="st">&quot;pug&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb182-8" title="8"></a>
<a class="sourceLine" id="cb182-9" title="9"><span class="kw">const</span> guests <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb182-10" title="10"></a>
<a class="sourceLine" id="cb182-11" title="11"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb182-12" title="12"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb182-13" title="13">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;index&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest List&quot;</span><span class="op">,</span> guests <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb182-14" title="14"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb182-15" title="15"></a>
<a class="sourceLine" id="cb182-16" title="16"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb182-17" title="17"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb182-18" title="18"></a>
<a class="sourceLine" id="cb182-19" title="19"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Finally, populate the <code>index.pug</code> template with some Pug content. Set the <code>title</code> in the <code>head</code> element, render an <code>h1</code> element to display the <code>title</code>, and then also set up two links to allow users to easily navigate back and forth between the <code>/</code> and <code>/guest</code> URL.</p>
<p>Underneath the navigation links, render a <code>table</code> element that will be used to keep track of all of the invited guests. There will be three pieces of information will be tracked for each guest:</p>
<ul>
<li>Full Name</li>
<li>Email</li>
<li>Guests (i.e. will they have a "plus one"? Can they bring their kids?)</li>
</ul>
<p>After following the instructions above, your <code>index.pug</code> should look something like this:</p>
<pre class="pug"><code>doctype html
html
  head
    title= title
  body
    h1= title
    div
      a(href=&quot;/&quot;) Home
    div
      a(href=&quot;/guest&quot;) Add Guest

    table
      thead
        tr
          th Full Name
          th Email
          th # Guests
      tbody
        each guest in guests
          tr
            td #{guest.fullname}
            td #{guest.email}
            td #{guest.numGuests}</code></pre>
<p>Alright! At this point you should be able to start up your server by running <code>npm start</code>. Navigate to <code>http://localhost:8081/</code> to see a page with an <code>h1</code> element that says "Guest List", two navigation links, and an empty guests table.</p>
<h2 id="getting-the-add-guest-form">Getting the "Add Guest" form</h2>
<p>Now that you have the home page set up, let’s first set up the <code>/guest</code> route and view.</p>
<p>As a reminder, this view should show a very basic form that allows users to add a guest to the guest list.</p>
<p>First, create a <code>guest-form.pug</code> template for that view, and add a simple form to it with a full name input field, an email input field, a number of guests input field, and a submit input.</p>
<p>Then, add the <code>method</code> and <code>action</code> attributes to the form. Use "post" for the <code>method</code> attribute. For <code>action</code>, go ahead and set it so that the form submission is routed to "/guest":</p>
<p>Here’s what your <code>guest-form.pug</code> file should look like:</p>
<pre class="pug"><code>h2 Add Guest
form(method=&quot;post&quot; action=&quot;/guest&quot;)
  label(for=&quot;fullname&quot;) Full Name:
  input(type=&quot;fullname&quot; id=&quot;fullname&quot; name=&quot;fullname&quot;)
  label(for=&quot;email&quot;) Email:
  input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot;)
  label(for=&quot;numGuests&quot;) Num Guests
  input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot;)
  input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)</code></pre>
<blockquote>
<p><strong>Note:</strong> You’ll want to be sure that the <code>name</code> of your inputs are consistent with the <code>guests</code> array object properties. The rationale for this will become clearer later in the reading when you start saving each guest into the <code>guests</code> array, but essentially, you want to keep your variable names consistent between the frontend and the backend.</p>
</blockquote>
<p>Then, set up the route in the Express server so that the <code>guest-form.pug</code> template gets rendered when the user navigates to <code>localhost:8081/guest</code>. For this route, set the <code>title</code> to "Guest Form":</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb185-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb185-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb185-3" title="3"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb185-4" title="4"><span class="co">// REST OF FILE NOT SHOWN</span></a></code></pre></div>
<p>Here’s what the <code>index.js</code> file should look like now:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb186-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb186-2" title="2"></a>
<a class="sourceLine" id="cb186-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb186-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb186-5" title="5"></a>
<a class="sourceLine" id="cb186-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb186-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&quot;view engine&quot;</span><span class="op">,</span> <span class="st">&quot;pug&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb186-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb186-9" title="9"></a>
<a class="sourceLine" id="cb186-10" title="10"><span class="kw">const</span> guests <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb186-11" title="11"></a>
<a class="sourceLine" id="cb186-12" title="12"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb186-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb186-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;index&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest List&quot;</span><span class="op">,</span> guests <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb186-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb186-16" title="16"></a>
<a class="sourceLine" id="cb186-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb186-18" title="18">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb186-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb186-20" title="20"></a>
<a class="sourceLine" id="cb186-21" title="21"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb186-22" title="22"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb186-23" title="23"></a>
<a class="sourceLine" id="cb186-24" title="24"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>When users navigate to <code>localhost:8081/guest</code>, the HTTP request will be routed to the <code>app.get('/guest')</code> route, which responds by rendering the <code>guest-form.pug</code> template. You should now see a form that allows users to input a guest’s email, full name, and number of allowed guests.</p>
<h2 id="a-quick-aside-pug-layout-templates">A quick aside: Pug layout templates</h2>
<p>One thing to note right now is that the <code>guest-form.pug</code> template is missing the navigation links that allows users to easily move back and forth between the home page and the guest form page.</p>
<p>To fix this, you have a couple of options. You could simply copy and paste the top of <code>index.pug</code> to the top of <code>guest-form.pug</code>. However, this solution quickly grows unwieldy once you need to add other templates that also need easy navigation.</p>
<p>Fortunately, Pug provides a clean way of preventing duplication of code with its template inheritance feature. Pug provides two keywords for template inheritance: <code>block</code> and <code>extends</code>.</p>
<p>According to the <a href="https://pugjs.org/language/inheritance.html">Pug documentation</a>, a <code>block</code> is a chunk of Pug code that "a child template can replace". To understand what this means, go ahead and start a new template called <code>layout.pug</code>.</p>
<p>Then, move all of the content that you’d like all of your templates to share into this <code>layout.pug</code> file. Finally, at the bottom, declare a new <code>block</code> by writing "<code>block content</code>", and nest an <code>h1</code> element in that <code>block</code> that says "This is the layout template." Here’s what your new <code>layout.pug</code> template should look like:</p>
<pre class="pug"><code>doctype html
html
  head
    title= title
  body
    h1= title
    div
      a(href=&quot;/&quot;) Home
    div
      a(href=&quot;/guest&quot;) Add Guest

    block content
      h1 This is the layout template</code></pre>
<p>Next, update your <code>index.pug</code> to this:</p>
<pre class="pug"><code>extends layout.pug

block content
  table
    thead
      tr
        th Full Name
        th Email
        th # Guests
    tbody
      each guest in guests
        tr
          td #{guest.fullname}
          td #{guest.email}
          td #{guest.numGuests}
</code></pre>
<p>Finally, update your <code>guest-form.pug</code> file to this:</p>
<pre class="pug"><code>extends layout.pug

block content
  h2 Add Guest
  form(method=&quot;post&quot; action=&quot;/guest&quot;)
    label(for=&quot;fullname&quot;) Full Name:
    input(type=&quot;fullname&quot; id=&quot;fullname&quot; name=&quot;fullname&quot;)
    label(for=&quot;email&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot;)
    label(for=&quot;numGuests&quot;) Num Guests
    input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot;)
    input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)
</code></pre>
<p>Then, navigate back and forth between <code>localhost:8081/</code> and <code>localhost:8081/guest</code> and see what happens.</p>
<p>Let’s explore how this works. The <code>extends</code> key word denotes that the <code>index.pug</code> and <code>guest-form.pug</code> templates are now inheriting from the <code>layout.pug</code> template. This means that when the <code>index.pug</code> and <code>guest-form.pug</code> templates are rendered, they will render all of the content that exists in <code>layout.pug</code>.</p>
<p>The <code>block</code> allows for any child template to redefine the content within that block. In <code>layout.pug</code>, a <code>block</code> named "content" is defined with an <code>h1</code> element underneath it. In <code>guest-form.pug</code>, the "content" <code>block</code> is now redefined to render the guest <code>form</code> instead of that <code>h1</code> element.</p>
<p>This would work even if the original "content" <code>block</code> in <code>layout.pug</code> had no content inside of it. For example, go ahead and remove that "This is the layout template" <code>h1</code> from <code>layout.pug</code>, and notice how the <code>block</code> redefinition still works. You don’t need to add that <code>h1</code> back to the template. That was only there to make <code>block</code> redefinitions a little bit clearer.</p>
<p>Using template inheritance, you can simply inherit from <code>layout.pug</code> in all of your new Pug templates. This is especially useful if you want to render the same navigation elements throughout your entire web application.</p>
<h2 id="submitting-the-guest-form">Submitting the guest form</h2>
<p>Let’s get back to finishing up the guest form.</p>
<p>Right now, if the user submits the form, it makes a POST request to "/guest". Set up the route that would handle this request:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb190-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb190-2" title="2">  <span class="co">// MORE CODE TO COME</span></a>
<a class="sourceLine" id="cb190-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h3 id="x-www-form-urlencoded"><code>x-www-form-urlencoded</code></h3>
<p>The previous reading briefly touched on how when forms are submitted with a "post" method, the data is sent to the server in the body of the HTTP request. It also mentioned how the data is encoded in a <code>x-www-form-urlencoded</code> format. Simply put, <code>x-wwww-form-urlencoded</code> format means that the data is formatted in a consistent way so that the server understands exactly what is being submitted.</p>
<p>This will make more sense with an example. When input data is sent in the body of the HTTP request, they’re sent in a key-value string format, like this: <code>fullname=[FULLNAME_VALUE]&amp;email=[EMAIL_VALUE]&amp;numGuests=[NUM_GUESTS_VALUE]</code>.</p>
<p>Let’s suppose you know a married couple called Jack Hill and Jill Hill. You plan on inviting them, but you really don’t want to have to enter them twice. Plus, they’re one of those couples that share email addresses, so it would be super convenient to enter them as one entry. So for the fullname field, you enter "Jack&amp;Jill Hill". In the email field, you enter their email, "jack.jill@hill.com", and then put down "2" for number of guests.</p>
<p>The problem here is that some characters in the key-value string format have special meaning. For example, notice how the "&amp;" character is used to split the two key-value pairs.</p>
<p>Unfortunately, because you put down "Jack&amp;Jill Hill" for the <code>fullname</code> field, it could be confusing as to whether or not the "&amp;" character was actually part of one of the input values or if it’s there to split up a key-value pair. In order to clarify the meaning, the data string needs to be encoded so that those special characters are consistently mapped to other characters that don’t have special meaning.</p>
<p>So in our example, the "@" character would be represented instead by "%40" and the "&amp;" symbol would be represented by "%3D". This results in the data being sent in the <code>x-www-form-urlencoded</code> format that looks like this: <code>fullname=Jack%3DJill+Hill&amp;email=jack.jill%40hill.com&amp;numGuests=2</code>.</p>
<blockquote>
<p>"%40" and "%3D" are <a href="https://en.wikipedia.org/wiki/Percent-encoding">percent encoded</a> values. Values after the "%" character are hexadecimal values.</p>
</blockquote>
<h3 id="parsing-the-request-body">Parsing the request body</h3>
<p>Once the request reaches the server, because the body of the request is now encoded in an <code>x-www-form-urlencoded</code> format, it needs to be decoded and parsed, preferably into a format that would be easy for the routes to handle.</p>
<p>Fortunately, the Express framework comes with a middleware function that does this for us. You’ll learn more about middleware in an upcoming reading, but for now, go ahead and add <code>app.use(express.urlencoded())</code> to your <code>index.js</code> file under where the view engine is being set:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb191-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb191-2" title="2"></a>
<a class="sourceLine" id="cb191-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb191-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb191-5" title="5"></a>
<a class="sourceLine" id="cb191-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb191-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&quot;view engine&quot;</span><span class="op">,</span> <span class="st">&quot;pug&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb191-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb191-9" title="9"></a>
<a class="sourceLine" id="cb191-10" title="10"><span class="kw">const</span> guests <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb191-11" title="11"></a>
<a class="sourceLine" id="cb191-12" title="12"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb191-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb191-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;layout&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest List&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb191-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb191-16" title="16"></a>
<a class="sourceLine" id="cb191-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/guest-form&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb191-18" title="18">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb191-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb191-20" title="20"></a>
<a class="sourceLine" id="cb191-21" title="21"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb191-22" title="22">  <span class="co">// MORE CODE TO COME</span></a>
<a class="sourceLine" id="cb191-23" title="23"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb191-24" title="24"></a>
<a class="sourceLine" id="cb191-25" title="25"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb191-26" title="26"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb191-27" title="27"></a>
<a class="sourceLine" id="cb191-28" title="28"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Because of the <code>express.urlencoded()</code> middleware function, the body data is now available in the <code>req</code> object. Specifically, <code>req.body</code> has now been formatted as an object that looks like this:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb192-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb192-2" title="2">  <span class="dt">fullname</span><span class="op">:</span> <span class="st">&#39;Jack&amp;Jill Hill&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb192-3" title="3">  <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;jack.jill@hill.com&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb192-4" title="4">  <span class="dt">numGuests</span><span class="op">:</span> <span class="st">&#39;2&#39;</span></a>
<a class="sourceLine" id="cb192-5" title="5"><span class="op">}</span></a></code></pre></div>
<blockquote>
<p>Notice how the number of guests field is a string even though the <code>input</code> type was a "number". This will be discussed in more detail in the next reading.</p>
</blockquote>
<p>Let’s parse out the fields from the <code>req.body</code> object and push this guest entry into the <code>guests</code> array. Then, redirect the user back to the home page by using the <code>res</code> object’s <code>redirect</code> method. That method redirects the user by sending a response with a <code>302 Found</code> HTTP status code to the client.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb193-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb193-2" title="2">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb193-3" title="3">    <span class="dt">fullname</span><span class="op">:</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">fullname</span><span class="op">,</span></a>
<a class="sourceLine" id="cb193-4" title="4">    <span class="dt">email</span><span class="op">:</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">email</span><span class="op">,</span></a>
<a class="sourceLine" id="cb193-5" title="5">    <span class="dt">numGuests</span><span class="op">:</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">numGuests</span></a>
<a class="sourceLine" id="cb193-6" title="6">  <span class="op">};</span></a>
<a class="sourceLine" id="cb193-7" title="7">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb193-8" title="8">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb193-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>To recap, when the user submits the add guest form, the following happens:</p>
<ol type="1">
<li>Because the <code>&lt;form&gt;</code> has a "post" <code>method</code>, the form data is sent in the body of the HTTP request in an <code>x-www-form-urlencoded</code> format.</li>
<li>When the request reaches the server, the <code>express.urlencoded</code> middleware function parses the urlencoded body into an object available via the <code>req.body</code> property.</li>
<li>The request is handled by the <code>/guest</code> POST route.</li>
<li>After the guest is added to the <code>guests</code> array, the server redirects the user back to the home page by sending a <code>302 Found</code> response. (Feel free confirm this in the <code>network</code> tab of your developer tools.)</li>
<li>When users lands on the home page, they can see the newly added guest in the guests table.</li>
</ol>
<h2 id="what-youve-learned-2">What you’ve learned</h2>
<p>There were a lot of steps that went into submitting just one simple form, but this form submission process is a common flow that you’ll encounter often as a developer!</p>
<p>In this reading, you learned how to:</p>
<ul>
<li>Create an HTML form using the Pug template engine.</li>
<li>Define a pair of GET and POST routes to deliver an HTML form to the user and process requests from that form.</li>
<li>Create and use a Pug layout template to eliminate code duplication across Pug views.</li>
<li>Configure an Express application to use the built-in <code>urlencoded</code> middleware function to parse incoming request body form data (encoded as x-www-form-urlencoded).</li>
</ul>
<hr />
<h1 id="data-validation">Data Validation</h1>
<p>When setting up HTML forms, it’s important to check and clean the incoming data to ensure that the data is correct.</p>
<p>In this lesson, you will:</p>
<ol type="1">
<li>Understand what data validation is and why it’s necessary for the server to validate incoming data.</li>
<li>Validate user-provided data from within an Express route handler function and return a response containing user-friendly validation error messages when necessary.</li>
</ol>
<h2 id="importance-of-server-side-data-validation">Importance of server-side data validation</h2>
<p>Data validation is the process of ensuring that the incoming data is correct. This section will cover the rationale for validating incoming data on the server side.</p>
<p>Even though you could add add validations on the client side, client-side validations are not as secure and can be circumvented. Because client-side validations can be circumvented, it’s necessary to implement server-side data validations.</p>
<h3 id="lack-of-trust-in-client-side-validations">Lack of trust in client-side validations</h3>
<p>Let’s talk through an example. Suppose you had an HTML form that collects a user’s age. First of all, the whole point of the form is to collect the user’s age, so you want to ensure that the "age" field is not blank. To account for this, you set a <code>required</code> attribute on the age <code>&lt;input&gt;</code>.</p>
<p>You also want to make sure that users submit a number for their age, so you set the <code>&lt;input&gt;</code> field’s <code>type</code> attribute equal to "number":</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb194-1" title="1"><span class="kw">&lt;for</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="ot"> action=</span><span class="st">&quot;/age&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb194-2" title="2">  <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;age&quot;</span><span class="kw">&gt;</span>Age: <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb194-3" title="3">  <span class="kw">&lt;input</span><span class="ot"> required type=</span><span class="st">&quot;number&quot;</span><span class="ot"> id=</span><span class="st">&quot;age&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb194-4" title="4">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb194-5" title="5"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<p>Excellent, now, whenever users fill out this form, they’re unable to submit the form unless the "age" field is filled out with a number. This seems like it would ensure that you have clean and correct data being submitted to your server.</p>
<p>Unfortunately, those frontend validations are not reliable. Someone could open up the developer’s console and remove the <code>required</code> attribute, and then change the <code>type</code> to equal "text".</p>
<p>Another situation to account for is that the end user might not even be using that specific form to submit data. Someone could be programmatically submitting a POST request to the server. In this scenario, they would never interact with the HTML form and its validations.</p>
<p>Ultimately, client-side validations are good for immediate feedback to the user, but they should not be relied upon for enforcing clean data submission.</p>
<h2 id="server-side-validations">Server-side validations</h2>
<p>So what kind of data validations should you implement on the server side? Let’s walk through a few examples.</p>
<h3 id="expected-data-types">Expected data types</h3>
<p>The previous reading discussed how when a form is submitted, the data is typically urlencoded. One effect of this url encoding is that each value will arrive at the server as a string. Because of this, there’s a tremendous need to validate that the provided string can be successfully converted to the desired type.</p>
<p>The previous example about the "age" field discussed how a user could circumvent the <code>type="number"</code> attribute on the frontend. Without server-side data validation on that "age" field, you could end up with an invalid value (for example, <code>NaN</code>) when trying to convert the "age" value into a number in the server.</p>
<p>Other examples of data type validations include:</p>
<ul>
<li>Checking for integer vs. float (perhaps you want to only store the user’s age as an integer)</li>
<li>Checking that an input date string can be converted to a valid date.</li>
</ul>
<h3 id="valid-ranges-and-format">Valid ranges and format</h3>
<p>To continue with our "age" field example, one logical validation you might want to enforce is that users submit a valid age. For example, it’s unlikely that a user is over 120 years old.</p>
<p>You could also check that values come in the correct format. A telephone number should not have any letters in it, and if you want to ensure that it is a US-based telephone number, you might also want to check that the phone number is 10 digits long.</p>
<p>Another example might be that you want to ensure that your users are creating strong and secure passwords. To do this, you could require and check for the presence of a symbol and a number in the password, or prevent users from setting "password" as their password.</p>
<h3 id="other-validations">Other validations</h3>
<p>Validations do not have to be constrained to just checking one field at a time. To continue with the example on passwords, let’s suppose you also wanted to add a "Confirm Password" field to ensure that users did not make a typo on their password when creating an account. In this scenario, it’s necessary to add a validation to ensure that the "Password" and "Confirmed Password" fields have the same value.</p>
<p>Validations could get even more complex based on the needs of your application. For example, let’s suppose you have a form for users to order products. You probably want to validate that their selected shipment order is valid given the order’s weight and destination postal code. After all, you don’t want users trying to select "1-day delivery" for a couch that needs to be transported across the country.</p>
<h2 id="server-side-validations-an-example">Server-side validations: an example</h2>
<p>Let’s pick up where last reading’s example left off and add some server-side validations. As a reminder, in the last reading, you built a website that allows you to add guests to a guest list.</p>
<h3 id="setup">Setup</h3>
<p>At this moment, the directory of that example should look like this:</p>
<pre class="plaintext"><code>forms-demo
│   node_modules/
|   views/
│   │   guest-form.pug
│   │   index.pug
│   │   layout.pug
│   index.js
│   package-lock.json
│   package.json</code></pre>
<p>The <code>index.js</code> file should look like this:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb196-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-2" title="2"></a>
<a class="sourceLine" id="cb196-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb196-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb196-5" title="5"></a>
<a class="sourceLine" id="cb196-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb196-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&quot;view engine&quot;</span><span class="op">,</span> <span class="st">&quot;pug&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb196-9" title="9"></a>
<a class="sourceLine" id="cb196-10" title="10"><span class="kw">const</span> guests <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb196-11" title="11"></a>
<a class="sourceLine" id="cb196-12" title="12"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb196-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb196-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;index&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest List&quot;</span><span class="op">,</span> guests <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-16" title="16"></a>
<a class="sourceLine" id="cb196-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb196-18" title="18">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-20" title="20"></a>
<a class="sourceLine" id="cb196-21" title="21"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb196-22" title="22">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb196-23" title="23">    <span class="dt">fullName</span><span class="op">:</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">fullName</span><span class="op">,</span></a>
<a class="sourceLine" id="cb196-24" title="24">    <span class="dt">email</span><span class="op">:</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">email</span><span class="op">,</span></a>
<a class="sourceLine" id="cb196-25" title="25">    <span class="dt">numGuests</span><span class="op">:</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">numGuests</span></a>
<a class="sourceLine" id="cb196-26" title="26">  <span class="op">};</span></a>
<a class="sourceLine" id="cb196-27" title="27">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-28" title="28">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-29" title="29"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb196-30" title="30"></a>
<a class="sourceLine" id="cb196-31" title="31"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb196-32" title="32"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb196-33" title="33"></a>
<a class="sourceLine" id="cb196-34" title="34"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>The <code>views/layout.pug</code> template should look like this:</p>
<pre class="pug"><code>doctype html
html
  head
    title= title
  body
    h1= title
    div
      a(href=&quot;/&quot;) Home
    div
      a(href=&quot;/guest&quot;) Add Guest

    block content

</code></pre>
<p>The <code>views/index.pug</code> file should look like this:</p>
<pre class="pug"><code>extends layout.pug

block content
  table
    thead
      tr
        th Full Name
        th Email
        th # Guests
    tbody
      each guest in guests
        tr
          td #{guest.fullName}
          td #{guest.email}
          td #{guest.numGuests}
</code></pre>
<p>Finally, the <code>guest-form.pug</code> should look like this:</p>
<pre class="pug"><code>extends layout.pug

block content
  h2 Add Guest
  form(method=&quot;post&quot; action=&quot;/guest&quot;)
    label(for=&quot;fullName&quot;) Full Name:
    input(type=&quot;text&quot; id=&quot;fullName&quot; name=&quot;fullName&quot;)
    label(for=&quot;email&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot;)
    label(for=&quot;numGuests&quot;) Num Guests
    input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot;)
    input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)
</code></pre>
<h3 id="validations-checking-that-all-fields-are-filled">Validations: checking that all fields are filled</h3>
<p>First, because all three fields are important, let’s add validations to ensure that each of the field is filled out with a value before it can be successfully submitted.</p>
<p>To be clear, you can add a <code>required</code> attribute to the three <code>input</code> fields, and the user would not be able to submit until each field has a value. However, as was discussed in the previous reading, these kinds of front-end validations can be circumvented, so for this reading, let’s focus on how to implement these validations in the server.</p>
<p>To do this, instantiate an <code>errors</code> array in <code>app.post('/guest')</code>. Then, check for truthy values in each of the <code>req.body</code> fields, and if any of the fields are missing, then push in an error message into the <code>errors</code> array to notify the user about how that field is required:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb200-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb200-2" title="2">  <span class="kw">const</span> <span class="op">{</span> fullName<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb200-3" title="3">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb200-4" title="4"></a>
<a class="sourceLine" id="cb200-5" title="5">  <span class="cf">if</span> (<span class="op">!</span>fullName) <span class="op">{</span></a>
<a class="sourceLine" id="cb200-6" title="6">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the full name field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb200-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb200-8" title="8"></a>
<a class="sourceLine" id="cb200-9" title="9">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb200-10" title="10">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the email field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb200-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb200-12" title="12"></a>
<a class="sourceLine" id="cb200-13" title="13">  <span class="cf">if</span> (<span class="op">!</span>numGuests) <span class="op">{</span></a>
<a class="sourceLine" id="cb200-14" title="14">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the field for number of guests.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb200-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb200-16" title="16"></a>
<a class="sourceLine" id="cb200-17" title="17">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb200-18" title="18">    fullName<span class="op">,</span></a>
<a class="sourceLine" id="cb200-19" title="19">    email<span class="op">,</span></a>
<a class="sourceLine" id="cb200-20" title="20">    numGuests</a>
<a class="sourceLine" id="cb200-21" title="21">  <span class="op">};</span></a>
<a class="sourceLine" id="cb200-22" title="22">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb200-23" title="23">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb200-24" title="24"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Now, if the <code>errors</code> array has an error message in it, then don’t add the <code>guest</code> to the <code>guests</code> array. Instead, give the user an opportunity to fix the errors before resubmitting the form again.</p>
<p>You can do this by rendering the <code>guest-form.pug</code> template again along with the <code>errors</code> array. Then, update that template to display each error message to the user. Also, if there are errors, let’s go ahead and return out of the callback function and ensure that none of the code below executes. Add this below the validations:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb201-1" title="1"><span class="co">// VALIDATIONS HERE</span></a>
<a class="sourceLine" id="cb201-2" title="2"></a>
<a class="sourceLine" id="cb201-3" title="3"><span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb201-4" title="4">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span> errors <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb201-5" title="5">  <span class="cf">return</span><span class="op">;</span> <span class="co">// `return` if there are errors.</span></a>
<a class="sourceLine" id="cb201-6" title="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb201-7" title="7"></a>
<a class="sourceLine" id="cb201-8" title="8"><span class="co">// REST OF CODE NOT SHOWN</span></a></code></pre></div>
<p>Here’s what that route should look like now:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb202-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb202-2" title="2">  <span class="kw">const</span> <span class="op">{</span> fullName<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb202-3" title="3">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb202-4" title="4"></a>
<a class="sourceLine" id="cb202-5" title="5">  <span class="cf">if</span> (<span class="op">!</span>fullName) <span class="op">{</span></a>
<a class="sourceLine" id="cb202-6" title="6">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the full name field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb202-8" title="8"></a>
<a class="sourceLine" id="cb202-9" title="9">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb202-10" title="10">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the email field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb202-12" title="12"></a>
<a class="sourceLine" id="cb202-13" title="13">  <span class="cf">if</span> (<span class="op">!</span>numGuests) <span class="op">{</span></a>
<a class="sourceLine" id="cb202-14" title="14">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the field for number of guests.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb202-16" title="16"></a>
<a class="sourceLine" id="cb202-17" title="17">  <span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb202-18" title="18">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span> errors <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-19" title="19">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb202-20" title="20">  <span class="op">}</span></a>
<a class="sourceLine" id="cb202-21" title="21"></a>
<a class="sourceLine" id="cb202-22" title="22">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb202-23" title="23">    fullName<span class="op">,</span></a>
<a class="sourceLine" id="cb202-24" title="24">    email<span class="op">,</span></a>
<a class="sourceLine" id="cb202-25" title="25">    numGuests</a>
<a class="sourceLine" id="cb202-26" title="26">  <span class="op">};</span></a>
<a class="sourceLine" id="cb202-27" title="27">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-28" title="28">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-29" title="29"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Update <code>guest-form.pug</code> to display error messages whenever they exist:</p>
<pre class="pug"><code>
extends layout.pug

block content
  div
    ul
      each error in errors
        li #{error}
  h2 Add Guest
  form(method=&quot;post&quot; action=&quot;/guest&quot;)
    label(for=&quot;fullName&quot;) Full Name:
    input(type=&quot;text&quot; id=&quot;fullName&quot; name=&quot;fullName&quot;)
    label(for=&quot;email&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot;)
    label(for=&quot;numGuests&quot;) Num Guests
    input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot;)
    input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)

</code></pre>
<p>There’s one more thing to fix here. One problem is that when the user navigates to <code>localhost:8081/guest</code> now, when <code>guest-form.pug</code> is rendered, the <code>app.get('/guest')</code> route is not rendering an <code>errors</code> variable. Therefore, when <code>guest-form.pug</code> tries to iterate through the <code>errors</code> array, there’s an error because <code>errors</code> does not exist.</p>
<p>You have a couple of options here: you can either check for the truthiness of <code>errors</code> in <code>guest-form.pug</code>, or you can render an empty <code>errors</code> array variable in the <code>app.get('/guest')</code> route callback. For now, let’s go ahead and go with the first option and update the <code>guest-form.pug</code> template:</p>
<pre class="pug"><code>extends layout.pug

block content
  if errors
    div
      ul
        each error in errors
          li #{error}
  h2 Add Guest
  form(method=&quot;post&quot; action=&quot;/guest&quot;)
    label(for=&quot;fullName&quot;) Full Name:
    input(type=&quot;text&quot; id=&quot;fullName&quot; name=&quot;fullName&quot;)
    label(for=&quot;email&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot;)
    label(for=&quot;numGuests&quot;) Num Guests
    input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot;)
    input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)
</code></pre>
<p>Things should be working properly now! If the user forgets to submit any of the fields, the user should get a very specific message about which field needs to be filled out still.</p>
<h3 id="validations-ensuring-that-numguests-is-valid">Validations: ensuring that <code>numGuests</code> is valid</h3>
<p>Let’s add a couple more validations on the <code>numGuests</code> field to get really comfortable with data validations. First, it probably makes sense that the number of guests per entry on the guest list is at least one. Also, as previously mentioned, each of the values will arrive at the server as a string. Although, JavaScript automatically converts strings into numbers when a string is being compared to a number, it’s good practice to compare values of the same type.</p>
<p>This brings up another necessary validation. Add a validation that checks to make sure that the <code>numGuests</code> field is actually a value that can be converted into a number. When you’ve added these validations, your <code>app.post('/guest')</code> route should look something like this:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb205-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-2" title="2">  <span class="kw">const</span> <span class="op">{</span> fullName<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb205-3" title="3">  <span class="kw">const</span> numGuestsNum <span class="op">=</span> <span class="at">parseInt</span>(numGuests<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-4" title="4">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb205-5" title="5"></a>
<a class="sourceLine" id="cb205-6" title="6">  <span class="cf">if</span> (<span class="op">!</span>fullName) <span class="op">{</span></a>
<a class="sourceLine" id="cb205-7" title="7">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the full name field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb205-9" title="9"></a>
<a class="sourceLine" id="cb205-10" title="10">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb205-11" title="11">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the email field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb205-13" title="13"></a>
<a class="sourceLine" id="cb205-14" title="14">  <span class="cf">if</span> (<span class="op">!</span>numGuests <span class="op">||</span> numGuests <span class="op">&lt;</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb205-15" title="15">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out a valid number for number of guests.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb205-17" title="17"></a>
<a class="sourceLine" id="cb205-18" title="18">  <span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb205-19" title="19">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span> errors <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-20" title="20">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb205-21" title="21">  <span class="op">}</span></a>
<a class="sourceLine" id="cb205-22" title="22"></a>
<a class="sourceLine" id="cb205-23" title="23">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-24" title="24">    fullName<span class="op">,</span></a>
<a class="sourceLine" id="cb205-25" title="25">    email<span class="op">,</span></a>
<a class="sourceLine" id="cb205-26" title="26">    <span class="dt">numGuests</span><span class="op">:</span> numGuestsNum</a>
<a class="sourceLine" id="cb205-27" title="27">  <span class="op">};</span></a>
<a class="sourceLine" id="cb205-28" title="28">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-29" title="29">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-30" title="30"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>There are now validations in place to ensure that the <code>numGuests</code> field is a valid number that is greater than 0. Test to make sure this is working properly by changing the <code>numGuests</code> input type to "text" and submitting invalid data (you can either edit this directly in <code>guest-form.pug</code> or by opening up the developers console to edit the HTML)</p>
<h3 id="improve-user-experience">Improve user experience</h3>
<p>One thing that’s somewhat annoying right now is that any time there is a server-side error, all the fields get wiped, and the user has to fill them all out again. For example, even if the <code>fullName</code> and <code>email</code> fields were filled out without any issue, a small mistake on the <code>numGuests</code> field would require the user to have to start the whole process over again and fill out each field.</p>
<p>Let’s improve the user experience by pre-setting each field with the values that they had just submitted. To do this, whenever there is an error, not only should you render the <code>errors</code> array, but also go ahead and render back the values from <code>req.body</code>:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb206-1" title="1"><span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb206-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb206-3" title="3">    <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb206-4" title="4">    errors<span class="op">,</span></a>
<a class="sourceLine" id="cb206-5" title="5">    email<span class="op">,</span></a>
<a class="sourceLine" id="cb206-6" title="6">    fullName<span class="op">,</span></a>
<a class="sourceLine" id="cb206-7" title="7">    numGuests</a>
<a class="sourceLine" id="cb206-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb206-9" title="9">  <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb206-10" title="10"><span class="op">}</span></a></code></pre></div>
<p>Then, in <code>guest-form.pug</code>, set each input’s <code>value</code> attribute to equal the associated variables that was rendered back:</p>
<pre class="pug"><code>extends layout.pug

block content
  if errors
    div
      ul
        each error in errors
          li #{error}
  h2 Add Guest
  form(method=&quot;post&quot; action=&quot;/guest&quot;)
    label(for=&quot;fullName&quot;) Full Name:
    input(type=&quot;text&quot; id=&quot;fullName&quot; name=&quot;fullName&quot; value=fullName)
    label(for=&quot;email&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; value=email)
    label(for=&quot;numGuests&quot;) Num Guests
    input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot; value=numGuests)
    input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)
</code></pre>
<p>Go ahead and test out the improved user experience! Now, each field’s value should persist even if there was an error.</p>
<h2 id="recap">Recap</h2>
<p>In this lesson, you learned:</p>
<ol type="1">
<li>What data validation is and why it’s necessary for the server to validate incoming data.</li>
<li>How to validate user-provided data from within an Express route handler function and return a response containing user-friendly validation error messages when necessary.</li>
</ol>
<hr />
<h1 id="express-middleware">Express Middleware</h1>
<p>In a previous reading, we briefly introduced the urlencoded middleware function. Middleware functions are a critical part of a robust Express server. In this reading you will:</p>
<ol type="1">
<li>Understand that the request pipeline in an Express application is composed of a series of middleware functions.</li>
<li>Write a custom middleware function that validates user-provided data (submitted via an HTML form), sets an array of user-friendly validation error messages on the Request object when necessary, and passes control to the next middleware function.</li>
</ol>
<h2 id="middleware-overview">Middleware overview</h2>
<p>Express middleware is kind of a misnomer: because of the "middle" in "middleware", you might assume that middleware is anything that sits between the client and the Express server. However, according to the <a href="https://expressjs.com/en/guide/using-middleware.html">Express documentation on using middleware</a>: "An Express application is essentially a series of middleware function calls." Let’s dive into what this means.</p>
<p>For starters, start up a demo server by running the following commands:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb208-1" title="1"><span class="fu">mkdir</span> middleware-demo</a>
<a class="sourceLine" id="cb208-2" title="2"><span class="bu">cd</span> middleware-demo</a>
<a class="sourceLine" id="cb208-3" title="3"><span class="ex">npm</span> init --yes</a>
<a class="sourceLine" id="cb208-4" title="4"><span class="ex">npm</span> install express@^4.0.0</a>
<a class="sourceLine" id="cb208-5" title="5"><span class="ex">npm</span> install nodemon@^2.0.0 --save-dev</a>
<a class="sourceLine" id="cb208-6" title="6"><span class="fu">touch</span> index.js</a></code></pre></div>
<p>Then, in your <code>index.js</code>, handle get requests to the root path by responding with "Hello World!":</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb209-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb209-2" title="2"></a>
<a class="sourceLine" id="cb209-3" title="3"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb209-4" title="4"></a>
<a class="sourceLine" id="cb209-5" title="5"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-6" title="6">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&quot;Hello World!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb209-7" title="7"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb209-8" title="8"></a>
<a class="sourceLine" id="cb209-9" title="9"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb209-10" title="10"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">3000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb209-11" title="11"></a>
<a class="sourceLine" id="cb209-12" title="12"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Set up a <code>start</code> script in your <code>package.json</code>:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb210-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb210-2" title="2">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;middleware-demo&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb210-3" title="3">  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb210-4" title="4">  <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb210-5" title="5">  <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;index.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb210-6" title="6">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb210-7" title="7">    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon index.js&quot;</span></a>
<a class="sourceLine" id="cb210-8" title="8">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb210-9" title="9">  <span class="dt">&quot;keywords&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb210-10" title="10">  <span class="dt">&quot;author&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb210-11" title="11">  <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;ISC&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb210-12" title="12">  <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb210-13" title="13">    <span class="dt">&quot;express&quot;</span><span class="fu">:</span> <span class="st">&quot;^4.17.1&quot;</span></a>
<a class="sourceLine" id="cb210-14" title="14">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb210-15" title="15">  <span class="dt">&quot;devDependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb210-16" title="16">    <span class="dt">&quot;nodemon&quot;</span><span class="fu">:</span> <span class="st">&quot;^2.0.2&quot;</span></a>
<a class="sourceLine" id="cb210-17" title="17">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb210-18" title="18"><span class="fu">}</span></a></code></pre></div>
<p>Then start up your server by running <code>npm start</code></p>
<h3 id="anatomy-of-a-middleware-function">Anatomy of a middleware function</h3>
<p>In Express, a middleware function is a function that takes three arguments, in this specific order:</p>
<ol type="1">
<li><code>req</code>- the request object</li>
<li><code>res</code>- the response object</li>
<li><code>next</code>- according to the <a href="https://expressjs.com/en/guide/using-middleware.html">Express documentation on using middleware</a>: "the next middleware function in the application’s request-response cycle"</li>
</ol>
<p>These arguments might seem a little familiar. Up to this point, you’ve been handling all requests with a callback function that takes a <code>req</code> and <code>res</code> argument.</p>
<p>For example, take a look at the callback function that you just set up to send back "Hello World!": it takes <code>req</code> and <code>res</code> as the first two arguments. There is, in fact, an optional <code>next</code> argument that you could have passed into this function as well. The <code>next</code> argument will be discussed in more depth later in this reading.</p>
<p>This means that all of the callback functions that you’ve been writing this whole time to handle requests and send back responses are actually middleware functions.</p>
<h3 id="series-of-middleware-functions">Series of middleware functions</h3>
<p>As a reminder, the documentation mentioned that "an Express application is a <em>series</em> of middleware function calls." To explore what "series" means there, let’s set up another middleware function.</p>
<p>Here’s the goal: let’s set up a middleware function that logs the time of each request.</p>
<p>Remember, a middleware function takes three arguments: <code>req</code>, <code>res</code>, and <code>next</code>. In <code>index.js</code>, create a middleware function <code>logTime</code> that console logs the current time formatted as an ISO string. At the end of the middleware function, invoke the <code>next</code> function, which represents the next middleware function:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb211-1" title="1"><span class="kw">const</span> logTime <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb211-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Current time: &quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="at">Date</span>().<span class="at">toISOString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb211-3" title="3">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb211-4" title="4"><span class="op">};</span></a></code></pre></div>
<p>Now, update the <code>app.get('/')</code> route so that it calls <code>logTime</code> before it invokes the anonymous callback function that sends back "Hello World!":</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb212-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> logTime<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb212-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&quot;Hello World!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb212-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>To confirm that this is working, refresh <code>localhost:3000</code> and check that your server logs are showing the current time of each request.</p>
<p>Let’s recap what just happened:</p>
<ol type="1">
<li>When the user lands on <code>localhost:3000</code>, a GET request is made to the "/" route of the Express server.</li>
<li>The first middleware function this route invokes is <code>logTime</code>. In <code>logTime</code>, the current time is logged. At the end of <code>logTime</code>, it invokes <code>next</code>, which represents the next middleware function.</li>
<li>The next middleware function in this example is the anonymous callback function that runs <code>res.send("Hello World!")</code>.</li>
</ol>
<p>You could invoke as many middleware functions as you’d like. In addition, because the <code>req</code> and <code>res</code> objects are passed through every one of the middleware functions, you could store values in the <code>req</code> object for the next middleware function to use.</p>
<p>Let’s explore this by creating another middleware function called <code>passOnMessage</code>:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb213-1" title="1"><span class="kw">const</span> passOnMessage <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb213-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Passing on a message!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb213-3" title="3">  <span class="va">req</span>.<span class="at">passedMessage</span> <span class="op">=</span> <span class="st">&quot;Hello from passOnMessage!&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb213-4" title="4">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb213-5" title="5"><span class="op">};</span></a></code></pre></div>
<p>Then, let’s add this middleware function to the <code>app.get('/')</code> route and then console.log the <code>req.passedMessage</code> in one of the later middleware functions:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb214-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> logTime<span class="op">,</span> passOnMessage<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb214-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Passed Message: &quot;</span><span class="op">,</span> <span class="va">req</span>.<span class="at">passedMessage</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb214-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&quot;Hello World!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb214-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p>In the example above, the <code>passedMessage</code> was added to the <code>req</code> object so that it could be used in a later middleware function. Alternatively, you might instead want to store properties inside of the <a href="https://expressjs.com/en/4x/api.html#res.locals">res.local</a> object so that you don’t accidentally override an existing property in the <code>req</code> object.</p>
</blockquote>
<p>Instead of passing each middleware function in separate arguments, you could also pass them all in as one array argument:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb215-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> [logTime<span class="op">,</span> passOnMessage]<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb215-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Passed Message: &quot;</span><span class="op">,</span> <span class="va">req</span>.<span class="at">passedMessage</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb215-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&quot;Hello World!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb215-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The order does matter. Try changing up the order of the middleware functions and see the order of the console.log statements.</p>
<h3 id="application-level-middleware">Application-level middleware</h3>
<p>To be clear, with the current set up, <code>logTime</code> and <code>passOnMessage</code> will only be executed for the <code>app.get('/')</code> route. For example, let’s say you set up another route:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb216-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/bye&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb216-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&quot;Bye World.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb216-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Because that route does not currently take in <code>logTime</code> as one of its arguments, it would not invoke the <code>logTime</code> middleware function. To fix this, you could simply pass in the <code>logTime</code> function, but if there was a middleware function that you wanted to execute for every single route, this could be pretty tedious.</p>
<p>Setting up an application-level middleware function that runs for every single route is simple. In fact, the <code>express.urlencoded</code> middleware you set up in the previous reading was an application-level middleware.</p>
<p>To do this, remove <code>logTime</code> from the <code>app.get('/')</code> arguments. Instead, add it as an application-wide middleware by writing <code>app.use(logTime)</code>. After doing this, your <code>index.js</code> file should look like this:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb217-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-2" title="2"></a>
<a class="sourceLine" id="cb217-3" title="3"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb217-4" title="4"></a>
<a class="sourceLine" id="cb217-5" title="5"><span class="kw">const</span> logTime <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb217-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Current time: &quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="at">Date</span>().<span class="at">toISOString</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb217-7" title="7">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb217-8" title="8"><span class="op">};</span></a>
<a class="sourceLine" id="cb217-9" title="9"></a>
<a class="sourceLine" id="cb217-10" title="10"><span class="va">app</span>.<span class="at">use</span>(logTime)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-11" title="11"></a>
<a class="sourceLine" id="cb217-12" title="12"><span class="kw">const</span> passOnMessage <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb217-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Passing on a message!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-14" title="14">  <span class="va">req</span>.<span class="at">passedMessage</span> <span class="op">=</span> <span class="st">&quot;Hello from passOnMessage!&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb217-15" title="15">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb217-16" title="16"><span class="op">};</span></a>
<a class="sourceLine" id="cb217-17" title="17"></a>
<a class="sourceLine" id="cb217-18" title="18"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> passOnMessage<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb217-19" title="19">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Passed Message: &quot;</span><span class="op">,</span> <span class="va">req</span>.<span class="at">passedMessage</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-20" title="20">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&quot;Hello World!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-21" title="21"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-22" title="22"></a>
<a class="sourceLine" id="cb217-23" title="23"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/bye&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb217-24" title="24">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&quot;Bye World.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-25" title="25"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb217-26" title="26"></a>
<a class="sourceLine" id="cb217-27" title="27"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb217-28" title="28"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">3000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb217-29" title="29"></a>
<a class="sourceLine" id="cb217-30" title="30"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Now, whenever you navigate to either <code>localhost:3000</code> or <code>localhost:3000/bye</code>, the <code>passTime</code> middleware function will be executed. Note how the <code>passOnMessage</code> is only executed for the <code>app.get('/')</code> route.</p>
<h2 id="data-validations-with-middleware">Data validations with middleware</h2>
<p>In the previous reading, you set up data validations in your Express server in the "Guest List" example.</p>
<p>Let’s pick up where that example left off and move the data validations into a middleware function.</p>
<p>At this point, your <code>index.js</code> should look like this:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb218-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-2" title="2"></a>
<a class="sourceLine" id="cb218-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb218-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb218-5" title="5"></a>
<a class="sourceLine" id="cb218-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb218-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&quot;view engine&quot;</span><span class="op">,</span> <span class="st">&quot;pug&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb218-9" title="9"></a>
<a class="sourceLine" id="cb218-10" title="10"><span class="kw">const</span> guests <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb218-11" title="11"></a>
<a class="sourceLine" id="cb218-12" title="12"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb218-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb218-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;index&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest List&quot;</span><span class="op">,</span> guests <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-16" title="16"></a>
<a class="sourceLine" id="cb218-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb218-18" title="18">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-20" title="20"></a>
<a class="sourceLine" id="cb218-21" title="21"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb218-22" title="22">  <span class="kw">const</span> <span class="op">{</span> fullname<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb218-23" title="23">  <span class="kw">const</span> numGuestsNum <span class="op">=</span> <span class="at">parseInt</span>(numGuests<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-24" title="24">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb218-25" title="25"></a>
<a class="sourceLine" id="cb218-26" title="26">  <span class="cf">if</span> (<span class="op">!</span>fullname) <span class="op">{</span></a>
<a class="sourceLine" id="cb218-27" title="27">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the full name field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-28" title="28">  <span class="op">}</span></a>
<a class="sourceLine" id="cb218-29" title="29"></a>
<a class="sourceLine" id="cb218-30" title="30">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb218-31" title="31">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the email field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-32" title="32">  <span class="op">}</span></a>
<a class="sourceLine" id="cb218-33" title="33"></a>
<a class="sourceLine" id="cb218-34" title="34">  <span class="cf">if</span> (<span class="op">!</span>numGuests <span class="op">||</span> numGuests <span class="op">&lt;</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb218-35" title="35">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out a valid number for number of guests.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-36" title="36">  <span class="op">}</span></a>
<a class="sourceLine" id="cb218-37" title="37"></a>
<a class="sourceLine" id="cb218-38" title="38">  <span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb218-39" title="39">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb218-40" title="40">      <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb218-41" title="41">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb218-42" title="42">      email<span class="op">,</span></a>
<a class="sourceLine" id="cb218-43" title="43">      fullname<span class="op">,</span></a>
<a class="sourceLine" id="cb218-44" title="44">      numGuests</a>
<a class="sourceLine" id="cb218-45" title="45">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-46" title="46">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb218-47" title="47">  <span class="op">}</span></a>
<a class="sourceLine" id="cb218-48" title="48"></a>
<a class="sourceLine" id="cb218-49" title="49">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb218-50" title="50">    fullname<span class="op">,</span></a>
<a class="sourceLine" id="cb218-51" title="51">    email<span class="op">,</span></a>
<a class="sourceLine" id="cb218-52" title="52">    <span class="dt">numGuests</span><span class="op">:</span> numGuestsNum</a>
<a class="sourceLine" id="cb218-53" title="53">  <span class="op">};</span></a>
<a class="sourceLine" id="cb218-54" title="54">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-55" title="55">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-56" title="56"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-57" title="57"></a>
<a class="sourceLine" id="cb218-58" title="58"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb218-59" title="59"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb218-60" title="60"></a>
<a class="sourceLine" id="cb218-61" title="61"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>You might be wondering why you would want to move the validation logic into a middleware function. Suppose you now wanted to add a route that would allow the user to update a <code>guest</code> on the guest list.</p>
<p>In that update route, you probably want to enforce the same validations. You could simply copy and paste over all of those validations, but having it in a middleware function would keep your code DRY.</p>
<p>To start, create a function called <code>validateGuest</code> and move all of the validation logic into that function.</p>
<p>Because this will be a middleware function, be sure to accept <code>req</code>, <code>res</code>, and <code>next</code> as arguments in the function.</p>
<p>Finally, your <code>validateGuest</code> functions should pass on error messages to a later function so the later function can render the error messages back to the client.</p>
<p>When you’re done with your <code>validateGuest</code> function, it should look something like this:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb219-1" title="1"><span class="kw">const</span> validateGuest <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb219-2" title="2">  <span class="kw">const</span> <span class="op">{</span> fullname<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb219-3" title="3">  <span class="kw">const</span> numGuestsNum <span class="op">=</span> <span class="at">parseInt</span>(numGuests<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb219-4" title="4">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb219-5" title="5"></a>
<a class="sourceLine" id="cb219-6" title="6">  <span class="cf">if</span> (<span class="op">!</span>fullname) <span class="op">{</span></a>
<a class="sourceLine" id="cb219-7" title="7">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the full name field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb219-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb219-9" title="9"></a>
<a class="sourceLine" id="cb219-10" title="10">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb219-11" title="11">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the email field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb219-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb219-13" title="13"></a>
<a class="sourceLine" id="cb219-14" title="14">  <span class="cf">if</span> (<span class="op">!</span>numGuests <span class="op">||</span> numGuests <span class="op">&lt;</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb219-15" title="15">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out a valid number for number of guests.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb219-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb219-17" title="17"></a>
<a class="sourceLine" id="cb219-18" title="18">  <span class="va">req</span>.<span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></a>
<a class="sourceLine" id="cb219-19" title="19">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb219-20" title="20"><span class="op">};</span></a></code></pre></div>
<p>Notice how the <code>errors</code> array is passed on to the next middleware function by being added to the <code>req</code> object. Update your <code>app.post('/guest')</code> route so that it now uses the <code>validateGuest</code> middleware function and so that it checks <code>req.errors</code> for error messages:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb220-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> validateGuest<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-2" title="2">  <span class="kw">const</span> <span class="op">{</span> fullname<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb220-3" title="3">  <span class="cf">if</span> (<span class="va">req</span>.<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb220-4" title="4">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-5" title="5">      <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb220-6" title="6">      <span class="dt">errors</span><span class="op">:</span> <span class="va">req</span>.<span class="at">errors</span><span class="op">,</span></a>
<a class="sourceLine" id="cb220-7" title="7">      email<span class="op">,</span></a>
<a class="sourceLine" id="cb220-8" title="8">      fullname<span class="op">,</span></a>
<a class="sourceLine" id="cb220-9" title="9">      numGuests</a>
<a class="sourceLine" id="cb220-10" title="10">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-11" title="11">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb220-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb220-13" title="13"></a>
<a class="sourceLine" id="cb220-14" title="14">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb220-15" title="15">    fullname<span class="op">,</span></a>
<a class="sourceLine" id="cb220-16" title="16">    email<span class="op">,</span></a>
<a class="sourceLine" id="cb220-17" title="17">    numGuests</a>
<a class="sourceLine" id="cb220-18" title="18">  <span class="op">};</span></a>
<a class="sourceLine" id="cb220-19" title="19">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-20" title="20">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-21" title="21"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>In summary, moving validations into a middleware allows you to concisely reuse validations across different routes. In production-level projects, you’ll likely use a validation library called <a href="https://express-validator.github.io/docs/">express-validator</a>, which follows the same pattern of validating data in middleware functions and then passing on error messages through the <code>req</code> object.</p>
<p>The <a href="https://express-validator.github.io/docs/">express-validator</a> library gives you a wide range of pre-built validations so that you don’t have to implement validation logic from scratch. For example, it comes with a pre-built validation for checking whether an input field’s is in a proper email format: <code>check('email').isEmail()</code>. You’ll get a chance to explore the <code>express-validator</code> middleware functions more in today’s project!</p>
<h2 id="what-you-learned-5">What you learned</h2>
<p>In this reading, you learned:</p>
<ol type="1">
<li>that the request pipeline in an Express application is composed of a series of middleware functions</li>
<li>how to write a custom middleware function that validates user-provided data (submitted via an HTML form), sets an array of user-friendly validation error messages on the Request object when necessary, and passes control to the next middleware function.</li>
</ol>
<hr />
<h1 id="protecting-forms-from-csrf">Protecting forms from CSRF</h1>
<p>The web, unfortunately, is full of bad actors who consistently try to exploit any insecurities that a web application might have. This reading will talk about one common attack called Cross Site Request Forgery (CSRF).</p>
<p>In this reading, you will learn:</p>
<ol type="1">
<li>How to use the <code>csurf</code> middleware to embed a token value in forms to protect against CSRF exploits.</li>
</ol>
<h2 id="csrf-explained">CSRF explained</h2>
<p>Let’s explain what CSRF is with an example. Imagine that you are a customer at a bank called "Bad Bank Inc.". To put it bluntly, this bank sucks, and their website is full of security issues.</p>
<p>In any case, you decide one day that you need to send your brother some money, so you go <code>http://badbank.com</code> and sign into your account. Once you have provided the correct credentials to log in, <code>http://badbank.com</code> sends back a cookie.</p>
<blockquote>
<p><strong>Brief overview of cookies:</strong> At a super high level, when a user logs into a website, one way that the server can "log in the user" is by sending back a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">cookie</a> to the client. For example, if you log to <code>facebook.com</code>, <code>facebook.com</code>’s server would send the browser back a cookie. Now, on every subsequent request to <code>facebook.com</code>, the browser would attach that cookie to the request. When the request arrives at the server, the server sees the cookie and sees that you’re logged in and authorized to navigate around your account.</p>
</blockquote>
<p>Now that you’re logged in, you navigate to <code>http://badbank.com/send-money</code>, which renders a a page that looks like this:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb221-1" title="1"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></a>
<a class="sourceLine" id="cb221-2" title="2"><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb221-3" title="3">  <span class="kw">&lt;head&gt;</span></a>
<a class="sourceLine" id="cb221-4" title="4">    <span class="kw">&lt;title&gt;</span>Bad Bank<span class="kw">&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb221-5" title="5">  <span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb221-6" title="6">  <span class="kw">&lt;body&gt;</span></a>
<a class="sourceLine" id="cb221-7" title="7">    <span class="kw">&lt;h1&gt;</span>Send Money<span class="kw">&lt;/h1&gt;</span></a>
<a class="sourceLine" id="cb221-8" title="8">    <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;/send-money&quot;</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb221-9" title="9">      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;recipient&quot;</span><span class="kw">&gt;</span>Recipient Email: <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb221-10" title="10">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;email&quot;</span><span class="ot"> id=</span><span class="st">&quot;recipient&quot;</span><span class="ot"> name=</span><span class="st">&quot;recipient&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb221-11" title="11">      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;amount&quot;</span><span class="kw">&gt;</span>Amount: <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb221-12" title="12">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> id=</span><span class="st">&quot;amount&quot;</span><span class="ot"> name=</span><span class="st">&quot;amount&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb221-13" title="13">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value=</span><span class="st">&quot;Send Money&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb221-14" title="14">    <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb221-15" title="15">  <span class="kw">&lt;/body&gt;</span></a>
<a class="sourceLine" id="cb221-16" title="16"><span class="kw">&lt;/html&gt;</span></a></code></pre></div>
<p>The page has a form where you can fill out a "recipient" field and an "amount" field. You fill out your brother’s email <code>joe@gmail.com</code> in the recipient field and $100 for the amount, and then hit the ‘Send Money’ button.</p>
<p>When you hit the ‘Send Money’ button, the following happens:</p>
<ol type="1">
<li>An HTTP POST request is made to <code>http://badbank.com/send-money</code>. When you logged in earlier, your browser received a cookie and stored it in association with <code>http://badbank.com</code>. Now, your browser sees this "send money" request going to the <code>http://badbank.com</code> domain, so it attaches that cookie to the HTTP request.</li>
<li>The request arrives at the server. The server sees that there is a cookie, and it checks the cookie.</li>
<li>Since the cookie is valid, the server knows that you are logged in, and the server processes the form data to see who you’re sending money to and how much you are sending.</li>
<li>The server finishes processing the form data and sends $100 to your brother Joe.</li>
</ol>
<p>Things are going well so far!</p>
<p>Unfortunately, a devious hacker comes along. The hacker puts up another website that looks like this:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb222-1" title="1"><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></a>
<a class="sourceLine" id="cb222-2" title="2"><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb222-3" title="3">  <span class="kw">&lt;head&gt;</span></a>
<a class="sourceLine" id="cb222-4" title="4">    <span class="kw">&lt;title&gt;</span>See Cute Puppies<span class="kw">&lt;/title&gt;</span></a>
<a class="sourceLine" id="cb222-5" title="5">    <span class="kw">&lt;style&gt;</span></a>
<a class="sourceLine" id="cb222-6" title="6">      form {</a>
<a class="sourceLine" id="cb222-7" title="7">        <span class="kw">visibility</span>: <span class="dv">hidden</span><span class="op">;</span></a>
<a class="sourceLine" id="cb222-8" title="8">      }</a>
<a class="sourceLine" id="cb222-9" title="9">      input<span class="ex">[type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="ex">]</span> {</a>
<a class="sourceLine" id="cb222-10" title="10">        <span class="kw">visibility</span>: <span class="dv">visible</span><span class="op">;</span></a>
<a class="sourceLine" id="cb222-11" title="11">      }</a>
<a class="sourceLine" id="cb222-12" title="12">    <span class="kw">&lt;/style&gt;</span></a>
<a class="sourceLine" id="cb222-13" title="13">  <span class="kw">&lt;/head&gt;</span></a>
<a class="sourceLine" id="cb222-14" title="14">  <span class="kw">&lt;body&gt;</span></a>
<a class="sourceLine" id="cb222-15" title="15">    <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;http://badbank.com/send-money&quot;</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb222-16" title="16">      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;recipient&quot;</span><span class="kw">&gt;</span>Recipient Email: <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb222-17" title="17">      <span class="kw">&lt;input</span></a>
<a class="sourceLine" id="cb222-18" title="18"><span class="ot">        type=</span><span class="st">&quot;email&quot;</span></a>
<a class="sourceLine" id="cb222-19" title="19"><span class="ot">        id=</span><span class="st">&quot;recipient&quot;</span></a>
<a class="sourceLine" id="cb222-20" title="20"><span class="ot">        name=</span><span class="st">&quot;recipient&quot;</span></a>
<a class="sourceLine" id="cb222-21" title="21"><span class="ot">        value=</span><span class="st">&quot;hacker@gmail.com&quot;</span></a>
<a class="sourceLine" id="cb222-22" title="22">      <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb222-23" title="23">      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;amount&quot;</span><span class="kw">&gt;</span>Amount: <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb222-24" title="24">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> id=</span><span class="st">&quot;amount&quot;</span><span class="ot"> name=</span><span class="st">&quot;amount&quot;</span><span class="ot"> value=</span><span class="st">&quot;1000000&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb222-25" title="25">      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value=</span><span class="st">&quot;See the cutest puppies!&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb222-26" title="26">    <span class="kw">&lt;/form&gt;</span></a>
<a class="sourceLine" id="cb222-27" title="27">  <span class="kw">&lt;/body&gt;</span></a>
<a class="sourceLine" id="cb222-28" title="28"><span class="kw">&lt;/html&gt;</span></a></code></pre></div>
<p>Let’s break down what’s going on in the hacker’s website:</p>
<ol type="1">
<li>First, the hacker puts up the exact same "Send Money" form on his website: it hits the same endpoint (<code>http://badbank.com/send-money</code>) with the same method ("post"), and it has all the fields that the endpoint expects when parsing the form ("recipient" and "amount").</li>
<li>One difference here is that the hacker hid the form on the website with CSS by setting the form’s visibility to hidden.</li>
<li>The other key difference is that the hacker went ahead and pre-filled the recipient field’s value to his own email address, "hacker@gmail.com", and then also pre-filled the "amount" field’s value to 1 million.</li>
<li>The only part of the form that the hacker decides to show is the submit button, and he changed the button text to an irresistible prompt: "See the cutest puppies!".</li>
<li>Naturally, you love puppies, so as you’re browsing the web and land on this hacker’s website, you click the button, thinking that you’re about to see puppies.</li>
<li>Instead, a "ost" request gets sent to <code>http://badbank.com/send-money</code> along with the pre-filled form data.</li>
</ol>
<p>Here’s the problem, because you had recently logged into <code>http://badbank.com</code>, your browser is currently storing the cookie to keep you logged in. When the browser sees that you are making another request to the <code>badbank.com</code> domain, it attaches the same cookie to the request that the hacker tricked you into making.</p>
<p>Now, when the hacker’s request makes it to <code>badbank.com</code>’s server, it sees the cookie, sees that you’re logged in and thinks that it’s you making the request, so it sends $1 million to "hacker@gmail.com".</p>
<h2 id="preventing-csrf">Preventing CSRF</h2>
<p>One foundational strategy to prevent a CSRF attack would be to have your server render a secret token as part of the form. Then, when the form gets submitted, it checks for the secret token to verify that it actually came from a form that the server itself had rendered, and not from some other malicious source.</p>
<p>Now, when a hacker tries to imitate the form on his own website, his form wouldn’t have the secret token, and the server would know to reject any requests from that malicious form.</p>
<p>Let’s pick up where we left off in our previous reading’s "Guest List" example and walk through how to implement this CSRF token strategy.</p>
<h3 id="example-setup">Example setup</h3>
<p>At this point, here’s what the <code>index.js</code> file for the "Guest List" example project should look like:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb223-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-2" title="2"></a>
<a class="sourceLine" id="cb223-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb223-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb223-5" title="5"></a>
<a class="sourceLine" id="cb223-6" title="6"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb223-7" title="7"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&quot;view engine&quot;</span><span class="op">,</span> <span class="st">&quot;pug&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb223-9" title="9"></a>
<a class="sourceLine" id="cb223-10" title="10"><span class="kw">const</span> guests <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb223-11" title="11"></a>
<a class="sourceLine" id="cb223-12" title="12"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb223-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;index&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest List&quot;</span><span class="op">,</span> guests <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-16" title="16"></a>
<a class="sourceLine" id="cb223-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-18" title="18">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-20" title="20"></a>
<a class="sourceLine" id="cb223-21" title="21"><span class="kw">const</span> validateGuest <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-22" title="22">  <span class="kw">const</span> <span class="op">{</span> fullname<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb223-23" title="23">  <span class="kw">const</span> numGuestsNum <span class="op">=</span> <span class="at">parseInt</span>(numGuests<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-24" title="24">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb223-25" title="25"></a>
<a class="sourceLine" id="cb223-26" title="26">  <span class="cf">if</span> (<span class="op">!</span>fullname) <span class="op">{</span></a>
<a class="sourceLine" id="cb223-27" title="27">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the full name field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-28" title="28">  <span class="op">}</span></a>
<a class="sourceLine" id="cb223-29" title="29"></a>
<a class="sourceLine" id="cb223-30" title="30">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb223-31" title="31">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out the email field.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-32" title="32">  <span class="op">}</span></a>
<a class="sourceLine" id="cb223-33" title="33"></a>
<a class="sourceLine" id="cb223-34" title="34">  <span class="cf">if</span> (<span class="op">!</span>numGuests <span class="op">||</span> numGuests <span class="op">&lt;</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb223-35" title="35">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&quot;Please fill out a valid number for number of guests.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-36" title="36">  <span class="op">}</span></a>
<a class="sourceLine" id="cb223-37" title="37"></a>
<a class="sourceLine" id="cb223-38" title="38">  <span class="va">req</span>.<span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></a>
<a class="sourceLine" id="cb223-39" title="39">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb223-40" title="40"><span class="op">};</span></a>
<a class="sourceLine" id="cb223-41" title="41"></a>
<a class="sourceLine" id="cb223-42" title="42"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> validateGuest<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-43" title="43">  <span class="kw">const</span> <span class="op">{</span> fullname<span class="op">,</span> email<span class="op">,</span> numGuests <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb223-44" title="44">  <span class="cf">if</span> (<span class="va">req</span>.<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb223-45" title="45">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-46" title="46">      <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb223-47" title="47">      <span class="dt">errors</span><span class="op">:</span> <span class="va">req</span>.<span class="at">errors</span><span class="op">,</span></a>
<a class="sourceLine" id="cb223-48" title="48">      email<span class="op">,</span></a>
<a class="sourceLine" id="cb223-49" title="49">      fullname<span class="op">,</span></a>
<a class="sourceLine" id="cb223-50" title="50">      numGuests</a>
<a class="sourceLine" id="cb223-51" title="51">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-52" title="52">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb223-53" title="53">  <span class="op">}</span></a>
<a class="sourceLine" id="cb223-54" title="54"></a>
<a class="sourceLine" id="cb223-55" title="55">  <span class="kw">const</span> guest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb223-56" title="56">    fullname<span class="op">,</span></a>
<a class="sourceLine" id="cb223-57" title="57">    email<span class="op">,</span></a>
<a class="sourceLine" id="cb223-58" title="58">    numGuests</a>
<a class="sourceLine" id="cb223-59" title="59">  <span class="op">};</span></a>
<a class="sourceLine" id="cb223-60" title="60">  <span class="va">guests</span>.<span class="at">push</span>(guest)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-61" title="61">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&quot;/&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-62" title="62"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb223-63" title="63"></a>
<a class="sourceLine" id="cb223-64" title="64"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb223-65" title="65"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb223-66" title="66"></a>
<a class="sourceLine" id="cb223-67" title="67"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Here’s what the <code>index.pug</code> file looks like:</p>
<pre class="pug"><code>extends layout.pug

block content
  table
    thead
      tr
        th Full Name
        th Email
        th # Guests
    tbody
      each guest in guests
        tr
          td #{guest.fullname}
          td #{guest.email}
          td #{guest.numGuests}


Here&#39;s what the `guest-form.pug` file looks like:

```pug
extends layout.pug

block content
  if errors
    div
      ul
        each error in errors
          li #{error}
  h2 Add Guest
  form(method=&quot;post&quot; action=&quot;/guest&quot;)
    label(for=&quot;fullname&quot;) Full Name:
    input(type=&quot;fullname&quot; id=&quot;fullname&quot; name=&quot;fullname&quot; value=fullname)
    label(for=&quot;email&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; value=email)
    label(for=&quot;numGuests&quot;) Num Guests
    input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot; value=numGuests)
    input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)
</code></pre>
<h3 id="using-the-csurf-library">Using the <code>csurf</code> library</h3>
<p>Let’s use the <code>csurf</code> library to handle this whole process of creating a secret token for the form and then checking the secret token when forms are submitted.</p>
<p>The <code>csurf</code> library creates a middleware function that does the following:</p>
<ol type="1">
<li>It creates a secret value, which is sent to the client and stored as a cookie named <code>_csrf</code>.</li>
<li>On every request for a form, a CSRF token is generated from that secret value. That CSRF token is then sent back to the client as part of the form in a hidden input field.</li>
<li>Whenever the client submits the form, the server checks the CSRF token that’s embedded in the form and verifies that it is a valid CSRF token by checking it against the secret <code>_csrf</code> value that was attached to the request as a cookie.</li>
</ol>
<p>By taking the steps above, the hacker site would not have the CSRF token embedded as part of the form on his site, and therefore it would fail the CSRF token verification process.</p>
<p>Let’s implement the above flow in the "Guest List" project. First, start by running <code>npm install csurf@^1.0.0</code>.</p>
<p>Then, go ahead and also install the <code>cookie-parser</code> middleware by running <code>npm install cookie-parser@^1.0.0</code>. Remember, the secret value is stored as a cookie named <code>_csrf</code>, so whenever the form is submitted, the server needs to be able to parse out the cookie in order to verify the CSRF token against the secret <code>_csrf</code> value.</p>
<p>At the top of <code>index.js</code>, require the <code>csurf</code> and <code>cookie-parser</code> dependencies. Add the <code>cookie-parser</code> middleware as an application-wide middleware function. For the <code>csurf</code> middleware, go ahead and create the function now so that you can later use it in specific routes:</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb225-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;express&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-2" title="2"><span class="kw">const</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;cookie-parser&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-3" title="3"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;csurf&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-4" title="4"></a>
<a class="sourceLine" id="cb225-5" title="5"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb225-6" title="6"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb225-7" title="7"></a>
<a class="sourceLine" id="cb225-8" title="8"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb225-9" title="9"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&quot;view engine&quot;</span><span class="op">,</span> <span class="st">&quot;pug&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb225-10" title="10"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())<span class="op">;</span> <span class="co">// Adding cookieParser() as application-wide middleware</span></a>
<a class="sourceLine" id="cb225-11" title="11"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb225-12" title="12"><span class="kw">const</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span> <span class="co">// creating csrfProtection middleware to use in specific routes</span></a>
<a class="sourceLine" id="cb225-13" title="13"></a>
<a class="sourceLine" id="cb225-14" title="14"><span class="co">// REST OF FILE NOT SHOWN</span></a></code></pre></div>
<p>In the <code>app.get('/guest-form')</code> route, pass in the <code>csrfProtection</code> function as one of the middleware functions for that route. Then in the route’s final callback middleware function, generate a CSRF token by calling <code>req.csrfToken()</code>.</p>
<p>The <code>csrfToken()</code> function was added to the <code>req</code> object by the <code>csrfProtection</code> middleware. The middleware function also generated a secret <code>_csrf</code> value and stored it in the <code>res</code> object’s headers so that the client can store it as a cookie. Finally, render the CSRF token under a <code>csrfToken</code> key so that the <code>guest-form.pug</code> template can use it:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb226-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&quot;/guest-form&quot;</span><span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb226-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;guest-form&quot;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&quot;Guest Form&quot;</span><span class="op">,</span> <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>() <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb226-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>In <code>guest-form.pug</code>, add a hidden input field with a <code>name</code> attribute of "_csrf" and the <code>value</code> attribute set to the <code>csrfToken</code> that the server renders:</p>
<pre class="pug"><code>extends layout.pug

block content
  if errors
    div
      ul
        each error in errors
          li #{error}
  h2 Add Guest
  form(method=&quot;post&quot; action=&quot;/guest&quot;)
    input(type=&quot;hidden&quot; name=&quot;_csrf&quot; value=csrfToken)
    label(for=&quot;fullname&quot;) Full Name:
    input(type=&quot;fullname&quot; id=&quot;fullname&quot; name=&quot;fullname&quot; value=fullname)
    label(for=&quot;email&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; value=email)
    label(for=&quot;numGuests&quot;) Num Guests
    input(type=&quot;number&quot; id=&quot;numGuests&quot; name=&quot;numGuests&quot; value=numGuests)
    input(type=&quot;submit&quot; value=&quot;Add Guest&quot;)
</code></pre>
<p>Finally, back in <code>index.js</code>, pass in the <code>csrfProtection</code> function to <code>app.post('/guest')</code>:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb228-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&quot;/guest&quot;</span><span class="op">,</span> csrfProtection<span class="op">,</span> validateGuest<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb228-2" title="2">  <span class="co">// REST OF CODE NOT SHOWN</span></a>
<a class="sourceLine" id="cb228-3" title="3"><span class="op">}</span></a></code></pre></div>
<p>Now whenever the form is submitted, the <code>csrfProtection</code> middleware function verifies that the CSRF token that was set in the hidden input field is a valid token by checking it against the secret <code>_csrf</code> value that was sent as a cookie.</p>
<p>In summary, now, if a hacker tries to add a guest to your guest list, his form would be missing the CSRF token. Therefore, the endpoint throw an error and prevent a guest from being added.</p>
<p>There are <a href="https://github.com/pillarjs/understanding-csrf">other considerations</a> to take into account to fully protect your web applications from CSRF attacks. For now, adding the CSRF token is a solid first line of defense.</p>
<h2 id="what-you-learned-6">What you learned</h2>
<p>In this reading, you learned how to use the csurf middleware to embed a token value in forms to protect against CSRF exploits.</p>
<p>This reading concludes this lesson on HTML Forms, and you’re now ready to build out your own Express application that uses forms!</p>
<hr />
<h1 id="formative-forms-project">Formative Forms Project</h1>
<p>Today you’ll be going through the formative experience of building out an Express application that uses HTML forms!</p>
<p>This application allows users to create two types of user accounts: a normal user account and an interesting user account. It keeps track of all of the users in a table on the home page.</p>
<p>When you’re done with the project, your web application should have the following features:</p>
<ol type="1">
<li>Site-wide navigation elements that allows users to navigate between the home page and the two other pages.</li>
<li>A table that shows all of the existing users.</li>
<li>A form that can be used to create a normal user account.</li>
<li>A form that can be used to create an interesting user account.</li>
</ol>
<h2 id="getting-started-1">Getting started</h2>
<ul>
<li>Clone the starter project from https://github.com/-starters/formative-forms-starter</li>
<li>Run <code>npm install</code> to install the dependencies</li>
<li>Run <code>npm test</code> to run the tests for the project</li>
</ul>
<h2 id="phase-0-intro-to-the-skeleton-directory">Phase 0: Intro to the skeleton directory</h2>
<p>The skeleton directory has a bare bone <code>index.js</code> file that renders "Hello World!" when a user land on <code>localhost:3000/</code>. There’s also a <code>users</code> array that already has one user created for you. Throughout the project, as you add new users, you’ll do so by pushing the new users into this array.</p>
<p>It also has a <code>layout.pug</code> template that your other templates can extend. The <code>layout.pug</code> imports Bootstrap stylesheets in the <code>head</code> element. Feel free to make your website look fancy with the available Bootstrap styling by adding Bootstrap class names to your elements.</p>
<p>For example, here is the documentation on how to <a href="https://getbootstrap.com/docs/4.4/components/forms/">add Bootstrap styles to a form element</a> by adding the Bootstrap classes to each element.</p>
<h2 id="phase-1-home-page">Phase 1: Home page</h2>
<p>Pass each of the specs in <code>01_home.test.js</code> file. Running <code>npm test</code> will run every single test across all five test files. If you only want to run the specs in <code>01_home.test.js</code>, run <code>npm test -- --grep home</code>. The <code>--grep</code> flag only executes tests with names that match the passed in option value.</p>
<p>Overall, this project will give you ample opportunity to get familiar with reading specs and then building out features to satisfy those specs. Be sure to check the specs often for guidance!</p>
<p>In this first phase, create an <code>index.pug</code> template and update the <code>app.get("/")</code> route so that it renders the index template. Remember to render the <code>users</code> array so that it’s available in the <code>index.pug</code> template.</p>
<p><a href="https://pugjs.org/language/inheritance.html">Extend</a> the <code>index.pug</code> template to inherit from <code>layout.pug</code>. Declare a block named "content" and add a table to render existing users. Follow the specs to create an <code>h2</code> header for the table.</p>
<blockquote>
<p><strong>Hint:</strong> Read the error messages to see the expected header name.</p>
</blockquote>
<p>Create table headers and columns for each user’s information.</p>
<blockquote>
<p><strong>Hint:</strong> Take a look at 01_home.test.js to view what columns are expected in the table.</p>
</blockquote>
<p>At the top of the <code>body</code> element in <code>layout.pug</code>, add navigation links so that users can easily navigate between the home page ("/" route), normal user creation form ("/create" route), and interesting user creation form ("/create-interesting" route).</p>
<h2 id="phase-2-create-the-normal-user-form">Phase 2: Create the normal user form</h2>
<p>Pass each of the specs in <code>02_create_form.test.js</code>. You can run the specs in this file by running <code>npm test -- --grep create-normal</code>.</p>
<p>In this phase, go ahead and set up this route to use the <a href="https://www.npmjs.com/package/csurf">csurf</a> middleware to render a CSRF token in a hidden input field. Be sure to in the <code>{cookie: true}</code> options when creating the middleware function.</p>
<p>Because your application will be using cookies to store the secret CSRF value, go ahead and also set up the <a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a> middleware as an application-wide middleware function.</p>
<p>Set up a route so that when users land on <code>/create</code>, a form renders with the following fields:</p>
<ul>
<li><code>_csrf</code> <strong>(hidden field)</strong></li>
<li><code>firstName</code></li>
<li><code>lastName</code></li>
<li><code>email</code></li>
<li><code>password</code></li>
<li><code>confirmedPassword</code></li>
</ul>
<p>Be sure to set correct input <code>type</code> and <code>name</code> attributes, and also remember to <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/label">add a label</a> correlating to each input field’s <code>name</code>.</p>
<p>Make sure your <code>_csrf</code> field has an appropriate value from your middleware. At this point, remove some duplication from your Pug template by leveraging <a href="https://pugjs.org/language/mixins.html">mixins</a>. Create a mixin to easily generate <code>label</code> and <code>input</code> element pairs. Think of how you would create a mixin using <code>input</code> attributes as parameters.</p>
<h2 id="phase-3-submitting-the-form">Phase 3: Submitting the form</h2>
<p>Pass each of the specs in <code>03_form_submit.test.js</code>. You can run the specs in this file by running <code>npm test -- --grep form-submit</code>.</p>
<p>Begin by setting up a <code>"/create"</code> route to handle POST requests. Now that you are handling POST requests, you’ll need access to <code>req.body</code>. Have your application use the <code>express.urlencoded</code> middleware to decode the form’s request body string into data that can be accessible in <code>req.body</code>.</p>
<p>The next step is to protect this route from CSRF attacks by using the middleware function that you set up using the <a href="https://www.npmjs.com/package/csurf">csurf</a> library. Make sure you’ve included the middleware function in both of the GET and POST <code>"/create"</code> routes.</p>
<p>Now set up data validations and create an <code>errors</code> array within the <code>app.post("/create")</code> route. You want to validate whether the user has provided a <code>firstName</code>, <code>lastName</code>, <code>email</code>, and <code>password</code>. Read the error messages from the specs to determine what messages to <code>push</code> into your <code>errors</code> array.</p>
<p>Time to update the <code>create.pug</code> template to render the error messages. Start by creating an unordered list at the top of your <code>create-form.pug</code> block. Inside of the unordered list, add a paragraph element with the following content: <code>The following errors were found:</code>. Now, iterate through each error to create list items with the error messages. Only render errors if they are present in the <code>errors</code> array. How can you determine if there are errors present?</p>
<p>You’ll want to be sure that you’re pre-filling each input field with already-submitted values so that users don’t have to fill out all of the fields again whenever there are errors. How can you update your <code>input</code> elements so that already-submitted values are still showing even after a form submission fails a data validation?</p>
<h2 id="phase-4-create-interesting-user-form">Phase 4: Create interesting user form</h2>
<p>Pass each of the specs in <code>04_create_interesting_form.test.js</code>. You can run the specs in this file by running <code>npm test -- --grep create-interesting</code>.</p>
<p>Notice how this form includes all of the fields from the first form. Reduce code duplication by leveraging the Pug <a href="https://pugjs.org/language/includes.html">includes</a> feature.</p>
<p>One way you could refactor is to create an <code>includes</code> directory inside your views and make the following files:</p>
<ul>
<li><code>views/includes/errors.pug</code></li>
<li><code>views/includes/form-inputs.pug</code></li>
</ul>
<p>Now create a <code>create-interesting.pug</code> template for your "interesting user form" and refactor your <code>create.pug</code> template to leverage the Pug <code>includes</code> feature. Start by dividing your existing <code>create.pug</code> template into <code>errors.pug</code> and <code>form-inputs.pug</code>. Think of how to use the templates to keep your code DRY.</p>
<h2 id="phase-5-submit-create-interesting-user-form">Phase 5: Submit create interesting user form</h2>
<p>Pass each of the specs in <code>05_interesting_form_submit.test.js</code>. You can run the specs in this file by running <code>npm test -- --grep submit-interesting</code>.</p>
<p>Go ahead and add validations and write error messages for this new form. Because this new form still has the same base fields as the other form, be sure to still run the same validations that you are currently running for the <code>app.post('/create')</code> route. If you have not done so already, go ahead and move all of the validations for the first form into a custom middleware function that both <code>app.post('/create')</code> and <code>app.post('/create-interesting</code>) can use. Be sure to store those errors on the <code>req</code> object so that they can be used in a later middleware function.</p>
<p>Once you’ve ensured that your base fields are being validated, go ahead and add validations for the new <code>age</code> and <code>favoriteBeatle</code> fields. Follow the error messages in the specs to determine what your error messages should be. Please write these new validations in a custom middleware function.</p>
<p>Create <a href="https://pugjs.org/language/mixins.html">mixins</a> for the <code>favoriteBeatle</code> options. How can you make sure that a user’s <code>favoriteBeatle</code> is automatically selected when a form with errors re-renders upon submission?</p>
<p>How can you make sure a user’s <code>iceCream</code> checkbox accurately renders whether the user likes ice cream upon an unsuccessful form submission? When saving the user, be sure to use the checkbox’s value (ex: "on") to convert the <code>user.iceCream</code> property to a boolean.</p>
<p>Finally, make sure your <code>index.pug</code> template is also rendering your new user properties.</p>
<p>You’ve made it! Confirm that your whole app works as expected by running <code>npm test</code>.</p>
<h2 id="bonus">Bonus</h2>
<p>In a production-level Express application, you’ll likely use a library to help handle most of your data validation. One of the most popular data validation libraries is the <a href="https://express-validator.github.io/docs/">express-validator</a> library, which gives you a wide range of robust validations right out of the box.</p>
<p>Install this dependency and use it to add a validation to check that the user password being submitted is at least 5 characters long and that it at least has one number in it.</p>
<p>Then, go ahead and migrate any validations that you had on the <code>age</code> and <code>favoriteBeatle</code> fields to use the <a href="https://express-validator.github.io/docs/">express-validator</a> library instead.</p>
<p>Once you’re done with those fields, continue migrating all other validations to use <a href="https://express-validator.github.io/docs/">express-validator</a> and add validations to check <em>all</em> user input (e.g, checking that a valid email is submitted).</p>
<hr />
<h1 id="week-11-day-4-data-driven-app" data-ignore="true">WEEK-11 DAY-4<br><em>Data-Driven App</em></h1>
<hr />
<h1 id="data-driven-web-sites-learning-objectives">Data-Driven Web Sites Learning Objectives</h1>
<p>This is where it all comes together: databases, HTTP servers, HTML, CSS, request and response, JavaScript powering it all. This is <strong>full-stack</strong>. At the end of this content, you should be able to:</p>
<ol type="1">
<li>Use environment variables to specify configuration of or provide sensitive information for your code</li>
<li>Use the <code>dotenv</code> npm package to load environment variables defined in an <code>.env</code> file</li>
<li>Recall that Express cannot process unhandled Promise rejections from within route handler (or middleware) functions;</li>
<li>Use a Promise <code>catch</code> block or a <code>try</code>/<code>catch</code> statement with <code>async</code>/<code>await</code> to properly handle errors thrown from within an asynchronous route handler (or middleware) function</li>
<li>Write a wrapper function to simplify catching errors thrown within asynchronous route handler (or middleware) functions</li>
<li>Use the <code>morgan</code> npm package to log requests to the terminal window to assist with auditing and debugging</li>
<li>Add support for the Bootstrap front-end component library to a Pug layout template</li>
<li>Install and configure Sequelize within an Express application.</li>
<li>Use Sequelize to test the connection to a database before starting the HTTP server on application startup</li>
<li>Define a collection of routes (and views) that perform CRUD operations against a single resource using Sequelize</li>
<li>Handle Sequelize validation errors when users are attempting to create or update data and display error messages to the user so that they can resolve any data quality issues</li>
<li>Describe how an Express.js error handler function differs from middleware and route handler functions</li>
<li>Define a global Express.js error-handling function to catch and process unhandled errors</li>
<li>Define a middleware function to handle requests for unknown routes by returning a 404 NOT FOUND error</li>
</ol>
<hr />
<h1 id="acclimating-to-environment-variables">Acclimating to Environment Variables</h1>
<p>As your Express applications increase in complexity, the need to have a convenient way to configure your applications will also increase.</p>
<p>For example, consider an application that uses a database for data persistence. To connect to the database, do you simply provide the username and password to use when making a connection to the database directly in your code? What if your teammate uses a different username or password? Do they modify the code to make it work for them? If they do that, how do you keep the application working on your system?</p>
<p>It’s not just the differences between you and your teammates’ systems. Your applications won’t always run locally; eventually they’ll need to run on external servers to facilitate testing or to ultimately serve your end users. In most cases, your application will need to be configured differently when it’s running on an external server than when it’s running locally.</p>
<p>You need a solution for managing your application’s configuration! When you finish this article, you should be able to:</p>
<ul>
<li>Recall what environment variables are and how they’re commonly used;</li>
<li>Set and get an environment variable value;</li>
<li>Store environment variable values in an <code>.env</code> file;</li>
<li>Use a module to organize environment variables; and</li>
<li>Understand how to run npm scripts in different environments.</li>
</ul>
<h2 id="what-are-environment-variables">What are environment variables?</h2>
<p>To understand what an environment variable is, we need to start with understanding what an environment is.</p>
<p>An environment is the system that an application is deployed to and running in. Up to now your applications have been running on your local machine, which is typically referred to as the "local environment" or "local development environment".</p>
<p>For real life applications, there are usually several environments—aside from each developer’s local environment—that the application will be deployed and ran within:</p>
<ul>
<li>Testing - An environment that’s used to test the application to ensure that recent changes don’t affect existing functionality and that new features meet the project’s requirements.</li>
<li>Staging - An environment that mirrors the production environment to ensure that nothing unexpected occurs before the application is deployed to production.</li>
<li>Production - The environment that serves end users. For applications that need to support a large number of users, the production environment can contain multiple servers (sometimes dozens or even hundreds of servers).</li>
</ul>
<p>Environment variables are application configuration related variables whose values change depending on the environment that the application is running in. Using environment variables allows you to change the behavior of your application by the environment that it’s running in without having to hard code values in your code.</p>
<h3 id="how-are-environment-variables-commonly-used">How are environment variables commonly used?</h3>
<p>In an earlier lesson, you learned how to use the Sequelize ORM to connect to a PostgreSQL database to retrieve, create, update, and delete data. To connect to the database, you provided values for the following configuration variables within a module named <code>config/database.js</code>:</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb229-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb229-2" title="2">  <span class="dt">development</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb229-3" title="3">    <span class="dt">username</span><span class="op">:</span> <span class="st">&quot;mydbuser&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb229-4" title="4">    <span class="dt">password</span><span class="op">:</span> <span class="st">&quot;mydbuserpassword&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb229-5" title="5">    <span class="dt">database</span><span class="op">:</span> <span class="st">&quot;mydbname&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb229-6" title="6">    <span class="dt">host</span><span class="op">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb229-7" title="7">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&quot;postgres&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb229-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb229-9" title="9"><span class="op">};</span></a></code></pre></div>
<p>The database connection settings that you use in your local development environment—in particular the <code>username</code> and <code>password</code> values—won’t be the same that the testing, staging, or production environments will need.</p>
<p>Sequelize allows you to define database connection settings per environment like this:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb230-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb230-2" title="2">  <span class="dt">development</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb230-3" title="3">    <span class="dt">username</span><span class="op">:</span> <span class="st">&quot;mydbuser&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-4" title="4">    <span class="dt">password</span><span class="op">:</span> <span class="st">&quot;mydbuserpassword&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-5" title="5">    <span class="dt">database</span><span class="op">:</span> <span class="st">&quot;mydbname&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-6" title="6">    <span class="dt">host</span><span class="op">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-7" title="7">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&quot;postgres&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb230-9" title="9">  <span class="dt">test</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb230-10" title="10">    <span class="dt">username</span><span class="op">:</span> <span class="st">&quot;testdbuser&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-11" title="11">    <span class="dt">password</span><span class="op">:</span> <span class="st">&quot;testdbuserpassword&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-12" title="12">    <span class="dt">database</span><span class="op">:</span> <span class="st">&quot;testdbname&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-13" title="13">    <span class="dt">host</span><span class="op">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-14" title="14">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&quot;postgres&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-15" title="15">  <span class="op">},</span></a>
<a class="sourceLine" id="cb230-16" title="16">  <span class="dt">production</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb230-17" title="17">    <span class="dt">username</span><span class="op">:</span> <span class="st">&quot;proddbuser&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-18" title="18">    <span class="dt">password</span><span class="op">:</span> <span class="st">&quot;proddbuserpassword&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-19" title="19">    <span class="dt">database</span><span class="op">:</span> <span class="st">&quot;proddbname&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-20" title="20">    <span class="dt">host</span><span class="op">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-21" title="21">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&quot;postgres&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-22" title="22">  <span class="op">},</span></a>
<a class="sourceLine" id="cb230-23" title="23"><span class="op">};</span></a></code></pre></div>
<p>While you could hard code different settings for each environment this approach is inelegant, difficult to maintain, and insecure. Application configuration can unexpectedly need to change in test, staging, and production environments. Having to make a code change to change an application’s configuration in a specific environment isn’t ideal.</p>
<p>Using environment variables for the database connection settings separates the configuration from the application’s code and allows the configuration to be updated without having to make a code change.</p>
<p>Where else should you use environment variables? Anywhere that the behavior of your code needs to change based upon the environment that it’s running in. Environment variables are commonly used for:</p>
<ul>
<li>Database connection settings (as you’ve just seen)</li>
<li>Server HTTP ports</li>
<li>Static file locations</li>
<li>API keys and secrets</li>
</ul>
<h2 id="setting-and-getting-environment-variable-values">Setting and getting environment variable values</h2>
<p>Now that you know what environment variables are and how they’re used, it’s time to see how to set and get an environment variable value.</p>
<h3 id="setting-an-environment-variable-value">Setting an environment variable value</h3>
<p>The simplest way to set an environment variable, is via the command line, by declaring and setting the environment variable before the <code>node</code> command:</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb231-1" title="1"><span class="va">PORT=</span>8080 <span class="ex">node</span> app.js</a></code></pre></div>
<p>You can even declare and set multiple environment variables:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb232-1" title="1"><span class="va">PORT=</span>8080 <span class="va">NODE_ENV=</span>development <span class="ex">node</span> app.js</a></code></pre></div>
<blockquote>
<p>The <code>NODE_ENV</code> environment variable is a special variable that’s used by many node programs to determine what environment the application is running in. For example, setting the <code>NODE_ENV</code> environment variable to <code>production</code> enables features in Express that help to improve the overall performance of your application. For more information, see <a href="https://expressjs.com/en/advanced/best-practice-performance.html#set-node_env-to-production">this page</a> in the Express documentation. Sequelize also uses the <code>NODE_ENV</code> variable to determine which section of the <code>config.json</code> file it will use for database configuration.</p>
</blockquote>
<p>This approach also works within an npm <code>start</code> script:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb233-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb233-2" title="2">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb233-3" title="3">    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;PORT=8080 NODE_ENV=development node app.js&quot;</span></a>
<a class="sourceLine" id="cb233-4" title="4">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb233-5" title="5"><span class="fu">}</span></a></code></pre></div>
<h3 id="getting-an-environment-variable-value">Getting an environment variable value</h3>
<p>To get an environment variable value, you simply use the <code>process.env</code> property:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb234-1" title="1"><span class="kw">const</span> port <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span><span class="op">;</span></a></code></pre></div>
<p>The <code>process</code> object is a global Node object, so you can safely access the <code>process.env</code> property from anywhere within your Node application.</p>
<p>If the <code>PORT</code> environment variable isn’t declared and set, it’ll have a value of <code>undefined</code>. You can use the logical <code>OR</code> (<code>||</code>) operator to provide a default value in code:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb235-1" title="1"><span class="kw">const</span> port <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">;</span></a></code></pre></div>
<h2 id="storing-environment-variables-in-a-.env-file">Storing environment variables in a <code>.env</code> file</h2>
<p>Passing environment variables from the command line is not an ideal solution. Defining an npm <code>start</code> script keeps you from having to type the variables again and again, but it’s still not a convenient way to maintain them.</p>
<p>Using the <code>dotenv</code> npm package, you can declare and set all of your environment variables in a <code>.env</code> file and the <code>dotenv</code> package will load your variables from that file and set them on the <code>process.env</code> property.</p>
<p>To start, install the <code>dotenv</code> npm package as a development dependency:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb236-1" title="1"><span class="ex">npm</span> install dotenv --save-dev</a></code></pre></div>
<blockquote>
<p>Remember that npm tracks two main types of dependencies in the <code>package.json</code> file: dependencies (<code>dependencies</code>) and development dependencies (<code>devDependencies</code>). <em>Dependencies</em> (<code>dependencies</code>) are the packages that your project needs in order to successfully run when in production (i.e. your application has been deployed or published to a server that can be accessed by your users). <em>Development dependencies</em> (<code>devDependencies</code>) are the packages that are needed locally when doing development work on the project. Passing the <code>--save-dev</code> flag when installing a dependency tells npm to install the dependency as a development dependency.</p>
</blockquote>
<p>Then add an <code>.env</code> file to the root of your project that contains all of your environment variables:</p>
<pre><code>PORT=8080
DB_USERNAME=mydbuser
DB_PASSWORD=mydbuserpassword
DB_DATABASE=mydbname
DB_HOST=localhost</code></pre>
<blockquote>
<p><strong>Pro tip for VS Code users:</strong> Install the <a href="https://marketplace.visualstudio.com/items?itemName=mikestead.dotenv">DotENV extension</a> to add syntax coloring in <code>.env</code> files.</p>
</blockquote>
<h3 id="loading-environment-variables-on-application-startup">Loading environment variables on application startup</h3>
<p>Using the <code>dotenv</code> npm package, it’s easy to load your environment variables when your Express application starts up. Just run this code before you configure and start your Express application:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb238-1" title="1"><span class="co">// app.js</span></a>
<a class="sourceLine" id="cb238-2" title="2"></a>
<a class="sourceLine" id="cb238-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb238-4" title="4"></a>
<a class="sourceLine" id="cb238-5" title="5"><span class="co">// Load the environment variables from the .env file</span></a>
<a class="sourceLine" id="cb238-6" title="6"><span class="at">require</span>(<span class="st">&#39;dotenv&#39;</span>).<span class="at">config</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb238-7" title="7"></a>
<a class="sourceLine" id="cb238-8" title="8"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb238-9" title="9"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb238-10" title="10"></a>
<a class="sourceLine" id="cb238-11" title="11"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb238-12" title="12"></a>
<a class="sourceLine" id="cb238-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb238-14" title="14">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from Express!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb238-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb238-16" title="16"></a>
<a class="sourceLine" id="cb238-17" title="17"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb238-18" title="18"></a>
<a class="sourceLine" id="cb238-19" title="19"><span class="kw">const</span> port <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb238-20" title="20"></a>
<a class="sourceLine" id="cb238-21" title="21"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<h3 id="another-way-to-use-dotenv">Another way to use dotenv</h3>
<p>Another way to use the dotenv module is to load it before your app loads on the Node.JS command line by using Node.JS’s <code>-r</code> option to require a module immediately. To use it this way you could change your <code>npm start</code> command in your package.json to look like this:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb239-1" title="1">  <span class="fu">{</span></a>
<a class="sourceLine" id="cb239-2" title="2">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb239-3" title="3">    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;node -r dotenv/config app.js&quot;</span></a>
<a class="sourceLine" id="cb239-4" title="4">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb239-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>Doing it this way makes sure that all of the environment variables are loaded before you execute any of the code of your app.</p>
<p>Whichever way you decide to go, the main point is to load the contents of your <code>.env</code> file as early as possible so those variables will be available to your code.</p>
<h3 id="keeping-the-.env-file-out-of-source-control">Keeping the <code>.env</code> file out of source control</h3>
<p>It’s important to keep your <code>.env</code> file out of your source control as it will often contain sensitive information like database connection settings or API keys and secrets. If you’re using Git for your source control, make sure that your <code>.gitignore</code> file includes an entry for <code>.env</code> files.</p>
<p>If you’re working on a team, you’ll need a way to document what the contents of the <code>.env</code> should look like. One approach is to update the project’s <code>README.md</code> file with instructions on what environment variables need to be defined in the <code>.env</code> file. Another option is to add an <code>.env.example</code> file to your project that mirrors the contents of the <code>.env</code> file but replaces any sensitive information with dummy values:</p>
<pre><code>PORT=8080
DB_USERNAME=dbuser
DB_PASSWORD=dbuserpassword
DB_DATABASE=dbname
DB_HOST=localhost</code></pre>
<p>In many companies, managing the environment variables or <code>.env</code> files will be handled by whatever process the company uses to get the code deployed and running on the actual servers. Often companies will have dedicated teams of System Administrators or "DevOps" personnel that handle these tasks. As a developer you may have to work with these teams to determine what the best strategy is for getting the environment variables set for your application.</p>
<h2 id="using-a-module-to-organize-environment-variables">Using a module to organize environment variables</h2>
<p>Earlier we mentioned that the <code>process</code> object is a global Node object, which means that you can safely access the <code>process.env</code> property from anywhere within your Node application. While that’s true, you might find it helpful to encapsulate all of your <code>process.env</code> property access into a single <code>config</code> module. The <code>config</code> module has a single purpose: to import all of your environment variables and export them to make them available to the rest of your application:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb241-1" title="1"><span class="co">// config.js</span></a>
<a class="sourceLine" id="cb241-2" title="2"></a>
<a class="sourceLine" id="cb241-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb241-4" title="4">  <span class="dt">environment</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">||</span> <span class="st">&#39;development&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb241-5" title="5">  <span class="dt">port</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">,</span></a>
<a class="sourceLine" id="cb241-6" title="6">  <span class="dt">db</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb241-7" title="7">    <span class="dt">username</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_USERNAME</span><span class="op">,</span></a>
<a class="sourceLine" id="cb241-8" title="8">    <span class="dt">password</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_PASSWORD</span><span class="op">,</span></a>
<a class="sourceLine" id="cb241-9" title="9">    <span class="dt">database</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_DATABASE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb241-10" title="10">    <span class="dt">host</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_HOST</span><span class="op">,</span></a>
<a class="sourceLine" id="cb241-11" title="11">  <span class="op">},</span></a>
<a class="sourceLine" id="cb241-12" title="12"><span class="op">};</span></a></code></pre></div>
<p>Creating a <code>config</code> module also gives you a convenient place to optionally provide default values and to alias environment variable names (notice how the <code>NODE_ENV</code> environment variable is being aliased to <code>environment</code>).</p>
<p>Any other module in your application that needs access to a configuration variable value just needs to require the <code>config</code> module:</p>
<blockquote>
<p>Make sure this is done after the environment variables are loaded if you are using the <code>dotenv</code> module.</p>
</blockquote>
<div class="sourceCode" id="cb242"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb242-1" title="1"><span class="co">// app.js</span></a>
<a class="sourceLine" id="cb242-2" title="2"></a>
<a class="sourceLine" id="cb242-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb242-4" title="4"></a>
<a class="sourceLine" id="cb242-5" title="5"><span class="co">// Load the environment variables from the .env file</span></a>
<a class="sourceLine" id="cb242-6" title="6"><span class="at">require</span>(<span class="st">&#39;dotenv&#39;</span>).<span class="at">config</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb242-7" title="7"></a>
<a class="sourceLine" id="cb242-8" title="8"><span class="co">// Get the port environment variable value.</span></a>
<a class="sourceLine" id="cb242-9" title="9"><span class="kw">const</span> <span class="op">{</span> port <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./config&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb242-10" title="10"></a>
<a class="sourceLine" id="cb242-11" title="11"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb242-12" title="12"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb242-13" title="13"></a>
<a class="sourceLine" id="cb242-14" title="14"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb242-15" title="15"></a>
<a class="sourceLine" id="cb242-16" title="16"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb242-17" title="17">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from Express!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb242-18" title="18"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb242-19" title="19"></a>
<a class="sourceLine" id="cb242-20" title="20"><span class="co">// Start listening for connections.</span></a>
<a class="sourceLine" id="cb242-21" title="21"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Notice how destructuring is being used to get a specific configuration variable value when requiring the <code>config</code> module:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb243-1" title="1"><span class="kw">const</span> <span class="op">{</span> port <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./config&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Without using destructuring, you could get the <code>port</code> configuration variable value like this:</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb244-1" title="1"><span class="kw">const</span> config <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./config&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb244-2" title="2"><span class="kw">const</span> port <span class="op">=</span> <span class="va">config</span>.<span class="at">port</span><span class="op">;</span></a></code></pre></div>
<p>Or like this:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb245-1" title="1"><span class="kw">const</span> port <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./config&#39;</span>).<span class="at">port</span><span class="op">;</span></a></code></pre></div>
<p>Any of these approaches work fine. Deciding which to use is one of the many stylistic choices you’ll make as a developer.</p>
<h3 id="running-npm-binaries">Running npm binaries</h3>
<p>Using npx to run an npm binary like the Sequelize CLI won’t work if you’ve defined environment variables in an <code>.env</code> file for your database connection settings. You’ll need to use a tool like the <code>dotenv-cli</code> npm package as an intermediary between npx and the Sequelize CLI to load your environment variables from the <code>.env</code> file and run the command that you pass into it.</p>
<p>To start, install the <code>dotenv-cli</code> package as a development dependency:</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb246-1" title="1"><span class="ex">npm</span> install dotenv-cli --save-dev</a></code></pre></div>
<p>Then use npx to run the <code>dotenv</code> command passing in the command to invoke using the set of environment variables loaded from your <code>.env</code> file:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb247-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate</a></code></pre></div>
<h3 id="defining-environment-specific-npm-scripts">Defining environment specific npm scripts</h3>
<p>Sometimes you may want to run different npm scripts for different <code>NODE_ENV</code> environments.</p>
<p>For instance you might have this in your package.json for local development.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb248-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb248-2" title="2">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb248-3" title="3">    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon app.js&quot;</span></a>
<a class="sourceLine" id="cb248-4" title="4">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb248-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>But in production we may not want to run nodemon, since our code won’t be changing constantly. Perhaps, production needs a package.json like this instead:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb249-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb249-2" title="2">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb249-3" title="3">    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;node app.js&quot;</span></a>
<a class="sourceLine" id="cb249-4" title="4">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb249-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>To keep from having to manually change your npm <code>start</code> script before you deploy your application to the production environment, you can use a tool like the <code>per-env</code> npm package that allows you to define npm scripts for each of your application’s environments.</p>
<p>To start, install the <code>per-env</code> package:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb250-1" title="1"><span class="ex">npm</span> install per-env</a></code></pre></div>
<p>Then update your npm scripts to this:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb251-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb251-2" title="2">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb251-3" title="3">    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;per-env&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb251-4" title="4">    <span class="dt">&quot;start:development&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon app.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb251-5" title="5">    <span class="dt">&quot;start:production&quot;</span><span class="fu">:</span> <span class="st">&quot;node app.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb251-6" title="6">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb251-7" title="7"><span class="fu">}</span></a></code></pre></div>
<p>If the <code>NODE_ENV</code> environment variable is set to <code>production</code>, then running the <code>start</code> script will result in the execution of the <code>start:production</code> script. If the <code>NODE_ENV</code> variable isn’t defined, then the <code>start:development</code> script will be executed by default.</p>
<p>Using this approach, you can conveniently define a <code>start</code> script (or any predefined or custom script) for each environment that your application will be deployed to.</p>
<h2 id="what-you-learned-7">What you learned</h2>
<p>In this article, you learned how to</p>
<ul>
<li>set and get an environment variable value</li>
<li>store environment variable values in an <code>.env</code> file</li>
<li>use a module to organize environment variables</li>
<li>handle running different npm scripts in different environments.</li>
</ul>
<hr />
<h1 id="asynchronous-route-handlers-in-express">Asynchronous Route Handlers in Express</h1>
<p>Up to this point, your Express route handler functions have been synchronous—each statement predictably executes in the order that they’re written in. Most Express applications, at some point, need to interact with a database or an API (or both). Interacting with those external resources requires you to write asynchronous code, which in turn requires your route handler functions to be asynchronous.</p>
<p>In modern JavaScript applications, writing asynchronous code means working with Promises and optionally the <code>async</code>/<code>await</code> keywords. When working with Promises in Express route handlers or middleware functions, special attention needs to be spent on how errors are handled.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Recall that Express cannot process unhandled Promise rejections from within route handler (or middleware) functions;</li>
<li>Use a Promise <code>catch</code> block or a <code>try</code>/<code>catch</code> statement with <code>async</code>/<code>await</code> to properly handle errors thrown from within an asynchronous route handler (or middleware) function; and</li>
<li>Write a wrapper function to simplify catching errors thrown within asynchronous route handler (or middleware) functions.</li>
</ul>
<h2 id="calling-asynchronous-functions-or-methods-within-route-handlers">Calling asynchronous functions or methods within route handlers</h2>
<p>To see how to properly call asynchronous functions or methods within route handlers, you need an asynchronous function or method to call.</p>
<h3 id="creating-a-simple-asynchronous-function">Creating a simple asynchronous function</h3>
<p>In a future article, you’ll see how to integrate your Express application with a database. For now keep things as simple as possible by creating a standalone function that wraps the built-in <code>setTimeout()</code> function in a Promise:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb252-1" title="1"><span class="co">/**</span></a>
<a class="sourceLine" id="cb252-2" title="2"><span class="co">* Asynchronous function that delays for the provided length of time.</span></a>
<a class="sourceLine" id="cb252-3" title="3"><span class="co">* If the length of time to wait is less than &#39;0&#39;, then the returned</span></a>
<a class="sourceLine" id="cb252-4" title="4"><span class="co">* Promise will reject, otherwise it&#39;ll resolve.</span></a>
<a class="sourceLine" id="cb252-5" title="5"><span class="co">* </span><span class="an">@param</span><span class="co"> </span><span class="cv">{number}</span><span class="co"> timeToWait - The length of time to wait in milliseconds.</span></a>
<a class="sourceLine" id="cb252-6" title="6"><span class="co">*/</span></a>
<a class="sourceLine" id="cb252-7" title="7"><span class="kw">const</span> delay <span class="op">=</span> (timeToWait) <span class="kw">=&gt;</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb252-8" title="8"> <span class="at">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb252-9" title="9">   <span class="cf">if</span> (timeToWait <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb252-10" title="10">     <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;An error has occurred!&#39;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb252-11" title="11">   <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb252-12" title="12">     <span class="at">resolve</span>(<span class="vs">`All done waiting for </span><span class="sc">${</span>timeToWait<span class="sc">}</span><span class="vs">ms!`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb252-13" title="13">   <span class="op">}</span></a>
<a class="sourceLine" id="cb252-14" title="14"> <span class="op">},</span> <span class="va">Math</span>.<span class="at">abs</span>(timeToWait))<span class="op">;</span></a>
<a class="sourceLine" id="cb252-15" title="15"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The above <code>delay()</code> function accepts a <code>timeToWait</code> value and returns a new Promise that calls the <code>setTimeout()</code> function passing in the <code>timeToWait</code> absolute value. When the <code>setTimeout()</code> function call completes, the Promise is resolved if the <code>timeToWait</code> value is a positive number or it’s rejected if the <code>timeToWait</code> value is a negative number.</p>
<blockquote>
<p><strong>Note:</strong> The <code>Math.abs()</code> function is used to get the absolute value of the <code>timeToWait</code> parameter value. Getting the absolute value ensures that the value passed to the <code>setTimeout()</code> function is always a positive number. For more information about absolute values, see <a href="https://en.wikipedia.org/wiki/Absolute_value">this Wikipedia page</a>.</p>
</blockquote>
<h3 id="setting-up-the-express-application">Setting up the Express application</h3>
<p>With your <code>delay()</code> function in hand, use it to create a simple Express application:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb253-1" title="1"><span class="co">// app.js</span></a>
<a class="sourceLine" id="cb253-2" title="2"></a>
<a class="sourceLine" id="cb253-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb253-4" title="4"></a>
<a class="sourceLine" id="cb253-5" title="5"><span class="co">/**</span></a>
<a class="sourceLine" id="cb253-6" title="6"><span class="co">* Asynchronous function that delays for the provided length of time.</span></a>
<a class="sourceLine" id="cb253-7" title="7"><span class="co">* If the length of time to wait is less than &#39;0&#39;, then the returned</span></a>
<a class="sourceLine" id="cb253-8" title="8"><span class="co">* Promise will reject, otherwise it&#39;ll resolve.</span></a>
<a class="sourceLine" id="cb253-9" title="9"><span class="co">* </span><span class="an">@param</span><span class="co"> </span><span class="cv">{number}</span><span class="co"> timeToWait - The length of time to wait in milliseconds.</span></a>
<a class="sourceLine" id="cb253-10" title="10"><span class="co">*/</span></a>
<a class="sourceLine" id="cb253-11" title="11"><span class="kw">const</span> delay <span class="op">=</span> (timeToWait) <span class="kw">=&gt;</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb253-12" title="12"> <span class="at">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb253-13" title="13">   <span class="cf">if</span> (timeToWait <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb253-14" title="14">     <span class="at">reject</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;An error has occurred!&#39;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb253-15" title="15">   <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb253-16" title="16">     <span class="at">resolve</span>(<span class="vs">`All done waiting for </span><span class="sc">${</span>timeToWait<span class="sc">}</span><span class="vs">ms!`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb253-17" title="17">   <span class="op">}</span></a>
<a class="sourceLine" id="cb253-18" title="18"> <span class="op">},</span> <span class="va">Math</span>.<span class="at">abs</span>(timeToWait))<span class="op">;</span></a>
<a class="sourceLine" id="cb253-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb253-20" title="20"></a>
<a class="sourceLine" id="cb253-21" title="21"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb253-22" title="22"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb253-23" title="23"></a>
<a class="sourceLine" id="cb253-24" title="24"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb253-25" title="25"></a>
<a class="sourceLine" id="cb253-26" title="26"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb253-27" title="27">  <span class="co">// </span><span class="al">TODO</span></a>
<a class="sourceLine" id="cb253-28" title="28"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb253-29" title="29"></a>
<a class="sourceLine" id="cb253-30" title="30"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb253-31" title="31"></a>
<a class="sourceLine" id="cb253-32" title="32"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb253-33" title="33"></a>
<a class="sourceLine" id="cb253-34" title="34"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<blockquote>
<p><strong>Note:</strong> If you’re following along, don’t forget to use npm to install Express (i.e. <code>npm install express</code>)!</p>
</blockquote>
<p>Now call the <code>delay()</code> function within your route handler function. Remember that the <code>delay()</code> function returns a Promise, so you can use the Promise <code>then()</code> method to execute code when the <code>delay()</code> method completes. Within the callback that you pass to the <code>then()</code> method, send the value returned from the <code>delay()</code> function to the client using the <code>res.send()</code> method:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb254-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-2" title="2"> <span class="at">delay</span>(<span class="dv">5000</span>).<span class="at">then</span>((value) <span class="kw">=&gt;</span> <span class="va">res</span>.<span class="at">send</span>(value))<span class="op">;</span></a>
<a class="sourceLine" id="cb254-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>If you start your application (i.e. <code>node app.js</code>) and browse to <code>http://localhost:8080/</code> you’ll see that the request hangs for 5 seconds before the server sends the response "All done waiting for 5000ms!"</p>
<p>Feel free to experiment by varying the number of milliseconds that you’re passing to the <code>delay()</code> function. For now, continue to pass a positive number; we’ll see in just a moment what happens when we pass a negative number.</p>
<h3 id="using-asyncawait">Using <code>async</code>/<code>await</code></h3>
<p>Instead of using the Promise <code>then()</code> method to execute code when an asynchronous function or method call has completed, you can use the <code>await</code> keyword.</p>
<p>Start with adding the <code>async</code> keyword to your route handler function to indicate that it’s going to make an asynchronous function or method call. Then use the <code>await</code> keyword to wait for a result to be returned from the <code>delay()</code> function call:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb255-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb255-2" title="2"> <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">delay</span>(<span class="dv">5000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb255-3" title="3"> <span class="va">res</span>.<span class="at">send</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb255-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>If you test your application again you’ll see that it behaves the same as it did before—the request hangs for 5 seconds before the server sends the response "All done waiting for 5000ms!"</p>
<h3 id="catching-errors-thrown-by-asynchronous-functions-or-methods">Catching errors thrown by asynchronous functions or methods</h3>
<p>So far, you’ve stayed on the "happy" path by passing a positive number to the <code>delay()</code> function. If you pass a negative number to the <code>delay()</code> function, it’ll throw an error:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb256-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb256-2" title="2"> <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">delay</span>(<span class="op">-</span><span class="dv">5000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb256-3" title="3"> <span class="va">res</span>.<span class="at">send</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb256-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This time when testing your application, the browser will indefinitely hang as it waits for the server to return a response. If you look in the terminal, you’ll see that an error occurred:</p>
<pre><code>(node:89455) UnhandledPromiseRejectionWarning: Error: An error has occurred!
    at Timeout._onTimeout ([path to the project folder]/app.js:13:14)
    at listOnTimeout (internal/timers.js:537:17)
    at processTimers (internal/timers.js:481:7)
(node:89455) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 1)
(node:89455) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.</code></pre>
<p>Node.js is warning you that an unhandled Promise rejection occurred. Furthermore, it’s warning that in a future version of Node, unhandled Promise rejections will terminate the Node process (which would result in your application being stopped)!</p>
<p>Luckily, this issue is easy to deal with—simply add a <code>try</code>/<code>catch</code> statement around your asynchronous function or method call:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb258-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb258-2" title="2"> <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb258-3" title="3">   <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">delay</span>(<span class="op">-</span><span class="dv">5000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb258-4" title="4">   <span class="va">res</span>.<span class="at">send</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb258-5" title="5"> <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb258-6" title="6">   <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb258-7" title="7"> <span class="op">}</span></a>
<a class="sourceLine" id="cb258-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Notice that you need to add the <code>next</code> parameter to your route handler function parameter list and pass the caught error to the <code>next()</code> method in the <code>catch</code> block. Passing the error to the <code>next()</code> method allows the Express default error handler process the error.</p>
<blockquote>
<p><strong>Note:</strong> When writing custom middleware functions, calling the <code>next()</code> method <strong>without an argument</strong> passes control to the next middleware function. Calling the <code>next()</code> method <strong>with an argument</strong> results in Express handling the current request as an error and skipping any remaining routing and middleware functions.</p>
</blockquote>
<p>The Express default error handler is a special type of middleware function that’s responsible for handling errors. In a development environment, the default error handler logs the error to the console and sends a response with an HTTP status code of <code>500 Internal Server Error</code> to the client containing the error message along with the stack trace.</p>
<p>If you test your application again, you’ll see the default error handler in action as it provides details about the unhandled error that occurred after the <code>delay()</code> function has waited for the number of milliseconds that you passed in:</p>
<pre><code>Error: An error has occurred!
   at Timeout._onTimeout ([path to the project folder]/app.js:13:14)
   at listOnTimeout (internal/timers.js:537:17)
   at processTimers (internal/timers.js:481:7)</code></pre>
<p>If you’re not using the <code>async</code>/<code>await</code> keywords, you need to call the <code>catch()</code> method on the Promise returned by the <code>delay()</code> function to handle any thrown errors:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb260-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb260-2" title="2"> <span class="at">delay</span>(<span class="op">-</span><span class="dv">5000</span>)</a>
<a class="sourceLine" id="cb260-3" title="3">   .<span class="at">then</span>((value) <span class="kw">=&gt;</span> <span class="va">res</span>.<span class="at">send</span>(value))</a>
<a class="sourceLine" id="cb260-4" title="4">   .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="at">next</span>(err))<span class="op">;</span></a>
<a class="sourceLine" id="cb260-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Again, notice that you need to add the <code>next</code> parameter to your route handler function parameter list and call the <code>next()</code> method passing in the error caught by the <code>catch()</code> method.</p>
<p>If you’re only passing the error to the <code>next()</code> method, you can simplify your code by passing the reference to the <code>next()</code> method directly to the <code>catch()</code> method call:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb261-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb261-2" title="2"> <span class="at">delay</span>(<span class="op">-</span><span class="dv">5000</span>)</a>
<a class="sourceLine" id="cb261-3" title="3">   .<span class="at">then</span>((value) <span class="kw">=&gt;</span> <span class="va">res</span>.<span class="at">send</span>(value))</a>
<a class="sourceLine" id="cb261-4" title="4">   .<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb261-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Express is able to automatically catch errors thrown by synchronous route handlers. When performing asynchronous operations within route handlers, it’s important to remember that <strong>Express is unable to catch errors thrown by asynchronous route handlers</strong>. Given that, asynchronous route handlers need to catch their own errors and pass them to the <code>next()</code> method.</p>
<blockquote>
<p><strong>Note:</strong> While all of the examples that you’ve seen in this article are built around route handlers, everything that’s been shown and discussed equally applies to asynchronous custom middleware functions.</p>
</blockquote>
<h2 id="reducing-boilerplate-code">Reducing boilerplate code</h2>
<p>Adding a <code>try</code>/<code>catch</code> statement to each route handler function that needs to call an asynchronous function or method can result in a lot of boilerplate code. If your application only has a handful of routes that’s probably not an issue, but if your application has dozens of routes (or more), it’s worth taking a look at how you can reduce the amount of boilerplate code you need to write.</p>
<h3 id="writing-an-asynchronous-route-handler-wrapper-function">Writing an asynchronous route handler wrapper function</h3>
<p>One approach to avoiding writing boilerplate code is to write a simple asynchronous route handler wrapper function to catch errors.</p>
<p>Start by defining a function named <code>asyncHandler</code> that accepts a reference to a route handler function and returns a function that defines three parameters, <code>req</code>, <code>res</code>, and <code>next</code>:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb262-1" title="1"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-2" title="2">  <span class="cf">return</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-3" title="3">    <span class="co">// </span><span class="al">TODO</span></a>
<a class="sourceLine" id="cb262-4" title="4">  <span class="op">};</span></a>
<a class="sourceLine" id="cb262-5" title="5"><span class="op">};</span></a></code></pre></div>
<p>Then, within the function that’s being returned, call the passed in route handler function (i.e. the <code>handler</code> parameter), passing in the <code>req</code>, <code>res</code>, and <code>next</code> parameters:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb263-1" title="1"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb263-2" title="2"> <span class="cf">return</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb263-3" title="3">   <span class="cf">return</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next)<span class="op">;</span></a>
<a class="sourceLine" id="cb263-4" title="4"> <span class="op">};</span></a>
<a class="sourceLine" id="cb263-5" title="5"><span class="op">};</span></a></code></pre></div>
<p>And finally, call the <code>catch()</code> method on the Promise returned from the route handler function passing in the <code>next</code> parameter:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb264-1" title="1"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-2" title="2"> <span class="cf">return</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-3" title="3">   <span class="cf">return</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-4" title="4"> <span class="op">};</span></a>
<a class="sourceLine" id="cb264-5" title="5"><span class="op">};</span></a></code></pre></div>
<p>Remember, passing the <code>next</code> parameter to the <code>catch()</code> method allows the Express default error handler to process any errors thrown by the route handler function.</p>
<p>Because each of the arrow functions return a single statement, the <code>asyncHandler()</code> function can optionally be written a little more concisely:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb265-1" title="1"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p><strong>Note:</strong> Developers sometimes find the more concise version to be more difficult to read and understand, so if you’re working on a team, talk with your teammates and determine which approach is the team’s preferred approach.</p>
</blockquote>
<h3 id="using-the-asynchronous-route-handler-wrapper-function">Using the asynchronous route handler wrapper function</h3>
<p>As a reminder, this is what your asynchronous route handler currently looks like:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb266-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb266-2" title="2"> <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb266-3" title="3">   <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">delay</span>(<span class="op">-</span><span class="dv">5000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb266-4" title="4">   <span class="va">res</span>.<span class="at">send</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb266-5" title="5"> <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb266-6" title="6">   <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb266-7" title="7"> <span class="op">}</span></a>
<a class="sourceLine" id="cb266-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Wrapping your asynchronous route handler with your <code>asyncHandler()</code> helper function looks like this:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb267-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-2" title="2"> <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">delay</span>(<span class="dv">5000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb267-3" title="3"> <span class="va">res</span>.<span class="at">send</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb267-4" title="4"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Because the <code>asyncHandler()</code> function is calling the <code>catch()</code> method on the Promise that’s returned from the asynchronous route handler you can safely remove the <code>try</code>/<code>catch</code> statement. This makes asynchronous route handlers cleaner and easier to read and maintain.</p>
<blockquote>
<p><strong>Note:</strong> You might wonder how the <code>asyncHandler()</code> function can successfully call the <code>catch()</code> method after invoking the asynchronous route handler function if the route handler function doesn’t explicitly return a Promise. Remember that marking a function or method with the <code>async</code> keyword results in that function or method implicitly returning a Promise. Your asynchronous route handler is marked as an <code>async</code> function, so it implicitly returns a Promise.</p>
</blockquote>
<h2 id="what-you-learned-8">What you learned</h2>
<p>In this article, you learned</p>
<ul>
<li>that Express cannot process unhandled Promise rejections from within a route handler (or middleware) function;</li>
<li>how to use a Promise <code>catch</code> block or a <code>try</code>/<code>catch</code> statement with <code>async</code>/<code>await</code> to properly handle errors thrown from within asynchronous route handler (or middleware) function; and</li>
<li>how to write a wrapper function to simplify catching errors thrown within asynchronous route handler (or middleware) functions.</li>
</ul>
<h2 id="see-also-3">See also…</h2>
<p>While writing a wrapper function for your asynchronous route handler function is easy to do, you can also use an npm package to accomplish the same thing without having to write any extra code. If you’re interested to see what this looks like, check out the <a href="https://www.npmjs.com/package/express-promise-router"><code>express-promise-router</code> npm package</a>.</p>
<hr />
<h1 id="handling-errors-in-express">Handling Errors in Express</h1>
<p>No matter how hard we try, we all make mistakes when writing code. If you’re lucky, the coding mistake will break the execution of the application in a very obvious way—crashing the application when testing in the local development environment. If you’re unlucky, the coding mistake will go unnoticed, only to surface as an unexpected error when the application is being used by end users.</p>
<p>When an unexpected error occurs, the default error handler in Express will send a response to the browser containing the error message along with the stack trace (if you’re not running in a production environment). While the default error handler might work fine in your local development environment, for most applications you’ll want to create a custom error handler to precisely control how errors are handled in other environments (i.e. test, staging, or production).</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Describe how an error handler function differs from middleware and route handler functions;</li>
<li>Define a global error-handling function to catch and process unhandled errors; and</li>
<li>Define a route to handle requests for unknown routes by throwing a 404 NOT FOUND error.</li>
</ul>
<h2 id="setting-up-an-example-express-application">Setting up an example Express application</h2>
<p>Let’s create a simple application to assist with exploring how to handle errors in Express.</p>
<p>Create a folder for your project (if you haven’t already), open a terminal and browse to your project folder, and run the following commands:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb268-1" title="1"><span class="ex">npm</span> init -y</a>
<a class="sourceLine" id="cb268-2" title="2"><span class="ex">npm</span> install express@^4.0.0 pug@^2.0.0</a>
<a class="sourceLine" id="cb268-3" title="3"><span class="ex">npm</span> install nodemon --save-dev</a></code></pre></div>
<blockquote>
<p><strong>Important:</strong> If you’re using Git, don’t forget to add a <code>.gitignore</code> file in the root of your project folder that contains an entry to ignore the <code>node_modules</code> folder! The <code>node_modules</code> folder tends to be very large and would bloat the Git repository if it was committed and pushed. Ignoring the <code>node_modules</code> folder is possible because it can be generated on demand by running the <code>npm install</code> command.</p>
</blockquote>
<p>Add an <code>app.js</code> file to the root of your project containing the following code:</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb269-1" title="1"><span class="co">// app.js</span></a>
<a class="sourceLine" id="cb269-2" title="2"></a>
<a class="sourceLine" id="cb269-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb269-4" title="4"></a>
<a class="sourceLine" id="cb269-5" title="5"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb269-6" title="6"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb269-7" title="7"></a>
<a class="sourceLine" id="cb269-8" title="8"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb269-9" title="9"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb269-10" title="10"></a>
<a class="sourceLine" id="cb269-11" title="11"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb269-12" title="12"></a>
<a class="sourceLine" id="cb269-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb269-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb269-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb269-16" title="16"></a>
<a class="sourceLine" id="cb269-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/throw-error&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb269-18" title="18">  <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;An error occurred!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb269-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb269-20" title="20"></a>
<a class="sourceLine" id="cb269-21" title="21"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb269-22" title="22"></a>
<a class="sourceLine" id="cb269-23" title="23"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb269-24" title="24"></a>
<a class="sourceLine" id="cb269-25" title="25"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Next, define an npm <code>start</code> script in your <code>package.json</code> file that uses Nodemon to run the application:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb270-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb270-2" title="2"> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;handling-errors-in-express&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-3" title="3"> <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-4" title="4"> <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-5" title="5"> <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;app.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-6" title="6"> <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb270-7" title="7">   <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon app.js&quot;</span></a>
<a class="sourceLine" id="cb270-8" title="8"> <span class="fu">},</span></a>
<a class="sourceLine" id="cb270-9" title="9"> <span class="dt">&quot;keywords&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-10" title="10"> <span class="dt">&quot;author&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-11" title="11"> <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;ISC&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-12" title="12"> <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb270-13" title="13">   <span class="dt">&quot;express&quot;</span><span class="fu">:</span> <span class="st">&quot;^4.17.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb270-14" title="14">   <span class="dt">&quot;pug&quot;</span><span class="fu">:</span> <span class="st">&quot;^2.0.4&quot;</span></a>
<a class="sourceLine" id="cb270-15" title="15"> <span class="fu">},</span></a>
<a class="sourceLine" id="cb270-16" title="16"> <span class="dt">&quot;devDependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb270-17" title="17">   <span class="dt">&quot;nodemon&quot;</span><span class="fu">:</span> <span class="st">&quot;^2.0.2&quot;</span></a>
<a class="sourceLine" id="cb270-18" title="18"> <span class="fu">}</span></a>
<a class="sourceLine" id="cb270-19" title="19"><span class="fu">}</span></a></code></pre></div>
<blockquote>
<p><strong>Pro Tip:</strong> Creating scripts in the <code>package.json</code> file allows you to customize and rename often used terminal commands. For example, the above <code>"start": "nodemon app.js"</code> script allows you to run <code>npm start</code> instead of <code>npx nodemon app.js</code> in your terminal to run the application.</p>
</blockquote>
<p>The last bit of set up business is to create a couple of Pug views. Add a <code>views</code> folder to the root of the project. Then add two files to the <code>views</code> folder: <code>layout.pug</code> and <code>index.pug</code>:</p>
<pre class="pug"><code>//- layout.pug

doctype html
html
 head
   title Custom Error Handlers - #{title}
 body
   h1 Custom Error Handlers
   h2= title
   div
     block content</code></pre>
<pre class="pug"><code>//- index.pug

extends layout.pug

block content
 p Welcome to the Custom Error Handlers project!</code></pre>
<p>Now you’re ready to run and test your application! From the terminal, run the command <code>npm start</code>, then browse to the URL <code>http://localhost:8080/</code>. You should see the application’s Home page.</p>
<h2 id="the-default-error-handler-in-express">The default error handler in Express</h2>
<p>After an error is thrown or the <code>next()</code> method is called with an argument from within a route handler, Express will handle the error using its default error handler.</p>
<p>You can see the default error handler in action by starting the example application (i.e. <code>npm start</code>) and browsing to <code>http://localhost:8080/throw-error</code>. The default error handler will send a response to the browser containing the error message along with the stack trace:</p>
<pre><code>Error: An error occurred!
   at throwError ([path to the project folder]/app.js:14:9)
   at [path to the project folder]/app.js:29:3
   at Layer.handle [as handle_request] ([path to the project folder]/node_modules/express/lib/router/layer.js:95:5)
   at next ([path to the project folder]/node_modules/express/lib/router/route.js:137:13)
   at Route.dispatch ([path to the project folder]/node_modules/express/lib/router/route.js:112:3)
   at Layer.handle [as handle_request] ([path to the project folder]/node_modules/express/lib/router/layer.js:95:5)
   at [path to the project folder]/node_modules/express/lib/router/index.js:281:22
   at Function.process_params ([path to the project folder]/node_modules/express/lib/router/index.js:335:12)
   at next ([path to the project folder]/node_modules/express/lib/router/index.js:275:10)
   at expressInit ([path to the project folder]/node_modules/express/lib/middleware/init.js:40:5)</code></pre>
<blockquote>
<p><strong>Note:</strong> If you’re following along, the placeholder text "[path to the project folder]" in the above error stack trace information will display the actual absolute path to your project folder.</p>
</blockquote>
<p>The response will also have an HTTP status code of <code>500 Internal Server Error</code>. You can view the response’s HTTP status code by inspecting the network information using your browser’s developer tools.</p>
<h3 id="do-you-need-a-custom-error-handler">Do you need a custom error handler?</h3>
<p>If the <code>NODE_ENV</code> environment variable is set to "production", then the default error handler will simply return a response with an HTTP status code of <code>500 Internal Server Error</code> containing the text "Internal Server Error".</p>
<p>You can see this in action by setting the <code>NODE_ENV</code> environment variable before starting the example application:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb274-1" title="1"><span class="va">NODE_ENV=</span>production <span class="ex">node</span> app.js</a></code></pre></div>
<figure>
<img src="images/express-default-error-handler-in-production.png" alt="express-default-error-handler-in-production" /><figcaption>express-default-error-handler-in-production</figcaption>
</figure>
<p>If an end user were to see the above error message in production, it would likely leave them frustrated and confused. While a custom error handler won’t be able to magically resolve unexpected errors for your users, it will allow you to display a friendlier message using your website’s layout template (you’ll see how to do this later in this article).</p>
<p>Defining a custom error handler will also allow you to log unexpected errors so that you (or someone on your team) can review them periodically to determine if an undetected bug has made its way into production.</p>
<h2 id="defining-a-custom-error-handler">Defining a custom error handler</h2>
<p>As you’ve seen in earlier lessons, Express middleware functions define three parameters (<code>req</code>, <code>res</code>, <code>next</code>) and route handlers define two or three parameters (<code>req</code>, <code>res</code>, and optionally the <code>next</code> parameter):</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb275-1" title="1"><span class="co">// Middleware function.</span></a>
<a class="sourceLine" id="cb275-2" title="2"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb275-3" title="3">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Hello from a middleware function!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb275-4" title="4">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb275-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb275-6" title="6"></a>
<a class="sourceLine" id="cb275-7" title="7"><span class="co">// Route handler function.</span></a>
<a class="sourceLine" id="cb275-8" title="8"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb275-9" title="9">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from a route handler function!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb275-10" title="10"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Error handling functions look the same as middleware functions except they define four parameters instead of three—<code>err</code>, <code>req</code>, <code>res</code>, and <code>next</code>:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb276-1" title="1"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb276-2" title="2">  <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb276-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;An error occurred!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb276-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Custom error handler functions have to define four parameters otherwise Express won’t recognize the function as an error handler. Route handler function definitions can omit the <code>next</code> parameter if it’s not going to be used; error handler functions have to include the <code>next</code> parameter.</p>
<p>Define error handler functions after all other calls to <code>app.use()</code> and all of your application’s route definitions:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb277-1" title="1"><span class="co">// app.js</span></a>
<a class="sourceLine" id="cb277-2" title="2"></a>
<a class="sourceLine" id="cb277-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-4" title="4"></a>
<a class="sourceLine" id="cb277-5" title="5"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb277-6" title="6"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb277-7" title="7"></a>
<a class="sourceLine" id="cb277-8" title="8"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb277-9" title="9"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-10" title="10"></a>
<a class="sourceLine" id="cb277-11" title="11"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb277-12" title="12"></a>
<a class="sourceLine" id="cb277-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb277-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-16" title="16"></a>
<a class="sourceLine" id="cb277-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/throw-error&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb277-18" title="18">  <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;An error occurred!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-20" title="20"></a>
<a class="sourceLine" id="cb277-21" title="21"><span class="co">// Custom error handler.</span></a>
<a class="sourceLine" id="cb277-22" title="22"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb277-23" title="23">  <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-24" title="24">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;An error occurred!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-25" title="25"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb277-26" title="26"></a>
<a class="sourceLine" id="cb277-27" title="27"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb277-28" title="28"></a>
<a class="sourceLine" id="cb277-29" title="29"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb277-30" title="30"></a>
<a class="sourceLine" id="cb277-31" title="31"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>This ensures that your custom error handler will get called to handle errors from any of your application’s middleware or route handler functions.</p>
<p>If you test your custom error handler by browsing to <code>http://localhost:8080/throw-error</code> you’ll see that it sends a response containing the text "An error occurred!".</p>
<p>If you use your browser’s developer tools to inspect the response of <code>http://localhost:8080/throw-error</code>, you’ll notice that the response HTTP status code is <code>200 OK</code>, which is the default status code used by Express when sending responses. You can use the <code>res.status()</code> method to set a different status code:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb278-1" title="1"><span class="co">// Custom error handler.</span></a>
<a class="sourceLine" id="cb278-2" title="2"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb278-3" title="3">  <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb278-4" title="4">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb278-5" title="5">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;An error occurred!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb278-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Notice how the <code>err.status</code> property is checked to see if it has a value before the status is set to the literal numeric value <code>500</code>. Giving priority to the <code>err.status</code> property allows code elsewhere in the application to throw an error that includes the specific HTTP status code to send to the client.</p>
<p>You can return an HTML response instead of plain text by rendering a Pug view:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb279-1" title="1"><span class="co">// Custom error handler.</span></a>
<a class="sourceLine" id="cb279-2" title="2"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb279-3" title="3"> <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb279-4" title="4"> <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb279-5" title="5"> <span class="kw">const</span> isProduction <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb279-6" title="6"> <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb279-7" title="7">   <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Server Error&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb279-8" title="8">   <span class="dt">message</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb279-9" title="9">   <span class="dt">error</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : err<span class="op">,</span></a>
<a class="sourceLine" id="cb279-10" title="10"> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb279-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Be sure to add the <code>error.pug</code> view to the <code>views</code> folder:</p>
<pre class="pug"><code>//- error.pug

extends layout.pug

block content
 div
   p= message || &#39;An unexpected error occurred on the server.&#39;
 if stack
   h3 Stack Trace
   pre= stack</code></pre>
<p>Notice that the error <code>message</code> and <code>stack</code> properties are only being passed to the view if the
    <code>NODE_ENV</code> environment variable isn’t set to "production". For security reasons, it’s important to avoid
    leaking potentially sensitive information about your application.</p>
<p>If you test your custom error handler again by browsing to <code>http://localhost:8080/throw-error</code> you’ll see that it sends an HTML response containing information about the error that was thrown.</p>
<p>To test how the error handler will behave in the production environment, set the <code>NODE_ENV</code> environment
    variable to "production" before starting the example application:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb281-1" title="1"><span class="va">NODE_ENV=</span>production <span class="ex">node</span> app.js</a></code></pre></div>
<h3 id="defining-multiple-custom-error-handlers">Defining multiple custom error handlers</h3>
<p>Express allows you to define more than one custom error handler which is useful if you need to handle specific types of errors differently. It’s also useful for creating an error handler to perform a specific error handling task. Let’s look at an example of defining a second error handler that’s responsible for logging errors.</p>
<p>Error handlers, like route handlers, are executed by Express in the order that they’re defined in, so defining a new error handler before the existing handler ensures that it’ll be called first:</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb282-1" title="1"><span class="co">// Custom error handlers.</span></a>
<a class="sourceLine" id="cb282-2" title="2"></a>
<a class="sourceLine" id="cb282-3" title="3"><span class="co">// Error handler to log errors.</span></a>
<a class="sourceLine" id="cb282-4" title="4"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb282-5" title="5">  <span class="cf">if</span> (<span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb282-6" title="6">    <span class="co">// </span><span class="al">TODO</span><span class="co"> Log the error to the database.</span></a>
<a class="sourceLine" id="cb282-7" title="7">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb282-8" title="8">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb282-9" title="9">  <span class="op">}</span></a>
<a class="sourceLine" id="cb282-10" title="10">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb282-11" title="11"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb282-12" title="12"></a>
<a class="sourceLine" id="cb282-13" title="13"><span class="co">// Generic error handler.</span></a>
<a class="sourceLine" id="cb282-14" title="14"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb282-15" title="15">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb282-16" title="16">  <span class="kw">const</span> isProduction <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb282-17" title="17">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb282-18" title="18">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Server Error&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb282-19" title="19">    <span class="dt">message</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb282-20" title="20">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb282-21" title="21">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb282-22" title="22"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The new error handler simply uses the <code>console.error()</code> method to log errors to the console, provided that the <code>NODE_ENV</code> environment variable isn’t set to "production". In the production environment, there’s a TODO comment to log the error to the database. The <code>console.error()</code> method call in the existing error handler was removed; logging errors is now the responsibility of the new error handler.</p>
<blockquote>
<p><strong>Note:</strong> Logging errors to a database—or another type of data store—is a common practice in production environments. Doing this allows a developer or system administrator to periodically review a log of application errors to determine if there are any issues that might need to be looked at in more detail. There are many ways to handle error logging, ranging from npm logging packages (e.g. <a href="https://www.npmjs.com/package/winston"><code>winston</code></a>) to full-blown application monitoring cloud-based services.</p>
</blockquote>
<p>Also notice that the new error handler calls the <code>next()</code> method passing in the <code>err</code> parameter (the current error) which passes control to the next error handler. An error handler needs to call <code>next()</code> or return a response. Failing to do this will result in the request "hanging" and consuming resources on the server.</p>
<h2 id="handling-page-not-found-errors">Handling "Page Not Found" errors</h2>
<p>A common feature for applications to implement is to present a friendly "Page Not Found" message to end users when a request can’t be matched to one of the application’s defined routes. Let’s see how to implement this feature using a combination of a middleware function and an error handler function.</p>
<p>First, add a new middleware function after the last route in your application (but before any of your error handlers):</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb283-1" title="1"><span class="co">// Catch unhandled requests and forward to error handler.</span></a>
<a class="sourceLine" id="cb283-2" title="2"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb283-3" title="3"> <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;The requested page couldn</span><span class="sc">\&#39;</span><span class="st">t be found.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb283-4" title="4"> <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb283-5" title="5"> <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb283-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Placing this middleware function after all of your routes means that this middleware function will only be invoked if a request fails to match any of your routes.</p>
<p>Notice that the middleware function creates a new Error object and sets a <code>status</code> property on the object to the literal number <code>404</code>. <code>404</code> is the HTTP status code for "Not Found" responses indicating that the requested resource could not be found.</p>
<p>After setting the <code>status</code> property, the <code>next()</code> method is called with the <code>err</code> variable passed as an argument. Remember that calling the <code>next()</code> method with an argument results in Express handling the current request as an error and skipping any remaining routing and middleware functions.</p>
<p>At this point, you can test your "Page Not Found" middleware function by browsing to <code>http://localhost:8080/some-unknown-page</code> (or really any path that doesn’t match one of your application’s configured routes). You should see your "Server Error" page displaying the message "The requested page couldn’t be found."</p>
<h3 id="creating-a-page-not-found-page">Creating a "Page Not Found" page</h3>
<p>While the current solution works, a more elegant solution would be to present a specific "Page Not Found" page to the end user.</p>
<p>To do this, define another error handler—in between the logging and generic error handlers—for handling 404 errors:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb284-1" title="1"><span class="co">// Error handler for 404 errors.</span></a>
<a class="sourceLine" id="cb284-2" title="2"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb284-3" title="3">  <span class="cf">if</span> (<span class="va">err</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb284-4" title="4">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">404</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb284-5" title="5">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;page-not-found&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb284-6" title="6">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Page Not Found&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb284-7" title="7">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb284-8" title="8">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb284-9" title="9">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb284-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb284-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This error handler starts by checking if the <code>err.status</code> property is set to <code>404</code>—which indicates that the current error is a "Not Found" error. If the current error is a "Not Found" error, then it sets the response HTTP status code to <code>404</code> and calls the <code>res.render()</code> method to render the <code>page-not-found</code> view (you’ll create that view in just a bit). Otherwise, the <code>next()</code> method is called with the <code>err</code> parameter passed as an argument, which passes control to the next error handler.</p>
<p>Before testing your new error handler, don’t forget to add a new view named <code>page-not-found.pug</code> to the <code>views</code> folder with the following content:</p>
<pre class="pug"><code>//- page-not-found.pug

extends layout.pug

block content
 div
   p Sorry, we couldn&#39;t find the page that you requested.</code></pre>
<p>Now if you test your application again by browsing to <code>http://localhost:8080/some-unknown-page</code> (or any path that doesn’t match one of your application’s configured routes) you should see your new "Page Not Found" page.</p>
<p>For your reference, here’s the final version of the <code>app.js</code> file:</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb286-1" title="1"><span class="co">// app.js</span></a>
<a class="sourceLine" id="cb286-2" title="2"></a>
<a class="sourceLine" id="cb286-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-4" title="4"></a>
<a class="sourceLine" id="cb286-5" title="5"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb286-6" title="6"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb286-7" title="7"></a>
<a class="sourceLine" id="cb286-8" title="8"><span class="co">// Set the pug view engine.</span></a>
<a class="sourceLine" id="cb286-9" title="9"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-10" title="10"></a>
<a class="sourceLine" id="cb286-11" title="11"><span class="co">// Define routes.</span></a>
<a class="sourceLine" id="cb286-12" title="12"></a>
<a class="sourceLine" id="cb286-13" title="13"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-14" title="14">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-15" title="15"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-16" title="16"></a>
<a class="sourceLine" id="cb286-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/throw-error&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-18" title="18">  <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;An error occurred!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-19" title="19"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-20" title="20"></a>
<a class="sourceLine" id="cb286-21" title="21"><span class="co">// Catch unhandled requests and forward to error handler.</span></a>
<a class="sourceLine" id="cb286-22" title="22"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-23" title="23">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;The requested page couldn</span><span class="sc">\&#39;</span><span class="st">t be found.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-24" title="24">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb286-25" title="25">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-26" title="26"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-27" title="27"></a>
<a class="sourceLine" id="cb286-28" title="28"><span class="co">// Custom error handlers.</span></a>
<a class="sourceLine" id="cb286-29" title="29"></a>
<a class="sourceLine" id="cb286-30" title="30"><span class="co">// Error handler to log errors.</span></a>
<a class="sourceLine" id="cb286-31" title="31"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-32" title="32">  <span class="cf">if</span> (<span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb286-33" title="33">    <span class="co">// </span><span class="al">TODO</span><span class="co"> Log the error to the database.</span></a>
<a class="sourceLine" id="cb286-34" title="34">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-35" title="35">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-36" title="36">  <span class="op">}</span></a>
<a class="sourceLine" id="cb286-37" title="37">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-38" title="38"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-39" title="39"></a>
<a class="sourceLine" id="cb286-40" title="40"><span class="co">// Error handler for 404 errors.</span></a>
<a class="sourceLine" id="cb286-41" title="41"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-42" title="42">  <span class="cf">if</span> (<span class="va">err</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb286-43" title="43">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">404</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-44" title="44">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;page-not-found&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-45" title="45">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Page Not Found&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb286-46" title="46">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-47" title="47">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-48" title="48">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-49" title="49">  <span class="op">}</span></a>
<a class="sourceLine" id="cb286-50" title="50"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-51" title="51"></a>
<a class="sourceLine" id="cb286-52" title="52"><span class="co">// Generic error handler.</span></a>
<a class="sourceLine" id="cb286-53" title="53"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-54" title="54">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-55" title="55">  <span class="kw">const</span> isProduction <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb286-56" title="56">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb286-57" title="57">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Server Error&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb286-58" title="58">    <span class="dt">message</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb286-59" title="59">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb286-60" title="60">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-61" title="61"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb286-62" title="62"></a>
<a class="sourceLine" id="cb286-63" title="63"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb286-64" title="64"></a>
<a class="sourceLine" id="cb286-65" title="65"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb286-66" title="66"></a>
<a class="sourceLine" id="cb286-67" title="67"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<h2 id="what-you-learned-9">What you learned</h2>
<p>In this article, you learned</p>
<ul>
<li>how an error handler function differs from middleware and route handler functions;</li>
<li>how to define a global error-handling function to catch and process unhandled errors; and</li>
<li>how to define a route to handle requests for unknown routes by throwing a 404 NOT FOUND error.</li>
</ul>
<hr />
<h1 id="data-driven-websites---part-1-setting-up-the-project">Data-Driven Websites - Part 1: Setting Up the Project</h1>
<p>Data-driven websites are everywhere online. From e-commerce websites to search websites to mega social media websites, data is the foundation of the dynamic, personalized experiences that users have come to expect of the Web.</p>
<p>You’ve learned all of the necessary skills—now it’s time to bring it all together to create a data-driven website using Express!</p>
<p>Over the next three articles, you’ll create a data-driven Reading List website that will allow you to view a list of books, add a book to the list, update a book in the list, and delete a book from the list. In this article, you’ll set up the project. In the next article, you’ll learn how to integrate Sequelize with an Express application. In the last article, you’ll create the routes and views to perform CRUD (create, read, update, and delete) operations using Sequelize.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Split the Express application and HTTP server into separate modules;</li>
<li>Use the <code>morgan</code> npm package to log requests; and</li>
<li>Add support for the Bootstrap front-end component library to your application’s Pug layout template.</li>
</ul>
<p>You’ll also review the following:</p>
<ul>
<li>Setting up a new Express project;</li>
<li>Stubbing out an Express application;</li>
<li>Adding custom error handlers to an Express application; and</li>
<li>Configuring environment variables.</li>
</ul>
<h2 id="setting-up-the-project-1">Setting up the project</h2>
<p>First things first, create a folder for your project. If you’re using source control (and you are—right?), open a terminal, browse to your project folder, and initialize your Git repository by running the command <code>git init</code>.</p>
<p>You’ll be using npm to install packages in just a bit, so be sure to add a <code>.gitignore</code> file to the root of your project. Then add the entry <code>node_modules/</code> to the <code>.gitignore</code> file so that the <code>node_modules</code> folder (where npm downloads packages to) won’t be tracked by Git.</p>
<blockquote>
<p><strong>Pro Tip:</strong> While configuring Git to not track the <code>node_modules</code> folder is important to do, it’s not necessarily the only thing you want to configure Git not to track. For a more comprehensive <code>.gitignore</code> file for Node.js projects, you can use <a href="https://github.com/github/gitignore/blob/master/Node.gitignore">GitHub’s <code>.gitignore</code> file for Node.js projects</a>.</p>
</blockquote>
<h3 id="initializing-npm-and-installing-dependencies">Initializing npm and installing dependencies</h3>
<p>Before you stub out the application, use npm to initialize your project and install the following dependencies:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb287-1" title="1"><span class="ex">npm</span> init -y</a>
<a class="sourceLine" id="cb287-2" title="2"><span class="ex">npm</span> install express@^4.0.0 pug@^2.0.0</a></code></pre></div>
<p>Then install Nodemon as a development dependency:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb288-1" title="1"><span class="ex">npm</span> install nodemon@^2.0.0 --save-dev</a></code></pre></div>
<h2 id="stubbing-out-the-application">Stubbing out the application</h2>
<p>Now it’s time to stub out the application by writing the minimal amount of code to define the route for the default route (i.e. the "Home" page).</p>
<p>Start with adding a <code>routes</code> module by adding a file named <code>routes.js</code> to the root of your project containing the following code:</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb289-1" title="1"><span class="co">// ./routes.js</span></a>
<a class="sourceLine" id="cb289-2" title="2"></a>
<a class="sourceLine" id="cb289-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb289-4" title="4"></a>
<a class="sourceLine" id="cb289-5" title="5"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb289-6" title="6"></a>
<a class="sourceLine" id="cb289-7" title="7"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb289-8" title="8">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb289-9" title="9"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb289-10" title="10"></a>
<a class="sourceLine" id="cb289-11" title="11"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>The default route renders the <code>index</code> view which you’ll create in just a bit.</p>
<p>Next, add the <code>app</code> module (<code>app.js</code>) to the root of your project containing the following code:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb290-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb290-2" title="2"></a>
<a class="sourceLine" id="cb290-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb290-4" title="4"></a>
<a class="sourceLine" id="cb290-5" title="5"><span class="kw">const</span> routes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb290-6" title="6"></a>
<a class="sourceLine" id="cb290-7" title="7"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb290-8" title="8"></a>
<a class="sourceLine" id="cb290-9" title="9"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb290-10" title="10"></a>
<a class="sourceLine" id="cb290-11" title="11"><span class="va">app</span>.<span class="at">use</span>(routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb290-12" title="12"></a>
<a class="sourceLine" id="cb290-13" title="13"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb290-14" title="14"></a>
<a class="sourceLine" id="cb290-15" title="15"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb290-16" title="16"></a>
<a class="sourceLine" id="cb290-17" title="17"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>To stub out the initial views for the application, add a folder named <code>views</code> to the root of the project. Then add two Pug templates to the <code>views</code> folder—<code>layout.pug</code> and <code>index.pug</code> containing the following code:</p>
<pre class="pug"><code>//- ./views/layout.pug

doctype html
html
  head
    title Reading List - #{title}
  body
    h1 Reading List
    div
      h2 #{title}
      block content</code></pre>
<pre class="pug"><code>//- ./views/index.pug

extends layout.pug

block content
  p Hello from the Reading List app!</code></pre>
<p>The <code>layout.pug</code> template provides the overall HTML for each page in the application while the <code>index.pug</code> template provides the HTML for the index or default page for the application.</p>
<p>All four of these files—<code>routes.js</code>, <code>app.js</code>, <code>layout.pug</code>, and <code>index.pug</code>—will evolve and change as you add features to the Reading List application.</p>
<h3 id="testing-the-initial-application-setup">Testing the initial application setup</h3>
<p>It’s time to test your initial application setup before you make any further changes.</p>
<p>Open the <code>package.json</code> file and replace the placeholder npm <code>test</code> script (that was generated by npm) with the following <code>start</code> script:</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb293-1" title="1"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb293-2" title="2">  <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon app.js&quot;</span></a>
<a class="sourceLine" id="cb293-3" title="3"><span class="fu">}</span></a></code></pre></div>
<p>From the terminal, run the command <code>npm start</code> to start your application, then browse to <code>http://localhost:8080/</code>. You should see the "Home" page displaying the message "Hello from the Reading List app!"</p>
<blockquote>
<p><strong>Now is a good time to commit your changes (if you haven’t already)!</strong> In general, making smaller commits more often where each commit contains a related set of changes is better than waiting until the end of the day to make one giant commit that contains all of the changes for the entire day.</p>
</blockquote>
<h2 id="splitting-the-application-and-server-into-separate-modules">Splitting the application and server into separate modules</h2>
<p>Now that you’ve created a simple, initial version of the application, it’s time to start adding additional features and making general improvements to the overall design of the application.</p>
<p>Up until this point, you’ve created your Express application and started the HTTP server within the same module—the <code>app</code> module. A common practice is to separate the application and server into separate modules. Doing this has the following benefits:</p>
<ul>
<li><strong>Improved separation of concerns:</strong> As much as possible, each module in your application should be responsible for doing one thing and only one thing. Separating out the server setup and startup into its own module improves the overall separation of concerns by allowing the <code>app</code> module to only be responsible for creating the Express application.</li>
<li><strong>Improved testability:</strong> Removing the startup of the HTTP server from the <code>app</code> module improves the testability of the Express application. While you won’t be writing tests for your Express application in this project, establishing good coding practices will set you up to write tests for your application in the future.</li>
</ul>
<h3 id="updating-the-app-module">Updating the <code>app</code> module</h3>
<p>The last two statements in the <code>app</code> module (<code>app.js</code>) are responsible for defining a port and starting the server listening for HTTP connections:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb294-1" title="1"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb294-2" title="2"></a>
<a class="sourceLine" id="cb294-3" title="3"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb294-4" title="4"></a>
<a class="sourceLine" id="cb294-5" title="5"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Go ahead and remove that code. In its place, add this line of code to export the Express application from the module:</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb295-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> app<span class="op">;</span></a></code></pre></div>
<p>For reference, here’s what the complete <code>app</code> module should look like at this point:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb296-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb296-2" title="2"></a>
<a class="sourceLine" id="cb296-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb296-4" title="4"></a>
<a class="sourceLine" id="cb296-5" title="5"><span class="kw">const</span> routes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb296-6" title="6"></a>
<a class="sourceLine" id="cb296-7" title="7"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb296-8" title="8"></a>
<a class="sourceLine" id="cb296-9" title="9"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb296-10" title="10"></a>
<a class="sourceLine" id="cb296-11" title="11"><span class="va">app</span>.<span class="at">use</span>(routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb296-12" title="12"></a>
<a class="sourceLine" id="cb296-13" title="13"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> app<span class="op">;</span></a></code></pre></div>
<h3 id="defining-a-new-entry-point-for-the-application">Defining a new entry point for the application</h3>
<p>As a reminder, the npm <code>start</code> script currently looks like this:</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb297-1" title="1"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb297-2" title="2">  <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon app.js&quot;</span></a>
<a class="sourceLine" id="cb297-3" title="3"><span class="fu">}</span></a></code></pre></div>
<p>Nodemon is being used to start the application and to restart the application when a change is made to any of the files in the project. The <code>app.js</code> file is provided as the entry point for the application—the module that’s responsible for configuring and starting the application.</p>
<p>Now that the <code>app</code> module doesn’t start the server listening for HTTP connections, it can no longer be used as the entry point for the application. To create a new entry point for the application, add a folder named <code>bin</code> to the root of the project. Then add a file named <code>www</code> (with no <code>.js</code> extension) containing the following code. Make sure <code>#!/usr/bin/env node</code> is on the first line of your file:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb298-1" title="1"><span class="co">#!/usr/bin/env node</span></a>
<a class="sourceLine" id="cb298-2" title="2"></a>
<a class="sourceLine" id="cb298-3" title="3"><span class="kw">const</span> app <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../app&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb298-4" title="4"></a>
<a class="sourceLine" id="cb298-5" title="5"><span class="co">// Define a port and start listening for connections.</span></a>
<a class="sourceLine" id="cb298-6" title="6"></a>
<a class="sourceLine" id="cb298-7" title="7"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span></a>
<a class="sourceLine" id="cb298-8" title="8"></a>
<a class="sourceLine" id="cb298-9" title="9"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<p>Then update the npm <code>start</code> script to pass the <code>www</code> file into Nodemon as the entry point:</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb299-1" title="1"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb299-2" title="2">  <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon ./bin/www&quot;</span></a>
<a class="sourceLine" id="cb299-3" title="3"><span class="fu">}</span></a></code></pre></div>
<p>To test your application’s new entry point, run the command <code>npm start</code>, then browse to <code>http://localhost:8080/</code>. As before, you should see the "Home" page displaying the message "Hello from the Reading List app!"</p>
<h3 id="taking-a-closer-look-at-the-.binwww-file">Taking a closer look at the <code>./bin/www</code> file</h3>
<p>The <code>bin</code> folder is a common Unix convention for naming a folder that contains executable scripts. Even though it’s lacking the <code>.js</code> file extension, the <code>www</code> file is actually a JavaScript module that contains the code to start up the Express application.</p>
<p>You might have noticed that the first line of the <code>www</code> file isn’t valid JavaScript:</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb300-1" title="1"><span class="co">#!/usr/bin/env node</span></a></code></pre></div>
<p>This is an instance of a <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">Unix shebang</a>. The shebang has to be written on the first line of the <code>www</code> file. It tells the system what interpreter to pass the file to for execution. In this case, <code>node</code> is specified as the interpreter via the Unix <code>env</code> command.</p>
<p>The intention of the <code>./bin/www</code> file is for it to be an executable script—meaning that you could start the application by simply entering the file name in the terminal as a command:</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb301-1" title="1"><span class="ex">bin/www</span></a></code></pre></div>
<p>If you attempt to execute the script, you’ll receive a "permission denied" error. Text files by default do not have the necessary permissions. You can use the <code>chmod</code> command in the root of your project to add the missing permissions:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb302-1" title="1"><span class="fu">chmod</span> +x bin/www</a></code></pre></div>
<p>With the proper permissions added, you can run the command <code>bin/www</code> to start your application.</p>
<blockquote>
<p><strong>Note:</strong> The ability to run your application via a <code>bin</code> script is primarily useful for Node projects that are intended to be used as command line tools or utilities. The Sequelize CLI is an example of a Node.js command line tool that’s executable via a <code>bin</code> folder script. For Express applications like the Reading List application, it’s far more common to use an npm <code>start</code> script to run the application.</p>
</blockquote>
<h2 id="logging-requests-using-morgan">Logging requests using Morgan</h2>
<p>Currently, after the application starts up and displays the message "Listening on port 8080…", nothing else is written to the console to show activity. To assist with testing and debugging, you can install the <code>morgan</code> npm package, an HTTP request logger middleware for Node.js and Express:</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb303-1" title="1"><span class="ex">npm</span> install morgan</a></code></pre></div>
<p>Aftering installing <code>morgan</code>, import it into the <code>app</code> module:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb304-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb304-2" title="2"></a>
<a class="sourceLine" id="cb304-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb304-4" title="4"><span class="kw">const</span> morgan <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;morgan&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb304-5" title="5"></a>
<a class="sourceLine" id="cb304-6" title="6"><span class="kw">const</span> routes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes&#39;</span>)<span class="op">;</span></a></code></pre></div>
<blockquote>
<p><strong>Code organization tip:</strong> Notice how the external modules are imported first and grouped together followed by the imported internal modules. While this isn’t a hard requirement, it can help make it easier to read a module’s dependencies.</p>
</blockquote>
<p>Then call the <code>app.use()</code> method to add <code>morgan</code> to the application request pipeline:</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb305-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="at">morgan</span>(<span class="st">&#39;dev&#39;</span>))<span class="op">;</span></a></code></pre></div>
<p>The string literal "dev" is passed into <code>morgan</code> to configure the request logging format. The "dev" format is just one of the available predefined formats.</p>
<p>Now if you start your application and browse to <code>http://localhost:8080/</code>, you’ll see the request logged to the console:</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb306-1" title="1"><span class="ex">GET</span> / 200 9.851 ms - 172</a></code></pre></div>
<p>Here’s a breakdown of the above output:</p>
<ul>
<li><code>GET</code> - The request HTTP method</li>
<li><code>/</code> - The request path</li>
<li><code>9.851 ms</code> - The response time in milliseconds</li>
<li><code>172</code> - The <code>Content-Length</code> response header value that indicates the size of the response body in bytes</li>
</ul>
<h2 id="adding-custom-error-handlers">Adding custom error handlers</h2>
<p>As you learned in a previous article, Express provides a default error handler, but for most applications you’ll want to create a custom error handler to precisely control how errors are handled.</p>
<p>In the <code>app</code> module, start with adding a middleware function to catch unmatched requests and throw a "Page Not Found" error:</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb307-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb307-2" title="2"></a>
<a class="sourceLine" id="cb307-3" title="3"><span class="co">// Code remove for brevity.</span></a>
<a class="sourceLine" id="cb307-4" title="4"></a>
<a class="sourceLine" id="cb307-5" title="5"><span class="va">app</span>.<span class="at">use</span>(routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb307-6" title="6"></a>
<a class="sourceLine" id="cb307-7" title="7"><span class="co">// Catch unhandled requests and forward to error handler.</span></a>
<a class="sourceLine" id="cb307-8" title="8"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb307-9" title="9">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;The requested page couldn</span><span class="sc">\&#39;</span><span class="st">t be found.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb307-10" title="10">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb307-11" title="11">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb307-12" title="12"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb307-13" title="13"></a>
<a class="sourceLine" id="cb307-14" title="14"><span class="co">// </span><span class="al">TODO</span><span class="co"> Add custom error handlers.</span></a>
<a class="sourceLine" id="cb307-15" title="15"></a>
<a class="sourceLine" id="cb307-16" title="16"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> app<span class="op">;</span></a></code></pre></div>
<p>Next, add the following custom error handlers—an error handler to log errors, an error handler to handle "Page Not Found" errors, and a generic error handler:</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb308-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb308-2" title="2"></a>
<a class="sourceLine" id="cb308-3" title="3"><span class="co">// Code remove for brevity.</span></a>
<a class="sourceLine" id="cb308-4" title="4"></a>
<a class="sourceLine" id="cb308-5" title="5"><span class="va">app</span>.<span class="at">use</span>(routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-6" title="6"></a>
<a class="sourceLine" id="cb308-7" title="7"><span class="co">// Catch unhandled requests and forward to error handler.</span></a>
<a class="sourceLine" id="cb308-8" title="8"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-9" title="9">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;The requested page couldn</span><span class="sc">\&#39;</span><span class="st">t be found.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-10" title="10">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb308-11" title="11">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-12" title="12"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-13" title="13"></a>
<a class="sourceLine" id="cb308-14" title="14"><span class="co">// Custom error handlers.</span></a>
<a class="sourceLine" id="cb308-15" title="15"></a>
<a class="sourceLine" id="cb308-16" title="16"><span class="co">// Error handler to log errors.</span></a>
<a class="sourceLine" id="cb308-17" title="17"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-18" title="18">  <span class="cf">if</span> (<span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb308-19" title="19">    <span class="co">// </span><span class="al">TODO</span><span class="co"> Log the error to the database.</span></a>
<a class="sourceLine" id="cb308-20" title="20">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-21" title="21">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-22" title="22">  <span class="op">}</span></a>
<a class="sourceLine" id="cb308-23" title="23">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-24" title="24"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-25" title="25"></a>
<a class="sourceLine" id="cb308-26" title="26"><span class="co">// Error handler for 404 errors.</span></a>
<a class="sourceLine" id="cb308-27" title="27"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-28" title="28">  <span class="cf">if</span> (<span class="va">err</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb308-29" title="29">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">404</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-30" title="30">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;page-not-found&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-31" title="31">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Page Not Found&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb308-32" title="32">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-33" title="33">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-34" title="34">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-35" title="35">  <span class="op">}</span></a>
<a class="sourceLine" id="cb308-36" title="36"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-37" title="37"></a>
<a class="sourceLine" id="cb308-38" title="38"><span class="co">// Generic error handler.</span></a>
<a class="sourceLine" id="cb308-39" title="39"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-40" title="40">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-41" title="41">  <span class="kw">const</span> isProduction <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb308-42" title="42">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb308-43" title="43">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Server Error&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb308-44" title="44">    <span class="dt">message</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb308-45" title="45">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb308-46" title="46">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-47" title="47"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb308-48" title="48"></a>
<a class="sourceLine" id="cb308-49" title="49"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> app<span class="op">;</span></a></code></pre></div>
<p>To complete your custom error handlers, add two views to the <code>views</code> folder—<code>error.pug</code> and <code>page-not-found.pug</code>:</p>
<pre class="pug"><code>//- error.pug

extends layout.pug

block content
 div
   p= message || &#39;An unexpected error occurred on the server.&#39;
 if stack
   h3 Stack Trace
   pre= stack</code></pre>
<pre class="pug"><code>//- page-not-found.pug

extends layout.pug

block content
 div
   p Sorry, we couldn&#39;t find the page that you requested.</code></pre>
<h3 id="testing-your-custom-error-handlers">Testing your custom error handlers</h3>
<p>To test your custom error handlers, update the default route (<code>/</code>) in the <code>routes</code> module to temporarily throw an error:</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb311-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb311-2" title="2">  <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;This is a test error!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb311-3" title="3">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb311-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Start your application and browse to <code>http://localhost:8080/</code> and you should see the "Server Error" page. Next, browse to an unknown path like <code>http://localhost:8080/asdf</code> and you should see the "Page Not Found" page.</p>
<p>You should also see the errors logged to the terminal:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb312-1" title="1"><span class="ex">Error</span>: This is a test error!</a>
<a class="sourceLine" id="cb312-2" title="2">    <span class="ex">at</span> [path to the project folder]/routes.js:7:9</a>
<a class="sourceLine" id="cb312-3" title="3">    <span class="ex">at</span> Layer.handle [as handle_request] ([path to the project folder]/node_modules/express/lib/router/layer.js:95:5)</a>
<a class="sourceLine" id="cb312-4" title="4">    <span class="ex">at</span> next ([path to the project folder]/node_modules/express/lib/router/route.js:137:13)</a>
<a class="sourceLine" id="cb312-5" title="5">    <span class="ex">at</span> Route.dispatch ([path to the project folder]/node_modules/express/lib/router/route.js:112:3)</a>
<a class="sourceLine" id="cb312-6" title="6">    <span class="ex">at</span> Layer.handle [as handle_request] ([path to the project folder]/node_modules/express/lib/router/layer.js:95:5)</a>
<a class="sourceLine" id="cb312-7" title="7">    <span class="ex">at</span> [path to the project folder]/node_modules/express/lib/router/index.js:281:22</a>
<a class="sourceLine" id="cb312-8" title="8">    <span class="ex">at</span> Function.process_params ([path to the project folder]/node_modules/express/lib/router/index.js:335:12)</a>
<a class="sourceLine" id="cb312-9" title="9">    <span class="ex">at</span> next ([path to the project folder]/node_modules/express/lib/router/index.js:275:10)</a>
<a class="sourceLine" id="cb312-10" title="10">    <span class="ex">at</span> Function.handle ([path to the project folder]/node_modules/express/lib/router/index.js:174:3)</a>
<a class="sourceLine" id="cb312-11" title="11">    <span class="ex">at</span> router ([path to the project folder]/node_modules/express/lib/router/index.js:47:12)</a>
<a class="sourceLine" id="cb312-12" title="12"><span class="ex">GET</span> / 500 452.308 ms - 2070</a></code></pre></div>
<div class="sourceCode" id="cb313"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb313-1" title="1"><span class="ex">Error</span>: The requested page couldn<span class="st">&#39;t be found.</span></a>
<a class="sourceLine" id="cb313-2" title="2"><span class="st">    at [path to the project folder]/app.js:16:15</span></a>
<a class="sourceLine" id="cb313-3" title="3"><span class="st">    at Layer.handle [as handle_request] ([path to the project folder]/node_modules/express/lib/router/layer.js:95:5)</span></a>
<a class="sourceLine" id="cb313-4" title="4"><span class="st">    at trim_prefix ([path to the project folder]/node_modules/express/lib/router/index.js:317:13)</span></a>
<a class="sourceLine" id="cb313-5" title="5"><span class="st">    at [path to the project folder]/node_modules/express/lib/router/index.js:284:7</span></a>
<a class="sourceLine" id="cb313-6" title="6"><span class="st">    at Function.process_params ([path to the project folder]/node_modules/express/lib/router/index.js:335:12)</span></a>
<a class="sourceLine" id="cb313-7" title="7"><span class="st">    at next ([path to the project folder]/node_modules/express/lib/router/index.js:275:10)</span></a>
<a class="sourceLine" id="cb313-8" title="8"><span class="st">    at [path to the project folder]/node_modules/express/lib/router/index.js:635:15</span></a>
<a class="sourceLine" id="cb313-9" title="9"><span class="st">    at next ([path to the project folder]/node_modules/express/lib/router/index.js:260:14)</span></a>
<a class="sourceLine" id="cb313-10" title="10"><span class="st">    at Function.handle ([path to the project folder]/node_modules/express/lib/router/index.js:174:3)</span></a>
<a class="sourceLine" id="cb313-11" title="11"><span class="st">    at router ([path to the project folder]/node_modules/express/lib/router/index.js:47:12) {</span></a>
<a class="sourceLine" id="cb313-12" title="12"><span class="st">  status: 404</span></a>
<a class="sourceLine" id="cb313-13" title="13"><span class="st">}</span></a>
<a class="sourceLine" id="cb313-14" title="14"><span class="st">GET /asdf 404 15.648 ms - 223</span></a></code></pre></div>
<p>Also notice that thanks to the request logging provided by the <code>morgan</code> middleware, you can see the <code>500</code> (Internal Server Error) and <code>404</code> (Not Found) HTTP response status codes returned by the server.</p>
<p>After confirming that your custom error handlers work as expected, be sure to remove the code that you temporarily added to your default route!</p>
<blockquote>
<p>For a refresher on the custom error handlers, see the "Catching and Handling Errors in Express" article.</p>
</blockquote>
<h2 id="configuring-environment-variables">Configuring environment variables</h2>
<p>Since the Reading List application will use a database for data persistence, your project needs to include a way to configure the database connection settings across environments. To do that, let’s use environment variables to configure the application.</p>
<blockquote>
<p>For a refresher on how to use environment variables within an Express application, see the "Acclimating to Environment Variables" article.</p>
</blockquote>
<p>To start, install <code>per-env</code> as a project dependency the <code>dotenv</code> and <code>dotenv-cli</code> as development dependencies (i.e. dependencies that are only needed in development environments):</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb314-1" title="1"><span class="ex">npm</span> install per-env</a>
<a class="sourceLine" id="cb314-2" title="2"><span class="ex">npm</span> install dotenv dotenv-cli --save-dev</a></code></pre></div>
<p>As a reminder, the <code>per-env</code> package allows you to define npm scripts for each of your application’s environments. The <code>dotenv</code> package is used to load environment variables from an <code>.env</code> file and the <code>dotenv-cli</code> package acts as an intermediary between npx and tools or utilities (like the Sequelize CLI) to load your environment variables from an <code>.env</code> file and run the command that you pass into it.</p>
<h3 id="adding-the-.env-and-.env.example-files">Adding the <code>.env</code> and <code>.env.example</code> files</h3>
<p>Next, add two files to the root of your project—<code>.env</code> and <code>.env.example</code> with the following content:</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode txt"><code class="sourceCode default"><a class="sourceLine" id="cb315-1" title="1">PORT=8080</a></code></pre></div>
<p>The <code>.env</code> file is where you define the environment variables to configure your application. At this point in the project, you just need to define the <code>PORT</code> environment variable. The <code>.env</code> file shouldn’t be committed to source control as the environment variables it defines are specific to your development environment. Additionally, it might contain sensitive information.</p>
<blockquote>
<p>To ensure that the <code>.env</code> file isn’t committed to source control, add <code>.env</code> as an entry to your project’s <code>.gitignore</code> file. If you’re using GitHub’s <code>.gitignore</code> file for Node.js projects, this has already been done for you.</p>
</blockquote>
<p>Because the <code>.env</code> file isn’t committed to source control, the <code>.env.example</code> file serves as documentation for your teammates so they can create their own <code>.env</code> files.</p>
<h3 id="adding-the-config-module">Adding the <code>config</code> module</h3>
<p>Let’s encapsulate all of the <code>process.env</code> property access into a single <code>config</code> module by importing all of the application’s environment variables and exporting them to make them available to the rest of the application.</p>
<p>Add a folder named <code>config</code> to the root of the project. Then add a file named <code>index.js</code> to the <code>config</code> folder containing the following code:</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb316-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb316-2" title="2">  <span class="dt">environment</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">||</span> <span class="st">&#39;development&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb316-3" title="3">  <span class="dt">port</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">,</span></a>
<a class="sourceLine" id="cb316-4" title="4"><span class="op">};</span></a></code></pre></div>
<p>Now you can update the <code>./bin/www</code> file to get the port from the <code>config</code> module:</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb317-1" title="1"><span class="co">#!/usr/bin/env node</span></a>
<a class="sourceLine" id="cb317-2" title="2"></a>
<a class="sourceLine" id="cb317-3" title="3"><span class="kw">const</span> <span class="op">{</span> port <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../config&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb317-4" title="4"></a>
<a class="sourceLine" id="cb317-5" title="5"><span class="kw">const</span> app <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../app&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb317-6" title="6"></a>
<a class="sourceLine" id="cb317-7" title="7"><span class="co">// Start listening for connections.</span></a>
<a class="sourceLine" id="cb317-8" title="8"></a>
<a class="sourceLine" id="cb317-9" title="9"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<h3 id="updating-the-npm-start-script">Updating the npm <code>start</code> script</h3>
<p>To load the environment variables from the <code>.env</code> file in the local development environment while ignoring the <code>.env</code> file in the production environment, update the <code>package.json</code> file <code>scripts</code> section:</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb318-1" title="1"><span class="er">&quot;scripts&quot;:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb318-2" title="2">  <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;per-env&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb318-3" title="3">  <span class="dt">&quot;start:development&quot;</span><span class="fu">:</span> <span class="st">&quot;nodemon -r dotenv/config ./bin/www&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb318-4" title="4">  <span class="dt">&quot;start:production&quot;</span><span class="fu">:</span> <span class="st">&quot;node ./bin/www&quot;</span></a>
<a class="sourceLine" id="cb318-5" title="5"><span class="fu">}</span></a></code></pre></div>
<p>To review, if the <code>NODE_ENV</code> environment variable is set to <code>production</code>, then running the <code>start</code> script will result in the execution of the <code>start:production</code> script. If the <code>NODE_ENV</code> variable isn’t defined (or set to <code>development</code>), then the <code>start:development</code> script will be executed by default.</p>
<p>At this point, running the command <code>npm start</code> should start your application just like it before.</p>
<h3 id="supporting-debugging-in-visual-studio-code">Supporting debugging in Visual Studio Code</h3>
<p>To use the debugger in Visual Studio Code, configure it to load your environment variables from your <code>.env</code> file. Open the <code>launch.json</code> file located in the <code>.vscode</code> folder and add the <code>envFile</code> property to your Node configuration:</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb319-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb319-2" title="2"> <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.2.0&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb319-3" title="3"> <span class="dt">&quot;configurations&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb319-4" title="4">   <span class="fu">{</span></a>
<a class="sourceLine" id="cb319-5" title="5">     <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;node&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb319-6" title="6">     <span class="dt">&quot;request&quot;</span><span class="fu">:</span> <span class="st">&quot;launch&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb319-7" title="7">     <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Launch Program&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb319-8" title="8">     <span class="dt">&quot;skipFiles&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb319-9" title="9">       <span class="st">&quot;&lt;node_internals&gt;/**&quot;</span></a>
<a class="sourceLine" id="cb319-10" title="10">     <span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb319-11" title="11">     <span class="dt">&quot;program&quot;</span><span class="fu">:</span> <span class="st">&quot;${workspaceFolder}/bin/www&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb319-12" title="12">     <span class="dt">&quot;envFile&quot;</span><span class="fu">:</span> <span class="st">&quot;${workspaceFolder}/.env&quot;</span></a>
<a class="sourceLine" id="cb319-13" title="13">   <span class="fu">}</span></a>
<a class="sourceLine" id="cb319-14" title="14"> <span class="ot">]</span></a>
<a class="sourceLine" id="cb319-15" title="15"><span class="fu">}</span></a></code></pre></div>
<blockquote>
<p><strong>Note:</strong> If you don’t have <code>.vscode/launch.json</code> file in your project, see <a href="https://code.visualstudio.com/docs/editor/debugging#_launch-configurations">this page</a> in the Visual Studio Code documentation for instructions on how to set up debugging.</p>
</blockquote>
<h2 id="setting-up-bootstrap">Setting up Bootstrap</h2>
<p>One last bit of project set up work before installing and configuring Sequelize! Update the <code>views/layout.pug</code> view with the following Bootstrap template markup:</p>
<pre class="pug"><code>doctype html
html
  head
    meta(charset=&#39;utf-8&#39;)
    meta(name=&#39;viewport&#39; content=&#39;width=device-width, initial-scale=1, shrink-to-fit=no&#39;)
    link(rel=&#39;stylesheet&#39; href=&#39;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css&#39; integrity=&#39;sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh&#39; crossorigin=&#39;anonymous&#39;)
    title Reading List - #{title}
  body
    nav(class=&#39;navbar navbar-expand-lg navbar-dark bg-primary&#39;)
      a(class=&#39;navbar-brand&#39; href=&#39;/&#39;) Reading List
    .container
      h2(class=&#39;py-4&#39;) #{title}
      block content
    script(src=&#39;https://code.jquery.com/jquery-3.4.1.slim.min.js&#39; integrity=&#39;sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n&#39; crossorigin=&#39;anonymous&#39;) script(src=&#39;https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js&#39; integrity=&#39;sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo&#39; crossorigin=&#39;anonymous&#39;) script(src=&#39;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js&#39; integrity=&#39;sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6&#39; crossorigin=&#39;anonymous&#39;)</code></pre>
<p>Adding support for the Bootstrap front-end component library will give the Reading List application a nice, polished look. The above markup was taken directly from <a href="https://getbootstrap.com/docs/4.4/getting-started/introduction/#starter-template">the starter template published in the official Bootstrap documentation</a>.</p>
<blockquote>
<p>Adding Bootstrap won’t change the look of the application much at this point. Later on, once you start adding forms to the application, it’ll be easier to notice the benefits of using a library like Bootstrap.</p>
</blockquote>
<h2 id="what-you-learned-10">What you learned</h2>
<p>In this article, you learned how to:</p>
<ul>
<li>Split the Express application and HTTP server into separate modules;</li>
<li>Use the <code>morgan</code> npm package to log requests; and</li>
<li>Add support for the Bootstrap front-end component library to your application’s Pug layout template.</li>
</ul>
<p>You also reviewed the following:</p>
<ul>
<li>Setting up a new Express project;</li>
<li>Stubbing out an Express application;</li>
<li>Adding custom error handlers to an Express application; and</li>
<li>Configuring environment variables.</li>
</ul>
<p>Next up: integrating Sequelize with an Express application!</p>
<hr />
<h1 id="data-driven-websites-project-part-2-integrating-sequelize-with-express">Data-Driven Websites Project (Part 2: Integrating Sequelize with Express)</h1>
<p>Welcome to part two of creating the data-driven Reading List website!</p>
<p>Over the course of three articles, you’ll create a data-driven Reading List website that will allow you to view a list of books, add a book to the list, update a book in the list, and delete a book from the list. In the first article, you created the project. In this article, you’ll learn how to integrate Sequelize with an Express application. In the last article, you’ll create the routes and views to perform CRUD (create, read, update, and delete) operations using Sequelize.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Install and configure Sequelize within an Express application; and</li>
<li>Use Sequelize to test the connection to a database before starting the HTTP server on application startup.</li>
</ul>
<p>You’ll also review the following:</p>
<ul>
<li>Using the Sequelize CLI to create a model and migration;</li>
<li>Using the Sequelize CLI to seed the database; and</li>
<li>Using Sequelize to query data from the database.</li>
</ul>
<h2 id="installing-and-configuring-sequelize">Installing and configuring Sequelize</h2>
<p>First things first, you need to install and configure Sequelize!</p>
<p>Use npm to install the following dependencies:</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb321-1" title="1"><span class="ex">npm</span> install sequelize@^5.0.0 pg@^8.0.0</a></code></pre></div>
<p>Then install the Sequelize CLI as a development dependency:</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb322-1" title="1"><span class="ex">npm</span> install sequelize-cli@^5.0.0 --save-dev</a></code></pre></div>
<h3 id="configuring-the-sequelize-cli">Configuring the Sequelize CLI</h3>
<p>Before using the Sequelize CLI to initialize Sequelize within your project, add a file named <code>.sequelizerc</code> to the root of your project containing the following code:</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb323-1" title="1"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;path&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb323-2" title="2"></a>
<a class="sourceLine" id="cb323-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb323-4" title="4">  <span class="st">&#39;config&#39;</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;config&#39;</span><span class="op">,</span> <span class="st">&#39;database.js&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb323-5" title="5">  <span class="st">&#39;models-path&#39;</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;db&#39;</span><span class="op">,</span> <span class="st">&#39;models&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb323-6" title="6">  <span class="st">&#39;seeders-path&#39;</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;db&#39;</span><span class="op">,</span> <span class="st">&#39;seeders&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb323-7" title="7">  <span class="st">&#39;migrations-path&#39;</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;db&#39;</span><span class="op">,</span> <span class="st">&#39;migrations&#39;</span>)</a>
<a class="sourceLine" id="cb323-8" title="8"><span class="op">};</span></a></code></pre></div>
<p>The <code>.sequelizerc</code> file configures the Sequelize CLI so that it knows:</p>
<ul>
<li>Where your database configuration is located; and</li>
<li>Where to generate the <code>models</code>, <code>seeders</code>, and <code>migrations</code> folders.</li>
</ul>
<h3 id="initializing-sequelize">Initializing Sequelize</h3>
<p>Now you’re ready to initialize Sequelize by running the following command:</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb324-1" title="1"><span class="ex">npx</span> sequelize init</a></code></pre></div>
<p>When the command completes, your project should now contain the following:</p>
<ul>
<li>The <code>config/database.js</code> file;</li>
<li>The <code>db/migrations</code>, <code>db/models</code>, and <code>db/seeders</code> folders; and</li>
<li>The <code>db/models/index.js</code> file.</li>
</ul>
<h3 id="creating-a-new-database-and-database-user">Creating a new database and database user</h3>
<p>To prepare for configuring Sequelize, you need to create a new database for the Reading List application to use and a new normal or limited user (i.e. a user without superuser privileges) that has permissions to access the new database.</p>
<p>Open psql by running the command <code>psql</code> (to use the currently logged in user) or <code>psql -U «super user username»</code> to specify the username of the super user to use. Then execute the following SQL statements:</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb325-1" title="1"><span class="kw">create</span> <span class="kw">database</span> reading_list;</a>
<a class="sourceLine" id="cb325-2" title="2"><span class="kw">create</span> <span class="fu">user</span> reading_list_app <span class="kw">with</span> encrypted <span class="kw">password</span> <span class="st">&#39;«a strong password for the reading_list_app user»&#39;</span>;</a>
<a class="sourceLine" id="cb325-3" title="3"><span class="kw">grant</span> <span class="kw">all</span> <span class="kw">privileges</span> <span class="kw">on</span> <span class="kw">database</span> reading_list <span class="kw">to</span> reading_list_app;</a></code></pre></div>
<p>Make note of the password that you use as you’ll need them for the next step in the configuration process!</p>
<blockquote>
<p>To review how to create a new PostgreSQL database and user, see the "Database Management Walk-Through" and "User Management Walk-Through" readings in the SQL lesson.</p>
</blockquote>
<h3 id="adding-the-database-environment-variables">Adding the database environment variables</h3>
<p>Now you’re ready to add the <code>DB_USERNAME</code>, <code>DB_PASSWORD</code>, <code>DB_DATABASE</code>, and <code>DB_HOST</code> environment variables to the <code>.env</code> and <code>.env.example</code> files:</p>
<pre><code>PORT=8080
DB_USERNAME=reading_list_app
DB_PASSWORD=«the reading_list_app user password»
DB_DATABASE=reading_list
DB_HOST=localhost</code></pre>
<p>Next, update the <code>config</code> module (the <code>config/index.js</code> file) with the following code:</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb327-1" title="1"><span class="co">// ./config/index.js</span></a>
<a class="sourceLine" id="cb327-2" title="2"></a>
<a class="sourceLine" id="cb327-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb327-4" title="4">  <span class="dt">environment</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">||</span> <span class="st">&#39;development&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb327-5" title="5">  <span class="dt">port</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">,</span></a>
<a class="sourceLine" id="cb327-6" title="6">  <span class="dt">db</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb327-7" title="7">    <span class="dt">username</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_USERNAME</span><span class="op">,</span></a>
<a class="sourceLine" id="cb327-8" title="8">    <span class="dt">password</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_PASSWORD</span><span class="op">,</span></a>
<a class="sourceLine" id="cb327-9" title="9">    <span class="dt">database</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_DATABASE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb327-10" title="10">    <span class="dt">host</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_HOST</span><span class="op">,</span></a>
<a class="sourceLine" id="cb327-11" title="11">  <span class="op">},</span></a>
<a class="sourceLine" id="cb327-12" title="12"><span class="op">};</span></a></code></pre></div>
<p>Remember that the <code>config</code> module is responsible for providing access to your application’s environment variables. Any part of the application that needs access to the <code>DB_USERNAME</code>, <code>DB_PASSWORD</code>, <code>DB_DATABASE</code>, and <code>DB_HOST</code> environment variables can use the <code>username</code>, <code>password</code>, <code>database</code>, and <code>host</code> properties on the <code>config</code> module’s <code>db</code> object.</p>
<h3 id="configuring-the-sequelize-database-connection">Configuring the Sequelize database connection</h3>
<p>Now you’re ready to configure the database connection for Sequelize! Update the <code>config/database.js</code> file with the following code:</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb328-1" title="1"><span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb328-2" title="2">  username<span class="op">,</span></a>
<a class="sourceLine" id="cb328-3" title="3">  password<span class="op">,</span></a>
<a class="sourceLine" id="cb328-4" title="4">  database<span class="op">,</span></a>
<a class="sourceLine" id="cb328-5" title="5">  host<span class="op">,</span></a>
<a class="sourceLine" id="cb328-6" title="6"><span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./index&#39;</span>).<span class="at">db</span><span class="op">;</span></a>
<a class="sourceLine" id="cb328-7" title="7"></a>
<a class="sourceLine" id="cb328-8" title="8"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb328-9" title="9">  <span class="dt">development</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb328-10" title="10">    username<span class="op">,</span></a>
<a class="sourceLine" id="cb328-11" title="11">    password<span class="op">,</span></a>
<a class="sourceLine" id="cb328-12" title="12">    database<span class="op">,</span></a>
<a class="sourceLine" id="cb328-13" title="13">    host<span class="op">,</span></a>
<a class="sourceLine" id="cb328-14" title="14">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&#39;postgres&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb328-15" title="15">  <span class="op">},</span></a>
<a class="sourceLine" id="cb328-16" title="16"><span class="op">};</span></a></code></pre></div>
<p>The first statement uses the <code>require()</code> function to import the <code>config/index</code> module. Destructuring is used to declare the <code>username</code>, <code>password</code>, <code>database</code>, and <code>host</code> variables and initialize them to the values of the corresponding property names on the <code>config</code> module’s <code>db</code> property.</p>
<p>You could remove the destructuring by refactoring the above statement into the following statements:</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb329-1" title="1"><span class="kw">const</span> config <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./index&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb329-2" title="2"></a>
<a class="sourceLine" id="cb329-3" title="3"><span class="kw">const</span> db <span class="op">=</span> <span class="va">config</span>.<span class="at">db</span><span class="op">;</span></a>
<a class="sourceLine" id="cb329-4" title="4"><span class="kw">const</span> username <span class="op">=</span> <span class="va">db</span>.<span class="at">username</span><span class="op">;</span></a>
<a class="sourceLine" id="cb329-5" title="5"><span class="kw">const</span> password <span class="op">=</span> <span class="va">db</span>.<span class="at">password</span><span class="op">;</span></a>
<a class="sourceLine" id="cb329-6" title="6"><span class="kw">const</span> database <span class="op">=</span> <span class="va">db</span>.<span class="at">database</span><span class="op">;</span></a>
<a class="sourceLine" id="cb329-7" title="7"><span class="kw">const</span> host <span class="op">=</span> <span class="va">db</span>.<span class="at">host</span><span class="op">;</span></a></code></pre></div>
<p>The <code>config/database</code> module then exports an object with a property named <code>development</code> set to an object literal with <code>username</code>, <code>password</code>, <code>database</code>, <code>host</code>, and <code>dialect</code> properties:</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb330-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb330-2" title="2">  <span class="dt">development</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb330-3" title="3">    username<span class="op">,</span></a>
<a class="sourceLine" id="cb330-4" title="4">    password<span class="op">,</span></a>
<a class="sourceLine" id="cb330-5" title="5">    database<span class="op">,</span></a>
<a class="sourceLine" id="cb330-6" title="6">    host<span class="op">,</span></a>
<a class="sourceLine" id="cb330-7" title="7">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&#39;postgres&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb330-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb330-9" title="9"><span class="op">};</span></a></code></pre></div>
<p>The <code>development</code> property name indicates that these configuration settings are for the <code>development</code> environment. The <code>username</code>, <code>password</code>, <code>database</code>, <code>host</code>, and <code>dialect</code> property names are the Sequelize options used to configure the database connection.</p>
<blockquote>
<p>For a complete list of the available Sequelize options, see <a href="https://sequelize.org/master/class/lib/sequelize.js~Sequelize.html#instance-constructor-constructor">the official Sequelize API documentation</a>.</p>
</blockquote>
<h2 id="testing-the-connection-to-the-database">Testing the connection to the database</h2>
<p>You’ve configured Sequelize—specifically the database connection—but how do you know if Sequelize can actually connect to the database? The Sequelize instance method <code>authenticate()</code> can be used to test the connection to the database by attempting to execute the query <code>SELECT 1+1 AS result</code> against the database specified in the <code>config/database</code> module.</p>
<p>The Reading List application is a data-driven website, so it’ll be heavily dependent on its database. Given that, it’s best to test the connection to the database as early as possible. You can do that by updating the <code>./bin/www</code> file to test the connection to the database before starting the application listening for HTTP connections.</p>
<p>Update the <code>./bin/www</code> file with the following code:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb331-1" title="1"><span class="co">#!/usr/bin/env node</span></a>
<a class="sourceLine" id="cb331-2" title="2"></a>
<a class="sourceLine" id="cb331-3" title="3"><span class="kw">const</span> <span class="op">{</span> port <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../config&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb331-4" title="4"></a>
<a class="sourceLine" id="cb331-5" title="5"><span class="kw">const</span> app <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../app&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb331-6" title="6"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb331-7" title="7"></a>
<a class="sourceLine" id="cb331-8" title="8"><span class="co">// Check the database connection before starting the app.</span></a>
<a class="sourceLine" id="cb331-9" title="9"><span class="va">db</span>.<span class="va">sequelize</span>.<span class="at">authenticate</span>()</a>
<a class="sourceLine" id="cb331-10" title="10">  .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb331-11" title="11">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Database connection success! Sequelize is ready to use...&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb331-12" title="12"></a>
<a class="sourceLine" id="cb331-13" title="13">    <span class="co">// Start listening for connections.</span></a>
<a class="sourceLine" id="cb331-14" title="14">    <span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb331-15" title="15">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb331-16" title="16">  .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb331-17" title="17">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Database connection failure.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb331-18" title="18">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb331-19" title="19">  <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>In addition to importing the <code>app</code> module, the <code>require()</code> function is called to import the <code>./db/models</code> module—a module that was generated by the Sequelize CLI when you initialized your project to use Sequelize.</p>
<p>The <code>./db/models</code> module provides access to the Sequelize instance via the <code>sequelize</code> property. The <code>authenticate()</code> method is called on the Sequelize instance. The <code>authenticate()</code> method is asynchronous, so it returns a Promise that will resolve if the connection to the database is successful, otherwise it will be rejected:</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb332-1" title="1"><span class="co">// Check the database connection before starting the app.</span></a>
<a class="sourceLine" id="cb332-2" title="2"><span class="va">db</span>.<span class="va">sequelize</span>.<span class="at">authenticate</span>()</a>
<a class="sourceLine" id="cb332-3" title="3">  .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb332-4" title="4">    <span class="co">// The connection to the database succeeded.</span></a>
<a class="sourceLine" id="cb332-5" title="5">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb332-6" title="6">  .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb332-7" title="7">    <span class="co">// The connection to the database failed.</span></a>
<a class="sourceLine" id="cb332-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Inside of the <code>then()</code> method callback, a message is logged to the console and the application is started listening for HTTP connections. Inside of the <code>catch()</code> method callback, an error message and the <code>err</code> object are logged to the console:</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb333-1" title="1"><span class="co">// Check the database connection before starting the app.</span></a>
<a class="sourceLine" id="cb333-2" title="2"><span class="va">db</span>.<span class="va">sequelize</span>.<span class="at">authenticate</span>()</a>
<a class="sourceLine" id="cb333-3" title="3">  .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb333-4" title="4">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Database connection success! Sequelize is ready to use...&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb333-5" title="5"></a>
<a class="sourceLine" id="cb333-6" title="6">    <span class="co">// Start listening for connections.</span></a>
<a class="sourceLine" id="cb333-7" title="7">    <span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb333-8" title="8">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb333-9" title="9">  .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb333-10" title="10">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Database connection failure.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb333-11" title="11">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb333-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>To test the connection to the database, run the command <code>npm start</code> in the terminal to start your application. In the console, you should see the success message if the database connection succeeded, otherwise you’ll see the error message.</p>
<h2 id="creating-the-book-model">Creating the Book model</h2>
<p>Now that you’ve confirmed that the application can successfully connect to the database, it’s time to create the application’s first model.</p>
<p>As a reminder, the Reading List website—when it’s completed—will allow you to view a list of books, add a book to the list, update a book in the list, and delete a book from the list. At the heart of all of these features are books, so let’s use the Sequelize CLI to generate a <code>Book</code> model.</p>
<p>The <code>Book</code> model should include the following properties:</p>
<ul>
<li><code>title</code> - A string representing the title;</li>
<li><code>author</code> - A string representing the the author;</li>
<li><code>releaseDate</code> - A date representing the release date;</li>
<li><code>pageCount</code> - An integer representing the page count; and</li>
<li><code>publisher</code> - A string representing the publisher.</li>
</ul>
<p>From the terminal, run the following command to use the Sequelize CLI to generate the <code>Book</code> model:</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb334-1" title="1"><span class="ex">npx</span> sequelize model:generate --name Book --attributes <span class="st">&quot;title:string, author:string, releaseDate:dateonly, pageCount:integer, publisher:string&quot;</span></a></code></pre></div>
<p>If the command succeeds, you’ll see the following output in the console:</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb335-1" title="1"><span class="ex">New</span> model was created at [path to the project folder]/db/models/book.js .</a>
<a class="sourceLine" id="cb335-2" title="2"><span class="ex">New</span> migration was created at [path to the project folder]/db/migrations/[timestamp]-Book.js .</a></code></pre></div>
<p>This confirms that two files were generated: a file for the <code>Book</code> model and a file for a database migration to add the <code>Books</code> table to the database.</p>
<h3 id="updating-the-generated-book-model-and-migration-files">Updating the generated <code>Book</code> model and migration files</h3>
<p>The <code>Book</code> model and migration files generated by the Sequelize CLI are close to what is needed, but some changes are required. Two things in particular need to be addressed: column string lengths and column nullability (i.e. the ability for a column to accept <code>null</code> values).</p>
<p>For your reference, here are the generated model and migration files:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb336-1" title="1"><span class="co">// ./db/models/book.js</span></a>
<a class="sourceLine" id="cb336-2" title="2"></a>
<a class="sourceLine" id="cb336-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb336-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb336-5" title="5">  <span class="kw">const</span> Book <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Book&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb336-6" title="6">    <span class="dt">title</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb336-7" title="7">    <span class="dt">author</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb336-8" title="8">    <span class="dt">releaseDate</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">DATEONLY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb336-9" title="9">    <span class="dt">pageCount</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb336-10" title="10">    <span class="dt">publisher</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb336-11" title="11">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb336-12" title="12">  <span class="va">Book</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb336-13" title="13">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb336-14" title="14">  <span class="op">};</span></a>
<a class="sourceLine" id="cb336-15" title="15">  <span class="cf">return</span> Book<span class="op">;</span></a>
<a class="sourceLine" id="cb336-16" title="16"><span class="op">};</span></a></code></pre></div>
<div class="sourceCode" id="cb337"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb337-1" title="1"><span class="co">// ./db/migrations/[timestamp]-create-book.js</span></a>
<a class="sourceLine" id="cb337-2" title="2"></a>
<a class="sourceLine" id="cb337-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb337-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-5" title="5">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-6" title="6">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Books&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-7" title="7">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-8" title="8">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb337-9" title="9">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb337-10" title="10">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb337-11" title="11">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb337-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb337-13" title="13">      <span class="dt">title</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-14" title="14">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb337-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb337-16" title="16">      <span class="dt">author</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-17" title="17">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb337-18" title="18">      <span class="op">},</span></a>
<a class="sourceLine" id="cb337-19" title="19">      <span class="dt">releaseDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-20" title="20">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATEONLY</span></a>
<a class="sourceLine" id="cb337-21" title="21">      <span class="op">},</span></a>
<a class="sourceLine" id="cb337-22" title="22">      <span class="dt">pageCount</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-23" title="23">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb337-24" title="24">      <span class="op">},</span></a>
<a class="sourceLine" id="cb337-25" title="25">      <span class="dt">publisher</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-26" title="26">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb337-27" title="27">      <span class="op">},</span></a>
<a class="sourceLine" id="cb337-28" title="28">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-29" title="29">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb337-30" title="30">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb337-31" title="31">      <span class="op">},</span></a>
<a class="sourceLine" id="cb337-32" title="32">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-33" title="33">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb337-34" title="34">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb337-35" title="35">      <span class="op">}</span></a>
<a class="sourceLine" id="cb337-36" title="36">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb337-37" title="37">  <span class="op">},</span></a>
<a class="sourceLine" id="cb337-38" title="38">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb337-39" title="39">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Books&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb337-40" title="40">  <span class="op">}</span></a>
<a class="sourceLine" id="cb337-41" title="41"><span class="op">};</span></a></code></pre></div>
<p>As it is, the generated migration file would create the following <code>Books</code> table in the database:</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb338-1" title="1"><span class="va">reading_list=</span># \<span class="ex">d</span> <span class="st">&quot;Books&quot;</span></a>
<a class="sourceLine" id="cb338-2" title="2">                                        <span class="ex">Table</span> <span class="st">&quot;public.Books&quot;</span></a>
<a class="sourceLine" id="cb338-3" title="3">   <span class="ex">Column</span>    <span class="kw">|</span>           <span class="ex">Type</span>           <span class="kw">|</span> <span class="ex">Collation</span> <span class="kw">|</span> <span class="ex">Nullable</span> <span class="kw">|</span>               <span class="ex">Default</span></a>
<a class="sourceLine" id="cb338-4" title="4"><span class="ex">-------------+--------------------------+-----------+----------+-------------------------------------</span></a>
<a class="sourceLine" id="cb338-5" title="5"> <span class="fu">id</span>          <span class="kw">|</span> <span class="ex">integer</span>                  <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span> <span class="ex">nextval</span>(<span class="st">&#39;&quot;Books_id_seq&quot;&#39;</span>::regclass)</a>
<a class="sourceLine" id="cb338-6" title="6"> <span class="ex">title</span>       <span class="kw">|</span> <span class="ex">character</span> varying(255)   <span class="kw">|</span>           <span class="kw">|</span>          <span class="kw">|</span></a>
<a class="sourceLine" id="cb338-7" title="7"> <span class="ex">author</span>      <span class="kw">|</span> <span class="ex">character</span> varying(255)   <span class="kw">|</span>           <span class="kw">|</span>          <span class="kw">|</span></a>
<a class="sourceLine" id="cb338-8" title="8"> <span class="ex">releaseDate</span> <span class="kw">|</span> <span class="fu">date</span>                     <span class="kw">|</span>           <span class="kw">|</span>          <span class="kw">|</span></a>
<a class="sourceLine" id="cb338-9" title="9"> <span class="ex">pageCount</span>   <span class="kw">|</span> <span class="ex">integer</span>                  <span class="kw">|</span>           <span class="kw">|</span>          <span class="kw">|</span></a>
<a class="sourceLine" id="cb338-10" title="10"> <span class="ex">publisher</span>   <span class="kw">|</span> <span class="ex">character</span> varying(255)   <span class="kw">|</span>           <span class="kw">|</span>          <span class="kw">|</span></a>
<a class="sourceLine" id="cb338-11" title="11"> <span class="ex">createdAt</span>   <span class="kw">|</span> <span class="ex">timestamp</span> with time zone <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb338-12" title="12"> <span class="ex">updatedAt</span>   <span class="kw">|</span> <span class="ex">timestamp</span> with time zone <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb338-13" title="13"><span class="ex">Indexes</span>:</a>
<a class="sourceLine" id="cb338-14" title="14">    <span class="st">&quot;Books_pkey&quot;</span> <span class="ex">PRIMARY</span> KEY, btree (id)</a></code></pre></div>
<p>Notice that all of the <code>Book</code> <code>string</code> based properties (i.e. <code>title</code>, <code>author</code>, and <code>publisher</code>) resulted in columns with a data type of <code>character varying(255)</code>, which is a variable length text based column up to 255 characters in length. Allowing for 255 characters for the <code>title</code> column seems about right, but for the <code>author</code> and <code>publisher</code> columns, it seems excessive.</p>
<p>Also notice that the <code>title</code>, <code>author</code>, <code>releaseDate</code>, <code>pageCount</code>, and <code>publisher</code> columns all allow <code>null</code> values (a value of <code>not null</code> in the "Nullable" column means that the column doesn’t allow <code>null</code> values, otherwise the column allows <code>null</code> values). Ideally, each book in the database would have values for all of those columns.</p>
<p>We can address both of these issues by updating the <code>./db/models/book.js</code> file to the following code:</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb339-1" title="1"><span class="co">// ./db/models/book.js</span></a>
<a class="sourceLine" id="cb339-2" title="2"></a>
<a class="sourceLine" id="cb339-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb339-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb339-5" title="5">  <span class="kw">const</span> Book <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Book&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb339-6" title="6">    <span class="dt">title</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb339-7" title="7">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb339-8" title="8">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb339-9" title="9">    <span class="op">},</span></a>
<a class="sourceLine" id="cb339-10" title="10">    <span class="dt">author</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb339-11" title="11">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb339-12" title="12">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb339-13" title="13">    <span class="op">},</span></a>
<a class="sourceLine" id="cb339-14" title="14">    <span class="dt">releaseDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb339-15" title="15">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">DATEONLY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb339-16" title="16">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb339-17" title="17">    <span class="op">},</span></a>
<a class="sourceLine" id="cb339-18" title="18">    <span class="dt">pageCount</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb339-19" title="19">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb339-20" title="20">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb339-21" title="21">    <span class="op">},</span></a>
<a class="sourceLine" id="cb339-22" title="22">    <span class="dt">publisher</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb339-23" title="23">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb339-24" title="24">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb339-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb339-26" title="26">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb339-27" title="27">  <span class="va">Book</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb339-28" title="28">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb339-29" title="29">  <span class="op">};</span></a>
<a class="sourceLine" id="cb339-30" title="30">  <span class="cf">return</span> Book<span class="op">;</span></a>
<a class="sourceLine" id="cb339-31" title="31"><span class="op">};</span></a></code></pre></div>
<p>The migration file <code>./db/migrations/[timestamp]-create-book.js</code> also needs to be updated to the following code:</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb340-1" title="1"><span class="co">// ./db/migrations/[timestamp]-create-book.js</span></a>
<a class="sourceLine" id="cb340-2" title="2"></a>
<a class="sourceLine" id="cb340-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb340-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-5" title="5">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-6" title="6">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Books&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-7" title="7">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-8" title="8">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-9" title="9">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-10" title="10">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-11" title="11">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb340-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb340-13" title="13">      <span class="dt">title</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-14" title="14">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-15" title="15">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb340-16" title="16">      <span class="op">},</span></a>
<a class="sourceLine" id="cb340-17" title="17">      <span class="dt">author</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-18" title="18">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb340-19" title="19">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb340-20" title="20">      <span class="op">},</span></a>
<a class="sourceLine" id="cb340-21" title="21">      <span class="dt">releaseDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-22" title="22">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATEONLY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-23" title="23">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb340-24" title="24">      <span class="op">},</span></a>
<a class="sourceLine" id="cb340-25" title="25">      <span class="dt">pageCount</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-26" title="26">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-27" title="27">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb340-28" title="28">      <span class="op">},</span></a>
<a class="sourceLine" id="cb340-29" title="29">      <span class="dt">publisher</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-30" title="30">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb340-31" title="31">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb340-32" title="32">      <span class="op">},</span></a>
<a class="sourceLine" id="cb340-33" title="33">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-34" title="34">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-35" title="35">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb340-36" title="36">      <span class="op">},</span></a>
<a class="sourceLine" id="cb340-37" title="37">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-38" title="38">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb340-39" title="39">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb340-40" title="40">      <span class="op">}</span></a>
<a class="sourceLine" id="cb340-41" title="41">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb340-42" title="42">  <span class="op">},</span></a>
<a class="sourceLine" id="cb340-43" title="43">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb340-44" title="44">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Books&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb340-45" title="45">  <span class="op">}</span></a>
<a class="sourceLine" id="cb340-46" title="46"><span class="op">};</span></a></code></pre></div>
<h3 id="applying-the-pending-migration">Applying the pending migration</h3>
<p>After resolving the column data type and nullability issues in the model and migration files, you’re ready to apply the pending migration to create the <code>Books</code> table in the database. In the terminal, run the following command:</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb341-1" title="1"><span class="ex">npx</span> dotenv sequelize db:migrate</a></code></pre></div>
<p>Notice that you’re using npx to invoke the <code>dotenv</code> tool which loads your environment variables from the <code>.env</code> file and then invokes the <code>sequelize db:migrate</code> command. In the console, you should see something similar to the following output:</p>
<div class="sourceCode" id="cb342"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb342-1" title="1"><span class="ex">Loaded</span> configuration file <span class="st">&quot;config/database.js&quot;</span>.</a>
<a class="sourceLine" id="cb342-2" title="2"><span class="ex">Using</span> environment <span class="st">&quot;development&quot;</span>.</a>
<a class="sourceLine" id="cb342-3" title="3">== [<span class="ex">timestamp</span>]-create-book: migrating =======</a>
<a class="sourceLine" id="cb342-4" title="4">== [<span class="ex">timestamp</span>]-create-book: migrated (0.021s)</a></code></pre></div>
<p>To confirm the creation of the <code>Books</code> table, you can run the following command from within psql:</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb343-1" title="1">\<span class="ex">d</span> <span class="st">&quot;Books&quot;</span></a></code></pre></div>
<blockquote>
<p>Be sure that you’re connected to the <code>reading_list</code> database in psql. If you are, the cursor should read <code>reading_list=#</code>. If you’re not connected to the correct database, you can run the command <code>\c reading_list</code> to connect to the <code>reading_list</code> database.</p>
</blockquote>
<p>After running the <code>\d "Books"</code> command, you should see the following output within psql:</p>
<div class="sourceCode" id="cb344"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb344-1" title="1">                                        <span class="ex">Table</span> <span class="st">&quot;public.Books&quot;</span></a>
<a class="sourceLine" id="cb344-2" title="2">   <span class="ex">Column</span>    <span class="kw">|</span>           <span class="ex">Type</span>           <span class="kw">|</span> <span class="ex">Collation</span> <span class="kw">|</span> <span class="ex">Nullable</span> <span class="kw">|</span>               <span class="ex">Default</span></a>
<a class="sourceLine" id="cb344-3" title="3"><span class="ex">-------------+--------------------------+-----------+----------+-------------------------------------</span></a>
<a class="sourceLine" id="cb344-4" title="4"> <span class="fu">id</span>          <span class="kw">|</span> <span class="ex">integer</span>                  <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span> <span class="ex">nextval</span>(<span class="st">&#39;&quot;Books_id_seq&quot;&#39;</span>::regclass)</a>
<a class="sourceLine" id="cb344-5" title="5"> <span class="ex">title</span>       <span class="kw">|</span> <span class="ex">character</span> varying(255)   <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb344-6" title="6"> <span class="ex">author</span>      <span class="kw">|</span> <span class="ex">character</span> varying(100)   <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb344-7" title="7"> <span class="ex">releaseDate</span> <span class="kw">|</span> <span class="fu">date</span>                     <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb344-8" title="8"> <span class="ex">pageCount</span>   <span class="kw">|</span> <span class="ex">integer</span>                  <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb344-9" title="9"> <span class="ex">publisher</span>   <span class="kw">|</span> <span class="ex">character</span> varying(100)   <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb344-10" title="10"> <span class="ex">createdAt</span>   <span class="kw">|</span> <span class="ex">timestamp</span> with time zone <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb344-11" title="11"> <span class="ex">updatedAt</span>   <span class="kw">|</span> <span class="ex">timestamp</span> with time zone <span class="kw">|</span>           <span class="kw">|</span> <span class="ex">not</span> null <span class="kw">|</span></a>
<a class="sourceLine" id="cb344-12" title="12"><span class="ex">Indexes</span>:</a>
<a class="sourceLine" id="cb344-13" title="13">    <span class="st">&quot;Books_pkey&quot;</span> <span class="ex">PRIMARY</span> KEY, btree (id)</a></code></pre></div>
<h2 id="seeding-the-database">Seeding the database</h2>
<p>With the <code>Books</code> table created in the database, you’re ready to seed the table with some test data!</p>
<p>To start, you need to create a seed file by running the following command in the terminal from the root of your project:</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb345-1" title="1"><span class="ex">npx</span> sequelize seed:generate --name test-data</a></code></pre></div>
<p>If the command succeeds, you’ll see the following output in the console:</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb346-1" title="1"><span class="ex">seeders</span> folder at <span class="st">&quot;[path to the project folder]/db/seeders&quot;</span> already exists.</a>
<a class="sourceLine" id="cb346-2" title="2"><span class="ex">New</span> seed was created at [path to the project folder]/db/seeders/[timestamp]-test-data.js .</a></code></pre></div>
<p>This confirms that the seed file was generated. Go ahead and replace the contents of the <code>./db/seeders/[timestamp]-test-data.js</code> with the following code:</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb347-1" title="1"><span class="co">// ./db/seeders/[timestamp]-test-data.js</span></a>
<a class="sourceLine" id="cb347-2" title="2"></a>
<a class="sourceLine" id="cb347-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb347-4" title="4"></a>
<a class="sourceLine" id="cb347-5" title="5"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb347-6" title="6">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb347-7" title="7">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(<span class="st">&#39;Books&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb347-8" title="8">      <span class="op">{</span></a>
<a class="sourceLine" id="cb347-9" title="9">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;The Martian&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-10" title="10">        <span class="dt">author</span><span class="op">:</span> <span class="st">&#39;Andy Weir&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-11" title="11">        <span class="dt">releaseDate</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>(<span class="st">&#39;2014-02-11&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb347-12" title="12">        <span class="dt">pageCount</span><span class="op">:</span> <span class="dv">384</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-13" title="13">        <span class="dt">publisher</span><span class="op">:</span> <span class="st">&#39;Crown&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-14" title="14">        <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb347-15" title="15">        <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb347-16" title="16">      <span class="op">},</span></a>
<a class="sourceLine" id="cb347-17" title="17">      <span class="op">{</span></a>
<a class="sourceLine" id="cb347-18" title="18">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Ready Player One&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-19" title="19">        <span class="dt">author</span><span class="op">:</span> <span class="st">&#39;Ernest Cline&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-20" title="20">        <span class="dt">releaseDate</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>(<span class="st">&#39;2011-08-16&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb347-21" title="21">        <span class="dt">pageCount</span><span class="op">:</span> <span class="dv">384</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-22" title="22">        <span class="dt">publisher</span><span class="op">:</span> <span class="st">&#39;Crown&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-23" title="23">        <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb347-24" title="24">        <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb347-25" title="25">      <span class="op">},</span></a>
<a class="sourceLine" id="cb347-26" title="26">      <span class="op">{</span></a>
<a class="sourceLine" id="cb347-27" title="27">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Harry Potter and the Sorcerer</span><span class="sc">\&#39;</span><span class="st">s Stone&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-28" title="28">        <span class="dt">author</span><span class="op">:</span> <span class="st">&#39;J.K. Rowling&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-29" title="29">        <span class="dt">releaseDate</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>(<span class="st">&#39;1998-10-01&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb347-30" title="30">        <span class="dt">pageCount</span><span class="op">:</span> <span class="dv">309</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-31" title="31">        <span class="dt">publisher</span><span class="op">:</span> <span class="st">&#39;Scholastic Press&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb347-32" title="32">        <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb347-33" title="33">        <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()</a>
<a class="sourceLine" id="cb347-34" title="34">      <span class="op">},</span></a>
<a class="sourceLine" id="cb347-35" title="35">    ]<span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb347-36" title="36">  <span class="op">},</span></a>
<a class="sourceLine" id="cb347-37" title="37"></a>
<a class="sourceLine" id="cb347-38" title="38">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb347-39" title="39">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkDelete</span>(<span class="st">&#39;Books&#39;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb347-40" title="40">  <span class="op">}</span></a>
<a class="sourceLine" id="cb347-41" title="41"><span class="op">};</span></a></code></pre></div>
<p>The <code>up</code> property references an anonymous method that uses the <code>queryInterface.bulkInsert()</code> method to insert an array of books into the <code>Book</code> table while the <code>down</code> property references an anonymous method that uses the <code>queryInterface.bulkDelete()</code> method to delete all of the data in the <code>Books</code> table.</p>
<blockquote>
<p>Feel free to add to the array of books… have fun with it!</p>
</blockquote>
<p>To seed your database with your test data, run the following command:</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb348-1" title="1"><span class="ex">npx</span> dotenv sequelize db:seed:all</a></code></pre></div>
<p>In the console, you should see something similar to the following output:</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb349-1" title="1"><span class="ex">Loaded</span> configuration file <span class="st">&quot;config/database.js&quot;</span>.</a>
<a class="sourceLine" id="cb349-2" title="2"><span class="ex">Using</span> environment <span class="st">&quot;development&quot;</span>.</a>
<a class="sourceLine" id="cb349-3" title="3">== [<span class="ex">timestamp</span>]-test-data: migrating =======</a>
<a class="sourceLine" id="cb349-4" title="4">== [<span class="ex">timestamp</span>]-test-data: migrated (0.009s)</a></code></pre></div>
<p>Then you can use psql to check if the <code>Books</code> table contains the test data:</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb350-1" title="1"><span class="kw">select</span> <span class="ex">*</span> from <span class="st">&quot;Books&quot;</span><span class="kw">;</span></a></code></pre></div>
<p>Which should produce the following output:</p>
<div class="sourceCode" id="cb351"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb351-1" title="1"> <span class="fu">id</span> <span class="kw">|</span>                 <span class="ex">title</span>                 <span class="kw">|</span>    <span class="ex">author</span>    <span class="kw">|</span> <span class="ex">releaseDate</span> <span class="kw">|</span> <span class="ex">pageCount</span> <span class="kw">|</span>    <span class="ex">publisher</span>     <span class="kw">|</span>         <span class="ex">createdAt</span>          <span class="kw">|</span>         <span class="ex">updatedAt</span></a>
<a class="sourceLine" id="cb351-2" title="2"><span class="ex">----+---------------------------------------+--------------+-------------+-----------+------------------+----------------------------+----------------------------</span></a>
<a class="sourceLine" id="cb351-3" title="3">  <span class="ex">2</span> <span class="kw">|</span> <span class="ex">The</span> Martian                           <span class="kw">|</span> <span class="ex">Andy</span> Weir    <span class="kw">|</span> <span class="ex">2014-02-11</span>  <span class="kw">|</span>       <span class="ex">384</span> <span class="kw">|</span> <span class="ex">Crown</span>            <span class="kw">|</span> <span class="ex">2020-03-31</span> 19:06:32.452-07 <span class="kw">|</span> <span class="ex">2020-03-31</span> 19:06:32.452-07</a>
<a class="sourceLine" id="cb351-4" title="4">  <span class="ex">3</span> <span class="kw">|</span> <span class="ex">Ready</span> Player One                      <span class="kw">|</span> <span class="ex">Ernest</span> Cline <span class="kw">|</span> <span class="ex">2011-08-16</span>  <span class="kw">|</span>       <span class="ex">384</span> <span class="kw">|</span> <span class="ex">Crown</span>            <span class="kw">|</span> <span class="ex">2020-03-31</span> 19:06:32.452-07 <span class="kw">|</span> <span class="ex">2020-03-31</span> 19:06:32.452-07</a>
<a class="sourceLine" id="cb351-5" title="5">  <span class="ex">4</span> <span class="kw">|</span> <span class="ex">Harry</span> Potter and the Sorcerer<span class="st">&#39;s Stone | J.K. Rowling | 1998-10-01  |       309 | Scholastic Press | 2020-03-31 19:06:32.452-07 | 2020-03-31 19:06:32.452-07</span></a>
<a class="sourceLine" id="cb351-6" title="6"><span class="st">(3 rows)</span></a></code></pre></div>
<h2 id="querying-and-rendering-a-temporary-list-of-books">Querying and rendering a temporary list of books</h2>
<p>Now that you’ve installed and configured Sequelize, created the <code>Book</code> model and associated migration, and seeded the <code>Books</code> table, you’re ready to update your application’s default route to query the for a list of books and render the data in the <code>index</code> view!</p>
<p>In the <code>routes</code> module (the <code>./routes.js</code> file), use the <code>require()</code> function to import the <code>models</code> module:</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb352-1" title="1"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Then update the default route (<code>/</code>) to this:</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb353-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb353-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb353-3" title="3">    <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb353-4" title="4">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb353-5" title="5">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb353-6" title="6">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb353-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb353-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The <code>async</code> keyword was added to make the route handler an asynchronous function and the <code>db.Book.findAll()</code> method is used to retrieve a list of books from the database.</p>
<p>For your reference, here’s what the complete <code>./routes.js</code> file should look like:</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb354-1" title="1"><span class="co">// ./routes.js</span></a>
<a class="sourceLine" id="cb354-2" title="2"></a>
<a class="sourceLine" id="cb354-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb354-4" title="4"></a>
<a class="sourceLine" id="cb354-5" title="5"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb354-6" title="6"></a>
<a class="sourceLine" id="cb354-7" title="7"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb354-8" title="8"></a>
<a class="sourceLine" id="cb354-9" title="9"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb354-10" title="10">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb354-11" title="11">    <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb354-12" title="12">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb354-13" title="13">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb354-14" title="14">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb354-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb354-16" title="16"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb354-17" title="17"></a>
<a class="sourceLine" id="cb354-18" title="18"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<p>Now you can update the <code>./views/index.pug</code> view to render the array of books:</p>
<pre class="pug"><code>extends layout.pug

block content
  p Hello from the Reading List app!
  h3 Books
  ul
    each book in books
      li= book.title</code></pre>
<p>For now, the formatting of the book list is very simple. In the next article, you’ll see how to use Bootstrap to improve the look and feel of the book list table.</p>
<p>Run the command <code>npm start</code> to start your application (if it’s not already started) and browse to <code>http://localhost:8080/</code>. You should see the list of books from the database rendered to the page in an unordered list!</p>
<h2 id="what-you-learned-11">What you learned</h2>
<p>In this article, you learned how to:</p>
<ul>
<li>Install and configure Sequelize within an Express application; and</li>
<li>Use Sequelize to test the connection to a database before starting the HTTP server on application startup.</li>
</ul>
<p>You also reviewed the following:</p>
<ul>
<li>Using the Sequelize CLI to create a model;</li>
<li>Using the Sequelize CLI to seed the database; and</li>
<li>Using Sequelize to query data from the database.</li>
</ul>
<p>Next up: creating the routes and views to perform CRUD (create, read, update, and delete) operations using Sequelize!</p>
<hr />
<h1 id="data-driven-websites-project-part-3-using-sequelize-to-perform-crud-operations">Data-Driven Websites Project (Part 3: Using Sequelize to Perform CRUD Operations)</h1>
<p>Welcome to part three of creating the data-driven Reading List website!</p>
<p>Over the course of three articles, you’ll create a data-driven Reading List website that will allow you to view a list of books, add a book to the list, update a book in the list, and delete a book from the list. In the first article, you created the project. In the second article, you learned how to integrate Sequelize with an Express application. In this article, you’ll create the routes and views to perform CRUD (create, read, update, and delete) operations using Sequelize.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Define a collection of routes and views that use Sequelize to perform CRUD operations against a single resource; and</li>
<li>Handle Sequelize validation errors when users are attempting to create or update data and display error messages to the user so that they can resolve any data quality issues.</li>
</ul>
<p>You’ll also review the following:</p>
<ul>
<li>Using a wrapper function to catch errors thrown within asynchronous route handler functions;</li>
<li>Using Pug to create HTML forms;</li>
<li>Using the <code>csurf</code> middleware to protect against CSRF exploits;</li>
<li>Using the built-in <code>express.urlencoded()</code> middleware function to parse incoming request body form data;</li>
<li>Using Sequelize model validations to validate user-provided data;</li>
<li>Using the <code>express-validator</code> validation library to validate user-provided data within an Express route; and</li>
<li>Using Pug includes and mixins to remove unnecessary code duplication.</li>
</ul>
<h2 id="planning-the-routes-and-views">Planning the routes and views</h2>
<p>Before creating any new routes or views, it’s a good idea to plan out what pages need to be added to support the required CRUD (create, read, update, and delete) operations along with their associated routes, HTTP methods, and views.</p>
<p>Here’s a list of the proposed pages to add to the Reading List application:</p>
<table>
<thead>
<tr class="header">
<th>Page Name</th>
<th>Route Path</th>
<th>HTTP Methods</th>
<th>View Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Book List</td>
<td><code>/</code></td>
<td><code>GET</code></td>
<td><code>book-list.pug</code></td>
</tr>
<tr class="even">
<td>Add Book</td>
<td><code>/book/add</code></td>
<td><code>GET</code> <code>POST</code></td>
<td><code>book-add.pug</code></td>
</tr>
<tr class="odd">
<td>Edit Book</td>
<td><code>/book/edit/:id</code></td>
<td><code>GET</code> <code>POST</code></td>
<td><code>book-edit.pug</code></td>
</tr>
<tr class="even">
<td>Delete Book</td>
<td><code>/book/delete/:id</code></td>
<td><code>GET</code> <code>POST</code></td>
<td><code>book-delete.pug</code></td>
</tr>
</tbody>
</table>
<p>There are a number of acceptable ways that you could approach implementing the required CRUD operations for the <code>Book</code> resource or model. The above approach is a common, tried-and-true way of implementing CRUD operations within a server-side rendered web application.</p>
<blockquote>
<p>The term <strong>server-side rendered</strong> simply means that all of the work of generating the HTML for the web application’s pages is done on the server. Later on, you’ll learn how to use client-side technologies like React to move some of that work to the client (i.e. the browser).</p>
</blockquote>
<p>Notice that the "Add Book", "Edit Book", and "Delete Book" pages need to support both the <code>GET</code> and <code>POST</code> HTTP methods. The <code>GET</code> HTTP method will be used to initially retrieve each page’s HTML form while the <code>POST</code> HTTP method will be used to process each page’s HTML form submissions.</p>
<p>Also notice that the route paths for the "Edit Book" and "Delete Book" pages define an <code>:id</code> route parameter. Without a book ID, those pages wouldn’t know what book record they were supposed to be editing or deleting. The "Add Book" page doesn’t need an <code>:id</code> route parameter because that page is adding a new book record, so a book ID isn’t needed (the ID for the new record will be created by the database when the record is inserted into the table).</p>
<p>Now that you have a plan, let’s start building out the proposed pages—starting with the "Book List" page!</p>
<h2 id="creating-the-book-list-page">Creating the Book List page</h2>
<p>As a reminder, here’s what the default route (<code>/</code>) in the <code>routes</code> module (i.e. the <code>routes.js</code> file) looks like at this point:</p>
<div class="sourceCode" id="cb356"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb356-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb356-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb356-3" title="3">    <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb356-4" title="4">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Home&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb356-5" title="5">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb356-6" title="6">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb356-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb356-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>And the <code>./views/index.pug</code> view:</p>
<pre class="pug"><code>//- ./views/index.pug

extends layout.pug

block content
  p Hello from the Reading List app!
  h3 Books
  ul
    each book in books
      li= book.title</code></pre>
<p>It’s a small change, but start with renaming the <code>./views/index.pug</code> view to <code>./views/book-list.pug</code>. Changing the name of the view will make it easier to identify the purpose of the view at a glance.</p>
<p>After renaming the view, update the call to the <code>res.render()</code> method in the default route:</p>
<div class="sourceCode" id="cb358"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb358-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb358-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb358-3" title="3">    <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb358-4" title="4">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-list&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Books&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb358-5" title="5">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb358-6" title="6">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb358-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb358-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Notice that the <code>title</code> property—on the object passed as the second argument to the <code>res.render()</code> method—was changed from "Home" to "Books".</p>
<h3 id="applying-bootstrap-styles-to-the-book-list-page">Applying Bootstrap styles to the Book List page</h3>
<p>When you added Bootstrap to the project in the first article in this series, it was mentioned that the look of the application wouldn’t change much at that point. Let’s change that!</p>
<p>Update the <code>./views/book-list.pug</code> view with the following code:</p>
<pre class="pug"><code>//- ./views/book-list.pug

extends layout.pug

block content
  div(class=&#39;py-3&#39;)
    a(class=&#39;btn btn-success&#39; href=&#39;/book/add&#39; role=&#39;button&#39;) Add Book
  table(class=&#39;table table-striped table-hover&#39;)
    thead(class=&#39;thead-dark&#39;)
      tr
        th(scope=&#39;col&#39;) Title
        th(scope=&#39;col&#39;) Author
        th(scope=&#39;col&#39;) Release Date
        th(scope=&#39;col&#39;) Page Count
        th(scope=&#39;col&#39;) Publisher
        th(scope=&#39;col&#39;)
    tbody
      each book in books
        tr
          td= book.title
          td= book.author
          td= book.releaseDate
          td= book.pageCount
          td= book.publisher
          td
            a(class=&#39;btn btn-primary&#39; href=`/book/edit/${book.id}` role=&#39;button&#39;) Edit
            a(class=&#39;btn btn-danger ml-2&#39; href=`/book/delete/${book.id}` role=&#39;button&#39;) Delete</code></pre>
<p>Here’s an overview of the above Pug template code:</p>
<ul>
<li>A hyperlink (<code>&lt;a&gt;</code>) at the top of the page (<code>a(class='btn btn-success' href='/book/add' role='button') Add Book</code>) gives users a way to navigate to the "Add Book" page. The hyperlink is styled to look like a button using the <a href="https://getbootstrap.com/docs/4.4/components/buttons/">Bootstrap button CSS classes</a> (<code>btn btn-success</code>).</li>
<li>An HTML table is used to render the list of books. The <a href="https://getbootstrap.com/docs/4.4/content/tables/">Bootstrap table CSS classes</a> (<code>table table-striped table-hover</code>) are used to style the table.</li>
<li>Each row in the books HTML table contains two hyperlinks—one to navigate to the "Edit Book" page and another to navigate to the "Delete Book" page. Again, both hyperlinks are styled to look like buttons using the <a href="https://getbootstrap.com/docs/4.4/components/buttons/">Bootstrap button CSS classes</a>.</li>
</ul>
<blockquote>
<p>For more information about the Bootstrap front-end component library, see <a href="https://getbootstrap.com/docs/4.4/">the official documentation</a>.</p>
</blockquote>
<h3 id="adding-an-asynchronous-route-handler-wrapper-function">Adding an asynchronous route handler wrapper function</h3>
<p>In an earlier article, you learned that Express is unable to catch errors thrown by asynchronous route handlers. Given that, asynchronous route handlers need to catch their own errors and pass them to the <code>next()</code> method. That’s exactly what the default route handler is currently doing:</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb360-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb360-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb360-3" title="3">    <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb360-4" title="4">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-list&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Books&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb360-5" title="5">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb360-6" title="6">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb360-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb360-8" title="8"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>While you could continue to add <code>try</code>/<code>catch</code> statements to each of your route handlers, defining a simple asynchronous route handler wrapper function will keep you from having to write that boilerplate code:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb361-1" title="1"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb361-2" title="2"></a>
<a class="sourceLine" id="cb361-3" title="3"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb361-4" title="4">  <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb361-5" title="5">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-list&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Books&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb361-6" title="6"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>For your reference, here’s what the <code>./routes.js</code> file should look like at this point in the project:</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb362-1" title="1"><span class="co">// ./routes.js</span></a>
<a class="sourceLine" id="cb362-2" title="2"></a>
<a class="sourceLine" id="cb362-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb362-4" title="4"></a>
<a class="sourceLine" id="cb362-5" title="5"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb362-6" title="6"></a>
<a class="sourceLine" id="cb362-7" title="7"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb362-8" title="8"></a>
<a class="sourceLine" id="cb362-9" title="9"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb362-10" title="10"></a>
<a class="sourceLine" id="cb362-11" title="11"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb362-12" title="12"> <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb362-13" title="13"> <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-list&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Books&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb362-14" title="14"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb362-15" title="15"></a>
<a class="sourceLine" id="cb362-16" title="16"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<h3 id="testing-the-book-list-page">Testing the Book List page</h3>
<p>Open a terminal and browse to your project folder. Run the command <code>npm start</code> to start your application and browse to <code>http://localhost:8080/</code>. You should see the list of books from the database rendered to the page—but instead of using an unordered list to format the list of books you should see a nicely Bootstrap formatted HTML table!</p>
<h2 id="adding-the-add-book-page">Adding the Add Book page</h2>
<p>The next page that you’ll add to the Reading List application is the "Add Book" page. As the name clearly suggests, this page will allow you to add a new book to the reading list.</p>
<h3 id="adding-protection-from-csrf-attacks">Adding protection from CSRF attacks</h3>
<p>Before adding the route and view for the "Add Book" page, go ahead and prepare to add protection from CSRF attacks by installing and configuring the necessary dependencies and middleware.</p>
<p>To review, Cross-Site Request Forgery (CSRF) is an attack that results in an end user executing unwanted actions within a web application. Imagine that the Reading List website requires users to login before they can view and make changes to their reading list (in a future article you’ll learn how to implement user login within an Express application!) If a user was currently logged into the Reading List website, a CSRF attack would trick the user into clicking a link that unexpectedly sends a POST request to the Reading List website—a request that might add or delete a book without the user’s consent!</p>
<p>While this particular example is trivial in terms of its impact to the user, imagine that the affected web application is a banking application. The end user could end up unintentionally transferring money to the hacker’s bank account!</p>
<blockquote>
<p>For a detailed walkthrough of a CSRF attack and how to protect against CSRF attacks, see the "Protecting Forms from CSRF" article in the Express HTML Forms lesson.</p>
</blockquote>
<p>From a terminal, install the following dependencies into your project:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb363-1" title="1"><span class="ex">npm</span> install csurf@^1.0.0</a>
<a class="sourceLine" id="cb363-2" title="2"><span class="ex">npm</span> install cookie-parser@^1.0.0</a></code></pre></div>
<p>Within the <code>app</code> module (i.e. the <code>./app.js</code> file), use the <code>require()</code> function to import the <code>cookie-parser</code> middleware and call the <code>app.use()</code> method to add the middleware just after adding the <code>morgan</code> middleware to the request pipeline. While you’re updating the <code>app</code> module, go ahead and add the built-in Express <code>urlencoded</code> middleware after adding the <code>cookie-parser</code> middleware (you’ll need the <code>urlencoded</code> middleware to parse the request body form data in just a bit):</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb364-1" title="1"><span class="co">// ./app.js</span></a>
<a class="sourceLine" id="cb364-2" title="2"></a>
<a class="sourceLine" id="cb364-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb364-4" title="4"><span class="kw">const</span> morgan <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;morgan&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb364-5" title="5"><span class="kw">const</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cookie-parser&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb364-6" title="6"></a>
<a class="sourceLine" id="cb364-7" title="7"><span class="kw">const</span> routes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb364-8" title="8"></a>
<a class="sourceLine" id="cb364-9" title="9"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb364-10" title="10"></a>
<a class="sourceLine" id="cb364-11" title="11"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb364-12" title="12"><span class="va">app</span>.<span class="at">use</span>(<span class="at">morgan</span>(<span class="st">&#39;dev&#39;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb364-13" title="13"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb364-14" title="14"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>(<span class="op">{</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb364-15" title="15"><span class="va">app</span>.<span class="at">use</span>(routes)<span class="op">;</span></a>
<a class="sourceLine" id="cb364-16" title="16"></a>
<a class="sourceLine" id="cb364-17" title="17"><span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb364-18" title="18"></a>
<a class="sourceLine" id="cb364-19" title="19"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> app<span class="op">;</span></a></code></pre></div>
<h3 id="defining-the-routes-for-the-add-book-page">Defining the routes for the Add Book page</h3>
<p>Now you’re ready to define the routes for the "Add Book" page!</p>
<p>At the top of the <code>routes</code> module (i.e. the <code>./routes.js</code> file), add a call to the <code>require()</code> function to import the <code>csurf</code> module:</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb365-1" title="1"><span class="co">// ./routes.js</span></a>
<a class="sourceLine" id="cb365-2" title="2"></a>
<a class="sourceLine" id="cb365-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb365-4" title="4"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb365-5" title="5"></a>
<a class="sourceLine" id="cb365-6" title="6"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb365-7" title="7"></a>
<a class="sourceLine" id="cb365-8" title="8"><span class="co">// Code removed for brevity.</span></a></code></pre></div>
<p>Then call the <code>csurf()</code> function to create the <code>csrfProtection</code> middleware that you’ll add to each of the routes that need CSRF protection:</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb366-1" title="1"><span class="co">// ./routes.js</span></a>
<a class="sourceLine" id="cb366-2" title="2"></a>
<a class="sourceLine" id="cb366-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb366-4" title="4"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb366-5" title="5"></a>
<a class="sourceLine" id="cb366-6" title="6"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb366-7" title="7"></a>
<a class="sourceLine" id="cb366-8" title="8"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb366-9" title="9"></a>
<a class="sourceLine" id="cb366-10" title="10"><span class="kw">const</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb366-11" title="11"></a>
<a class="sourceLine" id="cb366-12" title="12"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb366-13" title="13"></a>
<a class="sourceLine" id="cb366-14" title="14"><span class="co">// Code removed for brevity.</span></a></code></pre></div>
<p>Now you’re ready to add the routes for the "Add Book" page to the <code>routes</code> module just after the existing default route (<code>/</code>)—a <code>GET</code> route to initially retrieve the "Add Book" page’s HTML form and a <code>POST</code> route to process the page’s HTML form submissions:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb367-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb367-2" title="2">  <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb367-3" title="3">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb367-4" title="4">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb367-5" title="5">    book<span class="op">,</span></a>
<a class="sourceLine" id="cb367-6" title="6">    <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb367-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb367-8" title="8"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb367-9" title="9"></a>
<a class="sourceLine" id="cb367-10" title="10"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb367-11" title="11">  <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb367-12" title="12">    title<span class="op">,</span></a>
<a class="sourceLine" id="cb367-13" title="13">    author<span class="op">,</span></a>
<a class="sourceLine" id="cb367-14" title="14">    releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb367-15" title="15">    pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb367-16" title="16">    publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb367-17" title="17">  <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb367-18" title="18"></a>
<a class="sourceLine" id="cb367-19" title="19">  <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb367-20" title="20">    title<span class="op">,</span></a>
<a class="sourceLine" id="cb367-21" title="21">    author<span class="op">,</span></a>
<a class="sourceLine" id="cb367-22" title="22">    releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb367-23" title="23">    pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb367-24" title="24">    publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb367-25" title="25">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb367-26" title="26"></a>
<a class="sourceLine" id="cb367-27" title="27">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb367-28" title="28">    <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb367-29" title="29">    <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb367-30" title="30">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb367-31" title="31">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb367-32" title="32">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb367-33" title="33">      book<span class="op">,</span></a>
<a class="sourceLine" id="cb367-34" title="34">      <span class="dt">error</span><span class="op">:</span> err<span class="op">,</span></a>
<a class="sourceLine" id="cb367-35" title="35">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb367-36" title="36">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb367-37" title="37">  <span class="op">}</span></a>
<a class="sourceLine" id="cb367-38" title="38"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Here’s an overview of the above routes:</p>
<ul>
<li>Two routes are defined for the "Add Book" page—a <code>/book/add</code> <code>GET</code> route and a <code>/book/add</code> <code>POST</code> route. As mentioned earlier, the <code>GET</code> route is used to initially retrieve the page’s HTML form while the <code>POST</code> route is used to process submissions from the page’s HTML form.</li>
<li>Both routes use the <code>csrfProtection</code> middleware to protect against CSRF attacks.</li>
<li>Within the <code>GET</code> route handler, the Sequelize <code>db.Book.build()</code> method is used to create a new instance of the <code>Book</code> model which is then passed to the <code>book-add</code> view.</li>
<li>Within the <code>POST</code> route handler, destructuring is used to declare and initialize the <code>title</code>, <code>author</code>, <code>releaseDate</code>, <code>pageCount</code>, and <code>publisher</code> variables from the <code>req.body</code> property. The <code>title</code>, <code>author</code>, <code>releaseDate</code>, <code>pageCount</code>, and <code>publisher</code> variables are then used to create a new instance of the <code>Book</code> model with a call to the <code>db.Book.build()</code> method. The <code>book.save()</code> method is called on the instance to persist the model to the database and if that operation succeeds the user is redirected to the default route (<code>/</code>). If an error occurs, the <code>book-add</code> view is rendered and sent to the client (so the error can be displayed to the end user).</li>
</ul>
<h3 id="creating-the-view-for-the-add-book-page">Creating the view for the Add Book page</h3>
<p>Add a view to the <code>views</code> folder named <code>book-add.pug</code> containing the following code:</p>
<pre class="pug"><code>//- ./views/book-add.pug

extends layout.pug

block content
  if error
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      pre= JSON.stringify(error, null, 2)
  form(action=&#39;/book/add&#39; method=&#39;post&#39;)
    input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
    div(class=&#39;form-group&#39;)
      label(for=&#39;title&#39;) Title
      input(type=&#39;text&#39; id=&#39;title&#39; name=&#39;title&#39; value=book.title class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;author&#39;) Author
      input(type=&#39;text&#39; id=&#39;author&#39; name=&#39;author&#39; value=book.author class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;releaseDate&#39;) Release Date
      input(type=&#39;text&#39; id=&#39;releaseDate&#39; name=&#39;releaseDate&#39; value=book.releaseDate class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;pageCount&#39;) Page Count
      input(type=&#39;text&#39; id=&#39;pageCount&#39; name=&#39;pageCount&#39; value=book.pageCount class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;publisher&#39;) Publisher
      input(type=&#39;text&#39; id=&#39;publisher&#39; name=&#39;publisher&#39; value=book.publisher class=&#39;form-control&#39;)
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Add Book
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<p>Here’s an overview of the above Pug template code:</p>
<ul>
<li>A conditional statement checks to see if the <code>error</code> variable is truthy (i.e. has a reference to an error) and if there’s an error, the <code>JSON.stringify()</code> method is used to render the error to the page as JSON. Later in this article, you’ll refactor this part of the view to improve the display of errors to the end user.</li>
<li>A hidden <code>&lt;input&gt;</code> element is used to render the CSRF token value to the page (i.e. <code>input(type='hidden' name='_csrf' value=csrfToken)</code>).</li>
<li>A series of <code>&lt;label&gt;</code> and text <code>&lt;input&gt;</code> elements are rendered to create the form fields for the <code>Book</code> model <code>title</code>, <code>author</code>, <code>releaseDate</code>, <code>pageCount</code>, and <code>publisher</code> properties. The <a href="https://getbootstrap.com/docs/4.4/components/forms/">Bootstrap form CSS classes</a> (<code>form-group</code>, <code>form-control</code>) are used to style the form.</li>
<li>At the bottom of the form, a submit <code>&lt;button&gt;</code> element is rendered along with a "Cancel" hyperlink that allows the end user to navigate back to the "Book List" page.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> HTML <code>&lt;input&gt;</code> element types aren’t used to their fullest extent in the above code. Feel free to experiment with using <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#%3Cinput%3E_types">the available <code>&lt;input&gt;</code> element types</a> to add client-side validation but remember that client-side validation is intended only to improve the end user experience. Because client-side validation can easily be thwarted, validating data on the server is absolutely essential to do. You’ll implement server-side validation in just a bit.</p>
</blockquote>
<h3 id="testing-the-add-book-page">Testing the Add Book page</h3>
<p>Run the command <code>npm start</code> to start your application and browse to <code>http://localhost:8080/</code>. Click the "Add Book" button at the top of the "Book List" page to browse to the "Add Book" page. Provide a value for each of the form fields and click the "Add Book" button to submit the form to the server. Be sure that you provide a valid date value (i.e. "2000-01-31"). You should now see your new book in the list of books on the "Book List" page!</p>
<p>If you click the "Add Book" button again and submit the "Add Book" page form without providing any values, an error occurs when attempting to persist an instance of the <code>Book</code> model to the database. The lengthy error message displayed just above the form will look like this:</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb369-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb369-2" title="2">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;SequelizeDatabaseError&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-3" title="3">  <span class="dt">&quot;parent&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb369-4" title="4">    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-5" title="5">    <span class="dt">&quot;length&quot;</span><span class="fu">:</span> <span class="dv">116</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-6" title="6">    <span class="dt">&quot;severity&quot;</span><span class="fu">:</span> <span class="st">&quot;ERROR&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-7" title="7">    <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;22007&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-8" title="8">    <span class="dt">&quot;file&quot;</span><span class="fu">:</span> <span class="st">&quot;datetime.c&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-9" title="9">    <span class="dt">&quot;line&quot;</span><span class="fu">:</span> <span class="st">&quot;3774&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-10" title="10">    <span class="dt">&quot;routine&quot;</span><span class="fu">:</span> <span class="st">&quot;DateTimeParseError&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-11" title="11">    <span class="dt">&quot;sql&quot;</span><span class="fu">:</span> <span class="st">&quot;INSERT INTO </span><span class="ch">\&quot;</span><span class="st">Books</span><span class="ch">\&quot;</span><span class="st"> (</span><span class="ch">\&quot;</span><span class="st">id</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">title</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">author</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">releaseDate</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">pageCount</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">publisher</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">createdAt</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">updatedAt</span><span class="ch">\&quot;</span><span class="st">) VALUES (DEFAULT,$1,$2,$3,$4,$5,$6,$7) RETURNING *;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-12" title="12">    <span class="dt">&quot;parameters&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb369-13" title="13">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-14" title="14">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-15" title="15">      <span class="st">&quot;Invalid date&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-16" title="16">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-17" title="17">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-18" title="18">      <span class="st">&quot;2020-04-02 15:20:33.668 +00:00&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-19" title="19">      <span class="st">&quot;2020-04-02 15:20:33.668 +00:00&quot;</span></a>
<a class="sourceLine" id="cb369-20" title="20">    <span class="ot">]</span></a>
<a class="sourceLine" id="cb369-21" title="21">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb369-22" title="22">  <span class="dt">&quot;original&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb369-23" title="23">    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-24" title="24">    <span class="dt">&quot;length&quot;</span><span class="fu">:</span> <span class="dv">116</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-25" title="25">    <span class="dt">&quot;severity&quot;</span><span class="fu">:</span> <span class="st">&quot;ERROR&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-26" title="26">    <span class="dt">&quot;code&quot;</span><span class="fu">:</span> <span class="st">&quot;22007&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-27" title="27">    <span class="dt">&quot;file&quot;</span><span class="fu">:</span> <span class="st">&quot;datetime.c&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-28" title="28">    <span class="dt">&quot;line&quot;</span><span class="fu">:</span> <span class="st">&quot;3774&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-29" title="29">    <span class="dt">&quot;routine&quot;</span><span class="fu">:</span> <span class="st">&quot;DateTimeParseError&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-30" title="30">    <span class="dt">&quot;sql&quot;</span><span class="fu">:</span> <span class="st">&quot;INSERT INTO </span><span class="ch">\&quot;</span><span class="st">Books</span><span class="ch">\&quot;</span><span class="st"> (</span><span class="ch">\&quot;</span><span class="st">id</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">title</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">author</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">releaseDate</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">pageCount</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">publisher</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">createdAt</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">updatedAt</span><span class="ch">\&quot;</span><span class="st">) VALUES (DEFAULT,$1,$2,$3,$4,$5,$6,$7) RETURNING *;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-31" title="31">    <span class="dt">&quot;parameters&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb369-32" title="32">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-33" title="33">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-34" title="34">      <span class="st">&quot;Invalid date&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-35" title="35">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-36" title="36">      <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-37" title="37">      <span class="st">&quot;2020-04-02 15:20:33.668 +00:00&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-38" title="38">      <span class="st">&quot;2020-04-02 15:20:33.668 +00:00&quot;</span></a>
<a class="sourceLine" id="cb369-39" title="39">    <span class="ot">]</span></a>
<a class="sourceLine" id="cb369-40" title="40">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb369-41" title="41">  <span class="dt">&quot;sql&quot;</span><span class="fu">:</span> <span class="st">&quot;INSERT INTO </span><span class="ch">\&quot;</span><span class="st">Books</span><span class="ch">\&quot;</span><span class="st"> (</span><span class="ch">\&quot;</span><span class="st">id</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">title</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">author</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">releaseDate</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">pageCount</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">publisher</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">createdAt</span><span class="ch">\&quot;</span><span class="st">,</span><span class="ch">\&quot;</span><span class="st">updatedAt</span><span class="ch">\&quot;</span><span class="st">) VALUES (DEFAULT,$1,$2,$3,$4,$5,$6,$7) RETURNING *;&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb369-42" title="42">  <span class="dt">&quot;parameters&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb369-43" title="43">    <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-44" title="44">    <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-45" title="45">    <span class="st">&quot;Invalid date&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-46" title="46">    <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-47" title="47">    <span class="st">&quot;&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-48" title="48">    <span class="st">&quot;2020-04-02 15:20:33.668 +00:00&quot;</span><span class="ot">,</span></a>
<a class="sourceLine" id="cb369-49" title="49">    <span class="st">&quot;2020-04-02 15:20:33.668 +00:00&quot;</span></a>
<a class="sourceLine" id="cb369-50" title="50">  <span class="ot">]</span></a>
<a class="sourceLine" id="cb369-51" title="51"><span class="fu">}</span></a></code></pre></div>
<p>From the error message, you can see that a <code>SequelizeDatabaseError</code> occurred when attempting to insert into the <code>Books</code> table. The underlying error is a date/time parse error, which is occurring because you didn’t supply a value for the <code>releaseDate</code> property on the <code>Book</code> model.</p>
<p>It’s not just empty strings that result in date/time parse errors. Improperly formatted date/time <code>string</code> values—or simply bad <code>string</code> values—can also produce date/time parse errors. For example, all of the following <code>string</code> date/time values cannot be parsed to date/time values:</p>
<ul>
<li>Jan 31st 2002</li>
<li>100/31/2002</li>
<li>Jaanuary 31, 2002</li>
</ul>
<p>You can use the <code>input</code> element’s <code>placeholder</code> attribute to communicate to users an example of the expected input format. Refactor your <code>input#releaseDate</code> element to include a placeholder:</p>
<pre class="pug"><code>input(type=&#39;text&#39; 
      id=&#39;releaseDate&#39; 
      name=&#39;releaseDate&#39; 
      value=book.releaseDate 
      class=&#39;form-control&#39; 
      placeholder=&#39;ex: 2000-01-31&#39;)</code></pre>
<p>Time to implement server-side validations! You’ll see how to implement validations using two different approaches—within the <code>Book</code> database model using Sequelize’s built-in model validation and within the "Add Book" page <code>POST</code> route using the <code>express-validator</code> validation library.</p>
<h2 id="implementing-server-side-validation-using-sequelize">Implementing server-side validation using Sequelize</h2>
<p>Before updating the <code>Book</code> model (the <code>./db/models/book.js</code> file), make a copy of the existing code by copying the entire file with a file extension of <code>.bak</code> (i.e. <code>book.js.bak</code>) or simply copying and pasting the code within the existing file and commenting it out. When implementing validation at the route level using a validation library, you’ll want a convenient way to remove or disable the validations in the <code>Book</code> model.</p>
<h3 id="adding-validations-to-the-book-model">Adding validations to the <code>Book</code> model</h3>
<p>Now you’re ready to update the <code>Book</code> model to the following code:</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb371-1" title="1"><span class="co">// ./db/models/book.js</span></a>
<a class="sourceLine" id="cb371-2" title="2"></a>
<a class="sourceLine" id="cb371-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb371-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-5" title="5">  <span class="kw">const</span> Book <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Book&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-6" title="6">    <span class="dt">title</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-7" title="7">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-8" title="8">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-9" title="9">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-10" title="10">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-11" title="11">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Title&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-12" title="12">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-13" title="13">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-14" title="14">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Title&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-15" title="15">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-16" title="16">        <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-17" title="17">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">255</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb371-18" title="18">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Title must not be more than 255 characters long&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-19" title="19">        <span class="op">}</span></a>
<a class="sourceLine" id="cb371-20" title="20">      <span class="op">}</span></a>
<a class="sourceLine" id="cb371-21" title="21">    <span class="op">},</span></a>
<a class="sourceLine" id="cb371-22" title="22">    <span class="dt">author</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-23" title="23">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb371-24" title="24">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-25" title="25">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-26" title="26">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-27" title="27">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Author&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-28" title="28">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-29" title="29">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-30" title="30">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Author&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-31" title="31">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-32" title="32">        <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-33" title="33">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb371-34" title="34">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Author must not be more than 100 characters long&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-35" title="35">        <span class="op">}</span></a>
<a class="sourceLine" id="cb371-36" title="36">      <span class="op">}</span></a>
<a class="sourceLine" id="cb371-37" title="37">    <span class="op">},</span></a>
<a class="sourceLine" id="cb371-38" title="38">    <span class="dt">releaseDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-39" title="39">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">DATEONLY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-40" title="40">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-41" title="41">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-42" title="42">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-43" title="43">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Release Date&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-44" title="44">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-45" title="45">        <span class="dt">isDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-46" title="46">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a valid date for Release Date&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-47" title="47">        <span class="op">}</span></a>
<a class="sourceLine" id="cb371-48" title="48">      <span class="op">}</span></a>
<a class="sourceLine" id="cb371-49" title="49">    <span class="op">},</span></a>
<a class="sourceLine" id="cb371-50" title="50">    <span class="dt">pageCount</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-51" title="51">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-52" title="52">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-53" title="53">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-54" title="54">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-55" title="55">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Page Count&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-56" title="56">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-57" title="57">        <span class="dt">isInt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-58" title="58">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a valid integer for Page Count&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-59" title="59">        <span class="op">}</span></a>
<a class="sourceLine" id="cb371-60" title="60">      <span class="op">}</span></a>
<a class="sourceLine" id="cb371-61" title="61">    <span class="op">},</span></a>
<a class="sourceLine" id="cb371-62" title="62">    <span class="dt">publisher</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-63" title="63">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb371-64" title="64">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-65" title="65">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-66" title="66">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-67" title="67">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Publisher&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-68" title="68">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-69" title="69">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-70" title="70">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Publisher&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-71" title="71">        <span class="op">},</span></a>
<a class="sourceLine" id="cb371-72" title="72">        <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb371-73" title="73">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb371-74" title="74">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Publisher must not be more than 100 characters long&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb371-75" title="75">        <span class="op">}</span></a>
<a class="sourceLine" id="cb371-76" title="76">      <span class="op">}</span></a>
<a class="sourceLine" id="cb371-77" title="77">    <span class="op">}</span></a>
<a class="sourceLine" id="cb371-78" title="78">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb371-79" title="79">  <span class="va">Book</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb371-80" title="80">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb371-81" title="81">  <span class="op">};</span></a>
<a class="sourceLine" id="cb371-82" title="82">  <span class="cf">return</span> Book<span class="op">;</span></a>
<a class="sourceLine" id="cb371-83" title="83"><span class="op">};</span></a></code></pre></div>
<p>Here’s an overview of the above code:</p>
<ul>
<li>Sequelize validation rules or validators are applied to model properties—referred to by Sequelize as "attributes"—using the <code>validate</code> property. The <code>validate</code> property is set to an object whose properties represent each validation rule to apply to the model attribute.</li>
<li>For the <code>string</code> based model attributes (i.e. text based database table columns) that don’t allow <code>null</code> values—the <code>title</code>, <code>author</code>, <code>publisher</code> properties—the <code>notNull</code> and <code>notEmpty</code> validators are applied to disallow <code>null</code> values <strong>and</strong> empty string values.</li>
<li>Notice the nuance between the <code>allowNull</code> model attribute property and the <code>notNull</code> validation rule. The <code>allowNull</code> model attribute property is set to <code>false</code> to configure the underlying database table column to disallow <code>null</code> values and the <code>notNull</code> validation rule is applied to validate that a model instance attribute value is not <code>null</code>.</li>
<li>The <code>len</code> validation is also applied to the <code>string</code> based model attributes to give feedback to the end user when a model instance attribute value exceeds the configured maximum length for the underlying database table column.</li>
<li>The <code>isDate</code> and <code>isInt</code> validators are applied respectively to the <code>releaseDate</code> and <code>pageCount</code> model attributes to validate that the model instance attribute values can be successfully parsed to the underlying database table column data types.</li>
</ul>
<blockquote>
<p>Sequelize provides a variety of validators that you can apply to model attributes. For a list of the available validators, see <a href="https://sequelize.org/v5/manual/models-definition.html#validations">the official Sequelize documentation</a>.</p>
</blockquote>
<blockquote>
<p>For more information about Sequelize model validations see the "Model Validations With Sequelize" article in the SQL ORM lesson.</p>
</blockquote>
<h3 id="updating-the-add-book-page-post-route">Updating the Add Book page <code>POST</code> route</h3>
<p>With the model validations in place, now you need to update the "Add Book" page <code>POST</code> route in the <code>routes</code> module (the <code>./routes.js</code> file) to process Sequelize validation errors.</p>
<p>To start, add the <code>next</code> parameter to the route handler function’s parameter list:</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb372-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb372-2" title="2">  <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb372-3" title="3"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Then update the <code>try</code>/<code>catch</code> statement to this:</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb373-1" title="1"><span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb373-2" title="2">  <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb373-3" title="3">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb373-4" title="4"><span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb373-5" title="5">  <span class="cf">if</span> (<span class="va">err</span>.<span class="at">name</span> <span class="op">===</span> <span class="st">&#39;SequelizeValidationError&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb373-6" title="6">    <span class="kw">const</span> errors <span class="op">=</span> <span class="va">err</span>.<span class="va">errors</span>.<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb373-7" title="7">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb373-8" title="8">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb373-9" title="9">      book<span class="op">,</span></a>
<a class="sourceLine" id="cb373-10" title="10">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb373-11" title="11">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb373-12" title="12">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb373-13" title="13">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb373-14" title="14">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb373-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb373-16" title="16"><span class="op">}</span></a></code></pre></div>
<p>Within the <code>catch</code> block, the <code>err.name</code> property is checked to see if the error is a <code>SequelizeValidationError</code> error type which is the error type that Sequelize throws if a validation error has occurred.</p>
<p>If it’s a validation error, the <code>Array#map()</code> method is called on the <code>err.errors</code> array to create an array of error messages. Currently, <code>err</code> is an object with an <code>errors</code> property.</p>
<p>The <code>err.errors</code> property is an array of <em>error objects</em> that provide detailed information about each validation error. Each element in <code>err.errors</code> has a <code>message</code> property. The <code>Array#map()</code> method plucks the <code>message</code> property from each <em>error object</em> to create an array of validation messages. This array of validation messages will be rendered on the form, instead of the array of <em>error objects</em>.</p>
<p>If the error isn’t a <code>SequelizeValidationError</code> error, then the error is passed as an argument to the <code>next()</code> method call which results in Express handing the request off to the application’s defined error handlers for processing.</p>
<p>For your reference, the updated "Add Book" page <code>POST</code> route should now look like this:</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb374-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb374-2" title="2">  <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb374-3" title="3">    title<span class="op">,</span></a>
<a class="sourceLine" id="cb374-4" title="4">    author<span class="op">,</span></a>
<a class="sourceLine" id="cb374-5" title="5">    releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb374-6" title="6">    pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb374-7" title="7">    publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb374-8" title="8">  <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb374-9" title="9"></a>
<a class="sourceLine" id="cb374-10" title="10">  <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb374-11" title="11">    title<span class="op">,</span></a>
<a class="sourceLine" id="cb374-12" title="12">    author<span class="op">,</span></a>
<a class="sourceLine" id="cb374-13" title="13">    releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb374-14" title="14">    pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb374-15" title="15">    publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb374-16" title="16">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb374-17" title="17"></a>
<a class="sourceLine" id="cb374-18" title="18">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb374-19" title="19">    <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb374-20" title="20">    <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb374-21" title="21">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb374-22" title="22">    <span class="cf">if</span> (<span class="va">err</span>.<span class="at">name</span> <span class="op">===</span> <span class="st">&#39;SequelizeValidationError&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb374-23" title="23">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">err</span>.<span class="va">errors</span>.<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb374-24" title="24">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb374-25" title="25">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb374-26" title="26">        book<span class="op">,</span></a>
<a class="sourceLine" id="cb374-27" title="27">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb374-28" title="28">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb374-29" title="29">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb374-30" title="30">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb374-31" title="31">      <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb374-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb374-33" title="33">  <span class="op">}</span></a>
<a class="sourceLine" id="cb374-34" title="34"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<h3 id="updating-the-add-book-page-view">Updating the Add Book page view</h3>
<p>The final part of implementing validations is to update the "Add Book" page view (the <code>./views/book-add.pug</code> file) to render the array of validation messages. Replace the existing <code>if error</code> conditional statement with the following code:</p>
<pre class="pug"><code>//- ./views/book-add.pug

extends layout.pug

block content
  if errors
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      ul
        each error in errors
          li= error

//- Code removed for brevity.</code></pre>
<p>The Bootstrap <code>alert alert-danger</code> CSS classes are used to style the unordered list of validation messages.</p>
<p>For your reference, the updated "Add Book" page view should now look like this:</p>
<pre class="pug"><code>//- ./views/book-add.pug

extends layout.pug

block content
  if errors
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      ul
        each error in errors
          li= error
  form(action=&#39;/book/add&#39; method=&#39;post&#39;)
    input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
    div(class=&#39;form-group&#39;)
      label(for=&#39;title&#39;) Title
      input(type=&#39;text&#39; id=&#39;title&#39; name=&#39;title&#39; value=book.title class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;author&#39;) Author
      input(type=&#39;text&#39; id=&#39;author&#39; name=&#39;author&#39; value=book.author class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;releaseDate&#39;) Release Date
      input(type=&#39;text&#39; id=&#39;releaseDate&#39; name=&#39;releaseDate&#39; value=book.releaseDate class=&#39;form-control&#39; placeholder=&#39;ex: 2000-01-31&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;pageCount&#39;) Page Count
      input(type=&#39;text&#39; id=&#39;pageCount&#39; name=&#39;pageCount&#39; value=book.pageCount class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;publisher&#39;) Publisher
      input(type=&#39;text&#39; id=&#39;publisher&#39; name=&#39;publisher&#39; value=book.publisher class=&#39;form-control&#39;)
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Add Book
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<h3 id="testing-the-server-side-validations">Testing the server-side validations</h3>
<p>Run the command <code>npm start</code> to start your application and browse to <code>http://localhost:8080/</code>. Click the "Add Book" button at the top of the "Book List" page to browse to the "Add Book" page. Click the "Add Book" button to submit the "Add Book" page form without providing any values. You should now see a list of validation messages displayed just above the form.</p>
<p>Provide a value for each of the form fields and click the "Add Book" button to submit the form to the server. You should now see your new book in the list of books on the "Book List" page!</p>
<h2 id="implementing-server-side-validation-using-a-validation-library">Implementing server-side validation using a validation library</h2>
<p>Keeping your application’s validation logic out of your database models makes your code more modular. Improved modularity allows you to more easily update one part of your application without worrying as much about how that change will impact another part of your application.</p>
<p>In this section, you’ll replace the Sequelize model validations with route level validations using the <code>express-validator</code> validation library.</p>
<h3 id="removing-the-sequelize-model-validations">Removing the Sequelize model validations</h3>
<p>Before you updated the <code>Book</code> model (the <code>./db/models/book.js</code> file), you made a copy of the existing code by either copying the entire file with a file extension of <code>.bak</code> (i.e. <code>book.js.bak</code>) or copying and pasting the code within the existing file and commenting it out. It’s time to use your backup copy of the <code>Book</code> model to remove the Sequelize validations.</p>
<p>For your reference, here’s what the <code>Book</code> model (the <code>./db/models/book.js</code> file) should look like before proceeding:</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb377-1" title="1"><span class="co">// ./db/models/book.js</span></a>
<a class="sourceLine" id="cb377-2" title="2"></a>
<a class="sourceLine" id="cb377-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb377-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb377-5" title="5">  <span class="kw">const</span> Book <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Book&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb377-6" title="6">    <span class="dt">title</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb377-7" title="7">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb377-8" title="8">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb377-9" title="9">    <span class="op">},</span></a>
<a class="sourceLine" id="cb377-10" title="10">    <span class="dt">author</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb377-11" title="11">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb377-12" title="12">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb377-13" title="13">    <span class="op">},</span></a>
<a class="sourceLine" id="cb377-14" title="14">    <span class="dt">releaseDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb377-15" title="15">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">DATEONLY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb377-16" title="16">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb377-17" title="17">    <span class="op">},</span></a>
<a class="sourceLine" id="cb377-18" title="18">    <span class="dt">pageCount</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb377-19" title="19">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb377-20" title="20">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb377-21" title="21">    <span class="op">},</span></a>
<a class="sourceLine" id="cb377-22" title="22">    <span class="dt">publisher</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb377-23" title="23">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb377-24" title="24">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span></a>
<a class="sourceLine" id="cb377-25" title="25">    <span class="op">}</span></a>
<a class="sourceLine" id="cb377-26" title="26">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb377-27" title="27">  <span class="va">Book</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb377-28" title="28">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb377-29" title="29">  <span class="op">};</span></a>
<a class="sourceLine" id="cb377-30" title="30">  <span class="cf">return</span> Book<span class="op">;</span></a>
<a class="sourceLine" id="cb377-31" title="31"><span class="op">};</span></a></code></pre></div>
<h3 id="updating-the-add-book-page-post-route-1">Updating the Add Book page <code>POST</code> route</h3>
<p>From the terminal, use npm to install the <code>express-validator</code> package:</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb378-1" title="1"><span class="ex">npm</span> install express-validator@^6.0.0</a></code></pre></div>
<p>In the <code>routes</code> module (i.e. the <code>./routes.js</code> file), use the <code>require()</code> function to import the <code>express-validator</code> module (just after importing the <code>csurf</code> module) and destructuring to declare and initialize the <code>check</code> and <code>validationResult</code> variables:</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb379-1" title="1"><span class="co">// ./routes.js</span></a>
<a class="sourceLine" id="cb379-2" title="2"></a>
<a class="sourceLine" id="cb379-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb379-4" title="4"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb379-5" title="5"><span class="kw">const</span> <span class="op">{</span> check<span class="op">,</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-validator&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb379-6" title="6"></a>
<a class="sourceLine" id="cb379-7" title="7"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb379-8" title="8"></a>
<a class="sourceLine" id="cb379-9" title="9"><span class="co">// Code remove for brevity.</span></a></code></pre></div>
<p>The <code>check</code> variable references a function (defined by the <code>express-validator</code> validation library) that returns a middleware function for validating a request. When you call the <code>check()</code> method, you pass in the name of the field—in this case a request body form field name—that you want to validate:</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb380-1" title="1"><span class="kw">const</span> titleValidator <span class="op">=</span> <span class="at">check</span>(<span class="st">&#39;title&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>The value returned by the <code>check()</code> method is a validation chain object. The object is referred to as a validation "chain" because you can add one or more validators by making a series of method calls.</p>
<p>One of the validators that you can add to the validation chain is the <code>exists()</code> validator:</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb381-1" title="1"><span class="kw">const</span> titleValidator <span class="op">=</span> <span class="at">check</span>(<span class="st">&#39;title&#39;</span>)</a>
<a class="sourceLine" id="cb381-2" title="2">  .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>The <code>exists()</code> validator will fail if the request body is missing a form field with the name (or key) <code>title</code> or because we set the <code>checkFalsy</code> option to <code>true</code> the validator will fail if the request body contains a form field with the name <code>title</code> but the value is set to a falsy value (eg <code>""</code>, <code>0</code>, <code>false</code>, <code>null</code>).</p>
<p>When a validator fails, it’ll add a validation error to the current request. You can chain a call to the <code>withMessage()</code> method to customize the validation error message for the previous validator in the chain:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb382-1" title="1"><span class="kw">const</span> titleValidator <span class="op">=</span> <span class="at">check</span>(<span class="st">&#39;title&#39;</span>)</a>
<a class="sourceLine" id="cb382-2" title="2">  .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb382-3" title="3">  .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Title&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now if the <code>exists()</code> validator for the field <code>title</code> fails, a validation error will be added to the request with the message "Please provide a value for Title".</p>
<p>The <code>express-validator</code> validation library is built on top of the validator.js library. This means that all of the <a href="https://github.com/validatorjs/validator.js#validators">available validators within the validator.js library</a> are available for you to use in your validation logic.</p>
<p>One of the available validators is the <code>isLength()</code> validator, which can be used to check the length of a string based field:</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb383-1" title="1"><span class="kw">const</span> titleValidator <span class="op">=</span> <span class="at">check</span>(<span class="st">&#39;title&#39;</span>)</a>
<a class="sourceLine" id="cb383-2" title="2">  .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb383-3" title="3">  .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Title&#39;</span>)</a>
<a class="sourceLine" id="cb383-4" title="4">  .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">255</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb383-5" title="5">  .<span class="at">withMessage</span>(<span class="st">&#39;Title must not be more than 255 characters long&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Notice how the <code>isLength()</code> method is called directly on the return value of the <code>withMessage()</code> method? This is the validation chain in action—each method call in the validation chain returns the validation chain so you can keep adding validators. This is also known as "method chaining".</p>
<blockquote>
<p>APIs that make use of method chaining are often referred to as <a href="https://en.wikipedia.org/wiki/Fluent_interface">fluent APIs</a>.</p>
</blockquote>
<p>Instead of declaring a variable for each field that you want to define a validation chain for, you can declare a single variable that’s initialized to an array of validation chains:</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb384-1" title="1"><span class="kw">const</span> bookValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb384-2" title="2">  <span class="at">check</span>(<span class="st">&#39;title&#39;</span>)</a>
<a class="sourceLine" id="cb384-3" title="3">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-4" title="4">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Title&#39;</span>)</a>
<a class="sourceLine" id="cb384-5" title="5">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">255</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-6" title="6">    .<span class="at">withMessage</span>(<span class="st">&#39;Title must not be more than 255 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb384-7" title="7">  <span class="at">check</span>(<span class="st">&#39;author&#39;</span>)</a>
<a class="sourceLine" id="cb384-8" title="8">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-9" title="9">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Author&#39;</span>)</a>
<a class="sourceLine" id="cb384-10" title="10">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-11" title="11">    .<span class="at">withMessage</span>(<span class="st">&#39;Author must not be more than 100 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb384-12" title="12">  <span class="at">check</span>(<span class="st">&#39;releaseDate&#39;</span>)</a>
<a class="sourceLine" id="cb384-13" title="13">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-14" title="14">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Release Date&#39;</span>)</a>
<a class="sourceLine" id="cb384-15" title="15">    .<span class="at">isISO8601</span>()</a>
<a class="sourceLine" id="cb384-16" title="16">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a valid date for Release Date&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb384-17" title="17">  <span class="at">check</span>(<span class="st">&#39;pageCount&#39;</span>)</a>
<a class="sourceLine" id="cb384-18" title="18">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-19" title="19">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Page Count&#39;</span>)</a>
<a class="sourceLine" id="cb384-20" title="20">    .<span class="at">isInt</span>(<span class="op">{</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-21" title="21">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a valid integer for Page Count&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb384-22" title="22">  <span class="at">check</span>(<span class="st">&#39;publisher&#39;</span>)</a>
<a class="sourceLine" id="cb384-23" title="23">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-24" title="24">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Publisher&#39;</span>)</a>
<a class="sourceLine" id="cb384-25" title="25">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb384-26" title="26">    .<span class="at">withMessage</span>(<span class="st">&#39;Publisher must not be more than 100 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb384-27" title="27">]<span class="op">;</span></a></code></pre></div>
<p>Each validation chain is an Express middleware function. After initializing an array containing all of your field validation chains, you can simply add the array directly to your route definition:</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb385-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb385-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb385-3" title="3">    <span class="co">// Code removed for brevity.</span></a>
<a class="sourceLine" id="cb385-4" title="4">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Because each field validation chain is a middleware function and the Express Application <code>post()</code> method accepts an array of middleware functions, each validation chain will be called when the request matches the route path.</p>
<p>Within the route handler function, <code>validationResult()</code> function is used to extract any validation errors from the current request:</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb386-1" title="1"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb386-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb386-3" title="3">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb386-4" title="4">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb386-5" title="5">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb386-6" title="6">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb386-7" title="7">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb386-8" title="8">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb386-9" title="9">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb386-10" title="10"></a>
<a class="sourceLine" id="cb386-11" title="11">    <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb386-12" title="12">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb386-13" title="13">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb386-14" title="14">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb386-15" title="15">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb386-16" title="16">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb386-17" title="17">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb386-18" title="18"></a>
<a class="sourceLine" id="cb386-19" title="19">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb386-20" title="20"></a>
<a class="sourceLine" id="cb386-21" title="21">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb386-22" title="22">      <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb386-23" title="23">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb386-24" title="24">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb386-25" title="25">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb386-26" title="26">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb386-27" title="27">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb386-28" title="28">        book<span class="op">,</span></a>
<a class="sourceLine" id="cb386-29" title="29">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb386-30" title="30">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb386-31" title="31">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb386-32" title="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb386-33" title="33">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>The <code>validatorErrors</code> object provides an <code>isEmpty()</code> method to check if there are any validation errors. If there aren’t any validation errors, then the <code>book.save()</code> method is called to persist the book to the database and the user is redirected to the default route (i.e. the "Book List" page).</p>
<p>If there are validation errors, the <code>array()</code> method is called on the <code>validatorErrors</code> object to get an array of validation error objects. Each error object has a <code>msg</code> property containing the validation error message. The <code>Array#map()</code> method plucks the <code>msg</code> property from each error object into a new array of validation messages named <code>errors</code>.</p>
<blockquote>
<p>For more information about the <code>express-validator</code> library, see <a href="https://express-validator.github.io/docs/">the official documentation</a>.</p>
</blockquote>
<p>For your reference, here’s what the <code>./routes.js</code> file should look like after being updated:</p>
<div class="sourceCode" id="cb387"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb387-1" title="1"><span class="co">// ./routes.js</span></a>
<a class="sourceLine" id="cb387-2" title="2"></a>
<a class="sourceLine" id="cb387-3" title="3"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-4" title="4"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-5" title="5"><span class="kw">const</span> <span class="op">{</span> check<span class="op">,</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-validator&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-6" title="6"></a>
<a class="sourceLine" id="cb387-7" title="7"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-8" title="8"></a>
<a class="sourceLine" id="cb387-9" title="9"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb387-10" title="10"></a>
<a class="sourceLine" id="cb387-11" title="11"><span class="kw">const</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-12" title="12"></a>
<a class="sourceLine" id="cb387-13" title="13"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-14" title="14"></a>
<a class="sourceLine" id="cb387-15" title="15"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb387-16" title="16">  <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-17" title="17">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-list&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Books&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-18" title="18"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb387-19" title="19"></a>
<a class="sourceLine" id="cb387-20" title="20"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb387-21" title="21">  <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb387-22" title="22">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb387-23" title="23">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb387-24" title="24">    book<span class="op">,</span></a>
<a class="sourceLine" id="cb387-25" title="25">    <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb387-26" title="26">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-27" title="27"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-28" title="28"></a>
<a class="sourceLine" id="cb387-29" title="29"><span class="kw">const</span> bookValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb387-30" title="30">  <span class="at">check</span>(<span class="st">&#39;title&#39;</span>)</a>
<a class="sourceLine" id="cb387-31" title="31">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-32" title="32">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Title&#39;</span>)</a>
<a class="sourceLine" id="cb387-33" title="33">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">255</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-34" title="34">    .<span class="at">withMessage</span>(<span class="st">&#39;Title must not be more than 255 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb387-35" title="35">  <span class="at">check</span>(<span class="st">&#39;author&#39;</span>)</a>
<a class="sourceLine" id="cb387-36" title="36">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-37" title="37">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Author&#39;</span>)</a>
<a class="sourceLine" id="cb387-38" title="38">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-39" title="39">    .<span class="at">withMessage</span>(<span class="st">&#39;Author must not be more than 100 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb387-40" title="40">  <span class="at">check</span>(<span class="st">&#39;releaseDate&#39;</span>)</a>
<a class="sourceLine" id="cb387-41" title="41">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-42" title="42">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Release Date&#39;</span>)</a>
<a class="sourceLine" id="cb387-43" title="43">    .<span class="at">isISO8601</span>()</a>
<a class="sourceLine" id="cb387-44" title="44">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a valid date for Release Date&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb387-45" title="45">  <span class="at">check</span>(<span class="st">&#39;pageCount&#39;</span>)</a>
<a class="sourceLine" id="cb387-46" title="46">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-47" title="47">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Page Count&#39;</span>)</a>
<a class="sourceLine" id="cb387-48" title="48">    .<span class="at">isInt</span>(<span class="op">{</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-49" title="49">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a valid integer for Page Count&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb387-50" title="50">  <span class="at">check</span>(<span class="st">&#39;publisher&#39;</span>)</a>
<a class="sourceLine" id="cb387-51" title="51">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-52" title="52">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Publisher&#39;</span>)</a>
<a class="sourceLine" id="cb387-53" title="53">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb387-54" title="54">    .<span class="at">withMessage</span>(<span class="st">&#39;Publisher must not be more than 100 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb387-55" title="55">]<span class="op">;</span></a>
<a class="sourceLine" id="cb387-56" title="56"></a>
<a class="sourceLine" id="cb387-57" title="57"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/add&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb387-58" title="58">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb387-59" title="59">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb387-60" title="60">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb387-61" title="61">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb387-62" title="62">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb387-63" title="63">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb387-64" title="64">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb387-65" title="65">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb387-66" title="66"></a>
<a class="sourceLine" id="cb387-67" title="67">    <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb387-68" title="68">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb387-69" title="69">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb387-70" title="70">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb387-71" title="71">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb387-72" title="72">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb387-73" title="73">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-74" title="74"></a>
<a class="sourceLine" id="cb387-75" title="75">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-76" title="76"></a>
<a class="sourceLine" id="cb387-77" title="77">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb387-78" title="78">      <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb387-79" title="79">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-80" title="80">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb387-81" title="81">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-82" title="82">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb387-83" title="83">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb387-84" title="84">        book<span class="op">,</span></a>
<a class="sourceLine" id="cb387-85" title="85">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb387-86" title="86">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb387-87" title="87">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb387-88" title="88">    <span class="op">}</span></a>
<a class="sourceLine" id="cb387-89" title="89">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb387-90" title="90"></a>
<a class="sourceLine" id="cb387-91" title="91"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<h3 id="testing-the-updated-server-side-validations">Testing the updated server-side validations</h3>
<p>Run the command <code>npm start</code> to start your application and browse to <code>http://localhost:8080/</code>. Click the "Add Book" button at the top of the "Book List" page to browse to the "Add Book" page. Click the "Add Book" button to submit the "Add Book" page form without providing any values. You should now see a list of validation messages displayed just above the form.</p>
<p>Provide a value for each of the form fields and click the "Add Book" button to submit the form to the server. You should now see your new book in the list of books on the "Book List" page!</p>
<h2 id="adding-the-edit-book-page">Adding the Edit Book page</h2>
<p>The next page that you’ll add to the Reading List application is the "Edit Book" page. As the name clearly suggests, this page will allow you to edit the details of a book from the reading list.</p>
<h3 id="defining-the-routes-for-the-edit-book-page">Defining the routes for the Edit Book page</h3>
<p>Add the routes for the "Edit Book" page to the <code>routes</code> module (i.e. the <code>./routes.js file) just after the routes for the "Add Book" page—a</code>GET<code>route to initially retrieve the "Edit Book" page's HTML form and a</code>POST` route to process the page’s HTML form submissions:</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb388-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/edit/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb388-2" title="2">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb388-3" title="3">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-4" title="4">    <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-5" title="5">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-edit&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb388-6" title="6">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Edit Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb388-7" title="7">      book<span class="op">,</span></a>
<a class="sourceLine" id="cb388-8" title="8">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb388-9" title="9">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-10" title="10">  <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb388-11" title="11"></a>
<a class="sourceLine" id="cb388-12" title="12"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/edit/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb388-13" title="13">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb388-14" title="14">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-15" title="15">    <span class="kw">const</span> bookToUpdate <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-16" title="16"></a>
<a class="sourceLine" id="cb388-17" title="17">    <span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb388-18" title="18">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb388-19" title="19">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb388-20" title="20">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb388-21" title="21">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb388-22" title="22">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb388-23" title="23">    <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb388-24" title="24"></a>
<a class="sourceLine" id="cb388-25" title="25">    <span class="kw">const</span> book <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb388-26" title="26">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb388-27" title="27">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb388-28" title="28">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb388-29" title="29">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb388-30" title="30">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb388-31" title="31">    <span class="op">};</span></a>
<a class="sourceLine" id="cb388-32" title="32"></a>
<a class="sourceLine" id="cb388-33" title="33">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-34" title="34"></a>
<a class="sourceLine" id="cb388-35" title="35">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb388-36" title="36">      <span class="cf">await</span> <span class="va">bookToUpdate</span>.<span class="at">update</span>(book)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-37" title="37">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-38" title="38">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb388-39" title="39">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-40" title="40">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-edit&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb388-41" title="41">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Edit Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb388-42" title="42">        <span class="dt">book</span><span class="op">:</span> <span class="op">{</span> ...<span class="at">book</span><span class="op">,</span> <span class="dt">id</span><span class="op">:</span> bookId <span class="op">},</span></a>
<a class="sourceLine" id="cb388-43" title="43">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb388-44" title="44">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb388-45" title="45">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb388-46" title="46">    <span class="op">}</span></a>
<a class="sourceLine" id="cb388-47" title="47">  <span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Here’s an overview of the above routes:</p>
<ul>
<li>Just like you did for the "Add Book" page, two routes are defined for the "Edit Book" page—a <code>GET</code> route and a <code>POST</code> route, both with a path of <code>/book/edit/:id(\\d+)</code>. The <code>:id(\\d+)</code> path segment defines the <code>id</code> property in your <code>req.params</code>, the route parameter to capture the book ID to edit. The <code>\\d+</code> segment uses <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions">regexp</a> to ensure that only numbers (or <strong>d</strong>igits) will match this segment.</li>
<li>Within both route handlers, the <code>parseInt()</code> function is used to convert the <code>req.params.id</code> property from a string into an integer.</li>
<li>Within both route handlers, the Sequelize <code>db.Book.findByPk()</code> method uses the book ID to retrieve which book to edit from the database.</li>
<li>Just like in the <code>/book/add</code> route, destructuring is used to declare and initialize the <code>title</code>, <code>author</code>, <code>releaseDate</code>, <code>pageCount</code>, and <code>publisher</code> variables from the <code>req.body</code> property. Those variables are then used to create a <code>book</code> object literal whose properties align with the <code>Book</code> model properties. If there aren’t any validation errors, the object literal is passed into the <code>book.update()</code> method to update the book in the database and the user is redirected to the default route <code>/</code>. If there are validation errors, the <code>book-edit</code> view is re-rendered with the validation errors.</li>
</ul>
<p>When passing the <code>book</code> object into the <code>book-edit</code> view, you can use spread syntax to copy the <code>book</code> object literal properties into a new object. To the right of spreading the <code>book</code> object, an <code>id</code> property is declared and assigned to the <code>bookId</code> variable value:</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb389-1" title="1">book<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb389-2" title="2">  ...<span class="at">book</span><span class="op">,</span></a>
<a class="sourceLine" id="cb389-3" title="3">  <span class="dt">id</span><span class="op">:</span> bookId</a>
<a class="sourceLine" id="cb389-4" title="4"><span class="op">}</span></a></code></pre></div>
<p>The spread syntax above actually creates this <code>book</code> object:</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb390-1" title="1">book<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb390-2" title="2">  title<span class="op">,</span></a>
<a class="sourceLine" id="cb390-3" title="3">  author<span class="op">,</span></a>
<a class="sourceLine" id="cb390-4" title="4">  releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb390-5" title="5">  pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb390-6" title="6">  publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb390-7" title="7">  <span class="dt">id</span><span class="op">:</span> bookId</a>
<a class="sourceLine" id="cb390-8" title="8"><span class="op">}</span></a></code></pre></div>
<h3 id="creating-the-view-for-the-edit-book-page">Creating the view for the Edit Book page</h3>
<p>Add a view to the <code>views</code> folder named <code>book-edit.pug</code> containing the following code:</p>
<pre class="pug"><code>//- ./views/book-edit.pug

extends layout.pug

block content
  if errors
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      ul
        each error in errors
          li= error
  form(action=`/book/edit/${book.id}` method=&#39;post&#39;)
    input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
    div(class=&#39;form-group&#39;)
      label(for=&#39;title&#39;) Title
      input(type=&#39;text&#39; id=&#39;title&#39; name=&#39;title&#39; value=book.title class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;author&#39;) Author
      input(type=&#39;text&#39; id=&#39;author&#39; name=&#39;author&#39; value=book.author class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;releaseDate&#39;) Release Date
      input(type=&#39;text&#39; id=&#39;releaseDate&#39; name=&#39;releaseDate&#39; value=book.releaseDate class=&#39;form-control&#39; placeholder=&#39;ex: 2000-01-31&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;pageCount&#39;) Page Count
      input(type=&#39;text&#39; id=&#39;pageCount&#39; name=&#39;pageCount&#39; value=book.pageCount class=&#39;form-control&#39;)
    div(class=&#39;form-group&#39;)
      label(for=&#39;publisher&#39;) Publisher
      input(type=&#39;text&#39; id=&#39;publisher&#39; name=&#39;publisher&#39; value=book.publisher class=&#39;form-control&#39;)
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Update Book
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<p>This view is almost the same as the view for the "Add Book" page. On the form element’s <code>action</code> attribute and the submit button content are different.</p>
<blockquote>
<p>In just a bit, you’ll see how you can leverage features built into Pug to avoid unnecessary code duplication.</p>
</blockquote>
<h3 id="testing-the-edit-book-page">Testing the Edit Book page</h3>
<p>Run the command <code>npm start</code> to start your application and browse to <code>http://localhost:8080/</code>. Click the "Edit" button for one of the books listed in the table on the "Book List" page to edit that book. Change one or more form field values and click the "Update Book" button to submit the form to the server. You should now see the update book in the list of books on the "Book List" page!</p>
<h3 id="including-view-templates-for-dryer-code">Including view templates for DRYer code</h3>
<p>Currently, the "Add Book" and "Edit Book" views contain very similar code. Pug allows you to <code>include</code> the contents of a template within another template. You can use this feature to eliminate the code duplication between the <code>./views/book-add.pug</code> and <code>./views/book-edit.pug</code> files.</p>
<p>Start by adding a new file named <code>book-form-fields.pug</code> to the <code>views</code> folder containing the following code:</p>
<pre class="pug"><code>//- ./views/book-form-fields.pug

input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
div(class=&#39;form-group&#39;)
  label(for=&#39;title&#39;) Title
  input(type=&#39;text&#39; id=&#39;title&#39; name=&#39;title&#39; value=book.title class=&#39;form-control&#39;)
div(class=&#39;form-group&#39;)
  label(for=&#39;author&#39;) Author
  input(type=&#39;text&#39; id=&#39;author&#39; name=&#39;author&#39; value=book.author class=&#39;form-control&#39;)
div(class=&#39;form-group&#39;)
  label(for=&#39;releaseDate&#39;) Release Date
  input(type=&#39;text&#39; id=&#39;releaseDate&#39; name=&#39;releaseDate&#39; value=book.releaseDate class=&#39;form-control&#39; placeholder=&#39;ex: 2000-01-31&#39;)
div(class=&#39;form-group&#39;)
  label(for=&#39;pageCount&#39;) Page Count
  input(type=&#39;text&#39; id=&#39;pageCount&#39; name=&#39;pageCount&#39; value=book.pageCount class=&#39;form-control&#39;)
div(class=&#39;form-group&#39;)
  label(for=&#39;publisher&#39;) Publisher
  input(type=&#39;text&#39; id=&#39;publisher&#39; name=&#39;publisher&#39; value=book.publisher class=&#39;form-control&#39;)</code></pre>
<p>Then update the <code>book-add.pug</code> and <code>book-edit.pug</code> views to the following code:</p>
<pre class="pug"><code>// ./views/book-add.pug

extends layout.pug

block content
  if errors
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      ul
        each error in errors
          li= error
  form(action=&#39;/book/add&#39; method=&#39;post&#39;)
    include book-form-fields.pug
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Add Book
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<pre class="pug"><code>//- ./views/book-edit.pug

extends layout.pug

block content
  if errors
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      ul
        each error in errors
          li= error
  form(action=`/book/edit/${book.id}` method=&#39;post&#39;)
    include book-form-fields.pug
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Update Book
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<p>Notice the use of the <code>include</code> keyword to include the contents of the <code>book-form-fields.pug</code> template.</p>
<p>Another Pug feature—mixins—allows you to create reusable blocks of Pug code. You can use this Pug feature to further eliminate code duplication.</p>
<p>Add a new file named <code>utils.pug</code> to the <code>views</code> folder containing the following code:</p>
<pre class="pug"><code>//- ./views/utils.pug

mixin validationErrorSummary(errors)
  if errors
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      ul
        each error in errors
          li= error</code></pre>
<p>Notice that the <code>validationErrorSummary</code> mixin defines an <code>errors</code> parameter. As you might expect, mixin parameters allow you to pass data into the mixin.</p>
<p>Next, update the <code>book-add.pug</code> and <code>book-edit.pug</code> views to the following code:</p>
<pre class="pug"><code>// ./views/book-add.pug

extends layout.pug

include utils.pug

block content
  +validationErrorSummary(errors)
  form(action=&#39;/book/add&#39; method=&#39;post&#39;)
    include book-form-fields.pug
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Add Book
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<pre class="pug"><code>//- ./views/book-edit.pug

extends layout.pug

include utils.pug

block content
  +validationErrorSummary(errors)
  form(action=`/book/edit/${book.id}` method=&#39;post&#39;)
    include book-form-fields.pug
    div(class=&#39;py-4&#39;)
      button(type=&#39;submit&#39; class=&#39;btn btn-primary&#39;) Update Book
      a(href=&#39;/&#39; class=&#39;btn btn-warning ml-2&#39;) Cancel</code></pre>
<p>Notice the use of the <code>include</code> keyword again to include the contents of the <code>utils.pug</code> template which makes the <code>validationErrorSummary</code> mixin available within the <code>book-add.pug</code> and <code>book-edit.pug</code> templates. The mixin is called by prefixing the mixin name with a plus sign (<code>+</code>) and adding a set of parentheses after the mixin name. Inside of the parentheses, the <code>errors</code> variable is passed as an argument to the <code>validationErrorSummary</code> mixin.</p>
<p>You can go a bit further to eliminate more code duplication. Update the <code>./views/utils.pug</code> template to contain the following code:</p>
<pre class="pug"><code>//- ./views/utils.pug

mixin validationErrorSummary(errors)
  if errors
    div(class=&#39;alert alert-danger&#39; role=&#39;alert&#39;)
      p The following error(s) occurred:
      ul
        each error in errors
          li= error

mixin textField(labelText, fieldName, fieldValue, placeholder)
  div(class=&#39;form-group&#39;)
    label(for=fieldName)= labelText
    input(type=&#39;text&#39; id=fieldName name=fieldName value=fieldValue class=&#39;form-control&#39; placeholder=placeholder)</code></pre>
<p>Then update the <code>./views/book-form-fields.pug</code> template to contain this code:</p>
<pre class="pug"><code>//- ./views/book-form-fields.pug

include utils.pug

input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
+textField(&#39;Title&#39;, &#39;title&#39;, book.title)
+textField(&#39;Author&#39;, &#39;author&#39;, book.author)
+textField(&#39;Release Date&#39;, &#39;releaseDate&#39;, book.releaseDate, &#39;ex: 2000-01-31&#39;)
+textField(&#39;Page Count&#39;, &#39;pageCount&#39;, book.pageCount)
+textField(&#39;Publisher&#39;, &#39;publisher&#39;, book.publisher)</code></pre>
<p>Run the command <code>npm start</code> to start your application and browse to <code>http://localhost:8080/</code>. Use the "Add Book" page to add a new book and then use the "Edit Book" page to edit the book. Everything should work as it did before the refactoring of the view code.</p>
<p>Congratulations on making your code DRYer!</p>
<h2 id="add-the-delete-book-page">Add the Delete Book page</h2>
<p>The next page that you’ll add to the Reading List application is the "Delete Book" page. This page is relatively simple as it only needs to prompt the user if the selected book is the book that they want to delete.</p>
<h3 id="defining-the-routes-for-the-delete-book-page">Defining the routes for the Delete Book page</h3>
<p>Add the routes for the "Delete Book" page to the <code>routes</code> module (i.e. the <code>./routes.js file) just after the routes for the "Edit Book" page—a</code>GET<code>route to initially retrieve the "Delete Book" page's HTML form and a</code>POST` route to process the page’s HTML form submissions:</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb400-1" title="1"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/book/delete/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb400-2" title="2">  <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb400-3" title="3">  <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb400-4" title="4">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-delete&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb400-5" title="5">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Delete Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb400-6" title="6">    book<span class="op">,</span></a>
<a class="sourceLine" id="cb400-7" title="7">    <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb400-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb400-9" title="9"><span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb400-10" title="10"></a>
<a class="sourceLine" id="cb400-11" title="11"><span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/book/delete/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb400-12" title="12">  <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb400-13" title="13">  <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb400-14" title="14">  <span class="cf">await</span> <span class="va">book</span>.<span class="at">destroy</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb400-15" title="15">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb400-16" title="16"><span class="op">}</span>))<span class="op">;</span></a></code></pre></div>
<p>Here’s an overview of the above routes:</p>
<ul>
<li>Just like you did for the "Add Book" and "Edit Book" pages, two routes are defined for the "Delete Book" page—a <code>/book/delete/:id(\\d+)</code> <code>GET</code> route and a <code>/book/delete/:id(\\d+)</code> <code>POST</code> route.</li>
<li>Within both route handlers, the <code>parseInt()</code> function is used to convert the <code>req.params.id</code> property string value into a <code>number</code>.</li>
<li>Within both route handlers, the Sequelize <code>db.Book.findByPk()</code> method is used to retrieve the book to delete from the database.</li>
<li>Within the <code>POST</code> route handler, the <code>book.destroy()</code> method is called to delete the book from the database and the user is redirected to the default route (<code>/</code>).</li>
</ul>
<h3 id="creating-the-view-for-the-delete-book-page">Creating the view for the Delete Book page</h3>
<p>Add a view to the <code>views</code> folder named <code>book-delete.pug</code> containing the following code:</p>
<pre class="pug"><code>//- ./views/book-delete.pug

extends layout.pug

block content
  h3= book.title
  div(class=&#39;py-4&#39;)
    p Proceed with deleting this book?
  div
    form(action=`/book/delete/${book.id}` method=&#39;post&#39;)
      input(type=&#39;hidden&#39; name=&#39;_csrf&#39; value=csrfToken)
      button(class=&#39;btn btn-danger&#39; type=&#39;submit&#39;) Delete Book
      a(class=&#39;btn btn-warning ml-2&#39; href=&#39;/&#39; role=&#39;button&#39;) Cancel</code></pre>
<p>The purpose of this view is simple: display the title of the book that’s about to be deleted and render a simple form containing a hidden <code>&lt;input&gt;</code> element for the CSRF token and a <code>&lt;button&gt;</code> element to submit the form.</p>
<h3 id="testing-the-delete-book-page">Testing the Delete Book page</h3>
<p>Run the command <code>npm start</code> to start your application and browse to <code>http://localhost:8080/</code>. Click the "Delete" button for one of the books listed in the table on the "Book List" page to delete that book. On the "Delete Book" page, click the "Delete Book" button to delete the book. You should now see that the book has been removed from the list of books on the "Book List" page!</p>
<h2 id="what-you-learned-12">What you learned</h2>
<p>In this article, you learned how to:</p>
<ul>
<li>Define a collection of routes and views that use Sequelize to perform CRUD operations against a single resource; and</li>
<li>Handle Sequelize validation errors when users are attempting to create or update data and display error messages to the user so that they can resolve any data quality issues.</li>
</ul>
<p>You also reviewed the following:</p>
<ul>
<li>Using a wrapper function to catch errors thrown within asynchronous route handler functions;</li>
<li>Using Pug to create HTML forms;</li>
<li>Using the <code>csurf</code> middleware to protect against CSRF exploits;</li>
<li>Using the built-in <code>express.urlencoded()</code> middleware function to parse incoming request body form data;</li>
<li>Using Sequelize model validations to validate user-provided data;</li>
<li>Using the <code>express-validator</code> validation library to validate user-provided data within an Express route; and</li>
<li>Using Pug includes and mixins to remove unnecessary code duplication.</li>
</ul>
</body></html>
