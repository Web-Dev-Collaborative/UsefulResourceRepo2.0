<p># Tutorials for AWS services</p>
<p>We have covered the most popular AWS Services:</p>
<ul>
<li><a href="#ec2setup">AWS Elastic Cloud Compute (EC2)</a></li>
<li><a href="#s3-static-website-hosting">AWS Simple Storage Solution (S3() Static Website Hosting</a></li>
<li><a href="#rds">Amazon Relational Database System (RDS)</a></li>
<li><a href="https://github.com/dwyl/learn-amazon-web-services/blob/master/ses.md">Amazon Simple Email Service (SES)</a></li>
</ul>
<p><br /></p>
<h2 id="ec2setup">EC2Setup</h2>
<p>Documenting/sharing how I get an EC2 instance up and running.</p>
<p>This whole process takes about 20 mins including creating an AWS account. (I recommend creating a new email address and brand new amazon account to take full advantage of AWS “free tier” so you don’t pay while you play!)</p>
<p>As always, if you have questions, <a href="https://github.com/dwyl/learn-amazon-web-services/issues/new">raise an issue</a>! :sparkles:</p>
<h3 id="register-for-an-amazon-webservices-account">Register for an Amazon Webservices Account</h3>
<p>If you don’t already have an Amazon Web Services (AWS) account you will need to register for one: http://aws.amazon.com and click the <strong>Sign Up</strong> button.</p>
<p><strong>Note</strong>: Signup will ask you for <strong>credit card</strong> details, don’t worry you won’t be charged anything if you stay within the <a href="http://aws.amazon.com/free/">http://aws.amazon.com/free/</a> (this includes a <strong>Free</strong> <em>Micro</em> Instance)</p>
<p>Once you have registered for AWS, login via: http://aws.amazon.com/console/ You will see all the AWS services available to you.</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063290-97479866-6628-11e7-8a57-7d71c97419fa.png" alt="AWS Console" /><figcaption>AWS Console</figcaption>
</figure>
<p>Click on <strong>EC2</strong> (Elastic Cloud Compute)</p>
<h3 id="add-your-ssh-keys-to-aws">Add your SSH Keys to AWS</h3>
<p>To access your EC2 instance via the command line you will need to let AWS know what key you want to use to access it.</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063289-9746d052-6628-11e7-8081-356b54e3e6ae.png" alt="AWS Add Keypair" /><figcaption>AWS Add Keypair</figcaption>
</figure>
<p>If you don’t have any knowledge of SSH or public/private keys, don’t worry, its pretty simple.</p>
<p>Follow this tutorial: http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html</p>
<h3 id="security-group-definitions">Security Group Definitions</h3>
<p>In the left column/menu click on <strong>Security Groups</strong> and confirm your <strong>default</strong> security profile allows inbound traffic on TCP <strong>Port 22</strong> (SSH) and <strong>80</strong> (http) (by default these ports aren’t open, you need to add them)</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063555-5c709372-6629-11e7-9d50-de1207e70c21.png" alt="AWS Create Security Group" /><figcaption>AWS Create Security Group</figcaption>
</figure>
<p>I only added ports 22 and 80 for this simple setup, <img src="https://user-images.githubusercontent.com/22300773/28063554-5c707978-6629-11e7-99b1-78aaa7ef9088.png" alt="AWS TCP Port Rules Defined" /></p>
<p>but to run other node.js processes on your server e.g. for MongoExpress or RedisAdmin you need to open these here in the Security Group/Profile.</p>
<h3 id="create-ec2-instance">Create EC2 Instance</h3>
<p>Setting up an ec2 can be daunting the first time. Don’t worry, the defaults are sensible and if you get stuck there is always help available! :-)</p>
<p>e.g: http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html</p>
<h4 id="launch-instance-wizard">Launch Instance Wizard</h4>
<p>Click <strong>Instances</strong> in the left column/menu and then click <strong>Launch Instance</strong>: <img src="https://user-images.githubusercontent.com/22300773/28063661-c833d2d6-6629-11e7-850c-28029f8ebcfe.png" alt="AWS EC2 Launch" /></p>
<h4 id="pick-an-amazon-machine-image">Pick an Amazon Machine Image</h4>
<p>Select an Amamzon Machine Image (AMI) from the list of available AMIs:</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063676-d8217d60-6629-11e7-9272-b96e83ab8232.png" alt="AWS Choose an AMI" /><figcaption>AWS Choose an AMI</figcaption>
</figure>
<p>I recommend choosing a <em>bare-bones</em> Ubuntu Image for two reasons: - You don’t get any <em>LAMP</em> Cruft bundled in - Ubuntu is a very beginner friendly Linux distro and has the most (answered) FAQ questions if you get stuck!</p>
<h4 id="select-instance-type">Select Instance Type</h4>
<p>Keep the default <strong>Micro</strong> instance.</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063704-fbcb35f8-6629-11e7-9579-3cb01011a95e.png" alt="AWS micro" /><figcaption>AWS micro</figcaption>
</figure>
<h4 id="select-the-default-security-group">Select the Default Security Group</h4>
<p>Select the Default Security Group (the one we edited above):</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063774-38b81f12-662a-11e7-940a-62cc7ee072eb.png" alt="AWS Security Group" /><figcaption>AWS Security Group</figcaption>
</figure>
<h4 id="review-and-launch">Review and Launch</h4>
<p>Go over everything one last time and click <strong>Launch</strong> <img src="https://user-images.githubusercontent.com/22300773/28063850-742e4134-662a-11e7-9bb4-303fdd6664e1.png" alt="AWS Review and Launch" /></p>
<h4 id="select-the-key">Select the Key</h4>
<p>After launch you will be prompted to select a key.</p>
<p>Select the Key you imported earlier (so you can access the instance from SSH):</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063873-8588371e-662a-11e7-89aa-5ce980e27cd8.png" alt="AWS Select Key" /><figcaption>AWS Select Key</figcaption>
</figure>
<h4 id="confirm-the-instance-is-running">Confirm the Instance is Running</h4>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28063940-c1baaff0-662a-11e7-99d0-1642c3511111.png" alt="AWS instance running" /><figcaption>AWS instance running</figcaption>
</figure>
<h3 id="connecting-to-your-instance-via-ssh-terminalconsole">Connecting to your instance via SSH (Terminal/Console)</h3>
<p>Make sure that your instance is selected and click connect. Copy the example command from the dialogue, replacing <code>"&lt;YOUR-KEY-NAME&gt;.pem"</code> with the full path to your key:</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28024954-fc8ed65c-6589-11e7-91dd-6abfed4da36b.png" alt="AWS ssh dialogue" /><figcaption>AWS ssh dialogue</figcaption>
</figure>
<h3 id="install-node.js">Install Node.js</h3>
<p>Mercifully you no longer need to compile node.js from source (the good old days ;-) Now there is a <a href="https://github.com/creationix/nvm">great package</a> that allows you to install any version of Node with just a few commands:</p>
<p>Install NVM:</p>
<pre class="terminal"><code>curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash</code></pre>
<p>Install the latest version of Node:</p>
<pre class="terminal"><code>nvm install node</code></pre>
<p>Once that’s installed update NPM:</p>
<pre class="terminal"><code>npm i -g npm</code></pre>
<h3 id="redirect-calls-to-port-80">Redirect Calls To Port 80</h3>
<p>When installed with NVM Node doesn’t have access to port 80 (ports under 1024 need root access). To fix this we’ll need to redirect all traffic going to port 80 to 3000:</p>
<pre class="terminal"><code>sudo iptables -t nat -I PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3000</code></pre>
<h3 id="create-a-simple-node.js-http-server">Create A Simple Node.js HTTP Server</h3>
<pre class="terminal"><code>nano app.js</code></pre>
<p>This will bring up <code>nano</code> which is a simple in terminal text editor!</p>
<p>paste in a simple http app:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">var</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;http&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">var</span> port <span class="op">=</span> <span class="dv">3000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">var</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>(<span class="kw">function</span> (request<span class="op">,</span> response) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="va">response</span>.<span class="at">writeHead</span>(<span class="dv">200</span><span class="op">,</span> <span class="op">{</span><span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;text/plain&quot;</span><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="va">response</span>.<span class="at">end</span>(<span class="st">&quot;Node.js HTTP Server Running on Amazon EC2!</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="op">}</span>).<span class="at">listen</span>(port)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-8" title="8"></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Node HTTP Server running on &quot;</span><span class="op">+</span>port)<span class="op">;</span></a></code></pre></div>
<p>On linux this will be done with <code>shift + ctrl + v</code>, on mac it will be with <code>cmd + v</code>.</p>
<p>Once you’ve pasted this in you can exit by pressing <code>ctrl + x</code>, you will be prompted to save the file.</p>
<p>Type <code>y</code> to say yes to saving your changes, and then nano will allow you to edit the name of the file you write out to. Leave the file name as is and press <code>enter</code>.</p>
<p>Then, start the app:</p>
<pre class="terminal"><code>node app</code></pre>
<p>Now visit the IP address corresponding to your instance:</p>
<p>mine was: http://54.229.220.192</p>
<p>[node server running]</p>
<p><strong>Note</strong>: your IP address will be different</p>
<p>You can get it by going to your AWS console page, going to your EC2 instances and looking at the “IPv4 Public IP” section of the instance we just created.</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28064323-0b993c44-662c-11e7-8c8b-15297794e252.png" alt="screenshot highlighting where to find Public IPv4 in AWS console" /><figcaption>screenshot highlighting where to find Public IPv4 in AWS console</figcaption>
</figure>
<h3 id="random-tips">Random Tips</h3>
<p>If you get the error: <strong>Write failed: Broken pipe</strong> you need to keep the connection to the server alive. To resolve this, open your ssh config file:</p>
<pre class="terminal"><code>nano ~/.ssh/config</code></pre>
<p>and add the following lines:</p>
<pre><code>ServerAliveInterval 120
TCPKeepAlive yes</code></pre>
<h2 id="s3-static-website-hosting">S3 Static Website Hosting</h2>
<p>An S3 bucket can be used to host a static website.</p>
<ol type="1">
<li>Start by creating a new S3 bucket in the AWS S3 console.</li>
</ol>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28064428-904e9a6a-662c-11e7-88ef-f343cf7566b2.png" alt="Create S3 bucket" /><figcaption>Create S3 bucket</figcaption>
</figure>
<ol start="2" type="1">
<li><p>Select the ‘Properties’ tab. Click ‘Static web hosting’ and in the Index Document box add the name of the html file that will be your home page.</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28064534-f66d343c-662c-11e7-879e-66b39eebcf1c.png" alt="Static web hosting" /><figcaption>Static web hosting</figcaption>
</figure>
<p>Click Save. Note down the endpoint for your website. It will be of the form :</p>
<p><code>http://[bucket-name].s3-website-[region].amazonaws.com</code></p></li>
<li><p>Select the permissions tab. We need to add a bucket policy that make the bucket content public so the website endpoint can show the website files.</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28064676-7e462bde-662d-11e7-8ee6-c78f7b0aded5.png" alt="permissions 1" /><figcaption>permissions 1</figcaption>
</figure>
<p>Click ‘Add Bucket Policy’ and paste in the following policy:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="st">&quot;Version&quot;</span><span class="op">:</span><span class="st">&quot;2012-10-17&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb10-3" title="3">  <span class="st">&quot;Statement&quot;</span><span class="op">:</span>[<span class="op">{</span></a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="st">&quot;Sid&quot;</span><span class="op">:</span><span class="st">&quot;PublicReadForGetBucketObjects&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb10-5" title="5">        <span class="st">&quot;Effect&quot;</span><span class="op">:</span><span class="st">&quot;Allow&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb10-6" title="6">      <span class="st">&quot;Principal&quot;</span><span class="op">:</span> <span class="st">&quot;*&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb10-7" title="7">      <span class="st">&quot;Action&quot;</span><span class="op">:</span>[<span class="st">&quot;s3:GetObject&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb10-8" title="8">      <span class="st">&quot;Resource&quot;</span><span class="op">:</span>[<span class="st">&quot;arn:aws:s3:::example-bucket/*&quot;</span></a>
<a class="sourceLine" id="cb10-9" title="9">      ]</a>
<a class="sourceLine" id="cb10-10" title="10">    <span class="op">}</span></a>
<a class="sourceLine" id="cb10-11" title="11">  ]</a>
<a class="sourceLine" id="cb10-12" title="12"><span class="op">}</span></a></code></pre></div>
<p>Replace ‘example-bucket’ with the name of your bucket.</p></li>
<li><p>Upload the index document and other files for your website.</p>
<figure>
<img src="https://user-images.githubusercontent.com/22300773/28064703-98be1a44-662d-11e7-8218-2b9d8ff49d8d.png" alt="upload" /><figcaption>upload</figcaption>
</figure></li>
<li><p>Test the website by entering the website URL in the browser!</p>
<p>The uploading of files can be incorporated into your continuous integration process. <strong>NB the names of the files need to be versioned to prevent the cached version being displayed after an update.</strong></p></li>
</ol>
<h2 id="rds">RDS</h2>
<p>This guide will show you how to set up a Postgresql instance on AWS RDS, either standard, or <a href="https://aws.amazon.com/rds/aurora/">Aurora</a>, but should mostly apply to all the engines available on RDS.</p>
<p>Go to Services &gt; RDS. If you haven’t used RDS yet, click on <code>Get Started</code>, if you have, scroll down to the <code>Create Instance</code> box and select <code>Launch a DB Instance</code>.</p>
<p>Note that the region displayed in the top right of your screen is the region your database will be located in. If you need to comply with the EU’s GDPR, make sure your region is set to one in the EU: https://aws.amazon.com/compliance/eu-data-protection/</p>
<p><img width="750" alt="AWS Region" src="https://user-images.githubusercontent.com/8939909/32607172-e53507b2-c54f-11e7-845f-657cf60992d8.png"></p>
<p>Select <code>Postgresql</code> and click <code>Next</code>. When asked to choose your use case, for now select Dev/Test. This will populate the defaults for the next section with those eligible for the <code>free tier</code>, but you can upgrade them if you wish. (Note, <code>Aurora</code> does not have a free tier).</p>
<p>At the next step, if you’re just getting started with RDS, check the box that says <code>Only enable options eligible for RDS Free Usage Tier</code>. This will select an instance class of db.t2.micro, with allocated storage of 20GB. These can easily be updated later if you need to.</p>
<p><img width="500" alt="AWS Free Tier checkbox" src="https://user-images.githubusercontent.com/8939909/32607260-3c4ea710-c550-11e7-98a1-99093dd3a16a.png"></p>
<p>In <code>Settings</code>, choose a name for your instance, a master username and password. These are what you’ll use to connect to the database.</p>
<p>On the next screen, <code>Configure advanced settings</code>, if the server you need to connect with the database is also hosted on AWS, select the VPC your server is running in. If your server is hosted elsewhere, you can leave the VPC as the default, and change <code>Public Accessibility</code> to <code>Yes</code>.</p>
<p>To initialise your instance with a database, provide the desired name on the database to create in the <code>Database options</code> section. You can then set your encryption, backup, monitoring and maintenance settings to your preference and create your instance by clicking <code>Launch DB Instance</code>, and in a few minutes your database instance will be ready to use.</p>
<p>To connect to your database from a server outside of the VPC it’s in, you’ll need to edit the security group linked to the instance. To find the security group, look at the <code>Connect</code> box on the instance details.</p>
<p><img width="750" alt="AWS Connect details" src="https://user-images.githubusercontent.com/8939909/32607452-05715bc4-c551-11e7-918d-1b5641a14569.png"></p>
<p>Once you know the security group, go to Services &gt; EC2, and select <code>Security Groups</code> from the <code>Network &amp; Security</code> section on the sidebar. Then select the security group and the <code>Inbound</code> tab. Add an Inbound rule of type PostgreSQL, protocol TCP, port 5432 (or the port your database is using if you changed the default) and Source of the IP address your server is on, or 0.0.0.0/0 to allow inbound access from anywhere (the correct credentials will still be required to connect).</p>
<h3 id="migrating-to-rds-from-heroku">Migrating to RDS from Heroku</h3>
<p>If you’re migrating your data from heroku postgres, you should first set your heroku app to maintenance mode, to ensure no data is added and subsequently lost while you’re migrating.</p>
<p>Once the app is in maintenance mode, create a backup of your data by going to your Postgres add on on heroku, then selecting <code>Durability</code> and <code>Capture Backup</code>.</p>
<p>Once the backup is complete, you’ll need to access heroku on the command line: https://devcenter.heroku.com/categories/command-line.</p>
<p>Run the command <code>heroku pg:backups:download -o {app-name}.dump -a {app-name}</code> where <code>app-name</code> is the name of your heroku app. This will download the backup you’ve just created.</p>
<p>Then to import the data into your new AWS RDS database run:</p>
<p><code>pg_restore -v -h {rds-endpoint} -U {username} -d {database-name} {app-name}.dump</code></p>
<p>and enter the instance master user’s password when prompted. The RDS endpoint can be found by selecting your instance on the RDS dashboard and scrolling down to the <code>Connect</code> box (as shown in the section above).</p>
<p>Your data should now have been migrated to RDS, the only thing left to do is switch the databases over. If you’re using the <code>DATABASE_URL</code> config variable on Heroku, you need to detach your current database before you can change it.</p>
<p>Unfortunately, detaching the database destroys it and everything in it. To avoid this, you can first by first running the command:</p>
<p><code>heroku addons:attach {database-addon-name} --as backup_db -a {app-name}</code>.</p>
<p>To find your database addon name, run <code>heroku addons</code> on your command line; The database name is in brackets after <code>heroku-postgresql</code>. (Here, it’s <code>postgresql-metric-95269</code>.)</p>
<p><img width="526" alt="screen shot 2018-05-10 at 15 27 39" src="https://user-images.githubusercontent.com/8939909/39874806-c7ca7486-5466-11e8-9b95-f84f1663212e.png"></p>
<p>Once this is done, run <code>heroku addons:detach DATABASE -a {app-name}</code>, then add your new url: <code>heroku config:set DATABASE_URL=postgres://{username}:{password}@{aws-rds-host}:5432/{dbname}</code>.</p>
<p>If you’re using other environment variables for your database connection (for example <code>PGHOST</code>, <code>PGUSER</code> etc.), make sure to update those too.</p>
<h2 id="notes">Notes</h2>
<ul>
<li>Install Node.js on Ubuntu: https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager#ubuntu-mint</li>
<li>SSH Keep Alive: http://stackoverflow.com/questions/13228425/write-failed-broken-pipe</li>
<li>More detail: http://unix.stackexchange.com/questions/34004/how-does-tcp-keepalive-work-in-ssh</li>
<li>Simple Node Server: http://howtonode.org/hello-node</li>
<li>EC2 Guide: http://aws.amazon.com/documentation/ec2/</li>
<li>S3: Setting up a static website: http://docs.aws.amazon.com/AmazonS3/latest/dev/HostingWebsiteOnS3Setup.html</li>
</ul>
