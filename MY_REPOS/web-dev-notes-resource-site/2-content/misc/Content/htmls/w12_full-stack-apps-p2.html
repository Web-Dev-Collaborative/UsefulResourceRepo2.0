<!DOCTYPE html><html><head>
      <title>w12_full-stack-apps-p2</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\almyk\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.5.13\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header undefined" id="week-12brfull-stack-applications-part-2">WEEK 12<br><em>Full-Stack Applications (Part 2)</em></h1>

<hr>
<p><a href="#your-first-group-project"><em>Your First Group Project</em></a></p>
<ul>
<li><a href="#setting-up-your-groups-project-repository">Setting Up Your Group&apos;s Project Repository</a></li>
</ul>
<p><a href="#authentication-learning-objectives"><strong>Authentication Learning Objectives</strong></a></p>
<ul>
<li><a href="#using-bcrypt-to-hash-passwords"><strong>Using Bcrypt to Hash Passwords</strong></a>
<ul>
<li><a href="#what-is-cryptography">What is cryptography?</a></li>
<li><a href="#what-is-hashing">What is hashing?</a></li>
<li><a href="#using-bcrypt-to-hash-user-passwords">Using Bcrypt to hash user passwords</a></li>
</ul>
</li>
<li><a href="#configuring-sessions-in-express"><strong>Configuring Sessions in Express</strong></a>
<ul>
<li><a href="#overview-of-sessions">Overview of sessions</a></li>
<li><a href="#configuring-express-to-use-sessions">Configuring Express to use sessions</a></li>
<li><a href="#setting-and-accessing-session-values">Setting and accessing session values</a></li>
<li><a href="#session-store-configuration">Session store configuration</a></li>
<li><a href="#securing-the-session-http-cookie">Securing the session HTTP cookie</a></li>
</ul>
</li>
<li><a href="#implementing-session-based-authentication"><strong>Implementing Session-Based Authentication</strong></a>
<ul>
<li><a href="#overview-of-authentication-and-authorization">Overview of authentication and authorization</a></li>
<li><a href="#supporting-user-self-registration">Supporting user self-registration</a></li>
<li><a href="#supporting-user-login">Supporting user login</a></li>
<li><a href="#persisting-user-login-state">Persisting user login state</a></li>
<li><a href="#restoring-the-authenticated-user-from-session">Restoring the authenticated user from session</a></li>
<li><a href="#protecting-a-route">Protecting a route</a></li>
<li><a href="#associating-data-with-a-user">Associating data with a user</a></li>
<li><a href="#the-importance-of-using-https">The importance of using HTTPS</a></li>
<li><a href="#next-steps">Next steps</a></li>
</ul>
</li>
<li><a href="#project-amusement-park-tracker-with-authentication"><em>Project: Amusement Park Tracker with Authentication</em></a></li>
</ul>
<p><a href="#application-programming-interfaces-learning-objectives"><strong>Application Programming Interfaces Learning Objectives</strong></a></p>
<ul>
<li><a href="#getting-started-with-restful-endpoints"><strong>Getting Started With RESTful Endpoints</strong></a>
<ul>
<li><a href="#rules-of-rest">Rules of ReST</a></li>
<li><a href="#what-does-a-restful-api-look-like">What does a RESTful API look like?</a></li>
<li><a href="#designing-your-api">Designing your API</a></li>
<li><a href="#github-api-example">GitHub API example</a></li>
<li><a href="#restful-vs-remote-procedure-calls-rpc">RESTful vs remote procedure calls (RPC)</a></li>
</ul>
</li>
<li><a href="#express-apis"><strong>Express APIs</strong></a>
<ul>
<li><a href="#project-setup">Project setup</a></li>
<li><a href="#set-up-the-task-model">Set up the Task model</a></li>
<li><a href="#initial-router-setup">Initial router setup</a></li>
<li><a href="#global-error-handling">Global error handling</a></li>
<li><a href="#reading-all-tasks">Reading all tasks</a></li>
<li><a href="#create-a-task">Create a task</a></li>
<li><a href="#read-a-task">Read a task</a></li>
<li><a href="#update-a-task">Update a task</a></li>
<li><a href="#delete-a-task">Delete a task</a></li>
</ul>
</li>
<li><a href="#cross-origin-resource-sharing-cors"><strong>Cross-Origin Resource Sharing (CORS)</strong></a>
<ul>
<li><a href="#why-cors">Why CORS</a></li>
<li><a href="#setting-up-cors">Setting up CORS</a></li>
<li><a href="#preflighted-requests">Preflighted requests</a></li>
<li><a href="#setting-up-cors-for-the-entire-api">Setting up CORS for the entire API</a></li>
</ul>
</li>
<li><a href="#twitter-lite-project"><em>Twitter Lite Project</em></a></li>
<li><a href="#twitter-lite-project-with-authentication"><em>Twitter Lite Project... with Authentication!</em></a></li>
</ul>
<p><a href="#api-security-learning-objectives"><strong>API Security Learning Objectives</strong></a></p>
<ul>
<li><a href="#oauth-20"><strong>OAuth 2.0</strong></a>
<ul>
<li><a href="#high-level-overview-of-oauth-20">High level overview of OAuth 2.0</a></li>
<li><a href="#getting-your-app-ready-for-oauth-20">Getting your app ready for OAuth 2.0</a></li>
<li><a href="#oauth-20-in-detail">OAuth 2.0 in detail</a></li>
</ul>
</li>
<li><a href="#token-based-authentication"><strong>Token-Based Authentication</strong></a>
<ul>
<li><a href="#json-web-token-jwt">JSON Web Token (JWT)</a></li>
<li><a href="#setting-up-token-based-authentication">Setting up token-based authentication</a></li>
</ul>
</li>
</ul>
<hr>
<hr>
<h1 class="mume-header undefined" id="week-12-day-1brproject-planning">WEEK-12 DAY-1<br><em>Project Planning</em></h1>

<hr>
<h1 class="mume-header" id="your-first-group-project">Your First Group Project</h1>

<p>This is a big thing! You&apos;re getting ready to start work on your first big<br>
project to become the first entry in your portfolio for interviewing and<br>
showcasing. After you get your team together, you need to choose a project and,<br>
then, start doing some analysis.</p>
<h2 class="mume-header" id="the-groundwork">The groundwork</h2>

<p>Somebody set up the group project repositories, one for the front-end and one<br>
for the backend. In those repositories, create a <strong>documentation</strong> directory<br>
with two subdirectories: <strong>feature-list</strong> and <strong>feature-packets</strong>.</p>
<p>Now, it&apos;s important to note:</p>
<p><strong>THERE IS NOT A DEDICATED BACKEND TEAM NOR A DEDICATED FRONTEND TEAM</strong>.</p>
<p>Your workflow will be: as a pair, choose a feature that you want to complete,<br>
and then do that from front to back, UI to database. That is the good way to do<br>
things.</p>
<h2 class="mume-header" id="choosing-a-project">Choosing a Project</h2>

<p>This project is meant to challenge you and your team to build something from the<br>
ground up. You&apos;ve had practice using the tools of PostgreSQL, Sequelize, and npm<br>
to create skeleton projects. Then, you&apos;ve installed packages like Express.js<br>
and Pug.js to get your framework in place. Now, you can bring all of that to<br>
bear in this first, big application.</p>
<p>You will pick one of the following options to clone.</p>
<ul>
<li><a href="http://www.bandcamp.com">Bandcamp</a></li>
<li><a href="http://www.goodreads.com">Goodreads</a></li>
<li><a href="http://www.medium.com">Medium</a></li>
<li><a href="https://www.producthunt.com/">Product Hunt</a></li>
<li><a href="https://www.rememberthemilk.com/">Remember the Milk</a></li>
<li><a href="http://www.stackoverflow.com">Stack Overflow</a></li>
<li><a href="http://www.teawithstrangers.com/">TeaWithStrangers</a></li>
<li><a href="http://www.quora.com">Quora</a></li>
<li><a href="http://www.yelp.com">Yelp</a></li>
</ul>
<p>These projects were chosen because they allow you to focus on basic CRUD actions rather than complicated front-end features like infinite scroll and single-page apps. Remember that this project is focused on express and we have not yet taught you a front-end framework so you&apos;ll be limited to vanilla javascript.</p>
<h2 class="mume-header" id="the-feature-list">The feature list</h2>

<p>Once you have picked a project, spend time with your team figuring out the<br>
features that you want your application to have. Ask yourselves</p>
<ul>
<li>What features are needed to make this an application that people would use?</li>
<li>What features would be nice to have if the minimum viable product gets<br>
finished?</li>
<li>Will these features demonstrate everything we&apos;ve learned during the first<br>
half of the course?</li>
</ul>
<p>Try to create the feature list from the perspective of the person who will be<br>
using your application. You can see examples of that in our example repository.</p>
<p>Save this feature list in the <strong>feature-list</strong> subdirectory of the<br>
<strong>documentation</strong> directory of the team&apos;s repository.</p>
<h2 class="mume-header" id="feature-scoping">Feature scoping</h2>

<p>Post your feature scoping list to the Slack channel and tag the instructors.<br>
They will work with you to help you determine what is a good amount of work for<br>
your MVP and, then, for your stretch goals.</p>
<h2 class="mume-header" id="feature-packets">Feature packets</h2>

<p>Once your team knows what is the MVP, work on the feature packets. Create a new<br>
Markdown document for each feature for your MVP. In it, include the following<br>
documentation:</p>
<ul>
<li>Models needed</li>
<li>Endpoints needed</li>
<li>Templates needed</li>
<li>Wire frames or sketches</li>
</ul>
<p>This will help guide the team&apos;s development efforts.</p>
<h2 class="mume-header" id="code-code-code">Code, code, code!</h2>

<p>Once those are done, your team is set up for success! Determine whether you want<br>
to work on features together, one at a time, or have pairs work on features<br>
together, or if everyone in the group gets their own feature.</p>
<p>Be smart about your Git workflow. Create branches, commit to them, then create<br>
Pull Requests on GitHub to let others see your changes.</p>
<p>Coordinate many times per day so everyone knows what&apos;s going on.</p>
<p>Keep up the communication.</p>
<p>Don&apos;t let someone fail. This is a team effort.</p>
<h2 class="mume-header" id="evaluating-your-completion">Evaluating your completion</h2>

<p>Full-stack projects will be evaluated against the following &quot;Minimal Viable<br>
Product&quot; features.</p>
<ol>
<li>New account creation, login, and guest/demo login</li>
<li>A production README file for your GitHub repository containing
<ul>
<li>Brief explanation of what the app is and does</li>
<li>Link to live site</li>
<li>Discussion of technologies used</li>
<li>Discussion of two features that show off the team&apos;s technical abilities</li>
<li>Discussion of both challenges faced and the way the team solved them</li>
<li>Code snippets to highlight the best code</li>
</ul>
</li>
<li>Hosting on Heroku (you&apos;ll get instructions next week)</li>
<li>For four features:
<ul>
<li>Adequate styling</li>
<li>Smooth, bug-free navigation</li>
<li>Adequate and appropriate seed data to demonstrate the feature</li>
</ul>
</li>
</ol>
<p>In order for this to be considered complete, you must have the first three<br>
criteria completed. In addition to that, you will also need to have four of your<br>
features demonstrating the checklist under item 4. After the following section<br>
is a list of required features if you decide to clone one of the sites from the<br>
list above.</p>
<h2 class="mume-header" id="show-and-tell">Show and tell</h2>

<p>Instead of an assessment on the following Monday, each team will demonstrate<br>
what they&apos;ve been able to accomplish! This type of demonstration normally occurs<br>
in real software development shops after a sprint ends. That&apos;s what you&apos;ll be<br>
doing: showing what you&apos;ve been able to accomplish in such a short amount of<br>
time!</p>
<h2 class="mume-header" id="required-features-for-approved-clones">Required Features for Approved Clones</h2>

<p>If you decide to do a direct clone of the one of the sites above, here are the<br>
four minimum features that you must implement for each of the choices.</p>
<h4 class="mume-header" id="bandcamp">Bandcamp</h4>

<ul>
<li>Artist page</li>
<li>Song player</li>
<li>Search</li>
<li>Upload/download songs</li>
<li><strong>Bonus</strong>: Purchase songs</li>
<li><strong>Bonus</strong>: Follows</li>
</ul>
<h4 class="mume-header" id="goodreads">Goodreads</h4>

<ul>
<li>Books</li>
<li>Bookshelves</li>
<li>Reviews</li>
<li>Read Status (will read, have read, etc.)</li>
<li><strong>Bonus</strong>: Search across multiple models</li>
<li><strong>Bonus</strong>: Tags</li>
</ul>
<h4 class="mume-header" id="medium">Medium</h4>

<ul>
<li>Stories</li>
<li>Commenting on stories</li>
<li>Follows and feed</li>
<li>Likes</li>
<li><strong>Bonus</strong>: Topics/categories</li>
<li><strong>Bonus</strong>: Bookmarks</li>
</ul>
<h4 class="mume-header" id="product-hunt">Product Hunt</h4>

<ul>
<li>Products</li>
<li>Profile Page</li>
<li>Product Discussion</li>
<li>Search (Users or Products)</li>
<li><strong>Bonus</strong>: Collections</li>
<li><strong>Bonus</strong>: Upvotes and Tags</li>
</ul>
<h4 class="mume-header" id="quora">Quora</h4>

<ul>
<li>Questions</li>
<li>Answers/comments on answers</li>
<li>Search Questions</li>
<li>Topics/Tags</li>
<li><strong>Bonus</strong>: Upvotes, order questions by popularity</li>
<li><strong>Bonus</strong>: Replies to comments</li>
</ul>
<h4 class="mume-header" id="remember-the-milk">Remember the Milk</h4>

<ul>
<li>Tasks</li>
<li>Lists</li>
<li>List summary (time, num tasks, num completed)</li>
<li>Search</li>
<li><strong>Bonus</strong>: Autocomplete SmartAdd of task properties</li>
<li><strong>Bonus</strong>: Subtasks</li>
</ul>
<h4 class="mume-header" id="stack-overflow">Stack Overflow</h4>

<ul>
<li>Ask Questions</li>
<li>Answer Questions</li>
<li>Search for Questions</li>
<li>Upvote / Downvote Answer</li>
<li><strong>Bonus</strong>: Question Categories</li>
<li><strong>Bonus</strong>: Comment on Questions / Answers</li>
<li><strong>Bonus</strong>: Polymorphic Up/Down Votes: Questions, Answers, Comments</li>
<li><strong>Bonus</strong>: Code Snippets in Answers</li>
</ul>
<h4 class="mume-header" id="teawithstrangers">TeaWithStrangers</h4>

<ul>
<li>Choose City</li>
<li>Host Event</li>
<li>Join Event in your city</li>
<li>Dashboard of joined events/hosted events</li>
<li><strong>Bonus</strong>: Google Map API showing events based on location</li>
<li><strong>Bonus</strong>: Suggestions based on event details and user profiles</li>
</ul>
<h4 class="mume-header" id="yelp">Yelp</h4>

<ul>
<li>Business Page</li>
<li>Search / filters</li>
<li>Reviews / ratings</li>
<li>Map</li>
<li><strong>Bonus</strong>: Mark reviews funny, cool, useful etc.</li>
<li><strong>Bonus</strong>: Profile</li>
<li><strong>Bonus</strong>: Friends</li>
</ul>
<hr>
<h1 class="mume-header" id="setting-up-your-groups-project-repository">Setting Up Your Group&apos;s Project Repository</h1>

<p>Only <strong>one person</strong> on the team should do this, the &quot;project lead&quot;. Once the<br>
project is done, everyone should <em>fork</em> the repository to get their own local<br>
copies for future reference.</p>
<p>Your group will coordinate and collaborate around a GitHub repository. To do<br>
that, you&apos;ll need to set it up so that everyone can contribute. These are the<br>
steps to get you on your way.</p>
<h2 class="mume-header" id="create-a-new-repository">Create a new repository</h2>

<p>Go to GitHub. On your profile page, you should see a &quot;New&quot; button that allows<br>
you to create a new repository. Click it.</p>
<p><img src="images/group-project-repo-setup-new-repo.png" alt="new repository button"></p>
<p>Fill out the name of the repository, its description, and choose to initialize<br>
the repository with a README and a <strong>.gitignore</strong> file for Node.js projects.</p>
<p><strong>MAKE IT PUBLIC EVEN THOUGH THE PICTURE BELOW SHOWS PRIVATE!</strong> If it&apos;s not<br>
public, then you can&apos;t show it to the world.</p>
<p><img src="images/group-project-repo-setup-repo-details.png" alt="new repository details"></p>
<p>Click the &quot;Create repository&quot; button.</p>
<h2 class="mume-header" id="give-access-to-your-teammates">Give access to your teammates</h2>

<p>Now that you have a repository, you need to give some privileges to your<br>
teammates so they can use the repository, too.</p>
<p>On your project page, click the &quot;Settings&quot; tab.</p>
<p><img src="images/group-project-repo-setup-settings-tab.png" alt="repository settings tab"></p>
<p>Once on the Settings page, click the &quot;Manage access&quot; link.</p>
<p><img src="images/group-project-repo-setup-manage-access.png" alt="manage access link"></p>
<p>You may have to confirm your password.</p>
<p>Once you get there, click the &quot;Invite teams or people&quot;.</p>
<p><img src="images/group-project-repo-setup-invite-teams-or-people.png" alt="invite teams or people button"></p>
<p>For each person on your team, invite them to the repository and give them<br>
&quot;Maintain&quot; access.</p>
<p><img src="images/group-project-repo-setup-invite-member-at-level.png" alt="grant access to user"></p>
<p>Now, have everyone clone the repository and you can start working together.</p>
<p>Start by creating a <strong>documentation</strong> directory. Inside that directory, create a<br>
directory named <strong>feature-list</strong>. In there, create a <a href="http://README.md">README.md</a> document in which<br>
you can create the list of features and their estimates so that an instructor<br>
can review them.</p>
<hr>
<h1 class="mume-header undefined" id="week-12-day-2brauthentication-and-authorization">WEEK-12 DAY-2<br><em>Authentication and Authorization</em></h1>

<hr>
<h1 class="mume-header" id="authentication-learning-objectives">Authentication Learning Objectives</h1>

<p>Almost every online software application has an <strong>authentication</strong> component<br>
that compels visitors to identify themselves. After reading and practicing, you<br>
should be able to</p>
<ul>
<li>Define the term <em>authentication</em></li>
<li>Describe the difference between asymmetric and symmetric cryptographic<br>
algorithms</li>
<li>Identify &quot;strong&quot; vs. &quot;broken&quot; hash functions</li>
<li>Implement session-based authentication in an Express application</li>
<li>Implement a strong hash function to securely store passwords</li>
<li>Describe and use the different security options for cookies</li>
</ul>
<hr>
<h1 class="mume-header" id="using-bcrypt-to-hash-passwords">Using Bcrypt to Hash Passwords</h1>

<p>Using BCrypt to hash passwords came from the idea of thinking about how to<br>
protect user information in the worst case scenario. For example, what if a<br>
hacker tries to inject your application with a SQL query to receive all user<br>
information, including user passwords? This is why a password <em>hash</em> is stored<br>
in the database instead of a user&apos;s actual password.</p>
<p>By the end of this article, you will be able to:</p>
<ul>
<li>Understand what cryptography is and why it&apos;s important;</li>
<li>Understand what hashing and encryption are and how they differ from each<br>
other; and</li>
<li>Use Bcrypt to hash stored user passwords.</li>
</ul>
<h2 class="mume-header" id="what-is-cryptography">What is cryptography?</h2>

<p>Cryptography is a way to use algorithms and secret keys to keep information<br>
secure. It is comprised of techniques for secure communication for adversaries.<br>
Adversaries are third-parties who could possibly fake a user&apos;s identity to gain<br>
their secret values.</p>
<p>In modern times, cryptography is synonymous with encryption. Take note that<br>
encoding and encrypting are two different processes. An example of an encoding<br>
technique is compression, where you would encode the string &quot;aaabcccabbccc&quot; into<br>
&quot;a3bc3ab2c3&quot;. This is a classic encoding scheme for highly repetitive data. If<br>
you know the encoding scheme, you are able to manually decipher the encoded data<br>
into it&apos;s original form.</p>
<h3 class="mume-header" id="what-is-encryption">What is encryption?</h3>

<p>Encrypting is different from encoding. Encryption is the process of translating<br>
something that&apos;s readable into something that looks like nonsense (i.e. not<br>
readable) and being able to translate it from a non-readable state back into<br>
something that&apos;s readable.</p>
<p>An example of an encryption technique is the <a href="https://www.geeksforgeeks.org/caesar-cipher-in-cryptography/">Caesar Cipher</a> algorithm. Imagine<br>
that you are using a <code>caesarCipher</code> function below to transform the string<br>
&quot;abcd&quot;. The function uses its key of <code>2</code> to shift all its characters two<br>
characters to &quot;the right&quot; to have a final encrypted string of &quot;cdef&quot;.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token function">caesarCipher</span><span class="token punctuation">(</span><span class="token string">&quot;abcd&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// returns &quot;cdef&quot;</span>
</pre><p>A string is encrypted when we still don&apos;t know for certain what the original<br>
input was even though if we understand the algorithm used (i.e. understanding<br>
Caesar Cipher, but not being able to read or determine its input from its<br>
output).</p>
<h3 class="mume-header" id="how-does-encryption-work">How does encryption work?</h3>

<p>There are two kinds of encryption, <strong>symmetric</strong> and <strong>asymmetric</strong> encryption.<br>
The Caesar cipher is <em>symmetric</em> because it uses one value to determine how to<br>
encrypt data, the number of values to shift the letters in the message. If you<br>
know that one value, like <code>2</code> from the previous example, then you can<br>
reconstitute the original message by using that knowledge, shifting the letters<br>
left two steps.</p>
<p>Asymmetric encryption uses two pieces of information called the public and<br>
private keys. The public key is shared with anyone wanting to encrypt a message<br>
for the recipient. The private key is used to decrypt the message. Encrypt with<br>
public key, decrypt with private key. This is why it&apos;s known as asymmetric,<br>
because one key does the encrypting and the other key does the decrypting.</p>
<p>Establishing an HTTPS connection is an example of asymmetric encryption. To<br>
break down the steps of encryption between a computer and a Web server that is<br>
going to establish a secure HTTP connection (i.e., HTTPS), they would do the<br>
following:</p>
<ol>
<li>The server passes on its public key to encrypt data along with its SSL<br>
certificate.</li>
<li>The browser client uses the server&apos;s public key to encrypt a value and<br>
generate a new private key.</li>
<li>The client sends the encrypted value and the client&apos;s new private key to the<br>
server.</li>
<li>The browser&apos;s private key is used to decrypt messages that have been<br>
encrypted with the server&apos;s public key.</li>
<li>The server sends encrypted data to the client using the client&apos;s public key.</li>
<li>The browser decrypts the data from the server and renders the decrypted<br>
information.</li>
</ol>
<h3 class="mume-header" id="when-is-it-appropriate-to-use-encryption">When is it appropriate to use encryption?</h3>

<p>It&apos;s appropriate to use encryption to secure over the wire communication between<br>
the client and server (e.g. HTTPS or TLS/SSL). Data at rest (i.e. stored in a<br>
database) can also be encrypted. For example, credit card numbers should be<br>
encrypted (if they&apos;re stored at all). Sometimes data just needs to be protected<br>
at rest and you don&apos;t need the ability to decrypt it. For example, passwords<br>
need to be protected at rest, but you don&apos;t need the ability to translate a<br>
password back into human readable form. For this reason, hashing is a far more<br>
popular way of protecting user passwords.</p>
<h2 class="mume-header" id="what-is-hashing">What is hashing?</h2>

<p>Hashing is the process of converting a message of any length into a short,<br>
fixed-length string. Hashed values cannot be translated back to their original<br>
input values. Hashing is deterministic, meaning that every time you hash the<br>
same input, you will receive the same output. This is why we use hashing to<br>
secure user credentials.</p>
<h3 class="mume-header" id="how-does-hashing-work">How does hashing work?</h3>

<p>There are many different types of hashing functions. It&apos;s important to use<br>
cryptographic hashing functions, as they minimize hash collisions (i.e. creating<br>
the same hashed value from different inputs). We&apos;ll be focusing on using the<br>
BCrypt library which uses the Blowfish cipher, an encryption algorithm.</p>
<h3 class="mume-header" id="what-is-a-salt">What is a &quot;salt&quot;?</h3>

<p>Imagine if multiple users have the same password. This means that they would<br>
have the same password digest stored in the database. If one of the users has an<br>
exposed password, a hacker could find all the users with the same password<br>
digest and hack into all accounts with the exposed password. This is where<br>
salting comes into play. The basic idea behind salting is to begin by generating<br>
a small, random string or set of bits known as a <code>salt</code>. You would then append<br>
the <code>salt</code> to your the user&apos;s password before hashing.</p>
<p>If you create a new <code>salt</code> for each user, each time you hash a password for a<br>
different user, you are guaranteed to generate a unique password digest to store<br>
in the database. Instead of just storing a possibly generic password digest, the<br>
password and the unique <code>salt</code> generated for the user is stored.</p>
<p>Now when you see a password digest, the digest is no longer the digest of a<br>
common password. It&apos;s a secure digest of a common password concatenated with a<br>
salt to randomize the digest output.</p>
<h3 class="mume-header" id="when-is-it-appropriate-to-use-hashing">When is it appropriate to use hashing?</h3>

<p>Hashing is a popular way of storing passwords. A hashed password is often<br>
referred to as a &quot;password digest&quot;. When a user creates an account, their<br>
password digest is saved to the database. This keeps the user credentials safe<br>
by ensuring that the user&apos;s actual password is never stored in the database. You<br>
almost never need to convert user passwords back into something that&apos;s human<br>
readable. You simply hash a provided password and compare the hash to the stored<br>
hash. If the hashes match, then the user has provided the correct password.</p>
<p>Although the password digest is in the database, the user&apos;s credentials are<br>
still safe even if user information is extracted via SQL injection because of<br>
how hashing is deterministic. If a hacker uses a user&apos;s password digest in<br>
attempt to logging in, the password digest would get hashed into a new hashed<br>
value that would not equate to the user&apos;s stored password digest.</p>
<h2 class="mume-header" id="using-bcrypt-to-hash-user-passwords">Using Bcrypt to hash user passwords</h2>

<p>BCrypt is a password hashing function that&apos;s widely used to hash user passwords.<br>
In this section, you&apos;ll learn how to implement <a href="https://www.npmjs.com/package/bcrypt">BCrypt</a> into your application.</p>
<p>Begin by installing the <code>bcryptjs</code> npm package:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> bcryptjs
</pre><p>Now require it in your application:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;bcryptjs&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>You can either use BCrypt synchronously or asynchronously. It is recommended to<br>
generate hashes asynchronously. As of version <code>2.4.0</code>, <code>bcryptjs</code>&apos;s asynchronous<br>
methods return a promise if a callback is omitted.</p>
<p>To generate a hashed value, you&apos;ll await the <code>hash</code> method. The <code>hash</code> method<br>
takes in a password to hash and the number of <code>saltRounds</code> to generate a salt.<br>
Note that whenever you invoke the <code>hash</code> function with a number of <code>saltRounds</code>,<br>
the function generates the <code>salt</code> for you within the hash function.</p>
<p>Auto-generates salt based on number of <code>saltRounds</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Manually generates salt before generating password digest:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> salt <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">genSalt</span><span class="token punctuation">(</span>saltRounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In order to log in a user with their credentials, you would use BCrypt&apos;s<br>
<code>compare()</code> method to check whether a user-provided password matches a stored<br>
database hash. <code>await</code> the call to the <code>compare()</code> to return a <code>isPassword</code>.<br>
Note that <code>isPassword</code> is a Boolean value.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> isPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>As a recap, your asynchronous implementation of BCrypt hashing should look<br>
something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;bcryptjs&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token parameter">password<span class="token punctuation">,</span> saltRounds</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">isPassword</span><span class="token punctuation">(</span><span class="token parameter">password<span class="token punctuation">,</span> hash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>isPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> isPassword<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token string">&apos;P@ssw0rd&apos;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> passwordIsMatch <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">isPassword</span><span class="token punctuation">(</span><span class="token string">&apos;P@ssw0rd&apos;</span><span class="token punctuation">,</span> hashedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Hashes can also be generated synchronously with BCrypt&apos;s <code>hashSync()</code> method.<br>
Like in asynchronous execution, there are also two ways of hash generation. The<br>
first way generates a <code>salt</code> and <code>hash</code> on separate function calls. The <code>hash</code><br>
then uses the <code>salt</code> to generate a password digest.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> salt <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">genSaltSync</span><span class="token punctuation">(</span>saltRounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span><span class="token string">&quot;B4c0/\/&quot;</span><span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The second way auto-generates a salt to be used in the hash function. In this<br>
case, BCrypt&apos;s <code>hashSync()</code> method takes in a password to be hashed and a number<br>
of salt rounds.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span><span class="token string">&apos;bacon&apos;</span><span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>You would then use BCrypt&apos;s <code>compareSync()</code> method to compare a password with a<br>
stored database hash to determine whether or not a user has entered valid<br>
credentials.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span><span class="token string">&quot;B4c0/\/&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span><span class="token string">&quot;not_bacon&quot;</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</pre><p>Now that you have learned how to use the <code>bcryptjs</code> library, you can safely<br>
store hashed passwords in your database without the worry that a hacker can<br>
reverse engineer them!</p>
<hr>
<h1 class="mume-header" id="configuring-sessions-in-express">Configuring Sessions in Express</h1>

<p>In this reading, you&apos;ll learn about HTTP sessions. You&apos;ll also learn about how<br>
to configure a session store as well as how to secure the session cookie.</p>
<p>Let&apos;s begin by revisiting how HTTP is stateless. Since HTTP is stateless, query<br>
string parameters and HTTP cookies provide ways to persist values across<br>
requests. However, storing data in query string parameters can become cumbersome<br>
and possibly look strange to end users. This is where session storage comes<br>
into play.</p>
<p>By the end of this article, you should be able to:</p>
<ul>
<li>Use the <code>express-session</code> middleware to configure an Express application to<br>
support sessions;</li>
<li>Use the <code>req.session</code> object to store and retrieve a value;</li>
<li>Configure the <code>express-session</code> middleware to use a production-ready session<br>
storage provider; and,</li>
<li>Use the available security options (i.e. secure, httpOnly, domain, path, and<br>
expires) to secure a session&apos;s HTTP cookie.</li>
</ul>
<h2 class="mume-header" id="overview-of-sessions">Overview of sessions</h2>

<p>Let&apos;s begin by revisiting how HTTP is a stateless protocol. This means that each<br>
HTTP request is independent from other requests that were executed before or<br>
after. Once the server has processed an incoming request and returned a<br>
response, it forgets about the client.</p>
<h3 class="mume-header" id="what-are-sessions">What are sessions?</h3>

<p>Even though HTTP cookies allow the persistence of values across requests,<br>
cookies aren&apos;t an efficient way to store anything other than small amounts of<br>
data. Transmitting HTTP cookies between the server and client (and back again)<br>
can undesirably increase the amount of traffic on the server.</p>
<p>Most browsers don&apos;t reliably support more than 50 cookies per domain and the<br>
total size of all of the data in the cookies has to be less than 4093 characters<br>
of text. That may sound like a lot, but when you are storing data for a person&apos;s<br>
session in there, you will run out of room very quickly.</p>
<p>Sessions build upon the idea of an HTTP cookie. Instead of storing data in the<br>
cookie itself, a unique identifier known as the <strong>session ID</strong> is stored. This<br>
<strong>session ID</strong> is linked to an object stored on the server.</p>
<h3 class="mume-header" id="why-are-sessions-useful">Why are sessions useful?</h3>

<p>Sessions give you a way to identify a series of requests as being connected to<br>
the same client. Once you know that a request is connected to a known client<br>
session, you can associate the state (data) of that session without having to<br>
send that data to the client and rely upon them to send that data back to the<br>
server unaltered.</p>
<h3 class="mume-header" id="what-are-the-drawbacks">What are the drawbacks?</h3>

<p>Although sessions are useful, there are still drawbacks to using sessions. Using<br>
sessions increases the overhead required to serve clients. Server affinity, the<br>
ability of a router to send a request to the same server over and over for a<br>
specific client, can be an issue depending on the session store that you&apos;re<br>
using.</p>
<h2 class="mume-header" id="configuring-express-to-use-sessions">Configuring Express to use sessions</h2>

<p>Clone the starter project files at: <a href="https://github.com/appacademy-starters/express-sessions-starter.git">starter files</a></p>
<p>Install the project&apos;s dependencies and run it.</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span>
<span class="token function">npm</span> start
</pre><p>The application is a simple website that contains three pages: &quot;Home&quot;, &quot;About&quot;,<br>
and &quot;Contact&quot;.</p>
<p>Currently, when you browse from page to page, the server doesn&apos;t recognize or<br>
associate the page requests as being part of the same session.</p>
<p>Open up your web developer tools to view cookies under the &quot;Application&quot; tab.<br>
Click on &quot;Storage &gt; Cookies &gt; <code>http://localhost:8080</code>&quot; to view the cookies for<br>
your <code>localhost</code> domain. Currently, you shouldn&apos;t see any cookies listed.</p>
<p>Let&apos;s configure the application to use sessions!</p>
<h3 class="mume-header" id="installing-and-configuring-express-session">Installing and configuring <code>express-session</code></h3>

<p>Install the <code>express-session</code> npm package.</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> express-session
</pre><p>Since the <code>express-session</code> npm package handles your session cookies, you no<br>
longer need to install the <code>cookie-parser</code> package separately. If<br>
<code>cookie-parser</code> is configured separately, <code>express-session</code> and <code>cookie-parser</code><br>
would both need to use the same <code>secret</code> value. You&apos;ll learn more about this<br>
<code>secret</code> value below.</p>
<p>Add the <code>express-session</code> middleware to the <code>app</code> module.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./app.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-session&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&apos;view engine&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;pug&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> <span class="token string">&apos;a5d63fc5-17a5-459c-b3ba-6d81792158fc&apos;</span><span class="token punctuation">,</span>
  resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>
</pre><blockquote>
<p><strong>Note:</strong> Ideally the session <code>secret</code> option value is set from an environment<br>
variable. Using a literal value here is being done to keep this example as<br>
simple as possible.</p>
</blockquote>
<h3 class="mume-header" id="configuration-options">Configuration options</h3>

<p>Let&apos;s take a closer look at the session middleware you configured in <code>app.js</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> <span class="token string">&apos;a5d63fc5-17a5-459c-b3ba-6d81792158fc&apos;</span><span class="token punctuation">,</span>
  resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Notice the following keys that configure your session creation:</p>
<p><strong>secret</strong>:  This is the secret used to sign the <strong>session ID</strong> cookie. The<br>
<code>secret</code> value above was generated using the <a href="https://www.npmjs.com/package/uuid">uuid npm package</a>. The <code>uuid</code><br>
package allows you to generate universally unique identifiers (UUIDs) from<br>
random cryptographically-strong values, a timestamp, or a user-supplied string.</p>
<p><strong>resave</strong>:  This option forces the session to be saved into the session<br>
<em>store</em>, even if the session was never modified during the request. You would<br>
typically want to set this option as <code>false</code> to prevent overwriting sessions<br>
during race conditions, which are undesired parallel requests. However if your<br>
session store sets an expiration date on stored sessions, then you likely need<br>
to set &quot;resave&quot; as <code>true</code>.</p>
<p><strong>saveUninitialized</strong>:  This forces an <em>uninitialized</em> session to be saved to<br>
the store. An uninitialized session is when a session is new but not modified.<br>
It&apos;s useful to set this option as <code>false</code> when creating login sessions, reducing<br>
use of server storage, or complying with permission laws to set cookies. Setting<br>
the option as <code>false</code> also prevents race conditions when multiple requests are<br>
made without a session.</p>
<p>Not setting the <code>resave</code> and <code>saveUninitialized</code> options results in the<br>
following warning in the console:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">express-session deprecated undefined resave option<span class="token punctuation">;</span> provide resave option app.js:8:9
express-session deprecated undefined saveUninitialized option<span class="token punctuation">;</span> provide saveUninitialized option app.js:8:9
</pre><p>Another configuration option that you can set, but which is not listed in the<br>
example above, is the <strong>name</strong> of the cookie. By default, the<br>
<strong>express-session</strong> middleware uses the name <code>connect.sid</code>. Imagine if you have<br>
an application running on <code>localhost:8080</code> and a different application on<br>
<code>localhost:3000</code>. Since cookies are scoped to the general <code>localhost</code> domain,<br>
this means that cookies set for <code>localhost:8080</code> would appear in your<br>
<code>localhost:3000</code> cookies. This is why it&apos;s important to set a specific <code>name</code><br>
property and separate each application&apos;s session cookies from each other.</p>
<h3 class="mume-header" id="testing">Testing</h3>

<p>In order to test whether your session cookie is properly created in the next<br>
step, begin by opening up your developer tools to view the cookies of the<br>
<code>localhost</code> domain. Remember to access the cookies by clicking Application &gt;<br>
Storage &gt; Cookies &gt; <code>http://localhost:8080</code>.</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/configuring-sessions-devtools-1.png" alt="before-session-cookie-creation"></p>
<p>As you can see, the session cookie isn&apos;t being created. This is because setting<br>
<code>saveUninitialized</code> to <code>false</code> prevents the session from being created until the<br>
session has been used. Let&apos;s use the <code>session</code> in your application! Keep your<br>
developer tools open to be able to view your cookies as they appear.</p>
<h2 class="mume-header" id="setting-and-accessing-session-values">Setting and accessing session values</h2>

<p>Let&apos;s use <code>session</code> to track each page that the user visits!</p>
<p>Create a middleware function that adds each request URL to an array of page<br>
visits stored in session.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./app.js</span>

<span class="token comment">// Code removed for brevity.</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> <span class="token string">&apos;a5d63fc5-17a5-459c-b3ba-6d81792158fc&apos;</span><span class="token punctuation">,</span>
  resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Attempt to get the `history` array from session.</span>
  <span class="token comment">// If it&apos;s not initialized, then create an array</span>
  <span class="token comment">// and assigned it back to session.</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>history<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>history <span class="token operator">=</span> history<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Construct the full URL for the current request.</span>
  <span class="token comment">// Note: Using `req.get(&apos;host&apos;)` to get the hostname also</span>
  <span class="token comment">// gives you the port number.</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>protocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;host&apos;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>originalUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>

  <span class="token comment">// Add the URL to the beginning of the array.</span>
  history<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Note: We don&apos;t need to update the `session.history` property</span>
  <span class="token comment">// with the updated array because arrays are passed by reference.</span>
  <span class="token comment">// Because arrays are passed by reference, when we get a</span>
  <span class="token comment">// reference to the array in the above code</span>
  <span class="token comment">// `let { history } = req.session;` and modify the array by</span>
  <span class="token comment">// calling `history.unshift(url);` we&apos;re modifying the original</span>
  <span class="token comment">// array that&apos;s stored in session!</span>

  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>
</pre><p>After refreshing your page, you should now see a cookie in your developer tools.</p>
<p>![after-session-cookie-creation][devtools-with-session-cookie]</p>
<p>Notice how the code accessed the <code>session</code> attribute of the <code>req</code> object. In<br>
order to store or access session data, you use the <code>req.session</code> property.</p>
<p>In the example above, you attempted to get the <code>history</code> array from session. If<br>
the array was not already initialized, you created an array and assigned it to<br>
the &quot;history&quot; property of the <code>req.session</code> object.</p>
<p>Now you&apos;ll want to update each of the route handlers to pass the<br>
<code>req.session.history</code> array to the views.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;index&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&apos;Home&apos;</span><span class="token punctuation">,</span>
    history<span class="token punctuation">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>history<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/about&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;about&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&apos;About&apos;</span><span class="token punctuation">,</span>
    history<span class="token punctuation">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>history<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/contact&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;contact&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&apos;Contact&apos;</span><span class="token punctuation">,</span>
    history<span class="token punctuation">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>history<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then update the <code>layout.pug</code> view to render the history array.</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token doctype">doctype html</span>
<span class="token tag">html<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">lang</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;en&quot;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">head</span>
    <span class="token tag">title</span> <span class="token plain-text">Sessions - #{title}</span>
  <span class="token tag">body</span>
    <span class="token tag">h1</span> <span class="token plain-text">Sessions - #{title}</span>
    <span class="token tag">ul</span>
      <span class="token tag">li<span class="token punctuation">:</span></span> <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token tag">Home</span>
      <span class="token tag">li<span class="token punctuation">:</span></span> <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/about&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token tag">About</span>
      <span class="token tag">li<span class="token punctuation">:</span></span> <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/contact&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token tag">Contact</span>
    <span class="token keyword">block content</span>
    <span class="token tag">footer</span>
      <span class="token tag">h2</span> <span class="token plain-text">History</span>
      <span class="token tag">ul</span>
        <span class="token tag">for</span> <span class="token plain-text">item in history</span>
          <span class="token tag">li<span class="token punctuation">:</span></span> <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value">item</span><span class="token punctuation">)</span></span></span><span class="token punctuation">=</span><span class="token code"> item</span>
</pre><p>Now when you browse from page to page, your history is tracked by the server<br>
using <code>session</code>. The middleware function below (that you have already added to<br>
your <code>app.js</code>) takes care of generating the <code>history</code> array of visited links. In<br>
each of your GET routes, your <code>req.session.history</code> array is passed into the<br>
view as a <code>history</code> attribute. Your views then use the <code>history</code> attribute to<br>
render a list of visited links in the footer of each page.</p>
<p>Note that browsing history is specific to each user session. If you open a<br>
private, Incognito tab, you&apos;ll see that the private client gets its own array of<br>
visited pages.</p>
<h2 class="mume-header" id="session-store-configuration">Session store configuration</h2>

<p>The default in-memory store that you have been using (<code>MemoryStore</code>) is meant<br>
only for local development. There are many available session store options. For<br>
example, <code>connect-pg-simple</code> and <code>connect-session-sequelize</code> are two PostgreSQL<br>
compatible session store options.</p>
<p>Let&apos;s install and configure the <code>connect-pg-simple</code> session store!</p>
<p>Install the npm package.</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> connect-pg-simple
</pre><p>Next, create a database and a database user. You can use the <code>psql</code> terminal<br>
commands below.</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">create database session_example<span class="token punctuation">;</span>
create user session_example_app with encrypted password <span class="token string">&apos;&#xAB;a strong password for the session_example_app user&#xBB;&apos;</span><span class="token punctuation">;</span>
grant all privileges on database session_example to session_example_app<span class="token punctuation">;</span>
</pre><p>Then create the <code>session</code> table in the <code>session_example</code> database. You can run<br>
the following command from the root of your project to create the <code>session</code><br>
table.</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">psql -U session_example_app session_example <span class="token operator">&lt;</span> node_modules/connect-pg-simple/table.sql
</pre><p>Or you can run the following SQL statements in <code>psql</code> against the<br>
<code>session_example</code> database:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">&quot;session&quot;</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;sid&quot;</span> <span class="token keyword">varchar</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COLLATE</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;sess&quot;</span> json <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token string">&quot;expire&quot;</span> <span class="token keyword">timestamp</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>OIDS<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">&quot;session&quot;</span> <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> <span class="token string">&quot;session_pkey&quot;</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token string">&quot;sid&quot;</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> DEFERRABLE INITIALLY IMMEDIATE<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token string">&quot;IDX_session_expire&quot;</span> <span class="token keyword">ON</span> <span class="token string">&quot;session&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;expire&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Update the npm <code>start</code> script by setting <code>PGUSER</code>, <code>PGDATABASE</code>, and<br>
<code>PGPASSWORD</code> environment variables. These variables are used by the <code>pg</code> npm<br>
package, which is used by the <code>connect-pg-simple</code> package to communicate to the<br>
PostgreSQL database. Make sure to set the <code>PGPASSWORD</code> to the password you&apos;ve<br>
given to the <code>session_example_app</code> user.</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PGUSER=session_example_app PGDATABASE=session_example PGPASSWORD=password nodemon app.js&quot;</span>
<span class="token punctuation">}</span>
</pre><p>An alternative way to update the npm <code>start</code> script is by defining the<br>
<code>DATABASE_URL</code> environment variable. The <code>DATABASE_URL</code> is used by<br>
<code>connect-pg-simple</code> to determine how to connect to the PostgreSQL database<br>
containing the <code>session</code> table.</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;DATABASE_URL=postgresql://session_example_app:password@localhost:5432/session_example nodemon app.js&quot;</span>
<span class="token punctuation">}</span>
</pre><p>Now update the <code>app</code> module as follows.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./app.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-session&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;connect-pg-simple&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&apos;view engine&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;pug&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  store<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token function">store</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  secret<span class="token punctuation">:</span> <span class="token string">&apos;a5d63fc5-17a5-459c-b3ba-6d81792158fc&apos;</span><span class="token punctuation">,</span>
  resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>
</pre><p>Test your app again, and it should behave as it did before, but now the session<br>
data is stored in the database!</p>
<p>In <code>psql</code>, connect to the <code>session_example</code> database and run the following<br>
query:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">session</span><span class="token punctuation">;</span>
</pre><p>You should see a <code>sid</code> session ID, a session cookie, and a <code>history</code> array of<br>
visited urls stored in your PostgreSQL database, like the example below.</p>
<pre data-role="codeBlock" data-info class="language-"><code>sid: 2kseXpBRl9h1ZHoBndzEyu_cem9l0GN4
sess: {&quot;cookie&quot;:{&quot;originalMaxAge&quot;:null,&quot;expires&quot;:null,&quot;httpOnly&quot;:true,&quot;path&quot;:&quot;/&quot;},&quot;history&quot;:[&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/contact&quot;,&quot;http://localhost:8080/about&quot;,&quot;http://localhost:8080/&quot;,&quot;http://localhost:8080/about&quot;,&quot;http://localhost:8080/contact&quot;,&quot;http://localhost:8080/about&quot;]}
expire: 2020-04-11 12:19:13
</code></pre><h2 class="mume-header" id="securing-the-session-http-cookie">Securing the session HTTP cookie</h2>

<p>As you see in your database query, you have a <code>cookie</code> object with the following<br>
keys of <code>originalMaxAge</code>, <code>expires</code>, <code>httpOnly</code>, and <code>path</code>.</p>
<p>A session cookie has a default configuration of:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token punctuation">{</span>
  httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  maxAge<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  path<span class="token punctuation">:</span> <span class="token string">&apos;/&apos;</span><span class="token punctuation">,</span>
  secure<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</pre><p>A secure session cookie should be configured like so:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token punctuation">{</span>
  httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  maxAge<span class="token punctuation">:</span> &#xAB;time <span class="token keyword">in</span> milliseconds&#xBB;<span class="token punctuation">,</span>
  path<span class="token punctuation">:</span> <span class="token string">&apos;/&apos;</span><span class="token punctuation">,</span>
  secure<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</pre><p>It&apos;s important to configure cookies as secure HTTP cookies because it&apos;s possible<br>
for sessions to be hijacked. Insecure cookies allow hackers to make requests to<br>
the web application through another user&apos;s session.</p>
<p>Setting the cookie&apos;s <code>httpOnly</code> property to <code>true</code> prevents JavaScript on the<br>
page from accessing the cookie. This helps prevent cross-site scripting (XSS)<br>
attacks by making the <code>httpOnly</code> cookies inaccessible through the<br>
<code>document.cookie</code> API.</p>
<p>Setting the cookie&apos;s <code>secure</code> property requires that HTTPS is used. HTTPS uses a<br>
digital certificate for authentication known as an SSL certificate to make a web<br>
application more secure. Using <code>secure</code> cookies and HTTPS prevents anyone from<br>
being able to <em>sniff</em> or hijack the cookie as requests and responses are passed<br>
between the client and the server.</p>
<p>In production, the <code>secure</code> property should be set to <code>true</code>. If your<br>
Express application is behind a proxy you would need to configure it to trust<br>
the proxy with <code>app.set(&apos;trust proxy&apos;, 1)</code>.</p>
<p>Appropriately setting a <code>maxAge</code> on the cookie keeps the cookie from living<br>
longer than it needs to. Have you ever logged into a bank website and noticed<br>
how quickly the website will log you out if you&apos;re inactive? This is to prevent<br>
someone from stealing or accessing your information when sitting down at your<br>
computer while you&apos;re away. Expiring sessions as quickly as possible helps to<br>
protect your users from accidentally allowing someone to access the web<br>
application using their identity.</p>
<p><code>path</code> - Defaults to <code>/</code></p>
<h3 class="mume-header" id="additional-session-configuration-cookie-options">Additional session configuration cookie options</h3>

<p>You can also configure session cookies with the following options that are not<br>
set by default:</p>
<p><code>domain</code></p>
<p>Since no domain is set by default, this causes browsers to interpret the current<br>
domain as the cookie&apos;s domain. This is connected to why setting cookies in a<br>
<code>localhost</code> domain (i.e. <code>localhost:8080</code>) would set cookies in a different<br>
<code>localhost</code> domain (i.e. <code>localhost:3000</code>).</p>
<p><code>expires</code></p>
<p>Instead of setting this property directly, you can use <code>maxAge</code> instead. Note<br>
that <code>maxAge</code> takes in an integer number representing milliseconds to calculate<br>
when the cookie should expire.</p>
<h2 class="mume-header" id="what-you-have-learned">What you have learned</h2>

<p>You now know what HTTP sessions are as well as how to configure and access the<br>
session store in your Express application. You also know how to configure cookie<br>
options to secure the session cookie.</p>
<p>Now that you have learned about sessions, you can implement sessions in your<br>
own applications!</p>
<p>[devtools-with-session-cookie]: images/configuring-sessions-devtools-2.pngimages/configuring-sessions-devtools-2.pngpthFrom=2 depthTo=6 orderedList=false} --&gt;</p>
<hr>
<h1 class="mume-header" id="implementing-session-based-authentication">Implementing Session-Based Authentication</h1>

<p>In this reading, you&apos;ll learn how to implement session-based authentication in<br>
an Express application.</p>
<p>By the end of this article, you should be able to:</p>
<ul>
<li>Understand what authentication and authorization are and how they differ from<br>
each other;</li>
<li>Understand how to support user self-registration and login within a web<br>
application; and</li>
<li>Add session-based authentication to an Express website including user flows to<br>
support self-registration and login.</li>
</ul>
<h2 class="mume-header" id="overview-of-authentication-and-authorization">Overview of authentication and authorization</h2>

<p>So far, all of the users of your applications have been anonymous. While the<br>
server can use a feature like sessions to determine if a request is from a<br>
client that&apos;s been served before, the server still doesn&apos;t know the identity of<br>
that user.</p>
<p>If an application can&apos;t identify its users, it doesn&apos;t have a way to associate<br>
data with specific users. The ability to know whose data belongs to whom is an<br>
extremely important feature.</p>
<p>Think about popular web applications, such as Facebook. Being able to identify<br>
the current user is necessary so Facebook can determine who your friends are,<br>
what posts to display to you, and if you post, who to associate the post with.</p>
<h3 class="mume-header" id="what-is-authentication">What is authentication?</h3>

<p>Authentication is the process of identifying a user. To authenticate a user, a<br>
<code>key</code> and a <code>secret</code> is required.</p>
<ul>
<li>The <code>key</code> is typically a username or an email address.</li>
<li>The <code>secret</code> is typically a password.</li>
</ul>
<p>The user&apos;s <code>key</code> and <code>secret</code> fields are stored in the application&apos;s database as<br>
a user account.</p>
<p>A user&apos;s account can also contain other information about the user. For example,<br>
an account can contain personal information such as a birth date, a mobile phone<br>
number, or a physical address.</p>
<p>Application preferences are also stored in a user account. These preferences can<br>
include how many items to include in lists, the designation of a default home<br>
page, or color scheme (light vs dark mode).</p>
<h3 class="mume-header" id="authentication-process">Authentication process</h3>

<p>When a user authenticates, they provide their username and password via an HTML<br>
form. The form then posts to the server. The login route handler attempts to<br>
retrieve the user from the database using their username. If a user is found,<br>
then the user account&apos;s <em>hashed</em> password is checked against the provided<br>
password. Passwords are stored in the database as encrypted <em>hashes</em>.</p>
<p>The user&apos;s provided password needs to be hashed first before it can be compared<br>
to the password hash from the database. If the password hashes match, then the<br>
user is logged in. With session-based authentication, the user&apos;s ID is stored in<br>
the session. Subsequent requests to the application can then check if the<br>
session contains a user ID. If a user ID is available, then the user is logged<br>
in!</p>
<p>The application can then retrieve the user&apos;s account information and make it<br>
available to other middleware, the route handler, and the view.</p>
<h3 class="mume-header" id="what-is-authorization">What is authorization?</h3>

<p>Authorization is the process of determining if the currently logged in user has<br>
access to an application&apos;s data or features. Sometimes, data is associated<br>
directly with a user. For example, a table in the database for storing posts or<br>
comments would include a <code>userId</code> column. The <code>userId</code> column would have the<br>
primary key <code>id</code> value from the <code>Users</code> table.</p>
<p>Relating data to specific users allows the application to retrieve just the<br>
user&apos;s own records. Sometimes data should only be accessed by users that are<br>
assigned a specific user function or role.</p>
<p>For example, a user might belong to an &quot;Admin&quot; role. Any user in the &quot;Admin&quot;<br>
role has permissions to add, update, or even delete other application users.<br>
&quot;Admin&quot; role users may also have additional access to certain application<br>
features. Don&apos;t let that power go to your head!</p>
<p>We&apos;ll explore how role-based access control works in a future article.</p>
<h2 class="mume-header" id="supporting-user-self-registration">Supporting user self-registration</h2>

<p>Before a user can login to an application or website, the application needs to<br>
know who that user is... they need to register!</p>
<h3 class="mume-header" id="getting-the-starter-project">Getting the starter project</h3>

<p>Clone the starter project:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">git</span> clone https://github.com/appacademy-starters/express-reading-list-with-auth-starter.git
</pre><p>Install the project&apos;s dependencies:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span>
</pre><p>Add an <code>.env</code> file containing the environment variables from the <code>.env.example</code><br>
file:</p>
<pre data-role="codeBlock" data-info class="language-"><code>PORT=8080
DB_USERNAME=reading_list_app
DB_PASSWORD=&#xAB;the reading_list_app user password&#xBB;
DB_DATABASE=reading_list
DB_HOST=localhost
</code></pre><p>Create the database and database user (if needed). Open psql by running the<br>
command <code>psql</code> (to use the currently logged in user) or <code>psql -U &#xAB;super user username&#xBB;</code> to specify the username of the super user to use. Then execute the<br>
following SQL statements:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> reading_list<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">user</span> reading_list_app <span class="token keyword">with</span> encrypted password <span class="token string">&apos;&#xAB;a strong password for the reading_list_app user&#xBB;&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token keyword">database</span> reading_list <span class="token keyword">to</span> reading_list_app<span class="token punctuation">;</span>
</pre><p>Make sure that the <code>.env</code> file contains the correct database user password!</p>
<p>Start and test the application:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> start
</pre><h3 class="mume-header" id="creating-the-user-model">Creating the User model</h3>

<p>The <code>User</code> model should include the following properties:</p>
<ul>
<li><code>emailAddress</code> - A string representing the user&apos;s email address;</li>
<li><code>firstName</code> - A string representing the user&apos;s first name;</li>
<li><code>lastName</code> - A string representing the user&apos;s last name; and</li>
<li><code>hashedPassword</code> - A string representing the user&apos;s hashed password.</li>
</ul>
<p>From the terminal, run the following command to use the Sequelize CLI to<br>
generate the <code>User</code> model:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx sequelize model:generate --name User --attributes <span class="token string">&quot;emailAddress:string, firstName:string, lastName:string, hashedPassword:string&quot;</span>
</pre><p>If the command succeeds, you&apos;ll see the following output in the console:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">New model was created at <span class="token punctuation">[</span>path to the project folder<span class="token punctuation">]</span>/db/models/user.js <span class="token keyword">.</span>
New migration was created at <span class="token punctuation">[</span>path to the project folder<span class="token punctuation">]</span>/db/migrations/20200410231702-User.js
</pre><p>This confirms that two files were generated: a file for the <code>User</code> model and a<br>
file for a database migration to add the <code>Users</code> table to the database.</p>
<p>Open the <code>./db/models/user.js</code> file and update the <code>User</code> model&apos;s attribute<br>
data types and nullability:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&apos;User&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    emailAddress<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      unique<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    firstName<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    hashedPassword<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">.</span><span class="token constant">BINARY</span><span class="token punctuation">,</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// associations can be defined here</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Take a moment to notice that the <code>emailAddress</code> attribute is configured to be<br>
<code>unique</code>. This means that there is a <em>unique constraint</em> on that column in the<br>
database. The <em>unique constraint</em> ensures that each user in the database will<br>
have a unique <code>emailAddress</code>. Without the assurance of knowing that each user<br>
has a unique <code>emailAddress</code>, you wouldn&apos;t be able to reliably identify a user by<br>
their email address.</p>
<p>The Sequelize <code>STRING</code> data type has an available property of <code>BINARY</code>. Setting<br>
an attribute to have a datatype of <code>STRING.BINARY</code> means that the string is<br>
stored as raw-byte data. According to the PostgreSQL documentation, a <a href="https://www.postgresql.org/docs/8.1/datatype-binary.html">binary<br>
string</a> is a sequence of octets (or bytes).</p>
<p>Make sure to also set the <code>hashedPassword</code> attribute with a datatype of<br>
<code>STRING.BINARY</code> in the migration file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&apos;Users&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      emailAddress<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        unique<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      firstName<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      lastName<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      hashedPassword<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">.</span><span class="token constant">BINARY</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&apos;Users&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Then apply the migration:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:migrate
</pre><p>In the console, you should see something similar to the following output:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">Loaded configuration <span class="token function">file</span> <span class="token string">&quot;config/database.js&quot;</span><span class="token keyword">.</span>
Using environment <span class="token string">&quot;development&quot;</span><span class="token keyword">.</span>
<span class="token operator">==</span> 20200410231702-create-user: migrating <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token operator">==</span> 20200410231702-create-user: migrated <span class="token punctuation">(</span>0.028s<span class="token punctuation">)</span>
</pre><p>To confirm the creation of the <code>Users</code> table, you can run the following command<br>
from within psql:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">\d <span class="token string">&quot;Users&quot;</span>
</pre><blockquote>
<p>Be sure that you&apos;re connected to the <code>reading_list</code> database in psql. If you<br>
are, the cursor should read <code>reading_list=#</code>. If you&apos;re not connected to the<br>
correct database, you can run the command <code>\c reading_list</code> to connect to the<br>
<code>reading_list</code> database.</p>
</blockquote>
<p>After running the <code>\d &quot;Users&quot;</code> command, you should see the following output<br>
within psql:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">                                          Table <span class="token string">&quot;public.Users&quot;</span>
     Column     <span class="token operator">|</span>           Type           <span class="token operator">|</span> Collation <span class="token operator">|</span> Nullable <span class="token operator">|</span>               Default
----------------+--------------------------+-----------+----------+-------------------------------------
 <span class="token function">id</span>             <span class="token operator">|</span> integer                  <span class="token operator">|</span>           <span class="token operator">|</span> not null <span class="token operator">|</span> nextval<span class="token punctuation">(</span><span class="token string">&apos;&quot;Users_id_seq&quot;&apos;</span>::regclass<span class="token punctuation">)</span>
 emailAddress   <span class="token operator">|</span> character varying<span class="token punctuation">(</span>255<span class="token punctuation">)</span>   <span class="token operator">|</span>           <span class="token operator">|</span> not null <span class="token operator">|</span>
 firstName      <span class="token operator">|</span> character varying<span class="token punctuation">(</span>50<span class="token punctuation">)</span>    <span class="token operator">|</span>           <span class="token operator">|</span> not null <span class="token operator">|</span>
 lastName       <span class="token operator">|</span> character varying<span class="token punctuation">(</span>50<span class="token punctuation">)</span>    <span class="token operator">|</span>           <span class="token operator">|</span> not null <span class="token operator">|</span>
 hashedPassword <span class="token operator">|</span> bytea                    <span class="token operator">|</span>           <span class="token operator">|</span> not null <span class="token operator">|</span>
 createdAt      <span class="token operator">|</span> timestamp with <span class="token function">time</span> zone <span class="token operator">|</span>           <span class="token operator">|</span> not null <span class="token operator">|</span>
 updatedAt      <span class="token operator">|</span> timestamp with <span class="token function">time</span> zone <span class="token operator">|</span>           <span class="token operator">|</span> not null <span class="token operator">|</span>
Indexes:
    <span class="token string">&quot;Users_pkey&quot;</span> PRIMARY KEY, btree <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token string">&quot;Users_emailAddress_key&quot;</span> UNIQUE CONSTRAINT, btree <span class="token punctuation">(</span><span class="token string">&quot;emailAddress&quot;</span><span class="token punctuation">)</span>
</pre><h3 class="mume-header" id="adding-the-user-registration-form">Adding the user registration form</h3>

<p>Now you&apos;ll want to create a form that collects the required account information<br>
from the user.</p>
<p>To start, now that the application will have two resources, &quot;books&quot; and &quot;users&quot;,<br>
let&apos;s do a little refactoring! Create a <code>routes</code> folder in the root of the<br>
project and then rename the <code>routes.js</code> file as <code>book.js</code> and move the file into<br>
the <code>routes</code> folder.</p>
<p>Update the <code>routes</code> module reference in the <code>app.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> bookRoutes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./routes/book&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bookRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then move the <code>csrfProtection</code> and <code>asyncHandler</code> variable declarations to a new<br>
<code>./routes/utils</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./routes/utils.js</span>

<span class="token keyword">const</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;csurf&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> csrfProtection <span class="token operator">=</span> <span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cookie<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">asyncHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  csrfProtection<span class="token punctuation">,</span>
  asyncHandler<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>And update the <code>./routes/book.js</code> file to import those items from the <code>utils</code><br>
module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> csrfProtection<span class="token punctuation">,</span> asyncHandler <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./utils&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Add a module named <code>user</code> to the <code>routes</code> folder containing the following code<br>
to define the routes for the &quot;Register&quot; page:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> check<span class="token punctuation">,</span> validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-validator&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;../db/models&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> csrfProtection<span class="token punctuation">,</span> asyncHandler <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./utils&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/user/register&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-register&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&apos;Register&apos;</span><span class="token punctuation">,</span>
    user<span class="token punctuation">,</span>
    csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userValidators <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// TODO Define the user validators.</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/user/register&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> userValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      firstName<span class="token punctuation">,</span>
      lastName<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> user <span class="token operator">=</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      firstName<span class="token punctuation">,</span>
      lastName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-register&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;Register&apos;</span><span class="token punctuation">,</span>
        user<span class="token punctuation">,</span>
        errors<span class="token punctuation">,</span>
        csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</pre><p>Rename the <code>textField</code> mixin to <code>field</code> in the <code>utils.pug</code> template file:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token mixin"><span class="token keyword">mixin</span> <span class="token function">field</span><span class="token punctuation">(</span>labelText<span class="token punctuation">,</span> fieldName<span class="token punctuation">,</span> fieldValue<span class="token punctuation">,</span> fieldType = &apos;text&apos;<span class="token punctuation">)</span></span>
  <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;form-group&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value">fieldName</span><span class="token punctuation">)</span></span></span><span class="token punctuation">=</span><span class="token code"> labelText</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value">fieldType id<span class="token operator">=</span>fieldName name<span class="token operator">=</span>fieldName value<span class="token operator">=</span>fieldValue <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;form-control&apos;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Notice that a <code>fieldType</code> parameter was added that defaults to a value of<br>
<code>text</code>. Adding this parameter will give you a way to add a password field to the<br>
register form.</p>
<p>Then add the <code>user-register.pug</code> template file to the <code>views</code> folder containing<br>
the following code:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token comment">//- ./views/user-register.pug</span>

<span class="token keyword">extends layout.pug</span>

<span class="token keyword">include utils.pug</span>

<span class="token keyword">block content</span>
  <span class="token mixin"><span class="token name function">+validationErrorSummary</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span></span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">action</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/user/register&apos;</span> method<span class="token operator">=</span><span class="token string">&apos;post&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;hidden&apos;</span> name<span class="token operator">=</span><span class="token string">&apos;_csrf&apos;</span> value<span class="token operator">=</span>csrfToken</span><span class="token punctuation">)</span></span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;First Name&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;firstName&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Last Name&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;lastName&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;emailAddress&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>emailAddress<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Password&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Confirm Password&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;confirmPassword&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span></span>
    <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;py-4&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-primary&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Register</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-warning ml-2&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Cancel</span>
</pre><p>Notice that there are two &quot;password&quot; fields: &quot;Password&quot; and &quot;Confirm Password&quot;.<br>
When using the <code>input</code> element with a <code>type</code> attribute of <code>password</code>, the field<br>
will replace typed characters with bullets to hide what has been typed into the<br>
field. This is a great protection from prying eyes, but you need a way for users<br>
to be able to confirm the password that they&apos;re providing. Making them type<br>
their password twice is doing exactly that.</p>
<blockquote>
<p><strong>Note:</strong> After renaming the <code>textField</code> mixin to <code>field</code>, be sure to update<br>
the <code>book-form-fields.pug</code> template to call the mixin using the new name!</p>
</blockquote>
<h3 class="mume-header" id="validating-the-user-registration-form">Validating the user registration form</h3>

<p>Implement the following validation rules:</p>
<ul>
<li><code>firstName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul>
</li>
<li><code>lastName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul>
</li>
<li><code>emailAddress</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 255 characters</li>
<li>Is a valid email address</li>
</ul>
</li>
<li><code>password</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul>
</li>
<li><code>confirmPassword</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul>
</li>
</ul>
<p>Here&apos;s what the initial pass at setting up the validators looks like using the<br>
<code>express-validator</code> library:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> userValidators <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;firstName&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for First Name&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;First Name must not be more than 50 characters long&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;lastName&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Last Name&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Last Name must not be more than 50 characters long&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;emailAddress&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Email Address&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">255</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address must not be more than 255 characters long&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address is not a valid email&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Password&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Password must not be more than 50 characters long&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;confirmPassword&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Confirm Password&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Confirm Password must not be more than 50 characters long&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre><p>You can use a regular expression to enforce password complexity:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Password&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Password must not be more than 50 characters long&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token regex">/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&amp;*])/</span><span class="token punctuation">,</span> <span class="token string">&apos;g&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Password must contain at least 1 lowercase letter, uppercase letter, number, and special character (i.e. &quot;!@#$%^&amp;*&quot;)&apos;</span><span class="token punctuation">)</span>
</pre><p><code>^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&amp;*])</code></p>
<p>This article from <a href="https://www.thepolyglotdeveloper.com/2015/05/use-regex-to-test-password-strength-in-javascript/">The Polyglot Developer</a> breaks down the RegEx that tests the<br>
password strength in the validation above. To recap:</p>
<ul>
<li>The hat operator <code>^</code> is used to start matching at the beginning of the<br>
password.</li>
<li>The expression <code>(?=.*[a-z])</code> is used to check that the password contains at<br>
least one lowercase character.</li>
<li>The expression <code>(?=.*[A-Z])</code> is used to check that the password contains at<br>
least one uppercase character.</li>
<li>The expression <code>(?=.*[0-9])</code> is used to check that the password contains at<br>
least one numeric character.</li>
<li>The expression <code>(?=.*[!@#$%^&amp;*])</code> is used to check that the password contains<br>
at least one special character.</li>
</ul>
<p>The validation below checks that the two passwords should match:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;confirmPassword&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Confirm Password&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Confirm Password must not be more than 50 characters long&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> <span class="token punctuation">{</span> req <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&apos;Confirm Password does not match Password&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>You can use another custom validator to check if the provided email address is<br>
already in use by another account:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;emailAddress&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Email Address&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">255</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address must not be more than 255 characters long&apos;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address is not a valid email&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> emailAddress<span class="token punctuation">:</span> value <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&apos;The provided Email Address is already in use by another account&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</pre><h3 class="mume-header" id="hashing-user-passwords">Hashing user passwords</h3>

<p>To keep your user&apos;s personal information as secure as possible, you need to<br>
avoid storing user passwords in clear text. You can do this by encrypting the<br>
password with BCrypt, a password hashing function.</p>
<p>Install the <code>bcryptjs</code> npm package:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> bcryptjs
</pre><p>Update the <code>POST</code> <code>/user/register</code> route handler to use <code>bcrypt</code> to hash the<br>
user&apos;s password:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;bcryptjs&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/user/register&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> userValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      firstName<span class="token punctuation">,</span>
      lastName<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> user <span class="token operator">=</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      firstName<span class="token punctuation">,</span>
      lastName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user<span class="token punctuation">.</span>hashedPassword <span class="token operator">=</span> hashedPassword<span class="token punctuation">;</span>
      <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-register&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;Register&apos;</span><span class="token punctuation">,</span>
        user<span class="token punctuation">,</span>
        errors<span class="token punctuation">,</span>
        csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Notice that the asynchronous method <code>bcrypt.hash()</code> is called to hash the<br>
<code>password</code> variable. The hashed value returned from the method call is used to<br>
set the <code>user.hashedPassword</code> property.</p>
<h3 class="mume-header" id="adding-the-user-routes-to-the-app-module">Adding the user routes to the <code>app</code> module</h3>

<p>In the <code>app</code> module, add the user routes:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> bookRoutes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./routes/book&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userRoutes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./routes/user&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bookRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>userRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="testing-user-registration">Testing user registration</h3>

<p>Run the application (<code>npm start</code>) and test the <code>/user/register</code> route by filling<br>
out and submitting the form to create a new user.</p>
<p>Using psql, view the user in the database by running the following SELECT SQL<br>
statement:</p>
<pre data-role="codeBlock" data-info="sql" class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;Users&quot;</span><span class="token punctuation">;</span>
</pre><p>You should see a user with a hashed password like in this example:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"> <span class="token function">id</span> <span class="token operator">|</span>    emailAddress    <span class="token operator">|</span> firstName <span class="token operator">|</span> lastName  <span class="token operator">|</span>                                                       hashedPassword                                                       <span class="token operator">|</span>         createdAt          <span class="token operator">|</span>         updatedAt
----+--------------------+-----------+-----------+----------------------------------------------------------------------------------------------------------------------------+----------------------------+----------------------------
  1 <span class="token operator">|</span> james@smashdev.com <span class="token operator">|</span> James     <span class="token operator">|</span> Churchill <span class="token operator">|</span> \x24326124303824446c32684c546e676f49524f322e2e7335704d42697558554955617730325264796d58534e544d3552542e6d686b365a46336e724f <span class="token operator">|</span> 2020-04-10 18:54:07.635-07 <span class="token operator">|</span> 2020-04-10 18:54:07.635-07
<span class="token punctuation">(</span>1 row<span class="token punctuation">)</span>
</pre><h2 class="mume-header" id="supporting-user-login">Supporting user login</h2>

<p>Now that you have a way to support user registration, you need a way to allow<br>
existing users to log in using their email address and password.</p>
<h3 class="mume-header" id="adding-the-user-login-form">Adding the user login form</h3>

<p>Start by adding the routes and validators for the &quot;Login&quot; page to the<br>
<code>./routes/user</code> module just below the existing routes for the &quot;Register&quot; page:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/user/login&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-login&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&apos;Login&apos;</span><span class="token punctuation">,</span>
    csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> loginValidators <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;emailAddress&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Email Address&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&apos;Please provide a value for Password&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/user/login&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> loginValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">let</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO Attempt to login the user.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-login&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&apos;Login&apos;</span><span class="token punctuation">,</span>
      emailAddress<span class="token punctuation">,</span>
      errors<span class="token punctuation">,</span>
      csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><blockquote>
<p>Notice the slightly different approach of declaring the <code>errors</code> array outside<br>
of the <code>else</code> block. Using this approach will allow you to manually add an<br>
error message to the <code>errors</code> array if the user login process fails (you&apos;ll<br>
implement this process in just a bit).</p>
</blockquote>
<p>Then add the <code>user-login.pug</code> template file to the <code>views</code> folder containing the<br>
following code:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token comment">//- ./views/user-login.pug</span>

<span class="token keyword">extends layout.pug</span>

<span class="token keyword">include utils.pug</span>

<span class="token keyword">block content</span>
  <span class="token mixin"><span class="token name function">+validationErrorSummary</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span></span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">action</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/user/login&apos;</span> method<span class="token operator">=</span><span class="token string">&apos;post&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;hidden&apos;</span> name<span class="token operator">=</span><span class="token string">&apos;_csrf&apos;</span> value<span class="token operator">=</span>csrfToken</span><span class="token punctuation">)</span></span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;emailAddress&apos;</span><span class="token punctuation">,</span> emailAddress<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Password&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span></span>
    <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;py-4&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-primary&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Login</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-warning ml-2&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Cancel</span>
</pre><h3 class="mume-header" id="implementing-the-user-login-process">Implementing the user login process</h3>

<p>To implement the user login process, the following steps need to be followed:</p>
<ol>
<li>Attempt to retrieve the user from the database using the supplied email<br>
address.</li>
</ol>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Attempt to get the user by their email address.</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> emailAddress <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><ol start="2">
<li>If a user was found in the database, then use the <code>bcrypt.compare()</code> method<br>
to compare the supplied password to the user&apos;s hashed password.</li>
</ol>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Attempt to get the user by their email address.</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> emailAddress <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If the user exists then compare their password</span>
  <span class="token comment">// to the provided password.</span>
  <span class="token keyword">const</span> passwordMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>hashedPassword<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><ol start="3">
<li>If the hashed passwords match (i.e. the <code>bcrypt.compare()</code> method returns<br>
<code>true</code>), then login the user and redirect them to the default route (i.e.<br>
<code>/</code>).</li>
</ol>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Attempt to get the user by their email address.</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> emailAddress <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If the user exists then compare their password</span>
  <span class="token comment">// to the provided password.</span>
  <span class="token keyword">const</span> passwordMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>hashedPassword<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>passwordMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the password hashes match, then login the user</span>
    <span class="token comment">// and redirect them to the default route.</span>
    <span class="token comment">// TODO Login the user.</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p><strong>Note:</strong> We&apos;ll implement a method to &quot;login&quot; the user in just a bit. For now,<br>
add a <code>TODO</code> comment as a placeholder for the actual method call.</p>
</blockquote>
<ol start="4">
<li>If a user wasn&apos;t found in the database or the hashed passwords don&apos;t match,<br>
then add a validation error message and render the <code>user-login</code> view to let<br>
the user know that the login process failed.</li>
</ol>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Attempt to get the user by their email address.</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> emailAddress <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If the user exists then compare their password</span>
  <span class="token comment">// to the provided password.</span>
  <span class="token keyword">const</span> passwordMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>hashedPassword<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>passwordMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the password hashes match, then login the user</span>
    <span class="token comment">// and redirect them to the default route.</span>
    <span class="token comment">// TODO Login the user.</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Otherwise display an error message to the user.</span>
errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&apos;Login failed for the provided email address and password&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Notice that you&apos;re not letting the user know if the supplied email address or<br>
password is to blame for the failed login attempt. This is intentional! Not<br>
providing this information, while potentially frustrating to end users, makes<br>
it more difficult for hackers to guess at email address and password<br>
combinations.</p>
<p>Here&apos;s the completed <code>POST</code> <code>/user/login</code> route:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/user/login&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> loginValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">let</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Attempt to get the user by their email address.</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> emailAddress <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the user exists then compare their password</span>
        <span class="token comment">// to the provided password.</span>
        <span class="token keyword">const</span> passwordMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>hashedPassword<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>passwordMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If the password hashes match, then login the user</span>
          <span class="token comment">// and redirect them to the default route.</span>
          <span class="token comment">// TODO Login the user.</span>
          <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Otherwise display an error message to the user.</span>
      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&apos;Login failed for the provided email address and password&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-login&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&apos;Login&apos;</span><span class="token punctuation">,</span>
      emailAddress<span class="token punctuation">,</span>
      errors<span class="token punctuation">,</span>
      csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="improving-the-user-navigation">Improving the user navigation</h3>

<p>One small change to the <code>user-register</code> and <code>user-login</code> views before you test<br>
the user login form. As a convenience for the user, add links below the user<br>
registration and login forms that allow the user to easily navigate between the<br>
&quot;Register&quot; and &quot;Login&quot; pages:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token comment">//- ./views/user-register.pug</span>

<span class="token keyword">extends layout.pug</span>

<span class="token keyword">include utils.pug</span>

<span class="token keyword">block content</span>
  <span class="token mixin"><span class="token name function">+validationErrorSummary</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span></span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">action</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/user/register&apos;</span> method<span class="token operator">=</span><span class="token string">&apos;post&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;hidden&apos;</span> name<span class="token operator">=</span><span class="token string">&apos;_csrf&apos;</span> value<span class="token operator">=</span>csrfToken</span><span class="token punctuation">)</span></span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;First Name&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;firstName&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Last Name&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;lastName&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;emailAddress&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>emailAddress<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Password&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Confirm Password&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;confirmPassword&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span></span>
    <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;py-4&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-primary&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Register</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-warning ml-2&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Cancel</span>
  <span class="token tag">div</span>
    <span class="token tag">p<span class="token punctuation">:</span></span> <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/user/login&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token tag">Already</span> <span class="token tag">have</span> <span class="token tag">an</span> <span class="token tag">account</span>?
</pre><pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token comment">//- ./views/user-login.pug</span>

<span class="token keyword">extends layout.pug</span>

<span class="token keyword">include utils.pug</span>

<span class="token keyword">block content</span>
  <span class="token mixin"><span class="token name function">+validationErrorSummary</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span></span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">action</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/user/login&apos;</span> method<span class="token operator">=</span><span class="token string">&apos;post&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;hidden&apos;</span> name<span class="token operator">=</span><span class="token string">&apos;_csrf&apos;</span> value<span class="token operator">=</span>csrfToken</span><span class="token punctuation">)</span></span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Email Address&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;emailAddress&apos;</span><span class="token punctuation">,</span> emailAddress<span class="token punctuation">)</span></span>
    <span class="token mixin"><span class="token name function">+field</span><span class="token punctuation">(</span><span class="token string">&apos;Password&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&apos;password&apos;</span><span class="token punctuation">)</span></span>
    <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;py-4&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-primary&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Login</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/&apos;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&apos;btn btn-warning ml-2&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Cancel</span>
  <span class="token tag">div</span>
    <span class="token tag">p<span class="token punctuation">:</span></span> <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/user/register&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token tag">Don</span>&apos;t have an account?
</pre><h3 class="mume-header" id="testing-user-login">Testing user login</h3>

<p>Run the application (if it&apos;s not already running) and browse to the<br>
<code>/user/login</code> route. Test the user login form by completing the following<br>
actions:</p>
<ul>
<li>Submit the form with no values.
<ul>
<li>You should see two validation messages asking you to provide values.</li>
</ul>
</li>
<li>Submit the form with an email address that isn&apos;t associated with a user record<br>
in the database and a password (doesn&apos;t matter if the password is correct or<br>
not).
<ul>
<li>You should see a validation message letting you know that the login attempt<br>
failed.</li>
</ul>
</li>
<li>Submit the form with an email address that&apos;s associated with a user record in<br>
the database <strong>but with an incorrect password</strong>.
<ul>
<li>You should see a validation message letting you know that the login attempt<br>
failed.</li>
</ul>
</li>
<li>Submit the form with an email address that&apos;s associated with a user record in<br>
the database <strong>and with a correct password</strong>.
<ul>
<li>This time you should be redirected to the &quot;Home&quot; page.</li>
</ul>
</li>
</ul>
<p>The login process succeeded, but a crucial piece is still missing: persisting<br>
the user&apos;s login state.</p>
<h2 class="mume-header" id="persisting-user-login-state">Persisting user login state</h2>

<p>Now it&apos;s time to handle persisting the user&apos;s login state after they&apos;ve<br>
successfully logged into the website!</p>
<p>Remember that HTTP is a stateless protocol. Each HTTP request is independent<br>
from other requests that were executed before or after. Once the server has<br>
processed an incoming request and returned a response, it forgets about the<br>
client.</p>
<p>To persist to user&apos;s login state, we can implement and use sessions!</p>
<h3 class="mume-header" id="configuring-express-to-use-sessions-1">Configuring Express to use sessions</h3>

<p>Install the <code>express-session</code> npm package.</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> express-session
</pre><p>Add a new environment variable named <code>SESSION_SECRET</code> to the <code>.env</code> file:</p>
<pre data-role="codeBlock" data-info class="language-"><code>SESSION_SECRET=f1f079b1-68fe-4324-8010-0a5cff63a288
</code></pre><p>Don&apos;t forget to update the <code>.env.example</code> file too:</p>
<pre data-role="codeBlock" data-info class="language-"><code>SESSION_SECRET=&#xAB;strong session secret&#xBB;
</code></pre><p>After updating the <code>.env</code> file, update the <code>config</code> module to export a property<br>
named <code>sessionSecret</code> initialized to the <code>process.env.SESSION_SECRET</code> property<br>
value:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./config/index.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  environment<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">&apos;development&apos;</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8080</span><span class="token punctuation">,</span>
  sessionSecret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SESSION_SECRET</span><span class="token punctuation">,</span>
  db<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_USERNAME</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PASSWORD</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_DATABASE</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_HOST</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now it&apos;s time to add the <code>express-session</code> middleware to the <code>app</code> module Start<br>
with importing the <code>express-session</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-session&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then use the <code>require()</code> function to get the session secret environment variable<br>
from the <code>config</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> sessionSecret <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./config&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now you can add the <code>session</code> middleware to the application just after the call<br>
to the <code>app.use()</code> method that adds the <code>cookieParser</code> middleware:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span>sessionSecret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&apos;reading-list.sid&apos;</span><span class="token punctuation">,</span>
  secret<span class="token punctuation">:</span> sessionSecret<span class="token punctuation">,</span>
  resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Some things to note about the above code:</p>
<ul>
<li>Notice that the <code>sessionSecret</code> config value is passed to the <code>cookieParser</code><br>
middleware. If your application is using both <code>cookie-parser</code> and<br>
<code>express-session</code> they need to use the same <code>secret</code> value.</li>
<li>The <code>name</code> option is set to <code>reading-list.sid</code> so that session cookies for the<br>
Reading List application won&apos;t affect any other applications that are using<br>
the general <code>localhost</code> domain.</li>
</ul>
<p>Here&apos;s what the top portion of the <code>app</code> module should look like now:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./app.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;morgan&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;cookie-parser&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-session&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> sessionSecret <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./config&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bookRoutes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./routes/book&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userRoutes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./routes/user&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&apos;view engine&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;pug&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">&apos;dev&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span>sessionSecret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&apos;reading-list.sid&apos;</span><span class="token punctuation">,</span>
  secret<span class="token punctuation">:</span> sessionSecret<span class="token punctuation">,</span>
  resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bookRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>userRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>
</pre><blockquote>
<p><strong>Note:</strong> Remember that the default in-memory session store (<code>MemoryStore</code>) is<br>
only meant for local development. While the in-memory session store works for<br>
the purposes of this article, you&apos;d want to replace it with a more robust<br>
option (i.e. <code>connect-pg-simple</code> and <code>connect-session-sequelize</code>) before<br>
deploying your application to a production environment.</p>
</blockquote>
<h3 class="mume-header" id="using-sessions-to-persist-a-users-login-state">Using sessions to persist a user&apos;s login state</h3>

<p>Now that you&apos;ve configured sessions in Express application, you can persist the<br>
user&apos;s login state using a session.</p>
<p>Add a new module named <code>auth</code> to the root of your project and add the following<br>
code to the module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./auth.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>auth <span class="token operator">=</span> <span class="token punctuation">{</span>
    userId<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  loginUser<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Putting all of the authentication related code in its own module helps to keep<br>
things organized in the project. It also helps to keep your modules focused on<br>
solving a single problem or group of related problems. All of this will improve<br>
the readability and maintainability of your project.</p>
<p>Now update the <code>./routes/user</code> module to import the <code>loginUser()</code> function from<br>
the <code>auth</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> loginUser <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;../auth&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then within the <code>POST</code> <code>/user/login</code> route handler add a call to the<br>
<code>loginUser()</code> function just before redirecting the user to the default route if<br>
the password matched:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Code removed for brevity.</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>passwordMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If the password hashes match, then login the user</span>
  <span class="token comment">// and redirect them to the default route.</span>
  <span class="token function">loginUser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>You can also login the user after a new user has registered. In the <code>POST</code><br>
<code>/user/register</code> route handler add a call to the <code>loginUser()</code> function after<br>
saving the user to the database but before redirecting then to the default<br>
route:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Code removed for brevity.</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  user<span class="token punctuation">.</span>hashedPassword <span class="token operator">=</span> hashedPassword<span class="token punctuation">;</span>
  <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">loginUser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// Code removed for brevity.</span>
<span class="token punctuation">}</span>
</pre><p>For your reference, here are the updated <code>POST</code> <code>/user/register</code> and<br>
<code>/user/login</code> route handlers:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/user/register&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> userValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      firstName<span class="token punctuation">,</span>
      lastName<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> user <span class="token operator">=</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      firstName<span class="token punctuation">,</span>
      lastName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user<span class="token punctuation">.</span>hashedPassword <span class="token operator">=</span> hashedPassword<span class="token punctuation">;</span>
      <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">loginUser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-register&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;Register&apos;</span><span class="token punctuation">,</span>
        user<span class="token punctuation">,</span>
        errors<span class="token punctuation">,</span>
        csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Code removed for brevity.</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/user/login&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> loginValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      emailAddress<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">let</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Attempt to get the user by their email address.</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> emailAddress <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the user exists then compare their password</span>
        <span class="token comment">// to the provided password.</span>
        <span class="token keyword">const</span> passwordMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>hashedPassword<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>passwordMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If the password hashes match, then login the user</span>
          <span class="token comment">// and redirect them to the default route.</span>
          <span class="token function">loginUser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Otherwise display an error message to the user.</span>
      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&apos;Login failed for the provided email address and password&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;user-login&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&apos;Login&apos;</span><span class="token punctuation">,</span>
      emailAddress<span class="token punctuation">,</span>
      errors<span class="token punctuation">,</span>
      csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="testing-user-login-state-persistence">Testing user login state persistence</h3>

<p>Run the application (if it&apos;s not already running) and use the &quot;Register&quot; and<br>
&quot;Login&quot; pages to register a new user and login an existing user. Everything<br>
should work as it did before, but the user&apos;s login state is being persisted in<br>
session.</p>
<p>At this point in the project, there isn&apos;t any visual indication if the user is<br>
logged in or not (that&apos;s something that you&apos;ll fix in a bit). If you open the<br>
DevTools in Chrome and view the &quot;Application&quot; tab, you can view the cookies for<br>
<code>http://localhost:8080</code>. After registering a new user or logging in an existing<br>
user, you should see a cookie named <code>reading-list.sid</code>. That&apos;s the session<br>
cookie!</p>
<h2 class="mume-header" id="restoring-the-authenticated-user-from-session">Restoring the authenticated user from session</h2>

<p>Now that you&apos;re persisting a user&apos;s login state to session, you need to make<br>
that user&apos;s information easily accessible to your application when it&apos;s<br>
processing requests.</p>
<p>In the <code>auth</code> module, define a middleware function named <code>restoreUser()</code> to<br>
retrieve the user&apos;s information from the database if they&apos;re authenticated:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./auth.js</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./db/models&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>auth <span class="token operator">=</span> <span class="token punctuation">{</span>
    userId<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">restoreUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Log the session object to the console</span>
  <span class="token comment">// to assist with debugging.</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> userId <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>auth<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>authenticated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>authenticated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>authenticated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  loginUser<span class="token punctuation">,</span>
  restoreUser<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>The <code>restoreUser()</code> middleware function starts by logging the <code>req.session</code><br>
object to the console. Doing this will help with testing and debugging.</p>
<p>Then the function checks if the <code>req.session.auth</code> property is defined to<br>
determine if there&apos;s an authenticated user. If there is, then it uses<br>
destructuring to extract the <code>userId</code> from the <code>req.session.auth</code> property and<br>
calls the <code>db.User.findByPk()</code> method to retrieve the user from the database.</p>
<p>If the user is successfully retrieved from the database, then the <code>res.locals</code><br>
object is used to define and set two properties:</p>
<ul>
<li><code>authenticated</code> - Set to <code>true</code> to indicate that the current request has an<br>
authenticated user; and</li>
<li><code>user</code> - Set to the user that was just retrieved from the database.</li>
</ul>
<p>The <code>res.locals</code> object is scoped to the current request and available to<br>
anything that follows the <code>restoreUser()</code> middleware function, including<br>
middleware and route handler functions and any views that are rendered as part<br>
of the current request/response cycle. It&apos;s a convenient way to pass values to<br>
other middleware, route handlers, or views.</p>
<p>If the <code>req.session.auth</code> property isn&apos;t defined or if the <code>db.User.findByPk()</code><br>
method call throws an error then the <code>res.locals.authenticated</code> property is set<br>
to <code>false</code> to indicate that the current request doesn&apos;t have an authenticated<br>
user (i.e. it&apos;s an anonymous request).</p>
<p>After defining the <code>restoreUser()</code> function and exporting it from the <code>auth</code><br>
module, you need to import it into the <code>app</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> restoreUser <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./auth&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then add the <code>restoreUser()</code> middleware function to the application just before<br>
the routes are added:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>restoreUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bookRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>userRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Retrieving the user&apos;s information from the database on every request, instead of<br>
storing the user&apos;s information in the session, ensures that the user&apos;s<br>
information doesn&apos;t get stale. While it&apos;s possible to refresh the session if the<br>
user were to change their information using the application, using that approach<br>
could break if a user can change their information using other means (e.g. a<br>
mobile app).</p>
<h3 class="mume-header" id="displaying-the-users-login-state">Displaying the user&apos;s login state</h3>

<p>It&apos;s helpful to display to the end user whether or not they&apos;re currently logged<br>
in. A common approach is to display login and registration links or a welcome<br>
message in the header of the website.</p>
<p>If the user isn&apos;t logged in, they would see links to log in or register:</p>
<blockquote>
<p>Login | Register</p>
</blockquote>
<p>If the user is logged in, they would be welcomed and have access to logging out:</p>
<blockquote>
<p>Welcome &#xAB;current user name&#xBB;! | Logout</p>
</blockquote>
<p>To do that, update your <code>./views/layout.pug</code> template to the following:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token doctype">doctype html</span>
<span class="token tag">html</span>
  <span class="token tag">head</span>
    <span class="token tag">meta<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">charset</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;utf-8&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">meta<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;viewport&apos;</span> content<span class="token operator">=</span>&apos;width<span class="token operator">=</span>device<span class="token operator">-</span>width</span><span class="token punctuation">,</span> <span class="token attr-name">initial-scale</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token number">1</span></span><span class="token punctuation">,</span> <span class="token attr-name">shrink-to-fit</span><span class="token punctuation">=</span><span class="token attr-value">no&apos;</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">link<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">rel</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;stylesheet&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css&apos;</span> integrity<span class="token operator">=</span><span class="token string">&apos;sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh&apos;</span> crossorigin<span class="token operator">=</span><span class="token string">&apos;anonymous&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">title</span> <span class="token plain-text">Reading List - #{title}</span>
  <span class="token tag">body</span>
    <span class="token tag">nav<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar navbar-expand-lg navbar-dark bg-primary&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-brand&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Reading List</span>
      <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-toggler&apos;</span> type<span class="token operator">=</span><span class="token string">&apos;button&apos;</span> data<span class="token operator">-</span>toggle<span class="token operator">=</span><span class="token string">&apos;collapse&apos;</span> data<span class="token operator">-</span>target<span class="token operator">=</span><span class="token string">&apos;#navbarText&apos;</span> aria<span class="token operator">-</span>controls<span class="token operator">=</span><span class="token string">&apos;navbarText&apos;</span> aria<span class="token operator">-</span>expanded<span class="token operator">=</span><span class="token string">&apos;false&apos;</span> aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">&apos;Toggle navigation&apos;</span></span><span class="token punctuation">)</span></span></span>
        <span class="token tag">span<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-toggler-icon&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;collapse navbar-collapse&apos;</span> id<span class="token operator">=</span><span class="token string">&apos;navbarText&apos;</span></span><span class="token punctuation">)</span></span></span>
        <span class="token tag">ul<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-nav mr-auto&apos;</span></span><span class="token punctuation">)</span></span></span>
          <span class="token comment">//- Empty menu keeps the content that follows the</span>
          <span class="token comment">//- unordered list correctly positioned on the</span>
          <span class="token comment">//- right side of the navbar.</span>
        <span class="token flow-control"><span class="token branch keyword">if</span> locals<span class="token punctuation">.</span>authenticated</span>
          <span class="token tag">span<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-text px-4&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Welcome #{user.firstName}!</span>
          <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;form-inline pr-4&apos;</span> action<span class="token operator">=</span><span class="token string">&apos;/user/logout&apos;</span> method<span class="token operator">=</span><span class="token string">&apos;post&apos;</span></span><span class="token punctuation">)</span></span></span>
            <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-warning&apos;</span> type<span class="token operator">=</span><span class="token string">&apos;submit&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Logout</span>
        <span class="token flow-control"><span class="token branch keyword">else</span></span>
          <span class="token tag">span<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-text px-4&apos;</span></span><span class="token punctuation">)</span></span></span>
            <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-dark mr-2&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/user/login&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Login</span>
            <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-dark&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/user/register&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Register</span>
    <span class="token tag">.container</span>
      <span class="token tag">h2<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;py-4&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">#{title}</span>
      <span class="token keyword">block content</span>
    <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;https://code.jquery.com/jquery-3.4.1.slim.min.js&apos;</span> integrity<span class="token operator">=</span><span class="token string">&apos;sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n&apos;</span> crossorigin<span class="token operator">=</span><span class="token string">&apos;anonymous&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token script"><span class="token function">script</span><span class="token punctuation">(</span>src<span class="token operator">=</span><span class="token string">&apos;https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js&apos;</span> integrity<span class="token operator">=</span><span class="token string">&apos;sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo&apos;</span> crossorigin<span class="token operator">=</span><span class="token string">&apos;anonymous&apos;</span><span class="token punctuation">)</span> <span class="token function">script</span><span class="token punctuation">(</span>src<span class="token operator">=</span><span class="token string">&apos;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js&apos;</span> integrity<span class="token operator">=</span><span class="token string">&apos;sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6&apos;</span> crossorigin<span class="token operator">=</span><span class="token string">&apos;anonymous&apos;</span><span class="token punctuation">)</span></span>
</pre><p>A good portion of the new code is related to styling the Bootstrap Navbar<br>
component. The section that&apos;s responsible for displaying the user&apos;s login state<br>
is this bit:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token flow-control"><span class="token branch keyword">if</span> locals<span class="token punctuation">.</span>authenticated</span>
  <span class="token tag">span<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-text px-4&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Welcome #{user.firstName}!</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;form-inline pr-4&apos;</span> action<span class="token operator">=</span><span class="token string">&apos;/user/logout&apos;</span> method<span class="token operator">=</span><span class="token string">&apos;post&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-warning&apos;</span> type<span class="token operator">=</span><span class="token string">&apos;submit&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Logout</span>
<span class="token flow-control"><span class="token branch keyword">else</span></span>
  <span class="token tag">span<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-text px-4&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-dark mr-2&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/user/login&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Login</span>
    <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-dark&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/user/register&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Register</span>
</pre><p>Notice that the view is using the <code>locals.authenticated</code> property to determine<br>
if the current user is logged in or not. <code>locals</code> within a view is the same<br>
object that&apos;s available via <code>res.locals</code>. Remember that the <code>restoreUser</code><br>
function defined in the <code>auth</code> module is responsible for determining if there&apos;s<br>
an authenticated user stored in session and defining the initializing the<br>
<code>res.locals.authenticated</code> property to the appropriate value.</p>
<p>If the current user isn&apos;t logged in, then links (styled as buttons using<br>
Bootstrap CSS classes) are rendered to the &quot;Login&quot; and &quot;Register&quot; pages. If the<br>
current user is logged in, then a short, friendly &quot;welcome&quot; message is rendered<br>
along with a simple form that contains a single &quot;Logout&quot; submit button.</p>
<p>Now if you run and test your application, you&apos;ll see the current user&apos;s login<br>
state displayed in the header! If you log in and click the &quot;Logout&quot; button in<br>
the header, you&apos;ll receive a &quot;Page Not Found&quot; error. This is occurring because<br>
the <code>POST</code> <code>/user/logout</code> route doesn&apos;t exist. Time to fix that!</p>
<h3 class="mume-header" id="implementing-user-logout">Implementing user logout</h3>

<p>Before adding the new route to logout a user, define and export a <code>logoutUser()</code><br>
function in the <code>auth</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">logoutUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>auth<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>The <code>logoutUser()</code> function uses the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/delete">JavaScript <code>delete</code> operator</a> to remove the <code>auth</code> property from the <code>req.session</code> object which<br>
destroys the user&apos;s persisted login state.</p>
<p>Now you&apos;re ready to add the <code>POST</code> <code>/user/logout</code> to the <code>./routes/user</code> module<br>
to process <code>POST</code> requests from the logout form. Start by importing the<br>
<code>logoutUser()</code> function from the <code>auth</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> loginUser<span class="token punctuation">,</span> logoutUser <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;../auth&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then add the new route:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/user/logout&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">logoutUser</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/user/login&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Notice that the route doesn&apos;t use the <code>csrfProtection</code> middleware. The <code>POST</code><br>
<code>/user/logout</code> route isn&apos;t modifying any of the user&apos;s data in the database, so<br>
for simplicity&apos;s sake the route isn&apos;t requiring a valid CSRF token to be present<br>
on the request.</p>
<p>After calling the <code>logoutUser()</code> function to logout the user, the user is<br>
redirected to the <code>/user/login</code> route. In some situations, it&apos;d be more<br>
appropriate to redirect the user to the default route, but in just a bit you&apos;re<br>
going to update the default route to only be visible if the current user is<br>
logged in. Given that, it&apos;s a better option to redirect the user to the &quot;Login&quot;<br>
page.</p>
<h3 class="mume-header" id="testing-the-latest-changes">Testing the latest changes</h3>

<p>Run the application (if it&apos;s not already running) and use the &quot;Login&quot; page to<br>
login an existing user. After logging into the website, you should now see the<br>
user&apos;s first name displayed in the header.</p>
<p>Remember that the <code>restoreUser()</code> function logs the <code>req.session</code> object to the<br>
console. After logging in, you should see something like this logged to the<br>
console:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">Session <span class="token punctuation">{</span>
  cookie: <span class="token punctuation">{</span> path: <span class="token string">&apos;/&apos;</span>, _expires: null, originalMaxAge: null, httpOnly: <span class="token boolean">true</span> <span class="token punctuation">}</span>,
  auth: <span class="token punctuation">{</span> userId: 1 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>The <code>session.auth.userId</code> property value is the user ID of the currently logged<br>
in user.</p>
<p>Now if you click the &quot;Logout&quot; button, you&apos;ll be redirected to the &quot;Login&quot; page.<br>
In the console you&apos;ll see that the <code>session.auth</code> property is no longer defined<br>
on the <code>session</code> object:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">Session <span class="token punctuation">{</span>
  cookie: <span class="token punctuation">{</span> path: <span class="token string">&apos;/&apos;</span>, _expires: null, originalMaxAge: null, httpOnly: <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="protecting-a-route">Protecting a route</h2>

<p>Now that the Reading List application supports user self-registration and login,<br>
it&apos;s time to restrict access to the routes that should only be accessible to<br>
authenticated users.</p>
<p>For some applications, you might need to restrict access to one or two routes.<br>
For the Reading List application, you&apos;ll restrict access to all of the routes in<br>
the <code>./routes/book</code> module so that the user needs to log in view their list of<br>
books (in just a bit you&apos;ll update the <code>Book</code> model so that each book record<br>
will be associated with a user) or to add, update, or delete a book.</p>
<h3 class="mume-header" id="defining-a-middleware-function-to-require-an-authenticated-user">Defining a middleware function to require an authenticated user</h3>

<p>Add a new function named <code>requireAuth()</code> to the <code>auth</code> module. Update the<br>
<code>requireAuth()</code> function to redirect the user to the &quot;Login&quot; page if the<br>
<code>res.locals.authenticated</code> property is set to <code>false</code>, otherwise pass control to<br>
the next middleware function by calling the <code>next()</code> method:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./auth.js</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./db/models&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">loginUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Code removed for brevity.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">logoutUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>auth<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">requireAuth</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>authenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/user/login&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">restoreUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Code removed for brevity.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  loginUser<span class="token punctuation">,</span>
  logoutUser<span class="token punctuation">,</span>
  requireAuth<span class="token punctuation">,</span>
  restoreUser<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Import the <code>requireAuth</code> function into the <code>./routes/book</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> requireAuth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;../auth&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then add the <code>requireAuth</code> to every route:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./routes/book.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> check<span class="token punctuation">,</span> validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-validator&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;../db/models&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> csrfProtection<span class="token punctuation">,</span> asyncHandler <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./utils&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> requireAuth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;../auth&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Code removed for brevity.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/book/add&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Code removed for brevity.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> bookValidators <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// Code removed for brevity.</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/book/add&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> bookValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/book/edit/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/book/edit/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> bookValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/book/delete/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> 
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/book/delete/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> 
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</pre><p>Run the application (if it&apos;s not already running) and browse to the default<br>
route (<code>/</code>). You&apos;ll be redirected to the &quot;Login&quot; page. Go ahead and login using<br>
an existing account. After logging in, you&apos;ll be redirected to the default route<br>
(<code>/</code>) to view your list of books.</p>
<h2 class="mume-header" id="associating-data-with-a-user">Associating data with a user</h2>

<p>Now that you&apos;ve restricted access to all of the book related routes so that a<br>
logged or authenticated user is required, you can update the <code>Book</code> model so<br>
that each book record will be associated with a user.</p>
<h3 class="mume-header" id="defining-an-association">Defining an association</h3>

<p>To start, run the following command in a terminal from the root of your project<br>
to remove all of the seed data from the database:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:seed:undo:all
</pre><p>Then update the <code>Book</code> and <code>User</code> models as follows:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./db/models/book.js</span>

<span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Book <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&apos;Book&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Book<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Book<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&apos;user&apos;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&apos;userId&apos;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Book<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./db/models/user.js</span>

<span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&apos;User&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Book<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&apos;books&apos;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&apos;userId&apos;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Updating the models in this way creates a one-to-many association between the<br>
<code>User</code> and <code>Book</code> models (i.e. a user can have one or more books).</p>
<p>After defining the association in the models, you need to create a new migration<br>
to add the a foreign key column to the <code>Books</code> table in the database. Run the<br>
following command to add a skeleton migration file:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx sequelize migration:generate --name update-book
</pre><p>Then update the contents of the <code>./db/migrations/[timestamp]-update-book.js</code><br>
file to this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token string">&apos;Book&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;userId&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      references<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">:</span> <span class="token string">&apos;Users&apos;</span><span class="token punctuation">,</span>
        key<span class="token punctuation">:</span> <span class="token string">&apos;id&apos;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>The above migration uses the <code>queryInterface.addColumn()</code> method to add a new<br>
column to the <code>Books</code> table. In this specific case, you&apos;re adding a column named<br>
<code>userId</code> that&apos;s a foreign key to the <code>Users</code> table <code>id</code> column.</p>
<p>Now apply the pending migration:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:migrate
</pre><h3 class="mume-header" id="updating-the-seed-data">Updating the seed data</h3>

<p>Open the <code>./db/seeders/[timestamp]-test-data.js</code> file and update its contents to<br>
this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;bcryptjs&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span><span class="token string">&apos;Users&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        emailAddress<span class="token punctuation">:</span> <span class="token string">&apos;john@smith.com&apos;</span><span class="token punctuation">,</span>
        firstName<span class="token punctuation">:</span> <span class="token string">&apos;John&apos;</span><span class="token punctuation">,</span>
        lastName<span class="token punctuation">:</span> <span class="token string">&apos;Smith&apos;</span><span class="token punctuation">,</span>
        hashedPassword<span class="token punctuation">:</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span><span class="token string">&apos;P@ssw0rd&apos;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> returning<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span><span class="token string">&apos;Books&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        userId<span class="token punctuation">:</span> users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;The Martian&apos;</span><span class="token punctuation">,</span>
        author<span class="token punctuation">:</span> <span class="token string">&apos;Andy Weir&apos;</span><span class="token punctuation">,</span>
        releaseDate<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">&apos;2014-02-11&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pageCount<span class="token punctuation">:</span> <span class="token number">384</span><span class="token punctuation">,</span>
        publisher<span class="token punctuation">:</span> <span class="token string">&apos;Crown&apos;</span><span class="token punctuation">,</span>
        createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        userId<span class="token punctuation">:</span> users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;Ready Player One&apos;</span><span class="token punctuation">,</span>
        author<span class="token punctuation">:</span> <span class="token string">&apos;Ernest Cline&apos;</span><span class="token punctuation">,</span>
        releaseDate<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">&apos;2011-08-16&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pageCount<span class="token punctuation">:</span> <span class="token number">384</span><span class="token punctuation">,</span>
        publisher<span class="token punctuation">:</span> <span class="token string">&apos;Crown&apos;</span><span class="token punctuation">,</span>
        createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        userId<span class="token punctuation">:</span> users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;Harry Potter and the Sorcerer\&apos;s Stone&apos;</span><span class="token punctuation">,</span>
        author<span class="token punctuation">:</span> <span class="token string">&apos;J.K. Rowling&apos;</span><span class="token punctuation">,</span>
        releaseDate<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">&apos;1998-10-01&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pageCount<span class="token punctuation">:</span> <span class="token number">309</span><span class="token punctuation">,</span>
        publisher<span class="token punctuation">:</span> <span class="token string">&apos;Scholastic Press&apos;</span><span class="token punctuation">,</span>
        createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">&apos;Books&apos;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">&apos;Users&apos;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>An additional call to the <code>queryInterface.bulkInsert()</code> method has been added to<br>
seed a test user, &quot;John Smith&quot;, into the <code>Users</code> database table. Notice that an<br>
object literal has been supplied to the <code>queryInterface.bulkInsert()</code> method to<br>
specify the <code>returning</code> option. The <code>returning</code> optional configures the bulk<br>
insert to return the newly inserted data. This gives you a way to set the<br>
<code>userId</code> foreign key column when bulk inserting the test data into the <code>Books</code><br>
table.</p>
<p>To seed the database, run the following command:</p>
<pre data-role="codeBlock" data-info class="language-"><code>npx dotenv sequelize db:seed:all
</code></pre><h3 class="mume-header" id="updating-the-book-related-routes">Updating the book related routes</h3>

<p>Now that books are associated with a user, you can update the default route to<br>
retrieve the list of books for the currently authenticated user:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> books <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>Book<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> userId<span class="token punctuation">:</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span> order<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&apos;title&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;ASC&apos;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;book-list&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&apos;Books&apos;</span><span class="token punctuation">,</span> books <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The options object passed into the <code>db.Book.findAll()</code> method call has been<br>
updated with a <code>where</code> property. The <code>where</code> property is set to an object<br>
literal that defines the properties to filter the query results by. In this<br>
case, you&apos;re filtering by the <code>userId</code> column, using the <code>res.locals.user.id</code><br>
property value.</p>
<p>When users initially create an account, they won&apos;t have any books in their<br>
reading list. You can update the <code>book-list</code> view to display a friendly message<br>
when that occurs:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token comment">// ./views/book-list.pug</span>

<span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;py-3&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-success&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/book/add&apos;</span> role<span class="token operator">=</span><span class="token string">&apos;button&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Add Book</span>
  <span class="token flow-control"><span class="token branch keyword">if</span> books <span class="token operator">&amp;&amp;</span> books<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span></span>
    <span class="token tag">table<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;table table-striped table-hover&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">thead<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;thead-dark&apos;</span></span><span class="token punctuation">)</span></span></span>
        <span class="token tag">tr</span>
          <span class="token tag">th<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">scope</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;col&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Title</span>
          <span class="token tag">th<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">scope</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;col&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Author</span>
          <span class="token tag">th<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">scope</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;col&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Release Date</span>
          <span class="token tag">th<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">scope</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;col&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Page Count</span>
          <span class="token tag">th<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">scope</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;col&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Publisher</span>
          <span class="token tag">th<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">scope</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;col&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">tbody</span>
        <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> book <span class="token keyword">in</span></span> books</span>
          <span class="token tag">tr</span>
            <span class="token tag">td</span><span class="token punctuation">=</span><span class="token code"> book<span class="token punctuation">.</span>title</span>
            <span class="token tag">td</span><span class="token punctuation">=</span><span class="token code"> book<span class="token punctuation">.</span>author</span>
            <span class="token tag">td</span><span class="token punctuation">=</span><span class="token code"> book<span class="token punctuation">.</span>releaseDate</span>
            <span class="token tag">td</span><span class="token punctuation">=</span><span class="token code"> book<span class="token punctuation">.</span>pageCount</span>
            <span class="token tag">td</span><span class="token punctuation">=</span><span class="token code"> book<span class="token punctuation">.</span>publisher</span>
            <span class="token tag">td</span>
              <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-primary&apos;</span> href<span class="token operator">=</span><span class="token template-string"><span class="token string">`/book/edit/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>book<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> role<span class="token operator">=</span><span class="token string">&apos;button&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Edit</span>
              <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-danger ml-2&apos;</span> href<span class="token operator">=</span><span class="token template-string"><span class="token string">`/book/delete/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>book<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> role<span class="token operator">=</span><span class="token string">&apos;button&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Delete</span>
  <span class="token flow-control"><span class="token branch keyword">else</span></span>
    <span class="token tag">p<span class="token punctuation">:</span></span> <span class="token tag">em</span> <span class="token tag">You</span> <span class="token tag">don</span>&apos;t have any books in your reading list<span class="token punctuation">!</span>
</pre><p>When a user adds a new book, you need to update the book&apos;s <code>userId</code> property<br>
with the authenticated user&apos;s <code>id</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/book/add&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> bookValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">,</span>
      author<span class="token punctuation">,</span>
      releaseDate<span class="token punctuation">,</span>
      pageCount<span class="token punctuation">,</span>
      publisher<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> book <span class="token operator">=</span> db<span class="token punctuation">.</span>Book<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      userId<span class="token punctuation">:</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      title<span class="token punctuation">,</span>
      author<span class="token punctuation">,</span>
      releaseDate<span class="token punctuation">,</span>
      pageCount<span class="token punctuation">,</span>
      publisher<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> book<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;book-add&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;Add Book&apos;</span><span class="token punctuation">,</span>
        book<span class="token punctuation">,</span>
        errors<span class="token punctuation">,</span>
        csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>And lastly, you need to ensure that the current can only edit or delete their<br>
own books. To be clear, as long as the user uses the application&apos;s user<br>
interface to edit and delete books, this would never be an issue. This situation<br>
would only arise if a user maliciously edited their current URL to attempt to<br>
edit or delete a book that belonged to another user.</p>
<p>Luckily, this issue is easy to prevent. In the <code>./routes/book</code> module, add<br>
the following function above the route definitions:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">checkPermissions</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">book<span class="token punctuation">,</span> currentUser</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>book<span class="token punctuation">.</span>userId <span class="token operator">!==</span> currentUser<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&apos;Illegal operation.&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">403</span><span class="token punctuation">;</span> <span class="token comment">// Forbidden</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>The <code>checkPermissions()</code> function accepts a book and current user and throws an<br>
error if the book&apos;s associated user doesn&apos;t match the current user.</p>
<p>Then update each of the edit and delete routes to call the <code>checkPermissions()</code><br>
function:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/book/edit/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> bookId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> book <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>Book<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">checkPermissions</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;book-edit&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&apos;Edit Book&apos;</span><span class="token punctuation">,</span>
      book<span class="token punctuation">,</span>
      csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/book/edit/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> bookValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> bookId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> bookToUpdate <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>Book<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">checkPermissions</span><span class="token punctuation">(</span>bookToUpdate<span class="token punctuation">,</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">,</span>
      author<span class="token punctuation">,</span>
      releaseDate<span class="token punctuation">,</span>
      pageCount<span class="token punctuation">,</span>
      publisher<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> book <span class="token operator">=</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">,</span>
      author<span class="token punctuation">,</span>
      releaseDate<span class="token punctuation">,</span>
      pageCount<span class="token punctuation">,</span>
      publisher<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> validatorErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validatorErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> bookToUpdate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errors <span class="token operator">=</span> validatorErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;book-edit&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        title<span class="token punctuation">:</span> <span class="token string">&apos;Edit Book&apos;</span><span class="token punctuation">,</span>
        book<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span>book<span class="token punctuation">,</span> bookId <span class="token punctuation">}</span><span class="token punctuation">,</span>
        errors<span class="token punctuation">,</span>
        csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/book/delete/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> bookId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> book <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>Book<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">checkPermissions</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&apos;book-delete&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&apos;Delete Book&apos;</span><span class="token punctuation">,</span>
      book<span class="token punctuation">,</span>
      csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/book/delete/:id(\\d+)&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> bookId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> book <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>Book<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">checkPermissions</span><span class="token punctuation">(</span>book<span class="token punctuation">,</span> res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> book<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="testing-one-more-time">Testing one more time</h3>

<p>Now you&apos;re ready to do your final testing!</p>
<p>Login using the test user that you defined in your seed data. You should see the<br>
test user&apos;s list of books. Now logout the test user and login as another user.<br>
You should now see that user&apos;s list of books. If the user doesn&apos;t have any books<br>
in their reading list, add a new book. You should now only be seeing this user&apos;s<br>
books.</p>
<p>Congrats on completing the Reading List application... now with authentication!</p>
<h2 class="mume-header" id="the-importance-of-using-https">The importance of using HTTPS</h2>

<p>As a reminder, form fields are submitted in clear text to the server! This means<br>
that passwords can be <em>sniffed</em> or hijacked if the communication between the<br>
client and the server isn&apos;t encrypted. This brings us to why HTTPS (hypertext<br>
transfer protocol secure) is important. HTTP uses a digital certificate for<br>
authentication known as an SSL certificate to make a web application more<br>
secure. TSL and SSL protocol are often lumped together, as TLS is another<br>
protocol that encrypts communication between the client and server.</p>
<p>The use of HTTPS instead of HTTP means that TSL/SSL encryption is being used to<br>
keep form posts away from prying eyes!</p>
<p>In order to implement HTTPS, a domain requires an SSL certificate. SSL<br>
certificates can be purchased from companies that verify your identity so that<br>
you can be issued you a certificate for your domain. Once you have the<br>
certificate (which is simply a digital file), you then install the certificate<br>
on the server.</p>
<p>Typically, this server isn&apos;t your Node or Express application, but another web<br>
server that serves as a proxy server for your application. A proxy server<br>
receives all of the HTTP requests from the internet to your application&apos;s domain<br>
and forwards those requests to your application. Your application will then send<br>
responses to the proxy server, which then forwards them on to the client.</p>
<h2 class="mume-header" id="next-steps">Next steps</h2>

<p>There&apos;s so much more to learn about authentication! For example, it is important<br>
to know about implementing user roles as well as other user authentication<br>
flows. Examples of other user authentication processes include email<br>
confirmation, allowing users to reset their password, and two-factor<br>
authentication.</p>
<p>You&apos;ll dive into more components of user authentication as you learn more about<br>
web security and authentication!</p>
<hr>
<h1 class="mume-header" id="project-amusement-park-tracker-with-authentication">Project: Amusement Park Tracker with Authentication</h1>

<p>This project picks up where the first Amusement Park Tracker project left off!<br>
In the provided starter project, you can view, create, update, and delete both<br>
parks and attractions. In this project you&apos;ll extend the provided application<br>
with the following features:</p>
<ul>
<li>User self-registration and login; and</li>
<li>Ability for users to record visits to park attractions.</li>
</ul>
<h2 class="mume-header" id="phase-0-download-the-starter-project">Phase 0: Download the starter project</h2>

<p>Clone the starter project:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">git</span> clone https://github.com/appacademy-starters/express-amusement-park-tracker-with-auth.git
</pre><p>Then complete the following set up steps:</p>
<ul>
<li>Create the database and limited access database user;</li>
<li>Add an <code>.env</code> file containing the variables from the <code>.env.example</code> file;</li>
<li>Install the project&apos;s dependencies (<code>npm install</code>); and</li>
<li>Use the Sequelize CLI to apply the provided database migrations and seeder.</li>
</ul>
<p>Now you can start (<code>npm start</code>) and test the application!</p>
<h2 class="mume-header" id="phase-1-create-the-user-model">Phase 1: Create the User model</h2>

<p>The <code>User</code> model should include the following properties:</p>
<ul>
<li><code>emailAddress</code> - A non-nullable string (length: 255) representing the user&apos;s<br>
email address;</li>
<li><code>firstName</code> - A non-nullable string (length: 50) representing the user&apos;s first<br>
name;</li>
<li><code>lastName</code> - A non-nullable string (length: 50) representing the user&apos;s last<br>
name; and</li>
<li><code>hashedPassword</code> - A non-nullable binary string representing the user&apos;s hashed<br>
password.</li>
</ul>
<p>Use the Sequelize CLI to generate the <code>User</code> model and migration. Then edit both<br>
files to use the expected attribute and column configuration. Remember to make<br>
the <code>hashedPassword</code> attribute have a datatype of <code>STRING.BINARY</code>.</p>
<p>Apply the migration when you&apos;re ready.</p>
<h2 class="mume-header" id="phase-2-configure-express-to-use-sessions">Phase 2: Configure Express to use sessions</h2>

<p>Take a moment to install:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> express-session
</pre><p>Now let&apos;s configure your session store. Add the <code>express-session</code> middleware to<br>
the <code>app</code> module:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-session&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Make sure you have required <code>session</code> from the <code>express-session</code> package and<br>
have your application use the session. Make sure you configure the session with<br>
both <code>resave</code> and <code>saveUninitialized</code> set to <code>false</code>.</p>
<p>Take a moment set a <code>SESSION_SECRET</code> environment variable in your <code>.env</code> file.<br>
Add a key of <code>sessionSecret</code> connected to the <code>process.env.SESSION_SECRET</code> in<br>
your <code>./config/index.js</code> module as well. As a reminder, you can generate a<br>
<a href="https://www.npmjs.com/package/uuid">UUID</a> to have a more secure <code>sessionSecret</code> variable value.</p>
<p>In the <code>app</code> module, make sure to also import the <code>sessionSecret</code> in your<br>
<code>./config</code> require statement. As a reminder, be sure to use the same <code>secret</code><br>
value for the <code>express-session</code> and <code>cookie-parser</code> middleware.</p>
<p>Your session should be configured like so:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> sessionSecret<span class="token punctuation">,</span> 
  resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
  saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="phase-3-support-user-self-registration">Phase 3: Support user self-registration</h2>

<p>Now it&apos;s time to add the user registration form.</p>
<p>Begin by creating a <code>./routes/user</code> module. Import <code>express</code> and instantiate a<br>
<code>router</code> with <code>express.Router()</code>. Import your <code>db</code> from your <code>../db/models</code> and<br>
create <code>GET</code> and <code>POST</code> routes for the &quot;Register&quot; page (<code>/user/register</code>). Make<br>
sure to use CSRF protection as well the <code>bcryptjs</code> npm package to hash user<br>
passwords. Lastly, don&apos;t forget to export the router module you have just<br>
created.</p>
<p>Take note that you already have a <code>routes/utils.js</code> module that holds utility<br>
functions like the <code>csrfProtection</code> and <code>asyncHandler</code> methods you are familiar<br>
with. Import both of these methods into your <code>./routes/user</code> module with a<br>
require statement to the <code>./utils</code> module like so:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> csrfProtection<span class="token punctuation">,</span> asyncHandler <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./utils&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now you can use your <code>csrfProtection</code> and <code>asyncHandler</code> in your <code>./routes/user</code><br>
module!</p>
<p>In your GET <code>/user/register</code> route, use <code>db.User.build()</code> to initialize a new<br>
user to pass into the <code>user-register</code> view. Make sure to also pass in a <code>title</code><br>
for your &quot;Register&quot; page as well as a <code>csrfToken</code> (with a value of<br>
<code>req.csrfToken()</code>). Add <code>csrfProtection</code> to your route, and let&apos;s create your<br>
<code>user-register</code> template.</p>
<p>Render a template that extends the main layout and has a form within<br>
<code>block content</code>. Take note of the mixins in the <code>utils.pug</code> file that are<br>
available for you to use. The form should contain the following input fields:</p>
<ul>
<li>First Name</li>
<li>Last Name</li>
<li>Email Address</li>
<li>Password</li>
<li>Confirm Password</li>
</ul>
<p>Don&apos;t forget to have a hidden input field for your <code>_csrf</code> field as well as a<br>
submit button. Once you have your view set up, let&apos;s create your POST route for<br>
user registration!</p>
<p>In your POST <code>/user/register</code> route, make sure to use <code>userValidators</code> in<br>
addition to your <code>csrfProtection</code> middleware. This means you&apos;ll need to import<br>
<code>check</code> and <code>validationResult</code> from <code>express-validator</code>.</p>
<p>At this moment, implement the following validation rules:</p>
<ul>
<li><code>firstName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul>
</li>
<li><code>lastName</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
</ul>
</li>
<li><code>emailAddress</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 255 characters</li>
<li>Is a valid email address</li>
<li>Should not be in use by an existing account</li>
</ul>
</li>
<li><code>password</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
<li>Should contain at least 1 lowercase letter, uppercase letter, number, and<br>
special character (i.e. &quot;!@#$%^&amp;*&quot;) Hint: review the <em>Implementing<br>
Session-Based Authentication</em> reading and see below for reminders on how to<br>
<a href="https://www.thepolyglotdeveloper.com/2015/05/use-regex-to-test-password-strength-in-javascript/">use regex</a> for validation!</li>
</ul>
</li>
<li><code>confirmPassword</code>
<ul>
<li>Not null or empty</li>
<li>Not longer than 50 characters</li>
<li>Should match the provided <code>password</code> value</li>
</ul>
</li>
</ul>
<h3 class="mume-header" id="regex-reminders">Regex Reminders</h3>

<ul>
<li>The hat operator <code>^</code> is used to start matching at the beginning of the<br>
password.</li>
<li>The expression <code>(?=.*[a-z])</code> is used to check that the password contains at<br>
least one lowercase character.</li>
<li>The expression <code>(?=.*[A-Z])</code> is used to check that the password contains at<br>
least one uppercase character.</li>
<li>The expression <code>(?=.*[0-9])</code> is used to check that the password contains at<br>
least one numeric character.</li>
<li>The expression <code>(?=.*[!@#$%^&amp;*])</code> is used to check that the password contains<br>
at least one special character.</li>
</ul>
<p>Now return to your POST route and wrap your asynchronous route function with<br>
your <code>asyncHandler</code> so that you can <code>await</code> certain processes in your route.<br>
Begin by destructuring the <code>emailAddress</code>, <code>firstName</code>, <code>lastName</code>, and<br>
<code>password</code> from your <code>req.body</code> object. Then use the <code>emailAddress</code>,<br>
<code>firstName</code>, and <code>lastName</code> variables (but not the <code>password</code> variable) to<br>
build a user with the <code>db.User.build()</code> method.</p>
<p>At this point, generate your <code>validatorErrors</code> within your route by using the<br>
<code>validationResult</code> method from <code>express-validator</code>. If the <code>validatorErrors</code> are<br>
empty, <code>await</code> the generation of your <code>hashedPassword</code> created with<br>
<code>bcrypt.hash()</code>. Make sure import <code>bcrypt</code> by installing and requiring the<br>
<code>bcryptjs</code> package. Remember that the first argument of <code>bcrypt.hash()</code> is a<br>
password string. You can use use an integer for the second argument to<br>
auto-generate a salt that will be incorporated in the password hash process.<br>
After hashing the user password, set the <code>user.hashedPassword</code> property and<br>
<code>await</code> the save of your user instance. Lastly, redirect the user to the home<br>
page (<code>/</code>) upon successful registration.</p>
<p>If the <code>validatorErrors</code> are NOT empty, use <code>array()</code> to transform the<br>
<code>validatorErrors</code> object into a mappable array. Map over each <code>error</code> object in<br>
the array and pluck out each error&apos;s <code>msg</code> property to generate an array of<br>
error messages. Lastly, re-render your <code>user-register</code> form and pass in your<br>
<code>title</code> of &quot;Register&quot;, the <code>user</code> object, the <code>errors</code> array, and the<br>
<code>csrfToken</code>.</p>
<p>Now run your application and test the <code>/user/register</code> route! Remember that you<br>
can test your route by registering a user through the form and using Postbird to<br>
confirm whether or not your user has been persisted to the database.</p>
<h2 class="mume-header" id="phase-4-support-user-login">Phase 4: Support user login</h2>

<p>Now it&apos;s time to add the user login form! Begin by updating the <code>./routes/user</code><br>
module with <code>GET</code> and <code>POST</code> routes for the &quot;Login&quot; page (<code>/user/login</code>). Make<br>
sure to use CSRF protection for both routes.</p>
<p>Render your <code>user-login</code> template in your GET <code>/user/login</code> route. Pass along a<br>
<code>title</code> for your &quot;Login&quot; page as well as a <code>csrfToken</code>. Now let&apos;s create the<br>
view template for your login page!</p>
<p>Create a <code>user-login.pug</code> template in your views directory. Think of how you can<br>
include and re-use mixins from your <code>utils.pug</code> file just like in your<br>
&quot;Register&quot; page. The &quot;Login&quot; form should contain an &quot;Email Address&quot; field, a<br>
&quot;Password&quot; field, a hidden <code>_csrf</code> field, and a submit button.</p>
<p>Now let&apos;s revisit the POST <code>/user/login</code> route. You&apos;ll want to validate your<br>
login form data, so take a moment to implement the following validation rules:</p>
<ul>
<li><code>emailAddress</code>
<ul>
<li>Not null or empty</li>
</ul>
</li>
<li><code>password</code>
<ul>
<li>Not null or empty</li>
</ul>
</li>
</ul>
<p>After your <code>loginValidators</code> have been created, wrap your asynchronous route<br>
function within your <code>asyncHandler</code> function and destructure the <code>emailAddress</code><br>
and <code>password</code> from your <code>req.body</code> object. Generate your <code>validatorErrors</code> by<br>
passing in the <code>req</code> body into the <code>validationResult</code> function. Also take a<br>
moment to initialize an <code>errors</code> array. You&apos;ll manually <em>push</em> error messages to<br>
render into this array.</p>
<p>If your validation errors are empty, try to find the user by their email<br>
address. You can <code>await</code> the database fetch of a <code>user</code> by using the<br>
<code>db.User.findOne()</code> function <code>where</code> the user has a matching <code>emailAddress</code>. If<br>
the user exists, use the <code>bcrypt.compare()</code> function to check whether the<br>
<code>user.hashedPassword</code> (parsed into string format) property matches the provided<br>
password from <code>req.body</code>. If there is a password match, log in the user (for<br>
now just leave yourself a <code>TODO</code> comment to log in the user) and redirect the<br>
user to the home page (<code>/</code>).</p>
<p>If your validator errors are empty and the user was not found, or the password<br>
did not match the <code>hashedPassword</code>, display an error message to the user by<br>
pushing in a &quot;Login failed for the provided email address and password&quot; message<br>
into the <code>errors</code> array you initialized.</p>
<p>If your validation errors are not empty, convert your <code>validatorErrors</code> object<br>
into an mappable <code>errors</code> array to pluck error messages and generate an array of<br>
error messages. Lastly, you need to render a <code>user-login</code> view for this route.<br>
Make sure to pass in the &quot;Login&quot; title, the <code>emailAddress</code> from <code>req.body</code>, the<br>
<code>errors</code> array, and a <code>csrfToken</code>.</p>
<h3 class="mume-header" id="testing-user-login-1">Testing user login</h3>

<p>Run the application and browse to the <code>/user/login</code> route. You can test the user<br>
login form with the following actions:</p>
<ul>
<li>Submit the form with no values.
<ul>
<li>You should see two validation messages asking you to provide values.</li>
</ul>
</li>
<li>Submit the form with an email address that isn&apos;t associated with a user record<br>
in the database and a password (doesn&apos;t matter if the password is correct or<br>
not).
<ul>
<li>You should see a validation message letting you know that the login attempt<br>
failed.</li>
</ul>
</li>
<li>Submit the form with an email address that&apos;s associated with a user record in<br>
the database <strong>but with an incorrect password</strong>.
<ul>
<li>You should see a validation message letting you know that the login attempt<br>
failed.</li>
</ul>
</li>
<li>Submit the form with an email address that&apos;s associated with a user record in<br>
the database <strong>and with a correct password</strong>.
<ul>
<li>This time you should be redirected to the &quot;Home&quot; page.</li>
</ul>
</li>
</ul>
<h2 class="mume-header" id="phase-5-persist-user-login-state">Phase 5: Persist user login state</h2>

<p>Now it&apos;s time to handle persisting the user&apos;s login state after they&apos;ve<br>
successfully logged into the website!</p>
<h3 class="mume-header" id="using-sessions-to-persist-a-users-login-state-1">Using sessions to persist a user&apos;s login state</h3>

<p>Add a new module named <code>auth</code> to the root of your project and add function named<br>
<code>loginUser()</code> to handle persisting a user&apos;s login state to session.</p>
<p>Update the <code>./routes/user</code> module to import the <code>loginUser()</code> function from the<br>
<code>auth</code> module. Then within the <code>POST</code> <code>/user/login</code> route handler add a call to<br>
the <code>loginUser()</code> function just before redirecting the user to the default route<br>
if the password matched.</p>
<p>Also, after a new user has registered in the <code>POST</code> <code>/user/register</code> route<br>
handler, add a call to the <code>loginUser()</code> function after saving the user to the<br>
database but before redirecting then to the default route.</p>
<h3 class="mume-header" id="testing-user-login-state-persistence-1">Testing user login state persistence</h3>

<p>Run the application (if it&apos;s not already running) and use the &quot;Register&quot; and<br>
&quot;Login&quot; pages to register a new user and login an existing user. Everything<br>
should work as it did before, but the user&apos;s login state is being persisted in<br>
session.</p>
<p>At this point in the project, there isn&apos;t any visual indication if the user is<br>
logged in or not (that&apos;s something that you&apos;ll fix in a bit). If you open your<br>
developer tools and view the &quot;Application&quot; tab, you can view the cookies for<br>
<code>http://localhost:8080</code>. After registering a new user or logging in an existing<br>
user, you should see a cookie named <code>reading-list.sid</code>. That&apos;s the session<br>
cookie!</p>
<h2 class="mume-header" id="phase-6-restore-the-authenticated-user-from-session">Phase 6: Restore the authenticated user from session</h2>

<p>Now that you&apos;re persisting a user&apos;s login state to session, you need to make<br>
that user&apos;s information easily accessible to your application when it&apos;s<br>
processing requests.</p>
<p>In the <code>auth</code> module, define a middleware function named <code>restoreUser()</code> to<br>
retrieve the user&apos;s information from the database if they&apos;re authenticated.</p>
<p>The function should check if the <code>req.session.auth</code> property is defined to<br>
determine if there&apos;s an authenticated user. If there is, extract the <code>userId</code><br>
from the <code>req.session.auth</code> property and retrieve the user from the database.</p>
<p>If the user is successfully retrieved from the database, then use the<br>
<code>res.locals</code> object to define and set two properties:</p>
<ul>
<li><code>authenticated</code> - Set to <code>true</code> to indicate that the current request has an<br>
authenticated user; and</li>
<li><code>user</code> - Set to the user that was just retrieved from the database.</li>
</ul>
<p>If the <code>req.session.auth</code> property isn&apos;t defined or if retrieving the user from<br>
the database throws an error then set the <code>res.locals.authenticated</code> property to<br>
<code>false</code> to indicate that the current request doesn&apos;t have an authenticated user<br>
(i.e. it&apos;s an anonymous request).</p>
<p>After defining the <code>restoreUser()</code> function, export it from the <code>auth</code> module<br>
and import it into the <code>app</code> module. Then add the <code>restoreUser()</code> middleware<br>
function to the application just before the routes are added.</p>
<h2 class="mume-header" id="phase-7-display-the-users-login-state">Phase 7: Display the user&apos;s login state</h2>

<p>It&apos;s helpful to display to the end user whether or not they&apos;re currently logged<br>
in. A common approach is to display login and registration links or a welcome<br>
message in the header of the website.</p>
<p>If the user isn&apos;t logged in, they would see links to log in or register:</p>
<blockquote>
<p>Login | Register</p>
</blockquote>
<p>If the user is logged in, they would be welcomed and have access to logging out:</p>
<blockquote>
<p>Welcome &#xAB;current user name&#xBB;! | Logout</p>
</blockquote>
<p>To do that, update your <code>./views/layout.pug</code> template to use the<br>
<code>locals.authenticated</code> property to determine if the current user is logged in or<br>
not.</p>
<p>If the current user is logged in, then render a short, friendly &quot;welcome&quot;<br>
message is along with a simple form that contains a single &quot;Logout&quot; submit<br>
button:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token tag">span<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-text px-4&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Welcome #{user.firstName}!</span>
<span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;form-inline pr-4&apos;</span> action<span class="token operator">=</span><span class="token string">&apos;/user/logout&apos;</span> method<span class="token operator">=</span><span class="token string">&apos;post&apos;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-warning&apos;</span> type<span class="token operator">=</span><span class="token string">&apos;submit&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Logout</span>
</pre><p>If the current user isn&apos;t logged in, then render links (styled as buttons using<br>
Bootstrap CSS classes) to the &quot;Login&quot; and &quot;Register&quot; pages.</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token tag">span<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;navbar-text px-4&apos;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-dark mr-2&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/user/login&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Login</span>
  <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;btn btn-sm btn-dark&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/user/register&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Register</span>
</pre><p>Now if you run and test your application, you&apos;ll see the current user&apos;s login<br>
state displayed in the header! If you log in and click the &quot;Logout&quot; button in<br>
the header, you&apos;ll receive a &quot;Page Not Found&quot; error. This is occurring because<br>
the <code>POST</code> <code>/user/logout</code> route doesn&apos;t exist. Time to fix that!</p>
<h2 class="mume-header" id="phase-8-implement-user-logout">Phase 8: Implement user logout</h2>

<p>Define and export a <code>logoutUser()</code> function in the <code>auth</code> module that removes<br>
the <code>auth</code> property from the <code>req.session</code> object.</p>
<p>Then add a <code>POST</code> <code>/user/logout</code> to the <code>./routes/user</code> module to process <code>POST</code><br>
requests from the logout form. Import the <code>logoutUser()</code> function from the<br>
<code>auth</code> module and call it within the <code>POST</code> <code>/user/logout</code> route handler then<br>
redirect the user to the default route.</p>
<p>The <code>POST</code> <code>/user/logout</code> route isn&apos;t modifying any of the user&apos;s data in the<br>
database so there&apos;s no need to protect it from CSRF attacks.</p>
<h3 class="mume-header" id="testing-the-latest-changes-1">Testing the latest changes</h3>

<p>Run the application and use the &quot;Login&quot; page to login an existing user. You<br>
should now see the user&apos;s first name displayed in the header.</p>
<p>After logging in, you should see something like this logged to the console:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">Session <span class="token punctuation">{</span>
  cookie: <span class="token punctuation">{</span> path: <span class="token string">&apos;/&apos;</span>, _expires: null, originalMaxAge: null, httpOnly: <span class="token boolean">true</span> <span class="token punctuation">}</span>,
  auth: <span class="token punctuation">{</span> userId: 1 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Now click the &quot;Logout&quot; button, and you should be redirected to the &quot;Login&quot; page.<br>
In the console you should see that the <code>session.auth</code> property is no longer<br>
defined on the <code>session</code> object:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">Session <span class="token punctuation">{</span>
  cookie: <span class="token punctuation">{</span> path: <span class="token string">&apos;/&apos;</span>, _expires: null, originalMaxAge: null, httpOnly: <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="phase-9-support-user-attraction-visits">Phase 9: Support user attraction visits</h2>

<p>Now you&apos;re ready to add support for user attraction visits.</p>
<h3 class="mume-header" id="create-the-attractionvisit-model">Create the AttractionVisit model</h3>

<p>The <code>AttractionVisit</code> model should include the following properties:</p>
<ul>
<li><code>visitedOn</code> - A non-nullable date only attribute representing the date that<br>
the user visited the attraction;</li>
<li><code>rating</code> - A non-nullable integer attribute representing the user&apos;s rating of<br>
the attraction; and</li>
<li><code>comments</code> - A nullable text attribute representing the user&apos;s comments about<br>
the attraction.</li>
</ul>
<p>Use the Sequelize CLI to generate the <code>AttractionVisit</code> model and migration.<br>
Then edit both files to use the expected attribute and column configuration.</p>
<p>Before applying the migration, associate the model with both the <code>Attraction</code><br>
and <code>User</code> models:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./db/models/attractionvisit.js</span>

<span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> AttractionVisit <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&apos;AttractionVisit&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

    <span class="token comment">// Code removed for brevity.</span>

  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  AttractionVisit<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    AttractionVisit<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Attraction<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&apos;attraction&apos;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&apos;attractionId&apos;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AttractionVisit<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&apos;user&apos;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&apos;userId&apos;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> AttractionVisit<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./db/models/attraction.js</span>

<span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Attraction <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&apos;Attraction&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

    <span class="token comment">// Code removed for brevity.</span>

  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Attraction<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Attraction<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Park<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&apos;park&apos;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&apos;parkId&apos;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Attraction<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>AttractionVisit<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&apos;visits&apos;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&apos;attractionId&apos;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Attraction<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// ./db/models/user.js</span>

<span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&apos;User&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>

    <span class="token comment">// Code removed for brevity.</span>

  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>AttractionVisit<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&apos;visits&apos;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&apos;userId&apos;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Then update the <code>./db/migrations/[timestamp]-create-attraction-visit.js</code><br>
migration file with the <code>userId</code> and <code>attractionId</code> foreign key columns:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&apos;use strict&apos;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&apos;AttractionVisits&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      userId<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        references<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          model<span class="token punctuation">:</span> <span class="token string">&apos;Users&apos;</span><span class="token punctuation">,</span>
          key<span class="token punctuation">:</span> <span class="token string">&apos;id&apos;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      attractionId<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        references<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          model<span class="token punctuation">:</span> <span class="token string">&apos;Attractions&apos;</span><span class="token punctuation">,</span>
          key<span class="token punctuation">:</span> <span class="token string">&apos;id&apos;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// Code removed for brevity.</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&apos;AttractionVisits&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>These model associations create a one-to-many relationship between the<br>
<code>Attraction</code> and <code>AttractionVisit</code> models and a one-to-many relationship between<br>
the <code>User</code> and <code>AttractionVisit</code> model. Alternatively, you can think of the<br>
relationship as a many-to-many between the <code>Attraction</code> and <code>User</code> models (i.e.<br>
an attraction can be visited by many users and a user can visit many<br>
attractions).</p>
<p>Apply the migration when you&apos;re ready.</p>
<h3 class="mume-header" id="update-the-attraction-detail-page">Update the Attraction Detail page</h3>

<p>Update the Attraction Detail page to display a list of attraction visits.<br>
Display an &quot;Add Visit&quot; button (a hyperlink styled as a button using Bootstrap&apos;s<br>
CSS classes) above the list of attraction visits that when clicked, navigates<br>
the user to the &quot;Add Visit&quot; page.</p>
<h3 class="mume-header" id="add-the-add-visit-page">Add the Add Visit page</h3>

<p>Add a <code>./routes/visit</code> module, then add the <code>GET</code> and <code>POST</code> routes for the<br>
&quot;Add Visit&quot; page:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> visitValidators <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// TODO Define validators.</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/attraction/:attractionId(\\d+)/visit/add&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO Implement route handler.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/attraction/:attractionId(\\d+)/visit/add&apos;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> visitValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO Implement route handler.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In your POST <code>/user/register</code> route, make sure to use <code>visitValidators</code> in<br>
addition to your <code>csrfProtection</code> middleware. This means you&apos;ll need to import<br>
<code>check</code> and <code>validationResult</code> from <code>express-validator</code>.</p>
<p>Implement the following validation rules:</p>
<ul>
<li><code>visitedOn</code>
<ul>
<li>Not null or empty</li>
<li>Is a valid date</li>
</ul>
</li>
<li><code>rating</code>
<ul>
<li>Not null or empty</li>
<li>Is an integer between 1 and 5</li>
</ul>
</li>
</ul>
<p>Render a template that extends the main layout and has a form within<br>
<code>block content</code>. Take note of the mixins and <code>validationErrorSummary</code> template<br>
that are available for you to use. The form should contain the following input<br>
fields:</p>
<ul>
<li>Visited On</li>
<li>Rating</li>
<li>Comments</li>
</ul>
<h3 class="mume-header" id="require-a-logged-in-user">Require a logged in user</h3>

<p>To add a new visit, the user needs to be logged into the website. Without a<br>
logged in user, you wouldn&apos;t know who to add the visit for!</p>
<p>Add a new function named <code>requireAuth()</code> to the <code>auth</code> module. Update the<br>
<code>requireAuth()</code> function to redirect the user to the &quot;Login&quot; page if the<br>
<code>res.locals.authenticated</code> property is set to <code>false</code>, otherwise pass control to<br>
the next middleware function by calling the <code>next()</code> method.</p>
<p>Then import the <code>requireAuth()</code> function into the <code>./routes/visit</code> module and<br>
add it to the <code>GET</code> and <code>POST</code> routes for the &quot;Add Visit&quot; page:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&apos;/attraction/:attractionId(\\d+)/visit/add&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/attraction/:attractionId(\\d+)/visit/add&apos;</span><span class="token punctuation">,</span> requireAuth<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> visitValidators<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Code removed for brevity.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now, if the current user isn&apos;t logged in, they&apos;ll be redirected to the &quot;Login&quot;<br>
page if they attempt view the &quot;Add Visit&quot; page!</p>
<h2 class="mume-header" id="bonus-phase-1-adding-the-edit-visit-and-delete-visit-pages">Bonus Phase 1: Adding the Edit Visit and Delete Visit pages</h2>

<ul>
<li>Add the edit and delete attraction visit routes and views.</li>
<li>Only display the &quot;Edit&quot; and &quot;Delete&quot; buttons on a visit if the visit&apos;s user is<br>
the current user.</li>
<li>Check that the current user is the owner of the visit before allowing them to<br>
edit or delete it.</li>
</ul>
<h2 class="mume-header" id="bonus-phase-2-locking-down-parks-and-attractions">Bonus Phase 2: Locking down parks and attractions</h2>

<ul>
<li>Add an attribute to the <code>User</code> model that allows you to indicate which users<br>
are &quot;Admin&quot; users.</li>
<li>Update the park and attraction CRUD routes to only allow authenticated &quot;Admin&quot;<br>
users.</li>
</ul>
<hr>
<h1 class="mume-header undefined" id="week-12-day-3brdata-apis-with-express">WEEK-12 DAY-3<br><em>Data APIs With Express</em></h1>

<hr>
<h1 class="mume-header" id="application-programming-interfaces-learning-objectives">Application Programming Interfaces Learning Objectives</h1>

<p>Modern Web applications can serve both HTML <em>and</em> data. You see that when you<br>
go to Facebook, Twitter, and TurboTax Online. There are some widely-accepted<br>
practices for how to architect your applications so that they can do this. After<br>
homework, lecture, and practicing, you should be able to</p>
<ul>
<li>Recall that REST is an acronym for Representational State Transfer</li>
<li>Describe how RESTful endpoints differ from traditional remote-procedure call<br>
(RPC) services</li>
<li>Identify and describe the RESTful meanings of the combinations of HTTP verbs<br>
and endpoint types for both HTML-based applications and APIs
<ul>
<li>HTTP verbs: GET, POST, PUT, PATCH, and DELETE</li>
<li>Endpoint types: collections of resources and singular resources</li>
</ul>
</li>
<li>Recall that RESTful is <em>not</em> a standard (like ECMAScript or URLs), but a<br>
common way to organize data interactions</li>
<li>Explain how RESTful APIs are meant to be stateless</li>
<li>Given a data model, design RESTful endpoints that interact with the data model<br>
to define application functionality</li>
<li>Use the <code>express.json()</code> middleware to parse HTTP request bodies with type<br>
<code>application/json</code></li>
<li>Determine the maximum data an API response needs and map the content from a<br>
Sequelize object to a more limited data object</li>
<li>Define a global Express error handler to return appropriate responses and<br>
status codes given a specific Accept header in the HTTP request</li>
<li>Define Cross-Origin Resource Sharing (CORS) and how it is implemented in<br>
some Web clients</li>
<li>Explain that CORS is an opt-in feature of Web clients</li>
<li>Configure your API to use CORS to prevent unauthorized access from<br>
browser-based Web requests</li>
</ul>
<hr>
<h1 class="mume-header" id="getting-started-with-restful-endpoints">Getting Started With RESTful Endpoints</h1>

<p>ReST stands for REpresentational State Transfer. The acronym doesn&apos;t fit<br>
perfectly, but we&apos;re developers and we can come up with whatever cool acronyms<br>
work for us! This may sound like a complex concept, but don&apos;t let it scare you<br>
too much.</p>
<p>In this reading, you will learn the definition of ReST and how to apply its<br>
design principles. You will learn about how it replaces another kind of<br>
interaction called &quot;remote procedure calls&quot;. Finally, you&apos;ll get to a very<br>
practical way to implement ReST using the RESTful endpoint design convention.</p>
<h2 class="mume-header" id="rules-of-rest">Rules of ReST</h2>

<p>ReST (Representational State Transfer) is an architecture style for designing<br>
networked applications. To be clear, ReST is not an official standard. Instead,<br>
it&apos;s a set of rules/constraints. Though ReST is commonly associated with APIs,<br>
not every API actually follows RESTful conventions.</p>
<p>ReST defines six architectural constraints, and in this reading, we&apos;ll focus on<br>
three of them:</p>
<ol>
<li><strong>Decoupled client-server</strong>: The client and the server should be decoupled so<br>
that they can evolve separately without any dependence on one another.</li>
<li><strong>Stateless</strong>: This means that there is no necessary session between the<br>
client and the server. Data received from the server can be used by the<br>
client independently. This allows you to have short discrete operations.<br>
Luckily, this is a natural fit for HTTP operations in which requests are<br>
intended to be independent and short-lived.</li>
<li><strong>Uniform interface</strong>: RESTful APIs are meant to be self-describing and<br>
uniform in their definition. Each operation is intended to be separated by a<br>
separate endpoint or URL. In practical real world terms, most RESTful APIs<br>
implement the classic CRUD (Create, Read, Update, Delete) operations against<br>
a resource that just happens to be in your data model. This uniformity allows<br>
developers to easily learn the usage pattern of each API.</li>
</ol>
<h2 class="mume-header" id="what-does-a-restful-api-look-like">What does a RESTful API look like?</h2>

<p>Because RESTful APIs are meant to be representational, you can start with the<br>
data model that the API is meant to represent. For example, if you&apos;re building a<br>
Twitter clone application, you will most likely want to define API endpoints<br>
that manage the operations of your users &quot;tweets&quot;, such as &quot;create a tweet&quot; and<br>
&quot;like a tweet.&quot;</p>
<h3 class="mume-header" id="urls">URLs</h3>

<p>In RESTful APIs, you generally have two kinds of URLs, ones that points at<br>
<em>collections of resources</em> and ones that point at <em>single resources</em>. Using the<br>
Twitter application as an example, a path like <strong>/my/tweets</strong> would point to a<br>
collection of tweets made by you. A path like <strong>/my/tweets/17</strong> would point to<br>
a tweet made by you with the id of 17. Usually, those ids are the primary keys<br>
of rows in your database for the record that contains the information for that<br>
specific tweet.</p>
<p>The naming scheme, again, is quite simple. A path that ends in a plural noun<br>
represents a collection of resources that your API provides for developers to<br>
interact with. The following examples are just naming schemes that <em>you would<br>
decide</em> as the person creating the paths that your application will handle.</p>
<ul>
<li><strong>/invoices</strong> would represent a collection of invoices that you&apos;re allowed to<br>
see</li>
<li><strong>/people</strong> would represent the people in the application that you&apos;re allowed<br>
to see</li>
<li><strong>/houses</strong> would represent a collection of houses</li>
</ul>
<p>A path that combines a plural noun and a specific identifier represents a single<br>
resource in your application. Often, the identifier is a primary key from the<br>
database. However, if you have a unique column that also identifies a specific<br>
record, you could use that instead.</p>
<ul>
<li><strong>/invoices/PK-200201</strong> would represent the single invoice that has the<br>
the invoice number &quot;PK-200201&quot;</li>
<li><strong>/people/10103</strong> would represent the single person with id 10103</li>
<li><strong>/houses/bdfa5ef9-0c86-4810-bc13-10415250af09</strong> would represent the house<br>
with the specific globally unique identifier<br>
&quot;bdfa5ef9-0c86-4810-bc13-10415250af09&quot;</li>
</ul>
<h3 class="mume-header" id="ajax-urls-and-http-verbs">AJAX URLs and HTTP verbs</h3>

<p>For collections of resources URLs, the following table describes what each HTTP<br>
verb means for interacting with that URL. The responses will almost invariably<br>
be formatted as JSON.</p>
<table>
<thead>
<tr>
<th>HTTP Verb</th>
<th>Meaning</th>
<th>With respect to <strong>/my/tweets</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>Get &quot;all&quot; of the specified resources</td>
<td>Get all of your tweets</td>
</tr>
<tr>
<td>POST</td>
<td>Create a new resource</td>
<td>Create a new tweet</td>
</tr>
<tr>
<td>PUT</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr>
<td>PATCH</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr>
<td>DELETE</td>
<td>Delete all of the resources</td>
<td>Delete all of your tweets</td>
</tr>
</tbody>
</table>
<p>For single resource URLs, the following table describes what each HTTP verb<br>
means for interacting with that URL. Again, the responses will invariably be<br>
formatted as JSON.</p>
<table>
<thead>
<tr>
<th>HTTP Verb</th>
<th>Meaning</th>
<th>With respect to <strong>/my/tweets/17</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>Get the details of the resource</td>
<td>Get that specific tweet with id 17</td>
</tr>
<tr>
<td>POST</td>
<td>n/a</td>
<td>n/a</td>
</tr>
<tr>
<td>PUT</td>
<td>Replace the resource</td>
<td>Replace all of the tweet details with the provided data</td>
</tr>
<tr>
<td>PATCH</td>
<td>Update the resource</td>
<td>Update specific properties of the tweet</td>
</tr>
<tr>
<td>DELETE</td>
<td>Delete the specified resource</td>
<td>Delete that specific tweet</td>
</tr>
</tbody>
</table>
<p>When dealing with these RESTful endpoints, the actions don&apos;t necessarily mean<br>
that records <em>will</em> get created or destroyed in your database, or only one<br>
record will be affected.</p>
<p>For example, you may decide to perform &quot;soft deletes&quot; on some of your data. This<br>
means that, instead of removing a record from a table, you mark the record<br>
&quot;deleted&quot;. (You can enable this with the <a href="https://sequelize.org/v5/manual/models-definition.html#configuration"><code>paranoid</code> configuration setting</a> in<br>
your Sequelize models.) This means that the HTTP DELETE request would cause a SQL UPDATE<br>
rather than DELETE. What is important is that the <em>concept</em> of a delete has been<br>
performed.</p>
<p>In another example, consider the path that reads <strong>/weather/current</strong>. That<br>
doesn&apos;t point to any static single record in the weather database. Instead, it<br>
would return the <em>most recent</em> record of weather in the database. The id of<br>
&quot;current&quot; would be treated special and initiate a lookup of the most recent<br>
record rather than a specific record like <strong>/weather/10392</strong>.</p>
<h3 class="mume-header" id="html-urls-and-http-verbs">HTML URLs and HTTP verbs</h3>

<p>RESTful APIs don&apos;t need to be just data APIs returning JSON. The URLs that<br>
return HTML can follow a RESTful concept, as well. What it means, though, is<br>
that you will be limited to just the verbs GET and POST. That&apos;s all HTML-based<br>
views can generate. The following tables show the paths and HTTP verbs used to<br>
interact with HTML-based versions of a RESTful application.</p>
<table>
<thead>
<tr>
<th>Path</th>
<th>HTTP Verb</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>/my/tweets</strong></td>
<td>GET</td>
<td>Get an HTML-based list of your tweets</td>
</tr>
<tr>
<td><strong>/my/tweets/new</strong></td>
<td>GET</td>
<td>Show a form to create a new tweet</td>
</tr>
<tr>
<td><strong>/my/tweets</strong></td>
<td>POST</td>
<td>Create a new tweet</td>
</tr>
<tr>
<td><strong>/my/tweets/17</strong></td>
<td>GET</td>
<td>See the details of your tweet with the id of 17</td>
</tr>
<tr>
<td><strong>/my/tweets/17/edit</strong></td>
<td>GET</td>
<td>Show the edit form for your tweet with the id of 17</td>
</tr>
<tr>
<td><strong>/my/tweets/17</strong></td>
<td>POST</td>
<td>Update the tweet with the submitted details</td>
</tr>
<tr>
<td><strong>/my/tweets/17/delete</strong></td>
<td>POST</td>
<td>Delete your tweet with the id of 17</td>
</tr>
</tbody>
</table>
<p>All of the GET requests get HTML responses for the browser to show. All of the<br>
POST requests usually end in a redirect to another page that makes sense:</p>
<ul>
<li>After creating a resource, redirect to its detail page</li>
<li>After editing a resource, redirect to its detail page</li>
<li>After deleting a resource, redirect to the list page</li>
</ul>
<h2 class="mume-header" id="designing-your-api">Designing your API</h2>

<p>The simplest way to figure out what paths you need in your application is to<br>
figure out what resources you need in your application. For many developers,<br>
this means looking at the models in your application (and the database tables<br>
that power the models).</p>
<p>If you&apos;re creating a pet shelter management application, you would need to know<br>
about animals, animal types, what kennel they&apos;re in, who works there, and more.<br>
So, you would have some models like</p>
<ul>
<li><code>Animal</code></li>
<li><code>AnimalType</code></li>
<li><code>HealthRecord</code></li>
<li><code>Kennel</code></li>
<li>and more...</li>
</ul>
<p>For each of those, you could create paths in your RESTful API to allow the Web<br>
application to interact with those resources:</p>
<ul>
<li><strong>/animals</strong> would be the collection of animals</li>
<li><strong>/animal-types</strong> would be the collection of animal types</li>
<li><strong>/animals/137/health-records</strong> would be the health records for the specific<br>
animal whose id is 137</li>
<li><strong>/kennels</strong> would be the collection of kennels available at the shelter in<br>
which you could put the animals</li>
<li>and more...</li>
</ul>
<p>It all depends on what you need to interact with to make your application work<br>
like you want it to.</p>
<h2 class="mume-header" id="github-api-example">GitHub API example</h2>

<p>GitHub has a much vaunted RESTful API that many people use as a model for how to<br>
do <em>good API design</em>. This section checks out some of its features.</p>
<p>First, check out this <a href="https://api.github.com/users/app-academy">GitHub REST API endpoint</a> for a GET request to the<br>
<code>app-academy</code> user and the endpoint&apos;s response below. Notice how the information<br>
is formatted as JSON. JSON is the preferred format over other formats like XML.<br>
Feel free to take a look at the <a href="https://developer.github.com/v3/users/#get-a-single-user">GitHub API documentation</a> for sending a GET<br>
request for a single user.</p>
<p>If your browser is rendering the JSON below without the quotes around the<br>
property names, you&apos;re likely using the extension <a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a> to <em>prettify</em><br>
your JSON in JavaScript. The <a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc">JSONView</a> extension <em>prettifies</em> JSON by parsing<br>
the JSON text data into a JavaScript object. Note that you can also parse JSON<br>
into JavaScript by using the <code>JSON.parse()</code> method. Another extension, <a href="https://chrome.google.com/webstore/detail/json-viewer/gbmdgpbipfallnflgajpaliibnhdgobh">JSON<br>
Viewer</a>, also <em>prettifies</em> JSON but it correctly preserves the quotes around the<br>
property names.</p>
<p>If you opened <a href="https://api.github.com/users/app-academy">https://api.github.com/users/app-academy</a> endpoint in your browser,<br>
you should see the JSON formatted data below.  Feel free to navigate to the<br>
links in the JSON.</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;login&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app-academy&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">3155975</span><span class="token punctuation">,</span>
  <span class="token property">&quot;node_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MDQ6VXNlcjMxNTU5NzU=&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;avatar_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://avatars0.githubusercontent.com/u/3155975?v=4&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;gravatar_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;html_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://github.com/app-academy&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;followers_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/followers&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;following_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/following{/other_user}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;gists_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/gists{/gist_id}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;starred_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/starred{/owner}{/repo}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;subscriptions_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/subscriptions&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;organizations_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/orgs&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;repos_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/repos&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;events_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/events{/privacy}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;received_events_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://api.github.com/users/app-academy/received_events&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;site_admin&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;company&quot;</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;blog&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;hireable&quot;</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;bio&quot;</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;public_repos&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;public_gists&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;followers&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;following&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-12-31T00:08:43Z&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;updated_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2016-02-27T05:27:57Z&quot;</span>
<span class="token punctuation">}</span>
</pre><p>Navigate to the JSON&apos;s <a href="https://api.github.com/users/app-academy/followers">followers_url</a> and <a href="https://api.github.com/users/app-academy/repos">repos_url</a>. Notice how the url path<br>
of those endpoints connect to the endpoint that fetches all the data connected<br>
to the <code>app-academy</code> user.</p>
<p>Now open the <a href="https://api.github.com/users/app-academy/followers">followers_url</a> endpoint in your browser. You are now are sending a<br>
<code>GET</code> request to GitHub&#x2019;s server to receive an array of followers associated to<br>
the <code>app-academy</code> user. Keep in mind that there are many <a href="https://github.com/public-apis/public-apis">Public APIs</a> available<br>
as you plan your first full-stack project next week.</p>
<h2 class="mume-header" id="restful-vs-remote-procedure-calls-rpc">RESTful vs remote procedure calls (RPC)</h2>

<p>Defining HTTP APIs can come in many shapes and styles. The style you adopt may<br>
flow out of the problem that you are attempting to solve or it could just be<br>
your personal preference. In programming, there is usually more than one valid<br>
approach, and making HTTP based APIs is no exception. And while RESTful APIs are<br>
certainly one of the most popular styles for creating an API, it is not the only<br>
way.</p>
<h3 class="mume-header" id="a-remote-procedure-call">A remote procedure call</h3>

<p>Remote procedure calls are like methods on objects rather than database<br>
operations. Clients make requests centered around specific operations. For<br>
example, with a RESTful API, you would see a GET request to this path to<br>
retrieve a specific tweet: <code>http://localhost/tweets/12</code>. In an RPC-based API,<br>
you could see a path similar to this <code>http://localhost/getTweetById?id=12</code>.</p>
<p>Your route would then have an action to handle that specific &quot;call&quot;.</p>
<p>RPC style endpoints are notorious for specifying the method name in the URL.</p>
<p>This can be convenient, because by looking up the URL you can immediately<br>
understand what it does and what you get in return, and it can offer a way to<br>
get around some of the more complicated nested paths mentioned earlier.</p>
<p>The drawback is that you need comprehensive documentation to know all of the<br>
different methods available by an RPC-designed API. Contrast that to RESTful<br>
APIs where you need know only the resources; once you know the resources, you<br>
immediately know how to interact with them using the HTTP verbs.</p>
<h3 class="mume-header" id="which-is-better-rest-or-rpc">Which is better? ReST or RPC?</h3>

<p>&quot;Better&quot; is very subjective. RESTful APIs are definitely more popular nowadays.<br>
Although Express is an un-opinionated framework, a typical Express setup is more<br>
conducive to following RESTful conventions. For example, routers and routes are<br>
organized in a way to match RESTful URLs, and routes are defined around the core<br>
HTTP verbs.</p>
<p>Generally speaking, in this course, you&apos;ll want to use RESTful APIs, as it<br>
offers a predictable and systematic way of organizing your API.</p>
<h2 class="mume-header" id="what-you-learned">What you learned</h2>

<p>In this article, you covered quite a bit. You learned that</p>
<ol>
<li>ReST is an acronym for Representational State Transfer.</li>
<li>RESTful services differ from traditional remote-procedure call styled<br>
services.</li>
<li>ReST is not an official standard.</li>
<li>RESTful APIs utilize a client/server architecture.</li>
<li>Data from your APIs are represented by resources and are accessed using<br>
Uniform Resource Locators (URLs).</li>
<li>Endpoints are a combination of a resource and an operation.</li>
<li>CRUD operations are represented by HTTP methods (POST, GET, PUT, DELETE, and<br>
sometimes PATCH) and a URL.</li>
<li>RESTful APIs are stateless.</li>
</ol>
<hr>
<h1 class="mume-header" id="express-apis">Express APIs</h1>

<p>It&#x2019;s time to dive deeper into RESTful APIs. As you might remember, RESTful APIs<br>
utilize a client-server architecture. An example of client-server architecture<br>
that you are very familiar with is a web application loaded through a browser<br>
that connects the user to a server. RESTful APIs act as an intermediary to allow<br>
users to interact with database storage through CRUD operations.</p>
<p>In this reading, you&apos;ll be creating a lightweight API to manage tasks. You can<br>
imagine using this API in creating a To-Do list application. This reading will<br>
primarily be a walk-through and code demo of how to build out your own basic<br>
CRUD API with Express, Sequelize, and Postbird. You&apos;ll use Postbird to easily<br>
view your database objects. You&apos;ll also use Postman to send GET, POST, PUT, and<br>
DELETE requests to test your routes.</p>
<p>When you finish this article, you should be able to:</p>
<ul>
<li>Define a collection of endpoints (i.e. routes) that perform CRUD operations<br>
against a single resource using Sequelize and return responses to the client<br>
with appropriate HTTP status codes;</li>
<li>Use the built-in <code>express.json()</code> middleware function to parse request body<br>
content as JSON;</li>
<li>Use Postbird to view data in your database;</li>
<li>Use Postman to interact with your API;</li>
<li>Transform data for responses so that the content returned to clients only<br>
contains what&apos;s necessary and doesn&apos;t expose any sensitive information; and</li>
<li>Understand that a global error handling function catches and processes all<br>
unhandled errors to return appropriate responses (status codes and content).</li>
</ul>
<h2 class="mume-header" id="project-setup">Project setup</h2>

<p>Begin by cloning the project skeleton:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">git</span> clone https://github.com/appacademy-starters/express-sequelize-starter.git
</pre><p>Open your project&apos;s <code>package.json</code> and view the <code>dependencies</code> and<br>
<code>devDependencies</code>. The <code>package.json</code> has included the following packages as<br>
dependencies: <code>dotenv</code>, <code>express</code>, <code>express-validator</code>, <code>morgan</code>, <code>per-env</code>,<br>
<code>pg</code>, <code>sequelize</code>, <code>dotenv-cli</code>, <code>nodemon</code>, and <code>sequelize-cli</code>.</p>
<p>Since your <code>package.json</code> includes the packages above, running <code>npm install</code><br>
will take care of installing all of the dependencies you need to create an<br>
Express application that utilizes Sequelize, dotenv, and the Express validator<br>
library. Your project tomorrow will also have a <code>package.json</code> with all the<br>
dependencies required of your project.</p>
<h3 class="mume-header" id="initializing-sequelize">Initializing Sequelize</h3>

<p>Normally, the Sequelize CLI needs to be configured in order to know where your<br>
database configuration is located and where to generate the <code>models</code>, <code>seeders</code>,<br>
and <code>migrations</code> folders. The project skeleton has already taken care of<br>
configuration by including complete <code>.sequelizerc</code>, <code>./config/index.js</code>, and<br>
<code>./config/database.js</code> files.</p>
<h3 class="mume-header" id="creating-the-database">Creating the database</h3>

<p>Take a moment to create a database user and database:</p>
<ul>
<li>The login name that you must use is &quot;task_list_app&quot; (make sure to set a login<br>
password).</li>
<li>Your user must have the CREATEDB privilege so that you can run <code>npx dotenv sequelize-cli db:create</code>.</li>
<li>The database name that you must use is &quot;task_list_development&quot;.</li>
</ul>
<h3 class="mume-header" id="connecting-sequelize-to-your-database">Connecting Sequelize to your database</h3>

<p>Although the Sequelize CLI configuration files are already complete, Sequelize<br>
CLI still needs access to your database credentials. Remember to create a <code>.env</code><br>
file based off of the <code>.env.example</code> file included in your project skeleton, and<br>
to then replace the values with the values you used when creating the database.<br>
For example, if you used &quot;password1234&quot; for your password, then set the<br>
<code>DB_PASSWORD</code> to be equal to <code>password1234</code> in your own <code>.env</code> file.</p>
<h2 class="mume-header" id="set-up-the-task-model">Set up the Task model</h2>

<p>Generate and migrate your <code>Task</code> model with the following command:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx sequelize model:generate --name Task --attributes <span class="token string">&quot;name:string&quot;</span>
</pre><p>You should see that a <code>New model was created at...</code> and a<br>
<code>New migration was created at...</code> to confirm the successful creation of your<br>
<code>Task</code> model and migration files.</p>
<p>In the model and migration files, make sure to configure the task <code>name</code> to not<br>
be nullable. Each task should have a <code>name</code> column of type <code>string</code> that has a<br>
maximum length of <code>255</code> and is not nullable.</p>
<p>It&apos;s important to include <code>dotenv</code> in your migration command so that the<br>
Sequelize CLI uses correct database credentials when running the migration. Run<br>
your migrations with the command below:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:migrate
</pre><p>After migrating, you can use the Postbird client to view the <code>Tasks</code> table in<br>
your database.</p>
<p>Postbird is a cross-platform <a href="https://wiki.postgresql.org/wiki/PostgreSQL_Clients">PostgreSQL GUI client</a>. A <code>GUI</code> is a graphical<br>
user interface, meaning that its users interact with an application through<br>
icons instead of text-based navigation. <a href="https://github.com/Paxa/postbird">Postbird</a> is an open-source GUI client<br>
while <a href="http://postgresguide.com/utilities/psql.html">Psql</a> is an interactive terminal - both allow you to interact with<br>
Postgres.</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postbird-1.png" alt="postbird-migration"></p>
<p>Now generate a seed file by running the following command from the root of your<br>
project:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx sequelize seed:generate --name test-data
</pre><p>Go ahead and replace the contents of the <code>./db/seeders/[timestamp]-test-data.js</code><br>
with the following code to seed four tasks into your <code>task_list_development</code><br>
database:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">//- ./db/seeders/[timestamp]-test-data.js</span>

<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Tasks&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token string">&quot;Clean car&quot;</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token string">&quot;Study data structures&quot;</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token string">&quot;Buy groceries&quot;</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">&quot;Tasks&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now run your seed files with the command below:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:seed:all
</pre><p>After seeding, you should see the tasks you have created in your Postbird<br>
client:</p>
<p><img src="images/api-tasks-reading-postbird-2.png" alt="postbird-seed"></p>
<h2 class="mume-header" id="initial-router-setup">Initial router setup</h2>

<p>Now remember that you are creating this API to manage tasks. You&apos;ll need a way<br>
to read a task, create a task, update a task, and delete a task in your<br>
database. You&apos;ll also need to render error messages to the API in case any of<br>
your requests are unsuccessful.</p>
<p>Your skeleton has a basic Express application with a generic error handling<br>
function set up in <code>app.js</code>, but you still need to create routes before you can<br>
test your API with Postman. Create a <code>routes</code> directory in the root if your<br>
project. Within the <code>routes</code> folder, create an <code>index.js</code> file for your<br>
root-level router and a <code>tasks.js</code> file for your task router. In both files,<br>
begin by requiring <code>express</code> and creating a <code>router</code> with <code>express.Router()</code>.</p>
<p>To test that your API is up and working properly, let&apos;s set up a route handler<br>
for a GET request to the <code>/</code> path in the <code>./routes/index.js</code> file. Have your<br>
result send JSON response with a message of <code>&quot;Hello to the Express APIs demo app!&quot;</code>.<br>
Lastly, make sure you export the router you just created.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">//- ./routes/index.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">&quot;Hello to the Express APIs demo app!&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</pre><p>Let&apos;s connect your <code>tasks.js</code> route to your <code>Task</code> database model. Begin by<br>
requiring the database models from <code>../db/models</code> and using destructuring to get<br>
a reference to the <code>Task</code> model. Then set up a route handler for a GET request<br>
to the <code>/</code> path. Make sure you export the router you just created.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">//- ./routes/tasks.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../db/models&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> Task <span class="token punctuation">}</span> <span class="token operator">=</span> db<span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO: Fetch all tasks from the database (Read)</span>
  <span class="token comment">// TODO: Render all tasks in JSON format</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</pre><p>Since you are creating an API working with JSON data, you&apos;ll want to update your<br>
<code>app.js</code> file to have your application <code>use</code> the <code>express.json()</code> middleware.<br>
The <code>express.json()</code> middleware is needed to parse request body content<br>
formatted in JSON so that it is available via the <code>req.body</code> property.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>At this moment, you should notice that you have a route defined in the <code>app</code><br>
module for the <code>/</code> path. Remove the GET route to <code>/</code> in your <code>app.js</code>.</p>
<p>Lastly, in order to connect to the routes you have just created, import your<br>
<code>indexRouter</code> and your <code>tasksRouter</code>. In this demo, you will be using separate<br>
routers. Feel free to take a moment to review last Tuesday&apos;s homework reading,<br>
&quot;Using Separate Routers&quot;.</p>
<p>Mount your <code>indexRouter</code> with a path of <code>/</code> and mount your <code>tasksRouter</code> with a<br>
path of <code>/tasks</code>. Your <code>app.js</code> should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">//- app.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;morgan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;./config&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> indexRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> tasksRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/tasks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/tasks&quot;</span><span class="token punctuation">,</span> tasksRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Catch unhandled requests and forward to error handler.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;The requested resource couldn&apos;t be found.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Custom error handlers.</span>

<span class="token comment">// Generic error handler.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isProduction <span class="token operator">=</span> environment <span class="token operator">===</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> err<span class="token punctuation">.</span>title <span class="token operator">||</span> <span class="token string">&quot;Server Error&quot;</span><span class="token punctuation">,</span>
    message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    stack<span class="token punctuation">:</span> isProduction <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app<span class="token punctuation">;</span>
</pre><p>Now you can start your server and open <code>http://localhost:8080/</code> in your browser<br>
to test your API&apos;s index route! You should see your JSON response from the index<br>
route rendered in your application.</p>
<h2 class="mume-header" id="global-error-handling">Global error handling</h2>

<p>As a reminder, the function below is not an error handler. Remember that error<br>
handlers always define four parameters: <code>err</code>, <code>req</code>, <code>res</code>, and <code>next</code>. This<br>
middleware function is designed to match any failed requests so that it can<br>
create and pass a 404 error into the <code>next()</code> method, which prompts Express to<br>
handle the request as an error.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// Catch unhandled requests and forward to next error handler.</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;The requested resource couldn&apos;t be found.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>After calling the <code>next()</code> method with an argument, Express will invoke the<br>
first defined error handler. Remember that a global error handling function is<br>
defined to process unhandled errors.</p>
<p>The below error handler renders global error messages in JSON and returns a<br>
<code>500 Server Error</code> if the <code>err</code> does not have a valid status or title.</p>
<p>Remember that you don&apos;t want your error stack to be printed when running the<br>
application in production. This is why the <code>isProduction</code> variable is set to a<br>
boolean value determined by whether or not your application is in production.<br>
When your application is in production, the error will be rendered in JSON<br>
without the <code>err.stack</code>.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isProduction <span class="token operator">=</span> environment <span class="token operator">===</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> err<span class="token punctuation">.</span>title <span class="token operator">||</span> <span class="token string">&quot;Server Error&quot;</span><span class="token punctuation">,</span>
    message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    stack<span class="token punctuation">:</span> isProduction <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h2 class="mume-header" id="reading-all-tasks">Reading all tasks</h2>

<p>Now you&apos;ll begin writing your routes to implement CRUD operations to your API.</p>
<p>As a reminder, CRUD stands for create, read, update, and delete. You&apos;ll interact<br>
with your <code>Task</code> model to implement CRUD features by using the following<br>
built-in methods:</p>
<ul>
<li><code>Task.findAll()</code> to fetch all of your database tasks. (Read)</li>
<li><code>Task.findByPk()</code> to fetch a database task based on the <code>id</code> from your<br>
request parameters. (Read)</li>
<li><code>Task.create()</code> to generate a task in your database. (Create)</li>
<li><code>Task.update()</code> to update a task in your database. (Update)</li>
<li><code>Task.destroy()</code> to delete a task from your database. (Delete)</li>
</ul>
<p>First up, the writing the route to fetch all tasks!</p>
<p>Let&apos;s bring back your <code>asyncHandler</code> to <em>catch</em> errors in a DRY way. Add the<br>
<code>asyncHandler</code> below to your <code>tasks.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">asyncHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now you can refactor the GET route to fetch all your tasks in the database.<br>
Because you are using the <code>async</code> keyword to pass the middleware function below<br>
into your <code>asyncHandler</code>, you can <code>await</code> database queries. Refactor your GET<br>
<code>/</code> route to <code>await</code> the fetch of all your tasks.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: Render all tasks in JSON format</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now you&apos;ll want to render all tasks in JSON format by using <code>res.json({tasks})</code>.</p>
<p>Imagine you are rendering a list of users instead of a list of tasks. You<br>
wouldn&apos;t want to expose every user&apos;s private email or address. In the case of a<br>
user list, you could pluck out each user&apos;s <code>username</code> and decide to only send<br>
that property to the client. Remember that it&apos;s important to only send<br>
properties that the client needs and to be careful not to expose too much<br>
information.</p>
<p>At this point, your <code>tasks.js</code> file should look like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">//- ./routes/tasks.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../db/models&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> Task <span class="token punctuation">}</span> <span class="token operator">=</span> db<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">asyncHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tasks <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</pre><p>Now start your server with <code>npm start</code> and go into Postman to make a GET request<br>
to <code>localhost:8080/tasks</code> and test the route you have just created! As a<br>
reminder, your request should go to <code>/tasks</code> even though you defined a router<br>
for the <code>/</code> path because of how you are using the <code>tasksRouter</code> with the<br>
<code>/tasks</code> path in your <code>app.js</code>. Every router you create in your <code>tasks.js</code> file<br>
just adds its path onto the <code>/tasks</code> route you designated for <code>tasksRouter</code>. You<br>
should see the all your tasks from the database render in the response <code>Body</code>.</p>
<p><img src="images/api-tasks-reading-postman-1.png" alt="postman-test-read-tasks-index"></p>
<p>Note that if you use your browser to navigate to <code>localhost:8080/tasks</code>, you&apos;ll<br>
see the same response rendered as in Postman. This is because you are sending a<br>
GET request in Postman and your browser automatically sends a GET request when<br>
visiting <code>localhost:8080/tasks</code>.</p>
<h2 class="mume-header" id="create-a-task">Create a task</h2>

<p>Now you&apos;ll work on setting up a POST <code>/tasks</code> route to create a task.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: Create and render a task in JSON</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Begin by extracting the task <code>name</code> from the <code>req.body</code>. Then, use<br>
<code>Task.create()</code> to to instantiate a <code>task</code> and save it to the database. Lastly,<br>
render the <code>task</code> in a JSON response with a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/201">created status</a> of <code>201</code>. Your POST<br>
route should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>You can test this route by making a POST request to <code>/tasks</code> in Postman to<br>
create a task. Make sure to edit your <code>Headers</code> by adding a <code>Content-Type</code><br>
header with a value of <code>application/json</code>. Send your POST request data through<br>
the <code>Body</code> by using the <code>raw</code> format and selecting <code>JSON</code> in the dropdown to<br>
create a task.</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-2a.gif" alt="postman-test-create-valid-task"></p>
<p>After you have created a task, verify your success in Postbird.</p>
<h3 class="mume-header" id="validate-data">Validate data</h3>

<p>Now it&apos;s time to validate your data. You can use the combination of the<br>
<code>express-validator</code> middleware with a custom middleware function to do so. The<br>
<code>express-validator</code> middleware will validate your data and the custom middleware<br>
function will create a <code>400 Bad request.</code> error response upon invalid data.</p>
<p>Import <code>check</code> and <code>validationResult</code> from <code>express-validator</code> to add<br>
validations to your application by adding the following line to in your<br>
<code>tasks.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> check<span class="token punctuation">,</span> validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now create your array of validation middleware functions with <code>check</code> from<br>
<code>express-validator</code> to validate incoming task data:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> validateTask <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">//  Task name cannot be empty:</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Task name can&apos;t be empty.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">//  Task name cannot be longer than 255 characters:</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isLength</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token punctuation">:</span> <span class="token number">255</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Task name can&apos;t be longer than 255 characters.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre><p>Now define a custom middleware function that checks to see if the request has<br>
any validation errors:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">handleValidationErrors</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> validationErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the validation errors are empty,</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Generate an array of error messages</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> validationErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate a new `400 Bad request.` Error object</span>
    <span class="token comment">// and invoke the next function passing in `err`</span>
    <span class="token comment">// to pass control to the global error handler.</span>
    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Invoke the next middleware function</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Your validated POST route should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  validateTask<span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>You should now receive errors for creating a task with invalid data. Take note<br>
about how you are receiving an error <code>status</code> of <code>400</code>.</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-2b.png" alt="postman-test-create-invalid-task"></p>
<h2 class="mume-header" id="read-a-task">Read a task</h2>

<p>Now it&apos;s time to set up a route for reading a specific task. You&apos;ll use the <code>id</code><br>
from the <code>req.params</code> object. Begin by parsing the <code>id</code> and using<br>
<code>Task.findByPk()</code> to fetch the database task that matches the <code>id</code>. If the task<br>
was found, you&apos;ll render a JSON response.</p>
<p>As a reminder, <code>req.params</code> is an object that holds values parsed from your URL<br>
path. For example, reading the URL path to fetch your task with an <code>id</code> of <code>1</code><br>
is <code>/tasks/1</code>. Since you have defined the GET route for a <code>/:id</code> path, your<br>
request parameters (<code>req.params</code>) will have a key of <code>id</code> with a value of <code>1</code>.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/:id(\\d+)&quot;</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> taskId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Test your new route with Postman!</p>
<p><img src="images/api-tasks-reading-postman-3a.png" alt="postman-test-read-task"></p>
<p>However, what if you are querying for a task <code>id</code> that is not in your system?<br>
You&apos;ll need to set up error handling to return a <code>404 Task not found.</code> error if<br>
the <code>id</code> is invalid. You&apos;ll want to instantiate a new <code>Error</code> object with an<br>
error message about the invalid <code>id</code>. The <code>Error</code> object should have a <code>title</code><br>
of &quot;Task not found.&quot; and a <code>status</code> of &quot;404&quot;.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">taskNotFoundError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Task with id of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> could not be found.`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;Task not found.&quot;</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>You&apos;ll also need to refactor your GET route for <code>/:id</code>. Make sure to add <code>next</code><br>
as a parameter. You&apos;ll call the <code>next()</code> method by passing in the return value<br>
from the <code>taskNotFoundError(taskId)</code> function call.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/:id(\\d+)&quot;</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> taskId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">taskNotFoundError</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now test your <code>taskNotFoundError</code> function by making a request with an invalid<br>
<code>id</code>:</p>
<p><img src="images/api-tasks-reading-postman-3b.png" alt="postman-test-task-not-found"></p>
<h2 class="mume-header" id="update-a-task">Update a task</h2>

<p>You can update a task with either a PUT or PATCH request. The key difference<br>
between PUT/PATCH is that a PUT request replaces an object in its entirety while<br>
a PATCH request only updates specific attributes.</p>
<p>It&apos;s time to set up a route for updating a task with a PUT request. Parse the<br>
task <code>id</code> within your <code>req.params</code> and use the parsed <code>taskId</code> to fetch the<br>
<code>task</code> to update. If you have a valid task, await the update and then render the<br>
updated <code>task</code> in JSON format.</p>
<p>Don&apos;t forget to use the same data validations that the create route used so that<br>
you receive the same type of error messages. Lastly, make sure to pass your<br>
<code>taskId</code> into your <code>taskNotFoundError</code> function call to generate a <code>404</code> error<br>
if the task does not exist. Then pass the return value of the<br>
<code>taskNotFoundError</code> function call into the <code>next</code> method to invoke the global<br>
error handler.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/:id(\\d+)&quot;</span><span class="token punctuation">,</span>
  validateTask<span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> taskId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> task<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">taskNotFoundError</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Begin by sending a GET request to <code>localhost:8080/tasks/2</code> to view the data of<br>
your second task:</p>
<p><img src="images/api-tasks-reading-postman-4a.png" alt="postman-get-task-before-update"></p>
<p>Like when testing your create route, make sure to add a <code>Content-Type</code> header<br>
with a value of <code>application/json</code>. Send your PUT request data through the<br>
<code>Body</code> by using the <code>raw</code> format and selecting <code>JSON</code> in the dropdown to update<br>
the task name:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-4b.gif" alt="postman-test-task-update"></p>
<p>Lastly, erase the <code>name</code> value and send a PUT request to test your error<br>
handling for invalid update data:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-4c.gif" alt="postman-test-invalid-task-update"></p>
<h2 class="mume-header" id="delete-a-task">Delete a task</h2>

<p>It&apos;s time to create the last route! Set up the route for deleting a task and<br>
verify that it was properly deleted using Postbird.</p>
<p>You&apos;ll begin by parsing the <code>taskId</code> and using the id to find your <code>task</code> to<br>
delete. If a valid <code>task</code> is found, destroy the task and render a<br>
<code>204 NO CONTENT</code> response with <code>res.status(204).end()</code> to confirm the deletion.<br>
If there is no valid task, pass the <code>taskId</code> into your <code>taskNotFoundError</code><br>
function call to generate a <code>404</code> error. Then pass the return value of the<br>
<code>taskNotFoundError</code> function call into the <code>next</code> method to invoke the global<br>
error handler.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/:id(\\d+)&quot;</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> taskId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> task<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">taskNotFoundError</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now test your route and send a DELETE request to <code>localhost:8080/tasks/2</code> to<br>
delete your task with an id of <code>2</code>:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-5a.png" alt="postman-test-task-deletion"></p>
<p>Notice how there is no task with an id of <code>2</code> in the <code>Tasks</code> table <code>Content</code> in<br>
Postbird:</p>
<p><img src="images/api-tasks-reading-postbird-5b.png" alt="postbird-test-task-deletion"></p>
<p>Now you&apos;ll want to test your <code>taskNotFoundError</code> handler to ensure that it takes<br>
care of trying to delete tasks that are not found:</p>
<p><img src="images/api-tasks-reading-postman-5c.png" alt="postman-test-invalid-task-deletion"></p>
<h2 class="mume-header" id="what-youve-learned">What you&apos;ve learned</h2>

<p>You now know how to define a collection of route endpoints to perform CRUD<br>
operations. You know how to return responses to the client with appropriate HTTP<br>
status codes. You have also used the built-in <code>express.json()</code> middleware<br>
function to parse request body content in JSON format.</p>
<p>In the project, you used Postbird to view your database while using Postman to<br>
test your API. Within your routes, you transformed data for responses and<br>
processed errors to return appropriate responses (status codes and content).</p>
<p>Now that you&apos;ve learned how to create your own REST API, you can create a<br>
client-side project that utilizes your own API! As a reminder, you can use the<br>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a> in your client-side project to easily fetch data to render in your<br>
views.</p>
<hr>
<h1 class="mume-header" id="cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</h1>

<p>Now that you&apos;ve built out an API, it&apos;s time to build out a client to interact<br>
with this API. You have a couple of choices here: you can either serve this<br>
client application out of the same server or you can build out a separate client<br>
application that&apos;s served from a different server.</p>
<p>Serving the client out of your API server reduces complexity and makes the<br>
development experience simpler. However, you might want to serve the client and<br>
the API out of different servers in order to reduce the overall load on one<br>
single server and to improve maintainability of your application as it grows<br>
over time.</p>
<p>In this lesson, you&apos;ll build out a client that&apos;s completely separate from the<br>
API server. Along the way, you&apos;ll learn about the Cross-Origin Resource Sharing<br>
(CORS) issues that need to be considered when accessing API resources from a<br>
different origin. By the end of this lesson, you will:</p>
<ol>
<li>Understand that by default a web application running in the browser can only<br>
access API resources from the same origin (i.e. domain, protocol, port).</li>
<li>Understand that an API can be configured to use Cross-Origin Resource Sharing<br>
(CORS) to grant web applications from a different origin access to some or<br>
all of its resources.</li>
<li>Use the <a href="https://www.npmjs.com/package/cors">cors npm package</a> to enable cross-origin resource sharing.</li>
</ol>
<h2 class="mume-header" id="why-cors">Why CORS</h2>

<p>In the previous reading, you built out a RESTful API to perform CRUD operations<br>
on tasks. Let&apos;s now build out a client to interact with that API.</p>
<h3 class="mume-header" id="demo-project-setup">Demo project setup</h3>

<p>To do this, begin by cloning the project skeleton for this frontend:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">git</span> clone https://github.com/appacademy-starters/express-apis-frontend.git
</pre><p>Much of this starter repo should be pretty familiar. There&apos;s an Express server<br>
at <code>index.js</code> that&apos;s currently handling GET requests to <code>&apos;/&apos;</code> by rendering the<br>
<code>index.pug</code> template.</p>
<p>The <code>index.pug</code> template extends <code>layout.pug</code>. In the head tag of <code>layout.pug</code>,<br>
there are two links: one that fetches the <a href="https://getbootstrap.com/docs/4.3/getting-started/introduction/">bootstrap stylesheets</a> and one that<br>
imports a CSS file called <code>style.css</code>.</p>
<p>Here&apos;s what&apos;s going on: in <code>index.js</code>, the Express application is using a<br>
built-in middleware function called <code>express.static</code>. This middleware function<br>
allows the application to serve static assets, such as JavaScript, CSS, or image<br>
files, out of a specific directory.</p>
<p>In this repo, the server has been configured to serve the files that are in<br>
<code>public</code> as static assets: <code>app.use(express.static(path.join(__dirname, &quot;public&quot;)));</code>.</p>
<p>To see what this means, go ahead and run <code>npm install</code> and then start up the<br>
server by running <code>npm start</code>. Then, go to <code>localhost:4000/style.css</code> to see the<br>
server serving up the <code>style.css</code> file. So in essence, the<br>
<code>link(rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;style.css&quot;)</code> tag that you see in<br>
<code>layout.pug</code> is effectively the same as <code>link(rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;http://localhost:4000/style.css&quot;)</code>.</p>
<p>This was a pretty high-level overview of the <code>express.static</code> middleware<br>
function, and you can read more about how this works in the <a href="https://expressjs.com/en/starter/static-files.html">Express<br>
documentation on serving static files</a>.</p>
<h3 class="mume-header" id="attempting-to-fetch-all-tasks">Attempting to fetch all tasks</h3>

<p>Now, if you look inside of <code>index.pug</code>, there&apos;s a script tag that&apos;s importing<br>
the <code>public/js/index.js</code> JavaScript file. Confirm that this importing is working<br>
by navigating to <code>localhost:4000/</code>. There&apos;s currently a <code>console.log</code> statement<br>
in <code>public/js/index.js</code>, so at this point, you should see a &quot;Hello from<br>
index.js!&quot; statement when you open the browser console.</p>
<p>Let&apos;s replace that <code>console.log</code> with some code to fetch all the tasks from the<br>
API that you built in the previous reading. Be sure that the API is up and<br>
running on <code>localhost:8080</code>. Then, let&apos;s use the Fetch API to make a GET request<br>
for all of the tasks.</p>
<p>A few weeks ago, you went over a quick overview of the Fetch API. As a reminder,<br>
the Fetch API is used to make HTTP requests. It uses Promises to handle the<br>
asynchronous nature of HTTP requests and responses.</p>
<p>You learned that the <code>fetch</code>&apos;s first argument is the URL that you want to make a<br>
request to while the second argument is an optional <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#Supplying_request_options">options</a> object.</p>
<p>Take a moment to review this example fetch from MDN. The comments denote the<br>
possible values for each key in the additional <code>options</code> object.</p>
<p>Out of the all of the <code>options</code>, you&apos;ll primarily be working with <code>method</code>,<br>
<code>headers</code>, and <code>body</code> today:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token comment">// GET, POST, PUT, DELETE, etc.</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// body data type must match &quot;Content-Type&quot; header</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now that you&apos;ve reviewed the Fetch API, let&apos;s use it in <code>public/js/index.js</code> to<br>
fetch all tasks from the API server.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// public/js/index.js</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/tasks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> tasks <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In the code snippet above, an event listener is set up for the<br>
<code>DOMContentLoaded</code> event, so when all of the HTML elements are loaded, it fires<br>
a fetch request to the API server. Looking in the console, we can see that this<br>
failed:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/cors-error.png" alt="cors error"></p>
<h3 class="mume-header" id="cors">CORS</h3>

<p>The error message mentions that the request was blocked by &quot;CORS policy&quot;.<br>
Cross-Origin Resource Sharing means being able to access resources that are<br>
located at an origin different than the origin of the application that&apos;s making<br>
the request. Simply put, in this case, the origin of this fetch request was made<br>
from <code>localhost:4000</code>, and the tasks resources are located at <code>localhost:8080</code>.</p>
<p>To clarify, being from the same origin means having the same protocol (http vs<br>
https), domain, and port number. In our current example, both the client and the<br>
API server are using the same protocol (http) and domain (localhost), but are<br>
served on different ports, which is why it&apos;s considered a cross-origin request.</p>
<p>By default, browsers prevent cross-origin requests from happening for security<br>
reasons. Although this might make life a little more difficult for developers,<br>
restricting this type of requests is a good thing that reduces the number of<br>
attack vectors against your applications.</p>
<p>This cross-origin restriction is enforced by browsers, so if you were to make a<br>
server-side request to the API, there&apos;s nothing preventing that by default.</p>
<h2 class="mume-header" id="setting-up-cors">Setting up CORS</h2>

<p>Although Cross-Origin Resource Sharing is prevented by default, you can<br>
configure your API server to allow these types of cross-origin requests from<br>
trusted origins. Let&apos;s walk through an example of how to do this with your API.</p>
<p>To start, install the <a href="https://www.npmjs.com/package/cors">cors npm package</a> by running <code>npm install cors</code>. Be sure<br>
that you&apos;re in the correct directory (the API server) when you&apos;re running this.</p>
<h3 class="mume-header" id="setting-up-cors-to-fetch-all-tasks">Setting up CORS to fetch all tasks</h3>

<p>Now, go to <code>routes/tasks.js</code>. In there, import the <code>cors</code> middleware at the top<br>
of the file. Then, go down to <code>router.get(&quot;/&quot;)</code> and add the <code>cors()</code> middleware<br>
function. Here&apos;s what your <code>routes/tasks.js</code> file should look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../db/models&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> check<span class="token punctuation">,</span> validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// CODE IN BETWEEN NOT SHOWN</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tasks <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// REST OF CODE NOT SHOWN</span>
</pre><p>Now, if you go back to <code>localhost:4000/</code> and refresh, the console should no<br>
longer show the CORS error. Instead, it should be showing the list of tasks from<br>
your API. Yay!</p>
<p>Let&apos;s do more than just console logging the tasks. In your <code>views/index.pug</code><br>
(in the frontend project), add a div with a class name of &quot;tasks-container&quot;:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">h1</span> <span class="token plain-text">Hello World!</span>
  <span class="token tag">div.tasks-container</span>
  <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;js/index.js&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Then, in <code>public/js/index.js</code>, manipulate the DOM to add the tasks to the<br>
&quot;tasks-container&quot; div. Feel free to use some Bootstrap class names to style the<br>
task items:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/tasks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> tasks <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> tasksContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.tasks-container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tasksHtml <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`
      &lt;div class=&quot;card&quot;&gt;
        &lt;div class=&quot;card-body&quot;&gt;
          &lt;p class=&quot;card-text&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  tasksContainer<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> tasksHtml<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Next, let&apos;s set up a view for creating a task.</p>
<h3 class="mume-header" id="attempt-to-create-a-task">Attempt to create a task</h3>

<p>First, in <code>views/index.pug</code>, add a link to the &quot;/create&quot; page. Also, go ahead<br>
and update the <code>h1</code> to say &quot;Task List&quot; instead:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">h1</span> <span class="token plain-text">Task List</span>
  <span class="token tag">div.tasks-container</span>
  <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;btn btn-primary&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;/create&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Create Task</span>
  <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;js/index.js&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Next, set up a <code>views/create.pug</code> template that would allow someone to create a<br>
task:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">.errors-container</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;create-form&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">.form-group</span>
      <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;name&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Task name</span>
      <span class="token tag">input#name.form-control<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;text&apos;</span></span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;name&quot;</span></span><span class="token punctuation">,</span> <span class="token attr-name">placeholder</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;Task name&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">button.btn.btn-primary<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Create Task</span>

  <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;js/create.js&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Notice how in the template above, it imports a new script at <code>js/create.js</code>.<br>
Create a new <code>public/js/create.js</code> file. In there, set up the JavaScript that<br>
would make a POST request to <code>localhost:8080/tasks</code> when the &quot;Create Task&quot; form<br>
is submitted:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> form <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.create-form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

form<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/tasks&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token punctuation">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In the code above, when a task is successfully created, the use gets redirected<br>
back to the home page (<code>localhost:4000/</code>) where all of the tasks are displayed.<br>
The user is redirected by setting <code>window.location.href</code> equal to <code>&quot;/&quot;</code>.</p>
<p>Then, in <code>index.js</code>, set up a route handler for <code>app.get(&apos;/create&apos;)</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Finally, when you click on the <code>Create Task</code> button on the home page, it should<br>
take you to a form that looks like this:</p>
<p><img src="images/create-task-form.png" alt="Create Task Form"></p>
<p>If we review back in the <code>public/js/index.js</code> file, when someone fills out the<br>
task name field and then submits this form, it should make a POST request to the<br>
API server to create a task.</p>
<blockquote>
<p><strong>Note:</strong> The API requests that you&apos;ve added so far do not implement proper<br>
error handling because it&apos;s more important to focus on the CORS-related code<br>
for now. In tomorrow&apos;s project, you&apos;ll get a more in-depth overview of how to<br>
properly handle fetch errors.</p>
</blockquote>
<p>At this point, you might be thinking to yourself, &quot;Wait a second, this is<br>
<em>obviously</em> going to fail because we haven&apos;t configured CORS for this specific<br>
route yet.&quot; And you&apos;re right! So let&apos;s go ahead and add the <code>cors()</code> middleware<br>
function to <code>routes/tasks.js</code> in the API:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// POST /tasks (Create)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  validateTask<span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Great, let&apos;s fill out a task name and then submit this form. And...it failed. It<br>
failed with the same CORS error that you previously saw. How frustrating!</p>
<p>So what happened there? Well it turns out that when it comes to CORS, there are<br>
actually two types of requests: simple requests and not-so-simple requests.</p>
<p>According to the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">MDN docs on CORS</a>, in order to be considered a &quot;simple&quot;<br>
request, it must meet <strong>all</strong> of the following criteria:</p>
<ol>
<li>It has to be one of these HTTP methods: <code>GET</code>, <code>HEAD</code>, or <code>POST</code>.</li>
<li>It can only have &quot;CORS-safelisted request-headers&quot;. Essentially this means<br>
that if you manually set a header that&apos;s not included on the <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">safelisted<br>
request headers list</a>, then the request is no longer a &quot;simple&quot; request.</li>
<li>The <code>Content-Type</code> must be <code>application/x-www-form-urlencoded</code>,<br>
<code>multipart/form-data</code>, or <code>text/plain</code>.</li>
</ol>
<p>In the case of the task creation form, it met the first criteria since it was a<br>
POST request. It also met the second criteria since the only request header you<br>
set was <code>Content-Type</code>, which is on the <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">safelisted request headers list</a>.<br>
Unfortunately, because the <code>Content-Type</code> was <code>application/json</code>, it failed the<br>
third criteria.</p>
<h2 class="mume-header" id="preflighted-requests">Preflighted requests</h2>

<p>What happens when the request is not considered to be a &quot;simple&quot; request?</p>
<p>When the request does not meet all three criteria, then the browser takes some<br>
extra precaution and actually makes a preflighted <code>OPTIONS</code> request to the<br>
server before making the actual request.</p>
<p>In other words, when it comes to a &quot;not-so-simple&quot; cross-origin request, there<br>
are actually two HTTP requests being made. First, a request is made with an<br>
<code>OPTIONS</code> method, and if the server responds successfully, then the actual<br>
request would go through:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/preflight.svg" alt="preflight"></p>
<p>The problem right now is that because CORS is only set up for the <code>POST /tasks</code><br>
endpoint, when the first <code>OPTIONS</code> request is made, it fails the CORS check:</p>
<p><img src="images/preflight-fail.svgimages/preflight-fail.svg____________________" alt="preflight failure"></p>
<p>To resolve this, go back to <code>routes/tasks.js</code> and set up CORS for the <code>OPTIONS</code><br>
route to &quot;/tasks&quot;. As a reminder, the entire <code>tasks</code> router is nested under<br>
<code>&quot;/tasks&quot;</code>, so you don&apos;t need to define &quot;/tasks&quot; in the route handler path<br>
again:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// POST /tasks (Create)</span>
router<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  <span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  validateTask<span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now, when you try to create the task, both routes are configured for CORS!</p>
<h2 class="mume-header" id="setting-up-cors-for-the-entire-api">Setting up CORS for the entire API</h2>

<p>You&apos;ve now properly configured CORS for two of your API endpoints.<br>
Unfortunately, there are currently a couple of problems.</p>
<p>First, it would be pretty tedious to have to add the <code>cors()</code> middleware<br>
function individually to every single route. In addition, you would also have to<br>
think through whether or not the specific requests would also require the<br>
associated <code>options</code> route to be set up to handle CORS.</p>
<p>Second, right now those two endpoints are configured to allow requests from<br>
<em>any</em> origin. In terms of security, that&apos;s a bad idea. You only want to allow<br>
requests from origins that you know and trust.</p>
<p>Let&apos;s address both of these issues.</p>
<p>First, in your API&apos;s <code>app.js</code>, import the <code>cors</code> middleware function at the top<br>
and then configure for the entire application to use that middleware function:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;morgan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> indexRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> tasksRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/tasks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// REST OF CODE NOT SHOWN</span>
</pre><p>Then, configure the <code>cors</code> middleware function to only allow requests from<br>
trusted origins. In this case, the client requests are coming from<br>
<code>http://localhost:4000</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">{</span> origin<span class="token punctuation">:</span> <span class="token string">&quot;http://localhost:4000&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Check out the <a href="https://www.npmjs.com/package/cors">cors npm package</a> documentation for other configuration options<br>
you can pass into the <code>cors</code> middleware function.</p>
<p>Finally, since CORS is configured for the entire app now for any requests that<br>
come from <code>http://localhost:4000</code>, remove the <code>cors()</code> middleware from the<br>
routes that you previously added them to in <code>routes/tasks.js</code>.</p>
<p>You can also remove <code>router.options(&quot;/&quot;, cors());</code> since the app-wide CORS<br>
configuration will also work for <code>OPTIONS</code> requests.</p>
<p>After you&apos;ve removed all usage of <code>cors()</code> from <code>routes/tasks.js</code>, go ahead and<br>
remove the import of <code>cors</code> from the top of that file.</p>
<h2 class="mume-header" id="what-youve-learned-1">What you&apos;ve learned</h2>

<p>In this reading, you learned:</p>
<ol>
<li>That by default, a web application running in the browser can only access API<br>
resources from the same origin (i.e. domain, protocol, port).</li>
<li>That an API can be configured to use Cross-Origin Resource Sharing (CORS) to<br>
grant web applications from a different origin access to some or all of its<br>
resources.</li>
<li>How to use the <a href="https://www.npmjs.com/package/cors">cors npm package</a> to enable cross-origin resource sharing.</li>
</ol>
<div class="code-chunk" data-id="code-chunk-id-0" data-cmd="toc"><div class="input-div"><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><ul>
<li><a href="#the-groundwork">The groundwork</a></li>
<li><a href="#choosing-a-project">Choosing a Project</a></li>
<li><a href="#the-feature-list">The feature list</a></li>
<li><a href="#feature-scoping">Feature scoping</a></li>
<li><a href="#feature-packets">Feature packets</a></li>
<li><a href="#code-code-code">Code, code, code!</a></li>
<li><a href="#evaluating-your-completion">Evaluating your completion</a></li>
<li><a href="#show-and-tell">Show and tell</a></li>
<li><a href="#required-features-for-approved-clones">Required Features for Approved Clones</a>
<ul>
<li><a href="#bandcamp">Bandcamp</a></li>
<li><a href="#goodreads">Goodreads</a></li>
<li><a href="#medium">Medium</a></li>
<li><a href="#product-hunt">Product Hunt</a></li>
<li><a href="#quora">Quora</a></li>
<li><a href="#remember-the-milk">Remember the Milk</a></li>
<li><a href="#stack-overflow">Stack Overflow</a></li>
<li><a href="#teawithstrangers">TeaWithStrangers</a></li>
<li><a href="#yelp">Yelp</a></li>
</ul>
</li>
<li><a href="#create-a-new-repository">Create a new repository</a></li>
<li><a href="#give-access-to-your-teammates">Give access to your teammates</a></li>
<li><a href="#what-is-cryptography">What is cryptography?</a>
<ul>
<li><a href="#what-is-encryption">What is encryption?</a></li>
<li><a href="#how-does-encryption-work">How does encryption work?</a></li>
<li><a href="#when-is-it-appropriate-to-use-encryption">When is it appropriate to use encryption?</a></li>
</ul>
</li>
<li><a href="#what-is-hashing">What is hashing?</a>
<ul>
<li><a href="#how-does-hashing-work">How does hashing work?</a></li>
<li><a href="#what-is-a-salt">What is a &quot;salt&quot;?</a></li>
<li><a href="#when-is-it-appropriate-to-use-hashing">When is it appropriate to use hashing?</a></li>
</ul>
</li>
<li><a href="#using-bcrypt-to-hash-user-passwords">Using Bcrypt to hash user passwords</a></li>
<li><a href="#overview-of-sessions">Overview of sessions</a>
<ul>
<li><a href="#what-are-sessions">What are sessions?</a></li>
<li><a href="#why-are-sessions-useful">Why are sessions useful?</a></li>
<li><a href="#what-are-the-drawbacks">What are the drawbacks?</a></li>
</ul>
</li>
<li><a href="#configuring-express-to-use-sessions">Configuring Express to use sessions</a>
<ul>
<li><a href="#installing-and-configuring-express-session">Installing and configuring <code>express-session</code></a></li>
<li><a href="#configuration-options">Configuration options</a></li>
<li><a href="#testing">Testing</a></li>
</ul>
</li>
<li><a href="#setting-and-accessing-session-values">Setting and accessing session values</a></li>
<li><a href="#session-store-configuration">Session store configuration</a></li>
<li><a href="#securing-the-session-http-cookie">Securing the session HTTP cookie</a>
<ul>
<li><a href="#additional-session-configuration-cookie-options">Additional session configuration cookie options</a></li>
</ul>
</li>
<li><a href="#what-you-have-learned">What you have learned</a></li>
<li><a href="#overview-of-authentication-and-authorization">Overview of authentication and authorization</a>
<ul>
<li><a href="#what-is-authentication">What is authentication?</a></li>
<li><a href="#authentication-process">Authentication process</a></li>
<li><a href="#what-is-authorization">What is authorization?</a></li>
</ul>
</li>
<li><a href="#supporting-user-self-registration">Supporting user self-registration</a>
<ul>
<li><a href="#getting-the-starter-project">Getting the starter project</a></li>
<li><a href="#creating-the-user-model">Creating the User model</a></li>
<li><a href="#adding-the-user-registration-form">Adding the user registration form</a></li>
<li><a href="#validating-the-user-registration-form">Validating the user registration form</a></li>
<li><a href="#hashing-user-passwords">Hashing user passwords</a></li>
<li><a href="#adding-the-user-routes-to-the-app-module">Adding the user routes to the <code>app</code> module</a></li>
<li><a href="#testing-user-registration">Testing user registration</a></li>
</ul>
</li>
<li><a href="#supporting-user-login">Supporting user login</a>
<ul>
<li><a href="#adding-the-user-login-form">Adding the user login form</a></li>
<li><a href="#implementing-the-user-login-process">Implementing the user login process</a></li>
<li><a href="#improving-the-user-navigation">Improving the user navigation</a></li>
<li><a href="#testing-user-login">Testing user login</a></li>
</ul>
</li>
<li><a href="#persisting-user-login-state">Persisting user login state</a>
<ul>
<li><a href="#configuring-express-to-use-sessions-1">Configuring Express to use sessions</a></li>
<li><a href="#using-sessions-to-persist-a-users-login-state">Using sessions to persist a user&apos;s login state</a></li>
<li><a href="#testing-user-login-state-persistence">Testing user login state persistence</a></li>
</ul>
</li>
<li><a href="#restoring-the-authenticated-user-from-session">Restoring the authenticated user from session</a>
<ul>
<li><a href="#displaying-the-users-login-state">Displaying the user&apos;s login state</a></li>
<li><a href="#implementing-user-logout">Implementing user logout</a></li>
<li><a href="#testing-the-latest-changes">Testing the latest changes</a></li>
</ul>
</li>
<li><a href="#protecting-a-route">Protecting a route</a>
<ul>
<li><a href="#defining-a-middleware-function-to-require-an-authenticated-user">Defining a middleware function to require an authenticated user</a></li>
</ul>
</li>
<li><a href="#associating-data-with-a-user">Associating data with a user</a>
<ul>
<li><a href="#defining-an-association">Defining an association</a></li>
<li><a href="#updating-the-seed-data">Updating the seed data</a></li>
<li><a href="#updating-the-book-related-routes">Updating the book related routes</a></li>
<li><a href="#testing-one-more-time">Testing one more time</a></li>
</ul>
</li>
<li><a href="#the-importance-of-using-https">The importance of using HTTPS</a></li>
<li><a href="#next-steps">Next steps</a></li>
<li><a href="#phase-0-download-the-starter-project">Phase 0: Download the starter project</a></li>
<li><a href="#phase-1-create-the-user-model">Phase 1: Create the User model</a></li>
<li><a href="#phase-2-configure-express-to-use-sessions">Phase 2: Configure Express to use sessions</a></li>
<li><a href="#phase-3-support-user-self-registration">Phase 3: Support user self-registration</a>
<ul>
<li><a href="#regex-reminders">Regex Reminders</a></li>
</ul>
</li>
<li><a href="#phase-4-support-user-login">Phase 4: Support user login</a>
<ul>
<li><a href="#testing-user-login-1">Testing user login</a></li>
</ul>
</li>
<li><a href="#phase-5-persist-user-login-state">Phase 5: Persist user login state</a>
<ul>
<li><a href="#using-sessions-to-persist-a-users-login-state-1">Using sessions to persist a user&apos;s login state</a></li>
<li><a href="#testing-user-login-state-persistence-1">Testing user login state persistence</a></li>
</ul>
</li>
<li><a href="#phase-6-restore-the-authenticated-user-from-session">Phase 6: Restore the authenticated user from session</a></li>
<li><a href="#phase-7-display-the-users-login-state">Phase 7: Display the user&apos;s login state</a></li>
<li><a href="#phase-8-implement-user-logout">Phase 8: Implement user logout</a>
<ul>
<li><a href="#testing-the-latest-changes-1">Testing the latest changes</a></li>
</ul>
</li>
<li><a href="#phase-9-support-user-attraction-visits">Phase 9: Support user attraction visits</a>
<ul>
<li><a href="#create-the-attractionvisit-model">Create the AttractionVisit model</a></li>
<li><a href="#update-the-attraction-detail-page">Update the Attraction Detail page</a></li>
<li><a href="#add-the-add-visit-page">Add the Add Visit page</a></li>
<li><a href="#require-a-logged-in-user">Require a logged in user</a></li>
</ul>
</li>
<li><a href="#bonus-phase-1-adding-the-edit-visit-and-delete-visit-pages">Bonus Phase 1: Adding the Edit Visit and Delete Visit pages</a></li>
<li><a href="#bonus-phase-2-locking-down-parks-and-attractions">Bonus Phase 2: Locking down parks and attractions</a></li>
<li><a href="#rules-of-rest">Rules of ReST</a></li>
<li><a href="#what-does-a-restful-api-look-like">What does a RESTful API look like?</a>
<ul>
<li><a href="#urls">URLs</a></li>
<li><a href="#ajax-urls-and-http-verbs">AJAX URLs and HTTP verbs</a></li>
<li><a href="#html-urls-and-http-verbs">HTML URLs and HTTP verbs</a></li>
</ul>
</li>
<li><a href="#designing-your-api">Designing your API</a></li>
<li><a href="#github-api-example">GitHub API example</a></li>
<li><a href="#restful-vs-remote-procedure-calls-rpc">RESTful vs remote procedure calls (RPC)</a>
<ul>
<li><a href="#a-remote-procedure-call">A remote procedure call</a></li>
<li><a href="#which-is-better-rest-or-rpc">Which is better? ReST or RPC?</a></li>
</ul>
</li>
<li><a href="#what-you-learned">What you learned</a></li>
<li><a href="#project-setup">Project setup</a>
<ul>
<li><a href="#initializing-sequelize">Initializing Sequelize</a></li>
<li><a href="#creating-the-database">Creating the database</a></li>
<li><a href="#connecting-sequelize-to-your-database">Connecting Sequelize to your database</a></li>
</ul>
</li>
<li><a href="#set-up-the-task-model">Set up the Task model</a></li>
<li><a href="#initial-router-setup">Initial router setup</a></li>
<li><a href="#global-error-handling">Global error handling</a></li>
<li><a href="#reading-all-tasks">Reading all tasks</a></li>
<li><a href="#create-a-task">Create a task</a>
<ul>
<li><a href="#validate-data">Validate data</a></li>
</ul>
</li>
<li><a href="#read-a-task">Read a task</a></li>
<li><a href="#update-a-task">Update a task</a></li>
<li><a href="#delete-a-task">Delete a task</a></li>
<li><a href="#what-youve-learned">What you&apos;ve learned</a></li>
<li><a href="#why-cors">Why CORS</a>
<ul>
<li><a href="#demo-project-setup">Demo project setup</a></li>
<li><a href="#attempting-to-fetch-all-tasks">Attempting to fetch all tasks</a></li>
<li><a href="#cors">CORS</a></li>
</ul>
</li>
<li><a href="#setting-up-cors">Setting up CORS</a>
<ul>
<li><a href="#setting-up-cors-to-fetch-all-tasks">Setting up CORS to fetch all tasks</a></li>
<li><a href="#attempt-to-create-a-task">Attempt to create a task</a></li>
</ul>
</li>
<li><a href="#preflighted-requests">Preflighted requests</a></li>
<li><a href="#setting-up-cors-for-the-entire-api">Setting up CORS for the entire API</a></li>
<li><a href="#what-youve-learned-1">What you&apos;ve learned</a></li>
<li><a href="#phase-0-initialize-project">Phase 0: Initialize project</a>
<ul>
<li><a href="#initializing-sequelize-1">Initializing Sequelize</a></li>
<li><a href="#configuring-your-environment-variables">Configuring your environment variables</a></li>
<li><a href="#creating-your-database">Creating your database</a></li>
</ul>
</li>
<li><a href="#phase-1-set-up-the-tweet-model">Phase 1: Set up the Tweet model</a></li>
<li><a href="#phase-2-set-up-test-routes">Phase 2: Set up test routes</a>
<ul>
<li><a href="#creating-test-routes">Creating test routes</a></li>
<li><a href="#testing-requests-on-postman">Testing requests on Postman</a></li>
</ul>
</li>
<li><a href="#phase-3-set-up-tweet-routes">Phase 3: Set up tweet routes</a>
<ul>
<li><a href="#get-tweets">GET /tweets</a></li>
<li><a href="#get-tweetsid">GET /tweets/:id</a></li>
<li><a href="#post-tweets">POST /tweets</a></li>
<li><a href="#put-tweetsid">PUT /tweets/:id</a></li>
<li><a href="#delete-tweetsid">DELETE /tweets/:id</a></li>
</ul>
</li>
<li><a href="#phase-4-render-tweets-in-the-frontend-application">Phase 4: Render tweets in the frontend application</a></li>
<li><a href="#phase-5-add-the-users-model">Phase 5: Add the users model</a></li>
<li><a href="#phase-1-users-router">Phase 1: Users router</a></li>
<li><a href="#phase-2-protecting-the-tweets-resources">Phase 2: Protecting the tweets resources</a></li>
<li><a href="#phase-3-sign-up-for-user-account-from-the-client">Phase 3: Sign up for user account from the client</a></li>
<li><a href="#phase-4-setting-up-the-log-in-flow">Phase 4: Setting up the log-in flow</a></li>
<li><a href="#phase-5-creating-tweets-from-the-frontend-application">Phase 5: Creating tweets from the frontend application</a></li>
<li><a href="#phase-6-seeing-tweets-with-authors-and-creating-tweets-from-the-client">Phase 6: Seeing tweets with authors and creating tweets from the client</a></li>
<li><a href="#phase-7-set-up-the-profile-page">Phase 7: Set up the profile page</a></li>
<li><a href="#bonus-phase-add-ability-to-delete-your-own-tweet">Bonus Phase: Add ability to delete your own tweet</a></li>
<li><a href="#bonus-phase-combine-create-and-index-views">Bonus Phase: Combine create and index views</a></li>
<li><a href="#bonus-phase-es-modules">Bonus Phase: ES Modules</a></li>
<li><a href="#high-level-overview-of-oauth-20">High level overview of OAuth 2.0</a></li>
<li><a href="#getting-your-app-ready-for-oauth-20">Getting your app ready for OAuth 2.0</a></li>
<li><a href="#oauth-20-in-detail">OAuth 2.0 in detail</a>
<ul>
<li><a href="#everything-over-https">Everything over HTTPS</a></li>
<li><a href="#application-requests-authorization-from-user">Application requests authorization from user</a></li>
<li><a href="#user-issues-authorization-grant">User issues authorization grant</a></li>
<li><a href="#application-uses-the-authorization-grant">Application uses the authorization grant</a></li>
<li><a href="#authorization-server-issues-an-access-token">Authorization server issues an access token</a></li>
<li><a href="#access-token-is-used">Access token is used</a></li>
<li><a href="#protected-resources-are-served">Protected resources are served</a></li>
</ul>
</li>
<li><a href="#what-you-learned-1">What you learned</a></li>
<li><a href="#json-web-token-jwt">JSON Web Token (JWT)</a>
<ul>
<li><a href="#conceptual-overview-of-a-jwt-an-example">Conceptual overview of a JWT: an example</a></li>
<li><a href="#anatomy-of-a-jwt">Anatomy of a JWT</a></li>
</ul>
</li>
<li><a href="#setting-up-token-based-authentication">Setting up token-based authentication</a>
<ul>
<li><a href="#create-the-users-table">Create the Users table</a></li>
<li><a href="#users-router">Users router</a></li>
<li><a href="#generate-an-access-token-for-the-client">Generate an access token for the client</a></li>
<li><a href="#using-the-access-token">Using the access token</a></li>
<li><a href="#where-to-store-the-access-token-on-the-client-side">Where to store the access token on the client-side</a></li>
</ul>
</li>
<li><a href="#what-youve-learned-2">What you&apos;ve learned</a></li>
</ul>
<hr>
<p>Now that you&apos;ve built out an API, it&apos;s time to build out a client to interact<br>
with this API. You have a couple of choices here: you can either serve this<br>
client application out of the same server or you can build out a separate client<br>
application that&apos;s served from a different server.</p>
<p>Serving the client out of your API server reduces complexity and makes the<br>
development experience simpler. However, you might want to serve the client and<br>
the API out of different servers in order to reduce the overall load on one<br>
single server and to improve maintainability of your application as it grows<br>
over time.</p>
<p>In this lesson, you&apos;ll build out a client that&apos;s completely separate from the<br>
API server. Along the way, you&apos;ll learn about the Cross-Origin Resource Sharing<br>
(CORS) issues that need to be considered when accessing API resources from a<br>
different origin. By the end of this lesson, you will:</p>
<ol>
<li>Understand that by default a web application running in the browser can only<br>
access API resources from the same origin (i.e. domain, protocol, port).</li>
<li>Understand that an API can be configured to use Cross-Origin Resource Sharing<br>
(CORS) to grant web applications from a different origin access to some or<br>
all of its resources.</li>
<li>Use the <a href="https://www.npmjs.com/package/cors">cors npm package</a> to enable cross-origin resource sharing.</li>
</ol>
<hr>
<h1 class="mume-header" id="twitter-lite-project">Twitter Lite Project</h1>

<p>Today you&apos;ll begin building a lightweight Twitter API using Express, Sequelize,<br>
and Postbird! There will be two parts to this project: creating an API and<br>
creating a client-side application.</p>
<p>When you have completed the first part of the project, your application should<br>
have the following features:</p>
<ol>
<li>A default &quot;/&quot; GET route.</li>
<li>A &quot;/tweets&quot; GET route to fetch an index of tweets.</li>
<li>A &quot;/tweets&quot; POST route to create tweets.</li>
<li>A &quot;/tweets/:id&quot; PUT route to update tweets.</li>
<li>A &quot;/tweets/:id&quot; DELETE route to delete tweets.</li>
<li>A backend API that connects to a simple frontend server.</li>
<li>A Users model.</li>
</ol>
<h2 class="mume-header" id="phase-0-initialize-project">Phase 0: Initialize project</h2>

<p>Begin by cloning the project skeleton:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">git</span> clone https://github.com/appacademy-starters/express-sequelize-starter.git
</pre><p>Install your packages with <code>npm install</code>.</p>
<h3 class="mume-header" id="initializing-sequelize-1">Initializing Sequelize</h3>

<p>Just like in the To-Do list demo project, the Sequelize CLI is already<br>
configured to know where your database configuration is located and where to<br>
generate the <code>models</code>, <code>seeders</code>, and <code>migrations</code> folders. The project skeleton<br>
has already taken care of configuration by including complete <code>.sequelizerc</code>,<br>
<code>./config/index.js</code>, and <code>./config/database.js</code> files.</p>
<h3 class="mume-header" id="configuring-your-environment-variables">Configuring your environment variables</h3>

<p>Before you set up your database, remember that the Sequelize CLI still<br>
needs access to your database credentials. Create an <code>.env</code> file based off of<br>
the <code>.env.example</code> file included in your project skeleton.</p>
<h3 class="mume-header" id="creating-your-database">Creating your database</h3>

<p>Before initializing the <code>Tweet</code> model, you&apos;ll need to create a new database.</p>
<p>Take a moment to create a database user and database:</p>
<ul>
<li>The login name that you must use is &quot;twitter_lite_app&quot; (make sure to set a<br>
login password).</li>
<li>Your user must be granted the CREATEDB privilege so that you can run <code>npx dotenv sequelize-cli db:create</code>.</li>
<li>The database name that you must use is &quot;twitter_lite&quot;.</li>
</ul>
<h2 class="mume-header" id="phase-1-set-up-the-tweet-model">Phase 1: Set up the Tweet model</h2>

<p>It&apos;s time to generate and migrate your Tweet model with the following commands:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx sequelize model:generate --name Tweet --attributes <span class="token string">&quot;message:string&quot;</span>
</pre><p>In the model and migration files, make sure to configure the tweet <code>message</code> to<br>
not be nullable. Each tweet should have a <code>message</code> column of type <code>string</code> that<br>
has a maximum length of <code>280</code> and is not nullable. Then run your migrations:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:migrate
</pre><p>After migrating, you should see the <code>Tweets</code> table in your Postbird client:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postbird-1.png" alt="postbird-migration"></p>
<p>Now generate a seed file by running the following command from the root of your<br>
project:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx sequelize seed:generate --name test-data
</pre><p>Go ahead and replace the contents of the <code>./db/seeders/[timestamp]-test-data.js</code><br>
with the following code:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Tweets&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> <span class="token string">&quot;The Martian was awesome!&quot;</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> <span class="token string">&quot;Has anyone seen Ready Player One?&quot;</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          message<span class="token punctuation">:</span>
            <span class="token string">&quot;Harry Potter and the Sorcerer&apos;s Stone is the best out of all seven HP books :).&quot;</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">&quot;Tweets&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now run your seed files with the command below:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:seed:all
</pre><p>After seeding, you should see the tweets you have created in your Postbird<br>
client:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postbird-1.png" alt="postbird-seed"></p>
<h2 class="mume-header" id="phase-2-set-up-test-routes">Phase 2: Set up test routes</h2>

<p>Notice that your skeleton already has a basic Express application set up in<br>
<code>app.js</code>. It&apos;s time for you to set up the routers for your project.</p>
<p>Create a <code>routes</code> module by creating a <code>routes</code> directory in the root of your<br>
project. Within your <code>routes</code> folder, create an <code>index.js</code> file for your default<br>
router and a <code>tweets.js</code> file for your tweet routers. In both files, begin by<br>
requiring <code>express</code> and creating a <code>router</code> with <code>express.Router()</code>. Lastly,<br>
make sure you export the routers you just created.</p>
<p>A majority of RESTful APIs serve data in a JSON format. Let&apos;s do the same for<br>
this project! To do this, update your <code>app.js</code> file to have your application<br>
<code>use(express.json())</code>. The <code>express.json()</code> middleware is needed to parse<br>
request body content formatted in JSON so that it is available via the<br>
<code>req.body</code> property.</p>
<p>Lastly, in order to connect to the routes modules you have just created, import<br>
your <code>./routes/index</code> file as the <code>indexRouter</code> and import your<br>
<code>./routes/tweets</code> file as the <code>tweetsRouter</code>. Make sure your application is<br>
using the <code>/</code> route with the <code>indexRouter</code> as well as the <code>/tweets</code> route with<br>
the <code>tweetsRouter</code>.</p>
<h3 class="mume-header" id="creating-test-routes">Creating test routes</h3>

<p>Let&apos;s get started in the <code>./routes/index.js</code> file. Move your GET route for <code>/</code><br>
from <code>app.js</code> into your <code>./routes/index.js</code> file. Update the route to use<br>
<code>res.json()</code> in order to render a JSON response of <code>message: &quot;test index root&quot;</code>.</p>
<p>Now you&apos;ll add a test route in your <code>./routes/tweets.js</code>. Create a route<br>
that handles a GET request to the <code>/</code> path. Have your result <code>send</code> a JSON<br>
response of <code>message: &quot;test tweets index&quot;</code>.</p>
<h3 class="mume-header" id="testing-requests-on-postman">Testing requests on Postman</h3>

<p>Now run <code>npm start</code> to start your server and open up Postman to test your GET<br>
requests.</p>
<p><img src="images/api-tasks-reading-postman-1.png" alt="using-postman"></p>
<p>When sending a GET request to <code>localhost:8080/</code>, you should see JSON with your<br>
&quot;test index root&quot; message in the body response. When sending a GET request to<br>
<code>localhost:8080/tweets</code>, you should see JSON with your &quot;test tweets index&quot;<br>
message in the body response.</p>
<p>Note that if you use your browser to navigate to <code>localhost:8080/</code> and<br>
<code>localhost:8080/tweets</code>, you&apos;ll see the same response as in Postman.</p>
<h2 class="mume-header" id="phase-3-set-up-tweet-routes">Phase 3: Set up tweet routes</h2>

<p>Now you&apos;ll add your Tweet routes in your <code>./routes/tweets.js</code>. Begin by<br>
requiring your <code>db</code> from your <code>../db/models</code> directory:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../db/models&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now destructure your <code>Tweet</code> model from the <code>db</code> you have just imported:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> Tweet <span class="token punctuation">}</span> <span class="token operator">=</span> db<span class="token punctuation">;</span>
</pre><p>In this phase, you&apos;ll interact with your <code>Tweet</code> model by using built-in methods<br>
to set up the basic CRUD functionalities for tweets:</p>
<ul>
<li><code>Tweet.findAll()</code> to fetch all of your database tweets. (Read)</li>
<li><code>Tweet.findByPk()</code> to fetch a database tweet based on the <code>id</code> from your<br>
request parameters. (Read)</li>
<li><code>Tweet.create()</code> to generate a tweet in your database. (Create)</li>
<li><code>Tweet.update()</code> to update a tweet in your database. (Update)</li>
<li><code>Tweet.destroy()</code> to delete a tweet from your database. (Delete)</li>
</ul>
<h3 class="mume-header" id="get-tweets">GET /tweets</h3>

<p>It&apos;s time to set up a GET <code>/</code> route to fetch all of your seeded tweets when<br>
sending a GET request to <code>localhost:8080/tweets</code>. Since you&apos;ll be awaiting a<br>
database fetch, let&apos;s bring back your <code>asyncHandler</code> function to help you catch<br>
errors in a DRY way!</p>
<p>As a reminder, your <code>asyncHandler</code> takes in a <code>handler</code> function to return a<br>
middleware function that invokes the handler function with <code>req</code>, <code>res</code>, and<br>
<code>next</code>. It then chains on a <code>catch</code> statement by passing in the <code>next</code> function.</p>
<p>Let&apos;s begin by updating the <code>tweets</code> GET route to <code>/</code>. Wrap the route function<br>
with your <code>asyncHandler</code> to be able to <code>await</code> the database fetch of all your<br>
tweets. Look at the beginning of the Phase 3 instructions to determine which<br>
Tweet model method to use.</p>
<p>Lastly, remember to render the tweets you have fetched from your database in<br>
JSON by using <code>res.json({ tweets })</code>.</p>
<h3 class="mume-header" id="get-tweetsid">GET /tweets/:id</h3>

<p>Now you&apos;ll set up the GET <code>/:id(\\d+)</code> route to read a specific tweet when<br>
sending a GET request to <code>localhost:8080/tweets/:id</code>. Parse the <code>tweetId</code> from<br>
your <code>req.params</code> object and use your <code>tweetId</code> to fetch a specific tweet from<br>
the database.</p>
<p>Note that the <code>app</code> module contains the following middleware function to catch<br>
unhandled requests and pass a <code>404</code> error to the global error handler:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;The requested resource couldn&apos;t be found.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>This ensures that if a client makes a request to a route that doesn&apos;t exist<br>
they&apos;ll receive an appropriate error message.</p>
<p>Any error that occurs in your routes will be handled by the below global error<br>
handler so that error messages can be formatted and returned to the client in a<br>
consistent way. The error&apos;s title, message, and stacktrace is rendered in JSON.<br>
If your application is in production, the error will be rendered without the<br>
error stacktrace.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isProduction <span class="token operator">=</span> environment <span class="token operator">===</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> err<span class="token punctuation">.</span>title <span class="token operator">||</span> <span class="token string">&quot;Server Error&quot;</span><span class="token punctuation">,</span>
    message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    stack<span class="token punctuation">:</span> isProduction <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now let&apos;s go back to your GET route for a single tweet. Now that you have<br>
written a database fetch for a tweet, you want to render errors for tweets that<br>
were not found. Make sure your asynchronous route function is taking in <code>next</code><br>
as a parameter. If you have fetched a valid tweet, render the tweet in JSON. If<br>
you have not fetched a valid tweet, you can use a function to generate an error<br>
before invoking the <code>next</code> method.</p>
<p>Let&apos;s define your error generator function for tweets not found. In your tweet<br>
route module, define a <code>tweetNotFoundError</code> function that takes in a tweet ID.<br>
Generate a new <code>Error</code> object with a message stating that a tweet of the<br>
given ID could not be found. Assign the error to have a <code>title</code> property to be<br>
&quot;Tweet not found.&quot; and a <code>status</code> of <code>404</code>. At the end of the function, return<br>
the error.</p>
<p>Now that the <code>tweetNotFoundError</code> function is written to generate and return an<br>
<code>Error</code> object, you can pass the return value of the <code>tweetNotFoundError</code><br>
function call into the <code>next</code> method to invoke the global error handler.</p>
<p>Take a moment to test your route and error handling in Postman.</p>
<h3 class="mume-header" id="post-tweets">POST /tweets</h3>

<p>Set up a POST <code>/</code> route to create a new tweet by sending a POST request to<br>
<code>localhost:8080/tweets</code>. Now that you will take in JSON data to handle a<br>
request, remember that your application is using the <code>express.json()</code> middleware<br>
in <code>app.js</code> to parse the body content&apos;s JSON and access the <code>req.body</code>.</p>
<p>Now that you are taking in data, you&apos;ll need to validate that data. Import<br>
<code>check</code> and <code>validationResult</code> from <code>express-validator</code>. Use the<br>
<code>express-validator</code> library to check that the <code>message</code> value is present, and<br>
that it&apos;s not over 280 characters long.</p>
<p>You&apos;ll also need to handle your validation errors. In previous projects, you&apos;ve<br>
been handling validations in each of the route handlers. Today, let&apos;s DRY up our<br>
code and set up one middleware function that can check for errors in the <code>req</code><br>
object, and if there are errors, then we can generate an <code>Error</code> from that<br>
middleware function and handle it there.</p>
<p>Define a <code>handleValidationErrors</code> function and have it take in <code>req</code>, <code>res</code>, and<br>
<code>next</code> as parameters. Begin by generating a <code>validationErrors</code> object by<br>
invoking the <code>validationResult</code> function with the request:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">handleValidationErrors</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> validationErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO: Generate error object and invoke next middleware function</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>If you do you have validation errors, use <code>array()</code> to transform your<br>
<code>validationErrors</code> object into a mappable array. Pluck out each error&apos;s <code>msg</code><br>
attribute to generate an <code>errors</code> array of error messages:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> errors <span class="token operator">=</span> validationErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>After generating the <code>errors</code> array, you&apos;ll want to create a new <code>Error</code> object<br>
with a 400 <code>status</code> and title of &quot;Bad request&quot;:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
err<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
err<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">;</span>
<span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>You&apos;ll also want the <code>Error</code> object to set an <code>errors</code> array as a <code>errors</code><br>
property. Invoke the <code>next</code> middleware function with the <code>Error</code> object you have<br>
created. If you do not have any validation errors, invoke the <code>next</code> middleware<br>
function without an argument.</p>
<p>Your <code>handleValidationErrors</code> function should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">handleValidationErrors</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> validationErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> validationErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now that you are adding the <code>.errors</code> property to this error you will<br>
need to modify the generic error handler in <code>app.js</code> to add this <code>.errors</code><br>
array to the JSON you return, otherwise when you call our API and get validation<br>
errors you won&apos;t be able to see them!</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isProduction <span class="token operator">=</span> environment <span class="token operator">===</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> err<span class="token punctuation">.</span>title <span class="token operator">||</span> <span class="token string">&quot;Server Error&quot;</span><span class="token punctuation">,</span>
    message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    errors<span class="token punctuation">:</span> err<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> <span class="token comment">// Includes our array of validation errors in our JSON response</span>
    stack<span class="token punctuation">:</span> isProduction <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now make sure the POST route is using your tweet validations and<br>
<code>handleValidationErrors</code> function as middleware. Test your new route in Postman.<br>
Don&apos;t forget to set the &quot;Content-Type&quot; header to &quot;application/json&quot; and send<br>
raw JSON data through the request body. Feel free to review how to send a POST<br>
request through the image below.</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/api-tasks-reading-postman-2a.gif" alt="postman-post"></p>
<p>Take a moment to also test your error handling. You should see an error response<br>
in JSON upon submitting bad data (i.e. an empty <code>message</code> field). Notice that<br>
your error response has the following properties: a <code>status</code> of &quot;400&quot;, a <code>title</code><br>
of &quot;Bad request.&quot;, and an array of <code>errors</code>. Make sure that you see a <code>400 Bad Request</code> error if there are failing data validations.</p>
<h3 class="mume-header" id="put-tweetsid">PUT /tweets/:id</h3>

<p>Set up a PUT <code>/:id(\\d+)</code> route to update a tweet. Begin by parsing the tweet id<br>
within your <code>req.params</code> object and using the parsed <code>tweetId</code> to fetch the<br>
tweet to update. If you have a valid tweet, await the update and then render the<br>
updated tweet in JSON format.</p>
<p>If you have not fetched a valid tweet, use the same <code>404</code> error handling that<br>
the <code>GET /tweets/:id</code> route used. Invoke your <code>tweetNotFoundError</code> function<br>
to generate a <code>404</code> error. Then pass the return value of the<br>
<code>tweetNotFoundError</code> function call into the <code>next</code> method.</p>
<p>Make sure to also use the same <code>400</code> error handling that the <code>POST /tweets</code><br>
route used. Validate your data and handle your validation errors, like in the<br>
POST route, to generate an error response upon receiving bad form data.</p>
<p>Test your PUT route:</p>
<ol>
<li>Use Postman to send a GET request to <code>localhost:8080/tweets/1</code> to view the<br>
data of your first database tweet.</li>
<li>Configure your &quot;Content-Type&quot; header as &quot;application/json&quot;.</li>
<li>Send a PUT request to <code>localhost:8080/tweets/1</code> with updated fields in the<br>
<code>raw</code> request body.</li>
<li>View your updated tweet in Postbird.</li>
<li>Send a PUT request to <code>localhost:8080/tweets/1</code> with invalid data to check<br>
the error handling.</li>
</ol>
<h3 class="mume-header" id="delete-tweetsid">DELETE /tweets/:id</h3>

<p>Set up the DELETE <code>/:id(\\d+)</code> route for deleting a tweet by sending a DELETE<br>
request to <code>localhost:8080/tweets/:id</code>. Begin by parsing the tweet ID and using<br>
the id to find your tweet to delete. If a valid tweet is found, await to destroy<br>
the tweet and render a <code>204</code> response to confirm the deletion by using<br>
<code>res.status(204).end()</code>.</p>
<p>If a valid tweet wasn&apos;t found, use the same <code>404</code> error handling that the GET<br>
and PUT routes used. Pass the tweet ID into your <code>tweetNotFoundError</code> function<br>
call to generate a <code>404</code> error. Then pass your newly generated <code>404</code> error into<br>
the <code>next</code> method to invoke the global error handler.</p>
<p>Lastly, send a request with Postman to test your DELETE route and delete a<br>
tweet. Verify that the tweet was properly deleted by viewing your seeded objects<br>
with Postbird.</p>
<h2 class="mume-header" id="phase-4-render-tweets-in-the-frontend-application">Phase 4: Render tweets in the frontend application</h2>

<p>Up to this point, you&#x2019;ve set up a CRUD API for tweets. All users of your API<br>
have access to the following features:</p>
<ul>
<li>Viewing all existing tweets</li>
<li>Viewing a tweet specific tweet</li>
<li>Creating a tweet</li>
<li>Updating a tweet</li>
<li>Deleting a tweet</li>
</ul>
<p>Now that you have a fully functioning API, you can create another Express<br>
application to serve the pages to render the client-side code for the Twitter<br>
Lite user interface. To review, the term &quot;client-side&quot; means that user triggered<br>
events (i.e. form submissions), the API request/response cycle, and rendering<br>
data is handled by JavaScript code running in the browser.</p>
<p>This new Express application will use the Pug template engine to render HTML<br>
pages on the server-side or backend. Regardless, we&apos;ll refer to this Express<br>
application as the &quot;frontend&quot; of the Twitter Lite project since the backend<br>
rendered pages are primarily used to deliver the client-side JavaScript to the<br>
browser.</p>
<p>Here are all the things that you still need to do to make your project a lite<br>
version of Twitter:</p>
<ul>
<li>Add an Express &quot;frontend&quot; application to deliver the client-side code to<br>
interact with the API;</li>
<li>Set up users and auth in the API; and</li>
<li>Set up users and auth in the frontend application.</li>
</ul>
<p>To add the frontend application, clone the repo below into a new folder that&apos;s<br>
a sibling to the API project folder.</p>
<pre data-role="codeBlock" data-info class="language-"><code>git clone https://github.com/appacademy-starters/express-apis-frontend.git
</code></pre><p>Move into your frontend <code>express-apis-frontend</code> directory and run <code>npm install</code>. Now you&apos;ll want to start up the frontend server and the backend server<br>
in different terminal tabs or windows. Start your backend server from the first<br>
terminal window by running the <code>npm start</code> command from the root of the API<br>
project. Then open a second terminal to start your frontend server by running<br>
<code>npm start</code> from within the <code>express-apis-frontend</code> folder.</p>
<p>Take a moment to navigate to your backend at <code>http://localhost:8080/</code>. You<br>
should see a JSON response of a &quot;test index root&quot; message. Now navigate to your<br>
frontend at <code>http://localhost:4000/</code>. Open up your developer tools and you<br>
should see an <code>h1</code> element with the content of &quot;Hello World!&quot;.</p>
<p>Open your <code>public/js/index.js</code> file and add an event listener script. This file<br>
is where you will fetch all tweets from <code>http://localhost:8080/tweets</code>. Start<br>
off by awaiting the fetch response (<code>res</code>) of all your API tweets. Parse your<br>
response into JSON and destructure the <code>tweets</code> property from your parsed<br>
response object. You&apos;ll eventually use these <code>tweets</code> to render a list of each<br>
tweet message, but just console log all the tweets for now. Make sure to catch<br>
and <code>console.error</code> any errors. Your script function should look something like<br>
this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/tweets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> tweets <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tweets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>As a reminder, your <code>index.js</code> script will run as soon as the DOM content in<br>
your browser loads for your frontend. Your API fetch call will fire after the<br>
DOM content has loaded and the <code>tweets</code> from your response will be logged in<br>
your developer tools console.</p>
<p>If you navigate to <code>localhost:4000/</code> to view your frontend application, you<br>
should see a <code>Failed to fetch</code> error message. Let&apos;s investigate! Instead of<br>
console logging your <code>tweets</code>, try console logging the response (<code>res</code>) to<br>
figure out more context around your error. If you look closer, your response has<br>
<code>type</code> of &quot;cors&quot; and that you have a success status code of <code>200 OK</code>. This<br>
indicates that your application has a CORS error!</p>
<p>Resolve this CORS issue back on the API side by installing the <code>cors</code> npm<br>
package. In <code>app.js</code>, require and configure the <code>cors</code> middleware function to<br>
allow requests from the origin <code>localhost:4000</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">{</span> origin<span class="token punctuation">:</span> <span class="token string">&quot;http://localhost:4000&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Go back to the frontend application and try to console log the tweets again. This<br>
time, all the existing tweets should console log! Now let&apos;s actually display the<br>
tweets in HTML elements by updating the &quot;DOMContentLoaded&quot; event listener in<br>
<code>public/js/index.js</code>.</p>
<p>After your fetch call in the <code>try</code> block, redirect your user to the <code>/log-in</code><br>
page and <code>return</code> out of the event listener function if your <code>res</code> has a status<br>
of <code>401</code>. If the response does not have a status of <code>401</code>, parse your response as<br>
JSON and destructure the <code>tweets</code> property from your JSON response.</p>
<p>Take a moment to create a <code>div</code> element in your <code>index.pug</code> template before the<br>
load of your <code>index.js</code> script. Set the <code>div</code> with an ID of &quot;tweets-container&quot;.<br>
In your event listener, use the Vanilla JavaScript <code>querySelector()</code> method to<br>
find the <code>tweetsContainer</code>. Declare a <code>tweetsHtml</code> variable for an array of<br>
stringified HTML blocks that will render tweet messages. Map over your array of<br>
<code>tweets</code> to generate the array of stringified HTML blocks.</p>
<p>You can use Bootstrap classes to style the tweets. For each message, render a<br>
<code>div.card</code> parent element with a <code>div.card-body</code> child element. Within the<br>
<code>div.card-body</code> element should live a <code>p.card-text</code> element that renders each<br>
tweet&apos;s <code>message</code> with interpolation. You&apos;ll want to join your <code>tweetsHtml</code><br>
array by an empty string (<code>&quot;&quot;</code>) to create a full stringified HTML block for all<br>
your tweet message blocks. Set the the <code>innerHTML</code> property of the<br>
<code>tweetsContainer</code> to be the joined <code>tweetsHtml</code>.</p>
<p>Lastly, make sure that you are using <code>console.error</code> to log any caught errors.<br>
Your script should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/tweets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> tweets <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> tweetsContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#tweets-container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tweetsHtml <span class="token operator">=</span> tweets<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> message <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`
      &lt;div class=&quot;card&quot;&gt;
        &lt;div class=&quot;card-body&quot;&gt;
          &lt;p class=&quot;card-text&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    tweetsContainer<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> tweetsHtml<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Take a moment to confirm that your frontend is fetching and rendering the tweets<br>
on <code>localhost:4000/</code>.</p>
<h2 class="mume-header" id="phase-5-add-the-users-model">Phase 5: Add the users model</h2>

<p>Now it&apos;s time to set up the users model to begin implementing user<br>
authentication! Use the following Sequelize command to generate a User model<br>
with <code>username</code>, <code>email</code>, and <code>hashedPassword</code> attributes.</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx sequelize model:generate --name User --attributes <span class="token string">&apos;username:string,email:string,hashedPassword:string&apos;</span>
</pre><p>Make sure to update the user model and migration files with the following<br>
constraints:</p>
<ul>
<li><code>username</code> is unique and not nullable</li>
<li><code>email</code> is unique and not nullable</li>
<li><code>hashedPassword</code> is the type <code>STRING.BINARY</code> and not nullable.</li>
</ul>
<p>Now run the migration with <code>npx dotenv sequelize db:migrate</code> and check in<br>
Postbird to confirm the creation of your User table.</p>
<hr>
<h1 class="mume-header" id="twitter-lite-project-with-authentication">Twitter Lite Project... with Authentication!</h1>

<p>At this point, you&apos;ve set up an API for tweets and connected a frontend<br>
application to interact with your API. You&apos;ve also added a Users model to your<br>
project to prepare for implementing user authentication.</p>
<p>In this project, you&#x2019;ll be writing Vanilla JS to render frontend elements. You<br>
have been using string template literals to render data from the database as<br>
HTML. Later on in the class, you&#x2019;ll use React to render components and build<br>
frontend clients. In the next portion of the project, you will set up the Users<br>
router and protect your tweet resources from unauthenticated users.</p>
<p>When you have completed the second part of the project, your application should<br>
have the following features:</p>
<ol>
<li>Users routes</li>
<li>Protected tweet resources</li>
<li>User registration</li>
<li>User log-in</li>
<li>Authenticated tweet creation</li>
<li>A form to create tweets</li>
</ol>
<h2 class="mume-header" id="phase-1-users-router">Phase 1: Users router</h2>

<p>Begin by creating a users routes module at <code>routes/users.js</code>. Require <code>express</code><br>
to initialize a router with <code>express.Router()</code> and make sure to export the<br>
router you just initialized.</p>
<p>In your <code>app.js</code> file, require the <code>usersRouter</code> you have just created and have<br>
your application connect the <code>/users</code> path to the <code>usersRouter</code>.</p>
<p>The users router will need to use a couple of helper functions that currently<br>
exist in the tweets router: <code>asyncHandler</code> and <code>handleValidationErrors</code>. Go<br>
ahead and create a <code>utils.js</code> file within the root of your project and then move<br>
those two functions into that file.</p>
<p>Now add a route in the user router to handle POST requests to<br>
<code>localhost:8080/users</code>. In this route, use <code>express-validator</code> to validate the<br>
params. Make sure to import <code>check</code> from <code>express-validator</code> as well as the<br>
<code>asyncHandler</code> and <code>handleValidationErrors</code> helper functions from the<br>
<code>../utils.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> check <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> asyncHandler<span class="token punctuation">,</span> handleValidationErrors <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In your POST route, begin by wrapping the route handler with the <code>asyncHandler</code><br>
function because there will be some asynchronous logic inside the route.</p>
<p>Add the following validations to validate your user authentication data so that<br>
you can render error messages upon submission of bad registration data. Go ahead<br>
and also use the <code>handleValidationErrors</code> helper middleware function.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> validateUsername <span class="token operator">=</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Please provide a username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> validateEmailAndPassword <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Please provide a valid email.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Please provide a password.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  validateUsername<span class="token punctuation">,</span>
  validateEmailAndPassword<span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: User creation logic</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Within the asynchronous route handler function, destructure the <code>username</code>,<br>
<code>email</code>, and <code>password</code> from the <code>body</code> of your request. You&apos;ll use these<br>
properties to create a new user in your database. For now, leave a <code>TODO</code> note<br>
to create the user.</p>
<p>Now to actually create the user, install and require the <code>bcryptjs</code> library to<br>
use the <code>bcrypt.hash()</code> method. Invoke the <code>bcrypt.hash()</code> method with the<br>
user&apos;s <code>password</code> and a salt round of <code>10</code>. Await the generation of a<br>
<code>hashedPassword</code> before creating the user.</p>
<p>At this point, make sure you have required the <code>db</code> from <code>../db/models</code>.<br>
Destructure your <code>User</code> model from your <code>db</code> module and await the creation of<br>
your user (<code>User.create()</code>). In order to protect the user&apos;s credentials, create<br>
the user with the <code>hashedPassword</code> instead of the <code>password</code> from the form<br>
request body.</p>
<p>At this point, your user creation route should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  validateUsername<span class="token punctuation">,</span>
  validateEmailAndPassword<span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> hashedPassword <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: Generate JSON Web Token (access token)</span>
    <span class="token comment">// TODO: Render user in JSON</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Once the user has been created, you want to return an access token. You&apos;ll be<br>
using a JWT as the access token. To generate and decode the JWT, use the<br>
<a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> npm package. Begin by running <code>npm install jsonwebtoken</code>.</p>
<p>There are a few configuration steps to set up JWT generation. You need to set a<br>
<em>secret key</em> and a number representing how many seconds before the token<br>
expires. Add a <code>JWT_SECRET</code> and <code>JWT_EXPIRES_IN</code> variable to your <code>.env</code> file.</p>
<p>To generate a secret, open up your node repl in your terminal by running <code>node</code><br>
and then use the built-in crypto module to generate your <code>JWT_SECRET</code> key:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;crypto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>For the <code>JWT_EXPIRES_IN</code> set it to <code>604800</code>, which is the number of seconds for<br>
one week. Then update your <code>config/index.js</code> file to use these environment<br>
variables:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  environment<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8080</span><span class="token punctuation">,</span>
  db<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_USERNAME</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PASSWORD</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_DATABASE</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_HOST</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  jwtConfig<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    secret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">,</span>
    expiresIn<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_EXPIRES_IN</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Finally, let&apos;s put this JWT generation logic inside of an <code>auth.js</code> file. Create<br>
an <code>auth.js</code> file in the root of your project and require the <code>jsonwebtoken</code><br>
package as well as your <code>jwtConfig</code> variables from your <code>./config</code> module.</p>
<p>Now define a function called <code>getUserToken</code>. This function will take a user<br>
object as a parameter and then create a payload from the user. Then, it uses the<br>
<code>jsonwebtoken.sign()</code> function to generate a token.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> jwtConfig <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> secret<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span> <span class="token operator">=</span> jwtConfig<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUserToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Don&apos;t store the user&apos;s hashed password</span>
  <span class="token comment">// in the token data.</span>
  <span class="token keyword">const</span> userDataForToken <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create the token.</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> data<span class="token punctuation">:</span> userDataForToken <span class="token punctuation">}</span><span class="token punctuation">,</span>
    secret<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> expiresIn<span class="token punctuation">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>expiresIn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// 604,800 seconds = 1 week</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> getUserToken <span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Notice how in the code above, we had to convert <code>expiresIn</code> from a string to an<br>
integer because environment variables declared in the <code>.env</code> file are strings,<br>
and according to the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> docs, anything that gets set to the<br>
<code>expiresIn</code> as an <strong>integer</strong> will be calculated as <strong>seconds</strong>, and <strong>strings</strong><br>
will be calculated in <strong>milliseconds</strong>.</p>
<p>Now, go back to the users routes module and import the <code>getUserToken</code> function<br>
from the <code>../auth</code> module. Then update the user creation route to call the<br>
<code>getUserToken</code> function and return a token to the user when they sign up for an<br>
account. Your user creation route should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  validateUsername<span class="token punctuation">,</span>
  validateEmailAndPassword<span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> hashedPassword <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">getUserToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span>
      token<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Once you&apos;ve confirmed that this is working correctly on Postman, let&apos;s put this<br>
JWT token to use by protecting the tweets resources and only allowing signed in<br>
users to access the tweets routes!</p>
<h2 class="mume-header" id="phase-2-protecting-the-tweets-resources">Phase 2: Protecting the tweets resources</h2>

<p>It&apos;s time to protect the tweet resources in your API! On each request to tweet<br>
routes, do the following:</p>
<ol>
<li>Parse out the JWT token from the request header.</li>
<li>Decode the JWT.</li>
<li>Find the user based on the JWT payload.</li>
</ol>
<p>If all of the steps above succeed, then the user is considered to be signed in<br>
and can access the tweet resources.</p>
<p>To carry out the plan above, go to back to your <code>auth.js</code> file. Here, you&apos;ll<br>
want to use two middleware functions. The first will parse out the JWT token<br>
from the request header. The second function decodes the JWT to find the user<br>
and stores the user in the <code>req</code> object.</p>
<p>For the first middleware function, let&apos;s use the <code>express-bearer-token</code><br>
middleware to do this parsing. Run <code>npm install express-bearer-token</code> to add the<br>
middleware to your application. Begin by requiring the middleware as<br>
<code>bearerToken</code> as well as requiring your <code>User</code> model from the database models.</p>
<p>Define a middleware function named <code>restoreUser</code> that takes in the parameters:<br>
<code>req</code>, <code>res</code>, and <code>next</code>. Begin by destructuring the JWT <code>token</code> from the <code>req</code><br>
object. If the token is invalid, return an invocation of the <code>next</code> function.</p>
<p>If the token is valid, invoke the <code>jwt.verify()</code> method with four arguments:</p>
<ul>
<li>JWT <code>token</code> from the request body;</li>
<li>JWT <code>secret</code> from your configuration file;</li>
<li><code>null</code> options; and</li>
<li>An asynchronous function that takes in an error and a <code>jwtPayload</code> (more steps<br>
below).</li>
</ul>
<p>Currently, your <code>restoreUser</code> function should look something like this. Notice<br>
if we don&apos;t get a token in the request at all we set the &quot;WWW-Authenticate&quot;<br>
header to &quot;Bearer&quot; and return a &quot;401 Unauthorized&quot; status code.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">restoreUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;WWW-Authenticate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> jwtPayload</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: Define asynchronous function for jwtPayload logic</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>In the asynchronous function, check whether there is an error object. If so, set<br>
the error&apos;s status to be <code>401</code> and return an invocation of the <code>next</code> function<br>
passing in the error object:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>If there is no error, extract the user&apos;s <code>id</code> from the <code>data</code> property of your<br>
<code>jwtPayload</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> jwtPayload<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
</pre><p>Then use a <code>try</code>/<code>catch</code> block to await the fetch of a user (by using<br>
<code>User.findByPk()</code>) or catch an error to return an invocation of the <code>next</code><br>
function:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Now check to see whether the <code>req</code> object has an associated <code>user</code> property. If<br>
there isn&apos;t a valid user, return a response that sets the &quot;WWW-Authenticate&quot; header<br>
with a value of &quot;Bearer&quot; and sends a &quot;401 Unauthorized&quot; status code before<br>
invoking the <code>next</code> function:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;WWW-Authenticate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Your complete <code>restoreUser</code> function should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">restoreUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;WWW-Authenticate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> jwtPayload</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> jwtPayload<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;WWW-Authenticate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now, take a moment to organize your <code>bearerToken</code> generator function and the<br>
<code>restoreUser</code> function into an array named <code>requireAuth</code>. Update your module<br>
exports to export the two functions as one <code>requireAuth</code> array:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> requireAuth <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">bearerToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> restoreUser<span class="token punctuation">]</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> getUserToken<span class="token punctuation">,</span> requireAuth <span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now it&apos;s time to add the <code>requireAuth</code> middleware to the tweets router! Add the<br>
following code to your <code>routes/tweets.js</code> file to use the user authentication<br>
functions you just created:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> requireAuth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// REST OF FILE NOT SHOWN</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>requireAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Verify that your tweet protection works by trying to make a GET request to<br>
<code>localhost:8080/tweets</code> from Postman. You should see a <code>401</code> response.</p>
<p>To fix this, create another user by posting to <code>localhost:8080/users</code>. This<br>
time, when the token comes back in the response, copy that response and paste it<br>
in to the <em>Authorization header</em>:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postman-jwt-token-1.png" alt="postman-user-jwt-token"><br>
<img src="images/api-tweets-project-postman-jwt-token-2.png" alt="postman-jwt-token-bearer-header"></p>
<p>Then try to get all of the tweets again. This time, your request should pass<br>
through the <code>requireAuth</code> middleware functions successfully. Now that your<br>
tweets are protected, let&apos;s add a view for users to sign up from the client<br>
application!</p>
<h2 class="mume-header" id="phase-3-sign-up-for-user-account-from-the-client">Phase 3: Sign up for user account from the client</h2>

<p>Begin by adding a GET route in the <code>express-apis-frontend/index.js</code> file to<br>
render a <code>sign-up</code> template:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/sign-up&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;sign-up&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Use the snippet below to create a registration form for the <code>sign-up.pug</code><br>
template.</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;sign-up-container&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;errors-container&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">h2</span> <span class="token plain-text">Sign Up</span>
    <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;sign-up-form&quot;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">.form-group</span>
        <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;username&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Username</span>
        <span class="token tag">input#username.form-control<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;text&apos;</span> name<span class="token operator">=</span><span class="token string">&apos;username&apos;</span> placeholder<span class="token operator">=</span><span class="token string">&quot;Username&quot;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">.form-group</span>
        <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;email&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email address</span>
        <span class="token tag">input#email.form-control<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;email&apos;</span></span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">,</span> <span class="token attr-name">placeholder</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;Enter email&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">.form-group</span>
        <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;password&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Password</span>
        <span class="token tag">input#password.form-control<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;password&apos;</span></span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;password&quot;</span></span><span class="token punctuation">,</span> <span class="token attr-name">placeholder</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;Password&apos;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token tag">button.btn.btn-primary<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Sign Up</span>
    <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/log-in&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Already have an account? Log in here.</span>
  <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;js/sign-up.js&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>In the code above, there&apos;s also an anchor element to navigate to the <code>/log-in</code><br>
route that we&apos;ll implement next. Since the user will use the email and password<br>
input fields for the later log in form, let&apos;s move those to an <em>includes</em> file<br>
to DRY up our code.</p>
<p>Move the following <code>.form-group</code> elements from your <code>sign-up.pug</code> file to a new<br>
<code>views/includes/auth-form-fields.pug</code> file:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token tag">.form-group</span>
  <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;email&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email address</span>
  <span class="token tag">input#email.form-control<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;email&apos;</span></span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">,</span> <span class="token attr-name">placeholder</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;Enter email&apos;</span></span><span class="token punctuation">)</span></span></span>
<span class="token tag">.form-group</span>
  <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;password&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Password</span>
  <span class="token tag">input#password.form-control<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;password&apos;</span></span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;password&quot;</span></span><span class="token punctuation">,</span> <span class="token attr-name">placeholder</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;Password&apos;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Now take a moment to refactor your <code>sign-up.pug</code> template to use your new<br>
<em>includes</em> file.</p>
<p>At the bottom of the <code>sign-up.pug</code> template, notice that a <code>js/sign-up.js</code><br>
script has already been imported. Set up this <code>sign-up.js</code> script inside your<br>
<code>express-apis-frontend/public/js</code> directory. In the script, you want to add a<br>
<em>submit</em> event listener to the sign up form (hint: search for the element with a<br>
class of <code>sign-up-form</code>) and an asynchronous callback function to handle the<br>
sign up request. Remember that <code>submit</code> events automatically prompt a GET<br>
request to re-render the page. Make sure to prevent the form from re-rendering<br>
by using <code>e.preventDefault()</code> at the beginning of your event listener:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> signUpForm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.sign-up-form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

signUpForm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Sign up logic here</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Generate a new <code>FormData</code> object with your <code>signUpForm</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>signUpForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData/get">formData.get()</a> method to retrieve the <code>username</code>, <code>email</code>, and<br>
<code>password</code> from the form. You can use the form values to declare a <code>body</code><br>
variable:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> email <span class="token operator">=</span> <span class="token comment">// TODO: Get email</span>
<span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token comment">// TODO: Get password</span>
<span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token comment">// TODO: Get username</span>

<span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> username <span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>When a submit event happens, parse out the data from the form and then use a<br>
<code>fetch</code> call to make a POST request to <code>localhost:8080/users</code> to create the user<br>
in a <code>try</code> block. Set the <code>fetch</code> call&apos;s <code>method</code> to be &quot;POST&quot; and the <code>body</code> to<br>
be a JSON string of the form fields (hint: use <code>JSON.stringify({ email, password, username })</code>). Lastly, set a <code>Content-Type</code> header of<br>
&quot;application/json&quot;.</p>
<p>Your fetch call should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/users&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token punctuation">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span>
    headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Fetch calls don&apos;t throw errors on error status code responses. Note that the<br>
Fetch API only rejects network failure errors. This means you need to <a href="https://github.com/appacademy/Module-Web/blob/master/readings/ajax/reading-ajax-steps.md#error-handling">manually<br>
handle response errors</a> by checking the response&apos;s <code>ok</code> property. Add the code<br>
snippet below in your <code>try</code> block to manually throw an error if the fetch<br>
request was rejected:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>When the response body returns, store the JWT token and the user id in<br>
<code>localStorage</code> and redirect the user to the home page:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>
  token<span class="token punctuation">,</span>
  user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;TWITTER_LITE_CURRENT_USER_ID&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>If an error happens, await the parsing of the error object as JSON and query<br>
for your element with the class of <code>errors-container</code>. Your <code>try</code>/<code>catch</code> block<br>
should currently look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// CODE OMITTED FOR BREVITY</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    token<span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// CODE OMITTED FOR BREVITY</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> errorJSON <span class="token operator">=</span> <span class="token keyword">await</span> err<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> errorsContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.errors-container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: Generate and render errors</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: Alert user about bad internet connection</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Like how you rendered your list of tweets when you first connected the frontend<br>
to your application, you&apos;ll set the <code>innerHTML</code> of your <code>errorsContainer</code> to a<br>
stringified HTML block. Sometimes there might not be an errors array returned,<br>
and in those cases, go ahead and declare the <code>errorsHtml</code> array to display a<br>
generic &quot;Something went wrong&quot; message.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// errorsHtml block to alert user of error:</span>
<span class="token keyword">let</span> errorsHtml <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token template-string"><span class="token string">`
    &lt;div class=&quot;alert alert-danger&quot;&gt;
        Something went wrong. Please try again.
    &lt;/div&gt;
  `</span></span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre><p>Now take a look at the global error handling function in your <code>app.js</code> and<br>
notice how you are rendering an <code>errors</code> property in your JSON response. This<br>
<code>errors</code> property is the array of error messages from your validations. Iterate<br>
through the <code>errors</code> array and display them:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>errors <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  errorsHtml <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`
    &lt;div class=&quot;alert alert-danger&quot;&gt;
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    &lt;/div&gt;
  `</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO: Join errorsHtml and set the errorsContainer.innerHTML</span>
  <span class="token comment">// TODO: Error rendering</span>
<span class="token punctuation">}</span>
</pre><p>Since the Fetch API only throws errors on network errors (like if your internet<br>
cut out), so then we would also need to account for those types of errors. To<br>
account for these cases, go ahead and use the JavaScript <code>alert()</code> function to<br>
let the user know to check their internet connection:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span>
  <span class="token string">&quot;Something went wrong. Please check your internet connection and try again!&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>If the create request succeeds, redirect the user back to the home page right<br>
after you set your <code>localStorage</code> items. Use the <code>window.location.href</code> property<br>
so that the user can see all existing tweets:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
</pre><p>At this point, your <code>sign-up.js</code> file should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> signUpForm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.sign-up-form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

signUpForm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>signUpForm<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> email <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> username <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/users&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span>
      headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      token<span class="token punctuation">,</span>
      user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// storage access_token in localStorage:</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;TWITTER_LITE_CURRENT_USER_ID&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// redirect to home page to see all tweets:</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errorJSON <span class="token operator">=</span> <span class="token keyword">await</span> err<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> errorsContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.errors-container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> errorsHtml <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token string">`
        &lt;div class=&quot;alert alert-danger&quot;&gt;
            Something went wrong. Please try again.
        &lt;/div&gt;
      `</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span> <span class="token operator">=</span> errorJSON<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errors <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errorsHtml <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`
          &lt;div class=&quot;alert alert-danger&quot;&gt;
              </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
          &lt;/div&gt;
        `</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      errorsContainer<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> errorsHtml<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Something went wrong. Please check your internet connection and try again!&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>When a user signs up and is redirected to the home page, the request for all<br>
tweets should be failing because that request doesn&apos;t currently have the correct<br>
authentication headers. Let&apos;s fix this.</p>
<p>In the <code>public/js/index.js</code> file, add the <code>Authorization</code> header to your fetch<br>
call.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/tweets&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    Authorization<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>
      <span class="token string">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then, add the following code into your &quot;DOMContentLoaded&quot; event listener to<br>
redirect users to the log-in route if a user is not logged in. The next step is<br>
to implement the log-in route!</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/log-in&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Now that you&apos;ve implemented a sign-up flow, let&apos;s next implement a log-in flow!</p>
<h2 class="mume-header" id="phase-4-setting-up-the-log-in-flow">Phase 4: Setting up the log-in flow</h2>

<p>Go back to the API and add a route to the users router that allows users to<br>
fetch a new token, effectively logging them in. Do this by creating POST route<br>
to the <code>/token</code> path and using the <code>validateEmailAndPassword</code> middleware. Wrap<br>
your asynchronous route handler function with your <code>asyncHandler</code> helper method<br>
and destructure the <code>email</code> and <code>password</code> from your request body. Begin by<br>
using the <code>email</code> to find your user instance:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/token&quot;</span><span class="token punctuation">,</span>
  validateEmailAndPassword<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        email<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TODO: Password validation and error handling</span>
    <span class="token comment">// TODO: Token generation</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now we need a way to validate whether or not the provided password is correct.<br>
Let&apos;s implement a password validation function in the User model as an instance<br>
method! Add the instance method below to your <code>user.js</code> model file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token class-name">User</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">validatePassword</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Note that since this function is a model instance method,</span>
  <span class="token comment">// `this` is the user instance here:</span>
  <span class="token keyword">return</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashedPassword<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Note how the <code>hashedPassword</code> has to be converted back from its <em>binary</em> format<br>
to a <em>string</em> format before it can be compared with the provided <code>password</code>.</p>
<p>Back in the <code>/token</code> route handler, verify whether the a valid <code>user</code> has been<br>
found and use the <code>validatePassword</code> instance method to verify whether or not<br>
the user provided the correct credentials. If a valid user was found with a<br>
valid password, return a <code>token</code> and the user&apos;s <code>id</code> in the JSON response. If a<br>
valid user was not found or the password was incorrect, generate an error and<br>
return an invocation of the <code>next</code> function passing in the error:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> <span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">validatePassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Login failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;Login failed&quot;</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;The provided credentials were invalid.&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Make sure to generate a token by invoking your <code>getUserToken()</code> function with<br>
the <code>user</code> fetched from your database. Lastly, render a JSON response with the<br>
<code>token</code> and the user&apos;s <code>id</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">getUserToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token<span class="token punctuation">,</span> user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Next, go back to the frontend and set up a <code>localhost:4000/log-in</code> route. The<br>
logic is fairly similar to the sign-up route. First, set up a GET route in your<br>
<code>express-apis-frontend/index.js</code> file to render a <code>log-in</code> template:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/log-in&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;log-in&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then create a <code>views/log-in.pug</code> template with the snippet below:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;log-in-container&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;errors-container&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">h2</span> <span class="token plain-text">Log In</span>
    <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;log-in-form&quot;</span></span><span class="token punctuation">)</span></span></span>
      <span class="token keyword">include includes/auth-form-fields</span>
      <span class="token tag">button.btn.btn-primary<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Log In</span>
    <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/sign-up&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Don&apos;t have an account? Sign up here.</span>
  <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;js/log-in.js&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Now create a <code>public/js/log-in.js</code> file and add a <em>submit</em> event listener to do<br>
fairly similar logic to the event listener in your <code>public/js/sign-up.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> logInForm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.log-in-form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

logInForm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>logInForm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> email <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> password <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/users/token&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span>
      headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      token<span class="token punctuation">,</span>
      user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// storage access_token in localStorage:</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;TWITTER_LITE_ACCESS_TOKEN&quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;TWITTER_LITE_CURRENT_USER_ID&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// redirect to home page to see all tweets:</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">600</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> errorJSON <span class="token operator">=</span> <span class="token keyword">await</span> err<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> errorsContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.errors-container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> errorsHtml <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token string">`
        &lt;div class=&quot;alert alert-danger&quot;&gt;
            Something went wrong. Please try again.
        &lt;/div&gt;
      `</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span> <span class="token operator">=</span> errorJSON<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errors <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errorsHtml <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`
          &lt;div class=&quot;alert alert-danger&quot;&gt;
              </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
          &lt;/div&gt;
        `</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      errorsContainer<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> errorsHtml<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Something went wrong. Please check your internet connection and try again!&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>At this point, you might be thinking to yourself that this all seems super<br>
repetitive. In server-side Node.js code, you&apos;ve been using CommonJS modules to<br>
DRY up your code. Unfortunately, you haven&apos;t learned about client-side modules<br>
yet, but when you get to React, you&apos;ll learn more about using a frontend module<br>
system in order to clean up your code!</p>
<p>Now create a new user, and then go to the log in form to verify that the log in<br>
process works when you log in with the created user credentials.</p>
<h2 class="mume-header" id="phase-5-creating-tweets-from-the-frontend-application">Phase 5: Creating tweets from the frontend application</h2>

<p>Let&apos;s first reorganize the API so that tweets belong to a specific user. First,<br>
rollback all of your migrations by running the command below:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:migrate:undo:all
</pre><p>Then since we need to associate tweets with a user, add a foreign key of<br>
<code>userId</code> so that tweets can belong to users. Here&apos;s what your updated tweets<br>
migration file should look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&quot;Tweets&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      message<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">280</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      userId<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
        references<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          model<span class="token punctuation">:</span> <span class="token string">&quot;Users&quot;</span><span class="token punctuation">,</span>
          key<span class="token punctuation">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&quot;Tweets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>However, there&apos;s a problem right now. The <code>create-tweet</code> migration file was<br>
created first, and because of the timestamp in the first part of the file name,<br>
that specific migration will run first. The problem is that when we try to<br>
reference the Users table in the <code>references</code> definition part of the migration,<br>
the Users table has not actually been created yet. We&apos;re going to take a <em>hacky</em><br>
approach to resolve this issue and make the <code>create-user</code> migration run first.</p>
<p>To be clear, this is absolutely not how you would want to handle migrations in<br>
production. This whole &quot;undo all migrates and then switch up the order of<br>
migrations&quot; is purely for learning purposes and to help you get a better of how<br>
migrations work. So, go ahead and rename the <code>create-tweet</code> migration file so<br>
that the timestamp comes later than the <code>create-user</code> migration file:</p>
<p><img src="images/api-tweets-project-migration-file-rename.png" alt="migration-file-rename"></p>
<p>Now, that you&apos;ve updated the migrations to properly configure the tables in your<br>
database, update the models to also reflect this relationship. This is what your<br>
tweet model should look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Tweet <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
    <span class="token string">&quot;Tweet&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">280</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  Tweet<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Tweet<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Tweet<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>This is what your user model should look like after you add the associations:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;bcryptjs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
    <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      email<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> unique<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      username<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span> allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> unique<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      hashedPassword<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">.</span><span class="token constant">BINARY</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Tweet<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&quot;tweets&quot;</span><span class="token punctuation">,</span>
      foreignKey<span class="token punctuation">:</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">User</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">validatePassword</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// because this is a model instance method, `this` is the user instance here:</span>
    <span class="token keyword">return</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashedPassword<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Finally, let&apos;s also update the seeders to reflect this new relationship between<br>
tweets and users. We&apos;ll also use the faker library to generate fake content, so<br>
run <code>npm install faker</code>, and then update the seeders to:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> faker <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;faker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;bcryptjs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Users&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          username<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>internet<span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          email<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>internet<span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          hashedPassword<span class="token punctuation">:</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>faker<span class="token punctuation">.</span>internet<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          username<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>internet<span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          email<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>internet<span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          hashedPassword<span class="token punctuation">:</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>faker<span class="token punctuation">.</span>internet<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> returning<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Tweets&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>company<span class="token punctuation">.</span><span class="token function">catchPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          userId<span class="token punctuation">:</span> users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>company<span class="token punctuation">.</span><span class="token function">catchPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          userId<span class="token punctuation">:</span> users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          message<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>company<span class="token punctuation">.</span><span class="token function">catchPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          userId<span class="token punctuation">:</span> users<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">&quot;Tweets&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">&quot;Users&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now that you&apos;ve updated the migrations, models, and seeders to reflect the<br>
tweets <em>belongsTo</em> users and user <em>hasMany</em> tweets relationships, let&apos;s run all<br>
of the migrations and seed scripts:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">npx dotenv sequelize db:migrate
npx dotenv sequelize db:seed:all
</pre><p>Check Postbird to verify all the data has been properly created. Go to<br>
<code>routes/tweets.js</code> and update the post route so that when a tweet is created,<br>
the <code>id</code> of the <code>req.user</code> is stored in the <code>userId</code> column of the tweet:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> tweet <span class="token operator">=</span> <span class="token keyword">await</span> Tweet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> userId<span class="token punctuation">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Finally, update the GET <code>/</code> tweets route so that it also includes the author of<br>
the tweet. You previously learned about eager loading associations. When<br>
designing APIs, it&apos;s critical that you don&apos;t return any more info than is<br>
necessary.</p>
<p>So for example, in this case, when you eager load the user, if you didn&apos;t filter<br>
anything out, then it would include extra info like user email address or the<br>
hashedPassword, when really all the client needs to know from this route is the<br>
username of the author of the specific tweet and perhaps the user id of the<br>
author.</p>
<p>Fortunately, we can use sequelize <code>attributes</code> to filter out the fields that get<br>
returned from the sequelize query:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> tweets <span class="token operator">=</span> <span class="token keyword">await</span> Tweet<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  include<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> model<span class="token punctuation">:</span> User<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  order<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;createdAt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;DESC&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Let&apos;s now go back to the client to set up a form for an authenticated user to<br>
create tweets!</p>
<h2 class="mume-header" id="phase-6-seeing-tweets-with-authors-and-creating-tweets-from-the-client">Phase 6: Seeing tweets with authors and creating tweets from the client</h2>

<p>First, let&apos;s update the <code>public/js/index.js</code> script to render the username on<br>
top of the message (hint: destructure the user from each tweet and then<br>
destructure the username <code>{ message, user: { username } }</code>).</p>
<p>Update the <code>tweetsHtml</code> to render a <code>username</code> as content within a<br>
<code>div.card-header</code> element. Make the <code>div.card-header</code> element a child of the<br>
<code>div.card</code> element. Feel free to make use fo the HTML snippet below:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>card-header<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ${username}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</pre><p>Next, let&apos;s set up a <code>create</code> view for the user to create a tweet. First add the<br>
route in your <code>express-apis-frontend/index.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then set up the associated <code>create.pug</code> template with the snippet below:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">.errors-container</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;create-form&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">.form-group</span>
      <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;message&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Message</span>
      <span class="token tag">input#message.form-control<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;message&apos;</span></span><span class="token punctuation">,</span> <span class="token attr-name">name</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;message&quot;</span></span><span class="token punctuation">,</span> <span class="token attr-name">placeholder</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;What do you want to tweet?&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">button.btn.btn-primary<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;submit&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Tweet</span>

  <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;js/create.js&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Before we implement the <code>public/js/create.js</code> script file, let&apos;s update the<br>
<code>layout.pug</code> template to now also render a nav bar at the top of the application<br>
to allow users to easily navigate around:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token doctype">doctype html</span>
<span class="token tag">html</span>
  <span class="token tag">head</span>
    <span class="token tag">title</span> <span class="token plain-text">Twitter Lite</span>
    <span class="token tag">link<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">rel</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;stylesheet&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css&apos;</span> integrity<span class="token operator">=</span><span class="token string">&apos;sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh&apos;</span> crossorigin<span class="token operator">=</span><span class="token string">&apos;anonymous&apos;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">link<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">rel</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;stylesheet&apos;</span> type<span class="token operator">=</span><span class="token string">&apos;text/css&apos;</span> href<span class="token operator">=</span><span class="token string">&apos;/style.css&apos;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">body</span>
    <span class="token tag">nav.navbar.navbar-expand-lg.navbar-light.bg-light</span>
      <span class="token tag">a.navbar-brand<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Twitter Lite</span>
      <span class="token tag">.navbar-nav</span>
        <span class="token tag">a.nav-item.nav-link<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/create&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Create Tweet</span>
        <span class="token tag">a.nav-item.nav-link<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&apos;/profile&apos;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">My Tweets</span>
    <span class="token keyword">block content</span>
</pre><p>Notice how there&apos;s a link to a <code>/profile</code> route, which we will implement in the<br>
next phase. Now create the <code>public/js/create.js</code> file. In this file, begin by<br>
adding an event listener to the element with a class name of <code>create-form</code>.<br>
Remember to use <code>e.preventDefault()</code> within the event listener to prevent the<br>
form from sending a GET request upon submission. Then parse the form data:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> form <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.create-form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

form<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;submit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// TODO: Fetch tweets</span>
  <span class="token comment">// TODO: Redirect users to login page upon a 401 error</span>
  <span class="token comment">// TODO: Handle errors</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Within a <code>try</code> block, use the Fetch API to make a POST request to<br>
<code>http://localhost:8080/tweets</code> with the necessary <code>body</code> (formatted as a JSON<br>
string) and headers (<code>Content-Type</code> and <code>Authorization</code>). Upon a successful<br>
fetch request, remember to redirect the user to the home page by using the<br>
<code>window.location.href</code> property.</p>
<p>Now handle the following response and errors caught. If you receive a response<br>
with a status of <code>401</code>, redirect users to log-in page. Throw the response<br>
(<code>res</code>) for any other response statuses. If you catch an error with a status<br>
greater than or equal to <code>400</code> and less than <code>600</code>, parse your caught error as<br>
JSON and find your <code>errorsContainer</code> (element with a class of<br>
<code>errors-container</code>). Declare an array of error elements by using the<br>
<code>errorsHtml</code> snippet below:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">let</span> errorsHtml <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token template-string"><span class="token string">`
  &lt;div class=&quot;alert alert-danger&quot;&gt;
      Something went wrong. Please try again.
  &lt;/div&gt;
`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre><p>Now destructure your <code>errors</code> array from your error parsed as JSON and verify<br>
if <code>errors</code> is a valid, truthy array. If <code>errors</code> is a valid array, map through<br>
each <code>message</code> in the array to generate an array of stringified error elements:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span> <span class="token operator">=</span> errorJSON<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>errors <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  errorsHtml <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`
    &lt;div class=&quot;alert alert-danger&quot;&gt;
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    &lt;/div&gt;
  `</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Now join the elements within your <code>errorsHtml</code> array and set the joined array as<br>
the <code>innerHTML</code> of the <code>errorsContainer</code>. Lastly, use the <code>alert()</code> method to<br>
notify the end user with a generic error message.</p>
<h2 class="mume-header" id="phase-7-set-up-the-profile-page">Phase 7: Set up the profile page</h2>

<p>In the profile page, a user should be able to see their own tweets. Up to this<br>
point we haven&apos;t dealt with nested resources yet, but let&apos;s go ahead and build<br>
out a route where tweets are nested under a user.</p>
<p>In the users router, add an endpoint for <code>localhost:8080/users/:id/tweets</code>.<br>
You&apos;ll need to also import the Tweet model into this router. This route should<br>
await the database fetch of all tweets that belong to a specific user based on<br>
the <code>id</code> in the request <code>params</code>.</p>
<p>Make sure to import and your <code>requireAuth</code> middleware from the <code>../auth.js</code> file<br>
to keep your tweets <em>protected</em>. Also be sure to wrap the route handling<br>
function with your <code>asyncHandler</code> to be able to <code>await</code> the database fetch.<br>
Lastly, render the tweets in a JSON response.</p>
<p>Go to the client now and set up the profile page. Add the following route in the<br>
<code>express-apis-frontend/index.js</code> file to serve a <code>profile.pug</code> template:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/profile&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then set up the <code>profile.pug</code> template:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>
<span class="token keyword">block content</span>
  <span class="token tag">h2</span> <span class="token plain-text">Your Tweets</span>
  <span class="token tag">.tweets-container</span>
  <span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;js/profile.js&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><p>Finally, set up a script in the <code>public/js/profile.js</code> file to fetch all of the<br>
tweets that belong to the logged in user. Begin by adding a <code>DOMContentLoaded</code><br>
event listener. Now remember that after a user logs in or signs up, the server<br>
gives the client the user&apos;s id, which is stored in localStorage. Use that id to<br>
<code>try</code> to make a fetch request to the correct route (hint: interpolate the user&apos;s<br>
id into the fetch path). Make sure to include an <code>Authorization</code> header that<br>
gets the <code>TWITTER_LITE_ACCESS_TOKEN</code> from localStorage.</p>
<p>Upon a response status of <code>401</code>, re-direct the user to the <code>/log-in</code> page by<br>
using the <code>window.location.href</code> property and <code>return</code> out of the event listener<br>
function.</p>
<p>Upon a successful fetch, parse the response as JSON and destructure the<br>
response <code>tweets</code>. Search for the <code>tweetsContainer</code> (element with a class name<br>
of <code>tweets-container</code>) and declare a <code>tweetsHtml</code> variable. Now map over the<br>
<code>tweets</code> from your fetch response to generate an array of stringified tweet<br>
elements and set the <code>tweetsHtml</code> variable:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> tweetsHtml <span class="token operator">=</span> tweets<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> message<span class="token punctuation">,</span> id <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`
  &lt;div class=&quot;card&quot; id=&quot;tweet-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
    &lt;div class=&quot;card-body&quot;&gt;
      &lt;p class=&quot;card-text&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
`</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Make sure to join your stringified tweet elements to set the <code>innerHTML</code> of the<br>
<code>tweetsContainer</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">tweetsContainer<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> tweetsHtml<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Lastly, use <code>console.error()</code> to log any caught errors.</p>
<p>Nice work making it to this part of the project! In the next bonus phases, let&apos;s<br>
add a little more functionality, improve the UX of the app, and then also clean<br>
up the code!</p>
<h2 class="mume-header" id="bonus-phase-add-ability-to-delete-your-own-tweet">Bonus Phase: Add ability to delete your own tweet</h2>

<p>Let&apos;s add the ability to delete your own tweets, while not allowing anyone else to delete them!</p>
<p>Update your <code>profile.js</code> script so that after you fetch your own tweets, each message can show a delete button. Then, after the HTML has been added to the DOM, select all of the delete buttons to add a click handler to each button. The click handler&apos;s callback function should make a DELETE request to <code>http://localhost:8080/tweets/:id</code> in order to delete a tweet.</p>
<p>To add click handlers for each delete button, here&apos;s what you might want to write at the bottom of your &quot;DOMContentLoaded&quot; event listener in the <code>profile.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> deleteButtons <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&quot;.delete-button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>deleteButtons<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  deleteButtons<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">button</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token function">handleDelete</span><span class="token punctuation">(</span>button<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>In the code snippet above, there&apos;s a <code>handleDelete</code> callback function that&apos;s not shown. Go ahead and implement the logic for that function!</p>
<p>Next, let&apos;s add some logic so that only the author of a tweet can actually<br>
delete the tweet. Go to the endpoint for deleting tweets. How can you check<br>
whether or not the current user who&apos;s making this request is actually authorized<br>
to delete this tweet?</p>
<p>Once you&apos;ve tested that a tweet can only be deleted by its author in Postman,<br>
move on to the next bonus phase!</p>
<h2 class="mume-header" id="bonus-phase-combine-create-and-index-views">Bonus Phase: Combine create and index views</h2>

<p>Let&apos;s make it easier for users to create a tweet in the app. Right now, the<br>
whole process to create a tweet is a little cumbersome. Users have to navigate<br>
to a separate page for creating the tweet, and after it&apos;s created, they&apos;re then<br>
redirected back to another page to see the newly created.</p>
<p>Go ahead and move the create tweet form from <code>create.pug</code> to above the tweets<br>
container in <code>index.pug</code>. This will give the users the ability to create a tweet<br>
at the top of their timeline, which is an experience that&apos;s more in line with<br>
what the real Twitter does.</p>
<p>In this view, when users create a tweet, go ahead and just re-fetch all of the<br>
tweets again. Be sure to keep your code DRY here by extracting the logic to<br>
fetch all tweets into its own function.</p>
<p>Also, since you are no longer redirecting users to a different page after a<br>
tweet is created make sure you are clearing out the create tweet form inputs<br>
upon a successful tweet creation.</p>
<p>As a reminder, since you no longer need a create tweet page, go ahead and delete<br>
those template and JavaScript files, and then remove the navigation route from<br>
<code>layout.pug</code>.</p>
<p>When you are done with this phase, you should have an index page that allows<br>
users to create a tweet and then see that newly created tweet without ever<br>
requiring a page reload. This type of experience is more in line with what users<br>
expect from modern web apps. You&apos;ll dive deeper into how to build these types of<br>
modern frontends as you progress into the React curriculum soon!</p>
<h2 class="mume-header" id="bonus-phase-es-modules">Bonus Phase: ES Modules</h2>

<p>Finally, let&apos;s clean up some of the JavaScript code in the client app! Right now<br>
a lot of the error handling logic is being duplicated between the different<br>
files. DRY up your code with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript modules</a>.</p>
<p>You&apos;ll need to declare <code>type=&quot;module&quot;</code> in any script tags that load JavaScript<br>
files that use modules. Also, unlike the CommonJS module system (<code>require</code> and<br>
<code>module.exports</code>) that you&apos;ve been using in your server-side JavaScript, you&apos;ll<br>
need to use the ES module system (<code>import</code> and <code>export</code>) in client-side<br>
JavaScript.</p>
<p>In the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript modules</a> documentation, there&apos;s a section that talks about<br>
how ES modules are not supported by all browsers. In the React curriculum,<br>
you&apos;ll learn more about how to effectively handle client-side modules using<br>
build tools like <a href="https://webpack.js.org/">webpack</a>.</p>
<hr>
<h1 class="mume-header undefined" id="week-12-day-4brapis">WEEK-12 DAY-4<br><em>Apis</em></h1>

<hr>
<h1 class="mume-header" id="api-security-learning-objectives">API Security Learning Objectives</h1>

<p>Once you have an API up and running, you need to secure it to ward off leaking<br>
sensitive data or allowing people to use it in an unauthorized way. To do so,<br>
you will introduce the concept of authentication and authorization, again, but<br>
with tools that help support the stateless nature of RESTful APIs. After your<br>
homework, lecture, and practice, you should be able to</p>
<ul>
<li>Explain the fundamental concepts of OAuth as a way to authenticate users</li>
<li>Describe the workflow of OAuth resource owner password credentials grant<br>
(RFC 6749 Section 4.3)</li>
<li>Describe the components of a JSON Web Token (JWT) and how it is constructed</li>
<li>Configure an Express application to use token-based authentication and<br>
authorization using OAuth resource owner password credentials grant</li>
</ul>
<hr>
<h1 class="mume-header" id="oauth-20">OAuth 2.0</h1>

<p>As an application developer, your application sometimes needs to access your<br>
user&apos;s information from a different web application.</p>
<p>For example, let&apos;s say you&apos;re working on a website called<br>
MyMint<span>.com</span>, a simple site that lets people with multiple bank<br>
accounts access all of their accounts in one centralized place. In this example,<br>
Johnny wants to use your web app because he has an account with Chase and Bank<br>
of America, and he&apos;s tired of having to go back and forth between<br>
chase<span>.com</span> and bankofamerica<span>.com</span> in order to check<br>
his financial transactions.</p>
<p>So, Johnny signs up for MyMint<span>.com</span>, and you now need to be able to<br>
get Johnny&apos;s transactions from chase<span>.com</span>.</p>
<p>In the past, one way for you to access that information might have been for<br>
Johnny to directly give your application his password, and then your web app<br>
would go to chase<span>.com</span> to authenticate and then fetch the<br>
transactions. This was clearly not ideal from a security point of view.</p>
<p>OAuth 2.0 is a standard that allows for you to access that information without<br>
Johnny giving you his passwords to his bank account logins. It is defined by<br>
<a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a> &quot;The OAuth 2.0 Authorization Framework&quot;. OAuth 2.0 defines a very<br>
specific protocol for how your app (MyMint<span>.com</span>), Johnny, and<br>
chase<span>.com</span> should coordinate together so that you can securely get<br>
Johnny&apos;s chase<span>.com</span> transactions.</p>
<p>This article will help you learn how to</p>
<ul>
<li>Get your application ready for OAuth 2.0</li>
<li>Teach you about how OAuth 2.0 works</li>
<li>Use OAuth 2.0 to authenticate (and authorize) a person for your application<br>
from a third-party authority</li>
</ul>
<h2 class="mume-header" id="high-level-overview-of-oauth-20">High level overview of OAuth 2.0</h2>

<p>At a high level, there are six main steps to the OAuth 2.0 standard. Here is a<br>
high-level diagram from a <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2">Digital Ocean overview</a> of OAuth 2.0:</p>
<p><img src="images/abstract_flow.png" alt="High Level OAuth2 Flow"></p>
<p>Here are the key players mentioned in the diagram above:</p>
<ol>
<li><strong>Application</strong>- In our example, the application, or client, is the app that<br>
you&apos;ve built-- MyMint<span>.com</span>.</li>
<li><strong>User</strong>- The user in our example is Johnny. The user is also called the<br>
<strong>Resource Owner</strong> because he is the owner of the <strong>protected resource</strong>,<br>
which in our example is his financial transactions in chase<span>.com</span>.<br>
Other examples of resources that Johnny could have at chase<span>.com</span><br>
would be his mortgage account information and his IRA information.</li>
<li><strong>Service API</strong> We can refer to chase<span>.com</span> in our example as<br>
the <strong>Service API</strong>. Notice that it&apos;s broken down further into an<br>
<strong>Authorization Server</strong> and a <strong>Resource Server</strong>. The <strong>Authorization<br>
Server</strong> is solely responsible for authorizing the <strong>Application</strong><br>
(MyMint<span>.com</span>). The <strong>Resource Server</strong> is where the <strong>protected<br>
resources</strong> (Johnny&apos;s financial transactions) are actually stored and served.</li>
</ol>
<p>Now, let&apos;s do a high-level walk through of the six steps above using our<br>
example. Each of these will be covered in more detail later in the article.<br>
However, it&apos;s good to hold them in context as they&apos;re discussed.</p>
<ol>
<li><strong>Application requests authorization from user</strong>- Your app,<br>
MyMint<span>.com</span>, asks Johnny for authorization to access Johnny&apos;s<br>
financial transactions from chase<span>.com</span>.</li>
<li><strong>User issues Authorization Grant to Application</strong>- Johnny authorizes the<br>
MyMint<span>.com</span>, and an Authorization Grant is issued to<br>
MyMint<span>.com</span>.</li>
<li><strong>Application uses the Authorization Grant</strong>- MyMint<span>.com</span> uses<br>
the Authorization Grant to request an access token from<br>
chase<span>.com</span>&apos;s Authorization Server.</li>
<li><strong>Authorization Server issues access token to Application</strong>-<br>
chase<span>.com</span>&apos;s Authorization Server checks the authorization<br>
grant and issues an access token to MyMint<span>.com</span>. From this point<br>
on, MyMint<span>.com</span> will use that access token to communicate with<br>
chase<span>.com</span>&apos;s Resource Server.</li>
<li><strong>Access token is used</strong>- MyMint<span>.com</span> uses the access token to<br>
request Johnny&apos;s financial transactions from chase<span>.com</span>&apos;s<br>
Resource Server.</li>
<li><strong>Protected Resources are served</strong>- If chase<span>.com</span>&apos;s Resource<br>
Server is presented with a valid access token, then it sends back the<br>
resources (Johnny&apos;s financial transactions).</li>
</ol>
<h2 class="mume-header" id="getting-your-app-ready-for-oauth-20">Getting your app ready for OAuth 2.0</h2>

<p>In the high-level overview above, it seems like Johnny gave<br>
MyMint<span>.com</span> permission to access chase<span>.com</span>&apos;s<br>
resource, and chase<span>.com</span> just agreed to it. At this point, you<br>
might be wondering why chase<span>.com</span> would be willing to send<br>
MyMint<span>.com</span> protected resources. After all, how can<br>
chase<span>.com</span> trust that MyMint<span>.com</span> is actually a<br>
credible web application?</p>
<p>In reality, you would need to first register MyMint<span>.com</span> with<br>
chase<span>.com</span>&apos;s API before you are able to start requesting resources<br>
from it.</p>
<p>Specifically, you would need to provide details about your website and supply a<br>
callback URL (more on this later). Once you are registered,<br>
chase<span>.com</span> will give you a set of credentials to use during the<br>
authorization process. The credentials include:</p>
<ol>
<li><strong>client ID</strong>- public unique identifier for your web application</li>
<li><strong>client secret</strong>- a password that only your application and the API will<br>
know about. MyMint<span>.com</span> will use this when requesting resources<br>
from chase<span>.com</span>&apos;s servers.</li>
</ol>
<h2 class="mume-header" id="oauth-20-in-detail">OAuth 2.0 in detail</h2>

<p>Now that you have learned about OAuth 2.0 at a high level, as well as the<br>
prerequisites for getting your site ready for OAuth 2.0, let&apos;s discuss each step<br>
in more detail.</p>
<h3 class="mume-header" id="everything-over-https">Everything over HTTPS</h3>

<p>Note that all communication that occurs in the following sections occurs over<br>
HTTPS. This provides encrypted communications between the application and the<br>
service APIs. That way, no one can sniff the information as it goes by across<br>
the Internet, get the secret information being sent, and use it to maliciously<br>
impersonate Johnny, MyMint<span>.com</span>, or chase<span>.com</span>.</p>
<h3 class="mume-header" id="application-requests-authorization-from-user">Application requests authorization from user</h3>

<p>Let&apos;s imagine that Johnny is logged in to MyMint<span>.com</span> and now trying<br>
to add the ability to start viewing his Chase financial transactions. For<br>
simplicity&apos;s sake, let&apos;s suppose that your app, MyMint<span>.com</span>, has a<br>
link for Johnny to click when Johnny wants to add his Chase account to<br>
MyMint<span>.com</span>. This link would look something like this:</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext"><code>authorization.chase.com/?client_id=${MyMint_com_client_id}&amp;redirect_uri=${callback_url}
</code></pre><p>Let&apos;s break down the components of the URL above:</p>
<ol>
<li>authorization.chase<span>.com</span>- This URL is an example of what<br>
chase&apos;s authorization endpoint might look like.</li>
<li><code>client_id=${MyMint_com_client_id}</code>- This is<br>
MyMint<span>.com</span>&apos;s unique ID that was provided when you registered<br>
MyMint<span>.com</span> with chase<span>.com</span>&apos;s API services.<br>
chase<span>.com</span> uses this to identify your app.</li>
<li><code>redirect_uri=${callback_url}</code>- During the registration process, you also<br>
provided a <code>callback_url</code>, which is the URL that you want<br>
chase<span>.com</span> to redirect Johnny to after Johnny authorizes<br>
chase<span>.com</span> to send MyMint<span>.com</span> resources. <strong>For the<br>
purposes of our example, let&apos;s assume that you decided to use<br>
<code>https://mymint&lt;span&gt;.com&lt;/span&gt;/callback-time</code> as your app&apos;s callback URL</strong>.</li>
</ol>
<h3 class="mume-header" id="user-issues-authorization-grant">User issues authorization grant</h3>

<p>Once Johnny clicks on this link, Johnny would be directed to<br>
chase<span>.com</span>&apos;s authorization page, where he logs in directly to<br>
chase<span>.com</span> by providing his Chase username and password. Once Johnny<br>
has logged in to his chase<span>.com</span> account, chase<span>.com</span><br>
will ask Johnny whether or not he actually wants to authorize<br>
MyMint<span>.com</span> to access his Chase financial transactions data.</p>
<p>If Johnny authorizes MyMint<span>.com</span>, then Chase will issue an<br>
Authorization Grant to MyMint<span>.com</span>.</p>
<p>There are actually multiple forms of an <strong>authorization grant</strong>. For this<br>
example, the type of authorization grant that we will focus on is the<br>
<strong>authorization code</strong>. chase<span>.com</span> will send an authorization code<br>
to MyMint<span>.com</span> so that MyMint<span>.com</span> can authenticate<br>
itself. chase<span>.com</span> sends this code when it redirects the user back<br>
to the callback URL that you provided. That redirect URL for Johnny would look<br>
something like this:</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext"><code>https://mymint.com/callback-time?code=dlsie239084903j4092j340j
</code></pre><p>That random string of characters, &quot;dlsie239084903j4092j340j&quot;, that&apos;s the<br>
authorization code that chase<span>.com</span> sends to your application. These<br>
types of codes are usually only valid for a short period of time. That greatly<br>
reduces the chances of a bad actor from being able to guess a valid<br>
authentication code.</p>
<p>Note that because he is interacting directly with chase<span>.com</span>, at<br>
no point in time would Johnny ever provide his chase<span>.com</span><br>
credentials to your app, MyMint<span>.com</span>.</p>
<h3 class="mume-header" id="application-uses-the-authorization-grant">Application uses the authorization grant</h3>

<p>Now that MyMint<span>.com</span> has received an authorization code, it&apos;s ready<br>
to authenticate itself with chase<span>.com</span> so that it can start<br>
receiving Johnny&apos;s financial transaction data.</p>
<p>To do this, MyMint<span>.com</span> will send a POST request to<br>
chase<span>.com</span>&apos;s auth server using the recently provided authorization<br>
code. That post request might look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;node-fetch&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;querystring&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">&apos;POST&apos;</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&apos;content-type&apos;</span><span class="token punctuation">:</span> <span class="token string">&apos;application/x-www-form-urlencoded&apos;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    grant_type<span class="token punctuation">:</span> <span class="token string">&apos;authorization_code&apos;</span><span class="token punctuation">,</span>
    client_id<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mymint<span class="token punctuation">.</span>com_client_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    client_secret<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mymint<span class="token punctuation">.</span>com_client_secret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>authorization_code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    redirect_uri<span class="token punctuation">:</span> <span class="token string">&apos;https://mintmint.com/callback-time&apos;</span> <span class="token comment">// same callback_url you provided</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">&apos;https://authorization.chase.com/oauth/token&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Note that in the POST request above, you provided the <code>client_id</code>,<br>
<code>client_secret</code> and <code>authorization_code</code>.</p>
<h3 class="mume-header" id="authorization-server-issues-an-access-token">Authorization server issues an access token</h3>

<p>If everything is valid, then chase<span>.com</span>&apos;s auth server will send<br>
back a response that contains the access token. That response might look like<br>
this:</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJz93ak4laUWw&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GEbRxBNedjnXbL&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJ0XAi4faeEoQ&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bearer&quot;</span>
<span class="token punctuation">}</span>
</pre><p>MyMint<span>.com</span> is now authorized! Now, whenever MyMint<span>.com</span><br>
wants to request Johnny&apos;s transaction data, it would send along the<br>
<code>access_token</code> with each request.</p>
<h3 class="mume-header" id="access-token-is-used">Access token is used</h3>

<p>From this point forward, the request for Johnny&apos;s transaction data would be made<br>
to chase<span>.com</span>&apos;s resource servers. Here&apos;s an example of what that<br>
request might look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node-fetch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">&apos;https://resources.chase.com/api/johnny/transactions&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&apos;content-type&apos;</span><span class="token punctuation">:</span> <span class="token string">&apos;application/json&apos;</span><span class="token punctuation">,</span>
    <span class="token string">&apos;authorization&apos;</span><span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="protected-resources-are-served">Protected resources are served</h3>

<p>If the access_token is valid, then chase<span>.com</span> will send back the<br>
requested resources, which in this case is Johnny&apos;s financial transaction data.</p>
<h2 class="mume-header" id="what-you-learned-1">What you learned</h2>

<p>During this article, you learned about OAuth 2.0 and the interaction between<br>
your application and a server that can authenticate and authorize people&apos;s<br>
credentials. You saw that there is a six-step process to this interplay over<br>
HTTPS:</p>
<ol>
<li>Your application requests authorization from the person</li>
<li>The person informs the authorization server that they want to issue an<br>
authorization grant for your application</li>
<li>The application uses the authorization grant with its secret information to<br>
request an access token</li>
<li>The authorization server returns an access token</li>
<li>Your application uses the access token to gain access to the user&apos;s data from<br>
the service API</li>
<li>The service API returns the resource that the token allows access to</li>
</ol>
<hr>
<h1 class="mume-header" id="token-based-authentication">Token-Based Authentication</h1>

<p>Up until now, you&apos;ve been building out a todo-list API that only dealt with<br>
tasks. A todo-list app without users is not very useful, so let add some users!</p>
<p>In particular, let&apos;s set up users and a way of authenticating users so that<br>
there is an accurate way of keeping track of who tasks belong to.</p>
<p>In this lesson, you will:</p>
<ol>
<li>Understand what a JSON Web Token (JWT) is and how it can be used to securely<br>
send user information between servers or across requests.</li>
<li>Add token-based (session-less) authentication to an Express API.</li>
<li>Use the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> npm package to sign and verify JWTs.</li>
</ol>
<h2 class="mume-header" id="json-web-token-jwt">JSON Web Token (JWT)</h2>

<p>In a previous lesson, you learned about session-based authentication. With<br>
session-based authentication, when a user logs in, the server stores information<br>
about the session and sends back a session id to the client as a cookie. When<br>
the user makes a subsequent request, the cookie is presented and checked against<br>
the session data that&apos;s stored on the server side. To emphasize, with<br>
session-based authentication, data is stored on the server to keep track of<br>
sessions.</p>
<p>This presents an issue when it comes to building a RESTful API. Specifically,<br>
one of the constraints of REST is statelessness. As a reminder, the term<br>
stateless means that the data received from the server can be used by the client<br>
independently. Under the statelessness constraint, every request from the client<br>
should contain all necessary information for the server to process that request,<br>
and the server should not be storing any data about the client state.</p>
<p>What we need here is a way to identify that the user is logged in without<br>
requiring the server to store anything. JSON Web Tokens (JWTs) are perfect for<br>
these situations.</p>
<h3 class="mume-header" id="conceptual-overview-of-a-jwt-an-example">Conceptual overview of a JWT: an example</h3>

<p>So what is a JWT? Let&apos;s first gain some conceptual understanding with an<br>
example.</p>
<p>Let&apos;s say you&apos;re throwing a party. It&apos;s a gonna be a big party, and everyone<br>
wants to come, but unfortunately only people you send an invite to are allowed<br>
to come.</p>
<p>You prepare to start sending out invites, and you need to figure out a way to<br>
make sure only your invited guests are allowed into the party. One way would be<br>
to just keep a guest list, but you don&apos;t want to have to maintain a guest list.</p>
<p>So, you devise a genius way to send out tamper-proof invites. This invitation<br>
method requires:</p>
<ol>
<li><strong>the guest&apos;s email address</strong>: This is effectively a unique identifier for<br>
your guests, so for example let&apos;s say you want to invite your friend Johnny<br>
Rocket, whose email address is <code>johnny@gmail.com</code>.</li>
<li><strong>secret key/password that only you know</strong>: This is the only thing that you<br>
have to store on your end. You decide that your secret password will be<br>
&quot;ILoveDogs&quot;.</li>
<li><strong><a href="https://developer.mozilla.org/en-US/docs/Glossary/Cryptographic_hash_function">a hashing function</a></strong>: A hashing function is something that will take your<br>
guest&apos;s email and your secret password as inputs and then output a specific<br>
string digest. Keep in mind, the same input email and secret password will<br>
always produce the same output string digest. A key feature of a good hashing<br>
function is that it is not invertible. In other words, there should be no way<br>
to figure out what the inputs were based on the output string digest other<br>
than just trying to brute force your way into it.</li>
</ol>
<blockquote>
<p>Some popular hashing functions are: SHA1, MD5, SHA2, Scrypt, HS256, and<br>
Blowfish. In the first part of this article, you&apos;ll see screenshot demos that<br>
use the SHA1 hashing function. When you set up the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> library in<br>
this reading&apos;s project, you&apos;ll be using the HS256 hashing function (default<br>
algorithm of the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> library). Whenever you use BCrypt for<br>
encryption in your projects, you will use Blowfish, as it is the default<br>
hashing function used with BCrypt.</p>
</blockquote>
<p>Here&apos;s what you do (feel free to <a href="https://www.freeformatter.com/hmac-generator.html">follow along</a>). First, you take the guest&apos;s<br>
email address (<code>johnny@gmail.com</code>) and your secret password that nobody else<br>
knows (<code>ILoveDogs</code>), and you hash these two inputs with a SHA1 hashing function,<br>
which produces a string digest of <code>a94a45d3d125a25ef69775ff702406a8848633c3</code>:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/hash1.png" alt="hash"></p>
<p>You then send an email to Johnny:</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext"><code>Dear Johnny,

My party is this Friday. Present this code at the door:

&quot;johnny@gmail.com/a94a45d3d125a25ef69775ff702406a8848633c3&quot;

</code></pre><p>Now, when Johnny shows up at your party on Friday, he presents you with<br>
<code>johnny@gmail.com/a94a45d3d125a25ef69775ff702406a8848633c3</code>. You take the first<br>
part of the code that he presents, which is his email, and hash it again with<br>
your secret password. You then compare the output against the second part of the<br>
code, the string digest, that Johnny presents you with. If it&apos;s the same, then<br>
you know the invite is valid and hasn&apos;t been tampered with because the string<br>
digest couldn&apos;t have been generated without your secret key.</p>
<p>You have a frenemy named Leroy who didn&apos;t get invited. He&apos;s friends with Johnny<br>
Rocket, so he asks Johnny for the string digest, figuring that&apos;s the secret code<br>
that everyone needs to present to get in. Leroy shows up at your door and<br>
presents his own version of the code, which is just his email plus the digest<br>
that Johnny got: <code>leroy@gmail.com/a94a45d3d125a25ef69775ff702406a8848633c3</code>.</p>
<p>So you run <code>leroy@gmail.com</code> + <code>ILoveDogs</code> through your hashing function:</p>
<p><img src="images/hash2.png" alt="second hash"></p>
<p>Immediately, you know that Leroy has an invalid invite because the string digest<br>
output of the hashing function (<code>9ca5168290df6b05951af368d668ada58a56b12a</code>) was<br>
different than the one he presented.</p>
<p>This concept of validating a &quot;code&quot; against the hashed output of a value and a<br>
secret password is essentially how a JSON Web Token (JWT) works.</p>
<h3 class="mume-header" id="anatomy-of-a-jwt">Anatomy of a JWT</h3>

<p>JSON Web Token is actually an internet standard that defines how to create<br>
JSON-based access tokens.</p>
<p>A JWT is composed of three parts: the header, the payload, and the signature.</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/readings/jwt.png" alt="anatomy of a JWT"></p>
<p>If you look at the left side of the image above, you can see the typical format<br>
of a JWT. The three parts of the JWT are separated by a period. Although the JWT<br>
might seem super cryptic, the first two parts are simply <a href="https://developer.mozilla.org/en-US/docs/Glossary/Base64">base64 encoded</a>. The<br>
right side shows the base64 decoded version of the first two parts of the JWT.<br>
To clarify, base64 encoding is not an encryption mechanism. Therefore, a JWT is<br>
not encrypted by default and anyone who gains access to the token can see the<br>
contents of the payload.</p>
<p>The header describes the hashing algorithm that the JWT uses. The payload is the<br>
data being stored in the token. The signature is a hash of the header + the<br>
payload + a secret key.</p>
<p>To tie it back into our previous example, if you were to follow the JWT standard<br>
for your party invite to Johnny Rocket, it might have looked something like<br>
this:</p>
<pre data-role="codeBlock" data-info="json" class="language-json">base<span class="token number">64</span>Encode(<span class="token punctuation">{</span> <span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SHA1&quot;</span> <span class="token punctuation">}</span>) <span class="token comment">// header</span>
  .base<span class="token number">64</span>Encode(<span class="token punctuation">{</span> <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;johnny@gmail.com&quot;</span> <span class="token punctuation">}</span>) <span class="token comment">// payload</span>
  .SHA<span class="token number">1</span>HASH(header + payload + <span class="token string">&quot;ILoveDogs&quot;</span>) <span class="token comment">// signature</span>
</pre><p>Ultimately, you can use a JWT to identify that someone is logged in because you<br>
can store identifying information in the payload, and you can also verify the<br>
validity of the information. In contrast to sessions, which required storing<br>
data on the server-side, a JWT has all of the information you need.</p>
<h2 class="mume-header" id="setting-up-token-based-authentication">Setting up token-based authentication</h2>

<p>Now that you know what a JWT is, let&apos;s implement a token-based authentication<br>
flow in the todo-list app that we&apos;ve been working through in the last few<br>
readings.</p>
<h3 class="mume-header" id="create-the-users-table">Create the Users table</h3>

<p>First, create a migration to create the Users table by running: <code>npx sequelize model:generate --name User --attributes email:string,hashedPassword:string</code></p>
<p>This should create a new <code>db/migrations/[timestamp]-create-user.js</code> migration<br>
file and a new <code>db/models/user.js</code> file.</p>
<p>Update the <code>db/models/user.js</code> file so that the <code>email</code> is unique and not<br>
nullable and the <code>hashedPassword</code> is type <code>STRING.BINARY</code> and not nullable. When<br>
you&apos;re done updating the model file, it should look something like this.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
    <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      email<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      hashedPassword<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">.</span><span class="token constant">BINARY</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// associations can be defined here</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Then, update the <code>db/migrations/[timestamp]-create-user.js</code> file so that the<br>
fields and its properties matches the User model:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">up</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&quot;Users&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      email<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        unique<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      hashedPassword<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">.</span><span class="token constant">BINARY</span><span class="token punctuation">,</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        allowNull<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">down</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&quot;Users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Run <code>npx dotenv sequelize db:migrate</code>. Verify that you now have a <code>Users</code> table<br>
with the correct columns in Postbird.</p>
<h3 class="mume-header" id="users-router">Users router</h3>

<p>Next, create a new router for users at <code>routes/users.js</code>. In the users router,<br>
you&apos;ll need the <code>asyncHandler</code> and <code>handleValidationErrors</code> functions that are<br>
currently defined in <code>routes/tasks.js</code>. Go ahead and start a new <code>utils.js</code> file<br>
at the directory root, and move the <code>asyncHandler</code> function and<br>
<code>handleValidationErrors</code> function from <code>routes/tasks.js</code> into <code>utils.js</code>. This<br>
is what your <code>utils.js</code> file should look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> validationResult <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">asyncHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">handleValidationErrors</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> validationErrors <span class="token operator">=</span> <span class="token function">validationResult</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the validation errors are empty,</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validationErrors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Generate an array of error messages</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> validationErrors<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> error<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate a new `400 Bad request.` Error object</span>
    <span class="token comment">// and invoke the next function passing in `err`</span>
    <span class="token comment">// to pass control to the global error handler.</span>
    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;Bad request.&quot;</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Invoke the next middleware function</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> asyncHandler<span class="token punctuation">,</span> handleValidationErrors <span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>In <code>routes/task.js</code>, be sure to remove the original <code>asyncHandler</code> and<br>
<code>handleValidationErros</code> function definitions, and instead import them now from<br>
<code>utils.js</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">//- ./routes/tasks.js</span>

<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../db/models&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> check <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-validator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> asyncHandler<span class="token punctuation">,</span> handleValidationErrors <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// REST OF FILE NOT SHOWN</span>
</pre><p>Now that you&apos;re done with the refactor, let&apos;s build out the users router!</p>
<p>To start, create a <code>routes/users.js</code> file to hold your users router. Go ahead<br>
and declare an express router and export it:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</pre><p>Then, add this users router in your <code>app.js</code> file:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// only new code shown:</span>

<span class="token keyword">const</span> usersRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./routes/users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">,</span> usersRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>As a refresher, now all requests to a path that start with &apos;/users&apos; will be<br>
routed to the <code>usersRouter</code>.</p>
<p>Back in the users router, let&apos;s set up a route for creating users. There are a<br>
couple of things you&apos;ll need to set up. First, set up a router to handle POST<br>
requests to <a href="http://localhost:8080/users">http://localhost:8080/users</a>. Since this route handler will interact<br>
asynchronously with the database, you&apos;ll need to wrap the route handler function<br>
in the <code>asyncHandler</code> function:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> asyncHandler <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// TODO: implement creation of user</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// REST OF FILE NOT SHOWN</span>
</pre><p>Then, you&apos;ll also need to add some route-level validations to ensure that the<br>
client is passing in a valid email and password. Just like you did in the the<br>
tasks router, go ahead and use the <code>express-validator</code> library&apos;s <code>check</code><br>
function to define a series of middleware functions that will check the <code>email</code><br>
and <code>password</code> params.</p>
<p>Go ahead and define these validation middleware functions inside of a<br>
<code>validateEmailAndPassword</code> array. In a later section, you&apos;ll be implementing a<br>
&quot;log in&quot; route that will require the same <code>email</code> and <code>password</code> validations, so<br>
this array of validations can be reused for that route!</p>
<p>Here are a few things you should check for:</p>
<ol>
<li>check that <code>email</code> is a truthy value (i.e. not <code>undefined</code>, <code>null</code>, or an<br>
empty string)</li>
<li>check that <code>email</code> is a valid email.</li>
<li>check that <code>password</code> is a truthy value.</li>
</ol>
<p>Feel free to add more validations, like ensuring that the password has a digit<br>
in it, but make sure that you at least have the following validations:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> validateEmailAndPassword <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Please provide a valid email.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Please provide a password.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre><p>Back in the tasks router, you used the <code>handleValidationErrors</code> function to<br>
handle any validation errors that <code>express-validator</code> found. Import that<br>
<code>handleValidationErrors</code> function from the <code>utils.js</code> file now so that you can<br>
also handle validation errors in the users router. You have a couple of options<br>
here on how to set this up. You can either pass in both<br>
<code>validateEmailAndPassword</code> and <code>handleValidationErrors</code> as middleware functions<br>
in <code>router.post(&quot;/&quot;)</code> (like you did in the tasks router), or you could simply<br>
add <code>handleValidationErrors</code> as the last entry in <code>validateEmailAndPassword</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> validateEmailAndPassword <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Please provide a valid email.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">{</span> checkFalsy<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Please provide a password.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  handleValidationErrors<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre><p>Regardless of which option you choose, go ahead and add those validations to<br>
<code>router.post(&quot;/&quot;)</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  validateEmailAndPassword<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: handle user creation</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now that validations are taken care of, let&apos;s actually implement the user<br>
creation!</p>
<p>The first part of creating a user will be fairly similar to what you were doing<br>
back in the session-based authentication lesson. You want to hash the password<br>
so that you can store it in the <code>hashedPassword</code> column, and you&apos;ll be using the<br>
<a href="https://www.npmjs.com/package/bcryptjs">bcryptjs</a> library again to do the hashing. Go ahead and run <code>npm install bcryptjs</code>.</p>
<p>Then, use the library to hash your password before using the <code>User</code> model to<br>
create your new user:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;bcryptjs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../db/models&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token operator">=</span> db<span class="token punctuation">;</span>

<span class="token comment">// REST OF FILE IN BETWEEN NOT SHOWN</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  validateEmailAndPassword<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> hashedPassword <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// TODO: implement rest of route handler</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>At this point, you&apos;ve set up a route that creates a user. The next section will<br>
cover how to generate an access token for the user so that the user can be<br>
&quot;logged in&quot; for subsequent requests.</p>
<h3 class="mume-header" id="generate-an-access-token-for-the-client">Generate an access token for the client</h3>

<p>Let&apos;s finish up the rest of the route handler for <code>router.post(&quot;/&quot;)</code> in the<br>
users router!</p>
<p>Back in the previous lesson when you were implementing session-based<br>
authentication, you &quot;logged in&quot; a user by storing the new user&apos;s id in session<br>
and then storing the session id as a cookie on the client side.</p>
<p>With token-based authentication, you&apos;ll now instead generate an access token<br>
that holds identifying information in its payload, such as user id and email.<br>
Then, you&apos;ll return this token to the client, and the client will include this<br>
token in all subsequent requests.</p>
<p>The access token will be a JWT, and you&apos;ll use the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> package to<br>
handle JWT generation and decoding. Go ahead and run <code>npm install jsonwebtoken</code>.</p>
<p>Here&apos;s the game plan for generating this token:</p>
<ol>
<li>First, let&apos;s add all of the components that are necessary for generating a<br>
JWT.</li>
<li>Then, let&apos;s set up a new <code>auth.js</code> file that will have a set of utility<br>
functions that handles authentication-related logic.</li>
</ol>
<p>Let&apos;s start with adding all the components that are necessary for generating a<br>
JWT!</p>
<p>As a refresher, a JWT has three parts: the header, the payload, and the<br>
signature.</p>
<p>The header describes the algorithm that will be used for hashing. By default the<br>
<a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> library uses the <code>HS256</code> algorithm by default.</p>
<p>The payload holds identifying information about the user. You&apos;ll be storing the<br>
user id and email in the payload. There&apos;s one more piece that&apos;s necessary in the<br>
payload. Specifically, you probably don&apos;t want a JWT to be valid forever, as<br>
this would increase the risk of your application&apos;s security being compromised.</p>
<p>Instead, you want to expire these tokens after a certain amount of time. To do<br>
this, you can pass an <code>expiresIn</code> option to the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> token generation<br>
method. That method will take care of then including a field in the payload that<br>
notates how long the token is valid for. Then, when the JWT is later being<br>
decoded, that expiration timestamp can be checked to determine whether or not<br>
the token is still valid.</p>
<p>Finally, the third part of the JWT is the signature. The signature is the output<br>
of hashing the header, the payload, and the secret key, so you&apos;ll need to set up<br>
a secret key.</p>
<p>To recap, there are two components you need to set up: a secret key and the<br>
duration that a JWT should be valid for.</p>
<p>Let&apos;s store both of those components in environment variables.</p>
<p>To do this, first generate a secret key by opening up a node repl in your<br>
terminal (run <code>node</code>). In the node repl, use the built-in <code>crypto</code> module to<br>
generate a random string by running the following:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;crypto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Then add the following fields to your <code>.env</code>:</p>
<pre data-role="codeBlock" data-info="yml" class="language-yaml">JWT_SECRET=&lt;&lt;YOUR GENERATED RANDOM STRING<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span>
JWT_EXPIRES_IN=604800
</pre><p>&quot;604800&quot; was set as the <code>JWT_EXPIRES_IN</code> value because there are 604800 seconds<br>
in a week.</p>
<p>Next, set up your &apos;config/index.js&apos; so that those newly added environment<br>
variables are accessible in your app:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  environment<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8080</span><span class="token punctuation">,</span>
  db<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_USERNAME</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_PASSWORD</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_DATABASE</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DB_HOST</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  jwtConfig<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    secret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">,</span>
    expiresIn<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_EXPIRES_IN</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Finally, let&apos;s create an <code>auth.js</code> file and declare a <code>getUserToken</code> function<br>
that will generate an access token for the user. In this function, take in the<br>
user object as a parameter. Then, use the <code>jsonwebtoken</code> library to generate a<br>
JWT:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> jwtConfig <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> secret<span class="token punctuation">,</span> expiresIn <span class="token punctuation">}</span> <span class="token operator">=</span> jwtConfig<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUserToken</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Don&apos;t store the user&apos;s hashed password</span>
  <span class="token comment">// in the token data.</span>
  <span class="token keyword">const</span> userDataForToken <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create the token.</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> data<span class="token punctuation">:</span> userDataForToken <span class="token punctuation">}</span><span class="token punctuation">,</span>
    secret<span class="token punctuation">,</span>
    <span class="token punctuation">{</span> expiresIn<span class="token punctuation">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>expiresIn<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// 604,800 seconds = 1 week</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> getUserToken <span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>To recap, in the code snippet above, the <code>jwt.sign</code> method&apos;s first argument is<br>
the payload. The second argument is the secret key used to sign the JWT, and the<br>
third argument is an <code>options</code> object that you can use to customize the JWT.<br>
Notice how we also had to convert <code>expiresIn</code> from a string to an integer. This<br>
is because environment variables declared in the <code>.env</code> file are strings, and<br>
according to the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> docs, anything that gets set to the <code>expiresIn</code><br>
as an <strong>integer</strong> will be calculated as <strong>seconds</strong>, and <strong>strings</strong> will be<br>
calculated in <strong>milliseconds</strong>.</p>
<p>Let&apos;s go back to the users router to finish generating an access token for the<br>
client. In the <code>router.post(&quot;/&quot;)</code> route handler, after the user has been<br>
created, use the <code>getUserToken</code> function to generate the JWT. Then, set it in<br>
the body of the response:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> getUserToken <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// REST OF FILE NOT SHOWN</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
  validateEmailAndPassword<span class="token punctuation">,</span>
  <span class="token function">asyncHandler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> hashedPassword <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">getUserToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span>
      token<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Finally, go to Postman and make a POST request to <code>http://localhost:8080/users</code><br>
with the correct params in order to create a user. Verify that you are able to<br>
get the <code>token</code> in the response body.</p>
<h3 class="mume-header" id="using-the-access-token">Using the access token</h3>

<p>Let&apos;s put the access token to use by protecting the tasks resource. In order to<br>
protect the tasks routes, let&apos;s set it up so that the request must contain a<br>
valid, unexpired JWT that identifies a signed up user. This means that the<br>
client will now be required to include a valid access token in the header of<br>
the request if they want to access the tasks routes.</p>
<p>In the server, you&apos;ll need to then set up a couple of functions that will parse<br>
the access token from the header of the request, verify that it is a valid JWT,<br>
and then find the user based on the identifying data, such as the user id and<br>
email, in the payload.</p>
<p>Let&apos;s go to the <code>auth.js</code> file to set this up! First, in order to parse the<br>
access token from the request header, install the <a href="https://www.npmjs.com/package/express-bearer-token">express-bearer-token</a> npm<br>
package by running <code>npm install express-bearer-token</code>. This package provides a<br>
middleware function that will automatically look in the header under the<br>
<code>Authorization</code> key for a token, parse it out, and then set the token as a field<br>
in the <code>req</code> object. Specifically, it expects for the header to be formatted<br>
like: <code>Authorization: Bearer &lt;token&gt;</code>, which is a standard format for setting<br>
access tokens in the request header.</p>
<p>Next, now that the token has been parsed out, you need to set up a middleware<br>
function that will verify the validity of the JWT. Once it&apos;s been verified, you<br>
can take the decoded payload and then use the identifying information to search<br>
for the user in the database. Once a user has been found, set it as a field in<br>
the <code>req</code> object so that subsequent middleware functions have access to it. If<br>
any steps fail along the way, then throw an error and return a 401 Unauthorized<br>
status. This is what that function should look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">restoreUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// token being parsed from request header by the bearerToken middleware</span>
  <span class="token comment">// function in app.js:</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Unauthorized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> jwtPayload</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> jwtPayload<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Send a &quot;401 Unauthorized&quot; response status code</span>
      <span class="token comment">// along with an &quot;WWW-Authenticate&quot; header value of &quot;Bearer&quot;.</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;WWW-Authenticate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Make sure to use import the <code>User</code> model at the top of the file as well.</p>
<p>Now that you&apos;ve got both the <a href="https://www.npmjs.com/package/express-bearer-token">express-bearer-token</a> middleware function and the<br>
<code>restoreUser</code> function, go ahead and export both of those functions together in<br>
an array called <code>requireAuth</code>. This array of middleware functions can then be<br>
passed in to any routes or routers that you want to protect. This is what that<br>
should look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> bearerToken <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-bearer-token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// OTHER CODE IN THE FILE NOT SHOWN</span>

<span class="token keyword">const</span> requireAuth <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">bearerToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> restoreUser<span class="token punctuation">]</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> getUserToken<span class="token punctuation">,</span> requireAuth <span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Finally, let&apos;s put this array of middleware functions to use by going to the<br>
tasks router and adding it as a middleware function (before any of the route<br>
definitions) for all routes in this router:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> requireAuth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// REST OF FILE NOT SHOWN</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>requireAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ROUTE DEFINITIONS NOT SHOWN</span>
</pre><p>At this point, go ahead and go to Postman to try to make a request for all tasks<br>
(<code>GET http://localhost:8080/tasks</code>). This should fail with a 401 response.</p>
<p>To fix this, use the <code>POST http://localhost:8080/users</code> endpoint to create<br>
another user. This time, take the <code>token</code> that&apos;s in the response body. Use that<br>
<code>token</code> value in the <code>Authorization</code> header:</p>
<p><img src="https://appacademy-open-assets.s3-us-west-1.amazonaws.com/Module-Express/projects/api-tweets-project-postman-jwt-token-2.png" alt="Authorization header"></p>
<p>Then, make another request for all tasks, and this time, since the client is<br>
authenticated, getting all of the tasks works!</p>
<h3 class="mume-header" id="where-to-store-the-access-token-on-the-client-side">Where to store the access token on the client-side</h3>

<p>In the project that you&apos;ll be working on today, you&apos;ll be building out a<br>
frontend app that allows users to sign up and log in, and the response to these<br>
two types of requests would include the access token.</p>
<p>Once the client receives this access token, it needs to store it somewhere so<br>
that it can be included with all subsequent requests. In the previous lesson on<br>
session-based auth, the session id was stored in a cookie.</p>
<p>One popular place to store access tokens nowadays is by using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">Web Storage<br>
API</a>. The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">Web Storage API</a>, implemented by browsers, exposes two place to store<br>
data on the client side: <code>localStorage</code> and <code>sessionStorage</code>.</p>
<blockquote>
<p><code>localStorage</code> stores data without an expiration date. <code>sessionStorage</code> stores<br>
data until the browser or the tab is closed.</p>
</blockquote>
<p>In choosing between cookies and something like <code>localStorage</code>, the upside of<br>
<code>localStorage</code> is that it&apos;s very simple to use. With <code>cookies</code> there are very<br>
specific configurations that must be set on both the server and the client in<br>
order to allow for it to work in a cross-domain setting.</p>
<p>On the other hand, data stored in <code>localStorage</code> is retrievable by client-side<br>
JavaScript, so if your application does not take the necessary measures against<br>
Cross-Site Scripting (XSS), then the access tokens stored in <code>localStorage</code><br>
could be stolen. You&apos;ll learn more about XSS in a later lesson.</p>
<p>For tomorrow&apos;s project, you&apos;ll be using <code>localStorage</code> to store the access<br>
token, and again, it is a fairly popular way to store access tokens. At the same<br>
time, it&apos;s definitely useful to know what options are available and the pros and<br>
cons of each option.</p>
<h2 class="mume-header" id="what-youve-learned-2">What you&apos;ve learned</h2>

<p>In this lesson, you learned:</p>
<ol>
<li>What a JSON Web Token (JWT) is and how it can be used to securely send user<br>
information between servers or across requests.</li>
<li>How to add token-based (session-less) authentication to an Express API.</li>
<li>How to use the <a href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a> npm package to sign and verify JWTs.</li>
</ol>

      </div>
      <div class="md-sidebar-toc"><ul>
<li><a href="#your-first-group-project">Your First Group Project</a>
<ul>
<li><a href="#the-groundwork">The groundwork</a></li>
<li><a href="#choosing-a-project">Choosing a Project</a></li>
<li><a href="#the-feature-list">The feature list</a></li>
<li><a href="#feature-scoping">Feature scoping</a></li>
<li><a href="#feature-packets">Feature packets</a></li>
<li><a href="#code-code-code">Code, code, code!</a></li>
<li><a href="#evaluating-your-completion">Evaluating your completion</a></li>
<li><a href="#show-and-tell">Show and tell</a></li>
<li><a href="#required-features-for-approved-clones">Required Features for Approved Clones</a>
<ul>
<li><a href="#bandcamp">Bandcamp</a></li>
<li><a href="#goodreads">Goodreads</a></li>
<li><a href="#medium">Medium</a></li>
<li><a href="#product-hunt">Product Hunt</a></li>
<li><a href="#quora">Quora</a></li>
<li><a href="#remember-the-milk">Remember the Milk</a></li>
<li><a href="#stack-overflow">Stack Overflow</a></li>
<li><a href="#teawithstrangers">TeaWithStrangers</a></li>
<li><a href="#yelp">Yelp</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#setting-up-your-groups-project-repository">Setting Up Your Group&apos;s Project Repository</a>
<ul>
<li><a href="#create-a-new-repository">Create a new repository</a></li>
<li><a href="#give-access-to-your-teammates">Give access to your teammates</a></li>
</ul>
</li>
<li><a href="#authentication-learning-objectives">Authentication Learning Objectives</a></li>
<li><a href="#using-bcrypt-to-hash-passwords">Using Bcrypt to Hash Passwords</a>
<ul>
<li><a href="#what-is-cryptography">What is cryptography?</a>
<ul>
<li><a href="#what-is-encryption">What is encryption?</a></li>
<li><a href="#how-does-encryption-work">How does encryption work?</a></li>
<li><a href="#when-is-it-appropriate-to-use-encryption">When is it appropriate to use encryption?</a></li>
</ul>
</li>
<li><a href="#what-is-hashing">What is hashing?</a>
<ul>
<li><a href="#how-does-hashing-work">How does hashing work?</a></li>
<li><a href="#what-is-a-salt">What is a &quot;salt&quot;?</a></li>
<li><a href="#when-is-it-appropriate-to-use-hashing">When is it appropriate to use hashing?</a></li>
</ul>
</li>
<li><a href="#using-bcrypt-to-hash-user-passwords">Using Bcrypt to hash user passwords</a></li>
</ul>
</li>
<li><a href="#configuring-sessions-in-express">Configuring Sessions in Express</a>
<ul>
<li><a href="#overview-of-sessions">Overview of sessions</a>
<ul>
<li><a href="#what-are-sessions">What are sessions?</a></li>
<li><a href="#why-are-sessions-useful">Why are sessions useful?</a></li>
<li><a href="#what-are-the-drawbacks">What are the drawbacks?</a></li>
</ul>
</li>
<li><a href="#configuring-express-to-use-sessions">Configuring Express to use sessions</a>
<ul>
<li><a href="#installing-and-configuring-express-session">Installing and configuring <code>express-session</code></a></li>
<li><a href="#configuration-options">Configuration options</a></li>
<li><a href="#testing">Testing</a></li>
</ul>
</li>
<li><a href="#setting-and-accessing-session-values">Setting and accessing session values</a></li>
<li><a href="#session-store-configuration">Session store configuration</a></li>
<li><a href="#securing-the-session-http-cookie">Securing the session HTTP cookie</a>
<ul>
<li><a href="#additional-session-configuration-cookie-options">Additional session configuration cookie options</a></li>
</ul>
</li>
<li><a href="#what-you-have-learned">What you have learned</a></li>
</ul>
</li>
<li><a href="#implementing-session-based-authentication">Implementing Session-Based Authentication</a>
<ul>
<li><a href="#overview-of-authentication-and-authorization">Overview of authentication and authorization</a>
<ul>
<li><a href="#what-is-authentication">What is authentication?</a></li>
<li><a href="#authentication-process">Authentication process</a></li>
<li><a href="#what-is-authorization">What is authorization?</a></li>
</ul>
</li>
<li><a href="#supporting-user-self-registration">Supporting user self-registration</a>
<ul>
<li><a href="#getting-the-starter-project">Getting the starter project</a></li>
<li><a href="#creating-the-user-model">Creating the User model</a></li>
<li><a href="#adding-the-user-registration-form">Adding the user registration form</a></li>
<li><a href="#validating-the-user-registration-form">Validating the user registration form</a></li>
<li><a href="#hashing-user-passwords">Hashing user passwords</a></li>
<li><a href="#adding-the-user-routes-to-the-app-module">Adding the user routes to the <code>app</code> module</a></li>
<li><a href="#testing-user-registration">Testing user registration</a></li>
</ul>
</li>
<li><a href="#supporting-user-login">Supporting user login</a>
<ul>
<li><a href="#adding-the-user-login-form">Adding the user login form</a></li>
<li><a href="#implementing-the-user-login-process">Implementing the user login process</a></li>
<li><a href="#improving-the-user-navigation">Improving the user navigation</a></li>
<li><a href="#testing-user-login">Testing user login</a></li>
</ul>
</li>
<li><a href="#persisting-user-login-state">Persisting user login state</a>
<ul>
<li><a href="#configuring-express-to-use-sessions-1">Configuring Express to use sessions</a></li>
<li><a href="#using-sessions-to-persist-a-users-login-state">Using sessions to persist a user&apos;s login state</a></li>
<li><a href="#testing-user-login-state-persistence">Testing user login state persistence</a></li>
</ul>
</li>
<li><a href="#restoring-the-authenticated-user-from-session">Restoring the authenticated user from session</a>
<ul>
<li><a href="#displaying-the-users-login-state">Displaying the user&apos;s login state</a></li>
<li><a href="#implementing-user-logout">Implementing user logout</a></li>
<li><a href="#testing-the-latest-changes">Testing the latest changes</a></li>
</ul>
</li>
<li><a href="#protecting-a-route">Protecting a route</a>
<ul>
<li><a href="#defining-a-middleware-function-to-require-an-authenticated-user">Defining a middleware function to require an authenticated user</a></li>
</ul>
</li>
<li><a href="#associating-data-with-a-user">Associating data with a user</a>
<ul>
<li><a href="#defining-an-association">Defining an association</a></li>
<li><a href="#updating-the-seed-data">Updating the seed data</a></li>
<li><a href="#updating-the-book-related-routes">Updating the book related routes</a></li>
<li><a href="#testing-one-more-time">Testing one more time</a></li>
</ul>
</li>
<li><a href="#the-importance-of-using-https">The importance of using HTTPS</a></li>
<li><a href="#next-steps">Next steps</a></li>
</ul>
</li>
<li><a href="#project-amusement-park-tracker-with-authentication">Project: Amusement Park Tracker with Authentication</a>
<ul>
<li><a href="#phase-0-download-the-starter-project">Phase 0: Download the starter project</a></li>
<li><a href="#phase-1-create-the-user-model">Phase 1: Create the User model</a></li>
<li><a href="#phase-2-configure-express-to-use-sessions">Phase 2: Configure Express to use sessions</a></li>
<li><a href="#phase-3-support-user-self-registration">Phase 3: Support user self-registration</a>
<ul>
<li><a href="#regex-reminders">Regex Reminders</a></li>
</ul>
</li>
<li><a href="#phase-4-support-user-login">Phase 4: Support user login</a>
<ul>
<li><a href="#testing-user-login-1">Testing user login</a></li>
</ul>
</li>
<li><a href="#phase-5-persist-user-login-state">Phase 5: Persist user login state</a>
<ul>
<li><a href="#using-sessions-to-persist-a-users-login-state-1">Using sessions to persist a user&apos;s login state</a></li>
<li><a href="#testing-user-login-state-persistence-1">Testing user login state persistence</a></li>
</ul>
</li>
<li><a href="#phase-6-restore-the-authenticated-user-from-session">Phase 6: Restore the authenticated user from session</a></li>
<li><a href="#phase-7-display-the-users-login-state">Phase 7: Display the user&apos;s login state</a></li>
<li><a href="#phase-8-implement-user-logout">Phase 8: Implement user logout</a>
<ul>
<li><a href="#testing-the-latest-changes-1">Testing the latest changes</a></li>
</ul>
</li>
<li><a href="#phase-9-support-user-attraction-visits">Phase 9: Support user attraction visits</a>
<ul>
<li><a href="#create-the-attractionvisit-model">Create the AttractionVisit model</a></li>
<li><a href="#update-the-attraction-detail-page">Update the Attraction Detail page</a></li>
<li><a href="#add-the-add-visit-page">Add the Add Visit page</a></li>
<li><a href="#require-a-logged-in-user">Require a logged in user</a></li>
</ul>
</li>
<li><a href="#bonus-phase-1-adding-the-edit-visit-and-delete-visit-pages">Bonus Phase 1: Adding the Edit Visit and Delete Visit pages</a></li>
<li><a href="#bonus-phase-2-locking-down-parks-and-attractions">Bonus Phase 2: Locking down parks and attractions</a></li>
</ul>
</li>
<li><a href="#application-programming-interfaces-learning-objectives">Application Programming Interfaces Learning Objectives</a></li>
<li><a href="#getting-started-with-restful-endpoints">Getting Started With RESTful Endpoints</a>
<ul>
<li><a href="#rules-of-rest">Rules of ReST</a></li>
<li><a href="#what-does-a-restful-api-look-like">What does a RESTful API look like?</a>
<ul>
<li><a href="#urls">URLs</a></li>
<li><a href="#ajax-urls-and-http-verbs">AJAX URLs and HTTP verbs</a></li>
<li><a href="#html-urls-and-http-verbs">HTML URLs and HTTP verbs</a></li>
</ul>
</li>
<li><a href="#designing-your-api">Designing your API</a></li>
<li><a href="#github-api-example">GitHub API example</a></li>
<li><a href="#restful-vs-remote-procedure-calls-rpc">RESTful vs remote procedure calls (RPC)</a>
<ul>
<li><a href="#a-remote-procedure-call">A remote procedure call</a></li>
<li><a href="#which-is-better-rest-or-rpc">Which is better? ReST or RPC?</a></li>
</ul>
</li>
<li><a href="#what-you-learned">What you learned</a></li>
</ul>
</li>
<li><a href="#express-apis">Express APIs</a>
<ul>
<li><a href="#project-setup">Project setup</a>
<ul>
<li><a href="#initializing-sequelize">Initializing Sequelize</a></li>
<li><a href="#creating-the-database">Creating the database</a></li>
<li><a href="#connecting-sequelize-to-your-database">Connecting Sequelize to your database</a></li>
</ul>
</li>
<li><a href="#set-up-the-task-model">Set up the Task model</a></li>
<li><a href="#initial-router-setup">Initial router setup</a></li>
<li><a href="#global-error-handling">Global error handling</a></li>
<li><a href="#reading-all-tasks">Reading all tasks</a></li>
<li><a href="#create-a-task">Create a task</a>
<ul>
<li><a href="#validate-data">Validate data</a></li>
</ul>
</li>
<li><a href="#read-a-task">Read a task</a></li>
<li><a href="#update-a-task">Update a task</a></li>
<li><a href="#delete-a-task">Delete a task</a></li>
<li><a href="#what-youve-learned">What you&apos;ve learned</a></li>
</ul>
</li>
<li><a href="#cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</a>
<ul>
<li><a href="#why-cors">Why CORS</a>
<ul>
<li><a href="#demo-project-setup">Demo project setup</a></li>
<li><a href="#attempting-to-fetch-all-tasks">Attempting to fetch all tasks</a></li>
<li><a href="#cors">CORS</a></li>
</ul>
</li>
<li><a href="#setting-up-cors">Setting up CORS</a>
<ul>
<li><a href="#setting-up-cors-to-fetch-all-tasks">Setting up CORS to fetch all tasks</a></li>
<li><a href="#attempt-to-create-a-task">Attempt to create a task</a></li>
</ul>
</li>
<li><a href="#preflighted-requests">Preflighted requests</a></li>
<li><a href="#setting-up-cors-for-the-entire-api">Setting up CORS for the entire API</a></li>
<li><a href="#what-youve-learned-1">What you&apos;ve learned</a></li>
</ul>
</li>
<li><a href="#twitter-lite-project">Twitter Lite Project</a>
<ul>
<li><a href="#phase-0-initialize-project">Phase 0: Initialize project</a>
<ul>
<li><a href="#initializing-sequelize-1">Initializing Sequelize</a></li>
<li><a href="#configuring-your-environment-variables">Configuring your environment variables</a></li>
<li><a href="#creating-your-database">Creating your database</a></li>
</ul>
</li>
<li><a href="#phase-1-set-up-the-tweet-model">Phase 1: Set up the Tweet model</a></li>
<li><a href="#phase-2-set-up-test-routes">Phase 2: Set up test routes</a>
<ul>
<li><a href="#creating-test-routes">Creating test routes</a></li>
<li><a href="#testing-requests-on-postman">Testing requests on Postman</a></li>
</ul>
</li>
<li><a href="#phase-3-set-up-tweet-routes">Phase 3: Set up tweet routes</a>
<ul>
<li><a href="#get-tweets">GET /tweets</a></li>
<li><a href="#get-tweetsid">GET /tweets/:id</a></li>
<li><a href="#post-tweets">POST /tweets</a></li>
<li><a href="#put-tweetsid">PUT /tweets/:id</a></li>
<li><a href="#delete-tweetsid">DELETE /tweets/:id</a></li>
</ul>
</li>
<li><a href="#phase-4-render-tweets-in-the-frontend-application">Phase 4: Render tweets in the frontend application</a></li>
<li><a href="#phase-5-add-the-users-model">Phase 5: Add the users model</a></li>
</ul>
</li>
<li><a href="#twitter-lite-project-with-authentication">Twitter Lite Project... with Authentication!</a>
<ul>
<li><a href="#phase-1-users-router">Phase 1: Users router</a></li>
<li><a href="#phase-2-protecting-the-tweets-resources">Phase 2: Protecting the tweets resources</a></li>
<li><a href="#phase-3-sign-up-for-user-account-from-the-client">Phase 3: Sign up for user account from the client</a></li>
<li><a href="#phase-4-setting-up-the-log-in-flow">Phase 4: Setting up the log-in flow</a></li>
<li><a href="#phase-5-creating-tweets-from-the-frontend-application">Phase 5: Creating tweets from the frontend application</a></li>
<li><a href="#phase-6-seeing-tweets-with-authors-and-creating-tweets-from-the-client">Phase 6: Seeing tweets with authors and creating tweets from the client</a></li>
<li><a href="#phase-7-set-up-the-profile-page">Phase 7: Set up the profile page</a></li>
<li><a href="#bonus-phase-add-ability-to-delete-your-own-tweet">Bonus Phase: Add ability to delete your own tweet</a></li>
<li><a href="#bonus-phase-combine-create-and-index-views">Bonus Phase: Combine create and index views</a></li>
<li><a href="#bonus-phase-es-modules">Bonus Phase: ES Modules</a></li>
</ul>
</li>
<li><a href="#api-security-learning-objectives">API Security Learning Objectives</a></li>
<li><a href="#oauth-20">OAuth 2.0</a>
<ul>
<li><a href="#high-level-overview-of-oauth-20">High level overview of OAuth 2.0</a></li>
<li><a href="#getting-your-app-ready-for-oauth-20">Getting your app ready for OAuth 2.0</a></li>
<li><a href="#oauth-20-in-detail">OAuth 2.0 in detail</a>
<ul>
<li><a href="#everything-over-https">Everything over HTTPS</a></li>
<li><a href="#application-requests-authorization-from-user">Application requests authorization from user</a></li>
<li><a href="#user-issues-authorization-grant">User issues authorization grant</a></li>
<li><a href="#application-uses-the-authorization-grant">Application uses the authorization grant</a></li>
<li><a href="#authorization-server-issues-an-access-token">Authorization server issues an access token</a></li>
<li><a href="#access-token-is-used">Access token is used</a></li>
<li><a href="#protected-resources-are-served">Protected resources are served</a></li>
</ul>
</li>
<li><a href="#what-you-learned-1">What you learned</a></li>
</ul>
</li>
<li><a href="#token-based-authentication">Token-Based Authentication</a>
<ul>
<li><a href="#json-web-token-jwt">JSON Web Token (JWT)</a>
<ul>
<li><a href="#conceptual-overview-of-a-jwt-an-example">Conceptual overview of a JWT: an example</a></li>
<li><a href="#anatomy-of-a-jwt">Anatomy of a JWT</a></li>
</ul>
</li>
<li><a href="#setting-up-token-based-authentication">Setting up token-based authentication</a>
<ul>
<li><a href="#create-the-users-table">Create the Users table</a></li>
<li><a href="#users-router">Users router</a></li>
<li><a href="#generate-an-access-token-for-the-client">Generate an access token for the client</a></li>
<li><a href="#using-the-access-token">Using the access token</a></li>
<li><a href="#where-to-store-the-access-token-on-the-client-side">Where to store the access token on the client-side</a></li>
</ul>
</li>
<li><a href="#what-youve-learned-2">What you&apos;ve learned</a></li>
</ul>
</li>
</ul>
</div>
      <a id="sidebar-toc-btn">&#x2261;</a>
    
    
    
    
    
    
    
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  
    </body></html>