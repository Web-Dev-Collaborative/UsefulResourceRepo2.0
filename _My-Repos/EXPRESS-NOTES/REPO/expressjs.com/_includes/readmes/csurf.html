<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>csurf</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
  </head>
  <body>
    <h1 id="csurf">csurf</h1>
    <p>
      <a href="https://npmjs.org/package/csurf"
        ><img src="https://badgen.net/npm/v/csurf" alt="NPM Version"
      /></a>
      <a href="https://nodejs.org/en/download"
        ><img src="https://badgen.net/npm/dm/csurf" alt="NPM Downloads"
      /></a>
      <a href="https://travis-ci.org/expressjs/csurf"
        ><img
          src="https://badgen.net/travis/expressjs/csurf/master"
          alt="Build status"
      /></a>
      <a href="https://coveralls.io/r/expressjs/csurf?branch=master"
        ><img
          src="https://badgen.net/coveralls/c/github/expressjs/csurf/master"
          alt="Test coverage"
      /></a>
    </p>
    <p>
      Node.js
      <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery"
        >CSRF</a
      >
      protection middleware.
    </p>
    <p>
      Requires either a session middleware or
      <a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a> to
      be initialized first.
    </p>
    <ul>
      <li>
        If you are setting the <a href="#cookie">“cookie” option</a> to a
        non-<code>false</code> value, then you must use
        <a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a>
        before this module.
      </li>
      <li>
        Otherwise, you must use a session middleware before this module. For
        example:
        <ul>
          <li>
            <a href="https://www.npmjs.com/package/express-session"
              >express-session</a
            >
          </li>
          <li>
            <a href="https://www.npmjs.com/package/cookie-session"
              >cookie-session</a
            >
          </li>
        </ul>
      </li>
    </ul>
    <p>
      If you have questions on how this module is implemented, please read
      <a href="https://github.com/pillarjs/understanding-csrf"
        >Understanding CSRF</a
      >.
    </p>
    <h2 id="installation">Installation</h2>
    <p>
      This is a <a href="https://nodejs.org/en/">Node.js</a> module available
      through the <a href="https://www.npmjs.com/">npm registry</a>.
      Installation is done using the
      <a
        href="https://docs.npmjs.com/getting-started/installing-npm-packages-locally"
        ><code>npm install</code> command</a
      >:
    </p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode sh"
      ><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1">$ <span class="ex">npm</span> install csurf</a></code></pre>
    </div>
    <h2 id="api">API</h2>
    <!-- eslint-disable no-unused-vars -->
    <div class="sourceCode" id="cb2">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">var</span> csurf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)</a></code></pre>
    </div>
    <h3 id="csurfoptions">csurf(<a href="#options">options</a>)</h3>
    <p>
      Create a middleware for CSRF token creation and validation. This
      middleware adds a <code>req.csrfToken()</code> function to make a token
      which should be added to requests which mutate state, within a hidden form
      field, query-string etc. This token is validated against the visitor’s
      session or csrf cookie.
    </p>
    <h4 id="options">Options</h4>
    <p>
      The <code>csurf</code> function takes an optional
      <code>options</code> object that may contain any of the following keys:
    </p>
    <h5 id="cookie">cookie</h5>
    <p>
      Determines if the token secret for the user should be stored in a cookie
      or in <code>req.session</code>. Storing the token secret in a cookie
      implements the
      <a
        href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie"
        >double submit cookie pattern</a
      >. Defaults to <code>false</code>.
    </p>
    <p>
      When set to <code>true</code> (or an object of options for the cookie),
      then the module changes behavior and no longer uses
      <code>req.session</code>. This means you
      <em>are no longer required to use a session middleware</em>. Instead, you
      do need to use the
      <a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a>
      middleware in your app before this middleware.
    </p>
    <p>
      When set to an object, cookie storage of the secret is enabled and the
      object contains options for this functionality (when set to
      <code>true</code>, the defaults for the options are used). The options may
      contain any of the following keys:
    </p>
    <ul>
      <li>
        <code>key</code> - the name of the cookie to use to store the token
        secret (defaults to <code>'_csrf'</code>).
      </li>
      <li>
        <code>path</code> - the path of the cookie (defaults to
        <code>'/'</code>).
      </li>
      <li>
        <code>signed</code> - indicates if the cookie should be signed (defaults
        to <code>false</code>).
      </li>
      <li>
        <code>secure</code> - marks the cookie to be used with HTTPS only
        (defaults to <code>false</code>).
      </li>
      <li>
        <code>maxAge</code> - the number of seconds after which the cookie will
        expire (defaults to session length).
      </li>
      <li>
        <code>httpOnly</code> - flags the cookie to be accessible only by the
        web server (defaults to <code>false</code>).
      </li>
      <li>
        <code>sameSite</code> - sets the same site policy for the
        cookie(defaults to <code>false</code>). This can be set to
        <code>'strict'</code>, <code>'lax'</code>, <code>'none'</code>, or
        <code>true</code> (which maps to <code>'strict'</code>).
      </li>
      <li>
        <code>domain</code> - sets the domain the cookie is valid on(defaults to
        current domain).
      </li>
    </ul>
    <h5 id="ignoremethods">ignoreMethods</h5>
    <p>
      An array of the methods for which CSRF token checking will disabled.
      Defaults to <code>['GET', 'HEAD', 'OPTIONS']</code>.
    </p>
    <h5 id="sessionkey">sessionKey</h5>
    <p>
      Determines what property (“key”) on <code>req</code> the session object is
      located. Defaults to <code>'session'</code> (i.e. looks at
      <code>req.session</code>). The CSRF secret from this library is stored and
      read as <code>req[sessionKey].csrfSecret</code>.
    </p>
    <p>
      If the <a href="#cookie">“cookie” option</a> is not <code>false</code>,
      then this option does nothing.
    </p>
    <h5 id="value">value</h5>
    <p>
      Provide a function that the middleware will invoke to read the token from
      the request for validation. The function is called as
      <code>value(req)</code> and is expected to return the token as a string.
    </p>
    <p>
      The default value is a function that reads the token from the following
      locations, in order:
    </p>
    <ul>
      <li>
        <code>req.body._csrf</code> - typically generated by the
        <code>body-parser</code> module.
      </li>
      <li>
        <code>req.query._csrf</code> - a built-in from Express.js to read from
        the URL query string.
      </li>
      <li>
        <code>req.headers['csrf-token']</code> - the
        <code>CSRF-Token</code> HTTP request header.
      </li>
      <li>
        <code>req.headers['xsrf-token']</code> - the
        <code>XSRF-Token</code> HTTP request header.
      </li>
      <li>
        <code>req.headers['x-csrf-token']</code> - the
        <code>X-CSRF-Token</code> HTTP request header.
      </li>
      <li>
        <code>req.headers['x-xsrf-token']</code> - the
        <code>X-XSRF-Token</code> HTTP request header.
      </li>
    </ul>
    <h2 id="example">Example</h2>
    <h3 id="simple-express-example">Simple express example</h3>
    <p>
      The following is an example of some server-side code that generates a form
      that requires a CSRF token to post back.
    </p>
    <div class="sourceCode" id="cb3">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">var</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cookie-parser&#39;</span>)</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">var</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">var</span> bodyParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;body-parser&#39;</span>)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">var</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)</a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">// setup route middlewares</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">var</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb3-8" title="8"><span class="kw">var</span> parseForm <span class="op">=</span> <span class="va">bodyParser</span>.<span class="at">urlencoded</span>(<span class="op">{</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">// create express app</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="kw">var</span> app <span class="op">=</span> <span class="at">express</span>()</a>
<a class="sourceLine" id="cb3-12" title="12"></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">// parse cookies</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">// we need this because &quot;cookie&quot; is true in csrfProtection</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())</a>
<a class="sourceLine" id="cb3-16" title="16"></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/form&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-18" title="18">  <span class="co">// pass the csrfToken to the view</span></a>
<a class="sourceLine" id="cb3-19" title="19">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;send&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>() <span class="op">}</span>)</a>
<a class="sourceLine" id="cb3-20" title="20"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb3-21" title="21"></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&#39;/process&#39;</span><span class="op">,</span> parseForm<span class="op">,</span> csrfProtection<span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-23" title="23">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;data is being processed&#39;</span>)</a>
<a class="sourceLine" id="cb3-24" title="24"><span class="op">}</span>)</a></code></pre>
    </div>
    <p>
      Inside the view (depending on your template language; handlebars-style is
      demonstrated here), set the <code>csrfToken</code> value as the value of a
      hidden input field named <code>_csrf</code>:
    </p>
    <div class="sourceCode" id="cb4">
      <pre
        class="sourceCode html"
      ><code class="sourceCode html"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;/process&quot;</span><span class="ot"> method=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name=</span><span class="st">&quot;_csrf&quot;</span><span class="ot"> value=</span><span class="st">&quot;{{csrfToken}}&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-3" title="3">  </a>
<a class="sourceLine" id="cb4-4" title="4">  Favorite color: <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;favoriteColor&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="kw">&gt;</span>Submit<span class="kw">&lt;/button&gt;</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="kw">&lt;/form&gt;</span></a></code></pre>
    </div>
    <h4 id="using-ajax">Using AJAX</h4>
    <p>
      When accessing protected routes via ajax both the csrf token will need to
      be passed in the request. Typically this is done using a request header,
      as adding a request header can typically be done at a central location
      easily without payload modification.
    </p>
    <p>
      The CSRF token is obtained from the <code>req.csrfToken()</code> call on
      the server-side. This token needs to be exposed to the client-side,
      typically by including it in the initial page content. One possibility is
      to store it in an HTML <code>&lt;meta&gt;</code> tag, where value can then
      be retrieved at the time of the request by JavaScript.
    </p>
    <p>
      The following can be included in your view (handlebar example below),
      where the <code>csrfToken</code> value came from
      <code>req.csrfToken()</code>:
    </p>
    <div class="sourceCode" id="cb5">
      <pre
        class="sourceCode html"
      ><code class="sourceCode html"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">&lt;meta</span><span class="ot"> name=</span><span class="st">&quot;csrf-token&quot;</span><span class="ot"> content=</span><span class="st">&quot;{{csrfToken}}&quot;</span><span class="kw">&gt;</span></a></code></pre>
    </div>
    <p>
      The following is an example of using the
      <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API"
        >Fetch API</a
      >
      to post to the <code>/process</code> route with the CSRF token from the
      <code>&lt;meta&gt;</code> tag on the page:
    </p>
    <!-- eslint-env browser -->
    <div class="sourceCode" id="cb6">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="co">// Read the CSRF token from the &lt;meta&gt; tag</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">var</span> token <span class="op">=</span> <span class="va">document</span>.<span class="at">querySelector</span>(<span class="st">&#39;meta[name=&quot;csrf-token&quot;]&#39;</span>).<span class="at">getAttribute</span>(<span class="st">&#39;content&#39;</span>)</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">// Make a request using the Fetch API</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="at">fetch</span>(<span class="st">&#39;/process&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="dt">credentials</span><span class="op">:</span> <span class="st">&#39;same-origin&#39;</span><span class="op">,</span> <span class="co">// &lt;-- includes cookies in the request</span></a>
<a class="sourceLine" id="cb6-7" title="7">  <span class="dt">headers</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="st">&#39;CSRF-Token&#39;</span><span class="op">:</span> token <span class="co">// &lt;-- is the csrf token as a header</span></a>
<a class="sourceLine" id="cb6-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb6-10" title="10">  <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-11" title="11">  <span class="dt">body</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-12" title="12">    <span class="dt">favoriteColor</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span></a>
<a class="sourceLine" id="cb6-13" title="13">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="op">}</span>)</a></code></pre>
    </div>
    <h4 id="single-page-application-spa">Single Page Application (SPA)</h4>
    <p>
      Many SPA frameworks like Angular have CSRF support built in automatically.
      Typically they will reflect the value from a specific cookie, like
      <code>XSRF-TOKEN</code> (which is the case for Angular).
    </p>
    <p>
      To take advantage of this, set the value from
      <code>req.csrfToken()</code> in the cookie used by the SPA framework. This
      is only necessary to do on the route that renders the page (where
      <code>res.render</code> or <code>res.sendFile</code> is called in Express,
      for example).
    </p>
    <p>The following is an example for Express of a typical SPA response:</p>
    <!-- eslint-disable no-undef -->
    <div class="sourceCode" id="cb7">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="va">res</span>.<span class="at">cookie</span>(<span class="st">&#39;XSRF-TOKEN&#39;</span><span class="op">,</span> <span class="va">req</span>.<span class="at">csrfToken</span>())</a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;index&#39;</span>)</a>
<a class="sourceLine" id="cb7-4" title="4"><span class="op">}</span>)</a></code></pre>
    </div>
    <h3 id="ignoring-routes">Ignoring Routes</h3>
    <p>
      <strong>Note</strong> CSRF checks should only be disabled for requests
      that you expect to come from outside of your website. Do not disable CSRF
      checks for requests that you expect to only come from your website. An
      existing session, even if it belongs to an authenticated user, is not
      enough to protect against CSRF attacks.
    </p>
    <p>
      The following is an example of how to order your routes so that certain
      endpoints do not check for a valid CSRF token.
    </p>
    <div class="sourceCode" id="cb8">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">var</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cookie-parser&#39;</span>)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">var</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="kw">var</span> bodyParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;body-parser&#39;</span>)</a>
<a class="sourceLine" id="cb8-4" title="4"><span class="kw">var</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)</a>
<a class="sourceLine" id="cb8-5" title="5"></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">// create express app</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="kw">var</span> app <span class="op">=</span> <span class="at">express</span>()</a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">// create api router</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="kw">var</span> api <span class="op">=</span> <span class="at">createApiRouter</span>()</a>
<a class="sourceLine" id="cb8-11" title="11"></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">// mount api before csrf is appended to the app stack</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/api&#39;</span><span class="op">,</span> api)</a>
<a class="sourceLine" id="cb8-14" title="14"></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">// now add csrf and other middlewares, after the &quot;/api&quot; was mounted</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="va">app</span>.<span class="at">use</span>(<span class="va">bodyParser</span>.<span class="at">urlencoded</span>(<span class="op">{</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>))</a>
<a class="sourceLine" id="cb8-17" title="17"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())</a>
<a class="sourceLine" id="cb8-18" title="18"><span class="va">app</span>.<span class="at">use</span>(<span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>))</a>
<a class="sourceLine" id="cb8-19" title="19"></a>
<a class="sourceLine" id="cb8-20" title="20"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/form&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-21" title="21">  <span class="co">// pass the csrfToken to the view</span></a>
<a class="sourceLine" id="cb8-22" title="22">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;send&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>() <span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-23" title="23"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-24" title="24"></a>
<a class="sourceLine" id="cb8-25" title="25"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&#39;/process&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-26" title="26">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;csrf was required to get here&#39;</span>)</a>
<a class="sourceLine" id="cb8-27" title="27"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-28" title="28"></a>
<a class="sourceLine" id="cb8-29" title="29"><span class="kw">function</span> <span class="at">createApiRouter</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb8-30" title="30">  <span class="kw">var</span> router <span class="op">=</span> <span class="kw">new</span> <span class="va">express</span>.<span class="at">Router</span>()</a>
<a class="sourceLine" id="cb8-31" title="31"></a>
<a class="sourceLine" id="cb8-32" title="32">  <span class="va">router</span>.<span class="at">post</span>(<span class="st">&#39;/getProfile&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-33" title="33">    <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;no csrf to get here&#39;</span>)</a>
<a class="sourceLine" id="cb8-34" title="34">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-35" title="35"></a>
<a class="sourceLine" id="cb8-36" title="36">  <span class="cf">return</span> router</a>
<a class="sourceLine" id="cb8-37" title="37"><span class="op">}</span></a></code></pre>
    </div>
    <h3 id="custom-error-handling">Custom error handling</h3>
    <p>
      When the CSRF token validation fails, an error is thrown that has
      <code>err.code === 'EBADCSRFTOKEN'</code>. This can be used to display
      custom error messages.
    </p>
    <div class="sourceCode" id="cb9">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">var</span> bodyParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;body-parser&#39;</span>)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">var</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cookie-parser&#39;</span>)</a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">var</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="kw">var</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)</a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="kw">var</span> app <span class="op">=</span> <span class="at">express</span>()</a>
<a class="sourceLine" id="cb9-7" title="7"><span class="va">app</span>.<span class="at">use</span>(<span class="va">bodyParser</span>.<span class="at">urlencoded</span>(<span class="op">{</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>))</a>
<a class="sourceLine" id="cb9-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())</a>
<a class="sourceLine" id="cb9-9" title="9"><span class="va">app</span>.<span class="at">use</span>(<span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>))</a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">// error handler</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="va">app</span>.<span class="at">use</span>(<span class="kw">function</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-13" title="13">  <span class="cf">if</span> (<span class="va">err</span>.<span class="at">code</span> <span class="op">!==</span> <span class="st">&#39;EBADCSRFTOKEN&#39;</span>) <span class="cf">return</span> <span class="at">next</span>(err)</a>
<a class="sourceLine" id="cb9-14" title="14"></a>
<a class="sourceLine" id="cb9-15" title="15">  <span class="co">// handle CSRF token errors here</span></a>
<a class="sourceLine" id="cb9-16" title="16">  <span class="va">res</span>.<span class="at">status</span>(<span class="dv">403</span>)</a>
<a class="sourceLine" id="cb9-17" title="17">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;form tampered with&#39;</span>)</a>
<a class="sourceLine" id="cb9-18" title="18"><span class="op">}</span>)</a></code></pre>
    </div>
    <h2 id="references">References</h2>
    <ul>
      <li>
        <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery"
          >Cross-side request forgery on Wikipedia</a
        >
      </li>
      <li>
        <a
          href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html"
          >OWASP Cross-Site Request Forgery Prevention Cheat Sheet</a
        >
      </li>
    </ul>
    <h2 id="license">License</h2>
    <p><a href="LICENSE">MIT</a></p>
  </body>
</html>
